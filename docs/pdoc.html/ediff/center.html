<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.3"/>
    <title>ediff.center API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../ediff.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;ediff</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#module-ediffcenter">Module: ediff.center</a></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#CenterLocator">CenterLocator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CenterLocator.output">output</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.save_results">save_results</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.load_results">load_results</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.get_circle_pixels">get_circle_pixels</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.intensity_sum">intensity_sum</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.intensity_variance">intensity_variance</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.convert_coords">convert_coords</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.visualize_results">visualize_results</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.ellipse_distortion">ellipse_distortion</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CenterDetermination">CenterDetermination</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CenterDetermination.preprocess">preprocess</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.sobel_filt">sobel_filt</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_phase">detection_phase</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_crosscorr">detection_crosscorr</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_intensity">detection_intensity</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_Hough">detection_Hough</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_curvefit">detection_curvefit</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_3points">detection_3points</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.adjustment_3points">adjustment_3points</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.calculate_circle">calculate_circle</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.get_radius">get_radius</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.backend_fft">backend_fft</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.calc_fft">calc_fft</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.auto_masking">auto_masking</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.visualize_center">visualize_center</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CenterRefinement">CenterRefinement</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CenterRefinement.ref_interactive">ref_interactive</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterRefinement.ref_var">ref_var</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterRefinement.ref_sum">ref_sum</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterRefinement.diagnose_landscape">diagnose_landscape</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HandlerCircle">HandlerCircle</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HandlerCircle.create_artists">create_artists</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PocketFFTBackend">PocketFFTBackend</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#IntensityCenter">IntensityCenter</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#IntensityCenter.center_of_intensity">center_of_intensity</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../ediff.html">ediff</a><wbr>.center    </h1>

                        <div class="docstring"><h2 id="module-ediffcenter">Module: <a href="">ediff.center</a></h2>

<p>Find the center of a 2D diffraction pattern.</p>

<ul>
<li>The center determination may be surprisingly tricky in certain cases.</li>
<li>Nevertheless, usually it is enough to call <code><a href="#CenterLocator">CenterLocator</a></code> as shown below.</li>
<li>More details and examples at GitHub: <a href="https://mirekslouf.github.io/ediff/docs">https://mirekslouf.github.io/ediff/docs</a></li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Example: How to use CenterLocator and get results?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ediff</span> <span class="k">as</span> <span class="nn">ed</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">center</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">CenterLocator</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">input_image</span><span class="o">=</span><span class="s1">&#39;some_diffractogram.png&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">determination</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">refinement</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">final_replot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determined center coordinates:&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Refined center coordinates   :&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</code></pre>
</div>
</div>

                        <input id="mod-center-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-center-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">Module: ediff.center</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">--------------------</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">Find the center of a 2D diffraction pattern.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">* The center determination may be surprisingly tricky in certain cases.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">* Nevertheless, usually it is enough to call `CenterLocator` as shown below.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="sd">* More details and examples at GitHub: https://mirekslouf.github.io/ediff/docs</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">&gt;&gt;&gt; # Example: How to use CenterLocator and get results?</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="sd">&gt;&gt;&gt; import ediff as ed</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">&gt;&gt;&gt;</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">&gt;&gt;&gt; center = ed.center.CenterLocator(</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">&gt;&gt;&gt;    input_image=&#39;some_diffractogram.png&#39;,</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">&gt;&gt;&gt;    determination=&#39;intensity&#39;,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">&gt;&gt;&gt;    refinement=&#39;sum&#39;,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">&gt;&gt;&gt;    verbose=False, final_replot=True)</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">&gt;&gt;&gt;</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">&gt;&gt;&gt; print(&#39;Determined center coordinates:&#39;, center.x1, center.y1)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">&gt;&gt;&gt; print(&#39;Refined center coordinates   :&#39;, center.x2, center.y2)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="c1"># CenterDet, major update and improvements by MS-&gt;PS</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="c1"># PS 2023-10-06: CentDet update, methods compatibility</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="c1"># MS 2023-11-26: Improved code formatting and docs + TODO notes for PS</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="c1"># MS 2024-23-09: Re-desing/draft of CenterLocator =&gt; CenterLocator_new</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="c1"># PS 2025-XX-XX: Updates + imporovements in branch {center_determination}</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="c1"># MS 2025-08-01: Import of {center_determination} branch to {main) </span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">import</span> <span class="nn">skimage</span> <span class="k">as</span> <span class="nn">sk</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">from</span> <span class="nn">matplotlib.legend_handler</span> <span class="kn">import</span> <span class="n">HandlerBase</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">map_coordinates</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">import</span> <span class="nn">ediff.io</span> 
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="kn">import</span> <span class="nn">ediff.radial</span> 
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="kn">import</span> <span class="nn">cv2</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">moments</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">hough_circle</span><span class="p">,</span> <span class="n">hough_circle_peaks</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="kn">from</span> <span class="nn">skimage.registration</span> <span class="kn">import</span> <span class="n">phase_cross_correlation</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="kn">import</span> <span class="nn">skimage.feature</span> <span class="k">as</span> <span class="nn">skf</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="kn">from</span> <span class="nn">scipy.fft</span> <span class="kn">import</span> <span class="n">_pocketfft</span><span class="p">,</span> <span class="n">set_backend</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="n">CPU_COUNT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="k">class</span> <span class="nc">CenterLocator</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">    CenterLocator object : determine and refine the center of a 2D electron </span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">    diffraction pattern (diffractogram)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    </span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">    This class detects the center of diffraction patterns. It offers several </span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">    automatic or manual methods and optionally refines the center position.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">    Parameters</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">    ----------</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">    input_image : str, path, or numpy.ndarray</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">        The input 2D diffraction image, either a file path or a NumPy array.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">    determination : str or None, optional, default=None</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">        Method used for the initial center determination.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        Options include:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">        - &#39;manual&#39;: Manual detection = interactive plot where the user</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">          selects 3 points defining a diffraction ring with a mouse.</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">        - &#39;intensity&#39; : Auto-detection = the intensity center</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">          from the central region.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        - &#39;curvefit&#39;: Automatic detection = fit the intensity center</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">          from the central region using pseudo-Voigt profile.                      </span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        - &#39;hough&#39; : Automatic detection using Hough transform</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">          to find center of ring-like structures.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">        - &#39;phase&#39; : Automatic detection using phase correlation</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">          to find the symmetry center.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">        - &#39;ccorr&#39; : Automatic detection using cross-correlation</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">          to find the symmetry center.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        - None : Skip the center determination;</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">          it is supposed that the center coordinates</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">          will be read from *in_file* argument - see below.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">          </span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">    refinement : str or None, optional, default=None</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        Method used for refining the initially detected center.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        Options include:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        - &#39;manual&#39;: Manual fine-tuning of the center along</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">          the selected diffraction ring.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">        - &#39;sum&#39; : Automatic refinement by maximizing the intensity sum</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">          the selected diffraction ring.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">        - &#39;var&#39;: Automatic refinement by minimizing intensity variance</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">          the selected diffraction ring.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">    rtype : int, default=1</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">        How to determine a radius of a difraction ring for center refinement.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">        In powder diffractograms, the diffraction rings are clearly defined.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        In spotty diffractograms, the diffraction ring is an fictive ring</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        connecting at least three diffraction spots.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        Options include:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        - 0 : Peak matching method</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">          (fast and simple, but failing for non-powders, historical).</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        - 1 : Radial distribution method</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">          (slower but more universal, new default).</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">        </span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">    in_file : str or None, optional, default=None</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">        Path to a file from which the (previously saved)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        center coordinates will be loaded.</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">    out_file : str or None, optional, default=None</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">        Path to a file where the determined</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">        center coordinates will be saved.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">        </span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">    sobel : bool, optional, default=False</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">        If True, apply Sobel filter to the image before processing.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">        </span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">    heq : bool or None, optional, default=False</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">        If True, apply histogram equalization internally (display unchanged).</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    icut : float or None, optional, default=None</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">        Cut-off intensity level for processing the image.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">        </span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">    cmap : str, optional, default=&#39;gray&#39;</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">        Matplotlib colormap name used for displaying the image.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">        </span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">    csquare : int, optional, default=50</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">        Size (in pixels) of the central square used for initial center search.</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        </span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">    cintensity : float, optional, default=0.8</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">        Threshold intensity for finding the intensity center. Pixels with a </span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">        (relative) intensity lower than cintensity are ignored.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">        </span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">    verbose : int, optional, default=0</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        Verbosity level for printing messages during processing:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">        - 0 : Silent mode — no messages are printed.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        - 1 : Show help messages during manual refinement only.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        - 2 : Full verbose mode — print all messages and debug information.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        - 3 : Progress mode — print brief status updates during time-consuming </span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">              processing.</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        </span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">    print_sums : bool, optional, default=False</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">        If True, print intensity sums after each adjustment (in manual modes).</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">        </span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">    final_print : bool, optional, default=True</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">        If True, print final coordinates to stdout.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">    </span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">    live_plot : bool, optional, default=True</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">        If True, show live visualization of some processes if available.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd"> </span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">    Returns</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">    -------</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">    None</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        The result is stored in the instance variables:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">        - `(x1, y1)` for the initially determined center</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">        - `(x2, y2)` for the refined center (if refinement is applied)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">            </span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">    Technical notes</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">    ---------------</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">    * The class automatically initializes and uses two internal components:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">      `CenterDetermination` and `CenterRefinement`.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">    * These internal processes are hidden from the user but can be accessed </span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">      directly if needed.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">    Examples</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">    --------</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">    &gt;&gt;&gt; import ediff as ed</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">    &gt;&gt;&gt; locator = ed.center.CenterLocator(</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">    &gt;&gt;&gt;    input_image   = &#39;.r/path/to/your/data.png&#39;,   </span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">    &gt;&gt;&gt;    determination = &#39;manual&#39;,           </span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">    &gt;&gt;&gt;    refinement    = &#39;sum&#39;,</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">    &gt;&gt;&gt;    final_print   = True)   </span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">                              </span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>    
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>    
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>                 <span class="n">rtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>                 <span class="n">sobel</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>                 <span class="n">masking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>                 <span class="n">ellipse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>                 <span class="n">mcorrect</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>                 <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                 <span class="n">final_print</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>                 <span class="n">live_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="c1">## Initialize input attributes ---------------------------------------</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="c1"># Input image = diffraction pattern</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="c1"># (it can be either image file or numpy array)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="c1"># Methods of center determination, refinement, and radius estimation</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rtype</span> <span class="o">=</span> <span class="n">rtype</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="c1"># For reproducibility, convert the method names to lowercase</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="k">if</span> <span class="n">determination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="c1"># Text files for reading/saving center coordinates</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">in_file</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="c1"># Image processing parameters</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span> <span class="o">=</span> <span class="n">ellipse</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcorrect</span> <span class="o">=</span> <span class="n">mcorrect</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sobel</span> <span class="o">=</span> <span class="n">sobel</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">masking</span> <span class="o">=</span> <span class="n">masking</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">=</span> <span class="n">heq</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="o">=</span> <span class="n">icut</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span> <span class="o">=</span> <span class="n">csquare</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span> <span class="o">=</span> <span class="n">cintensity</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="c1"># Process-Information parameters</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span> <span class="o">=</span> <span class="n">print_sums</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span> <span class="o">=</span> <span class="n">final_print</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">live_plot</span> <span class="o">=</span> <span class="n">live_plot</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="c1">## Initialize new attributes ------------------------------------------</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="c1"># The value of the following attribute can be adjusted</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">=</span> <span class="mi">100</span>          
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="c1">## (1) Read input image -----------------------------------------------</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Loading image.&quot;</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="c1"># The input image can be numpy.array (ndarray) or image file (path/str)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">ediff</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="c1">## (2) Correct ellipse ------------------------------------------------</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Correcting ellipse distortion... &quot;</span><span class="p">,</span> 
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>                      <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse_distortion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>                                                 <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mcorrect</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>                
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="c1">## (3) Read center coordinates ----------------------------------------</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="c1"># The center coordinates may have been determined in a previous run </span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="c1"># of the program and saved to a text file.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="c1"># We can Load coordinates from an input file if specified, this is done </span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="c1"># by the following command. As the saved coordinates can be used INSTEAD </span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="c1"># of CenterDetermination we will read them here.</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_results</span><span class="p">()</span>  
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Loading saved center coordinates.&quot;</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="c1">## (4) Run CenterDetermination ----------------------------------------</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Detecting center...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>            
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="c1">#  (4a) Initialize/run CenterDetermination</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center1</span> <span class="o">=</span> <span class="n">CenterDetermination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="p">,</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span><span class="p">,</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>    
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="c1">#  (4b) Find radius of a circle/diffraction ring, which is needed </span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="c1">#       for the next step = CenterRefimenement.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Estimating radius of the diffraction pattern...&quot;</span><span class="p">,</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                  <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>    
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">!=</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rtype</span><span class="p">,</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>                <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>        <span class="c1">## (5) Initialize/run CenterRefinement --------------------------------</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Refining center coordinates...&quot;</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>                  <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center2</span> <span class="o">=</span> <span class="n">CenterRefinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span> 
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span> 
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>            
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>            
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="c1">## (6) Collect results ------------------------------------------------</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Collecting results.&quot;</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="c1"># Center only detected and not refined</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            <span class="c1"># Center detected and refined</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>        <span class="c1">## (7) Switch coordinates if necessary --------------------------------</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="c1">#      This step is important, as center detection/refinement methods</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>        <span class="c1">#      have various coordinate system origins. The conversion is </span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="c1">#      necessary for some combinations of methods</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">):</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>        
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;hough&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;phase&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>            
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;ccorr&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span> 
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                        
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s2">&quot;curvefit&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span> 
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                            
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>        <span class="c1">## (8) Print the coordinates if required ------------------------------</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>            
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)))</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>            
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)))</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                        
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>        <span class="c1">## (9) Save results to a .txt file if specified -----------------------</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span><span class="p">()</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Saving results.&quot;</span><span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>    
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        Return the final results of center determination and refinement. </span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        </span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        Returns</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">        -------</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        x1 : float</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">            x-coordinate of the center determined by the *determination* method.</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">            </span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">        y1 : float</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">            y-coordinate of the center determined by the *determination* method.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        </span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">        x2 : float</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">            x-coordinate of the center after *refinement*, or same as x1 if no </span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">            refinement was used.</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">        </span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        y2 : float</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">            y-coordinate of the center after *refinement*, or same as y1 if no </span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">            refinement was used.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">            </span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">        Notes</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        -----</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">        - The function always returns four values: (x1, y1, x2, y2).</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">        - If no refinement method was used (`refinement=None`), then (x2, y2) </span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">          will be equal to (x1, y1).</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">        - All values are rounded to one decimal place before returning.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">        - Coordinates are internally converted to float to ensure consistency </span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">          in output.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="c1"># (1) refinement=None -------------------------------------------------</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="c1"># Convert to float</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> \
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> 
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)]</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>                    
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="c1"># (2) refinement!=None ------------------------------------------------</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="c1"># Convert to float</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> \
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)]</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="c1"># Define x2,y2 = x1,y1</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="c1"># (3) Return (rounded) values of center coordinates -------------------</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>    
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">        Save the determined and refined center coordinates to a file.</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">    </span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">        This method writes the coordinates (x1, y1) from the *determination*</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">        step and (x2, y2) from the *refinement* step to a file specified by the </span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">        `out_file` attribute.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">    </span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">        - If the file already exists, the results are appended to the end.</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">        - If the file does not exist, it is created and the results are written.</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">        - Coordinates are formatted to four decimal places for clarity.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">        </span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        </span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">        Parameters</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        ----------</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">        None</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        </span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">        Returns</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        -------</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">        None</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        </span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">        Notes</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">        -----</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">        - If `self.out_file` is None, the method does nothing.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">        - The results are written in the format:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">        - This method does not raise an error if the path is invalid;</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">          ensure `out_file` is a valid writable path.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="c1"># Check if the specified file exists</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">):</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                <span class="c1"># Append results to in_file</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in append mode</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>                <span class="c1"># If the file does not exist, create it and write results</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in write mode</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>    <span class="k">def</span> <span class="nf">load_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">        Load center coordinates from a results file.</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">    </span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">        This method reads a text file (defaulting to `self.in_file` or</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">        a provided `path`) containing previously saved center coordinates.</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">        It extracts coordinate pairs (x1, y1) from the determination step and</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a><span class="sd">        (x2, y2) from the refinement step. All sets of values are stored</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="sd">        internally, with the most recent values assigned to instance variables </span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="sd">        `self.x1`, `self.y1`, `self.x2`, and `self.y2`.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a><span class="sd">    </span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">        Parameters</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">        ----------</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">        path : str, optional</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">            Path to the results file. </span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">            If not provided, the method uses `self.in_file`.</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">    </span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">        Returns</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        -------</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">        tuple or None</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">            If `path` is provided and successfully loaded:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">                (x1_values, y1_values) : Lists of all loaded x1 and y1 values.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">            If loading fails:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">                None</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">    </span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        Notes</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        -----</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        - The file is expected to contain lines in the following format:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a><span class="sd">        - Multiple coordinate entries can be loaded; the last set is stored in</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">          the instance variables for easy access.</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="sd">        - If the file doesn&#39;t exist or is unreadable, a warning is printed and</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="sd">          the function returns None.</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">        &quot;&quot;&quot;</span>      
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                <span class="c1"># Initialize lists to hold multiple values</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                <span class="n">x1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="n">y1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                <span class="n">x2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                <span class="n">y2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>    
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                    <span class="c1"># Strip and split each line to get the coordinates</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                        <span class="c1"># Extract x1 and y1 or x2 and y2 based on line content</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                        <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                            <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                            <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                            <span class="n">x1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                            <span class="n">y1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                        <span class="k">elif</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                            <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                            <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                            <span class="n">x2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                            <span class="n">y2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>    
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                <span class="c1"># Store the last set of values as instance variables </span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>    
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                <span class="c1"># Store the last loaded values:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                <span class="k">if</span> <span class="n">x1_values</span> <span class="ow">and</span> <span class="n">y1_values</span> <span class="ow">and</span> <span class="n">x2_values</span> <span class="ow">and</span> <span class="n">y2_values</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                    
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                    <span class="k">return</span> <span class="n">x1_values</span><span class="p">,</span> <span class="n">y1_values</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error reading text file with center coordinates!&quot;</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>            <span class="k">return</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>    <span class="k">def</span> <span class="nf">get_circle_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">        Extract pixel values along a circular path in the image.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">    </span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">        Parameters</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">        ----------</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">            2D grayscale image from which pixel values are extracted.</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">            </span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        cx : float</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">            X-coordinate (row) of the circle center.</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        </span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        cy : float</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">            Y-coordinate (column) of the circle center.</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">        </span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">        r : float</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="sd">            Radius of the circle.</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        </span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">        num_points : int, optional</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">            Number of points to sample along the circular path. Default is 360.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">    </span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">        Returns</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">        -------</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">        pixels : np.ndarray</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="sd">            1D array of pixel intensity values sampled along the circular path.</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="c1"># Generate coordinates for the circle</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="c1"># Use map_coordinates for accurate sub-pixel interpolation</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="c1"># &#39;order=1&#39; is linear interpolation</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                                 <span class="n">coords</span><span class="p">,</span> 
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                                 <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                                 <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> 
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                                 <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="c1"># Return pixels</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="k">return</span> <span class="n">pixels</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>     
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>     
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="sd">        Compute the sum of pixel intensities along a circular path.</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">    </span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="sd">        This function extracts pixel values along a circle defined by the </span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">        given center coordinates (cx, cy) and radius r, then returns </span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a><span class="sd">        the sum of these intensities.</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="sd">    </span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">        Parameters</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="sd">        ----------</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">            2D grayscale image from which the intensities are extracted.</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">        </span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">        cx : float</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">            X-coordinate (row) of the circle center.</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">        </span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">        cy : float</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">            Y-coordinate (column) of the circle center.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">        </span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        r : float</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">            Radius of the circle.</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">    </span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">        Returns</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">        -------</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">        float</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">            Sum of pixel intensities along the circular path.</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="c1"># Get pixel intensities</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>        
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="c1"># Sum pixel intensities</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>    
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>    
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>    <span class="k">def</span> <span class="nf">intensity_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">        Variance of intensity values of pixels of a diffraction pattern.</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">        Parameters</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="sd">        ----------</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">        image : array of uint8</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        </span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">        px : float64</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        </span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">        py : float64</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">        </span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">        pr : float64</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        Returns</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">        -------</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        s : float64</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">            intensity variance</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span><span class="p">])</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>    
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>    
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>    <span class="k">def</span> <span class="nf">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">        Convert coordinates between numpy and matplotlib systems.</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">        Parameters</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">        ----------</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">        x : int or float</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">            The x-coordinate in the numpy (column index) format.</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        </span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">        y : int or float</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="sd">            The y-coordinate in the numpy (row index) format.</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">        Returns</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">        -------</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">        tuple of (int or float, int or float)</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">            The converted coordinates in matplotlib format, where:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">            - First element corresponds to y (new x in matplotlib).</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">            - Second element corresponds to x (new y in matplotlib).</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">        Visualize diffractogram and its center after</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">        center determination + refinement.</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">    </span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">        Parameters</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">        ----------</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">        csquare : int, optional, default is None</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">            If csquare argument is given,</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">            only the central square of the diffractogram will be plotted;</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">            the size of the central square will be equal to csquare argument.</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">        </span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">        out_file : str, optional, default is None</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">            If out_file is given,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">            save the final plot to image named *out_file*.</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">        </span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">        out_dpi : int, optional, default is 200</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">            DPI of the output image file;</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">            this parameter is relevant only if out_file is given.</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">    </span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">        Returns</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">        -------</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">        None</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">            The output is the image of the diffractogram</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">            showing also the central coordinates and refinement ring.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="c1"># (0) Collect center coordinates and radii ----------------------------</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>        <span class="c1"># (1) Prepare the image of the diffractogram --------------------------</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="c1"># (2) Calculate intensity sum or intensity variance -------------------</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="n">dvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="n">rvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-var: </span><span class="si">{</span><span class="n">dvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-var: </span><span class="si">{</span><span class="n">rvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="n">dsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="n">rsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-sum: </span><span class="si">{</span><span class="n">dsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-sum: </span><span class="si">{</span><span class="n">rsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        <span class="c1"># (3) Calculate xy-limits if we want to see only the central square ---</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="n">xmin</span> <span class="o">+=</span> <span class="n">edge</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="n">xmax</span> <span class="o">-=</span> <span class="n">edge</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="n">ymin</span> <span class="o">+=</span> <span class="n">edge</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="n">ymax</span> <span class="o">-=</span> <span class="n">edge</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>    
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>        <span class="c1"># (4) Final plot: show the diffractogram + refinement results ---------</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>    
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Center :: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>    
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> 
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labeld</span><span class="p">,</span> 
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> 
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                   <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="n">c0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">r1</span><span class="p">,</span> 
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> 
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detected center&#39;</span><span class="p">,</span> 
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>    
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labelr</span><span class="p">,</span> 
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="n">c1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">r2</span><span class="p">,</span> 
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refined center&#39;</span><span class="p">,</span> 
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>    
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                  <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="n">Circle</span><span class="p">:</span> <span class="n">HandlerCircle</span><span class="p">()},</span> 
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.98</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> 
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                  <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>    
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="c1"># Remove axes (= tick and ticklabels) around the diffractogram</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>        <span class="c1"># Plot only the central square region if requested</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="c1"># Save the result to output file if requested</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">out_dpi</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="c1"># Show the plot on screen</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>    <span class="k">def</span> <span class="nf">ellipse_distortion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">        Corrects elliptical distortion in an image by transforming 4 distorted </span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">        points (which should ideally lie on a circle) to lie on a true circle.</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">    </span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">        Parameters</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="sd">        ----------</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">        img : np.ndarray</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">            Input image (2D numpy array) containing an elliptical diffraction </span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">            pattern.</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="sd">        </span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">        show : bool, optional</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">            If True, displays the original and corrected images. </span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">            Default is True.</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">        </span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">        method : str, optional</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">            Point selection method: &#39;manual&#39; or &#39;auto&#39;.</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">            - &#39;manual&#39;: User clicks four points on the image.</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">            - &#39;auto&#39;: Automatically detects the four brightest Bragg spots </span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">              (not yet implemented).</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">    </span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">        Returns</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">        -------</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">        corrected : np.ndarray</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">            The distortion-corrected image.</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="c1"># Helper function</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="k">def</span> <span class="nf">refine_to_local_max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">            Refine a point to the local maximum intensity within a neighborhood.</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">        </span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">            This function searches for the brightest (maximum intensity) pixel</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">            within a square window centered around a given point. It is typi-</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">            cally used to improve the accuracy of an estimated center by snap-</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">            ping it to the nearest local maximum.</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        </span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">            Parameters</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">            ----------</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">            img : ndarray</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">                2D array (grayscale) in which the local maximum is to be found.</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">                </span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">            pt : array-like of float</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">                Initial (x, y) point coordinates around which the local maximum </span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">                is searched.</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">                </span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">            window : int, optional</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">                Size of the square window for the local search (default is 9).</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">                The actual window will be `window x window` pixels, </span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">                centered at `pt`.</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">        </span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">            Returns</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">            -------</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">            refined_pt : ndarray of float</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">                Refined point coordinates [x, y] corresponding to the brightest </span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">                pixel in the local window.</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">        </span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="sd">            Notes</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">            -----</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">            - If the window overlaps the image boundaries, it is clipped </span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">              appropriately.</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">            - If the window is completely outside the image, the original point </span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">              is returned.</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">            - Assumption : `img` uses (row, column) = (y, x) indexing.</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">window</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>            <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>            <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>    
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="n">local</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>            <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>    
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="n">local</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>            <span class="n">refined_x</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="n">dx</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="n">refined_y</span> <span class="o">=</span> <span class="n">y_min</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">refined_x</span><span class="p">,</span> <span class="n">refined_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="c1"># Elliptical correction workflow --------------------------------------</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>    
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only user-assisted (&#39;manual&#39;) correction available.&quot;</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;manual&quot;</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>    
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="c1"># Manual point selection</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Click 4 distorted points (in circular order)&quot;</span><span class="p">)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>            <span class="n">raw_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>    
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="c1"># Refine each point to local max</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="n">distorted_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                <span class="n">refine_to_local_max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">raw_pts</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>            <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>    
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="c1"># Compute center and average radius</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distorted_pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">distorted_pts</span> <span class="o">-</span> <span class="n">center</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="n">avg_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>    
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        <span class="c1"># Target points evenly on circle</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="n">circle_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">avg_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>            <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">avg_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>    
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="c1"># Perspective transform</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">distorted_pts</span><span class="p">,</span> <span class="n">circle_pts</span><span class="p">)</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="c1"># Make output square by padding the image to max_dim x max_dim</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="n">max_dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="c1"># Compute offset to center the original image content in the square </span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_dim</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_dim</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="c1"># Create a translation matrix to shift image content to center</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">],</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">],</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="c1"># Combine the original homography with the translation</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="n">H_total</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">H</span>  <span class="c1"># Matrix multiplication</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="c1"># Apply the combined transformation</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="n">corrected</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>            <span class="n">img</span><span class="p">,</span> <span class="n">H_total</span><span class="p">,</span> <span class="p">(</span><span class="n">max_dim</span><span class="p">,</span> <span class="n">max_dim</span><span class="p">),</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>            <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="n">borderValue</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="p">)</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="c1"># Show results</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original with refined points&quot;</span><span class="p">)</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">distorted_pts</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>    
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Corrected image&quot;</span><span class="p">)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="k">return</span> <span class="n">corrected</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="k">class</span> <span class="nc">CenterDetermination</span><span class="p">:</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">    CenterDetermination object - initial detection of a diffractogram center.</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">    This class is responsible for identifying the center coordinates of </span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">    a 2D diffraction pattern image using various detection methods specified </span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">    by the user. It initializes with the input image and other parameters</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">    that influence the center detection process.</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">    Parameters</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="sd">    ----------</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">        Reference to the parent CenterLocator object, allowing access </span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">        to shared attributes and methods.</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">        </span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">        The input image representing a 2D diffraction pattern, provided as </span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">        a file path or a NumPy array.</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        </span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">    determination : str or None, optional, default=None</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">        Method used for the initial center determination.</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">        Options include:</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">        - &#39;manual&#39;   : Manual selection of 3 points on a diffraction ring.</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">        - &#39;hough&#39;    : Automatic detection using Hough transform.</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">        - &#39;intensity&#39;: Automatic detection based on the intensity center </span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">                       of the central region.</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">        - &#39;phase&#39;    : Automatic detection using phase correlation to find </span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="sd">                       the symmetry center.</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">        - &#39;ccorr&#39;    : Automatic detection using cross-correlation to find </span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">                       the symmetry center.</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">        - &#39;curvefit&#39; : Automatic detecting using pseudo-Voigt profile fitting </span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">        </span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">    in_file : str or None, optional, default=None</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">        Path to the file from which previously saved coordinates will be loaded.</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">    </span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">    out_file : str or None, optional, default=None</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        Path to the file where the determined coordinates will be saved.</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">        </span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">    sobel : bool, optional, default=False</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">        If True, apply Sobel filter to the image before processing.</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">        </span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">    heq : bool or None, optional, default=False</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">        If True, apply histogram equalization internally (display unchanged).</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">    </span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">    icut : float or None, optional, default=None</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">        Cut-off intensity level for processing the image.</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">        </span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">    cmap : str, optional, default=&#39;gray&#39;</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">        Matplotlib colormap name used for displaying the image.</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">        </span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">    csquare : int, optional, defaul=50</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">        Size (in pixels) of the central square used for initial center search.</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">        </span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">    cintensity : float, optional, default=0.8</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">        Threshold intensity for finding the intensity center. Pixels with a </span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">        (relative) intensity lower than cintensity are ignored.</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">        </span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">    verbose : bool, optional, default=False</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">        If True, print informational verbose during the detection process.</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        </span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">    print_sums : bool, optional, default=False</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">        If True, print intensity sums after each adjustment (in manual modes).</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        </span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">    </span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">    Returns</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">    -------</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">    None</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">    Notes</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">    -----</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">    - The class preprocesses the input image and then applies the specified </span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">      center detection method.</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">    - The detected center coordinates are stored in instance variables</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">      `x`, `y`, and `r`, representing the center&#39;s x-coordinate, </span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">      y-coordinate, and radius, respectively.</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">      </span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>    
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                 <span class="n">input_image</span><span class="p">,</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                 <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="c1">## (0) Initialize input attributes -----------------------------------</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="c1">## (1) Initialize new attributes -------------------------------------</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span> 
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="c1">## (2) Run functions -------------------------------------------------</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="c1">#  (2a) Preprocess data</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">preInit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="c1">#  (2b) Center detection methods</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="k">if</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_3points</span><span class="p">()</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>            
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hough&quot;</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_Hough</span><span class="p">(</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">,</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>                <span class="n">live_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">live_plot</span><span class="p">)</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>            
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_intensity</span><span class="p">(</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span> 
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cintensity</span><span class="p">,</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">)</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>            
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;phase&quot;</span><span class="p">:</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_phase</span><span class="p">(</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">,</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                <span class="n">masking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">masking</span><span class="p">)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>         
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ccorr&quot;</span><span class="p">:</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_crosscorr</span><span class="p">(</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">,</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>        
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;curvefit&quot;</span><span class="p">:</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_curvefit</span><span class="p">()</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected determination method does not exist.&quot;</span><span class="p">)</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preInit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preHough</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preManual</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>                   <span class="n">preVar</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preSum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preInt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">        Preprocess the input image based on the selected automatic detection </span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">        and refinement methods.</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">    </span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">        Parameters</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">        ----------</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="sd">        preInit : bool, optional, default=0</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">            Preprocess the original image using initialization methods such as</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">            histogram equalization (heq) or contrast clipping (icut). This</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">            is used to enhance the input image prior to any detection or</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">            correction.</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">        </span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">        preHough : bool, optional, default=0</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a><span class="sd">            Perform preprocessing required for Hough transform-based automatic </span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">            detection. This includes edge detection and handling beamstoppers. </span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">    </span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">        preManual, preVar, preSum, preInt : bool, optional, default=0</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">            Placeholder flags for future preprocessing needs for manual </span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">            detection and different refinement methods (variance, sum, </span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">            intensity-based). Currently unused.</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">    </span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">        Returns</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">        -------</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">        edges : np.ndarray of bool, optional</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">            Edge map obtained using the Canny edge detector, required for Hough</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">            transform. Only returned if `preHough` is True.</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">    </span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">        Notes</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">        -----</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">        This function performs different preprocessing steps depending on the</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">        detection/refinement strategy selected. It is modular and supports</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">        optional display of intermediate results if `self.parent.verbose` is True.</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>    
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="c1"># Flags</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="n">control_print</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>        <span class="c1"># Load original image</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>            
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="c1">### After initialization: perform an image enhancement if specified</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="k">if</span> <span class="n">preInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="c1"># Enhance diffraction pattern to make it more visible</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Histogram equalized.&quot;</span><span class="p">)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">equalize_adapthist</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="k">return</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="c1">### Hough transform: perform pre-processing necessary for the detection</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="k">if</span> <span class="n">preHough</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>           
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>                
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beamstopper removed.&#39;</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                    <span class="n">max_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>        
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                    
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>                    
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                            <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>                            <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>                            <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>                    
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                    
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>                    <span class="c1"># Erode the dilated edges</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>                    <span class="c1"># to reduce thickness and smooth the contour</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>                        
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No beamstopper.&#39;</span><span class="p">)</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>                                             <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>                                             <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>                                             <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>                    
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>                    
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>                    <span class="c1"># Erode the dilated edges</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>                    <span class="c1"># to reduce thickness and smooth the contour</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>                    <span class="n">connected_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>                        <span class="n">connected_edges</span><span class="p">,</span> 
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>                        <span class="n">min_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>                    
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,)</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>                
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>                <span class="c1"># Central square extraction</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>                <span class="k">if</span> <span class="mf">0.4</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.6</span><span class="p">:</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>                    
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>    
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>    
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>                                                     
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>                    
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>                      <span class="c1">#  ax[1,1].imshow(connected_edges)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>                    
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>                    
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="k">return</span> <span class="n">edges</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>        
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="k">def</span> <span class="nf">sobel_filt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>   
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">        The Sobel filter, which is a simple 3×3 kernel convolved with the image </span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">        which approximates the gradient of intensity in a certain direction. </span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a><span class="sd">        Since the Sobel filter is a simple matrix, it can be applied across </span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="sd">        datasets without concern for effects caused by changing user defined </span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="sd">        thresholds, and is much faster and impartial than an iterative method</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="sd">        Parameters</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">        ----------</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">        image : TYPE</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">            DESCRIPTION.</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">        disp : TYPE, optional</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">            DESCRIPTION. The default is False.</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">        Returns</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">        -------</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">        sobel_magnitude : TYPE</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">            DESCRIPTION.</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>        <span class="c1"># Apply Sobel filter</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>        <span class="n">sobel_x</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>                            <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> 
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>                            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>                            <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Horizontal edges</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>        <span class="n">sobel_y</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>                            <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> 
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>                            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>                            <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Vertical edges</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="c1"># # Take absolute values to remove negatives</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="c1"># sobel_x = np.abs(sobel_x)</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>        <span class="c1"># sobel_y = np.abs(sobel_y)</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>        <span class="c1"># Compute gradient magnitude</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="n">sobel_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sobel_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sobel_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        <span class="c1"># Normalize</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="n">sobel_magnitude</span> <span class="o">=</span> \
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">sobel_magnitude</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sobel_magnitude</span><span class="p">))</span>  
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>        
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>            <span class="c1"># Display results</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_x</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span> 
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sobel X&#39;</span><span class="p">)</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_y</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sobel Y&#39;</span><span class="p">)</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_magnitude</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span> 
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gradient Magnitude&#39;</span><span class="p">)</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="k">return</span> <span class="n">sobel_magnitude</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>    
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>    
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>    <span class="k">def</span> <span class="nf">detection_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>                        <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">masking</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a><span class="sd">        Detects the center of symmetry in a diffraction image using a </span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">        combination of weighted intensity averaging and phase cross-correlation.</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="sd">    </span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">        This method performs the following steps:</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">            1. Estimates an initial center using a weighted average of pixel </span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">               intensities.</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="sd">            2. Crops the image to focus on its central region.</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a><span class="sd">            3. Optionally normalizes the background to mitigate experimental </span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a><span class="sd">               artifacts.</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a><span class="sd">            4. Computes a refined center via inversion symmetry and phase </span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="sd">               cross-correlation.</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">            5. Returns the final refined center coordinates.</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">    </span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="sd">        Parameters</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">        ----------</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">        normalize_bg : bool, optional, default=True</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">            If True, normalize background intensity to reduce artifacts.</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">            </span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">            If True, applies Sobel filtering (currently unused if not implemented)</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">            </span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="sd">        disp : bool, optional, default=False</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a><span class="sd">            If True, displays intermediate processing results. </span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a><span class="sd">            </span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a><span class="sd">        masking : bool, optional, default=True</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="sd">            If True, applies masking to exclude unwanted regions from analysis</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a><span class="sd">    </span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">        Returns</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">        -------</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">        r_final : float</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="sd">            Estimated row-coordinate of the image center after refinement.</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="sd">            </span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="sd">        c_final : float</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">            Estimated column-coordinate of the image center after refinement.</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">            </span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a><span class="sd">        None : NoneType</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="sd">            Placeholder for future functionality (e.g., radius estimation).</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>        <span class="c1"># (1) Get image  ------------------------------------------------------</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>        
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="c1"># if Sobel==True, perform Sobel filtration</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="c1"># https://doi.org/10.1016/j.ultramic.2016.12.021</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">disp</span><span class="p">)</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>        
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="c1"># shift the pixel values (smallest value is zero -&gt; non-negative image)</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="n">image</span> <span class="o">-=</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="c1"># (2) Prepare mask and compute weighted center ------------------------</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="k">if</span> <span class="n">masking</span><span class="p">:</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_masking</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> 
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>            <span class="c1"># print(&quot;masked&quot;)</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># binary mask</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>        
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">image</span>                        <span class="c1"># </span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>       <span class="c1"># matrices of row/col indices</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>        <span class="c1"># Weighted center of mass (brighter pixels contribute more)</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>        <span class="c1"># This gives an initial estimate of the center (r_, c_).</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>        <span class="n">r_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>        <span class="n">c_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="c1"># (3) Crop the image around the estimated center ----------------------</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="c1"># Some diffraction patterns are not centered, and so there&#39;s a lot of </span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>        <span class="c1"># image area that cannot be used for registration.</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>        <span class="c1"># Radial inversion becomes simple inversion of dimensions</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>        <span class="n">side_length</span> <span class="o">=</span> \
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>            <span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">r_</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">r_</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">c_</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">c_</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="n">rs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">r_</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">r_</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>        <span class="n">cs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">c_</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">c_</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">)</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">rs</span><span class="p">,</span> <span class="n">cs</span><span class="p">]</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">rs</span><span class="p">,</span> <span class="n">cs</span><span class="p">]</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>    
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="c1"># (4) Normalize background intensity (optional) -----------------------</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>        <span class="c1"># This step removes intensity variations due to experimental artifacts, </span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        <span class="c1"># such as uneven illumination.</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="k">if</span> <span class="n">normalize_bg</span><span class="p">:</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># float64 before division</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>                <span class="n">image</span> <span class="o">/=</span> <span class="n">gaussian_filter</span><span class="p">(</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>                    <span class="nb">input</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>        <span class="c1"># Replace NaN values with 0s</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="c1"># (5) Compute inversion symmetry using Fourier methods ----------------</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="c1"># an inverted copy of the image (im_i) and mask (mask_i), </span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="c1"># flipping both horizontally and vertically ::-1</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>        <span class="n">im_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>        <span class="n">mask_i</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        <span class="c1"># downsampling to speed up processing (for too large images)</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>        <span class="n">downsampling</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>            <span class="n">downsampling</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>    
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="c1"># phase cross-correlation finds the best alignment between the image</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="c1"># and its inverted copy</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="c1"># the shift tells us how much the center is offset from perfect </span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="c1"># inversion symmetry.</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>        <span class="n">shift</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_fft</span><span class="p">(</span><span class="n">phase_cross_correlation</span><span class="p">)(</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>            <span class="n">reference_image</span><span class="o">=</span><span class="n">image</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>            <span class="n">moving_image</span><span class="o">=</span><span class="n">im_i</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>            <span class="n">reference_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>            <span class="n">moving_mask</span><span class="o">=</span><span class="n">mask_i</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="p">)</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>        
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>        <span class="c1"># The computed shift is rescaled to match the original image resolution.</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="n">correction</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="n">downsampling</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>        <span class="c1"># (6) User information (if required) ----------------------------------</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>                <span class="s2">&quot;Center Determination (PhaseCorrCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>        
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="c1"># Ensure correction is a tuple or list before extracting elements</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="n">correction_r</span><span class="p">,</span> <span class="n">correction_c</span> <span class="o">=</span> <span class="n">correction</span> \
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correction</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> \
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>                <span class="k">else</span> <span class="p">(</span><span class="n">correction</span><span class="p">,</span> <span class="n">correction</span><span class="p">)</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="n">r_final</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">+</span> <span class="n">correction_r</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        <span class="n">c_final</span> <span class="o">=</span> <span class="n">c_</span> <span class="o">+</span> <span class="n">correction_c</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>                
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">r_final</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c_final</span><span class="p">),</span> <span class="kc">None</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>    
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>    <span class="k">def</span> <span class="nf">detection_crosscorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a><span class="sd">        Detects the center of symmetry in a diffraction image using a </span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="sd">        combination of weighted intensity averaging and cross-correlation.</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a><span class="sd">    </span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a><span class="sd">        This method performs the following steps:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a><span class="sd">            1. Estimates an initial center using the weighted average of pixel</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a><span class="sd">               intensities.</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a><span class="sd">            2. Crops the image to focus on its central region.</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a><span class="sd">            3. Optionally normalizes the background to reduce experimental</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a><span class="sd">               artifacts.</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="sd">            4. Computes a refined center by analyzing inversion symmetry </span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a><span class="sd">               using cross-correlation.</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="sd">            5. Returns the final corrected center coordinates.</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a><span class="sd">    </span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a><span class="sd">        Parameters</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a><span class="sd">        ----------</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a><span class="sd">        normalize_bg : bool, optional, default=True</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a><span class="sd">            If True, normalizes the background intensity to reduce illumination </span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a><span class="sd">            artifacts. </span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a><span class="sd">            </span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a><span class="sd">            If True, applies Sobel filtering to enhance edges prior to processing. </span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a><span class="sd">            </span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a><span class="sd">        disp : bool, optional, default=False</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">            If True, displays intermediate processing results.</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a><span class="sd">    </span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">        Returns</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">        -------</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a><span class="sd">        r_final : float</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a><span class="sd">            Estimated row-coordinate of the image center after refinement.</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a><span class="sd">            </span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a><span class="sd">        c_final : float</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a><span class="sd">            Estimated column-coordinate of the image center after refinement.</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>       
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>        <span class="c1"># (1) Get image -------------------------------------------------------</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>        
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>        <span class="c1"># Apply Sobel filter if requested</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>        
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>        <span class="c1"># Shift pixel values to ensure non-negative image</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>        <span class="n">image</span> <span class="o">-=</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>     
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>    
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>        <span class="c1"># (2) Normalize background intensity (optional) -----------------------</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="k">if</span> <span class="n">normalize_bg</span><span class="p">:</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                <span class="n">image</span> <span class="o">/=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                                         <span class="n">sigma</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> 
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>                                         <span class="n">truncate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>        
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>        <span class="c1"># Replace NaN values with 0s</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>    
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>        <span class="c1"># (3) Compute inversion symmetry using cross-correlation --------------</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>        <span class="c1"># Dynamically set the margin to a reasonable fraction of the image size</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>        <span class="n">margin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>        <span class="n">im_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">]</span>  <span class="c1"># Crop slightly</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>        
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">im_i</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Inverted image for symmetry comparison</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>    
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="c1"># Compute cross-correlation using OpenCV template matching</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="c1"># it finds areas in an image that best match a given template. </span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        <span class="c1"># it compares the original image with its inverted version to measure </span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="c1"># inversion symmetry</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>        <span class="c1"># im_i (template) slides over image in a pixel-by-pixel manner.</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="c1"># at each position, it computes the cross-correlation between </span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>        <span class="c1"># overlapping pixels.</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="c1"># result is a 2D matrix, where each value represents the correlation </span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="c1"># score at a particular location. Higher values indicate</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>        <span class="c1"># better symmetry at that position.</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>        
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>        <span class="c1"># Ensure template is smaller than image</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="ow">and</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="s2">&quot;Template is larger than the image&quot;</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>        
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>                                   <span class="n">template</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>                                   <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCORR_NORMED</span><span class="p">)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>        <span class="c1"># Get the location of the best match in `result`</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="n">max_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>        <span class="n">correction_r</span><span class="p">,</span> <span class="n">correction_c</span> <span class="o">=</span> <span class="n">max_location</span>  
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>        
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span> 
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation matrix&quot;</span><span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>        
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>        <span class="c1"># Adjust to original image coordinates (account for template cropping)</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>        <span class="n">corrected_r</span> <span class="o">=</span> <span class="n">correction_r</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>        <span class="n">corrected_c</span> <span class="o">=</span> <span class="n">correction_c</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>        
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>        <span class="c1"># (4) Visualization ---------------------------------------------------</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>        <span class="c1"># Plot with correct alignment</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>            
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">:</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>                <span class="n">orig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>            
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>            <span class="c1"># Assuming fft_im_i is your Fourier transform image</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>            <span class="n">center_size</span> <span class="o">=</span> <span class="mi">513</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="n">center_x</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="n">center_y</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="c1"># Crop the central part of the spectrum</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>            <span class="n">orig</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>                <span class="n">center_y</span> <span class="o">-</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">center_y</span> <span class="o">+</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>                <span class="n">center_x</span> <span class="o">-</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">center_x</span> <span class="o">+</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>            
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">corrected_c</span><span class="o">-</span><span class="n">center_x</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">corrected_r</span><span class="o">-</span><span class="n">center_y</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>            <span class="n">my_title</span> <span class="o">=</span>  <span class="s2">&quot;Location of the highest correlation coefficient&quot;</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>            <span class="n">my_title</span> <span class="o">+=</span> <span class="s2">&quot;in the original image.&quot;</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_title</span><span class="p">)</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>            
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>        
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>        <span class="c1"># (5) User information (if required) ----------------------------------</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>                <span class="s2">&quot;Center Determination (CrossCorrCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">corrected_r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">corrected_c</span><span class="p">),</span> <span class="kc">None</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>    
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>    <span class="k">def</span> <span class="nf">detection_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>                            <span class="n">csquare</span><span class="p">,</span> <span class="n">cintensity</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a><span class="sd">        </span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a><span class="sd">        Parameters</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a><span class="sd">        ----------</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a><span class="sd">            </span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="sd">            The intensity center will be searched only within the central</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a><span class="sd">            square.</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a><span class="sd">            to minimize the effect of possible intensity assymetry</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a><span class="sd">            around the center. </span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a><span class="sd">            </span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a><span class="sd">            </span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a><span class="sd">        Returns</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="sd">        -------</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="sd">        xc, yc : float,float</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="sd">        &#39;&#39;&#39;</span>  
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>        
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>        <span class="c1"># (1) Get image/array size --------------------------------------------</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>        
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>             
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>        
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        <span class="c1"># (2) Calculate borders around the central square ---------------------</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>        
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>        <span class="c1"># (3) Create the central square, --------------------------------------</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>        <span class="c1"># from which the intensity center will be detected</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>        
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>        <span class="c1"># (4) In the central square, ------------------------------------------</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>        <span class="c1"># set all values below cintenstity to zero</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>        
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>        <span class="c1"># (5) Determine the intensity center from image moments ---------------</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>        <span class="c1"># see image moments in...</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="c1"># skimage: https://scikit-image.org/docs/dev/api/skimage.measure.html</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="c1"># wikipedia: https://en.wikipedia.org/wiki/Image_moment -&gt; Centroid</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>        <span class="c1"># ---</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>        <span class="c1"># (a) Calculate 1st central moments of the image</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>        <span class="c1"># (b) Calculate the intensity center = centroid according to www-help</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>        <span class="c1"># (c) We have centroid of the central square</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>        <span class="c1"># but we have to recalculate it to the whole image</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">xborder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">yborder</span><span class="p">)</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>        <span class="c1"># (d) Radius of a diffraction ring </span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rtype</span><span class="p">,</span> 
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>            <span class="n">image</span><span class="p">,</span> 
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>            <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>        
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>        <span class="c1"># (6) User information (if required) ----------------------------------</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span>\
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>                <span class="s2">&quot;Center Determination (IntensityCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>        <span class="c1"># (7) Plot results (if required) --------------------------------------</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>        <span class="c1"># (8) Return the results: ---------------------------------------------</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>        <span class="c1">#  a) XY-coordinates of the center</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>        <span class="c1">#  b) radius of the circle/diff.ring,</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>        <span class="c1">#     from which the center was determined</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>    
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>    <span class="k">def</span> <span class="nf">detection_Hough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>                        <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;        </span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a><span class="sd">        Perform Hough transform to detect the center of diffraction patterns </span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a><span class="sd">        with optional real-time visualization and a final image showing all </span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a><span class="sd">        detected circles.</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a><span class="sd">    </span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a><span class="sd">        Parameters</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a><span class="sd">        ----------</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a><span class="sd">            If 1, shows the final detected circle.</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a><span class="sd">        </span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a><span class="sd">            If True, applies Sobel filtering to enhance edges prior to processing. </span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a><span class="sd">            </span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a><span class="sd">        sobel            </span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a><span class="sd">        live_plot : bool, optional, default=False</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a><span class="sd">            If True, animates the circle detection process and shows all </span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a><span class="sd">            detected circles.</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a><span class="sd">    </span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a><span class="sd">        Returns</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a><span class="sd">        -------</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a><span class="sd">        self.x : float64</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a><span class="sd">            x-coordinate of the detected center.</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a><span class="sd">            </span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a><span class="sd">        self.y : float64</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a><span class="sd">            y-coordinate of the detected center.</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a><span class="sd">            </span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a><span class="sd">        self.r : float64</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a><span class="sd">            Radius of the detected circle.</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>        
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>        <span class="c1">## (0) Image preprocessing --------------------------------------------</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>                    
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">:</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">skf</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>                              <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>                              <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>                              <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">:</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">skf</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>                              <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>                              <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> 
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>                              <span class="n">high_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>        <span class="c1">## (1) Define the radii range for concentric circles ------------------</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>        <span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">radius_step</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">10</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span> <span class="o">+</span> <span class="n">radius_step</span><span class="p">,</span> <span class="n">radius_step</span><span class="p">)</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>    
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>        <span class="c1"># Store detected circles</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>        <span class="n">detected_circles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>    
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>                
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Live Hough Circle Detection&quot;</span><span class="p">)</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>  <span class="c1"># Turn on interactive mode</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>    
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>        <span class="c1">## (2) Process each radius one at a time ------------------------------</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>            <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">]))</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>            <span class="n">accums</span><span class="p">,</span> <span class="n">x_peaks</span><span class="p">,</span> <span class="n">y_peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> 
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>                                                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">]),</span> 
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>                                                             <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>    
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>            <span class="c1"># Store circle if detected</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>                <span class="n">detected_circles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">))</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>    
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>            <span class="c1"># Live animation (if enabled)</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>            <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detecting Circles: Radius </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">)</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">detected_circles</span><span class="p">:</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>                    <span class="n">circ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rad</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>                                      <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>    
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="c1">## (3) Final detected circle ------------------------------------------</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>        <span class="n">accums</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>            <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">radii</span><span class="p">),</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>            <span class="n">radii</span><span class="p">,</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>            <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">5</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>        <span class="p">)</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>        
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> \
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>    
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>        <span class="c1">## (4) User information -----------------------------------------------</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>                <span class="s2">&quot;Center Determination (HoughTransform) : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span>\
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>                    <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>    
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>        <span class="c1">## (5) Final plot with all detected circles (if enabled) --------------</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>  <span class="c1"># Turn off interactive mode</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>        
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>        
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>            <span class="n">fig_final</span><span class="p">,</span> <span class="n">ax_final</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hough Transform Preliminary Detection&quot;</span><span class="p">)</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>        
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">detected_circles</span><span class="p">:</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>                <span class="n">circ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rad</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>                                  <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>                <span class="n">ax_final</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>        
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>            <span class="c1"># Highlight the final detected circle (red)</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>            <span class="n">circ_final</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>                                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Selected Circle&quot;</span><span class="p">)</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ_final</span><span class="p">)</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>        
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>            <span class="c1"># Create a single blue circle just for the legend</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>            <span class="n">legend_blue</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>                                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>                                     <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>                                     <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>                                     <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Searching Space&quot;</span><span class="p">)</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>        
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>            <span class="c1"># Add the legend</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">legend_blue</span><span class="p">,</span> <span class="n">circ_final</span><span class="p">])</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>    
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>        <span class="c1"># Close live plot (to avoid non-closed windows in Jupyter)</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>        
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="c1">## (6) Final detected circle visualization (if requested) --------------</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>    
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>   
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>    <span class="k">def</span> <span class="nf">detection_curvefit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a><span class="sd">        Detects the center of a diffraction pattern by fitting a 2D pseudo-Voigt </span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a><span class="sd">        function to the central region of the image.</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a><span class="sd">     </span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a><span class="sd">        This method:</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a><span class="sd">            - Crops a square region around the image center.</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a><span class="sd">            - Fits a 2D pseudo-Voigt peak to the cropped region.</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a><span class="sd">            - Returns the refined center coordinates in the original image space.</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a><span class="sd">            - Optionally visualizes the result.</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a><span class="sd">            - Falls back to the crop center if fitting fails.</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a><span class="sd">     </span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a><span class="sd">        Parameters</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a><span class="sd">        ----------</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a><span class="sd">            If True, displays the fitted center location on the image. </span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a><span class="sd">     </span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a><span class="sd">        Returns</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a><span class="sd">        -------</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a><span class="sd">        x : float</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a><span class="sd">            Refined x-coordinate of the center (column index).</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a><span class="sd">            </span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a><span class="sd">        y : float</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a><span class="sd">            Refined y-coordinate of the center (row index).</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>    
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>        <span class="k">def</span> <span class="nf">pseudo_voigt_2d</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a><span class="sd">            Computes a 2D pseudo-Voigt function, which is a linear combination </span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="sd">            of a Gaussian and a Lorentzian function.</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="sd">        </span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">            Parameters</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a><span class="sd">            ----------</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a><span class="sd">            xy : tuple of numpy.ndarray</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a><span class="sd">                A tuple (x, y) containing coordinate meshgrids.</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a><span class="sd">                </span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a><span class="sd">            amp : float</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a><span class="sd">                Amplitude of the peak.</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a><span class="sd">                </span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a><span class="sd">            x0, y0 : float</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a><span class="sd">                Coordinates of the center of the peak.</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a><span class="sd">                </span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a><span class="sd">            sigma_x, sigma_y : float</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a><span class="sd">                Width (standard deviation) of the peak along the x and y axes.</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a><span class="sd">                </span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a><span class="sd">            eta : float</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a><span class="sd">                Mixing parameter (0 = pure Gaussian, 1 = pure Lorentzian).</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a><span class="sd">        </span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a><span class="sd">            Returns</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a><span class="sd">            -------</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a><span class="sd">            numpy.ndarray</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a><span class="sd">                Flattened 1D array of function values evaluated at the input </span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a><span class="sd">                coordinates.</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>            <span class="n">r_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_x</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>            <span class="n">r_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_y</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>    
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>            <span class="n">gaussian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>            <span class="n">lorentzian</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>    
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>            <span class="k">return</span> <span class="n">amp</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">gaussian</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">lorentzian</span><span class="p">)</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>        
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>        <span class="c1"># Define crop size around the center of the image</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>        <span class="n">crop_size</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>        
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>        <span class="c1"># Make a copy of the image to avoid modifying the original</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>        
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>        <span class="c1"># Get the image dimensions</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>        
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>        <span class="c1"># Estimate the center of the image</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>        <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">=</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>    
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>        <span class="c1"># Calculate the bounds of the cropped square region</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>        <span class="n">half_crop</span> <span class="o">=</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_center</span> <span class="o">-</span> <span class="n">half_crop</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">half_crop</span><span class="p">)</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">-</span> <span class="n">half_crop</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">+</span> <span class="n">half_crop</span><span class="p">)</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>    
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>        <span class="c1"># Crop the image around the center for curve fitting</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>        <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>    
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>        <span class="c1"># Create a meshgrid of x and y coordinates for the cropped region</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>                           <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>        
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>        <span class="c1"># Flatten the meshgrid coordinates and image for use with curve fitting</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>        <span class="n">x_flat</span><span class="p">,</span> <span class="n">y_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>        <span class="n">image_flat</span> <span class="o">=</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>        <span class="c1"># Set initial parameter guesses for curve fitting:</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>        <span class="c1"># [amplitude, x0, y0, sigma_x, sigma_y, eta]    </span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>        <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">),</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>            <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>            <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>            <span class="mf">0.5</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>        <span class="p">]</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>        
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>        <span class="c1"># Define bounds for each parameter during optimization</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>        <span class="p">)</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>    
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>            <span class="c1"># Fit the pseudo-Voigt function to the cropped image</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>                <span class="n">pseudo_voigt_2d</span><span class="p">,</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>                <span class="p">(</span><span class="n">x_flat</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">),</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>                <span class="n">image_flat</span><span class="p">,</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>                <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>                <span class="n">max_nfev</span><span class="o">=</span><span class="mi">2000</span>  <span class="c1"># increase if needed</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>            <span class="p">)</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>            
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>            <span class="c1"># Extract refined x and y center coordinates from fit</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>            <span class="n">x_refined</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>            <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>    
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>            <span class="c1"># If fitting fails, fall back to geometric center </span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>            <span class="n">x_refined</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">=</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>            <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>            
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>        <span class="c1"># Add the offset of the cropped region to get coordinates in full image</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">x_refined</span> <span class="o">+</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">+</span> <span class="n">y_min</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>        
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>        <span class="c1"># Print the result if verbose are enabled</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>                <span class="sa">f</span><span class="s2">&quot;Center Determination (CurveFitting) :   (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; [fallback]&quot;</span> <span class="k">if</span> <span class="n">used_fallback</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>            <span class="p">)</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>            
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>        <span class="c1"># Optionally show the result visually</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>    
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>    <span class="k">def</span> <span class="nf">detection_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a><span class="sd">        Semi-automated detection of the diffraction pattern center using manual </span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a><span class="sd">        selection of 3 points.</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a><span class="sd">        This method allows the user to manually select 3 points along a visible </span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a><span class="sd">        diffraction ring in the image to define a circle. Once selected, </span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a><span class="sd">        the center and radius of the circle are automatically computed. After </span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a><span class="sd">        that, the user can manually adjust the center position using</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a><span class="sd">        an interactive interface.</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a><span class="sd">        User Controls (during point selection)</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a><span class="sd">        --------------------------------------</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a><span class="sd">        - **&#39;1&#39;**: Add a point at the current mouse cursor position </span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a><span class="sd">                         (max 3 points).</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a><span class="sd">        - **&#39;2&#39;**: Delete the most recently added point.</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a><span class="sd">        - **&#39;3&#39;**: Delete the point closest to the mouse cursor.</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a><span class="sd">        - **&#39;d&#39;**: When 3 points are selected (DONE), proceed </span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a><span class="sd">        - **Close**    : Terminate the process without detecting a center.</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a><span class="sd">        </span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a><span class="sd">        Parameters</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a><span class="sd">        ----------</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a><span class="sd">        plot_results : int, binary, default=0</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a><span class="sd">        </span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a><span class="sd">        Returns</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a><span class="sd">        -------</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a><span class="sd">        self.x : float64</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a><span class="sd">            </span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a><span class="sd">        self.y : float64</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a><span class="sd">            </span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a><span class="sd">        self.r : float64</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a><span class="sd">            (if available, othervise returns None)</span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a><span class="sd">                                    </span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>        <span class="c1"># (0) Load and prepare image ------------------------------------------</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>        
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>            
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="c1"># (2) Create a figure and display the image ---------------------------</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> 
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>        
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a> 
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Select 3 points defining one of diffraction circles&quot;</span><span class="p">,</span> 
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>                  <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>        <span class="c1"># (3) User information ------------------------------------------------</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a><span class="sd">            CenterDetermination :: ThreePoints (semi-automated method)</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a><span class="sd">            Select 3 points to define a diffraction circle using keys:</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a><span class="sd">              - &#39;1&#39; : define a point at current cursor position</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a><span class="sd">              - &#39;2&#39; : delete the last point</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a><span class="sd">              - &#39;3&#39; : delete the point closest to the cursor</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a><span class="sd">              - &#39;d&#39; : done = finished = go to the next step</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a><span class="sd">            Close the figure to terminate. No center will be detected.</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>       
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>        <span class="c1"># (4) Enable interactive mode -----------------------------------------</span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>        <span class="c1"># (figure is updated after every plotting command</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>        <span class="c1"># (so that calling figure.show() is not necessary</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a> 
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>        <span class="c1"># (5) Initialization</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>        <span class="c1"># Initialize the list of coordinates</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span> 
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>        
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>        <span class="c1"># Initialize all flags and counters</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>        <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># press &#39;d&#39; event</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># close window event</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>        <span class="n">point_counter</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># number of selected points</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>        
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>        <span class="c1"># (6) Define the event handler for figure close event -----------------</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execution terminated.&#39;</span><span class="p">)</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a> 
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>        
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>        
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>        <span class="c1"># (7) Define the callback function for key press events ---------------</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>        <span class="k">def</span> <span class="nf">onkeypress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>            <span class="c1"># nonlocal to modify the flag variable in the outer scope</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>            <span class="k">nonlocal</span> <span class="n">calculate_circle_flag</span><span class="p">,</span> <span class="n">point_counter</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>            
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>            <span class="c1"># Store the zoom level</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>            <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>            <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a> 
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>            <span class="c1">## Delete points -- the closest to the cursor</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>                <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>                    <span class="n">pointer_x</span><span class="p">,</span> <span class="n">pointer_y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">pointer_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">pointer_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">]</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>                    <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">closest_index</span><span class="p">]</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>    
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>                    <span class="c1">## Redraw the image without the deleted point</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>                    <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>                        <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>                        <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>                    
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>                    
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>    
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>            <span class="c1"># Delete recent point (last added) -- independent on the cursor</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>                <span class="c1"># Check if there are points to delete</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>                    <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>                        <span class="c1"># Delete the last point in the list</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>    
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>                        <span class="c1"># Redraw the image without the deleted point</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>                                  <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>                                       <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>                                       <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>                        <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>                            <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>                            <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">)</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>                        
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>                        <span class="c1"># Retore the previous zoom level</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>                    
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>            <span class="c1">## Select points </span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>                <span class="c1"># Only allow selecting up to three points</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>                    <span class="c1"># Save the coordinates of the clicked point</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>                    <span class="n">new_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>                    
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>                    <span class="k">if</span> <span class="n">new_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a>                        <span class="c1"># Do not allow multiple selection of one point</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The selected point already exists.&quot;</span><span class="p">)</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>                        <span class="c1"># Add selected point</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>    
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>                        <span class="c1"># Visualize the selected point on the image</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>                        <span class="c1"># Restore the previous zoom level</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>    
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>                        <span class="n">point_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>    
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>                    <span class="c1"># Turn off interactive mode</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>    
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>    
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>            <span class="c1"># (8) Calculate circle or terminate -------------------------------</span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>                    <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a> 
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select exactly 3 points to calculate the circle.&quot;</span><span class="p">)</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>    
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>        <span class="n">cid0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress</span><span class="p">)</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>        <span class="c1"># Show the plot </span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>      
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>        <span class="c1"># Wait for &#39;d&#39; key event or close the figure if no points are selected</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">calculate_circle_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a> 
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>                <span class="c1"># Store the zoom level</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>                <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>                <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a> 
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>                <span class="c1"># Plot detected diffraction pattern</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>                <span class="k">if</span> <span class="n">calculate_circle_flag</span><span class="p">:</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a> 
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_circle</span><span class="p">(</span><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>                    
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>                 
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>                    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>                    <span class="c1"># Plot center point</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>                    <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the position of the center using keys.&#39;</span><span class="p">)</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>        
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>                    <span class="c1"># Display the image</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution manually interrupted by user.&quot;</span><span class="p">)</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>                <span class="k">break</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ValueError:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>                <span class="k">break</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>           
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points selected. Returned None values.&quot;</span><span class="p">)</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>             <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>        
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>        <span class="c1"># Disconnect key press events</span>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">cid0</span><span class="p">)</span> 
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>        
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>        <span class="c1"># local variables save</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>        
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>        <span class="c1"># Manually adjust the calculated center coordinates</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjustment_3points</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>        <span class="c1"># Return the results:</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>    
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>    
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>    <span class="k">def</span> <span class="nf">adjustment_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a><span class="sd">        Manual/interactive refinement of the diffraction pattern center</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a><span class="sd">        after initial detection via 3 points.</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a><span class="sd">        User Controls (during point selection)</span>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a><span class="sd">        --------------------------------------</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a><span class="sd">        This method allows the user to fine-tune the estimated</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a><span class="sd">        center and radius of a diffraction ring,</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a><span class="sd">        (which was determined manually by selecting 3 points)</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a><span class="sd">        by means of the following interactive keyboard controls:</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a><span class="sd">        - Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a><span class="sd">        - **&#39;+&#39;** : Increase the radius</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a><span class="sd">        - **&#39;-&#39;** : Decrease the radius</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a><span class="sd">        - **&#39;b&#39;** : Increase step size (×5)</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a><span class="sd">        - **&#39;l&#39;** : Decrease step size (/5, with minimum step size 0.5)</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a><span class="sd">        - **&#39;d&#39;**: Done — finalize the center and radius</span>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a><span class="sd">        - Closing the figure: Cancels refinement and returns the original input </span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a><span class="sd">          center and radius</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a><span class="sd">        Parameters</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a><span class="sd">        ----------</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a><span class="sd">        fig : matplotlib.figure.Figure</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a><span class="sd">            The figure window used for interactive refinement.</span>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a><span class="sd">            </span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a><span class="sd">        circle : matplotlib.patches.Circle</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a><span class="sd">            The circle object initially defined from 3 selected points.</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a><span class="sd">            </span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a><span class="sd">        center : tuple</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a><span class="sd">            The initial (x, y) center coordinates estimated from the selected </span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a><span class="sd">            points.</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a><span class="sd">            </span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a><span class="sd">            If True, the results of the adjustment are visualized.</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a><span class="sd">        Returns</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a><span class="sd">        -------</span>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a><span class="sd">        xy[0] : float</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a><span class="sd">            x-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a><span class="sd">            </span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a><span class="sd">        xy[1] : float</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a><span class="sd">            y-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a><span class="sd">            </span>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a><span class="sd">        r : float</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a><span class="sd">            Adjusted radius of the diffraction ring.</span>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a><span class="sd">        Notes</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a><span class="sd">        -----</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a><span class="sd">        - Interactive adjustments are visualized in real time.</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a><span class="sd">        - Intensity sum at the current center/radius is printed if print_sums</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a><span class="sd">          is True.</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a><span class="sd">        - Arrow key defaults in Matplotlib (e.g., navigation) are temporarily </span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a><span class="sd">          disabled to allow movement control.</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>                    
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>        <span class="c1"># Remove default left / right arrow key press events</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>        
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a><span class="sd">            CenterDetermination :: ThreePoints (interactive adjustment)</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a><span class="sd">            Use these keys:</span>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a><span class="sd">              - &#39;←&#39; : move left</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a><span class="sd">              - &#39;→&#39; : move right</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a><span class="sd">              - &#39;↑&#39; : move up</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a><span class="sd">              - &#39;↓&#39; : move down</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a><span class="sd">              - &#39;+&#39; : increase circle radius</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a><span class="sd">              - &#39;-&#39; : decrease circle radius</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a><span class="sd">              - &#39;b&#39; : increase step size</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a><span class="sd">              - &#39;l&#39; : decrease step size</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a><span class="sd">              - &#39;d&#39; : refinement done</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a><span class="sd">                  </span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a><span class="sd">            DISCLAIMER: For the purpose of the center position adjustment, </span>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a><span class="sd">                        the default shortcuts for arrows were removed.</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>        
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>            
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a>        
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a>          
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>        
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a>        
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>        
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a>                    
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>            
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>        
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>            <span class="c1"># Change step size </span>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>        
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>        
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>        
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>        
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>            <span class="c1"># Update the plot</span>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>                
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>        
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>               
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>                
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>        
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>        
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>        <span class="c1"># User information:</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (ThreePoints)    : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>        
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>    
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>        
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>    <span class="k">def</span> <span class="nf">calculate_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>            <span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">]:</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a><span class="sd">        Calculate the center and radius of a circle defined by 3 manually </span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a><span class="sd">        selected points.</span>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a><span class="sd">        Given three user-defined points (typically on a diffraction ring), this </span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a><span class="sd">        method computes the center and radius of the circle that passes through </span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a><span class="sd">        them. Optionally, it visualizes the result including the circle, center, </span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a><span class="sd">        and selected points overlaid on the image.</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a><span class="sd">        Parameters</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a><span class="sd">        ----------</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a><span class="sd">        plot_results : int (binary: 0 or 1)</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a><span class="sd">            If 1, displays the image with the fitted circle and center.</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a><span class="sd">            If 0, skips visualization.</span>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a><span class="sd">        Returns</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a><span class="sd">        -------</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a><span class="sd">        self.x : float</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a><span class="sd">            x-coordinate of the detected circle center.</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a><span class="sd">        self.y : float</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a><span class="sd">            y-coordinate of the detected circle center.</span>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a><span class="sd">        self.r : float</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a><span class="sd">            Radius of the detected circle.</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a><span class="sd">        self.center : tuple[float, float]</span>
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a><span class="sd">            The (x, y) coordinates of the circle center.</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a><span class="sd">        self.circle : matplotlib.patches.Circle</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a><span class="sd">            A matplotlib Circle object that can be reused for future plotting.</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a><span class="sd">        Notes</span>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a><span class="sd">        -----</span>
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a><span class="sd">        - The method uses a geometric approach to calculate the circumcenter</span>
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a><span class="sd">          and circumradius.</span>
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a><span class="sd">        - For best visual results, ensure the selected points are well spaced </span>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a><span class="sd">          and belong to the same circular ring.</span>
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>        <span class="c1"># Extract the coordinates of the points        </span>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a>        
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>        <span class="c1"># Compute the radius and center coordinates of the circle</span>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a>            <span class="c1"># a: the squared length of the side between the second </span>
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a>            <span class="c1">#    and third points (x[1], y[1]) and (x[2], y[2]).</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a>            <span class="c1"># b: the squared length of the side between the first </span>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a>            <span class="c1">#    and third points (x[0], y[0]) and (x[2], y[2]).</span>
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a>            <span class="c1"># c: the squared length of the side between the first </span>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a>            <span class="c1">#    and second points (x[0], y[0]) and (x[1], y[1]).</span>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a>            <span class="c1"># s: the twice the signed area of the triangle formed by 3 points</span>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a>            
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-2608"><a href="#L-2608"><span class="linenos">2608</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-2609"><a href="#L-2609"><span class="linenos">2609</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-2610"><a href="#L-2610"><span class="linenos">2610</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> 
</span><span id="L-2611"><a href="#L-2611"><span class="linenos">2611</span></a>        
</span><span id="L-2612"><a href="#L-2612"><span class="linenos">2612</span></a>        <span class="c1"># coordinates of the center</span>
</span><span id="L-2613"><a href="#L-2613"><span class="linenos">2613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span>
</span><span id="L-2614"><a href="#L-2614"><span class="linenos">2614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span> 
</span><span id="L-2615"><a href="#L-2615"><span class="linenos">2615</span></a>        
</span><span id="L-2616"><a href="#L-2616"><span class="linenos">2616</span></a>        <span class="c1"># radius</span>
</span><span id="L-2617"><a href="#L-2617"><span class="linenos">2617</span></a>        <span class="n">ar</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-2618"><a href="#L-2618"><span class="linenos">2618</span></a>        <span class="n">br</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-2619"><a href="#L-2619"><span class="linenos">2619</span></a>        <span class="n">cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="mf">0.5</span> 
</span><span id="L-2620"><a href="#L-2620"><span class="linenos">2620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">ar</span><span class="o">*</span><span class="n">br</span><span class="o">*</span><span class="n">cr</span><span class="o">/</span><span class="p">((</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">-</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">-</span><span class="n">cr</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-2621"><a href="#L-2621"><span class="linenos">2621</span></a>        
</span><span id="L-2622"><a href="#L-2622"><span class="linenos">2622</span></a>        <span class="c1"># # Print results</span>
</span><span id="L-2623"><a href="#L-2623"><span class="linenos">2623</span></a>        <span class="c1"># if self.parent.verbose:</span>
</span><span id="L-2624"><a href="#L-2624"><span class="linenos">2624</span></a>        <span class="c1">#     print(&quot;CenterEstimator :: manual center detection&quot;)</span>
</span><span id="L-2625"><a href="#L-2625"><span class="linenos">2625</span></a>        <span class="c1">#     print(f&quot;Center coordinates: {self.x:.2f} {self.y:.2f}&quot;)</span>
</span><span id="L-2626"><a href="#L-2626"><span class="linenos">2626</span></a>                    
</span><span id="L-2627"><a href="#L-2627"><span class="linenos">2627</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2628"><a href="#L-2628"><span class="linenos">2628</span></a>            <span class="c1"># Create and manage the figure</span>
</span><span id="L-2629"><a href="#L-2629"><span class="linenos">2629</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-2630"><a href="#L-2630"><span class="linenos">2630</span></a>            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
</span><span id="L-2631"><a href="#L-2631"><span class="linenos">2631</span></a>            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
</span><span id="L-2632"><a href="#L-2632"><span class="linenos">2632</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-2633"><a href="#L-2633"><span class="linenos">2633</span></a>                      <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-2634"><a href="#L-2634"><span class="linenos">2634</span></a>            
</span><span id="L-2635"><a href="#L-2635"><span class="linenos">2635</span></a>            <span class="c1"># Plot center and points</span>
</span><span id="L-2636"><a href="#L-2636"><span class="linenos">2636</span></a>            <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="L-2637"><a href="#L-2637"><span class="linenos">2637</span></a>                     <span class="s1">&#39;rx&#39;</span><span class="p">,</span> 
</span><span id="L-2638"><a href="#L-2638"><span class="linenos">2638</span></a>                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center&#39;</span><span class="p">,</span> 
</span><span id="L-2639"><a href="#L-2639"><span class="linenos">2639</span></a>                     <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-2640"><a href="#L-2640"><span class="linenos">2640</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> 
</span><span id="L-2641"><a href="#L-2641"><span class="linenos">2641</span></a>                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-2642"><a href="#L-2642"><span class="linenos">2642</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="L-2643"><a href="#L-2643"><span class="linenos">2643</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Circle points&#39;</span><span class="p">)</span>
</span><span id="L-2644"><a href="#L-2644"><span class="linenos">2644</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Circle found using 3 manually detected points&#39;</span><span class="p">)</span>
</span><span id="L-2645"><a href="#L-2645"><span class="linenos">2645</span></a>            
</span><span id="L-2646"><a href="#L-2646"><span class="linenos">2646</span></a>            <span class="c1"># Circle visualization</span>
</span><span id="L-2647"><a href="#L-2647"><span class="linenos">2647</span></a>            <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> 
</span><span id="L-2648"><a href="#L-2648"><span class="linenos">2648</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="L-2649"><a href="#L-2649"><span class="linenos">2649</span></a>                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="L-2650"><a href="#L-2650"><span class="linenos">2650</span></a>                                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2651"><a href="#L-2651"><span class="linenos">2651</span></a>                                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
</span><span id="L-2652"><a href="#L-2652"><span class="linenos">2652</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="L-2653"><a href="#L-2653"><span class="linenos">2653</span></a>            
</span><span id="L-2654"><a href="#L-2654"><span class="linenos">2654</span></a>            <span class="c1"># Set the aspect ratio to equal to have a circular shape</span>
</span><span id="L-2655"><a href="#L-2655"><span class="linenos">2655</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="L-2656"><a href="#L-2656"><span class="linenos">2656</span></a>            
</span><span id="L-2657"><a href="#L-2657"><span class="linenos">2657</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> 
</span><span id="L-2658"><a href="#L-2658"><span class="linenos">2658</span></a>                       <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="L-2659"><a href="#L-2659"><span class="linenos">2659</span></a>                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> 
</span><span id="L-2660"><a href="#L-2660"><span class="linenos">2660</span></a>                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> 
</span><span id="L-2661"><a href="#L-2661"><span class="linenos">2661</span></a>                       <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2662"><a href="#L-2662"><span class="linenos">2662</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2663"><a href="#L-2663"><span class="linenos">2663</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-2664"><a href="#L-2664"><span class="linenos">2664</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2665"><a href="#L-2665"><span class="linenos">2665</span></a>
</span><span id="L-2666"><a href="#L-2666"><span class="linenos">2666</span></a>        
</span><span id="L-2667"><a href="#L-2667"><span class="linenos">2667</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-2668"><a href="#L-2668"><span class="linenos">2668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-2669"><a href="#L-2669"><span class="linenos">2669</span></a>        
</span><span id="L-2670"><a href="#L-2670"><span class="linenos">2670</span></a>
</span><span id="L-2671"><a href="#L-2671"><span class="linenos">2671</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle</span>
</span><span id="L-2672"><a href="#L-2672"><span class="linenos">2672</span></a>
</span><span id="L-2673"><a href="#L-2673"><span class="linenos">2673</span></a>
</span><span id="L-2674"><a href="#L-2674"><span class="linenos">2674</span></a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span>
</span><span id="L-2675"><a href="#L-2675"><span class="linenos">2675</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">rtype</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">disp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-2676"><a href="#L-2676"><span class="linenos">2676</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2677"><a href="#L-2677"><span class="linenos">2677</span></a><span class="sd">        Calculate the radius of a circle based on intensity profiles along </span>
</span><span id="L-2678"><a href="#L-2678"><span class="linenos">2678</span></a><span class="sd">        horizontal and vertical axes.</span>
</span><span id="L-2679"><a href="#L-2679"><span class="linenos">2679</span></a><span class="sd">    </span>
</span><span id="L-2680"><a href="#L-2680"><span class="linenos">2680</span></a><span class="sd">        Parameters</span>
</span><span id="L-2681"><a href="#L-2681"><span class="linenos">2681</span></a><span class="sd">        ----------</span>
</span><span id="L-2682"><a href="#L-2682"><span class="linenos">2682</span></a><span class="sd">        rtype : integer</span>
</span><span id="L-2683"><a href="#L-2683"><span class="linenos">2683</span></a><span class="sd">            Method for radius calculation. Default is 0.</span>
</span><span id="L-2684"><a href="#L-2684"><span class="linenos">2684</span></a><span class="sd">            - rtype=0 : peaks matching method</span>
</span><span id="L-2685"><a href="#L-2685"><span class="linenos">2685</span></a><span class="sd">            - rtype=1 : radial distribution method</span>
</span><span id="L-2686"><a href="#L-2686"><span class="linenos">2686</span></a><span class="sd">            </span>
</span><span id="L-2687"><a href="#L-2687"><span class="linenos">2687</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="L-2688"><a href="#L-2688"><span class="linenos">2688</span></a><span class="sd">            The 2D image array containing the circle. </span>
</span><span id="L-2689"><a href="#L-2689"><span class="linenos">2689</span></a><span class="sd">            </span>
</span><span id="L-2690"><a href="#L-2690"><span class="linenos">2690</span></a><span class="sd">        x : float</span>
</span><span id="L-2691"><a href="#L-2691"><span class="linenos">2691</span></a><span class="sd">            The x-coordinate of the circle&#39;s center.</span>
</span><span id="L-2692"><a href="#L-2692"><span class="linenos">2692</span></a><span class="sd">            </span>
</span><span id="L-2693"><a href="#L-2693"><span class="linenos">2693</span></a><span class="sd">        y : float</span>
</span><span id="L-2694"><a href="#L-2694"><span class="linenos">2694</span></a><span class="sd">            The y-coordinate of the circle&#39;s center.</span>
</span><span id="L-2695"><a href="#L-2695"><span class="linenos">2695</span></a><span class="sd">            </span>
</span><span id="L-2696"><a href="#L-2696"><span class="linenos">2696</span></a><span class="sd">        disp : bool, optional</span>
</span><span id="L-2697"><a href="#L-2697"><span class="linenos">2697</span></a><span class="sd">            If True, visualizes the detected intensity profiles and peaks </span>
</span><span id="L-2698"><a href="#L-2698"><span class="linenos">2698</span></a><span class="sd">            (default is False).</span>
</span><span id="L-2699"><a href="#L-2699"><span class="linenos">2699</span></a><span class="sd">    </span>
</span><span id="L-2700"><a href="#L-2700"><span class="linenos">2700</span></a><span class="sd">        Returns</span>
</span><span id="L-2701"><a href="#L-2701"><span class="linenos">2701</span></a><span class="sd">        -------</span>
</span><span id="L-2702"><a href="#L-2702"><span class="linenos">2702</span></a><span class="sd">        float</span>
</span><span id="L-2703"><a href="#L-2703"><span class="linenos">2703</span></a><span class="sd">            The estimated radius of the circle. Defaults to 100 if no valid </span>
</span><span id="L-2704"><a href="#L-2704"><span class="linenos">2704</span></a><span class="sd">            radius is detected.</span>
</span><span id="L-2705"><a href="#L-2705"><span class="linenos">2705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2706"><a href="#L-2706"><span class="linenos">2706</span></a>        <span class="c1"># Helper function -----------------------------------------------------</span>
</span><span id="L-2707"><a href="#L-2707"><span class="linenos">2707</span></a>        <span class="k">def</span> <span class="nf">match_peaks</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span><span id="L-2708"><a href="#L-2708"><span class="linenos">2708</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2709"><a href="#L-2709"><span class="linenos">2709</span></a><span class="sd">            Find the most similar values across the left and right halves of </span>
</span><span id="L-2710"><a href="#L-2710"><span class="linenos">2710</span></a><span class="sd">            an array, excluding the global maximum.</span>
</span><span id="L-2711"><a href="#L-2711"><span class="linenos">2711</span></a><span class="sd">        </span>
</span><span id="L-2712"><a href="#L-2712"><span class="linenos">2712</span></a><span class="sd">            This function is typically used for analyzing symmetric patterns </span>
</span><span id="L-2713"><a href="#L-2713"><span class="linenos">2713</span></a><span class="sd">            such as diffraction profiles or intensity histograms. It identifies </span>
</span><span id="L-2714"><a href="#L-2714"><span class="linenos">2714</span></a><span class="sd">            the most similar pair of peaks on either side of the central maximum, </span>
</span><span id="L-2715"><a href="#L-2715"><span class="linenos">2715</span></a><span class="sd">            which is excluded from the comparison.</span>
</span><span id="L-2716"><a href="#L-2716"><span class="linenos">2716</span></a><span class="sd">        </span>
</span><span id="L-2717"><a href="#L-2717"><span class="linenos">2717</span></a><span class="sd">            Special case:</span>
</span><span id="L-2718"><a href="#L-2718"><span class="linenos">2718</span></a><span class="sd">            - If the array contains exactly two elements, it assumes they form </span>
</span><span id="L-2719"><a href="#L-2719"><span class="linenos">2719</span></a><span class="sd">              the best pair and returns their indices directly.</span>
</span><span id="L-2720"><a href="#L-2720"><span class="linenos">2720</span></a><span class="sd">            - If one half is empty after removing the central peak,</span>
</span><span id="L-2721"><a href="#L-2721"><span class="linenos">2721</span></a><span class="sd">              it returns (None, None).</span>
</span><span id="L-2722"><a href="#L-2722"><span class="linenos">2722</span></a><span class="sd">        </span>
</span><span id="L-2723"><a href="#L-2723"><span class="linenos">2723</span></a><span class="sd">            Parameters</span>
</span><span id="L-2724"><a href="#L-2724"><span class="linenos">2724</span></a><span class="sd">            ----------</span>
</span><span id="L-2725"><a href="#L-2725"><span class="linenos">2725</span></a><span class="sd">            arr : np.ndarray or list of float</span>
</span><span id="L-2726"><a href="#L-2726"><span class="linenos">2726</span></a><span class="sd">                1D array of values (intensity profile) where symmetric peak</span>
</span><span id="L-2727"><a href="#L-2727"><span class="linenos">2727</span></a><span class="sd">                positions are to be matched.</span>
</span><span id="L-2728"><a href="#L-2728"><span class="linenos">2728</span></a><span class="sd">        </span>
</span><span id="L-2729"><a href="#L-2729"><span class="linenos">2729</span></a><span class="sd">            Returns</span>
</span><span id="L-2730"><a href="#L-2730"><span class="linenos">2730</span></a><span class="sd">            -------</span>
</span><span id="L-2731"><a href="#L-2731"><span class="linenos">2731</span></a><span class="sd">            best_pair : tuple[int or None, int or None]</span>
</span><span id="L-2732"><a href="#L-2732"><span class="linenos">2732</span></a><span class="sd">                Indices of the two most similar values, one from each half of </span>
</span><span id="L-2733"><a href="#L-2733"><span class="linenos">2733</span></a><span class="sd">                the array. Returns (None, None) if no valid pair is found.</span>
</span><span id="L-2734"><a href="#L-2734"><span class="linenos">2734</span></a><span class="sd">        </span>
</span><span id="L-2735"><a href="#L-2735"><span class="linenos">2735</span></a><span class="sd">            Notes</span>
</span><span id="L-2736"><a href="#L-2736"><span class="linenos">2736</span></a><span class="sd">            -----</span>
</span><span id="L-2737"><a href="#L-2737"><span class="linenos">2737</span></a><span class="sd">            - The function assumes the most prominent peak (maximum value) lies </span>
</span><span id="L-2738"><a href="#L-2738"><span class="linenos">2738</span></a><span class="sd">              at or near the center and represents the central feature.</span>
</span><span id="L-2739"><a href="#L-2739"><span class="linenos">2739</span></a><span class="sd">            - The left and right halves are compared pairwise, and the closest </span>
</span><span id="L-2740"><a href="#L-2740"><span class="linenos">2740</span></a><span class="sd">              match in absolute value difference is returned.</span>
</span><span id="L-2741"><a href="#L-2741"><span class="linenos">2741</span></a><span class="sd">            - This is useful for refining radial symmetry or finding symmetric </span>
</span><span id="L-2742"><a href="#L-2742"><span class="linenos">2742</span></a><span class="sd">              ring peaks.</span>
</span><span id="L-2743"><a href="#L-2743"><span class="linenos">2743</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-2744"><a href="#L-2744"><span class="linenos">2744</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not enough values to compare</span>
</span><span id="L-2745"><a href="#L-2745"><span class="linenos">2745</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2746"><a href="#L-2746"><span class="linenos">2746</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough values to find similar pairs.&quot;</span><span class="p">)</span>
</span><span id="L-2747"><a href="#L-2747"><span class="linenos">2747</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-2748"><a href="#L-2748"><span class="linenos">2748</span></a>    
</span><span id="L-2749"><a href="#L-2749"><span class="linenos">2749</span></a>            <span class="c1"># Special case: if there are exactly 2 peaks, return them</span>
</span><span id="L-2750"><a href="#L-2750"><span class="linenos">2750</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2751"><a href="#L-2751"><span class="linenos">2751</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2752"><a href="#L-2752"><span class="linenos">2752</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exactly two peaks detected. Returning them as the best pair.&quot;</span><span class="p">)</span>
</span><span id="L-2753"><a href="#L-2753"><span class="linenos">2753</span></a>                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span id="L-2754"><a href="#L-2754"><span class="linenos">2754</span></a>    
</span><span id="L-2755"><a href="#L-2755"><span class="linenos">2755</span></a>            <span class="c1"># Find the index of the highest value</span>
</span><span id="L-2756"><a href="#L-2756"><span class="linenos">2756</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span id="L-2757"><a href="#L-2757"><span class="linenos">2757</span></a>    
</span><span id="L-2758"><a href="#L-2758"><span class="linenos">2758</span></a>            <span class="c1"># Split into left and right halves, excluding the highest value</span>
</span><span id="L-2759"><a href="#L-2759"><span class="linenos">2759</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="L-2760"><a href="#L-2760"><span class="linenos">2760</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="L-2761"><a href="#L-2761"><span class="linenos">2761</span></a>            <span class="n">left_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>
</span><span id="L-2762"><a href="#L-2762"><span class="linenos">2762</span></a>            <span class="n">right_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
</span><span id="L-2763"><a href="#L-2763"><span class="linenos">2763</span></a>    
</span><span id="L-2764"><a href="#L-2764"><span class="linenos">2764</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check for empty halves</span>
</span><span id="L-2765"><a href="#L-2765"><span class="linenos">2765</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2766"><a href="#L-2766"><span class="linenos">2766</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One of the halves is empty.&quot;</span><span class="p">)</span>
</span><span id="L-2767"><a href="#L-2767"><span class="linenos">2767</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-2768"><a href="#L-2768"><span class="linenos">2768</span></a>    
</span><span id="L-2769"><a href="#L-2769"><span class="linenos">2769</span></a>            <span class="c1"># Initialize variables for tracking the smallest difference</span>
</span><span id="L-2770"><a href="#L-2770"><span class="linenos">2770</span></a>            <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-2771"><a href="#L-2771"><span class="linenos">2771</span></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-2772"><a href="#L-2772"><span class="linenos">2772</span></a>    
</span><span id="L-2773"><a href="#L-2773"><span class="linenos">2773</span></a>            <span class="c1"># Compare each value in the left with every value in the right</span>
</span><span id="L-2774"><a href="#L-2774"><span class="linenos">2774</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
</span><span id="L-2775"><a href="#L-2775"><span class="linenos">2775</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
</span><span id="L-2776"><a href="#L-2776"><span class="linenos">2776</span></a>                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l_val</span> <span class="o">-</span> <span class="n">r_val</span><span class="p">)</span>
</span><span id="L-2777"><a href="#L-2777"><span class="linenos">2777</span></a>                    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">smallest_diff</span><span class="p">:</span>
</span><span id="L-2778"><a href="#L-2778"><span class="linenos">2778</span></a>                        <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">diff</span>
</span><span id="L-2779"><a href="#L-2779"><span class="linenos">2779</span></a>                        <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_indices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="L-2780"><a href="#L-2780"><span class="linenos">2780</span></a>    
</span><span id="L-2781"><a href="#L-2781"><span class="linenos">2781</span></a>            <span class="k">return</span> <span class="n">best_pair</span>
</span><span id="L-2782"><a href="#L-2782"><span class="linenos">2782</span></a>        
</span><span id="L-2783"><a href="#L-2783"><span class="linenos">2783</span></a>        <span class="c1"># Peak matching method ------------------------------------------------</span>
</span><span id="L-2784"><a href="#L-2784"><span class="linenos">2784</span></a>        <span class="k">if</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2785"><a href="#L-2785"><span class="linenos">2785</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-2786"><a href="#L-2786"><span class="linenos">2786</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-2787"><a href="#L-2787"><span class="linenos">2787</span></a>        
</span><span id="L-2788"><a href="#L-2788"><span class="linenos">2788</span></a>            <span class="n">x_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-2789"><a href="#L-2789"><span class="linenos">2789</span></a>            <span class="n">y_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</span><span id="L-2790"><a href="#L-2790"><span class="linenos">2790</span></a>        
</span><span id="L-2791"><a href="#L-2791"><span class="linenos">2791</span></a>            <span class="c1"># Define threshold for peak detection</span>
</span><span id="L-2792"><a href="#L-2792"><span class="linenos">2792</span></a>            <span class="n">x_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span>
</span><span id="L-2793"><a href="#L-2793"><span class="linenos">2793</span></a>            <span class="n">y_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_line</span><span class="p">)</span>
</span><span id="L-2794"><a href="#L-2794"><span class="linenos">2794</span></a>        
</span><span id="L-2795"><a href="#L-2795"><span class="linenos">2795</span></a>            <span class="c1"># Find peaks with dynamic height thresholds</span>
</span><span id="L-2796"><a href="#L-2796"><span class="linenos">2796</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> 
</span><span id="L-2797"><a href="#L-2797"><span class="linenos">2797</span></a>                                        <span class="n">height</span><span class="o">=</span><span class="n">x_thr</span><span class="p">,</span> 
</span><span id="L-2798"><a href="#L-2798"><span class="linenos">2798</span></a>                                        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-2799"><a href="#L-2799"><span class="linenos">2799</span></a>                                        <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-2800"><a href="#L-2800"><span class="linenos">2800</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span> <span class="o">=</span> <span class="n">x_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">]</span>
</span><span id="L-2801"><a href="#L-2801"><span class="linenos">2801</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> 
</span><span id="L-2802"><a href="#L-2802"><span class="linenos">2802</span></a>                                        <span class="n">height</span><span class="o">=</span><span class="n">y_thr</span><span class="p">,</span> 
</span><span id="L-2803"><a href="#L-2803"><span class="linenos">2803</span></a>                                        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-2804"><a href="#L-2804"><span class="linenos">2804</span></a>                                        <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-2805"><a href="#L-2805"><span class="linenos">2805</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="n">y_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">]</span>
</span><span id="L-2806"><a href="#L-2806"><span class="linenos">2806</span></a>        
</span><span id="L-2807"><a href="#L-2807"><span class="linenos">2807</span></a>            <span class="c1"># Define half the length of the image</span>
</span><span id="L-2808"><a href="#L-2808"><span class="linenos">2808</span></a>            <span class="n">half_length_x</span> <span class="o">=</span> <span class="n">x_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-2809"><a href="#L-2809"><span class="linenos">2809</span></a>            <span class="n">half_length_y</span> <span class="o">=</span> <span class="n">y_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-2810"><a href="#L-2810"><span class="linenos">2810</span></a>        
</span><span id="L-2811"><a href="#L-2811"><span class="linenos">2811</span></a>            <span class="c1"># Check the additional condition for xpeaks</span>
</span><span id="L-2812"><a href="#L-2812"><span class="linenos">2812</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-2813"><a href="#L-2813"><span class="linenos">2813</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-2814"><a href="#L-2814"><span class="linenos">2814</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span><span class="p">)):</span>
</span><span id="L-2815"><a href="#L-2815"><span class="linenos">2815</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2816"><a href="#L-2816"><span class="linenos">2816</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xpeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="L-2817"><a href="#L-2817"><span class="linenos">2817</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2818"><a href="#L-2818"><span class="linenos">2818</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2819"><a href="#L-2819"><span class="linenos">2819</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">)</span>
</span><span id="L-2820"><a href="#L-2820"><span class="linenos">2820</span></a>        
</span><span id="L-2821"><a href="#L-2821"><span class="linenos">2821</span></a>            <span class="c1"># Check the additional condition for ypeaks</span>
</span><span id="L-2822"><a href="#L-2822"><span class="linenos">2822</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-2823"><a href="#L-2823"><span class="linenos">2823</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-2824"><a href="#L-2824"><span class="linenos">2824</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span><span class="p">)):</span>
</span><span id="L-2825"><a href="#L-2825"><span class="linenos">2825</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2826"><a href="#L-2826"><span class="linenos">2826</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ypeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="L-2827"><a href="#L-2827"><span class="linenos">2827</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2828"><a href="#L-2828"><span class="linenos">2828</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2829"><a href="#L-2829"><span class="linenos">2829</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">)</span>
</span><span id="L-2830"><a href="#L-2830"><span class="linenos">2830</span></a>        
</span><span id="L-2831"><a href="#L-2831"><span class="linenos">2831</span></a>            <span class="c1"># Determine radius based on available pairs</span>
</span><span id="L-2832"><a href="#L-2832"><span class="linenos">2832</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">:</span>
</span><span id="L-2833"><a href="#L-2833"><span class="linenos">2833</span></a>                <span class="n">rx_x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2834"><a href="#L-2834"><span class="linenos">2834</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2835"><a href="#L-2835"><span class="linenos">2835</span></a>                <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2836"><a href="#L-2836"><span class="linenos">2836</span></a>                <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-2837"><a href="#L-2837"><span class="linenos">2837</span></a>                <span class="n">rx_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-2838"><a href="#L-2838"><span class="linenos">2838</span></a>        
</span><span id="L-2839"><a href="#L-2839"><span class="linenos">2839</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">:</span>
</span><span id="L-2840"><a href="#L-2840"><span class="linenos">2840</span></a>                <span class="n">rx_y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2841"><a href="#L-2841"><span class="linenos">2841</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2842"><a href="#L-2842"><span class="linenos">2842</span></a>                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2843"><a href="#L-2843"><span class="linenos">2843</span></a>                <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-2844"><a href="#L-2844"><span class="linenos">2844</span></a>                <span class="n">rx_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-2845"><a href="#L-2845"><span class="linenos">2845</span></a>        
</span><span id="L-2846"><a href="#L-2846"><span class="linenos">2846</span></a>            <span class="k">if</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2847"><a href="#L-2847"><span class="linenos">2847</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">rx_x</span><span class="p">,</span> <span class="n">rx_y</span><span class="p">])</span>
</span><span id="L-2848"><a href="#L-2848"><span class="linenos">2848</span></a>            <span class="k">elif</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2849"><a href="#L-2849"><span class="linenos">2849</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_x</span>
</span><span id="L-2850"><a href="#L-2850"><span class="linenos">2850</span></a>            <span class="k">elif</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2851"><a href="#L-2851"><span class="linenos">2851</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_y</span>
</span><span id="L-2852"><a href="#L-2852"><span class="linenos">2852</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2853"><a href="#L-2853"><span class="linenos">2853</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2854"><a href="#L-2854"><span class="linenos">2854</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pairs detected for radius calculation.&quot;</span><span class="p">)</span>
</span><span id="L-2855"><a href="#L-2855"><span class="linenos">2855</span></a>                <span class="k">return</span> <span class="mi">100</span>  <span class="c1"># Default radius or error handling</span>
</span><span id="L-2856"><a href="#L-2856"><span class="linenos">2856</span></a>        
</span><span id="L-2857"><a href="#L-2857"><span class="linenos">2857</span></a>            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="L-2858"><a href="#L-2858"><span class="linenos">2858</span></a>                <span class="c1"># Plot xline with peaks</span>
</span><span id="L-2859"><a href="#L-2859"><span class="linenos">2859</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="L-2860"><a href="#L-2860"><span class="linenos">2860</span></a>        
</span><span id="L-2861"><a href="#L-2861"><span class="linenos">2861</span></a>                <span class="c1"># Plot for xline</span>
</span><span id="L-2862"><a href="#L-2862"><span class="linenos">2862</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2863"><a href="#L-2863"><span class="linenos">2863</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;xline&#39;</span><span class="p">)</span>
</span><span id="L-2864"><a href="#L-2864"><span class="linenos">2864</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>
</span><span id="L-2865"><a href="#L-2865"><span class="linenos">2865</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in xline&#39;</span><span class="p">)</span>
</span><span id="L-2866"><a href="#L-2866"><span class="linenos">2866</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="L-2867"><a href="#L-2867"><span class="linenos">2867</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="L-2868"><a href="#L-2868"><span class="linenos">2868</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-2869"><a href="#L-2869"><span class="linenos">2869</span></a>        
</span><span id="L-2870"><a href="#L-2870"><span class="linenos">2870</span></a>                <span class="c1"># Plot for yline</span>
</span><span id="L-2871"><a href="#L-2871"><span class="linenos">2871</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-2872"><a href="#L-2872"><span class="linenos">2872</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;yline&#39;</span><span class="p">)</span>
</span><span id="L-2873"><a href="#L-2873"><span class="linenos">2873</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>  
</span><span id="L-2874"><a href="#L-2874"><span class="linenos">2874</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in yline&#39;</span><span class="p">)</span>
</span><span id="L-2875"><a href="#L-2875"><span class="linenos">2875</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="L-2876"><a href="#L-2876"><span class="linenos">2876</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="L-2877"><a href="#L-2877"><span class="linenos">2877</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-2878"><a href="#L-2878"><span class="linenos">2878</span></a>        
</span><span id="L-2879"><a href="#L-2879"><span class="linenos">2879</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-2880"><a href="#L-2880"><span class="linenos">2880</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-2881"><a href="#L-2881"><span class="linenos">2881</span></a>        
</span><span id="L-2882"><a href="#L-2882"><span class="linenos">2882</span></a>        <span class="c1"># Radial distribution method ------------------------------------------</span>
</span><span id="L-2883"><a href="#L-2883"><span class="linenos">2883</span></a>        <span class="k">elif</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2884"><a href="#L-2884"><span class="linenos">2884</span></a>            <span class="n">profile</span> <span class="o">=</span> <span class="n">ediff</span><span class="o">.</span><span class="n">radial</span><span class="o">.</span><span class="n">calc_radial_distribution</span><span class="p">(</span>
</span><span id="L-2885"><a href="#L-2885"><span class="linenos">2885</span></a>                <span class="n">im</span><span class="p">,</span> 
</span><span id="L-2886"><a href="#L-2886"><span class="linenos">2886</span></a>                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-2887"><a href="#L-2887"><span class="linenos">2887</span></a>                <span class="p">)</span>
</span><span id="L-2888"><a href="#L-2888"><span class="linenos">2888</span></a>            <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">profile</span>
</span><span id="L-2889"><a href="#L-2889"><span class="linenos">2889</span></a>            <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">50</span><span class="p">:])</span> <span class="o">+</span> <span class="mi">50</span>
</span><span id="L-2890"><a href="#L-2890"><span class="linenos">2890</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
</span><span id="L-2891"><a href="#L-2891"><span class="linenos">2891</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
</span><span id="L-2892"><a href="#L-2892"><span class="linenos">2892</span></a>    
</span><span id="L-2893"><a href="#L-2893"><span class="linenos">2893</span></a>            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="L-2894"><a href="#L-2894"><span class="linenos">2894</span></a>                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-2895"><a href="#L-2895"><span class="linenos">2895</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="L-2896"><a href="#L-2896"><span class="linenos">2896</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="L-2897"><a href="#L-2897"><span class="linenos">2897</span></a>                    <span class="n">Circle</span><span class="p">(</span>
</span><span id="L-2898"><a href="#L-2898"><span class="linenos">2898</span></a>                        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">rx</span><span class="p">,</span> 
</span><span id="L-2899"><a href="#L-2899"><span class="linenos">2899</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="L-2900"><a href="#L-2900"><span class="linenos">2900</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-2901"><a href="#L-2901"><span class="linenos">2901</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-2902"><a href="#L-2902"><span class="linenos">2902</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="L-2903"><a href="#L-2903"><span class="linenos">2903</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Initial Estimate&quot;</span><span class="p">)</span>
</span><span id="L-2904"><a href="#L-2904"><span class="linenos">2904</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2905"><a href="#L-2905"><span class="linenos">2905</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
</span><span id="L-2906"><a href="#L-2906"><span class="linenos">2906</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_val</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2907"><a href="#L-2907"><span class="linenos">2907</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> 
</span><span id="L-2908"><a href="#L-2908"><span class="linenos">2908</span></a>                               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="L-2909"><a href="#L-2909"><span class="linenos">2909</span></a>                               <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
</span><span id="L-2910"><a href="#L-2910"><span class="linenos">2910</span></a>                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Radius&#39;</span><span class="p">)</span>
</span><span id="L-2911"><a href="#L-2911"><span class="linenos">2911</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Radial Profile&quot;</span><span class="p">)</span>
</span><span id="L-2912"><a href="#L-2912"><span class="linenos">2912</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-2913"><a href="#L-2913"><span class="linenos">2913</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-2914"><a href="#L-2914"><span class="linenos">2914</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-2915"><a href="#L-2915"><span class="linenos">2915</span></a>        
</span><span id="L-2916"><a href="#L-2916"><span class="linenos">2916</span></a>        <span class="c1"># Return found radius</span>
</span><span id="L-2917"><a href="#L-2917"><span class="linenos">2917</span></a>        <span class="k">return</span> <span class="n">rx</span>
</span><span id="L-2918"><a href="#L-2918"><span class="linenos">2918</span></a>
</span><span id="L-2919"><a href="#L-2919"><span class="linenos">2919</span></a>
</span><span id="L-2920"><a href="#L-2920"><span class="linenos">2920</span></a>    <span class="k">def</span> <span class="nf">backend_fft</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="L-2921"><a href="#L-2921"><span class="linenos">2921</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2922"><a href="#L-2922"><span class="linenos">2922</span></a><span class="sd">        Decorator to enforce the use of PocketFFTBackend when utilizing the </span>
</span><span id="L-2923"><a href="#L-2923"><span class="linenos">2923</span></a><span class="sd">        `scipy.fft` module. This ensures that all FFT computations leverage </span>
</span><span id="L-2924"><a href="#L-2924"><span class="linenos">2924</span></a><span class="sd">        the optimized PocketFFT implementation, improving performance, </span>
</span><span id="L-2925"><a href="#L-2925"><span class="linenos">2925</span></a><span class="sd">        particularly for multi-threaded execution.</span>
</span><span id="L-2926"><a href="#L-2926"><span class="linenos">2926</span></a><span class="sd">    </span>
</span><span id="L-2927"><a href="#L-2927"><span class="linenos">2927</span></a><span class="sd">        Parameters</span>
</span><span id="L-2928"><a href="#L-2928"><span class="linenos">2928</span></a><span class="sd">        ----------</span>
</span><span id="L-2929"><a href="#L-2929"><span class="linenos">2929</span></a><span class="sd">        f : callable</span>
</span><span id="L-2930"><a href="#L-2930"><span class="linenos">2930</span></a><span class="sd">            The function to be wrapped, ensuring it executes within the </span>
</span><span id="L-2931"><a href="#L-2931"><span class="linenos">2931</span></a><span class="sd">            PocketFFTBackend context.</span>
</span><span id="L-2932"><a href="#L-2932"><span class="linenos">2932</span></a><span class="sd">    </span>
</span><span id="L-2933"><a href="#L-2933"><span class="linenos">2933</span></a><span class="sd">        Returns</span>
</span><span id="L-2934"><a href="#L-2934"><span class="linenos">2934</span></a><span class="sd">        -------</span>
</span><span id="L-2935"><a href="#L-2935"><span class="linenos">2935</span></a><span class="sd">        callable</span>
</span><span id="L-2936"><a href="#L-2936"><span class="linenos">2936</span></a><span class="sd">            A wrapped function that forces the use of PocketFFTBackend.</span>
</span><span id="L-2937"><a href="#L-2937"><span class="linenos">2937</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2938"><a href="#L-2938"><span class="linenos">2938</span></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-2939"><a href="#L-2939"><span class="linenos">2939</span></a>        <span class="k">def</span> <span class="nf">newf</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-2940"><a href="#L-2940"><span class="linenos">2940</span></a>            <span class="k">with</span> <span class="n">set_backend</span><span class="p">(</span><span class="n">PocketFFTBackend</span><span class="p">):</span>
</span><span id="L-2941"><a href="#L-2941"><span class="linenos">2941</span></a>                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-2942"><a href="#L-2942"><span class="linenos">2942</span></a>        <span class="k">return</span> <span class="n">newf</span>
</span><span id="L-2943"><a href="#L-2943"><span class="linenos">2943</span></a>    
</span><span id="L-2944"><a href="#L-2944"><span class="linenos">2944</span></a>    <span class="nd">@backend_fft</span>
</span><span id="L-2945"><a href="#L-2945"><span class="linenos">2945</span></a>    <span class="k">def</span> <span class="nf">calc_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fft_function</span><span class="p">):</span>
</span><span id="L-2946"><a href="#L-2946"><span class="linenos">2946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2947"><a href="#L-2947"><span class="linenos">2947</span></a><span class="sd">        Computes the Fast Fourier Transform (FFT) using the specified function.</span>
</span><span id="L-2948"><a href="#L-2948"><span class="linenos">2948</span></a>
</span><span id="L-2949"><a href="#L-2949"><span class="linenos">2949</span></a><span class="sd">        This method ensures that the FFT operation is executed using </span>
</span><span id="L-2950"><a href="#L-2950"><span class="linenos">2950</span></a><span class="sd">        the PocketFFTBackend, applying optimized settings for improved efficiency.</span>
</span><span id="L-2951"><a href="#L-2951"><span class="linenos">2951</span></a>
</span><span id="L-2952"><a href="#L-2952"><span class="linenos">2952</span></a><span class="sd">        Parameters</span>
</span><span id="L-2953"><a href="#L-2953"><span class="linenos">2953</span></a><span class="sd">        ----------</span>
</span><span id="L-2954"><a href="#L-2954"><span class="linenos">2954</span></a><span class="sd">        fft_function : callable</span>
</span><span id="L-2955"><a href="#L-2955"><span class="linenos">2955</span></a><span class="sd">            The FFT function to be applied to the data.</span>
</span><span id="L-2956"><a href="#L-2956"><span class="linenos">2956</span></a>
</span><span id="L-2957"><a href="#L-2957"><span class="linenos">2957</span></a><span class="sd">        Returns</span>
</span><span id="L-2958"><a href="#L-2958"><span class="linenos">2958</span></a><span class="sd">        -------</span>
</span><span id="L-2959"><a href="#L-2959"><span class="linenos">2959</span></a><span class="sd">        object</span>
</span><span id="L-2960"><a href="#L-2960"><span class="linenos">2960</span></a><span class="sd">            The result of the FFT computation.</span>
</span><span id="L-2961"><a href="#L-2961"><span class="linenos">2961</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2962"><a href="#L-2962"><span class="linenos">2962</span></a>        <span class="k">return</span> <span class="n">fft_function</span>
</span><span id="L-2963"><a href="#L-2963"><span class="linenos">2963</span></a>
</span><span id="L-2964"><a href="#L-2964"><span class="linenos">2964</span></a>   
</span><span id="L-2965"><a href="#L-2965"><span class="linenos">2965</span></a>    <span class="k">def</span> <span class="nf">auto_masking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">show_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2966"><a href="#L-2966"><span class="linenos">2966</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2967"><a href="#L-2967"><span class="linenos">2967</span></a><span class="sd">        Automatically generates a binary mask for an image based on intensity </span>
</span><span id="L-2968"><a href="#L-2968"><span class="linenos">2968</span></a><span class="sd">        thresholding.</span>
</span><span id="L-2969"><a href="#L-2969"><span class="linenos">2969</span></a><span class="sd">        </span>
</span><span id="L-2970"><a href="#L-2970"><span class="linenos">2970</span></a><span class="sd">        This function determines a lower intensity limit by taking a fraction </span>
</span><span id="L-2971"><a href="#L-2971"><span class="linenos">2971</span></a><span class="sd">        (threshold) of the median of the highest intensity values in the image. </span>
</span><span id="L-2972"><a href="#L-2972"><span class="linenos">2972</span></a><span class="sd">        This helps filter out noise while preserving meaningful features, </span>
</span><span id="L-2973"><a href="#L-2973"><span class="linenos">2973</span></a><span class="sd">        avoiding the influence of hot spots.</span>
</span><span id="L-2974"><a href="#L-2974"><span class="linenos">2974</span></a><span class="sd">    </span>
</span><span id="L-2975"><a href="#L-2975"><span class="linenos">2975</span></a><span class="sd">        Parameters</span>
</span><span id="L-2976"><a href="#L-2976"><span class="linenos">2976</span></a><span class="sd">        ----------</span>
</span><span id="L-2977"><a href="#L-2977"><span class="linenos">2977</span></a><span class="sd">        im : ndarray</span>
</span><span id="L-2978"><a href="#L-2978"><span class="linenos">2978</span></a><span class="sd">            Input grayscale image as a 2D NumPy array.</span>
</span><span id="L-2979"><a href="#L-2979"><span class="linenos">2979</span></a><span class="sd">        </span>
</span><span id="L-2980"><a href="#L-2980"><span class="linenos">2980</span></a><span class="sd">        threshold : float, optional</span>
</span><span id="L-2981"><a href="#L-2981"><span class="linenos">2981</span></a><span class="sd">            A fraction (default is 0.1) of the median of the highest intensity </span>
</span><span id="L-2982"><a href="#L-2982"><span class="linenos">2982</span></a><span class="sd">            values. Pixels with intensity above this computed limit will be </span>
</span><span id="L-2983"><a href="#L-2983"><span class="linenos">2983</span></a><span class="sd">            included in the mask.</span>
</span><span id="L-2984"><a href="#L-2984"><span class="linenos">2984</span></a><span class="sd">    </span>
</span><span id="L-2985"><a href="#L-2985"><span class="linenos">2985</span></a><span class="sd">        Returns</span>
</span><span id="L-2986"><a href="#L-2986"><span class="linenos">2986</span></a><span class="sd">        -------</span>
</span><span id="L-2987"><a href="#L-2987"><span class="linenos">2987</span></a><span class="sd">        mask : ndarray</span>
</span><span id="L-2988"><a href="#L-2988"><span class="linenos">2988</span></a><span class="sd">            A boolean mask (same shape as `im`), where `True` indicates pixels </span>
</span><span id="L-2989"><a href="#L-2989"><span class="linenos">2989</span></a><span class="sd">            above the threshold and `False` represents background or noise.</span>
</span><span id="L-2990"><a href="#L-2990"><span class="linenos">2990</span></a><span class="sd">    </span>
</span><span id="L-2991"><a href="#L-2991"><span class="linenos">2991</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2992"><a href="#L-2992"><span class="linenos">2992</span></a>        <span class="c1"># Find the median of the highest intensity value of the image to avoid </span>
</span><span id="L-2993"><a href="#L-2993"><span class="linenos">2993</span></a>        <span class="c1"># hot spots (More stable than median scaling)</span>
</span><span id="L-2994"><a href="#L-2994"><span class="linenos">2994</span></a>        <span class="n">lower_limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> 
</span><span id="L-2995"><a href="#L-2995"><span class="linenos">2995</span></a>        
</span><span id="L-2996"><a href="#L-2996"><span class="linenos">2996</span></a>        <span class="c1"># Generate a mask</span>
</span><span id="L-2997"><a href="#L-2997"><span class="linenos">2997</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">im</span> <span class="o">&gt;</span> <span class="n">lower_limit</span>
</span><span id="L-2998"><a href="#L-2998"><span class="linenos">2998</span></a>        
</span><span id="L-2999"><a href="#L-2999"><span class="linenos">2999</span></a>        <span class="k">if</span> <span class="n">show_mask</span><span class="p">:</span>
</span><span id="L-3000"><a href="#L-3000"><span class="linenos">3000</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="L-3001"><a href="#L-3001"><span class="linenos">3001</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="L-3002"><a href="#L-3002"><span class="linenos">3002</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Beam Stopper Masking&quot;</span><span class="p">)</span>
</span><span id="L-3003"><a href="#L-3003"><span class="linenos">3003</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-3004"><a href="#L-3004"><span class="linenos">3004</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-3005"><a href="#L-3005"><span class="linenos">3005</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-3006"><a href="#L-3006"><span class="linenos">3006</span></a>        
</span><span id="L-3007"><a href="#L-3007"><span class="linenos">3007</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="L-3008"><a href="#L-3008"><span class="linenos">3008</span></a>
</span><span id="L-3009"><a href="#L-3009"><span class="linenos">3009</span></a>        
</span><span id="L-3010"><a href="#L-3010"><span class="linenos">3010</span></a>    <span class="k">def</span> <span class="nf">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3011"><a href="#L-3011"><span class="linenos">3011</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="L-3012"><a href="#L-3012"><span class="linenos">3012</span></a><span class="sd">        Visualize detected diffraction patterns and mark the center.</span>
</span><span id="L-3013"><a href="#L-3013"><span class="linenos">3013</span></a><span class="sd">        </span>
</span><span id="L-3014"><a href="#L-3014"><span class="linenos">3014</span></a><span class="sd">        Parameters</span>
</span><span id="L-3015"><a href="#L-3015"><span class="linenos">3015</span></a><span class="sd">        ----------</span>
</span><span id="L-3016"><a href="#L-3016"><span class="linenos">3016</span></a><span class="sd">        tit : string</span>
</span><span id="L-3017"><a href="#L-3017"><span class="linenos">3017</span></a><span class="sd">            name of the method used for circle detection</span>
</span><span id="L-3018"><a href="#L-3018"><span class="linenos">3018</span></a><span class="sd">            </span>
</span><span id="L-3019"><a href="#L-3019"><span class="linenos">3019</span></a><span class="sd">        x : float64</span>
</span><span id="L-3020"><a href="#L-3020"><span class="linenos">3020</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="L-3021"><a href="#L-3021"><span class="linenos">3021</span></a><span class="sd">            </span>
</span><span id="L-3022"><a href="#L-3022"><span class="linenos">3022</span></a><span class="sd">        y : float64</span>
</span><span id="L-3023"><a href="#L-3023"><span class="linenos">3023</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="L-3024"><a href="#L-3024"><span class="linenos">3024</span></a><span class="sd">            </span>
</span><span id="L-3025"><a href="#L-3025"><span class="linenos">3025</span></a><span class="sd">        r : float64</span>
</span><span id="L-3026"><a href="#L-3026"><span class="linenos">3026</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-3027"><a href="#L-3027"><span class="linenos">3027</span></a><span class="sd">        </span>
</span><span id="L-3028"><a href="#L-3028"><span class="linenos">3028</span></a><span class="sd">        Returns</span>
</span><span id="L-3029"><a href="#L-3029"><span class="linenos">3029</span></a><span class="sd">        -------</span>
</span><span id="L-3030"><a href="#L-3030"><span class="linenos">3030</span></a><span class="sd">        None.</span>
</span><span id="L-3031"><a href="#L-3031"><span class="linenos">3031</span></a><span class="sd">                            </span>
</span><span id="L-3032"><a href="#L-3032"><span class="linenos">3032</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-3033"><a href="#L-3033"><span class="linenos">3033</span></a>        <span class="c1"># Load image</span>
</span><span id="L-3034"><a href="#L-3034"><span class="linenos">3034</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-3035"><a href="#L-3035"><span class="linenos">3035</span></a>    
</span><span id="L-3036"><a href="#L-3036"><span class="linenos">3036</span></a>        <span class="k">if</span> <span class="n">rd</span><span class="o">==</span><span class="s2">&quot;d&quot;</span><span class="p">:</span>
</span><span id="L-3037"><a href="#L-3037"><span class="linenos">3037</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Detected center position&quot;</span>
</span><span id="L-3038"><a href="#L-3038"><span class="linenos">3038</span></a>        <span class="k">elif</span> <span class="n">rd</span><span class="o">==</span><span class="s2">&quot;r&quot;</span><span class="p">:</span>
</span><span id="L-3039"><a href="#L-3039"><span class="linenos">3039</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Refined center position&quot;</span>
</span><span id="L-3040"><a href="#L-3040"><span class="linenos">3040</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-3041"><a href="#L-3041"><span class="linenos">3041</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Center position&quot;</span>
</span><span id="L-3042"><a href="#L-3042"><span class="linenos">3042</span></a>            
</span><span id="L-3043"><a href="#L-3043"><span class="linenos">3043</span></a>            
</span><span id="L-3044"><a href="#L-3044"><span class="linenos">3044</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3045"><a href="#L-3045"><span class="linenos">3045</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="L-3046"><a href="#L-3046"><span class="linenos">3046</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3047"><a href="#L-3047"><span class="linenos">3047</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-3048"><a href="#L-3048"><span class="linenos">3048</span></a>            
</span><span id="L-3049"><a href="#L-3049"><span class="linenos">3049</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="L-3050"><a href="#L-3050"><span class="linenos">3050</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-3051"><a href="#L-3051"><span class="linenos">3051</span></a>        
</span><span id="L-3052"><a href="#L-3052"><span class="linenos">3052</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="L-3053"><a href="#L-3053"><span class="linenos">3053</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-3054"><a href="#L-3054"><span class="linenos">3054</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-3055"><a href="#L-3055"><span class="linenos">3055</span></a> 
</span><span id="L-3056"><a href="#L-3056"><span class="linenos">3056</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tit</span><span class="p">)</span>
</span><span id="L-3057"><a href="#L-3057"><span class="linenos">3057</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-3058"><a href="#L-3058"><span class="linenos">3058</span></a>
</span><span id="L-3059"><a href="#L-3059"><span class="linenos">3059</span></a>        <span class="c1"># Plot center point</span>
</span><span id="L-3060"><a href="#L-3060"><span class="linenos">3060</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
</span><span id="L-3061"><a href="#L-3061"><span class="linenos">3061</span></a>                <span class="n">label</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;center:  [</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span>
</span><span id="L-3062"><a href="#L-3062"><span class="linenos">3062</span></a>                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-3063"><a href="#L-3063"><span class="linenos">3063</span></a>
</span><span id="L-3064"><a href="#L-3064"><span class="linenos">3064</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="L-3065"><a href="#L-3065"><span class="linenos">3065</span></a>        
</span><span id="L-3066"><a href="#L-3066"><span class="linenos">3066</span></a>        <span class="c1"># Display the image</span>
</span><span id="L-3067"><a href="#L-3067"><span class="linenos">3067</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-3068"><a href="#L-3068"><span class="linenos">3068</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-3069"><a href="#L-3069"><span class="linenos">3069</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-3070"><a href="#L-3070"><span class="linenos">3070</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3071"><a href="#L-3071"><span class="linenos">3071</span></a>
</span><span id="L-3072"><a href="#L-3072"><span class="linenos">3072</span></a>
</span><span id="L-3073"><a href="#L-3073"><span class="linenos">3073</span></a>
</span><span id="L-3074"><a href="#L-3074"><span class="linenos">3074</span></a><span class="k">class</span> <span class="nc">CenterRefinement</span><span class="p">:</span>
</span><span id="L-3075"><a href="#L-3075"><span class="linenos">3075</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-3076"><a href="#L-3076"><span class="linenos">3076</span></a><span class="sd">    CenterRefinement - Final refinement of the center of a diffraction pattern.</span>
</span><span id="L-3077"><a href="#L-3077"><span class="linenos">3077</span></a>
</span><span id="L-3078"><a href="#L-3078"><span class="linenos">3078</span></a><span class="sd">    This class performs refinement of the detected center coordinates in a 2D</span>
</span><span id="L-3079"><a href="#L-3079"><span class="linenos">3079</span></a><span class="sd">    diffraction pattern. It supports multiple refinement methods, both manual</span>
</span><span id="L-3080"><a href="#L-3080"><span class="linenos">3080</span></a><span class="sd">    and automatic, and optionally saves the refined center to a file.</span>
</span><span id="L-3081"><a href="#L-3081"><span class="linenos">3081</span></a>
</span><span id="L-3082"><a href="#L-3082"><span class="linenos">3082</span></a>
</span><span id="L-3083"><a href="#L-3083"><span class="linenos">3083</span></a><span class="sd">    Parameters</span>
</span><span id="L-3084"><a href="#L-3084"><span class="linenos">3084</span></a><span class="sd">    ----------</span>
</span><span id="L-3085"><a href="#L-3085"><span class="linenos">3085</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="L-3086"><a href="#L-3086"><span class="linenos">3086</span></a><span class="sd">        Reference to the parent CenterLocator object. Used to access shared</span>
</span><span id="L-3087"><a href="#L-3087"><span class="linenos">3087</span></a><span class="sd">        attributes like initial center estimates and configuration flags.</span>
</span><span id="L-3088"><a href="#L-3088"><span class="linenos">3088</span></a><span class="sd">        </span>
</span><span id="L-3089"><a href="#L-3089"><span class="linenos">3089</span></a><span class="sd">    input_image : str, Path, or numpy.ndarray</span>
</span><span id="L-3090"><a href="#L-3090"><span class="linenos">3090</span></a><span class="sd">        The diffraction pattern image, either as a file path or a 2D NumPy array.</span>
</span><span id="L-3091"><a href="#L-3091"><span class="linenos">3091</span></a><span class="sd">    </span>
</span><span id="L-3092"><a href="#L-3092"><span class="linenos">3092</span></a><span class="sd">        </span>
</span><span id="L-3093"><a href="#L-3093"><span class="linenos">3093</span></a><span class="sd">    refinement : str or None, optional, default=None</span>
</span><span id="L-3094"><a href="#L-3094"><span class="linenos">3094</span></a><span class="sd">        The refinement method to apply. Options include:</span>
</span><span id="L-3095"><a href="#L-3095"><span class="linenos">3095</span></a><span class="sd">        - &#39;manual&#39;: Manual adjustment via user interaction on the selected ring.</span>
</span><span id="L-3096"><a href="#L-3096"><span class="linenos">3096</span></a><span class="sd">        - &#39;sum&#39;   : Automatic refinement by maximizing the intensity sum </span>
</span><span id="L-3097"><a href="#L-3097"><span class="linenos">3097</span></a><span class="sd">        - &#39;var&#39;   : Automatic refinement by minimizing the intensity variance</span>
</span><span id="L-3098"><a href="#L-3098"><span class="linenos">3098</span></a><span class="sd">        If None, no refinement is applied.</span>
</span><span id="L-3099"><a href="#L-3099"><span class="linenos">3099</span></a><span class="sd">          </span>
</span><span id="L-3100"><a href="#L-3100"><span class="linenos">3100</span></a><span class="sd">    out_file : str, optional</span>
</span><span id="L-3101"><a href="#L-3101"><span class="linenos">3101</span></a><span class="sd">        Path to a text file where the refined center coordinates will be saved.</span>
</span><span id="L-3102"><a href="#L-3102"><span class="linenos">3102</span></a><span class="sd">    </span>
</span><span id="L-3103"><a href="#L-3103"><span class="linenos">3103</span></a><span class="sd">    heq : bool, optional, default=False</span>
</span><span id="L-3104"><a href="#L-3104"><span class="linenos">3104</span></a><span class="sd">        Whether to apply histogram equalization to the input image before</span>
</span><span id="L-3105"><a href="#L-3105"><span class="linenos">3105</span></a><span class="sd">        processing.</span>
</span><span id="L-3106"><a href="#L-3106"><span class="linenos">3106</span></a><span class="sd">    </span>
</span><span id="L-3107"><a href="#L-3107"><span class="linenos">3107</span></a><span class="sd">    icut : float, optional, default=None</span>
</span><span id="L-3108"><a href="#L-3108"><span class="linenos">3108</span></a><span class="sd">        Cut-off intensity level for processing the image</span>
</span><span id="L-3109"><a href="#L-3109"><span class="linenos">3109</span></a><span class="sd">        </span>
</span><span id="L-3110"><a href="#L-3110"><span class="linenos">3110</span></a><span class="sd">    cmap : str, optional, default=&#39;gray&#39;</span>
</span><span id="L-3111"><a href="#L-3111"><span class="linenos">3111</span></a><span class="sd">        Colormap to be used when displaying the image for manual refinement.</span>
</span><span id="L-3112"><a href="#L-3112"><span class="linenos">3112</span></a><span class="sd">    </span>
</span><span id="L-3113"><a href="#L-3113"><span class="linenos">3113</span></a><span class="sd">    verbose : bool, optional, default=False</span>
</span><span id="L-3114"><a href="#L-3114"><span class="linenos">3114</span></a><span class="sd">        Flag to enable or disable informational verbose during processing. </span>
</span><span id="L-3115"><a href="#L-3115"><span class="linenos">3115</span></a>
</span><span id="L-3116"><a href="#L-3116"><span class="linenos">3116</span></a><span class="sd">    print_sums : bool, optional, default=False</span>
</span><span id="L-3117"><a href="#L-3117"><span class="linenos">3117</span></a><span class="sd">        If True, prints the sum of intensity values for the refined circle </span>
</span><span id="L-3118"><a href="#L-3118"><span class="linenos">3118</span></a><span class="sd">        after each adjustment, relevant only for manual refinement methods.</span>
</span><span id="L-3119"><a href="#L-3119"><span class="linenos">3119</span></a>
</span><span id="L-3120"><a href="#L-3120"><span class="linenos">3120</span></a><span class="sd">    Returns</span>
</span><span id="L-3121"><a href="#L-3121"><span class="linenos">3121</span></a><span class="sd">    -------</span>
</span><span id="L-3122"><a href="#L-3122"><span class="linenos">3122</span></a><span class="sd">    None</span>
</span><span id="L-3123"><a href="#L-3123"><span class="linenos">3123</span></a>
</span><span id="L-3124"><a href="#L-3124"><span class="linenos">3124</span></a><span class="sd">    Notes</span>
</span><span id="L-3125"><a href="#L-3125"><span class="linenos">3125</span></a><span class="sd">    -----</span>
</span><span id="L-3126"><a href="#L-3126"><span class="linenos">3126</span></a><span class="sd">    - If an unsupported refinement method is provided, the program exits with</span>
</span><span id="L-3127"><a href="#L-3127"><span class="linenos">3127</span></a><span class="sd">      an error.</span>
</span><span id="L-3128"><a href="#L-3128"><span class="linenos">3128</span></a><span class="sd">    - The coordinates `xx`, `yy`, and radius `rr` can be accessed after</span>
</span><span id="L-3129"><a href="#L-3129"><span class="linenos">3129</span></a><span class="sd">      initialization for further analysis or saving.</span>
</span><span id="L-3130"><a href="#L-3130"><span class="linenos">3130</span></a><span class="sd">    - The refinement strategy relies on initial estimates provided by the parent </span>
</span><span id="L-3131"><a href="#L-3131"><span class="linenos">3131</span></a><span class="sd">      object.</span>
</span><span id="L-3132"><a href="#L-3132"><span class="linenos">3132</span></a><span class="sd">    - Manual refinement supports click-based center adjustments guided by visual </span>
</span><span id="L-3133"><a href="#L-3133"><span class="linenos">3133</span></a><span class="sd">      feedback.</span>
</span><span id="L-3134"><a href="#L-3134"><span class="linenos">3134</span></a><span class="sd">    - Sum/variance refinement automatically searches for the most likely center</span>
</span><span id="L-3135"><a href="#L-3135"><span class="linenos">3135</span></a><span class="sd">      by evaluating ring statistics.</span>
</span><span id="L-3136"><a href="#L-3136"><span class="linenos">3136</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-3137"><a href="#L-3137"><span class="linenos">3137</span></a>    
</span><span id="L-3138"><a href="#L-3138"><span class="linenos">3138</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="L-3139"><a href="#L-3139"><span class="linenos">3139</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="L-3140"><a href="#L-3140"><span class="linenos">3140</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-3141"><a href="#L-3141"><span class="linenos">3141</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-3142"><a href="#L-3142"><span class="linenos">3142</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-3143"><a href="#L-3143"><span class="linenos">3143</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-3144"><a href="#L-3144"><span class="linenos">3144</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-3145"><a href="#L-3145"><span class="linenos">3145</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="L-3146"><a href="#L-3146"><span class="linenos">3146</span></a>                 <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-3147"><a href="#L-3147"><span class="linenos">3147</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-3148"><a href="#L-3148"><span class="linenos">3148</span></a>        
</span><span id="L-3149"><a href="#L-3149"><span class="linenos">3149</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-3150"><a href="#L-3150"><span class="linenos">3150</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="L-3151"><a href="#L-3151"><span class="linenos">3151</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="L-3152"><a href="#L-3152"><span class="linenos">3152</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-3153"><a href="#L-3153"><span class="linenos">3153</span></a>        
</span><span id="L-3154"><a href="#L-3154"><span class="linenos">3154</span></a>        <span class="c1">## (0) Initialize input attributes ------------------------------------</span>
</span><span id="L-3155"><a href="#L-3155"><span class="linenos">3155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="L-3156"><a href="#L-3156"><span class="linenos">3156</span></a>        
</span><span id="L-3157"><a href="#L-3157"><span class="linenos">3157</span></a>        <span class="c1">## (1) Initialize new attributes --------------------------------------</span>
</span><span id="L-3158"><a href="#L-3158"><span class="linenos">3158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="L-3159"><a href="#L-3159"><span class="linenos">3159</span></a>        
</span><span id="L-3160"><a href="#L-3160"><span class="linenos">3160</span></a>        <span class="c1">## (2) Run functions --------------------------------------------------</span>
</span><span id="L-3161"><a href="#L-3161"><span class="linenos">3161</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3162"><a href="#L-3162"><span class="linenos">3162</span></a>            <span class="c1"># Flag for later</span>
</span><span id="L-3163"><a href="#L-3163"><span class="linenos">3163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-3164"><a href="#L-3164"><span class="linenos">3164</span></a>            <span class="n">par_short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">center1</span>
</span><span id="L-3165"><a href="#L-3165"><span class="linenos">3165</span></a>        
</span><span id="L-3166"><a href="#L-3166"><span class="linenos">3166</span></a>            <span class="k">if</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="L-3167"><a href="#L-3167"><span class="linenos">3167</span></a>                <span class="c1"># Manual refinement method</span>
</span><span id="L-3168"><a href="#L-3168"><span class="linenos">3168</span></a>                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
</span><span id="L-3169"><a href="#L-3169"><span class="linenos">3169</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> \
</span><span id="L-3170"><a href="#L-3170"><span class="linenos">3170</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-3171"><a href="#L-3171"><span class="linenos">3171</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> \
</span><span id="L-3172"><a href="#L-3172"><span class="linenos">3172</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-3173"><a href="#L-3173"><span class="linenos">3173</span></a>                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-3174"><a href="#L-3174"><span class="linenos">3174</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="L-3175"><a href="#L-3175"><span class="linenos">3175</span></a>                            <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-3176"><a href="#L-3176"><span class="linenos">3176</span></a>                <span class="k">elif</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
</span><span id="L-3177"><a href="#L-3177"><span class="linenos">3177</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="L-3178"><a href="#L-3178"><span class="linenos">3178</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-3179"><a href="#L-3179"><span class="linenos">3179</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-3180"><a href="#L-3180"><span class="linenos">3180</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="L-3181"><a href="#L-3181"><span class="linenos">3181</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-3182"><a href="#L-3182"><span class="linenos">3182</span></a>        
</span><span id="L-3183"><a href="#L-3183"><span class="linenos">3183</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="L-3184"><a href="#L-3184"><span class="linenos">3184</span></a>                <span class="c1"># Intensity variance refinement</span>
</span><span id="L-3185"><a href="#L-3185"><span class="linenos">3185</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_var</span><span class="p">(</span>
</span><span id="L-3186"><a href="#L-3186"><span class="linenos">3186</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-3187"><a href="#L-3187"><span class="linenos">3187</span></a>        
</span><span id="L-3188"><a href="#L-3188"><span class="linenos">3188</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
</span><span id="L-3189"><a href="#L-3189"><span class="linenos">3189</span></a>                <span class="c1"># Intensity sum refinement</span>
</span><span id="L-3190"><a href="#L-3190"><span class="linenos">3190</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_sum</span><span class="p">(</span>
</span><span id="L-3191"><a href="#L-3191"><span class="linenos">3191</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="L-3192"><a href="#L-3192"><span class="linenos">3192</span></a>                    <span class="n">live_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">live_plot</span><span class="p">)</span>
</span><span id="L-3193"><a href="#L-3193"><span class="linenos">3193</span></a>            
</span><span id="L-3194"><a href="#L-3194"><span class="linenos">3194</span></a>
</span><span id="L-3195"><a href="#L-3195"><span class="linenos">3195</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-3196"><a href="#L-3196"><span class="linenos">3196</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected refinement method is not supported.&quot;</span><span class="p">)</span>
</span><span id="L-3197"><a href="#L-3197"><span class="linenos">3197</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="L-3198"><a href="#L-3198"><span class="linenos">3198</span></a>       
</span><span id="L-3199"><a href="#L-3199"><span class="linenos">3199</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>          
</span><span id="L-3200"><a href="#L-3200"><span class="linenos">3200</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-3201"><a href="#L-3201"><span class="linenos">3201</span></a>            <span class="c1"># Flag for later</span>
</span><span id="L-3202"><a href="#L-3202"><span class="linenos">3202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-3203"><a href="#L-3203"><span class="linenos">3203</span></a>            
</span><span id="L-3204"><a href="#L-3204"><span class="linenos">3204</span></a>           
</span><span id="L-3205"><a href="#L-3205"><span class="linenos">3205</span></a>    <span class="k">def</span> <span class="nf">ref_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="L-3206"><a href="#L-3206"><span class="linenos">3206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3207"><a href="#L-3207"><span class="linenos">3207</span></a><span class="sd">        Manual/interactive refinement of the diffraction pattern center.</span>
</span><span id="L-3208"><a href="#L-3208"><span class="linenos">3208</span></a><span class="sd">      </span>
</span><span id="L-3209"><a href="#L-3209"><span class="linenos">3209</span></a><span class="sd">        This method allows the user to fine-tune the estimated center</span>
</span><span id="L-3210"><a href="#L-3210"><span class="linenos">3210</span></a><span class="sd">        and radius of a diffraction ring through interactive keyboard controls.</span>
</span><span id="L-3211"><a href="#L-3211"><span class="linenos">3211</span></a><span class="sd">      </span>
</span><span id="L-3212"><a href="#L-3212"><span class="linenos">3212</span></a><span class="sd">        An new window is opened and the user can adjust the position</span>
</span><span id="L-3213"><a href="#L-3213"><span class="linenos">3213</span></a><span class="sd">        of the diffraction ring using the following keys (keyboard controls):</span>
</span><span id="L-3214"><a href="#L-3214"><span class="linenos">3214</span></a><span class="sd">        - Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</span>
</span><span id="L-3215"><a href="#L-3215"><span class="linenos">3215</span></a><span class="sd">        - &#39;+&#39; : Increase the radius</span>
</span><span id="L-3216"><a href="#L-3216"><span class="linenos">3216</span></a><span class="sd">        - &#39;-&#39; : Decrease the radius</span>
</span><span id="L-3217"><a href="#L-3217"><span class="linenos">3217</span></a><span class="sd">        - &#39;b&#39; : Increase step size (×5)</span>
</span><span id="L-3218"><a href="#L-3218"><span class="linenos">3218</span></a><span class="sd">        - &#39;l&#39; : Decrease step size (/5, with minimum step size 0.5)</span>
</span><span id="L-3219"><a href="#L-3219"><span class="linenos">3219</span></a><span class="sd">        - &#39;d&#39; : Done — finalize the center and radius</span>
</span><span id="L-3220"><a href="#L-3220"><span class="linenos">3220</span></a><span class="sd">        - Closing the figure: Cancels refinement and returns the original input </span>
</span><span id="L-3221"><a href="#L-3221"><span class="linenos">3221</span></a><span class="sd">          center and radius</span>
</span><span id="L-3222"><a href="#L-3222"><span class="linenos">3222</span></a><span class="sd">      </span>
</span><span id="L-3223"><a href="#L-3223"><span class="linenos">3223</span></a><span class="sd">        Parameters</span>
</span><span id="L-3224"><a href="#L-3224"><span class="linenos">3224</span></a><span class="sd">        ----------</span>
</span><span id="L-3225"><a href="#L-3225"><span class="linenos">3225</span></a><span class="sd">        fig : matplotlib.figure.Figure</span>
</span><span id="L-3226"><a href="#L-3226"><span class="linenos">3226</span></a><span class="sd">            The figure window used for interactive refinement.</span>
</span><span id="L-3227"><a href="#L-3227"><span class="linenos">3227</span></a><span class="sd">            </span>
</span><span id="L-3228"><a href="#L-3228"><span class="linenos">3228</span></a><span class="sd">        circle : matplotlib.patches.Circle</span>
</span><span id="L-3229"><a href="#L-3229"><span class="linenos">3229</span></a><span class="sd">            The circle object known from</span>
</span><span id="L-3230"><a href="#L-3230"><span class="linenos">3230</span></a><span class="sd">            the previous step = from the center determination.</span>
</span><span id="L-3231"><a href="#L-3231"><span class="linenos">3231</span></a><span class="sd">            </span>
</span><span id="L-3232"><a href="#L-3232"><span class="linenos">3232</span></a><span class="sd">        center : tuple</span>
</span><span id="L-3233"><a href="#L-3233"><span class="linenos">3233</span></a><span class="sd">            The initial (x, y) center coordinates from</span>
</span><span id="L-3234"><a href="#L-3234"><span class="linenos">3234</span></a><span class="sd">            the previous step = from the center determination.</span>
</span><span id="L-3235"><a href="#L-3235"><span class="linenos">3235</span></a><span class="sd">            </span>
</span><span id="L-3236"><a href="#L-3236"><span class="linenos">3236</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="L-3237"><a href="#L-3237"><span class="linenos">3237</span></a><span class="sd">            If True, the results of the adjustment are visualized.</span>
</span><span id="L-3238"><a href="#L-3238"><span class="linenos">3238</span></a><span class="sd">      </span>
</span><span id="L-3239"><a href="#L-3239"><span class="linenos">3239</span></a><span class="sd">        Returns</span>
</span><span id="L-3240"><a href="#L-3240"><span class="linenos">3240</span></a><span class="sd">        -------</span>
</span><span id="L-3241"><a href="#L-3241"><span class="linenos">3241</span></a><span class="sd">        xy[0] : float</span>
</span><span id="L-3242"><a href="#L-3242"><span class="linenos">3242</span></a><span class="sd">            x-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="L-3243"><a href="#L-3243"><span class="linenos">3243</span></a><span class="sd">            </span>
</span><span id="L-3244"><a href="#L-3244"><span class="linenos">3244</span></a><span class="sd">        xy[1] : float</span>
</span><span id="L-3245"><a href="#L-3245"><span class="linenos">3245</span></a><span class="sd">            y-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="L-3246"><a href="#L-3246"><span class="linenos">3246</span></a><span class="sd">            </span>
</span><span id="L-3247"><a href="#L-3247"><span class="linenos">3247</span></a><span class="sd">        r : float</span>
</span><span id="L-3248"><a href="#L-3248"><span class="linenos">3248</span></a><span class="sd">            Adjusted radius of the diffraction ring.</span>
</span><span id="L-3249"><a href="#L-3249"><span class="linenos">3249</span></a><span class="sd">      </span>
</span><span id="L-3250"><a href="#L-3250"><span class="linenos">3250</span></a><span class="sd">        Notes</span>
</span><span id="L-3251"><a href="#L-3251"><span class="linenos">3251</span></a><span class="sd">        -----</span>
</span><span id="L-3252"><a href="#L-3252"><span class="linenos">3252</span></a><span class="sd">        - Interactive adjustments are visualized in real time.</span>
</span><span id="L-3253"><a href="#L-3253"><span class="linenos">3253</span></a><span class="sd">        - Intensity sum at the current center/radius is printed</span>
</span><span id="L-3254"><a href="#L-3254"><span class="linenos">3254</span></a><span class="sd">          if *print_sums* argument is True.</span>
</span><span id="L-3255"><a href="#L-3255"><span class="linenos">3255</span></a><span class="sd">        - Arrow key defaults in Matplotlib (e.g., navigation)</span>
</span><span id="L-3256"><a href="#L-3256"><span class="linenos">3256</span></a><span class="sd">          are temporarily disabled to allow movement control.</span>
</span><span id="L-3257"><a href="#L-3257"><span class="linenos">3257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3258"><a href="#L-3258"><span class="linenos">3258</span></a>             
</span><span id="L-3259"><a href="#L-3259"><span class="linenos">3259</span></a>        <span class="c1"># (0) Load original image ---------------------------------------------</span>
</span><span id="L-3260"><a href="#L-3260"><span class="linenos">3260</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-3261"><a href="#L-3261"><span class="linenos">3261</span></a>
</span><span id="L-3262"><a href="#L-3262"><span class="linenos">3262</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="L-3263"><a href="#L-3263"><span class="linenos">3263</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3264"><a href="#L-3264"><span class="linenos">3264</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-3265"><a href="#L-3265"><span class="linenos">3265</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="L-3266"><a href="#L-3266"><span class="linenos">3266</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-3267"><a href="#L-3267"><span class="linenos">3267</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-3268"><a href="#L-3268"><span class="linenos">3268</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="L-3269"><a href="#L-3269"><span class="linenos">3269</span></a>            
</span><span id="L-3270"><a href="#L-3270"><span class="linenos">3270</span></a>        <span class="c1"># (1) Initialize variables and flags ----------------------------------</span>
</span><span id="L-3271"><a href="#L-3271"><span class="linenos">3271</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>
</span><span id="L-3272"><a href="#L-3272"><span class="linenos">3272</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="L-3273"><a href="#L-3273"><span class="linenos">3273</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-3274"><a href="#L-3274"><span class="linenos">3274</span></a>
</span><span id="L-3275"><a href="#L-3275"><span class="linenos">3275</span></a>        <span class="c1"># (2) User information ------------------------------------------------</span>
</span><span id="L-3276"><a href="#L-3276"><span class="linenos">3276</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-3277"><a href="#L-3277"><span class="linenos">3277</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-3278"><a href="#L-3278"><span class="linenos">3278</span></a><span class="s2">            </span>
</span><span id="L-3279"><a href="#L-3279"><span class="linenos">3279</span></a><span class="s2">            Interactive refinement. Use these keys:</span>
</span><span id="L-3280"><a href="#L-3280"><span class="linenos">3280</span></a><span class="s2">                  - &#39;←&#39; : move left</span>
</span><span id="L-3281"><a href="#L-3281"><span class="linenos">3281</span></a><span class="s2">                  - &#39;→&#39; : move right</span>
</span><span id="L-3282"><a href="#L-3282"><span class="linenos">3282</span></a><span class="s2">                  - &#39;↑&#39; : move up</span>
</span><span id="L-3283"><a href="#L-3283"><span class="linenos">3283</span></a><span class="s2">                  - &#39;↓&#39; : move down</span>
</span><span id="L-3284"><a href="#L-3284"><span class="linenos">3284</span></a><span class="s2">                  - &#39;+&#39; : increase circle radius</span>
</span><span id="L-3285"><a href="#L-3285"><span class="linenos">3285</span></a><span class="s2">                  - &#39;-&#39; : decrease circle radius</span>
</span><span id="L-3286"><a href="#L-3286"><span class="linenos">3286</span></a><span class="s2">                  - &#39;b&#39; : increase step size</span>
</span><span id="L-3287"><a href="#L-3287"><span class="linenos">3287</span></a><span class="s2">                  - &#39;l&#39; : decrease step size</span>
</span><span id="L-3288"><a href="#L-3288"><span class="linenos">3288</span></a><span class="s2">                  - &#39;d&#39; : refinement done</span>
</span><span id="L-3289"><a href="#L-3289"><span class="linenos">3289</span></a><span class="s2">                  </span>
</span><span id="L-3290"><a href="#L-3290"><span class="linenos">3290</span></a><span class="s2">            DISCLAIMER: For the purpose of the center shift, the default</span>
</span><span id="L-3291"><a href="#L-3291"><span class="linenos">3291</span></a><span class="s2">            shortcuts for left and right arrows were removed.</span>
</span><span id="L-3292"><a href="#L-3292"><span class="linenos">3292</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-3293"><a href="#L-3293"><span class="linenos">3293</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="L-3294"><a href="#L-3294"><span class="linenos">3294</span></a>        
</span><span id="L-3295"><a href="#L-3295"><span class="linenos">3295</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-3296"><a href="#L-3296"><span class="linenos">3296</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="L-3297"><a href="#L-3297"><span class="linenos">3297</span></a>            
</span><span id="L-3298"><a href="#L-3298"><span class="linenos">3298</span></a>        <span class="c1"># (3) Create a figure and display the image ---------------------------</span>
</span><span id="L-3299"><a href="#L-3299"><span class="linenos">3299</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="L-3300"><a href="#L-3300"><span class="linenos">3300</span></a>        
</span><span id="L-3301"><a href="#L-3301"><span class="linenos">3301</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="L-3302"><a href="#L-3302"><span class="linenos">3302</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-3303"><a href="#L-3303"><span class="linenos">3303</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-3304"><a href="#L-3304"><span class="linenos">3304</span></a>        
</span><span id="L-3305"><a href="#L-3305"><span class="linenos">3305</span></a>        <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="L-3306"><a href="#L-3306"><span class="linenos">3306</span></a>            <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">pr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3307"><a href="#L-3307"><span class="linenos">3307</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="L-3308"><a href="#L-3308"><span class="linenos">3308</span></a>
</span><span id="L-3309"><a href="#L-3309"><span class="linenos">3309</span></a>        <span class="c1"># Plot center point</span>
</span><span id="L-3310"><a href="#L-3310"><span class="linenos">3310</span></a>        <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-3311"><a href="#L-3311"><span class="linenos">3311</span></a>                    
</span><span id="L-3312"><a href="#L-3312"><span class="linenos">3312</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the center position.&#39;</span><span class="p">,</span> 
</span><span id="L-3313"><a href="#L-3313"><span class="linenos">3313</span></a>                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-3314"><a href="#L-3314"><span class="linenos">3314</span></a>
</span><span id="L-3315"><a href="#L-3315"><span class="linenos">3315</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-3316"><a href="#L-3316"><span class="linenos">3316</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-3317"><a href="#L-3317"><span class="linenos">3317</span></a>        
</span><span id="L-3318"><a href="#L-3318"><span class="linenos">3318</span></a>        <span class="c1"># (4) Enable interactive mode -----------------------------------------</span>
</span><span id="L-3319"><a href="#L-3319"><span class="linenos">3319</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="L-3320"><a href="#L-3320"><span class="linenos">3320</span></a>        
</span><span id="L-3321"><a href="#L-3321"><span class="linenos">3321</span></a>
</span><span id="L-3322"><a href="#L-3322"><span class="linenos">3322</span></a>        <span class="c1"># (5) Display the image -----------------------------------------------</span>
</span><span id="L-3323"><a href="#L-3323"><span class="linenos">3323</span></a>        <span class="c1"># fig.set_size_inches(self.fig_width, self.fig_height)</span>
</span><span id="L-3324"><a href="#L-3324"><span class="linenos">3324</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3325"><a href="#L-3325"><span class="linenos">3325</span></a>        
</span><span id="L-3326"><a href="#L-3326"><span class="linenos">3326</span></a>        <span class="c1"># (6) Define the event handler for figure close event -----------------</span>
</span><span id="L-3327"><a href="#L-3327"><span class="linenos">3327</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-3328"><a href="#L-3328"><span class="linenos">3328</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="L-3329"><a href="#L-3329"><span class="linenos">3329</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3330"><a href="#L-3330"><span class="linenos">3330</span></a> 
</span><span id="L-3331"><a href="#L-3331"><span class="linenos">3331</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="L-3332"><a href="#L-3332"><span class="linenos">3332</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="L-3333"><a href="#L-3333"><span class="linenos">3333</span></a>
</span><span id="L-3334"><a href="#L-3334"><span class="linenos">3334</span></a>        <span class="c1"># (7) Define the callback function for key press events ---------------</span>
</span><span id="L-3335"><a href="#L-3335"><span class="linenos">3335</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-3336"><a href="#L-3336"><span class="linenos">3336</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="L-3337"><a href="#L-3337"><span class="linenos">3337</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="L-3338"><a href="#L-3338"><span class="linenos">3338</span></a>        
</span><span id="L-3339"><a href="#L-3339"><span class="linenos">3339</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="L-3340"><a href="#L-3340"><span class="linenos">3340</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="L-3341"><a href="#L-3341"><span class="linenos">3341</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="L-3342"><a href="#L-3342"><span class="linenos">3342</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="L-3343"><a href="#L-3343"><span class="linenos">3343</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="L-3344"><a href="#L-3344"><span class="linenos">3344</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="L-3345"><a href="#L-3345"><span class="linenos">3345</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="L-3346"><a href="#L-3346"><span class="linenos">3346</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="L-3347"><a href="#L-3347"><span class="linenos">3347</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="L-3348"><a href="#L-3348"><span class="linenos">3348</span></a>        
</span><span id="L-3349"><a href="#L-3349"><span class="linenos">3349</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="L-3350"><a href="#L-3350"><span class="linenos">3350</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="L-3351"><a href="#L-3351"><span class="linenos">3351</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-3352"><a href="#L-3352"><span class="linenos">3352</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-3353"><a href="#L-3353"><span class="linenos">3353</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="L-3354"><a href="#L-3354"><span class="linenos">3354</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="L-3355"><a href="#L-3355"><span class="linenos">3355</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-3356"><a href="#L-3356"><span class="linenos">3356</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="L-3357"><a href="#L-3357"><span class="linenos">3357</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-3358"><a href="#L-3358"><span class="linenos">3358</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="L-3359"><a href="#L-3359"><span class="linenos">3359</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-3360"><a href="#L-3360"><span class="linenos">3360</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="L-3361"><a href="#L-3361"><span class="linenos">3361</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-3362"><a href="#L-3362"><span class="linenos">3362</span></a>                    
</span><span id="L-3363"><a href="#L-3363"><span class="linenos">3363</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="L-3364"><a href="#L-3364"><span class="linenos">3364</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-3365"><a href="#L-3365"><span class="linenos">3365</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-3366"><a href="#L-3366"><span class="linenos">3366</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-3367"><a href="#L-3367"><span class="linenos">3367</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3368"><a href="#L-3368"><span class="linenos">3368</span></a>            
</span><span id="L-3369"><a href="#L-3369"><span class="linenos">3369</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="L-3370"><a href="#L-3370"><span class="linenos">3370</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="L-3371"><a href="#L-3371"><span class="linenos">3371</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3372"><a href="#L-3372"><span class="linenos">3372</span></a>        
</span><span id="L-3373"><a href="#L-3373"><span class="linenos">3373</span></a>            <span class="c1"># Change step size </span>
</span><span id="L-3374"><a href="#L-3374"><span class="linenos">3374</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="L-3375"><a href="#L-3375"><span class="linenos">3375</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="L-3376"><a href="#L-3376"><span class="linenos">3376</span></a>        
</span><span id="L-3377"><a href="#L-3377"><span class="linenos">3377</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="L-3378"><a href="#L-3378"><span class="linenos">3378</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="L-3379"><a href="#L-3379"><span class="linenos">3379</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="L-3380"><a href="#L-3380"><span class="linenos">3380</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-3381"><a href="#L-3381"><span class="linenos">3381</span></a>        
</span><span id="L-3382"><a href="#L-3382"><span class="linenos">3382</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="L-3383"><a href="#L-3383"><span class="linenos">3383</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="L-3384"><a href="#L-3384"><span class="linenos">3384</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="L-3385"><a href="#L-3385"><span class="linenos">3385</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="L-3386"><a href="#L-3386"><span class="linenos">3386</span></a>        
</span><span id="L-3387"><a href="#L-3387"><span class="linenos">3387</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-3388"><a href="#L-3388"><span class="linenos">3388</span></a>        
</span><span id="L-3389"><a href="#L-3389"><span class="linenos">3389</span></a>            <span class="c1"># Update the plot</span>
</span><span id="L-3390"><a href="#L-3390"><span class="linenos">3390</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-3391"><a href="#L-3391"><span class="linenos">3391</span></a>
</span><span id="L-3392"><a href="#L-3392"><span class="linenos">3392</span></a>            
</span><span id="L-3393"><a href="#L-3393"><span class="linenos">3393</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="L-3394"><a href="#L-3394"><span class="linenos">3394</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="L-3395"><a href="#L-3395"><span class="linenos">3395</span></a>        
</span><span id="L-3396"><a href="#L-3396"><span class="linenos">3396</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="L-3397"><a href="#L-3397"><span class="linenos">3397</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="L-3398"><a href="#L-3398"><span class="linenos">3398</span></a>
</span><span id="L-3399"><a href="#L-3399"><span class="linenos">3399</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="L-3400"><a href="#L-3400"><span class="linenos">3400</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="L-3401"><a href="#L-3401"><span class="linenos">3401</span></a>               
</span><span id="L-3402"><a href="#L-3402"><span class="linenos">3402</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="L-3403"><a href="#L-3403"><span class="linenos">3403</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="L-3404"><a href="#L-3404"><span class="linenos">3404</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3405"><a href="#L-3405"><span class="linenos">3405</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-3406"><a href="#L-3406"><span class="linenos">3406</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-3407"><a href="#L-3407"><span class="linenos">3407</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="L-3408"><a href="#L-3408"><span class="linenos">3408</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3409"><a href="#L-3409"><span class="linenos">3409</span></a>         
</span><span id="L-3410"><a href="#L-3410"><span class="linenos">3410</span></a>        <span class="c1"># (8) Turn off interactive mode ---------------------------------------</span>
</span><span id="L-3411"><a href="#L-3411"><span class="linenos">3411</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="L-3412"><a href="#L-3412"><span class="linenos">3412</span></a>        
</span><span id="L-3413"><a href="#L-3413"><span class="linenos">3413</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="L-3414"><a href="#L-3414"><span class="linenos">3414</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-3415"><a href="#L-3415"><span class="linenos">3415</span></a>
</span><span id="L-3416"><a href="#L-3416"><span class="linenos">3416</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3417"><a href="#L-3417"><span class="linenos">3417</span></a>        
</span><span id="L-3418"><a href="#L-3418"><span class="linenos">3418</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="L-3419"><a href="#L-3419"><span class="linenos">3419</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="L-3420"><a href="#L-3420"><span class="linenos">3420</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="L-3421"><a href="#L-3421"><span class="linenos">3421</span></a>
</span><span id="L-3422"><a href="#L-3422"><span class="linenos">3422</span></a>        <span class="c1"># User information:</span>
</span><span id="L-3423"><a href="#L-3423"><span class="linenos">3423</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-3424"><a href="#L-3424"><span class="linenos">3424</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-3425"><a href="#L-3425"><span class="linenos">3425</span></a>
</span><span id="L-3426"><a href="#L-3426"><span class="linenos">3426</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>    
</span><span id="L-3427"><a href="#L-3427"><span class="linenos">3427</span></a>        
</span><span id="L-3428"><a href="#L-3428"><span class="linenos">3428</span></a>    
</span><span id="L-3429"><a href="#L-3429"><span class="linenos">3429</span></a>    <span class="k">def</span> <span class="nf">ref_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-3430"><a href="#L-3430"><span class="linenos">3430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3431"><a href="#L-3431"><span class="linenos">3431</span></a><span class="sd">        Refine the center coordinates (px, py) and radius (pr) of a circular </span>
</span><span id="L-3432"><a href="#L-3432"><span class="linenos">3432</span></a><span class="sd">        diffraction pattern by minimizing the variance of pixel intensities </span>
</span><span id="L-3433"><a href="#L-3433"><span class="linenos">3433</span></a><span class="sd">        along the circle&#39;s border.</span>
</span><span id="L-3434"><a href="#L-3434"><span class="linenos">3434</span></a>
</span><span id="L-3435"><a href="#L-3435"><span class="linenos">3435</span></a><span class="sd">        This method performs iterative local search in the 8-neighbourhood </span>
</span><span id="L-3436"><a href="#L-3436"><span class="linenos">3436</span></a><span class="sd">        around the current center to find a position and radius that minimize </span>
</span><span id="L-3437"><a href="#L-3437"><span class="linenos">3437</span></a><span class="sd">        the intensity variance. The refinement stops when convergence criteria </span>
</span><span id="L-3438"><a href="#L-3438"><span class="linenos">3438</span></a><span class="sd">        are met or after a maximum number of iterations.</span>
</span><span id="L-3439"><a href="#L-3439"><span class="linenos">3439</span></a>
</span><span id="L-3440"><a href="#L-3440"><span class="linenos">3440</span></a><span class="sd">        Neighborhood pattern tested (o = current center, x = candidate center):</span>
</span><span id="L-3441"><a href="#L-3441"><span class="linenos">3441</span></a><span class="sd">            x x x   --&gt; (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)</span>
</span><span id="L-3442"><a href="#L-3442"><span class="linenos">3442</span></a><span class="sd">            x o x   --&gt; (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="L-3443"><a href="#L-3443"><span class="linenos">3443</span></a><span class="sd">            x x x   --&gt; (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="L-3444"><a href="#L-3444"><span class="linenos">3444</span></a>
</span><span id="L-3445"><a href="#L-3445"><span class="linenos">3445</span></a><span class="sd">        Parameters</span>
</span><span id="L-3446"><a href="#L-3446"><span class="linenos">3446</span></a><span class="sd">        ----------</span>
</span><span id="L-3447"><a href="#L-3447"><span class="linenos">3447</span></a><span class="sd">        px : float</span>
</span><span id="L-3448"><a href="#L-3448"><span class="linenos">3448</span></a><span class="sd">            Initial x-coordinate of the detected center.</span>
</span><span id="L-3449"><a href="#L-3449"><span class="linenos">3449</span></a><span class="sd">            </span>
</span><span id="L-3450"><a href="#L-3450"><span class="linenos">3450</span></a><span class="sd">        py : float</span>
</span><span id="L-3451"><a href="#L-3451"><span class="linenos">3451</span></a><span class="sd">            Initial y-coordinate of the detected center.</span>
</span><span id="L-3452"><a href="#L-3452"><span class="linenos">3452</span></a><span class="sd">            </span>
</span><span id="L-3453"><a href="#L-3453"><span class="linenos">3453</span></a><span class="sd">        pr : float</span>
</span><span id="L-3454"><a href="#L-3454"><span class="linenos">3454</span></a><span class="sd">            Initial radius of the detected circular pattern.</span>
</span><span id="L-3455"><a href="#L-3455"><span class="linenos">3455</span></a><span class="sd">            </span>
</span><span id="L-3456"><a href="#L-3456"><span class="linenos">3456</span></a><span class="sd">        plot_results : int, optional (default=0)</span>
</span><span id="L-3457"><a href="#L-3457"><span class="linenos">3457</span></a><span class="sd">            Whether to plot the refinement result (1 = yes, 0 = no).</span>
</span><span id="L-3458"><a href="#L-3458"><span class="linenos">3458</span></a>
</span><span id="L-3459"><a href="#L-3459"><span class="linenos">3459</span></a><span class="sd">        Returns</span>
</span><span id="L-3460"><a href="#L-3460"><span class="linenos">3460</span></a><span class="sd">        -------</span>
</span><span id="L-3461"><a href="#L-3461"><span class="linenos">3461</span></a><span class="sd">        px : float</span>
</span><span id="L-3462"><a href="#L-3462"><span class="linenos">3462</span></a><span class="sd">            Refined x-coordinate of the center.</span>
</span><span id="L-3463"><a href="#L-3463"><span class="linenos">3463</span></a><span class="sd">            </span>
</span><span id="L-3464"><a href="#L-3464"><span class="linenos">3464</span></a><span class="sd">        py : float</span>
</span><span id="L-3465"><a href="#L-3465"><span class="linenos">3465</span></a><span class="sd">            Refined y-coordinate of the center.</span>
</span><span id="L-3466"><a href="#L-3466"><span class="linenos">3466</span></a><span class="sd">            </span>
</span><span id="L-3467"><a href="#L-3467"><span class="linenos">3467</span></a><span class="sd">        pr : float</span>
</span><span id="L-3468"><a href="#L-3468"><span class="linenos">3468</span></a><span class="sd">            Refined radius of the circular pattern.</span>
</span><span id="L-3469"><a href="#L-3469"><span class="linenos">3469</span></a>
</span><span id="L-3470"><a href="#L-3470"><span class="linenos">3470</span></a><span class="sd">        Notes</span>
</span><span id="L-3471"><a href="#L-3471"><span class="linenos">3471</span></a><span class="sd">        -----</span>
</span><span id="L-3472"><a href="#L-3472"><span class="linenos">3472</span></a><span class="sd">        - The function avoids overfitting to local minima by enforcing </span>
</span><span id="L-3473"><a href="#L-3473"><span class="linenos">3473</span></a><span class="sd">          convergence thresholds and consistency checks.</span>
</span><span id="L-3474"><a href="#L-3474"><span class="linenos">3474</span></a><span class="sd">        - If the refinement worsens the initial variance significantly or </span>
</span><span id="L-3475"><a href="#L-3475"><span class="linenos">3475</span></a><span class="sd">          suggests an invalid coordinate swap, the original input is preserved.</span>
</span><span id="L-3476"><a href="#L-3476"><span class="linenos">3476</span></a><span class="sd">        - Uses `self.parent.intensity_variance()` for evaluating the criterion.</span>
</span><span id="L-3477"><a href="#L-3477"><span class="linenos">3477</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3478"><a href="#L-3478"><span class="linenos">3478</span></a>        
</span><span id="L-3479"><a href="#L-3479"><span class="linenos">3479</span></a>        <span class="c1"># Store input for plot</span>
</span><span id="L-3480"><a href="#L-3480"><span class="linenos">3480</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="L-3481"><a href="#L-3481"><span class="linenos">3481</span></a>        
</span><span id="L-3482"><a href="#L-3482"><span class="linenos">3482</span></a>        <span class="c1"># Load image</span>
</span><span id="L-3483"><a href="#L-3483"><span class="linenos">3483</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-3484"><a href="#L-3484"><span class="linenos">3484</span></a>
</span><span id="L-3485"><a href="#L-3485"><span class="linenos">3485</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="L-3486"><a href="#L-3486"><span class="linenos">3486</span></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-3487"><a href="#L-3487"><span class="linenos">3487</span></a>        <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-3488"><a href="#L-3488"><span class="linenos">3488</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="L-3489"><a href="#L-3489"><span class="linenos">3489</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="L-3490"><a href="#L-3490"><span class="linenos">3490</span></a>    
</span><span id="L-3491"><a href="#L-3491"><span class="linenos">3491</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="L-3492"><a href="#L-3492"><span class="linenos">3492</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="L-3493"><a href="#L-3493"><span class="linenos">3493</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="L-3494"><a href="#L-3494"><span class="linenos">3494</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">min_intensity_var</span>
</span><span id="L-3495"><a href="#L-3495"><span class="linenos">3495</span></a>        
</span><span id="L-3496"><a href="#L-3496"><span class="linenos">3496</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="L-3497"><a href="#L-3497"><span class="linenos">3497</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-3498"><a href="#L-3498"><span class="linenos">3498</span></a>        
</span><span id="L-3499"><a href="#L-3499"><span class="linenos">3499</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="L-3500"><a href="#L-3500"><span class="linenos">3500</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="L-3501"><a href="#L-3501"><span class="linenos">3501</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="L-3502"><a href="#L-3502"><span class="linenos">3502</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3503"><a href="#L-3503"><span class="linenos">3503</span></a>    
</span><span id="L-3504"><a href="#L-3504"><span class="linenos">3504</span></a>    
</span><span id="L-3505"><a href="#L-3505"><span class="linenos">3505</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="L-3506"><a href="#L-3506"><span class="linenos">3506</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="L-3507"><a href="#L-3507"><span class="linenos">3507</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="L-3508"><a href="#L-3508"><span class="linenos">3508</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="L-3509"><a href="#L-3509"><span class="linenos">3509</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-3510"><a href="#L-3510"><span class="linenos">3510</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="L-3511"><a href="#L-3511"><span class="linenos">3511</span></a>        
</span><span id="L-3512"><a href="#L-3512"><span class="linenos">3512</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="L-3513"><a href="#L-3513"><span class="linenos">3513</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="L-3514"><a href="#L-3514"><span class="linenos">3514</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-3515"><a href="#L-3515"><span class="linenos">3515</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-3516"><a href="#L-3516"><span class="linenos">3516</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-3517"><a href="#L-3517"><span class="linenos">3517</span></a>                                      <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="L-3518"><a href="#L-3518"><span class="linenos">3518</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="L-3519"><a href="#L-3519"><span class="linenos">3519</span></a>            <span class="n">curr_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3520"><a href="#L-3520"><span class="linenos">3520</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="L-3521"><a href="#L-3521"><span class="linenos">3521</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="L-3522"><a href="#L-3522"><span class="linenos">3522</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="L-3523"><a href="#L-3523"><span class="linenos">3523</span></a>                <span class="n">curr_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-3524"><a href="#L-3524"><span class="linenos">3524</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">))</span>
</span><span id="L-3525"><a href="#L-3525"><span class="linenos">3525</span></a>            
</span><span id="L-3526"><a href="#L-3526"><span class="linenos">3526</span></a>            <span class="c1"># Find the minimum value coordinates within curr_intensity_var</span>
</span><span id="L-3527"><a href="#L-3527"><span class="linenos">3527</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span>
</span><span id="L-3528"><a href="#L-3528"><span class="linenos">3528</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-3529"><a href="#L-3529"><span class="linenos">3529</span></a>                    
</span><span id="L-3530"><a href="#L-3530"><span class="linenos">3530</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="L-3531"><a href="#L-3531"><span class="linenos">3531</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="L-3532"><a href="#L-3532"><span class="linenos">3532</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="L-3533"><a href="#L-3533"><span class="linenos">3533</span></a>            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_intensity_var</span><span class="p">:</span>                           
</span><span id="L-3534"><a href="#L-3534"><span class="linenos">3534</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span>
</span><span id="L-3535"><a href="#L-3535"><span class="linenos">3535</span></a>                
</span><span id="L-3536"><a href="#L-3536"><span class="linenos">3536</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="L-3537"><a href="#L-3537"><span class="linenos">3537</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="L-3538"><a href="#L-3538"><span class="linenos">3538</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="L-3539"><a href="#L-3539"><span class="linenos">3539</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="L-3540"><a href="#L-3540"><span class="linenos">3540</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="L-3541"><a href="#L-3541"><span class="linenos">3541</span></a>                
</span><span id="L-3542"><a href="#L-3542"><span class="linenos">3542</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="L-3543"><a href="#L-3543"><span class="linenos">3543</span></a>            <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-3544"><a href="#L-3544"><span class="linenos">3544</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-3545"><a href="#L-3545"><span class="linenos">3545</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-3546"><a href="#L-3546"><span class="linenos">3546</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="L-3547"><a href="#L-3547"><span class="linenos">3547</span></a>            
</span><span id="L-3548"><a href="#L-3548"><span class="linenos">3548</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="L-3549"><a href="#L-3549"><span class="linenos">3549</span></a>            <span class="c1"># constant. It iterates through different radius adjustments</span>
</span><span id="L-3550"><a href="#L-3550"><span class="linenos">3550</span></a>            <span class="c1"># to find a radius that maximizes the intensity sum of pixels.</span>
</span><span id="L-3551"><a href="#L-3551"><span class="linenos">3551</span></a>            
</span><span id="L-3552"><a href="#L-3552"><span class="linenos">3552</span></a>            <span class="n">radi_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3553"><a href="#L-3553"><span class="linenos">3553</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-3554"><a href="#L-3554"><span class="linenos">3554</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="L-3555"><a href="#L-3555"><span class="linenos">3555</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="L-3556"><a href="#L-3556"><span class="linenos">3556</span></a>                <span class="n">radi_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-3557"><a href="#L-3557"><span class="linenos">3557</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-3558"><a href="#L-3558"><span class="linenos">3558</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-3559"><a href="#L-3559"><span class="linenos">3559</span></a>                                                             <span class="n">new_radius</span><span class="p">))</span>
</span><span id="L-3560"><a href="#L-3560"><span class="linenos">3560</span></a>                
</span><span id="L-3561"><a href="#L-3561"><span class="linenos">3561</span></a>            <span class="c1"># Find the minimum value coordinates within curr_var</span>
</span><span id="L-3562"><a href="#L-3562"><span class="linenos">3562</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span>
</span><span id="L-3563"><a href="#L-3563"><span class="linenos">3563</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-3564"><a href="#L-3564"><span class="linenos">3564</span></a>            
</span><span id="L-3565"><a href="#L-3565"><span class="linenos">3565</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="L-3566"><a href="#L-3566"><span class="linenos">3566</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_intensity_var</span><span class="p">:</span>
</span><span id="L-3567"><a href="#L-3567"><span class="linenos">3567</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span>
</span><span id="L-3568"><a href="#L-3568"><span class="linenos">3568</span></a>                
</span><span id="L-3569"><a href="#L-3569"><span class="linenos">3569</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="L-3570"><a href="#L-3570"><span class="linenos">3570</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="L-3571"><a href="#L-3571"><span class="linenos">3571</span></a>                
</span><span id="L-3572"><a href="#L-3572"><span class="linenos">3572</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="L-3573"><a href="#L-3573"><span class="linenos">3573</span></a>
</span><span id="L-3574"><a href="#L-3574"><span class="linenos">3574</span></a>            
</span><span id="L-3575"><a href="#L-3575"><span class="linenos">3575</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="L-3576"><a href="#L-3576"><span class="linenos">3576</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_intensity_var</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="L-3577"><a href="#L-3577"><span class="linenos">3577</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="L-3578"><a href="#L-3578"><span class="linenos">3578</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-3579"><a href="#L-3579"><span class="linenos">3579</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-3580"><a href="#L-3580"><span class="linenos">3580</span></a>                    <span class="k">break</span>
</span><span id="L-3581"><a href="#L-3581"><span class="linenos">3581</span></a>        
</span><span id="L-3582"><a href="#L-3582"><span class="linenos">3582</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="L-3583"><a href="#L-3583"><span class="linenos">3583</span></a>        <span class="c1">## (1) swapped coordinates</span>
</span><span id="L-3584"><a href="#L-3584"><span class="linenos">3584</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-3585"><a href="#L-3585"><span class="linenos">3585</span></a>            <span class="ow">or</span>  <span class="p">(</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="L-3586"><a href="#L-3586"><span class="linenos">3586</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-3587"><a href="#L-3587"><span class="linenos">3587</span></a>        
</span><span id="L-3588"><a href="#L-3588"><span class="linenos">3588</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="L-3589"><a href="#L-3589"><span class="linenos">3589</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_intensity_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-3590"><a href="#L-3590"><span class="linenos">3590</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="L-3591"><a href="#L-3591"><span class="linenos">3591</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="L-3592"><a href="#L-3592"><span class="linenos">3592</span></a>    
</span><span id="L-3593"><a href="#L-3593"><span class="linenos">3593</span></a>        <span class="c1"># Print results</span>
</span><span id="L-3594"><a href="#L-3594"><span class="linenos">3594</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-3595"><a href="#L-3595"><span class="linenos">3595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="L-3596"><a href="#L-3596"><span class="linenos">3596</span></a>                <span class="s2">&quot;Center Refinement (IntensityVar)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-3597"><a href="#L-3597"><span class="linenos">3597</span></a>                                  
</span><span id="L-3598"><a href="#L-3598"><span class="linenos">3598</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span><span id="L-3599"><a href="#L-3599"><span class="linenos">3599</span></a>    
</span><span id="L-3600"><a href="#L-3600"><span class="linenos">3600</span></a>    
</span><span id="L-3601"><a href="#L-3601"><span class="linenos">3601</span></a>    <span class="k">def</span> <span class="nf">ref_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-3602"><a href="#L-3602"><span class="linenos">3602</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3603"><a href="#L-3603"><span class="linenos">3603</span></a><span class="sd">        Refine the center coordinates (px, py) and radius (pr) of a circular </span>
</span><span id="L-3604"><a href="#L-3604"><span class="linenos">3604</span></a><span class="sd">        diffraction pattern by maximizing the summed pixel intensity along </span>
</span><span id="L-3605"><a href="#L-3605"><span class="linenos">3605</span></a><span class="sd">        a circular ring.</span>
</span><span id="L-3606"><a href="#L-3606"><span class="linenos">3606</span></a>
</span><span id="L-3607"><a href="#L-3607"><span class="linenos">3607</span></a><span class="sd">        The method uses an iterative local search strategy based on gradient </span>
</span><span id="L-3608"><a href="#L-3608"><span class="linenos">3608</span></a><span class="sd">        ascent in the 8-neighbourhood around the current center to find </span>
</span><span id="L-3609"><a href="#L-3609"><span class="linenos">3609</span></a><span class="sd">        a position and radius that maximize the intensity sum. The center </span>
</span><span id="L-3610"><a href="#L-3610"><span class="linenos">3610</span></a><span class="sd">        is updated based on the best neighbor until convergence criteria </span>
</span><span id="L-3611"><a href="#L-3611"><span class="linenos">3611</span></a><span class="sd">        or maximum iteration limits are met.</span>
</span><span id="L-3612"><a href="#L-3612"><span class="linenos">3612</span></a>
</span><span id="L-3613"><a href="#L-3613"><span class="linenos">3613</span></a><span class="sd">        Neighborhood pattern tested (o = current center, x = candidate center):</span>
</span><span id="L-3614"><a href="#L-3614"><span class="linenos">3614</span></a><span class="sd">            x x x   --&gt; (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)</span>
</span><span id="L-3615"><a href="#L-3615"><span class="linenos">3615</span></a><span class="sd">            x o x   --&gt; (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="L-3616"><a href="#L-3616"><span class="linenos">3616</span></a><span class="sd">            x x x   --&gt; (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="L-3617"><a href="#L-3617"><span class="linenos">3617</span></a>
</span><span id="L-3618"><a href="#L-3618"><span class="linenos">3618</span></a><span class="sd">        Parameters</span>
</span><span id="L-3619"><a href="#L-3619"><span class="linenos">3619</span></a><span class="sd">        ----------</span>
</span><span id="L-3620"><a href="#L-3620"><span class="linenos">3620</span></a><span class="sd">        px : float</span>
</span><span id="L-3621"><a href="#L-3621"><span class="linenos">3621</span></a><span class="sd">            Initial x-coordinate of the detected center.</span>
</span><span id="L-3622"><a href="#L-3622"><span class="linenos">3622</span></a><span class="sd">            </span>
</span><span id="L-3623"><a href="#L-3623"><span class="linenos">3623</span></a><span class="sd">        py : float</span>
</span><span id="L-3624"><a href="#L-3624"><span class="linenos">3624</span></a><span class="sd">            Initial y-coordinate of the detected center.</span>
</span><span id="L-3625"><a href="#L-3625"><span class="linenos">3625</span></a><span class="sd">            </span>
</span><span id="L-3626"><a href="#L-3626"><span class="linenos">3626</span></a><span class="sd">        pr : float</span>
</span><span id="L-3627"><a href="#L-3627"><span class="linenos">3627</span></a><span class="sd">            Initial radius of the detected circular pattern.</span>
</span><span id="L-3628"><a href="#L-3628"><span class="linenos">3628</span></a><span class="sd">            </span>
</span><span id="L-3629"><a href="#L-3629"><span class="linenos">3629</span></a><span class="sd">        plot_results : int, optional (default=0)</span>
</span><span id="L-3630"><a href="#L-3630"><span class="linenos">3630</span></a><span class="sd">            If set to 1, plots the final result of the refinement.</span>
</span><span id="L-3631"><a href="#L-3631"><span class="linenos">3631</span></a>
</span><span id="L-3632"><a href="#L-3632"><span class="linenos">3632</span></a><span class="sd">        Returns</span>
</span><span id="L-3633"><a href="#L-3633"><span class="linenos">3633</span></a><span class="sd">        -------</span>
</span><span id="L-3634"><a href="#L-3634"><span class="linenos">3634</span></a><span class="sd">        px : float</span>
</span><span id="L-3635"><a href="#L-3635"><span class="linenos">3635</span></a><span class="sd">            Refined x-coordinate of the center.</span>
</span><span id="L-3636"><a href="#L-3636"><span class="linenos">3636</span></a><span class="sd">            </span>
</span><span id="L-3637"><a href="#L-3637"><span class="linenos">3637</span></a><span class="sd">        py : float</span>
</span><span id="L-3638"><a href="#L-3638"><span class="linenos">3638</span></a><span class="sd">            Refined y-coordinate of the center.</span>
</span><span id="L-3639"><a href="#L-3639"><span class="linenos">3639</span></a><span class="sd">            </span>
</span><span id="L-3640"><a href="#L-3640"><span class="linenos">3640</span></a><span class="sd">        pr : float</span>
</span><span id="L-3641"><a href="#L-3641"><span class="linenos">3641</span></a><span class="sd">            Refined radius of the circular pattern.</span>
</span><span id="L-3642"><a href="#L-3642"><span class="linenos">3642</span></a>
</span><span id="L-3643"><a href="#L-3643"><span class="linenos">3643</span></a><span class="sd">        Notes</span>
</span><span id="L-3644"><a href="#L-3644"><span class="linenos">3644</span></a><span class="sd">        -----</span>
</span><span id="L-3645"><a href="#L-3645"><span class="linenos">3645</span></a><span class="sd">        - Uses `self.parent.intensity_sum()` as the optimization criterion.</span>
</span><span id="L-3646"><a href="#L-3646"><span class="linenos">3646</span></a><span class="sd">        - Alternates between optimizing the center and the radius.</span>
</span><span id="L-3647"><a href="#L-3647"><span class="linenos">3647</span></a><span class="sd">        - Stops after no significant improvement over multiple iterations.</span>
</span><span id="L-3648"><a href="#L-3648"><span class="linenos">3648</span></a><span class="sd">        - If refinement worsens the result, the original values are retained.</span>
</span><span id="L-3649"><a href="#L-3649"><span class="linenos">3649</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3650"><a href="#L-3650"><span class="linenos">3650</span></a>        <span class="c1"># Store input for plot via self.visualize_refinement()</span>
</span><span id="L-3651"><a href="#L-3651"><span class="linenos">3651</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="L-3652"><a href="#L-3652"><span class="linenos">3652</span></a>    
</span><span id="L-3653"><a href="#L-3653"><span class="linenos">3653</span></a>        <span class="c1"># Image in which the center is refined</span>
</span><span id="L-3654"><a href="#L-3654"><span class="linenos">3654</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-3655"><a href="#L-3655"><span class="linenos">3655</span></a>    
</span><span id="L-3656"><a href="#L-3656"><span class="linenos">3656</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="L-3657"><a href="#L-3657"><span class="linenos">3657</span></a>        <span class="n">init_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-3658"><a href="#L-3658"><span class="linenos">3658</span></a>        <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-3659"><a href="#L-3659"><span class="linenos">3659</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="L-3660"><a href="#L-3660"><span class="linenos">3660</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="L-3661"><a href="#L-3661"><span class="linenos">3661</span></a>        
</span><span id="L-3662"><a href="#L-3662"><span class="linenos">3662</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="L-3663"><a href="#L-3663"><span class="linenos">3663</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="L-3664"><a href="#L-3664"><span class="linenos">3664</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="L-3665"><a href="#L-3665"><span class="linenos">3665</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">max_intensity_sum</span>
</span><span id="L-3666"><a href="#L-3666"><span class="linenos">3666</span></a>        
</span><span id="L-3667"><a href="#L-3667"><span class="linenos">3667</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="L-3668"><a href="#L-3668"><span class="linenos">3668</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-3669"><a href="#L-3669"><span class="linenos">3669</span></a>        
</span><span id="L-3670"><a href="#L-3670"><span class="linenos">3670</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="L-3671"><a href="#L-3671"><span class="linenos">3671</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="L-3672"><a href="#L-3672"><span class="linenos">3672</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="L-3673"><a href="#L-3673"><span class="linenos">3673</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3674"><a href="#L-3674"><span class="linenos">3674</span></a>         
</span><span id="L-3675"><a href="#L-3675"><span class="linenos">3675</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="L-3676"><a href="#L-3676"><span class="linenos">3676</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="L-3677"><a href="#L-3677"><span class="linenos">3677</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="L-3678"><a href="#L-3678"><span class="linenos">3678</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="L-3679"><a href="#L-3679"><span class="linenos">3679</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-3680"><a href="#L-3680"><span class="linenos">3680</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="L-3681"><a href="#L-3681"><span class="linenos">3681</span></a>        
</span><span id="L-3682"><a href="#L-3682"><span class="linenos">3682</span></a>        <span class="c1"># Live plot initialization </span>
</span><span id="L-3683"><a href="#L-3683"><span class="linenos">3683</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="L-3684"><a href="#L-3684"><span class="linenos">3684</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="L-3685"><a href="#L-3685"><span class="linenos">3685</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-3686"><a href="#L-3686"><span class="linenos">3686</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</span><span id="L-3687"><a href="#L-3687"><span class="linenos">3687</span></a>            <span class="n">circ_artist</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="n">best_center</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">,</span> 
</span><span id="L-3688"><a href="#L-3688"><span class="linenos">3688</span></a>                                 <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="L-3689"><a href="#L-3689"><span class="linenos">3689</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ_artist</span><span class="p">)</span>
</span><span id="L-3690"><a href="#L-3690"><span class="linenos">3690</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Refinement Progress&quot;</span><span class="p">)</span>
</span><span id="L-3691"><a href="#L-3691"><span class="linenos">3691</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-3692"><a href="#L-3692"><span class="linenos">3692</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-3693"><a href="#L-3693"><span class="linenos">3693</span></a>    
</span><span id="L-3694"><a href="#L-3694"><span class="linenos">3694</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="L-3695"><a href="#L-3695"><span class="linenos">3695</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="L-3696"><a href="#L-3696"><span class="linenos">3696</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-3697"><a href="#L-3697"><span class="linenos">3697</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-3698"><a href="#L-3698"><span class="linenos">3698</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-3699"><a href="#L-3699"><span class="linenos">3699</span></a>                                      <span class="n">best_radius</span><span class="p">)</span>
</span><span id="L-3700"><a href="#L-3700"><span class="linenos">3700</span></a>            
</span><span id="L-3701"><a href="#L-3701"><span class="linenos">3701</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="L-3702"><a href="#L-3702"><span class="linenos">3702</span></a>            <span class="n">curr_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3703"><a href="#L-3703"><span class="linenos">3703</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="L-3704"><a href="#L-3704"><span class="linenos">3704</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="L-3705"><a href="#L-3705"><span class="linenos">3705</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="L-3706"><a href="#L-3706"><span class="linenos">3706</span></a>                <span class="n">curr_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-3707"><a href="#L-3707"><span class="linenos">3707</span></a>                                                        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> 
</span><span id="L-3708"><a href="#L-3708"><span class="linenos">3708</span></a>                                                        <span class="n">best_radius</span><span class="p">))</span>
</span><span id="L-3709"><a href="#L-3709"><span class="linenos">3709</span></a>            
</span><span id="L-3710"><a href="#L-3710"><span class="linenos">3710</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="L-3711"><a href="#L-3711"><span class="linenos">3711</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span>
</span><span id="L-3712"><a href="#L-3712"><span class="linenos">3712</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-3713"><a href="#L-3713"><span class="linenos">3713</span></a>                    
</span><span id="L-3714"><a href="#L-3714"><span class="linenos">3714</span></a>            <span class="c1"># Check for improvement of criterion - in each iteration just once,</span>
</span><span id="L-3715"><a href="#L-3715"><span class="linenos">3715</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center</span>
</span><span id="L-3716"><a href="#L-3716"><span class="linenos">3716</span></a>            <span class="c1"># (in each iteration, the center is updated if possible)</span>
</span><span id="L-3717"><a href="#L-3717"><span class="linenos">3717</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>                           
</span><span id="L-3718"><a href="#L-3718"><span class="linenos">3718</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span>
</span><span id="L-3719"><a href="#L-3719"><span class="linenos">3719</span></a>                
</span><span id="L-3720"><a href="#L-3720"><span class="linenos">3720</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="L-3721"><a href="#L-3721"><span class="linenos">3721</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="L-3722"><a href="#L-3722"><span class="linenos">3722</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="L-3723"><a href="#L-3723"><span class="linenos">3723</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="L-3724"><a href="#L-3724"><span class="linenos">3724</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="L-3725"><a href="#L-3725"><span class="linenos">3725</span></a>    
</span><span id="L-3726"><a href="#L-3726"><span class="linenos">3726</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="L-3727"><a href="#L-3727"><span class="linenos">3727</span></a>            <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-3728"><a href="#L-3728"><span class="linenos">3728</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-3729"><a href="#L-3729"><span class="linenos">3729</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-3730"><a href="#L-3730"><span class="linenos">3730</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span>
</span><span id="L-3731"><a href="#L-3731"><span class="linenos">3731</span></a>    
</span><span id="L-3732"><a href="#L-3732"><span class="linenos">3732</span></a>        
</span><span id="L-3733"><a href="#L-3733"><span class="linenos">3733</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="L-3734"><a href="#L-3734"><span class="linenos">3734</span></a>            <span class="c1"># constant. It iterates through different radius adjustments</span>
</span><span id="L-3735"><a href="#L-3735"><span class="linenos">3735</span></a>            <span class="c1"># to find a radius that maximizes the intensity sum of pixels.</span>
</span><span id="L-3736"><a href="#L-3736"><span class="linenos">3736</span></a>            
</span><span id="L-3737"><a href="#L-3737"><span class="linenos">3737</span></a>            <span class="n">radi_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3738"><a href="#L-3738"><span class="linenos">3738</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-3739"><a href="#L-3739"><span class="linenos">3739</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="L-3740"><a href="#L-3740"><span class="linenos">3740</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="L-3741"><a href="#L-3741"><span class="linenos">3741</span></a>                <span class="n">radi_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-3742"><a href="#L-3742"><span class="linenos">3742</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-3743"><a href="#L-3743"><span class="linenos">3743</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-3744"><a href="#L-3744"><span class="linenos">3744</span></a>                                                            <span class="n">new_radius</span><span class="p">))</span>
</span><span id="L-3745"><a href="#L-3745"><span class="linenos">3745</span></a>                
</span><span id="L-3746"><a href="#L-3746"><span class="linenos">3746</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="L-3747"><a href="#L-3747"><span class="linenos">3747</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span>
</span><span id="L-3748"><a href="#L-3748"><span class="linenos">3748</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-3749"><a href="#L-3749"><span class="linenos">3749</span></a>    
</span><span id="L-3750"><a href="#L-3750"><span class="linenos">3750</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="L-3751"><a href="#L-3751"><span class="linenos">3751</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>
</span><span id="L-3752"><a href="#L-3752"><span class="linenos">3752</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span>
</span><span id="L-3753"><a href="#L-3753"><span class="linenos">3753</span></a>                
</span><span id="L-3754"><a href="#L-3754"><span class="linenos">3754</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="L-3755"><a href="#L-3755"><span class="linenos">3755</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="L-3756"><a href="#L-3756"><span class="linenos">3756</span></a>                
</span><span id="L-3757"><a href="#L-3757"><span class="linenos">3757</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="L-3758"><a href="#L-3758"><span class="linenos">3758</span></a>                
</span><span id="L-3759"><a href="#L-3759"><span class="linenos">3759</span></a>            
</span><span id="L-3760"><a href="#L-3760"><span class="linenos">3760</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="L-3761"><a href="#L-3761"><span class="linenos">3761</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_intensity_sum</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="L-3762"><a href="#L-3762"><span class="linenos">3762</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="L-3763"><a href="#L-3763"><span class="linenos">3763</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-3764"><a href="#L-3764"><span class="linenos">3764</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
</span><span id="L-3765"><a href="#L-3765"><span class="linenos">3765</span></a>                    <span class="k">break</span>
</span><span id="L-3766"><a href="#L-3766"><span class="linenos">3766</span></a>                
</span><span id="L-3767"><a href="#L-3767"><span class="linenos">3767</span></a>            <span class="c1"># --- Live plot update ---</span>
</span><span id="L-3768"><a href="#L-3768"><span class="linenos">3768</span></a>            <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="L-3769"><a href="#L-3769"><span class="linenos">3769</span></a>                <span class="n">circ_artist</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">best_center</span>
</span><span id="L-3770"><a href="#L-3770"><span class="linenos">3770</span></a>                <span class="n">circ_artist</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">best_radius</span><span class="p">)</span>
</span><span id="L-3771"><a href="#L-3771"><span class="linenos">3771</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="L-3772"><a href="#L-3772"><span class="linenos">3772</span></a>                    <span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> | Sum=</span><span class="si">{</span><span class="n">max_intensity_sum</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3773"><a href="#L-3773"><span class="linenos">3773</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-3774"><a href="#L-3774"><span class="linenos">3774</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
</span><span id="L-3775"><a href="#L-3775"><span class="linenos">3775</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># small delay for visual update</span>
</span><span id="L-3776"><a href="#L-3776"><span class="linenos">3776</span></a>        
</span><span id="L-3777"><a href="#L-3777"><span class="linenos">3777</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="L-3778"><a href="#L-3778"><span class="linenos">3778</span></a>        <span class="c1"># ## (1) swapped coordinates</span>
</span><span id="L-3779"><a href="#L-3779"><span class="linenos">3779</span></a>        <span class="c1"># if ((bckup[0] &gt; bckup[1] and not best_center[0] &gt; best_center[1])</span>
</span><span id="L-3780"><a href="#L-3780"><span class="linenos">3780</span></a>        <span class="c1">#     or  (bckup[0] &lt; bckup[1]</span>
</span><span id="L-3781"><a href="#L-3781"><span class="linenos">3781</span></a>        <span class="c1">#     and not best_center[0] &lt; best_center[1])):</span>
</span><span id="L-3782"><a href="#L-3782"><span class="linenos">3782</span></a>        <span class="c1">#     best_center = best_center[::-1]</span>
</span><span id="L-3783"><a href="#L-3783"><span class="linenos">3783</span></a>        
</span><span id="L-3784"><a href="#L-3784"><span class="linenos">3784</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="L-3785"><a href="#L-3785"><span class="linenos">3785</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">max_intensity_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-3786"><a href="#L-3786"><span class="linenos">3786</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="L-3787"><a href="#L-3787"><span class="linenos">3787</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="L-3788"><a href="#L-3788"><span class="linenos">3788</span></a>    
</span><span id="L-3789"><a href="#L-3789"><span class="linenos">3789</span></a>        <span class="c1"># Print results</span>
</span><span id="L-3790"><a href="#L-3790"><span class="linenos">3790</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-3791"><a href="#L-3791"><span class="linenos">3791</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="L-3792"><a href="#L-3792"><span class="linenos">3792</span></a>                <span class="s2">&quot;Center Refinement (IntensitySum)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-3793"><a href="#L-3793"><span class="linenos">3793</span></a>        
</span><span id="L-3794"><a href="#L-3794"><span class="linenos">3794</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="L-3795"><a href="#L-3795"><span class="linenos">3795</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="L-3796"><a href="#L-3796"><span class="linenos">3796</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-3797"><a href="#L-3797"><span class="linenos">3797</span></a>
</span><span id="L-3798"><a href="#L-3798"><span class="linenos">3798</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span><span id="L-3799"><a href="#L-3799"><span class="linenos">3799</span></a>    
</span><span id="L-3800"><a href="#L-3800"><span class="linenos">3800</span></a>    
</span><span id="L-3801"><a href="#L-3801"><span class="linenos">3801</span></a>    <span class="k">def</span> <span class="nf">diagnose_landscape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">search_range</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">21</span><span class="p">):</span>
</span><span id="L-3802"><a href="#L-3802"><span class="linenos">3802</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3803"><a href="#L-3803"><span class="linenos">3803</span></a><span class="sd">        Visualize the optimization landscape of a center refinement metric</span>
</span><span id="L-3804"><a href="#L-3804"><span class="linenos">3804</span></a><span class="sd">        around a candidate center location and radius.</span>
</span><span id="L-3805"><a href="#L-3805"><span class="linenos">3805</span></a><span class="sd">    </span>
</span><span id="L-3806"><a href="#L-3806"><span class="linenos">3806</span></a><span class="sd">        This function evaluates the selected metric over a grid of positions</span>
</span><span id="L-3807"><a href="#L-3807"><span class="linenos">3807</span></a><span class="sd">        in a 2D neighborhood around the given (px, py) center, using a fixed</span>
</span><span id="L-3808"><a href="#L-3808"><span class="linenos">3808</span></a><span class="sd">        radius `pr`, and visualizes the results as a heatmap with contours.</span>
</span><span id="L-3809"><a href="#L-3809"><span class="linenos">3809</span></a><span class="sd">    </span>
</span><span id="L-3810"><a href="#L-3810"><span class="linenos">3810</span></a><span class="sd">        It can be useful for diagnosing whether the optimization function</span>
</span><span id="L-3811"><a href="#L-3811"><span class="linenos">3811</span></a><span class="sd">        (e.g., standard deviation, median, or sum of pixel intensities) has</span>
</span><span id="L-3812"><a href="#L-3812"><span class="linenos">3812</span></a><span class="sd">        a smooth and well-behaved landscape, which is important for gradient</span>
</span><span id="L-3813"><a href="#L-3813"><span class="linenos">3813</span></a><span class="sd">        optimization methods.</span>
</span><span id="L-3814"><a href="#L-3814"><span class="linenos">3814</span></a><span class="sd">    </span>
</span><span id="L-3815"><a href="#L-3815"><span class="linenos">3815</span></a><span class="sd">        Parameters</span>
</span><span id="L-3816"><a href="#L-3816"><span class="linenos">3816</span></a><span class="sd">        ----------</span>
</span><span id="L-3817"><a href="#L-3817"><span class="linenos">3817</span></a><span class="sd">        px : float</span>
</span><span id="L-3818"><a href="#L-3818"><span class="linenos">3818</span></a><span class="sd">            X-coordinate of the candidate center.</span>
</span><span id="L-3819"><a href="#L-3819"><span class="linenos">3819</span></a><span class="sd">            </span>
</span><span id="L-3820"><a href="#L-3820"><span class="linenos">3820</span></a><span class="sd">        py : float</span>
</span><span id="L-3821"><a href="#L-3821"><span class="linenos">3821</span></a><span class="sd">            Y-coordinate of the candidate center.</span>
</span><span id="L-3822"><a href="#L-3822"><span class="linenos">3822</span></a><span class="sd">            </span>
</span><span id="L-3823"><a href="#L-3823"><span class="linenos">3823</span></a><span class="sd">        pr : float</span>
</span><span id="L-3824"><a href="#L-3824"><span class="linenos">3824</span></a><span class="sd">            Radius of the circular region to evaluate the metric on.</span>
</span><span id="L-3825"><a href="#L-3825"><span class="linenos">3825</span></a><span class="sd">            </span>
</span><span id="L-3826"><a href="#L-3826"><span class="linenos">3826</span></a><span class="sd">        metric : str, optional</span>
</span><span id="L-3827"><a href="#L-3827"><span class="linenos">3827</span></a><span class="sd">            The metric to evaluate. Options are:</span>
</span><span id="L-3828"><a href="#L-3828"><span class="linenos">3828</span></a><span class="sd">            - &#39;std&#39;: standard deviation of pixel values (default)</span>
</span><span id="L-3829"><a href="#L-3829"><span class="linenos">3829</span></a><span class="sd">            - &#39;median&#39;: median of pixel values</span>
</span><span id="L-3830"><a href="#L-3830"><span class="linenos">3830</span></a><span class="sd">            - &#39;sum&#39;: sum of pixel values</span>
</span><span id="L-3831"><a href="#L-3831"><span class="linenos">3831</span></a><span class="sd">            </span>
</span><span id="L-3832"><a href="#L-3832"><span class="linenos">3832</span></a><span class="sd">        search_range : float, optional, default=2.0</span>
</span><span id="L-3833"><a href="#L-3833"><span class="linenos">3833</span></a><span class="sd">            The radius of the square region (in pixels) around the center </span>
</span><span id="L-3834"><a href="#L-3834"><span class="linenos">3834</span></a><span class="sd">            to explore. The grid will extend ±`search_range` in both x and y </span>
</span><span id="L-3835"><a href="#L-3835"><span class="linenos">3835</span></a><span class="sd">            directions.</span>
</span><span id="L-3836"><a href="#L-3836"><span class="linenos">3836</span></a><span class="sd">            </span>
</span><span id="L-3837"><a href="#L-3837"><span class="linenos">3837</span></a><span class="sd">        steps : int, optional, default=21</span>
</span><span id="L-3838"><a href="#L-3838"><span class="linenos">3838</span></a><span class="sd">            The number of points to sample along each axis (grid resolution).</span>
</span><span id="L-3839"><a href="#L-3839"><span class="linenos">3839</span></a><span class="sd">            Must be an odd number to ensure the center point is included.</span>
</span><span id="L-3840"><a href="#L-3840"><span class="linenos">3840</span></a><span class="sd">    </span>
</span><span id="L-3841"><a href="#L-3841"><span class="linenos">3841</span></a><span class="sd">        Returns</span>
</span><span id="L-3842"><a href="#L-3842"><span class="linenos">3842</span></a><span class="sd">        -------</span>
</span><span id="L-3843"><a href="#L-3843"><span class="linenos">3843</span></a><span class="sd">        None</span>
</span><span id="L-3844"><a href="#L-3844"><span class="linenos">3844</span></a><span class="sd">            This method produces a matplotlib plot and does not return any value.</span>
</span><span id="L-3845"><a href="#L-3845"><span class="linenos">3845</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3846"><a href="#L-3846"><span class="linenos">3846</span></a>        <span class="c1"># Helper functions ----------------------------------------------------</span>
</span><span id="L-3847"><a href="#L-3847"><span class="linenos">3847</span></a>        <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="L-3848"><a href="#L-3848"><span class="linenos">3848</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-3849"><a href="#L-3849"><span class="linenos">3849</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="L-3850"><a href="#L-3850"><span class="linenos">3850</span></a>        
</span><span id="L-3851"><a href="#L-3851"><span class="linenos">3851</span></a>        <span class="k">def</span> <span class="nf">intensity_std</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="L-3852"><a href="#L-3852"><span class="linenos">3852</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-3853"><a href="#L-3853"><span class="linenos">3853</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="L-3854"><a href="#L-3854"><span class="linenos">3854</span></a>        
</span><span id="L-3855"><a href="#L-3855"><span class="linenos">3855</span></a>        <span class="k">def</span> <span class="nf">intensity_median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="L-3856"><a href="#L-3856"><span class="linenos">3856</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-3857"><a href="#L-3857"><span class="linenos">3857</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="L-3858"><a href="#L-3858"><span class="linenos">3858</span></a>
</span><span id="L-3859"><a href="#L-3859"><span class="linenos">3859</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diagnosing landscape around (</span><span class="si">{</span><span class="n">px</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">py</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) with r=</span><span class="si">{</span><span class="n">pr</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="L-3860"><a href="#L-3860"><span class="linenos">3860</span></a>        
</span><span id="L-3861"><a href="#L-3861"><span class="linenos">3861</span></a>        <span class="c1"># (0) Select the metric function --------------------------------------</span>
</span><span id="L-3862"><a href="#L-3862"><span class="linenos">3862</span></a>        <span class="n">metric_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">intensity_std</span><span class="p">,</span> 
</span><span id="L-3863"><a href="#L-3863"><span class="linenos">3863</span></a>                      <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">intensity_median</span><span class="p">,</span> 
</span><span id="L-3864"><a href="#L-3864"><span class="linenos">3864</span></a>                      <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="n">intensity_sum</span> <span class="p">}</span>
</span><span id="L-3865"><a href="#L-3865"><span class="linenos">3865</span></a>        <span class="n">metric_func</span> <span class="o">=</span> <span class="n">metric_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">intensity_std</span><span class="p">)</span>
</span><span id="L-3866"><a href="#L-3866"><span class="linenos">3866</span></a>    
</span><span id="L-3867"><a href="#L-3867"><span class="linenos">3867</span></a>        <span class="c1"># (1) Create a grid of x and y coordinates to test --------------------</span>
</span><span id="L-3868"><a href="#L-3868"><span class="linenos">3868</span></a>        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">px</span> <span class="o">-</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="L-3869"><a href="#L-3869"><span class="linenos">3869</span></a>        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">py</span> <span class="o">-</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="L-3870"><a href="#L-3870"><span class="linenos">3870</span></a>        <span class="n">score_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="n">steps</span><span class="p">))</span>
</span><span id="L-3871"><a href="#L-3871"><span class="linenos">3871</span></a>    
</span><span id="L-3872"><a href="#L-3872"><span class="linenos">3872</span></a>        <span class="c1"># (2) Calculate the metric score at each point on the grid ------------</span>
</span><span id="L-3873"><a href="#L-3873"><span class="linenos">3873</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_range</span><span class="p">):</span>
</span><span id="L-3874"><a href="#L-3874"><span class="linenos">3874</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_range</span><span class="p">):</span>
</span><span id="L-3875"><a href="#L-3875"><span class="linenos">3875</span></a>                <span class="n">score_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-3876"><a href="#L-3876"><span class="linenos">3876</span></a>    
</span><span id="L-3877"><a href="#L-3877"><span class="linenos">3877</span></a>        <span class="c1"># (3) Plot the results ------------------------------------------------</span>
</span><span id="L-3878"><a href="#L-3878"><span class="linenos">3878</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="L-3879"><a href="#L-3879"><span class="linenos">3879</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="L-3880"><a href="#L-3880"><span class="linenos">3880</span></a>            <span class="n">score_grid</span><span class="p">,</span> 
</span><span id="L-3881"><a href="#L-3881"><span class="linenos">3881</span></a>            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> 
</span><span id="L-3882"><a href="#L-3882"><span class="linenos">3882</span></a>            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-3883"><a href="#L-3883"><span class="linenos">3883</span></a>            <span class="p">)</span>
</span><span id="L-3884"><a href="#L-3884"><span class="linenos">3884</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Metric Score (&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
</span><span id="L-3885"><a href="#L-3885"><span class="linenos">3885</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">score_grid</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="L-3886"><a href="#L-3886"><span class="linenos">3886</span></a>        
</span><span id="L-3887"><a href="#L-3887"><span class="linenos">3887</span></a>        <span class="c1"># Mark the starting point</span>
</span><span id="L-3888"><a href="#L-3888"><span class="linenos">3888</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Guess&#39;</span><span class="p">)</span>
</span><span id="L-3889"><a href="#L-3889"><span class="linenos">3889</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Optimization Landscape&quot;</span><span class="p">)</span>
</span><span id="L-3890"><a href="#L-3890"><span class="linenos">3890</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X-coordinate&quot;</span><span class="p">)</span>
</span><span id="L-3891"><a href="#L-3891"><span class="linenos">3891</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y-coordinate&quot;</span><span class="p">)</span>
</span><span id="L-3892"><a href="#L-3892"><span class="linenos">3892</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-3893"><a href="#L-3893"><span class="linenos">3893</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-3894"><a href="#L-3894"><span class="linenos">3894</span></a>        
</span><span id="L-3895"><a href="#L-3895"><span class="linenos">3895</span></a>
</span><span id="L-3896"><a href="#L-3896"><span class="linenos">3896</span></a><span class="k">class</span> <span class="nc">HandlerCircle</span><span class="p">(</span><span class="n">HandlerBase</span><span class="p">):</span>
</span><span id="L-3897"><a href="#L-3897"><span class="linenos">3897</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3898"><a href="#L-3898"><span class="linenos">3898</span></a><span class="sd">    Helper class for creating circular markers in matplotlib legends.</span>
</span><span id="L-3899"><a href="#L-3899"><span class="linenos">3899</span></a>
</span><span id="L-3900"><a href="#L-3900"><span class="linenos">3900</span></a><span class="sd">    This class customizes the legend to display circular markers instead of the </span>
</span><span id="L-3901"><a href="#L-3901"><span class="linenos">3901</span></a><span class="sd">    default. It is intended for internal use within the module and not </span>
</span><span id="L-3902"><a href="#L-3902"><span class="linenos">3902</span></a><span class="sd">    for general use.</span>
</span><span id="L-3903"><a href="#L-3903"><span class="linenos">3903</span></a>
</span><span id="L-3904"><a href="#L-3904"><span class="linenos">3904</span></a><span class="sd">    Methods:</span>
</span><span id="L-3905"><a href="#L-3905"><span class="linenos">3905</span></a><span class="sd">    --------</span>
</span><span id="L-3906"><a href="#L-3906"><span class="linenos">3906</span></a><span class="sd">    create_artists(legend, </span>
</span><span id="L-3907"><a href="#L-3907"><span class="linenos">3907</span></a><span class="sd">                   orig_handle, </span>
</span><span id="L-3908"><a href="#L-3908"><span class="linenos">3908</span></a><span class="sd">                   xdescent,</span>
</span><span id="L-3909"><a href="#L-3909"><span class="linenos">3909</span></a><span class="sd">                   ydescent, </span>
</span><span id="L-3910"><a href="#L-3910"><span class="linenos">3910</span></a><span class="sd">                   width, </span>
</span><span id="L-3911"><a href="#L-3911"><span class="linenos">3911</span></a><span class="sd">                   height, </span>
</span><span id="L-3912"><a href="#L-3912"><span class="linenos">3912</span></a><span class="sd">                   fontsize, </span>
</span><span id="L-3913"><a href="#L-3913"><span class="linenos">3913</span></a><span class="sd">                   trans):</span>
</span><span id="L-3914"><a href="#L-3914"><span class="linenos">3914</span></a><span class="sd">        Creates a circular marker for the legend based on the original handle&#39;s </span>
</span><span id="L-3915"><a href="#L-3915"><span class="linenos">3915</span></a><span class="sd">        properties.</span>
</span><span id="L-3916"><a href="#L-3916"><span class="linenos">3916</span></a>
</span><span id="L-3917"><a href="#L-3917"><span class="linenos">3917</span></a><span class="sd">    Parameters for `create_artists`:</span>
</span><span id="L-3918"><a href="#L-3918"><span class="linenos">3918</span></a><span class="sd">        legend : matplotlib.legend.Legend</span>
</span><span id="L-3919"><a href="#L-3919"><span class="linenos">3919</span></a><span class="sd">            The legend instance where the custom marker will be used.</span>
</span><span id="L-3920"><a href="#L-3920"><span class="linenos">3920</span></a><span class="sd">        orig_handle : matplotlib.artist.Artist</span>
</span><span id="L-3921"><a href="#L-3921"><span class="linenos">3921</span></a><span class="sd">            The original handle containing the marker properties </span>
</span><span id="L-3922"><a href="#L-3922"><span class="linenos">3922</span></a><span class="sd">            (e.g., facecolor, edgecolor).</span>
</span><span id="L-3923"><a href="#L-3923"><span class="linenos">3923</span></a><span class="sd">        xdescent : float</span>
</span><span id="L-3924"><a href="#L-3924"><span class="linenos">3924</span></a><span class="sd">            Horizontal offset adjustment for the marker.</span>
</span><span id="L-3925"><a href="#L-3925"><span class="linenos">3925</span></a><span class="sd">        ydescent : float</span>
</span><span id="L-3926"><a href="#L-3926"><span class="linenos">3926</span></a><span class="sd">            Vertical offset adjustment for the marker.</span>
</span><span id="L-3927"><a href="#L-3927"><span class="linenos">3927</span></a><span class="sd">        width : float</span>
</span><span id="L-3928"><a href="#L-3928"><span class="linenos">3928</span></a><span class="sd">            Width of the legend entry.</span>
</span><span id="L-3929"><a href="#L-3929"><span class="linenos">3929</span></a><span class="sd">        height : float</span>
</span><span id="L-3930"><a href="#L-3930"><span class="linenos">3930</span></a><span class="sd">            Height of the legend entry.</span>
</span><span id="L-3931"><a href="#L-3931"><span class="linenos">3931</span></a><span class="sd">        fontsize : float</span>
</span><span id="L-3932"><a href="#L-3932"><span class="linenos">3932</span></a><span class="sd">            Font size of the legend text.</span>
</span><span id="L-3933"><a href="#L-3933"><span class="linenos">3933</span></a><span class="sd">        trans : matplotlib.transforms.Transform</span>
</span><span id="L-3934"><a href="#L-3934"><span class="linenos">3934</span></a><span class="sd">            Transformation applied to the marker&#39;s coordinates.</span>
</span><span id="L-3935"><a href="#L-3935"><span class="linenos">3935</span></a>
</span><span id="L-3936"><a href="#L-3936"><span class="linenos">3936</span></a><span class="sd">    Returns:</span>
</span><span id="L-3937"><a href="#L-3937"><span class="linenos">3937</span></a><span class="sd">    --------</span>
</span><span id="L-3938"><a href="#L-3938"><span class="linenos">3938</span></a><span class="sd">    list of matplotlib.patches.Circle</span>
</span><span id="L-3939"><a href="#L-3939"><span class="linenos">3939</span></a><span class="sd">        A list containing a single circular marker artist.</span>
</span><span id="L-3940"><a href="#L-3940"><span class="linenos">3940</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3941"><a href="#L-3941"><span class="linenos">3941</span></a>
</span><span id="L-3942"><a href="#L-3942"><span class="linenos">3942</span></a>    <span class="k">def</span> <span class="nf">create_artists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">,</span> <span class="n">xdescent</span><span class="p">,</span> <span class="n">ydescent</span><span class="p">,</span> 
</span><span id="L-3943"><a href="#L-3943"><span class="linenos">3943</span></a>                       <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
</span><span id="L-3944"><a href="#L-3944"><span class="linenos">3944</span></a>        <span class="c1"># Calculate the center and radius of the circle</span>
</span><span id="L-3945"><a href="#L-3945"><span class="linenos">3945</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-3946"><a href="#L-3946"><span class="linenos">3946</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-3947"><a href="#L-3947"><span class="linenos">3947</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-3948"><a href="#L-3948"><span class="linenos">3948</span></a>
</span><span id="L-3949"><a href="#L-3949"><span class="linenos">3949</span></a>        <span class="c1"># Create a circular marker using the properties of the original handle</span>
</span><span id="L-3950"><a href="#L-3950"><span class="linenos">3950</span></a>        <span class="n">marker</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span>
</span><span id="L-3951"><a href="#L-3951"><span class="linenos">3951</span></a>                        <span class="n">facecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">(),</span>
</span><span id="L-3952"><a href="#L-3952"><span class="linenos">3952</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">(),</span>
</span><span id="L-3953"><a href="#L-3953"><span class="linenos">3953</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">(),</span>
</span><span id="L-3954"><a href="#L-3954"><span class="linenos">3954</span></a>                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
</span><span id="L-3955"><a href="#L-3955"><span class="linenos">3955</span></a>
</span><span id="L-3956"><a href="#L-3956"><span class="linenos">3956</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">marker</span><span class="p">]</span>
</span><span id="L-3957"><a href="#L-3957"><span class="linenos">3957</span></a>
</span><span id="L-3958"><a href="#L-3958"><span class="linenos">3958</span></a>
</span><span id="L-3959"><a href="#L-3959"><span class="linenos">3959</span></a><span class="k">class</span> <span class="nc">PocketFFTBackend</span><span class="p">:</span>
</span><span id="L-3960"><a href="#L-3960"><span class="linenos">3960</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3961"><a href="#L-3961"><span class="linenos">3961</span></a><span class="sd">    High-performance FFT backend leveraging SciPy&#39;s PocketFFT with optimized </span>
</span><span id="L-3962"><a href="#L-3962"><span class="linenos">3962</span></a><span class="sd">    defaults. This backend enhances the efficiency of Fast Fourier Transforms </span>
</span><span id="L-3963"><a href="#L-3963"><span class="linenos">3963</span></a><span class="sd">    (FFT), particularly for 2D transforms, which may experience up to a 50% </span>
</span><span id="L-3964"><a href="#L-3964"><span class="linenos">3964</span></a><span class="sd">    speed improvement over standard configurations.</span>
</span><span id="L-3965"><a href="#L-3965"><span class="linenos">3965</span></a>
</span><span id="L-3966"><a href="#L-3966"><span class="linenos">3966</span></a><span class="sd">    Attributes</span>
</span><span id="L-3967"><a href="#L-3967"><span class="linenos">3967</span></a><span class="sd">    ----------</span>
</span><span id="L-3968"><a href="#L-3968"><span class="linenos">3968</span></a><span class="sd">    __ua_domain__ : str</span>
</span><span id="L-3969"><a href="#L-3969"><span class="linenos">3969</span></a><span class="sd">        Universal array domain identifier for NumPy&#39;s SciPy-based FFT interface.</span>
</span><span id="L-3970"><a href="#L-3970"><span class="linenos">3970</span></a>
</span><span id="L-3971"><a href="#L-3971"><span class="linenos">3971</span></a><span class="sd">    Methods</span>
</span><span id="L-3972"><a href="#L-3972"><span class="linenos">3972</span></a><span class="sd">    -------</span>
</span><span id="L-3973"><a href="#L-3973"><span class="linenos">3973</span></a><span class="sd">    __ua_function__(method, args, kwargs)</span>
</span><span id="L-3974"><a href="#L-3974"><span class="linenos">3974</span></a><span class="sd">        Universal array function handler that dispatches FFT operations to the </span>
</span><span id="L-3975"><a href="#L-3975"><span class="linenos">3975</span></a><span class="sd">        corresponding PocketFFT implementation with optimized threading</span>
</span><span id="L-3976"><a href="#L-3976"><span class="linenos">3976</span></a><span class="sd">        settings.</span>
</span><span id="L-3977"><a href="#L-3977"><span class="linenos">3977</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3978"><a href="#L-3978"><span class="linenos">3978</span></a>
</span><span id="L-3979"><a href="#L-3979"><span class="linenos">3979</span></a>    <span class="n">__ua_domain__</span> <span class="o">=</span> <span class="s2">&quot;numpy.scipy.fft&quot;</span>
</span><span id="L-3980"><a href="#L-3980"><span class="linenos">3980</span></a>
</span><span id="L-3981"><a href="#L-3981"><span class="linenos">3981</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-3982"><a href="#L-3982"><span class="linenos">3982</span></a>    <span class="k">def</span> <span class="nf">__ua_function__</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-3983"><a href="#L-3983"><span class="linenos">3983</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3984"><a href="#L-3984"><span class="linenos">3984</span></a><span class="sd">        Dispatches FFT operations to SciPy&#39;s PocketFFT with optimized worker </span>
</span><span id="L-3985"><a href="#L-3985"><span class="linenos">3985</span></a><span class="sd">        settings. This method dynamically selects the appropriate PocketFFT </span>
</span><span id="L-3986"><a href="#L-3986"><span class="linenos">3986</span></a><span class="sd">        function and applies threading optimizations by adjusting the number </span>
</span><span id="L-3987"><a href="#L-3987"><span class="linenos">3987</span></a><span class="sd">        of workers.</span>
</span><span id="L-3988"><a href="#L-3988"><span class="linenos">3988</span></a>
</span><span id="L-3989"><a href="#L-3989"><span class="linenos">3989</span></a><span class="sd">        Parameters</span>
</span><span id="L-3990"><a href="#L-3990"><span class="linenos">3990</span></a><span class="sd">        ----------</span>
</span><span id="L-3991"><a href="#L-3991"><span class="linenos">3991</span></a><span class="sd">        method : callable</span>
</span><span id="L-3992"><a href="#L-3992"><span class="linenos">3992</span></a><span class="sd">            The FFT function being dispatched.</span>
</span><span id="L-3993"><a href="#L-3993"><span class="linenos">3993</span></a><span class="sd">        args : tuple</span>
</span><span id="L-3994"><a href="#L-3994"><span class="linenos">3994</span></a><span class="sd">            Positional arguments passed to the FFT function.</span>
</span><span id="L-3995"><a href="#L-3995"><span class="linenos">3995</span></a><span class="sd">        kwargs : dict</span>
</span><span id="L-3996"><a href="#L-3996"><span class="linenos">3996</span></a><span class="sd">            Keyword arguments passed to the FFT function, including</span>
</span><span id="L-3997"><a href="#L-3997"><span class="linenos">3997</span></a><span class="sd">            the optional &quot;workers&quot; parameter for parallel execution.</span>
</span><span id="L-3998"><a href="#L-3998"><span class="linenos">3998</span></a>
</span><span id="L-3999"><a href="#L-3999"><span class="linenos">3999</span></a><span class="sd">        Returns</span>
</span><span id="L-4000"><a href="#L-4000"><span class="linenos">4000</span></a><span class="sd">        -------</span>
</span><span id="L-4001"><a href="#L-4001"><span class="linenos">4001</span></a><span class="sd">        result : object</span>
</span><span id="L-4002"><a href="#L-4002"><span class="linenos">4002</span></a><span class="sd">            The output of the FFT function if supported; </span>
</span><span id="L-4003"><a href="#L-4003"><span class="linenos">4003</span></a><span class="sd">            otherwise, returns NotImplemented.</span>
</span><span id="L-4004"><a href="#L-4004"><span class="linenos">4004</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-4005"><a href="#L-4005"><span class="linenos">4005</span></a>        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_pocketfft</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-4006"><a href="#L-4006"><span class="linenos">4006</span></a>        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-4007"><a href="#L-4007"><span class="linenos">4007</span></a>            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="L-4008"><a href="#L-4008"><span class="linenos">4008</span></a>        
</span><span id="L-4009"><a href="#L-4009"><span class="linenos">4009</span></a>        <span class="n">workers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;workers&quot;</span><span class="p">,</span> <span class="n">CPU_COUNT</span><span class="p">)</span>
</span><span id="L-4010"><a href="#L-4010"><span class="linenos">4010</span></a>        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-4011"><a href="#L-4011"><span class="linenos">4011</span></a>
</span><span id="L-4012"><a href="#L-4012"><span class="linenos">4012</span></a>        
</span><span id="L-4013"><a href="#L-4013"><span class="linenos">4013</span></a><span class="k">class</span> <span class="nc">IntensityCenter</span><span class="p">:</span> 
</span><span id="L-4014"><a href="#L-4014"><span class="linenos">4014</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-4015"><a href="#L-4015"><span class="linenos">4015</span></a><span class="sd">    Simple center determination for a symmetric diffractogram.</span>
</span><span id="L-4016"><a href="#L-4016"><span class="linenos">4016</span></a><span class="sd">    </span>
</span><span id="L-4017"><a href="#L-4017"><span class="linenos">4017</span></a><span class="sd">    * The center is determined as a center of intensity.</span>
</span><span id="L-4018"><a href="#L-4018"><span class="linenos">4018</span></a><span class="sd">    * This works well for simple, symmetric diffraction patters, which are:</span>
</span><span id="L-4019"><a href="#L-4019"><span class="linenos">4019</span></a><span class="sd">      (i) without beamstopper, (ii) pre-centered, and (iii) powder-like.</span>
</span><span id="L-4020"><a href="#L-4020"><span class="linenos">4020</span></a><span class="sd">    * A real-life example of a simple symmetric diffractogram:</span>
</span><span id="L-4021"><a href="#L-4021"><span class="linenos">4021</span></a><span class="sd">      a good powder electron diffraction pattern from STEMDIFF software.</span>
</span><span id="L-4022"><a href="#L-4022"><span class="linenos">4022</span></a><span class="sd">    * This class is a legacy from previous EDIFF versions;</span>
</span><span id="L-4023"><a href="#L-4023"><span class="linenos">4023</span></a><span class="sd">      it is kept mostly for backward compatibility.</span>
</span><span id="L-4024"><a href="#L-4024"><span class="linenos">4024</span></a><span class="sd">      The functions in this class can be (and should be)</span>
</span><span id="L-4025"><a href="#L-4025"><span class="linenos">4025</span></a><span class="sd">      replaced by a simple call of ediff.center.CenterLocator object.</span>
</span><span id="L-4026"><a href="#L-4026"><span class="linenos">4026</span></a><span class="sd">      </span>
</span><span id="L-4027"><a href="#L-4027"><span class="linenos">4027</span></a><span class="sd">    &gt;&gt;&gt; # Center determination in a simple symmetric diffraction pattern</span>
</span><span id="L-4028"><a href="#L-4028"><span class="linenos">4028</span></a><span class="sd">    &gt;&gt;&gt; # (center = just center_of_intensity, no refinement</span>
</span><span id="L-4029"><a href="#L-4029"><span class="linenos">4029</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="L-4030"><a href="#L-4030"><span class="linenos">4030</span></a><span class="sd">    &gt;&gt;&gt; # (1) Old way = this (old, legacy) IntensityCenter class:</span>
</span><span id="L-4031"><a href="#L-4031"><span class="linenos">4031</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.IntensityCenter.center_of_intensity(</span>
</span><span id="L-4032"><a href="#L-4032"><span class="linenos">4032</span></a><span class="sd">    &gt;&gt;&gt;     arr, csquare=30, cintensity=0.8)</span>
</span><span id="L-4033"><a href="#L-4033"><span class="linenos">4033</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="L-4034"><a href="#L-4034"><span class="linenos">4034</span></a><span class="sd">    &gt;&gt;&gt; # (2) New way = newer (and more universal) CenterLocator class:</span>
</span><span id="L-4035"><a href="#L-4035"><span class="linenos">4035</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.CenterLocator(</span>
</span><span id="L-4036"><a href="#L-4036"><span class="linenos">4036</span></a><span class="sd">    &gt;&gt;&gt;     arr, detection_method=&#39;intensity&#39;, csquare=30, cintensity=0.8)</span>
</span><span id="L-4037"><a href="#L-4037"><span class="linenos">4037</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-4038"><a href="#L-4038"><span class="linenos">4038</span></a>    
</span><span id="L-4039"><a href="#L-4039"><span class="linenos">4039</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-4040"><a href="#L-4040"><span class="linenos">4040</span></a>    <span class="k">def</span> <span class="nf">center_of_intensity</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="L-4041"><a href="#L-4041"><span class="linenos">4041</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-4042"><a href="#L-4042"><span class="linenos">4042</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="L-4043"><a href="#L-4043"><span class="linenos">4043</span></a><span class="sd">        </span>
</span><span id="L-4044"><a href="#L-4044"><span class="linenos">4044</span></a><span class="sd">        Parameters</span>
</span><span id="L-4045"><a href="#L-4045"><span class="linenos">4045</span></a><span class="sd">        ----------</span>
</span><span id="L-4046"><a href="#L-4046"><span class="linenos">4046</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="L-4047"><a href="#L-4047"><span class="linenos">4047</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="L-4048"><a href="#L-4048"><span class="linenos">4048</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="L-4049"><a href="#L-4049"><span class="linenos">4049</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="L-4050"><a href="#L-4050"><span class="linenos">4050</span></a><span class="sd">            The intensity center is searched only within the central square.</span>
</span><span id="L-4051"><a href="#L-4051"><span class="linenos">4051</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="L-4052"><a href="#L-4052"><span class="linenos">4052</span></a><span class="sd">            to minimize the effect of an intensity assymetry around center. </span>
</span><span id="L-4053"><a href="#L-4053"><span class="linenos">4053</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="L-4054"><a href="#L-4054"><span class="linenos">4054</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="L-4055"><a href="#L-4055"><span class="linenos">4055</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="L-4056"><a href="#L-4056"><span class="linenos">4056</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="L-4057"><a href="#L-4057"><span class="linenos">4057</span></a><span class="sd">            </span>
</span><span id="L-4058"><a href="#L-4058"><span class="linenos">4058</span></a><span class="sd">        Returns</span>
</span><span id="L-4059"><a href="#L-4059"><span class="linenos">4059</span></a><span class="sd">        -------</span>
</span><span id="L-4060"><a href="#L-4060"><span class="linenos">4060</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="L-4061"><a href="#L-4061"><span class="linenos">4061</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="L-4062"><a href="#L-4062"><span class="linenos">4062</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.    </span>
</span><span id="L-4063"><a href="#L-4063"><span class="linenos">4063</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-4064"><a href="#L-4064"><span class="linenos">4064</span></a>        <span class="c1"># Get image/array size</span>
</span><span id="L-4065"><a href="#L-4065"><span class="linenos">4065</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-4066"><a href="#L-4066"><span class="linenos">4066</span></a>        <span class="c1"># Calculate borders around the central square</span>
</span><span id="L-4067"><a href="#L-4067"><span class="linenos">4067</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-4068"><a href="#L-4068"><span class="linenos">4068</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-4069"><a href="#L-4069"><span class="linenos">4069</span></a>        <span class="c1"># Create central square = cut off the borders</span>
</span><span id="L-4070"><a href="#L-4070"><span class="linenos">4070</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-4071"><a href="#L-4071"><span class="linenos">4071</span></a>        <span class="c1"># In the central square, set all values below cintenstity to zero</span>
</span><span id="L-4072"><a href="#L-4072"><span class="linenos">4072</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-4073"><a href="#L-4073"><span class="linenos">4073</span></a>        <span class="c1"># Calculate 1st central moments of the image</span>
</span><span id="L-4074"><a href="#L-4074"><span class="linenos">4074</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-4075"><a href="#L-4075"><span class="linenos">4075</span></a>        <span class="c1"># Calculate the intensity center = centroid according to www-help</span>
</span><span id="L-4076"><a href="#L-4076"><span class="linenos">4076</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-4077"><a href="#L-4077"><span class="linenos">4077</span></a>        <span class="c1"># We have centroid of the central square =&gt; recalculate to whole image</span>
</span><span id="L-4078"><a href="#L-4078"><span class="linenos">4078</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xborder</span><span class="p">,</span><span class="n">yc</span><span class="o">+</span><span class="n">yborder</span><span class="p">)</span>
</span><span id="L-4079"><a href="#L-4079"><span class="linenos">4079</span></a>        
</span><span id="L-4080"><a href="#L-4080"><span class="linenos">4080</span></a>        <span class="c1">## Return the final center</span>
</span><span id="L-4081"><a href="#L-4081"><span class="linenos">4081</span></a>        <span class="k">return</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="CenterLocator">
                            <input id="CenterLocator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CenterLocator</span>:

                <label class="view-source-button" for="CenterLocator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator-64"><a href="#CenterLocator-64"><span class="linenos"> 64</span></a><span class="k">class</span> <span class="nc">CenterLocator</span><span class="p">:</span>
</span><span id="CenterLocator-65"><a href="#CenterLocator-65"><span class="linenos"> 65</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator-66"><a href="#CenterLocator-66"><span class="linenos"> 66</span></a><span class="sd">    CenterLocator object : determine and refine the center of a 2D electron </span>
</span><span id="CenterLocator-67"><a href="#CenterLocator-67"><span class="linenos"> 67</span></a><span class="sd">    diffraction pattern (diffractogram)</span>
</span><span id="CenterLocator-68"><a href="#CenterLocator-68"><span class="linenos"> 68</span></a><span class="sd">    </span>
</span><span id="CenterLocator-69"><a href="#CenterLocator-69"><span class="linenos"> 69</span></a><span class="sd">    This class detects the center of diffraction patterns. It offers several </span>
</span><span id="CenterLocator-70"><a href="#CenterLocator-70"><span class="linenos"> 70</span></a><span class="sd">    automatic or manual methods and optionally refines the center position.</span>
</span><span id="CenterLocator-71"><a href="#CenterLocator-71"><span class="linenos"> 71</span></a>
</span><span id="CenterLocator-72"><a href="#CenterLocator-72"><span class="linenos"> 72</span></a>
</span><span id="CenterLocator-73"><a href="#CenterLocator-73"><span class="linenos"> 73</span></a><span class="sd">    Parameters</span>
</span><span id="CenterLocator-74"><a href="#CenterLocator-74"><span class="linenos"> 74</span></a><span class="sd">    ----------</span>
</span><span id="CenterLocator-75"><a href="#CenterLocator-75"><span class="linenos"> 75</span></a><span class="sd">    input_image : str, path, or numpy.ndarray</span>
</span><span id="CenterLocator-76"><a href="#CenterLocator-76"><span class="linenos"> 76</span></a><span class="sd">        The input 2D diffraction image, either a file path or a NumPy array.</span>
</span><span id="CenterLocator-77"><a href="#CenterLocator-77"><span class="linenos"> 77</span></a>
</span><span id="CenterLocator-78"><a href="#CenterLocator-78"><span class="linenos"> 78</span></a><span class="sd">    determination : str or None, optional, default=None</span>
</span><span id="CenterLocator-79"><a href="#CenterLocator-79"><span class="linenos"> 79</span></a><span class="sd">        Method used for the initial center determination.</span>
</span><span id="CenterLocator-80"><a href="#CenterLocator-80"><span class="linenos"> 80</span></a><span class="sd">        Options include:</span>
</span><span id="CenterLocator-81"><a href="#CenterLocator-81"><span class="linenos"> 81</span></a><span class="sd">        - &#39;manual&#39;: Manual detection = interactive plot where the user</span>
</span><span id="CenterLocator-82"><a href="#CenterLocator-82"><span class="linenos"> 82</span></a><span class="sd">          selects 3 points defining a diffraction ring with a mouse.</span>
</span><span id="CenterLocator-83"><a href="#CenterLocator-83"><span class="linenos"> 83</span></a><span class="sd">        - &#39;intensity&#39; : Auto-detection = the intensity center</span>
</span><span id="CenterLocator-84"><a href="#CenterLocator-84"><span class="linenos"> 84</span></a><span class="sd">          from the central region.</span>
</span><span id="CenterLocator-85"><a href="#CenterLocator-85"><span class="linenos"> 85</span></a><span class="sd">        - &#39;curvefit&#39;: Automatic detection = fit the intensity center</span>
</span><span id="CenterLocator-86"><a href="#CenterLocator-86"><span class="linenos"> 86</span></a><span class="sd">          from the central region using pseudo-Voigt profile.                      </span>
</span><span id="CenterLocator-87"><a href="#CenterLocator-87"><span class="linenos"> 87</span></a><span class="sd">        - &#39;hough&#39; : Automatic detection using Hough transform</span>
</span><span id="CenterLocator-88"><a href="#CenterLocator-88"><span class="linenos"> 88</span></a><span class="sd">          to find center of ring-like structures.</span>
</span><span id="CenterLocator-89"><a href="#CenterLocator-89"><span class="linenos"> 89</span></a><span class="sd">        - &#39;phase&#39; : Automatic detection using phase correlation</span>
</span><span id="CenterLocator-90"><a href="#CenterLocator-90"><span class="linenos"> 90</span></a><span class="sd">          to find the symmetry center.</span>
</span><span id="CenterLocator-91"><a href="#CenterLocator-91"><span class="linenos"> 91</span></a><span class="sd">        - &#39;ccorr&#39; : Automatic detection using cross-correlation</span>
</span><span id="CenterLocator-92"><a href="#CenterLocator-92"><span class="linenos"> 92</span></a><span class="sd">          to find the symmetry center.</span>
</span><span id="CenterLocator-93"><a href="#CenterLocator-93"><span class="linenos"> 93</span></a><span class="sd">        - None : Skip the center determination;</span>
</span><span id="CenterLocator-94"><a href="#CenterLocator-94"><span class="linenos"> 94</span></a><span class="sd">          it is supposed that the center coordinates</span>
</span><span id="CenterLocator-95"><a href="#CenterLocator-95"><span class="linenos"> 95</span></a><span class="sd">          will be read from *in_file* argument - see below.</span>
</span><span id="CenterLocator-96"><a href="#CenterLocator-96"><span class="linenos"> 96</span></a><span class="sd">          </span>
</span><span id="CenterLocator-97"><a href="#CenterLocator-97"><span class="linenos"> 97</span></a><span class="sd">    refinement : str or None, optional, default=None</span>
</span><span id="CenterLocator-98"><a href="#CenterLocator-98"><span class="linenos"> 98</span></a><span class="sd">        Method used for refining the initially detected center.</span>
</span><span id="CenterLocator-99"><a href="#CenterLocator-99"><span class="linenos"> 99</span></a><span class="sd">        Options include:</span>
</span><span id="CenterLocator-100"><a href="#CenterLocator-100"><span class="linenos">100</span></a><span class="sd">        - &#39;manual&#39;: Manual fine-tuning of the center along</span>
</span><span id="CenterLocator-101"><a href="#CenterLocator-101"><span class="linenos">101</span></a><span class="sd">          the selected diffraction ring.</span>
</span><span id="CenterLocator-102"><a href="#CenterLocator-102"><span class="linenos">102</span></a><span class="sd">        - &#39;sum&#39; : Automatic refinement by maximizing the intensity sum</span>
</span><span id="CenterLocator-103"><a href="#CenterLocator-103"><span class="linenos">103</span></a><span class="sd">          the selected diffraction ring.</span>
</span><span id="CenterLocator-104"><a href="#CenterLocator-104"><span class="linenos">104</span></a><span class="sd">        - &#39;var&#39;: Automatic refinement by minimizing intensity variance</span>
</span><span id="CenterLocator-105"><a href="#CenterLocator-105"><span class="linenos">105</span></a><span class="sd">          the selected diffraction ring.</span>
</span><span id="CenterLocator-106"><a href="#CenterLocator-106"><span class="linenos">106</span></a>
</span><span id="CenterLocator-107"><a href="#CenterLocator-107"><span class="linenos">107</span></a><span class="sd">    rtype : int, default=1</span>
</span><span id="CenterLocator-108"><a href="#CenterLocator-108"><span class="linenos">108</span></a><span class="sd">        How to determine a radius of a difraction ring for center refinement.</span>
</span><span id="CenterLocator-109"><a href="#CenterLocator-109"><span class="linenos">109</span></a><span class="sd">        In powder diffractograms, the diffraction rings are clearly defined.</span>
</span><span id="CenterLocator-110"><a href="#CenterLocator-110"><span class="linenos">110</span></a><span class="sd">        In spotty diffractograms, the diffraction ring is an fictive ring</span>
</span><span id="CenterLocator-111"><a href="#CenterLocator-111"><span class="linenos">111</span></a><span class="sd">        connecting at least three diffraction spots.</span>
</span><span id="CenterLocator-112"><a href="#CenterLocator-112"><span class="linenos">112</span></a><span class="sd">        Options include:</span>
</span><span id="CenterLocator-113"><a href="#CenterLocator-113"><span class="linenos">113</span></a><span class="sd">        - 0 : Peak matching method</span>
</span><span id="CenterLocator-114"><a href="#CenterLocator-114"><span class="linenos">114</span></a><span class="sd">          (fast and simple, but failing for non-powders, historical).</span>
</span><span id="CenterLocator-115"><a href="#CenterLocator-115"><span class="linenos">115</span></a><span class="sd">        - 1 : Radial distribution method</span>
</span><span id="CenterLocator-116"><a href="#CenterLocator-116"><span class="linenos">116</span></a><span class="sd">          (slower but more universal, new default).</span>
</span><span id="CenterLocator-117"><a href="#CenterLocator-117"><span class="linenos">117</span></a><span class="sd">        </span>
</span><span id="CenterLocator-118"><a href="#CenterLocator-118"><span class="linenos">118</span></a><span class="sd">    in_file : str or None, optional, default=None</span>
</span><span id="CenterLocator-119"><a href="#CenterLocator-119"><span class="linenos">119</span></a><span class="sd">        Path to a file from which the (previously saved)</span>
</span><span id="CenterLocator-120"><a href="#CenterLocator-120"><span class="linenos">120</span></a><span class="sd">        center coordinates will be loaded.</span>
</span><span id="CenterLocator-121"><a href="#CenterLocator-121"><span class="linenos">121</span></a>
</span><span id="CenterLocator-122"><a href="#CenterLocator-122"><span class="linenos">122</span></a><span class="sd">    out_file : str or None, optional, default=None</span>
</span><span id="CenterLocator-123"><a href="#CenterLocator-123"><span class="linenos">123</span></a><span class="sd">        Path to a file where the determined</span>
</span><span id="CenterLocator-124"><a href="#CenterLocator-124"><span class="linenos">124</span></a><span class="sd">        center coordinates will be saved.</span>
</span><span id="CenterLocator-125"><a href="#CenterLocator-125"><span class="linenos">125</span></a><span class="sd">        </span>
</span><span id="CenterLocator-126"><a href="#CenterLocator-126"><span class="linenos">126</span></a><span class="sd">    sobel : bool, optional, default=False</span>
</span><span id="CenterLocator-127"><a href="#CenterLocator-127"><span class="linenos">127</span></a><span class="sd">        If True, apply Sobel filter to the image before processing.</span>
</span><span id="CenterLocator-128"><a href="#CenterLocator-128"><span class="linenos">128</span></a><span class="sd">        </span>
</span><span id="CenterLocator-129"><a href="#CenterLocator-129"><span class="linenos">129</span></a><span class="sd">    heq : bool or None, optional, default=False</span>
</span><span id="CenterLocator-130"><a href="#CenterLocator-130"><span class="linenos">130</span></a><span class="sd">        If True, apply histogram equalization internally (display unchanged).</span>
</span><span id="CenterLocator-131"><a href="#CenterLocator-131"><span class="linenos">131</span></a>
</span><span id="CenterLocator-132"><a href="#CenterLocator-132"><span class="linenos">132</span></a><span class="sd">    icut : float or None, optional, default=None</span>
</span><span id="CenterLocator-133"><a href="#CenterLocator-133"><span class="linenos">133</span></a><span class="sd">        Cut-off intensity level for processing the image.</span>
</span><span id="CenterLocator-134"><a href="#CenterLocator-134"><span class="linenos">134</span></a><span class="sd">        </span>
</span><span id="CenterLocator-135"><a href="#CenterLocator-135"><span class="linenos">135</span></a><span class="sd">    cmap : str, optional, default=&#39;gray&#39;</span>
</span><span id="CenterLocator-136"><a href="#CenterLocator-136"><span class="linenos">136</span></a><span class="sd">        Matplotlib colormap name used for displaying the image.</span>
</span><span id="CenterLocator-137"><a href="#CenterLocator-137"><span class="linenos">137</span></a><span class="sd">        </span>
</span><span id="CenterLocator-138"><a href="#CenterLocator-138"><span class="linenos">138</span></a><span class="sd">    csquare : int, optional, default=50</span>
</span><span id="CenterLocator-139"><a href="#CenterLocator-139"><span class="linenos">139</span></a><span class="sd">        Size (in pixels) of the central square used for initial center search.</span>
</span><span id="CenterLocator-140"><a href="#CenterLocator-140"><span class="linenos">140</span></a><span class="sd">        </span>
</span><span id="CenterLocator-141"><a href="#CenterLocator-141"><span class="linenos">141</span></a><span class="sd">    cintensity : float, optional, default=0.8</span>
</span><span id="CenterLocator-142"><a href="#CenterLocator-142"><span class="linenos">142</span></a><span class="sd">        Threshold intensity for finding the intensity center. Pixels with a </span>
</span><span id="CenterLocator-143"><a href="#CenterLocator-143"><span class="linenos">143</span></a><span class="sd">        (relative) intensity lower than cintensity are ignored.</span>
</span><span id="CenterLocator-144"><a href="#CenterLocator-144"><span class="linenos">144</span></a><span class="sd">        </span>
</span><span id="CenterLocator-145"><a href="#CenterLocator-145"><span class="linenos">145</span></a><span class="sd">    verbose : int, optional, default=0</span>
</span><span id="CenterLocator-146"><a href="#CenterLocator-146"><span class="linenos">146</span></a><span class="sd">        Verbosity level for printing messages during processing:</span>
</span><span id="CenterLocator-147"><a href="#CenterLocator-147"><span class="linenos">147</span></a><span class="sd">        - 0 : Silent mode — no messages are printed.</span>
</span><span id="CenterLocator-148"><a href="#CenterLocator-148"><span class="linenos">148</span></a><span class="sd">        - 1 : Show help messages during manual refinement only.</span>
</span><span id="CenterLocator-149"><a href="#CenterLocator-149"><span class="linenos">149</span></a><span class="sd">        - 2 : Full verbose mode — print all messages and debug information.</span>
</span><span id="CenterLocator-150"><a href="#CenterLocator-150"><span class="linenos">150</span></a><span class="sd">        - 3 : Progress mode — print brief status updates during time-consuming </span>
</span><span id="CenterLocator-151"><a href="#CenterLocator-151"><span class="linenos">151</span></a><span class="sd">              processing.</span>
</span><span id="CenterLocator-152"><a href="#CenterLocator-152"><span class="linenos">152</span></a><span class="sd">        </span>
</span><span id="CenterLocator-153"><a href="#CenterLocator-153"><span class="linenos">153</span></a><span class="sd">    print_sums : bool, optional, default=False</span>
</span><span id="CenterLocator-154"><a href="#CenterLocator-154"><span class="linenos">154</span></a><span class="sd">        If True, print intensity sums after each adjustment (in manual modes).</span>
</span><span id="CenterLocator-155"><a href="#CenterLocator-155"><span class="linenos">155</span></a><span class="sd">        </span>
</span><span id="CenterLocator-156"><a href="#CenterLocator-156"><span class="linenos">156</span></a><span class="sd">    final_print : bool, optional, default=True</span>
</span><span id="CenterLocator-157"><a href="#CenterLocator-157"><span class="linenos">157</span></a><span class="sd">        If True, print final coordinates to stdout.</span>
</span><span id="CenterLocator-158"><a href="#CenterLocator-158"><span class="linenos">158</span></a><span class="sd">    </span>
</span><span id="CenterLocator-159"><a href="#CenterLocator-159"><span class="linenos">159</span></a><span class="sd">    live_plot : bool, optional, default=True</span>
</span><span id="CenterLocator-160"><a href="#CenterLocator-160"><span class="linenos">160</span></a><span class="sd">        If True, show live visualization of some processes if available.</span>
</span><span id="CenterLocator-161"><a href="#CenterLocator-161"><span class="linenos">161</span></a><span class="sd"> </span>
</span><span id="CenterLocator-162"><a href="#CenterLocator-162"><span class="linenos">162</span></a><span class="sd">    Returns</span>
</span><span id="CenterLocator-163"><a href="#CenterLocator-163"><span class="linenos">163</span></a><span class="sd">    -------</span>
</span><span id="CenterLocator-164"><a href="#CenterLocator-164"><span class="linenos">164</span></a><span class="sd">    None</span>
</span><span id="CenterLocator-165"><a href="#CenterLocator-165"><span class="linenos">165</span></a><span class="sd">        The result is stored in the instance variables:</span>
</span><span id="CenterLocator-166"><a href="#CenterLocator-166"><span class="linenos">166</span></a><span class="sd">        - `(x1, y1)` for the initially determined center</span>
</span><span id="CenterLocator-167"><a href="#CenterLocator-167"><span class="linenos">167</span></a><span class="sd">        - `(x2, y2)` for the refined center (if refinement is applied)</span>
</span><span id="CenterLocator-168"><a href="#CenterLocator-168"><span class="linenos">168</span></a><span class="sd">            </span>
</span><span id="CenterLocator-169"><a href="#CenterLocator-169"><span class="linenos">169</span></a><span class="sd">    Technical notes</span>
</span><span id="CenterLocator-170"><a href="#CenterLocator-170"><span class="linenos">170</span></a><span class="sd">    ---------------</span>
</span><span id="CenterLocator-171"><a href="#CenterLocator-171"><span class="linenos">171</span></a><span class="sd">    * The class automatically initializes and uses two internal components:</span>
</span><span id="CenterLocator-172"><a href="#CenterLocator-172"><span class="linenos">172</span></a><span class="sd">      `CenterDetermination` and `CenterRefinement`.</span>
</span><span id="CenterLocator-173"><a href="#CenterLocator-173"><span class="linenos">173</span></a><span class="sd">    * These internal processes are hidden from the user but can be accessed </span>
</span><span id="CenterLocator-174"><a href="#CenterLocator-174"><span class="linenos">174</span></a><span class="sd">      directly if needed.</span>
</span><span id="CenterLocator-175"><a href="#CenterLocator-175"><span class="linenos">175</span></a>
</span><span id="CenterLocator-176"><a href="#CenterLocator-176"><span class="linenos">176</span></a><span class="sd">    Examples</span>
</span><span id="CenterLocator-177"><a href="#CenterLocator-177"><span class="linenos">177</span></a><span class="sd">    --------</span>
</span><span id="CenterLocator-178"><a href="#CenterLocator-178"><span class="linenos">178</span></a><span class="sd">    &gt;&gt;&gt; import ediff as ed</span>
</span><span id="CenterLocator-179"><a href="#CenterLocator-179"><span class="linenos">179</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="CenterLocator-180"><a href="#CenterLocator-180"><span class="linenos">180</span></a><span class="sd">    &gt;&gt;&gt; locator = ed.center.CenterLocator(</span>
</span><span id="CenterLocator-181"><a href="#CenterLocator-181"><span class="linenos">181</span></a><span class="sd">    &gt;&gt;&gt;    input_image   = &#39;.r/path/to/your/data.png&#39;,   </span>
</span><span id="CenterLocator-182"><a href="#CenterLocator-182"><span class="linenos">182</span></a><span class="sd">    &gt;&gt;&gt;    determination = &#39;manual&#39;,           </span>
</span><span id="CenterLocator-183"><a href="#CenterLocator-183"><span class="linenos">183</span></a><span class="sd">    &gt;&gt;&gt;    refinement    = &#39;sum&#39;,</span>
</span><span id="CenterLocator-184"><a href="#CenterLocator-184"><span class="linenos">184</span></a><span class="sd">    &gt;&gt;&gt;    final_print   = True)   </span>
</span><span id="CenterLocator-185"><a href="#CenterLocator-185"><span class="linenos">185</span></a><span class="sd">                              </span>
</span><span id="CenterLocator-186"><a href="#CenterLocator-186"><span class="linenos">186</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="CenterLocator-187"><a href="#CenterLocator-187"><span class="linenos">187</span></a>    
</span><span id="CenterLocator-188"><a href="#CenterLocator-188"><span class="linenos">188</span></a>    
</span><span id="CenterLocator-189"><a href="#CenterLocator-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CenterLocator-190"><a href="#CenterLocator-190"><span class="linenos">190</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="CenterLocator-191"><a href="#CenterLocator-191"><span class="linenos">191</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="CenterLocator-192"><a href="#CenterLocator-192"><span class="linenos">192</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-193"><a href="#CenterLocator-193"><span class="linenos">193</span></a>                 <span class="n">rtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="CenterLocator-194"><a href="#CenterLocator-194"><span class="linenos">194</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-195"><a href="#CenterLocator-195"><span class="linenos">195</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-196"><a href="#CenterLocator-196"><span class="linenos">196</span></a>                 <span class="n">sobel</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CenterLocator-197"><a href="#CenterLocator-197"><span class="linenos">197</span></a>                 <span class="n">masking</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="CenterLocator-198"><a href="#CenterLocator-198"><span class="linenos">198</span></a>                 <span class="n">ellipse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CenterLocator-199"><a href="#CenterLocator-199"><span class="linenos">199</span></a>                 <span class="n">mcorrect</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-200"><a href="#CenterLocator-200"><span class="linenos">200</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator-201"><a href="#CenterLocator-201"><span class="linenos">201</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-202"><a href="#CenterLocator-202"><span class="linenos">202</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="CenterLocator-203"><a href="#CenterLocator-203"><span class="linenos">203</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="CenterLocator-204"><a href="#CenterLocator-204"><span class="linenos">204</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="CenterLocator-205"><a href="#CenterLocator-205"><span class="linenos">205</span></a>                 <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CenterLocator-206"><a href="#CenterLocator-206"><span class="linenos">206</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CenterLocator-207"><a href="#CenterLocator-207"><span class="linenos">207</span></a>                 <span class="n">final_print</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="CenterLocator-208"><a href="#CenterLocator-208"><span class="linenos">208</span></a>                 <span class="n">live_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="CenterLocator-209"><a href="#CenterLocator-209"><span class="linenos">209</span></a>        
</span><span id="CenterLocator-210"><a href="#CenterLocator-210"><span class="linenos">210</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterLocator-211"><a href="#CenterLocator-211"><span class="linenos">211</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="CenterLocator-212"><a href="#CenterLocator-212"><span class="linenos">212</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="CenterLocator-213"><a href="#CenterLocator-213"><span class="linenos">213</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterLocator-214"><a href="#CenterLocator-214"><span class="linenos">214</span></a>
</span><span id="CenterLocator-215"><a href="#CenterLocator-215"><span class="linenos">215</span></a>        <span class="c1">## Initialize input attributes ---------------------------------------</span>
</span><span id="CenterLocator-216"><a href="#CenterLocator-216"><span class="linenos">216</span></a>        
</span><span id="CenterLocator-217"><a href="#CenterLocator-217"><span class="linenos">217</span></a>        <span class="c1"># Input image = diffraction pattern</span>
</span><span id="CenterLocator-218"><a href="#CenterLocator-218"><span class="linenos">218</span></a>        <span class="c1"># (it can be either image file or numpy array)</span>
</span><span id="CenterLocator-219"><a href="#CenterLocator-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="CenterLocator-220"><a href="#CenterLocator-220"><span class="linenos">220</span></a>        
</span><span id="CenterLocator-221"><a href="#CenterLocator-221"><span class="linenos">221</span></a>        <span class="c1"># Methods of center determination, refinement, and radius estimation</span>
</span><span id="CenterLocator-222"><a href="#CenterLocator-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span>
</span><span id="CenterLocator-223"><a href="#CenterLocator-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span>
</span><span id="CenterLocator-224"><a href="#CenterLocator-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rtype</span> <span class="o">=</span> <span class="n">rtype</span>
</span><span id="CenterLocator-225"><a href="#CenterLocator-225"><span class="linenos">225</span></a>        
</span><span id="CenterLocator-226"><a href="#CenterLocator-226"><span class="linenos">226</span></a>        <span class="c1"># For reproducibility, convert the method names to lowercase</span>
</span><span id="CenterLocator-227"><a href="#CenterLocator-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">determination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-228"><a href="#CenterLocator-228"><span class="linenos">228</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="CenterLocator-229"><a href="#CenterLocator-229"><span class="linenos">229</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-230"><a href="#CenterLocator-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="CenterLocator-231"><a href="#CenterLocator-231"><span class="linenos">231</span></a>        
</span><span id="CenterLocator-232"><a href="#CenterLocator-232"><span class="linenos">232</span></a>        <span class="c1"># Text files for reading/saving center coordinates</span>
</span><span id="CenterLocator-233"><a href="#CenterLocator-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">in_file</span>
</span><span id="CenterLocator-234"><a href="#CenterLocator-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file</span>
</span><span id="CenterLocator-235"><a href="#CenterLocator-235"><span class="linenos">235</span></a>        
</span><span id="CenterLocator-236"><a href="#CenterLocator-236"><span class="linenos">236</span></a>        <span class="c1"># Image processing parameters</span>
</span><span id="CenterLocator-237"><a href="#CenterLocator-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span> <span class="o">=</span> <span class="n">ellipse</span>
</span><span id="CenterLocator-238"><a href="#CenterLocator-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcorrect</span> <span class="o">=</span> <span class="n">mcorrect</span>
</span><span id="CenterLocator-239"><a href="#CenterLocator-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sobel</span> <span class="o">=</span> <span class="n">sobel</span>
</span><span id="CenterLocator-240"><a href="#CenterLocator-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">masking</span> <span class="o">=</span> <span class="n">masking</span>
</span><span id="CenterLocator-241"><a href="#CenterLocator-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">=</span> <span class="n">heq</span>
</span><span id="CenterLocator-242"><a href="#CenterLocator-242"><span class="linenos">242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="o">=</span> <span class="n">icut</span>
</span><span id="CenterLocator-243"><a href="#CenterLocator-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span>
</span><span id="CenterLocator-244"><a href="#CenterLocator-244"><span class="linenos">244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span> <span class="o">=</span> <span class="n">csquare</span>
</span><span id="CenterLocator-245"><a href="#CenterLocator-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span> <span class="o">=</span> <span class="n">cintensity</span>
</span><span id="CenterLocator-246"><a href="#CenterLocator-246"><span class="linenos">246</span></a>        
</span><span id="CenterLocator-247"><a href="#CenterLocator-247"><span class="linenos">247</span></a>        <span class="c1"># Process-Information parameters</span>
</span><span id="CenterLocator-248"><a href="#CenterLocator-248"><span class="linenos">248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="CenterLocator-249"><a href="#CenterLocator-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span> <span class="o">=</span> <span class="n">print_sums</span>
</span><span id="CenterLocator-250"><a href="#CenterLocator-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span> <span class="o">=</span> <span class="n">final_print</span>
</span><span id="CenterLocator-251"><a href="#CenterLocator-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">live_plot</span> <span class="o">=</span> <span class="n">live_plot</span>
</span><span id="CenterLocator-252"><a href="#CenterLocator-252"><span class="linenos">252</span></a>        
</span><span id="CenterLocator-253"><a href="#CenterLocator-253"><span class="linenos">253</span></a>        <span class="c1">## Initialize new attributes ------------------------------------------</span>
</span><span id="CenterLocator-254"><a href="#CenterLocator-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-255"><a href="#CenterLocator-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-256"><a href="#CenterLocator-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-257"><a href="#CenterLocator-257"><span class="linenos">257</span></a>        
</span><span id="CenterLocator-258"><a href="#CenterLocator-258"><span class="linenos">258</span></a>        <span class="c1"># The value of the following attribute can be adjusted</span>
</span><span id="CenterLocator-259"><a href="#CenterLocator-259"><span class="linenos">259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">=</span> <span class="mi">100</span>          
</span><span id="CenterLocator-260"><a href="#CenterLocator-260"><span class="linenos">260</span></a>
</span><span id="CenterLocator-261"><a href="#CenterLocator-261"><span class="linenos">261</span></a>        <span class="c1">## (1) Read input image -----------------------------------------------</span>
</span><span id="CenterLocator-262"><a href="#CenterLocator-262"><span class="linenos">262</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-263"><a href="#CenterLocator-263"><span class="linenos">263</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Loading image.&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-264"><a href="#CenterLocator-264"><span class="linenos">264</span></a>        <span class="c1"># The input image can be numpy.array (ndarray) or image file (path/str)</span>
</span><span id="CenterLocator-265"><a href="#CenterLocator-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="CenterLocator-266"><a href="#CenterLocator-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="CenterLocator-267"><a href="#CenterLocator-267"><span class="linenos">267</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-268"><a href="#CenterLocator-268"><span class="linenos">268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">ediff</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">)</span>
</span><span id="CenterLocator-269"><a href="#CenterLocator-269"><span class="linenos">269</span></a>        
</span><span id="CenterLocator-270"><a href="#CenterLocator-270"><span class="linenos">270</span></a>        <span class="c1">## (2) Correct ellipse ------------------------------------------------</span>
</span><span id="CenterLocator-271"><a href="#CenterLocator-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="p">:</span>
</span><span id="CenterLocator-272"><a href="#CenterLocator-272"><span class="linenos">272</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-273"><a href="#CenterLocator-273"><span class="linenos">273</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Correcting ellipse distortion... &quot;</span><span class="p">,</span> 
</span><span id="CenterLocator-274"><a href="#CenterLocator-274"><span class="linenos">274</span></a>                      <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CenterLocator-275"><a href="#CenterLocator-275"><span class="linenos">275</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse_distortion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="CenterLocator-276"><a href="#CenterLocator-276"><span class="linenos">276</span></a>                                                 <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mcorrect</span><span class="p">)</span>
</span><span id="CenterLocator-277"><a href="#CenterLocator-277"><span class="linenos">277</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-278"><a href="#CenterLocator-278"><span class="linenos">278</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-279"><a href="#CenterLocator-279"><span class="linenos">279</span></a>                
</span><span id="CenterLocator-280"><a href="#CenterLocator-280"><span class="linenos">280</span></a>        <span class="c1">## (3) Read center coordinates ----------------------------------------</span>
</span><span id="CenterLocator-281"><a href="#CenterLocator-281"><span class="linenos">281</span></a>        <span class="c1"># The center coordinates may have been determined in a previous run </span>
</span><span id="CenterLocator-282"><a href="#CenterLocator-282"><span class="linenos">282</span></a>        <span class="c1"># of the program and saved to a text file.</span>
</span><span id="CenterLocator-283"><a href="#CenterLocator-283"><span class="linenos">283</span></a>        <span class="c1"># We can Load coordinates from an input file if specified, this is done </span>
</span><span id="CenterLocator-284"><a href="#CenterLocator-284"><span class="linenos">284</span></a>        <span class="c1"># by the following command. As the saved coordinates can be used INSTEAD </span>
</span><span id="CenterLocator-285"><a href="#CenterLocator-285"><span class="linenos">285</span></a>        <span class="c1"># of CenterDetermination we will read them here.</span>
</span><span id="CenterLocator-286"><a href="#CenterLocator-286"><span class="linenos">286</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="CenterLocator-287"><a href="#CenterLocator-287"><span class="linenos">287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_results</span><span class="p">()</span>  
</span><span id="CenterLocator-288"><a href="#CenterLocator-288"><span class="linenos">288</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-289"><a href="#CenterLocator-289"><span class="linenos">289</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Loading saved center coordinates.&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-290"><a href="#CenterLocator-290"><span class="linenos">290</span></a>        
</span><span id="CenterLocator-291"><a href="#CenterLocator-291"><span class="linenos">291</span></a>        <span class="c1">## (4) Run CenterDetermination ----------------------------------------</span>
</span><span id="CenterLocator-292"><a href="#CenterLocator-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-293"><a href="#CenterLocator-293"><span class="linenos">293</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Detecting center...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CenterLocator-294"><a href="#CenterLocator-294"><span class="linenos">294</span></a>            
</span><span id="CenterLocator-295"><a href="#CenterLocator-295"><span class="linenos">295</span></a>        <span class="c1">#  (4a) Initialize/run CenterDetermination</span>
</span><span id="CenterLocator-296"><a href="#CenterLocator-296"><span class="linenos">296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center1</span> <span class="o">=</span> <span class="n">CenterDetermination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CenterLocator-297"><a href="#CenterLocator-297"><span class="linenos">297</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span>
</span><span id="CenterLocator-298"><a href="#CenterLocator-298"><span class="linenos">298</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="p">,</span>
</span><span id="CenterLocator-299"><a href="#CenterLocator-299"><span class="linenos">299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span>
</span><span id="CenterLocator-300"><a href="#CenterLocator-300"><span class="linenos">300</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="CenterLocator-301"><a href="#CenterLocator-301"><span class="linenos">301</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterLocator-302"><a href="#CenterLocator-302"><span class="linenos">302</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span>
</span><span id="CenterLocator-303"><a href="#CenterLocator-303"><span class="linenos">303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span><span class="p">,</span>
</span><span id="CenterLocator-304"><a href="#CenterLocator-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="CenterLocator-305"><a href="#CenterLocator-305"><span class="linenos">305</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="CenterLocator-306"><a href="#CenterLocator-306"><span class="linenos">306</span></a>        
</span><span id="CenterLocator-307"><a href="#CenterLocator-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-308"><a href="#CenterLocator-308"><span class="linenos">308</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-309"><a href="#CenterLocator-309"><span class="linenos">309</span></a>    
</span><span id="CenterLocator-310"><a href="#CenterLocator-310"><span class="linenos">310</span></a>        <span class="c1">#  (4b) Find radius of a circle/diffraction ring, which is needed </span>
</span><span id="CenterLocator-311"><a href="#CenterLocator-311"><span class="linenos">311</span></a>        <span class="c1">#       for the next step = CenterRefimenement.</span>
</span><span id="CenterLocator-312"><a href="#CenterLocator-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-313"><a href="#CenterLocator-313"><span class="linenos">313</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Estimating radius of the diffraction pattern...&quot;</span><span class="p">,</span>
</span><span id="CenterLocator-314"><a href="#CenterLocator-314"><span class="linenos">314</span></a>                  <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CenterLocator-315"><a href="#CenterLocator-315"><span class="linenos">315</span></a>    
</span><span id="CenterLocator-316"><a href="#CenterLocator-316"><span class="linenos">316</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">!=</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterLocator-317"><a href="#CenterLocator-317"><span class="linenos">317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span>
</span><span id="CenterLocator-318"><a href="#CenterLocator-318"><span class="linenos">318</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rtype</span><span class="p">,</span>
</span><span id="CenterLocator-319"><a href="#CenterLocator-319"><span class="linenos">319</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterLocator-320"><a href="#CenterLocator-320"><span class="linenos">320</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="CenterLocator-321"><a href="#CenterLocator-321"><span class="linenos">321</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterLocator-322"><a href="#CenterLocator-322"><span class="linenos">322</span></a>                <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterLocator-323"><a href="#CenterLocator-323"><span class="linenos">323</span></a>        
</span><span id="CenterLocator-324"><a href="#CenterLocator-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-325"><a href="#CenterLocator-325"><span class="linenos">325</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-326"><a href="#CenterLocator-326"><span class="linenos">326</span></a>            
</span><span id="CenterLocator-327"><a href="#CenterLocator-327"><span class="linenos">327</span></a>        <span class="c1">## (5) Initialize/run CenterRefinement --------------------------------</span>
</span><span id="CenterLocator-328"><a href="#CenterLocator-328"><span class="linenos">328</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-329"><a href="#CenterLocator-329"><span class="linenos">329</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Refining center coordinates...&quot;</span><span class="p">,</span>
</span><span id="CenterLocator-330"><a href="#CenterLocator-330"><span class="linenos">330</span></a>                  <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CenterLocator-331"><a href="#CenterLocator-331"><span class="linenos">331</span></a>                
</span><span id="CenterLocator-332"><a href="#CenterLocator-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center2</span> <span class="o">=</span> <span class="n">CenterRefinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CenterLocator-333"><a href="#CenterLocator-333"><span class="linenos">333</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span> 
</span><span id="CenterLocator-334"><a href="#CenterLocator-334"><span class="linenos">334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="p">,</span>
</span><span id="CenterLocator-335"><a href="#CenterLocator-335"><span class="linenos">335</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
</span><span id="CenterLocator-336"><a href="#CenterLocator-336"><span class="linenos">336</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
</span><span id="CenterLocator-337"><a href="#CenterLocator-337"><span class="linenos">337</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span> 
</span><span id="CenterLocator-338"><a href="#CenterLocator-338"><span class="linenos">338</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="CenterLocator-339"><a href="#CenterLocator-339"><span class="linenos">339</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterLocator-340"><a href="#CenterLocator-340"><span class="linenos">340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="CenterLocator-341"><a href="#CenterLocator-341"><span class="linenos">341</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="CenterLocator-342"><a href="#CenterLocator-342"><span class="linenos">342</span></a>        
</span><span id="CenterLocator-343"><a href="#CenterLocator-343"><span class="linenos">343</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-344"><a href="#CenterLocator-344"><span class="linenos">344</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [DONE]&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-345"><a href="#CenterLocator-345"><span class="linenos">345</span></a>            
</span><span id="CenterLocator-346"><a href="#CenterLocator-346"><span class="linenos">346</span></a>            
</span><span id="CenterLocator-347"><a href="#CenterLocator-347"><span class="linenos">347</span></a>        <span class="c1">## (6) Collect results ------------------------------------------------</span>
</span><span id="CenterLocator-348"><a href="#CenterLocator-348"><span class="linenos">348</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-349"><a href="#CenterLocator-349"><span class="linenos">349</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Collecting results.&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-350"><a href="#CenterLocator-350"><span class="linenos">350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="CenterLocator-351"><a href="#CenterLocator-351"><span class="linenos">351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="CenterLocator-352"><a href="#CenterLocator-352"><span class="linenos">352</span></a>        
</span><span id="CenterLocator-353"><a href="#CenterLocator-353"><span class="linenos">353</span></a>        <span class="c1"># Center only detected and not refined</span>
</span><span id="CenterLocator-354"><a href="#CenterLocator-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-355"><a href="#CenterLocator-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span>
</span><span id="CenterLocator-356"><a href="#CenterLocator-356"><span class="linenos">356</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span>
</span><span id="CenterLocator-357"><a href="#CenterLocator-357"><span class="linenos">357</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterLocator-358"><a href="#CenterLocator-358"><span class="linenos">358</span></a>            <span class="c1"># Center detected and refined</span>
</span><span id="CenterLocator-359"><a href="#CenterLocator-359"><span class="linenos">359</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="CenterLocator-360"><a href="#CenterLocator-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="CenterLocator-361"><a href="#CenterLocator-361"><span class="linenos">361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="CenterLocator-362"><a href="#CenterLocator-362"><span class="linenos">362</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="CenterLocator-363"><a href="#CenterLocator-363"><span class="linenos">363</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterLocator-364"><a href="#CenterLocator-364"><span class="linenos">364</span></a>        
</span><span id="CenterLocator-365"><a href="#CenterLocator-365"><span class="linenos">365</span></a>        <span class="c1">## (7) Switch coordinates if necessary --------------------------------</span>
</span><span id="CenterLocator-366"><a href="#CenterLocator-366"><span class="linenos">366</span></a>        <span class="c1">#      This step is important, as center detection/refinement methods</span>
</span><span id="CenterLocator-367"><a href="#CenterLocator-367"><span class="linenos">367</span></a>        <span class="c1">#      have various coordinate system origins. The conversion is </span>
</span><span id="CenterLocator-368"><a href="#CenterLocator-368"><span class="linenos">368</span></a>        <span class="c1">#      necessary for some combinations of methods</span>
</span><span id="CenterLocator-369"><a href="#CenterLocator-369"><span class="linenos">369</span></a>        
</span><span id="CenterLocator-370"><a href="#CenterLocator-370"><span class="linenos">370</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">):</span>
</span><span id="CenterLocator-371"><a href="#CenterLocator-371"><span class="linenos">371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator-372"><a href="#CenterLocator-372"><span class="linenos">372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="CenterLocator-373"><a href="#CenterLocator-373"><span class="linenos">373</span></a>        
</span><span id="CenterLocator-374"><a href="#CenterLocator-374"><span class="linenos">374</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;hough&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="CenterLocator-375"><a href="#CenterLocator-375"><span class="linenos">375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="CenterLocator-376"><a href="#CenterLocator-376"><span class="linenos">376</span></a>
</span><span id="CenterLocator-377"><a href="#CenterLocator-377"><span class="linenos">377</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;phase&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="CenterLocator-378"><a href="#CenterLocator-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="CenterLocator-379"><a href="#CenterLocator-379"><span class="linenos">379</span></a>            
</span><span id="CenterLocator-380"><a href="#CenterLocator-380"><span class="linenos">380</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;ccorr&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="CenterLocator-381"><a href="#CenterLocator-381"><span class="linenos">381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span> 
</span><span id="CenterLocator-382"><a href="#CenterLocator-382"><span class="linenos">382</span></a>                        
</span><span id="CenterLocator-383"><a href="#CenterLocator-383"><span class="linenos">383</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s2">&quot;curvefit&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="CenterLocator-384"><a href="#CenterLocator-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span> 
</span><span id="CenterLocator-385"><a href="#CenterLocator-385"><span class="linenos">385</span></a>                            
</span><span id="CenterLocator-386"><a href="#CenterLocator-386"><span class="linenos">386</span></a>        <span class="c1">## (8) Print the coordinates if required ------------------------------</span>
</span><span id="CenterLocator-387"><a href="#CenterLocator-387"><span class="linenos">387</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="CenterLocator-388"><a href="#CenterLocator-388"><span class="linenos">388</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="p">)</span>
</span><span id="CenterLocator-389"><a href="#CenterLocator-389"><span class="linenos">389</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="p">)</span>
</span><span id="CenterLocator-390"><a href="#CenterLocator-390"><span class="linenos">390</span></a>            
</span><span id="CenterLocator-391"><a href="#CenterLocator-391"><span class="linenos">391</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-392"><a href="#CenterLocator-392"><span class="linenos">392</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)))</span>
</span><span id="CenterLocator-393"><a href="#CenterLocator-393"><span class="linenos">393</span></a>            
</span><span id="CenterLocator-394"><a href="#CenterLocator-394"><span class="linenos">394</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-395"><a href="#CenterLocator-395"><span class="linenos">395</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)))</span>
</span><span id="CenterLocator-396"><a href="#CenterLocator-396"><span class="linenos">396</span></a>                        
</span><span id="CenterLocator-397"><a href="#CenterLocator-397"><span class="linenos">397</span></a>        <span class="c1">## (9) Save results to a .txt file if specified -----------------------</span>
</span><span id="CenterLocator-398"><a href="#CenterLocator-398"><span class="linenos">398</span></a>        
</span><span id="CenterLocator-399"><a href="#CenterLocator-399"><span class="linenos">399</span></a>        <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-400"><a href="#CenterLocator-400"><span class="linenos">400</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span><span class="p">()</span>
</span><span id="CenterLocator-401"><a href="#CenterLocator-401"><span class="linenos">401</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
</span><span id="CenterLocator-402"><a href="#CenterLocator-402"><span class="linenos">402</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Saving results.&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-403"><a href="#CenterLocator-403"><span class="linenos">403</span></a>
</span><span id="CenterLocator-404"><a href="#CenterLocator-404"><span class="linenos">404</span></a>    
</span><span id="CenterLocator-405"><a href="#CenterLocator-405"><span class="linenos">405</span></a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator-406"><a href="#CenterLocator-406"><span class="linenos">406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-407"><a href="#CenterLocator-407"><span class="linenos">407</span></a><span class="sd">        Return the final results of center determination and refinement. </span>
</span><span id="CenterLocator-408"><a href="#CenterLocator-408"><span class="linenos">408</span></a><span class="sd">        </span>
</span><span id="CenterLocator-409"><a href="#CenterLocator-409"><span class="linenos">409</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-410"><a href="#CenterLocator-410"><span class="linenos">410</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-411"><a href="#CenterLocator-411"><span class="linenos">411</span></a><span class="sd">        x1 : float</span>
</span><span id="CenterLocator-412"><a href="#CenterLocator-412"><span class="linenos">412</span></a><span class="sd">            x-coordinate of the center determined by the *determination* method.</span>
</span><span id="CenterLocator-413"><a href="#CenterLocator-413"><span class="linenos">413</span></a><span class="sd">            </span>
</span><span id="CenterLocator-414"><a href="#CenterLocator-414"><span class="linenos">414</span></a><span class="sd">        y1 : float</span>
</span><span id="CenterLocator-415"><a href="#CenterLocator-415"><span class="linenos">415</span></a><span class="sd">            y-coordinate of the center determined by the *determination* method.</span>
</span><span id="CenterLocator-416"><a href="#CenterLocator-416"><span class="linenos">416</span></a><span class="sd">        </span>
</span><span id="CenterLocator-417"><a href="#CenterLocator-417"><span class="linenos">417</span></a><span class="sd">        x2 : float</span>
</span><span id="CenterLocator-418"><a href="#CenterLocator-418"><span class="linenos">418</span></a><span class="sd">            x-coordinate of the center after *refinement*, or same as x1 if no </span>
</span><span id="CenterLocator-419"><a href="#CenterLocator-419"><span class="linenos">419</span></a><span class="sd">            refinement was used.</span>
</span><span id="CenterLocator-420"><a href="#CenterLocator-420"><span class="linenos">420</span></a><span class="sd">        </span>
</span><span id="CenterLocator-421"><a href="#CenterLocator-421"><span class="linenos">421</span></a><span class="sd">        y2 : float</span>
</span><span id="CenterLocator-422"><a href="#CenterLocator-422"><span class="linenos">422</span></a><span class="sd">            y-coordinate of the center after *refinement*, or same as y1 if no </span>
</span><span id="CenterLocator-423"><a href="#CenterLocator-423"><span class="linenos">423</span></a><span class="sd">            refinement was used.</span>
</span><span id="CenterLocator-424"><a href="#CenterLocator-424"><span class="linenos">424</span></a>
</span><span id="CenterLocator-425"><a href="#CenterLocator-425"><span class="linenos">425</span></a><span class="sd">            </span>
</span><span id="CenterLocator-426"><a href="#CenterLocator-426"><span class="linenos">426</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator-427"><a href="#CenterLocator-427"><span class="linenos">427</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator-428"><a href="#CenterLocator-428"><span class="linenos">428</span></a><span class="sd">        - The function always returns four values: (x1, y1, x2, y2).</span>
</span><span id="CenterLocator-429"><a href="#CenterLocator-429"><span class="linenos">429</span></a><span class="sd">        - If no refinement method was used (`refinement=None`), then (x2, y2) </span>
</span><span id="CenterLocator-430"><a href="#CenterLocator-430"><span class="linenos">430</span></a><span class="sd">          will be equal to (x1, y1).</span>
</span><span id="CenterLocator-431"><a href="#CenterLocator-431"><span class="linenos">431</span></a><span class="sd">        - All values are rounded to one decimal place before returning.</span>
</span><span id="CenterLocator-432"><a href="#CenterLocator-432"><span class="linenos">432</span></a><span class="sd">        - Coordinates are internally converted to float to ensure consistency </span>
</span><span id="CenterLocator-433"><a href="#CenterLocator-433"><span class="linenos">433</span></a><span class="sd">          in output.</span>
</span><span id="CenterLocator-434"><a href="#CenterLocator-434"><span class="linenos">434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator-435"><a href="#CenterLocator-435"><span class="linenos">435</span></a>        
</span><span id="CenterLocator-436"><a href="#CenterLocator-436"><span class="linenos">436</span></a>        <span class="c1"># (1) refinement=None -------------------------------------------------</span>
</span><span id="CenterLocator-437"><a href="#CenterLocator-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterLocator-438"><a href="#CenterLocator-438"><span class="linenos">438</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator-439"><a href="#CenterLocator-439"><span class="linenos">439</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator-440"><a href="#CenterLocator-440"><span class="linenos">440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> \
</span><span id="CenterLocator-441"><a href="#CenterLocator-441"><span class="linenos">441</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> 
</span><span id="CenterLocator-442"><a href="#CenterLocator-442"><span class="linenos">442</span></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)]</span>
</span><span id="CenterLocator-443"><a href="#CenterLocator-443"><span class="linenos">443</span></a>                    
</span><span id="CenterLocator-444"><a href="#CenterLocator-444"><span class="linenos">444</span></a>        <span class="c1"># (2) refinement!=None ------------------------------------------------</span>
</span><span id="CenterLocator-445"><a href="#CenterLocator-445"><span class="linenos">445</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-446"><a href="#CenterLocator-446"><span class="linenos">446</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator-447"><a href="#CenterLocator-447"><span class="linenos">447</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator-448"><a href="#CenterLocator-448"><span class="linenos">448</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> \
</span><span id="CenterLocator-449"><a href="#CenterLocator-449"><span class="linenos">449</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)]</span>
</span><span id="CenterLocator-450"><a href="#CenterLocator-450"><span class="linenos">450</span></a>            <span class="c1"># Define x2,y2 = x1,y1</span>
</span><span id="CenterLocator-451"><a href="#CenterLocator-451"><span class="linenos">451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
</span><span id="CenterLocator-452"><a href="#CenterLocator-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span>
</span><span id="CenterLocator-453"><a href="#CenterLocator-453"><span class="linenos">453</span></a>            
</span><span id="CenterLocator-454"><a href="#CenterLocator-454"><span class="linenos">454</span></a>        <span class="c1"># (3) Return (rounded) values of center coordinates -------------------</span>
</span><span id="CenterLocator-455"><a href="#CenterLocator-455"><span class="linenos">455</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
</span><span id="CenterLocator-456"><a href="#CenterLocator-456"><span class="linenos">456</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="CenterLocator-457"><a href="#CenterLocator-457"><span class="linenos">457</span></a>
</span><span id="CenterLocator-458"><a href="#CenterLocator-458"><span class="linenos">458</span></a>    
</span><span id="CenterLocator-459"><a href="#CenterLocator-459"><span class="linenos">459</span></a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator-460"><a href="#CenterLocator-460"><span class="linenos">460</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator-461"><a href="#CenterLocator-461"><span class="linenos">461</span></a><span class="sd">        Save the determined and refined center coordinates to a file.</span>
</span><span id="CenterLocator-462"><a href="#CenterLocator-462"><span class="linenos">462</span></a><span class="sd">    </span>
</span><span id="CenterLocator-463"><a href="#CenterLocator-463"><span class="linenos">463</span></a><span class="sd">        This method writes the coordinates (x1, y1) from the *determination*</span>
</span><span id="CenterLocator-464"><a href="#CenterLocator-464"><span class="linenos">464</span></a><span class="sd">        step and (x2, y2) from the *refinement* step to a file specified by the </span>
</span><span id="CenterLocator-465"><a href="#CenterLocator-465"><span class="linenos">465</span></a><span class="sd">        `out_file` attribute.</span>
</span><span id="CenterLocator-466"><a href="#CenterLocator-466"><span class="linenos">466</span></a><span class="sd">    </span>
</span><span id="CenterLocator-467"><a href="#CenterLocator-467"><span class="linenos">467</span></a><span class="sd">        - If the file already exists, the results are appended to the end.</span>
</span><span id="CenterLocator-468"><a href="#CenterLocator-468"><span class="linenos">468</span></a><span class="sd">        - If the file does not exist, it is created and the results are written.</span>
</span><span id="CenterLocator-469"><a href="#CenterLocator-469"><span class="linenos">469</span></a><span class="sd">        - Coordinates are formatted to four decimal places for clarity.</span>
</span><span id="CenterLocator-470"><a href="#CenterLocator-470"><span class="linenos">470</span></a><span class="sd">        </span>
</span><span id="CenterLocator-471"><a href="#CenterLocator-471"><span class="linenos">471</span></a><span class="sd">        </span>
</span><span id="CenterLocator-472"><a href="#CenterLocator-472"><span class="linenos">472</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-473"><a href="#CenterLocator-473"><span class="linenos">473</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-474"><a href="#CenterLocator-474"><span class="linenos">474</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-475"><a href="#CenterLocator-475"><span class="linenos">475</span></a><span class="sd">        </span>
</span><span id="CenterLocator-476"><a href="#CenterLocator-476"><span class="linenos">476</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-477"><a href="#CenterLocator-477"><span class="linenos">477</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-478"><a href="#CenterLocator-478"><span class="linenos">478</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-479"><a href="#CenterLocator-479"><span class="linenos">479</span></a><span class="sd">        </span>
</span><span id="CenterLocator-480"><a href="#CenterLocator-480"><span class="linenos">480</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator-481"><a href="#CenterLocator-481"><span class="linenos">481</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator-482"><a href="#CenterLocator-482"><span class="linenos">482</span></a><span class="sd">        - If `self.out_file` is None, the method does nothing.</span>
</span><span id="CenterLocator-483"><a href="#CenterLocator-483"><span class="linenos">483</span></a><span class="sd">        - The results are written in the format:</span>
</span><span id="CenterLocator-484"><a href="#CenterLocator-484"><span class="linenos">484</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator-485"><a href="#CenterLocator-485"><span class="linenos">485</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator-486"><a href="#CenterLocator-486"><span class="linenos">486</span></a><span class="sd">        - This method does not raise an error if the path is invalid;</span>
</span><span id="CenterLocator-487"><a href="#CenterLocator-487"><span class="linenos">487</span></a><span class="sd">          ensure `out_file` is a valid writable path.</span>
</span><span id="CenterLocator-488"><a href="#CenterLocator-488"><span class="linenos">488</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-489"><a href="#CenterLocator-489"><span class="linenos">489</span></a>        
</span><span id="CenterLocator-490"><a href="#CenterLocator-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-491"><a href="#CenterLocator-491"><span class="linenos">491</span></a>            <span class="c1"># Check if the specified file exists</span>
</span><span id="CenterLocator-492"><a href="#CenterLocator-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">):</span>
</span><span id="CenterLocator-493"><a href="#CenterLocator-493"><span class="linenos">493</span></a>                <span class="c1"># Append results to in_file</span>
</span><span id="CenterLocator-494"><a href="#CenterLocator-494"><span class="linenos">494</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in append mode</span>
</span><span id="CenterLocator-495"><a href="#CenterLocator-495"><span class="linenos">495</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-496"><a href="#CenterLocator-496"><span class="linenos">496</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-497"><a href="#CenterLocator-497"><span class="linenos">497</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-498"><a href="#CenterLocator-498"><span class="linenos">498</span></a>                <span class="c1"># If the file does not exist, create it and write results</span>
</span><span id="CenterLocator-499"><a href="#CenterLocator-499"><span class="linenos">499</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in write mode</span>
</span><span id="CenterLocator-500"><a href="#CenterLocator-500"><span class="linenos">500</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-501"><a href="#CenterLocator-501"><span class="linenos">501</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-502"><a href="#CenterLocator-502"><span class="linenos">502</span></a>
</span><span id="CenterLocator-503"><a href="#CenterLocator-503"><span class="linenos">503</span></a>
</span><span id="CenterLocator-504"><a href="#CenterLocator-504"><span class="linenos">504</span></a>    <span class="k">def</span> <span class="nf">load_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CenterLocator-505"><a href="#CenterLocator-505"><span class="linenos">505</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-506"><a href="#CenterLocator-506"><span class="linenos">506</span></a><span class="sd">        Load center coordinates from a results file.</span>
</span><span id="CenterLocator-507"><a href="#CenterLocator-507"><span class="linenos">507</span></a><span class="sd">    </span>
</span><span id="CenterLocator-508"><a href="#CenterLocator-508"><span class="linenos">508</span></a><span class="sd">        This method reads a text file (defaulting to `self.in_file` or</span>
</span><span id="CenterLocator-509"><a href="#CenterLocator-509"><span class="linenos">509</span></a><span class="sd">        a provided `path`) containing previously saved center coordinates.</span>
</span><span id="CenterLocator-510"><a href="#CenterLocator-510"><span class="linenos">510</span></a><span class="sd">        It extracts coordinate pairs (x1, y1) from the determination step and</span>
</span><span id="CenterLocator-511"><a href="#CenterLocator-511"><span class="linenos">511</span></a><span class="sd">        (x2, y2) from the refinement step. All sets of values are stored</span>
</span><span id="CenterLocator-512"><a href="#CenterLocator-512"><span class="linenos">512</span></a><span class="sd">        internally, with the most recent values assigned to instance variables </span>
</span><span id="CenterLocator-513"><a href="#CenterLocator-513"><span class="linenos">513</span></a><span class="sd">        `self.x1`, `self.y1`, `self.x2`, and `self.y2`.</span>
</span><span id="CenterLocator-514"><a href="#CenterLocator-514"><span class="linenos">514</span></a><span class="sd">    </span>
</span><span id="CenterLocator-515"><a href="#CenterLocator-515"><span class="linenos">515</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-516"><a href="#CenterLocator-516"><span class="linenos">516</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-517"><a href="#CenterLocator-517"><span class="linenos">517</span></a><span class="sd">        path : str, optional</span>
</span><span id="CenterLocator-518"><a href="#CenterLocator-518"><span class="linenos">518</span></a><span class="sd">            Path to the results file. </span>
</span><span id="CenterLocator-519"><a href="#CenterLocator-519"><span class="linenos">519</span></a><span class="sd">            If not provided, the method uses `self.in_file`.</span>
</span><span id="CenterLocator-520"><a href="#CenterLocator-520"><span class="linenos">520</span></a><span class="sd">    </span>
</span><span id="CenterLocator-521"><a href="#CenterLocator-521"><span class="linenos">521</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-522"><a href="#CenterLocator-522"><span class="linenos">522</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-523"><a href="#CenterLocator-523"><span class="linenos">523</span></a><span class="sd">        tuple or None</span>
</span><span id="CenterLocator-524"><a href="#CenterLocator-524"><span class="linenos">524</span></a><span class="sd">            If `path` is provided and successfully loaded:</span>
</span><span id="CenterLocator-525"><a href="#CenterLocator-525"><span class="linenos">525</span></a><span class="sd">                (x1_values, y1_values) : Lists of all loaded x1 and y1 values.</span>
</span><span id="CenterLocator-526"><a href="#CenterLocator-526"><span class="linenos">526</span></a><span class="sd">            If loading fails:</span>
</span><span id="CenterLocator-527"><a href="#CenterLocator-527"><span class="linenos">527</span></a><span class="sd">                None</span>
</span><span id="CenterLocator-528"><a href="#CenterLocator-528"><span class="linenos">528</span></a><span class="sd">    </span>
</span><span id="CenterLocator-529"><a href="#CenterLocator-529"><span class="linenos">529</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator-530"><a href="#CenterLocator-530"><span class="linenos">530</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator-531"><a href="#CenterLocator-531"><span class="linenos">531</span></a><span class="sd">        - The file is expected to contain lines in the following format:</span>
</span><span id="CenterLocator-532"><a href="#CenterLocator-532"><span class="linenos">532</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator-533"><a href="#CenterLocator-533"><span class="linenos">533</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator-534"><a href="#CenterLocator-534"><span class="linenos">534</span></a><span class="sd">        - Multiple coordinate entries can be loaded; the last set is stored in</span>
</span><span id="CenterLocator-535"><a href="#CenterLocator-535"><span class="linenos">535</span></a><span class="sd">          the instance variables for easy access.</span>
</span><span id="CenterLocator-536"><a href="#CenterLocator-536"><span class="linenos">536</span></a><span class="sd">        - If the file doesn&#39;t exist or is unreadable, a warning is printed and</span>
</span><span id="CenterLocator-537"><a href="#CenterLocator-537"><span class="linenos">537</span></a><span class="sd">          the function returns None.</span>
</span><span id="CenterLocator-538"><a href="#CenterLocator-538"><span class="linenos">538</span></a><span class="sd">        &quot;&quot;&quot;</span>      
</span><span id="CenterLocator-539"><a href="#CenterLocator-539"><span class="linenos">539</span></a>        
</span><span id="CenterLocator-540"><a href="#CenterLocator-540"><span class="linenos">540</span></a>        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-541"><a href="#CenterLocator-541"><span class="linenos">541</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="CenterLocator-542"><a href="#CenterLocator-542"><span class="linenos">542</span></a>            
</span><span id="CenterLocator-543"><a href="#CenterLocator-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">):</span>
</span><span id="CenterLocator-544"><a href="#CenterLocator-544"><span class="linenos">544</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CenterLocator-545"><a href="#CenterLocator-545"><span class="linenos">545</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CenterLocator-546"><a href="#CenterLocator-546"><span class="linenos">546</span></a>                
</span><span id="CenterLocator-547"><a href="#CenterLocator-547"><span class="linenos">547</span></a>                <span class="c1"># Initialize lists to hold multiple values</span>
</span><span id="CenterLocator-548"><a href="#CenterLocator-548"><span class="linenos">548</span></a>                <span class="n">x1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-549"><a href="#CenterLocator-549"><span class="linenos">549</span></a>                <span class="n">y1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-550"><a href="#CenterLocator-550"><span class="linenos">550</span></a>                <span class="n">x2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-551"><a href="#CenterLocator-551"><span class="linenos">551</span></a>                <span class="n">y2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-552"><a href="#CenterLocator-552"><span class="linenos">552</span></a>    
</span><span id="CenterLocator-553"><a href="#CenterLocator-553"><span class="linenos">553</span></a>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="CenterLocator-554"><a href="#CenterLocator-554"><span class="linenos">554</span></a>                    <span class="c1"># Strip and split each line to get the coordinates</span>
</span><span id="CenterLocator-555"><a href="#CenterLocator-555"><span class="linenos">555</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-556"><a href="#CenterLocator-556"><span class="linenos">556</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterLocator-557"><a href="#CenterLocator-557"><span class="linenos">557</span></a>                        <span class="c1"># Extract x1 and y1 or x2 and y2 based on line content</span>
</span><span id="CenterLocator-558"><a href="#CenterLocator-558"><span class="linenos">558</span></a>                        <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator-559"><a href="#CenterLocator-559"><span class="linenos">559</span></a>                            <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-560"><a href="#CenterLocator-560"><span class="linenos">560</span></a>                            <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-561"><a href="#CenterLocator-561"><span class="linenos">561</span></a>                            <span class="n">x1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
</span><span id="CenterLocator-562"><a href="#CenterLocator-562"><span class="linenos">562</span></a>                            <span class="n">y1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator-563"><a href="#CenterLocator-563"><span class="linenos">563</span></a>                        <span class="k">elif</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator-564"><a href="#CenterLocator-564"><span class="linenos">564</span></a>                            <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-565"><a href="#CenterLocator-565"><span class="linenos">565</span></a>                            <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-566"><a href="#CenterLocator-566"><span class="linenos">566</span></a>                            <span class="n">x2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</span><span id="CenterLocator-567"><a href="#CenterLocator-567"><span class="linenos">567</span></a>                            <span class="n">y2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator-568"><a href="#CenterLocator-568"><span class="linenos">568</span></a>    
</span><span id="CenterLocator-569"><a href="#CenterLocator-569"><span class="linenos">569</span></a>                <span class="c1"># Store the last set of values as instance variables </span>
</span><span id="CenterLocator-570"><a href="#CenterLocator-570"><span class="linenos">570</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span>
</span><span id="CenterLocator-571"><a href="#CenterLocator-571"><span class="linenos">571</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span>
</span><span id="CenterLocator-572"><a href="#CenterLocator-572"><span class="linenos">572</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span>
</span><span id="CenterLocator-573"><a href="#CenterLocator-573"><span class="linenos">573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span>
</span><span id="CenterLocator-574"><a href="#CenterLocator-574"><span class="linenos">574</span></a>    
</span><span id="CenterLocator-575"><a href="#CenterLocator-575"><span class="linenos">575</span></a>                <span class="c1"># Store the last loaded values:</span>
</span><span id="CenterLocator-576"><a href="#CenterLocator-576"><span class="linenos">576</span></a>                <span class="k">if</span> <span class="n">x1_values</span> <span class="ow">and</span> <span class="n">y1_values</span> <span class="ow">and</span> <span class="n">x2_values</span> <span class="ow">and</span> <span class="n">y2_values</span><span class="p">:</span>
</span><span id="CenterLocator-577"><a href="#CenterLocator-577"><span class="linenos">577</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-578"><a href="#CenterLocator-578"><span class="linenos">578</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-579"><a href="#CenterLocator-579"><span class="linenos">579</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-580"><a href="#CenterLocator-580"><span class="linenos">580</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-581"><a href="#CenterLocator-581"><span class="linenos">581</span></a>                    
</span><span id="CenterLocator-582"><a href="#CenterLocator-582"><span class="linenos">582</span></a>                <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-583"><a href="#CenterLocator-583"><span class="linenos">583</span></a>                    <span class="k">return</span> <span class="n">x1_values</span><span class="p">,</span> <span class="n">y1_values</span>
</span><span id="CenterLocator-584"><a href="#CenterLocator-584"><span class="linenos">584</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-585"><a href="#CenterLocator-585"><span class="linenos">585</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error reading text file with center coordinates!&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-586"><a href="#CenterLocator-586"><span class="linenos">586</span></a>            <span class="k">return</span>
</span><span id="CenterLocator-587"><a href="#CenterLocator-587"><span class="linenos">587</span></a>
</span><span id="CenterLocator-588"><a href="#CenterLocator-588"><span class="linenos">588</span></a>
</span><span id="CenterLocator-589"><a href="#CenterLocator-589"><span class="linenos">589</span></a>    <span class="k">def</span> <span class="nf">get_circle_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
</span><span id="CenterLocator-590"><a href="#CenterLocator-590"><span class="linenos">590</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-591"><a href="#CenterLocator-591"><span class="linenos">591</span></a><span class="sd">        Extract pixel values along a circular path in the image.</span>
</span><span id="CenterLocator-592"><a href="#CenterLocator-592"><span class="linenos">592</span></a><span class="sd">    </span>
</span><span id="CenterLocator-593"><a href="#CenterLocator-593"><span class="linenos">593</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-594"><a href="#CenterLocator-594"><span class="linenos">594</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-595"><a href="#CenterLocator-595"><span class="linenos">595</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="CenterLocator-596"><a href="#CenterLocator-596"><span class="linenos">596</span></a><span class="sd">            2D grayscale image from which pixel values are extracted.</span>
</span><span id="CenterLocator-597"><a href="#CenterLocator-597"><span class="linenos">597</span></a><span class="sd">            </span>
</span><span id="CenterLocator-598"><a href="#CenterLocator-598"><span class="linenos">598</span></a><span class="sd">        cx : float</span>
</span><span id="CenterLocator-599"><a href="#CenterLocator-599"><span class="linenos">599</span></a><span class="sd">            X-coordinate (row) of the circle center.</span>
</span><span id="CenterLocator-600"><a href="#CenterLocator-600"><span class="linenos">600</span></a><span class="sd">        </span>
</span><span id="CenterLocator-601"><a href="#CenterLocator-601"><span class="linenos">601</span></a><span class="sd">        cy : float</span>
</span><span id="CenterLocator-602"><a href="#CenterLocator-602"><span class="linenos">602</span></a><span class="sd">            Y-coordinate (column) of the circle center.</span>
</span><span id="CenterLocator-603"><a href="#CenterLocator-603"><span class="linenos">603</span></a><span class="sd">        </span>
</span><span id="CenterLocator-604"><a href="#CenterLocator-604"><span class="linenos">604</span></a><span class="sd">        r : float</span>
</span><span id="CenterLocator-605"><a href="#CenterLocator-605"><span class="linenos">605</span></a><span class="sd">            Radius of the circle.</span>
</span><span id="CenterLocator-606"><a href="#CenterLocator-606"><span class="linenos">606</span></a><span class="sd">        </span>
</span><span id="CenterLocator-607"><a href="#CenterLocator-607"><span class="linenos">607</span></a><span class="sd">        num_points : int, optional</span>
</span><span id="CenterLocator-608"><a href="#CenterLocator-608"><span class="linenos">608</span></a><span class="sd">            Number of points to sample along the circular path. Default is 360.</span>
</span><span id="CenterLocator-609"><a href="#CenterLocator-609"><span class="linenos">609</span></a><span class="sd">    </span>
</span><span id="CenterLocator-610"><a href="#CenterLocator-610"><span class="linenos">610</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-611"><a href="#CenterLocator-611"><span class="linenos">611</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-612"><a href="#CenterLocator-612"><span class="linenos">612</span></a><span class="sd">        pixels : np.ndarray</span>
</span><span id="CenterLocator-613"><a href="#CenterLocator-613"><span class="linenos">613</span></a><span class="sd">            1D array of pixel intensity values sampled along the circular path.</span>
</span><span id="CenterLocator-614"><a href="#CenterLocator-614"><span class="linenos">614</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator-615"><a href="#CenterLocator-615"><span class="linenos">615</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
</span><span id="CenterLocator-616"><a href="#CenterLocator-616"><span class="linenos">616</span></a>        
</span><span id="CenterLocator-617"><a href="#CenterLocator-617"><span class="linenos">617</span></a>        <span class="c1"># Generate coordinates for the circle</span>
</span><span id="CenterLocator-618"><a href="#CenterLocator-618"><span class="linenos">618</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span id="CenterLocator-619"><a href="#CenterLocator-619"><span class="linenos">619</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span id="CenterLocator-620"><a href="#CenterLocator-620"><span class="linenos">620</span></a>        
</span><span id="CenterLocator-621"><a href="#CenterLocator-621"><span class="linenos">621</span></a>        <span class="c1"># Use map_coordinates for accurate sub-pixel interpolation</span>
</span><span id="CenterLocator-622"><a href="#CenterLocator-622"><span class="linenos">622</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</span><span id="CenterLocator-623"><a href="#CenterLocator-623"><span class="linenos">623</span></a>        
</span><span id="CenterLocator-624"><a href="#CenterLocator-624"><span class="linenos">624</span></a>        <span class="c1"># &#39;order=1&#39; is linear interpolation</span>
</span><span id="CenterLocator-625"><a href="#CenterLocator-625"><span class="linenos">625</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterLocator-626"><a href="#CenterLocator-626"><span class="linenos">626</span></a>                                 <span class="n">coords</span><span class="p">,</span> 
</span><span id="CenterLocator-627"><a href="#CenterLocator-627"><span class="linenos">627</span></a>                                 <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterLocator-628"><a href="#CenterLocator-628"><span class="linenos">628</span></a>                                 <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-629"><a href="#CenterLocator-629"><span class="linenos">629</span></a>                                 <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="CenterLocator-630"><a href="#CenterLocator-630"><span class="linenos">630</span></a>        
</span><span id="CenterLocator-631"><a href="#CenterLocator-631"><span class="linenos">631</span></a>        <span class="c1"># Return pixels</span>
</span><span id="CenterLocator-632"><a href="#CenterLocator-632"><span class="linenos">632</span></a>        <span class="k">return</span> <span class="n">pixels</span>
</span><span id="CenterLocator-633"><a href="#CenterLocator-633"><span class="linenos">633</span></a>     
</span><span id="CenterLocator-634"><a href="#CenterLocator-634"><span class="linenos">634</span></a>     
</span><span id="CenterLocator-635"><a href="#CenterLocator-635"><span class="linenos">635</span></a>    <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterLocator-636"><a href="#CenterLocator-636"><span class="linenos">636</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-637"><a href="#CenterLocator-637"><span class="linenos">637</span></a><span class="sd">        Compute the sum of pixel intensities along a circular path.</span>
</span><span id="CenterLocator-638"><a href="#CenterLocator-638"><span class="linenos">638</span></a><span class="sd">    </span>
</span><span id="CenterLocator-639"><a href="#CenterLocator-639"><span class="linenos">639</span></a><span class="sd">        This function extracts pixel values along a circle defined by the </span>
</span><span id="CenterLocator-640"><a href="#CenterLocator-640"><span class="linenos">640</span></a><span class="sd">        given center coordinates (cx, cy) and radius r, then returns </span>
</span><span id="CenterLocator-641"><a href="#CenterLocator-641"><span class="linenos">641</span></a><span class="sd">        the sum of these intensities.</span>
</span><span id="CenterLocator-642"><a href="#CenterLocator-642"><span class="linenos">642</span></a><span class="sd">    </span>
</span><span id="CenterLocator-643"><a href="#CenterLocator-643"><span class="linenos">643</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-644"><a href="#CenterLocator-644"><span class="linenos">644</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-645"><a href="#CenterLocator-645"><span class="linenos">645</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="CenterLocator-646"><a href="#CenterLocator-646"><span class="linenos">646</span></a><span class="sd">            2D grayscale image from which the intensities are extracted.</span>
</span><span id="CenterLocator-647"><a href="#CenterLocator-647"><span class="linenos">647</span></a><span class="sd">        </span>
</span><span id="CenterLocator-648"><a href="#CenterLocator-648"><span class="linenos">648</span></a><span class="sd">        cx : float</span>
</span><span id="CenterLocator-649"><a href="#CenterLocator-649"><span class="linenos">649</span></a><span class="sd">            X-coordinate (row) of the circle center.</span>
</span><span id="CenterLocator-650"><a href="#CenterLocator-650"><span class="linenos">650</span></a><span class="sd">        </span>
</span><span id="CenterLocator-651"><a href="#CenterLocator-651"><span class="linenos">651</span></a><span class="sd">        cy : float</span>
</span><span id="CenterLocator-652"><a href="#CenterLocator-652"><span class="linenos">652</span></a><span class="sd">            Y-coordinate (column) of the circle center.</span>
</span><span id="CenterLocator-653"><a href="#CenterLocator-653"><span class="linenos">653</span></a><span class="sd">        </span>
</span><span id="CenterLocator-654"><a href="#CenterLocator-654"><span class="linenos">654</span></a><span class="sd">        r : float</span>
</span><span id="CenterLocator-655"><a href="#CenterLocator-655"><span class="linenos">655</span></a><span class="sd">            Radius of the circle.</span>
</span><span id="CenterLocator-656"><a href="#CenterLocator-656"><span class="linenos">656</span></a><span class="sd">    </span>
</span><span id="CenterLocator-657"><a href="#CenterLocator-657"><span class="linenos">657</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-658"><a href="#CenterLocator-658"><span class="linenos">658</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-659"><a href="#CenterLocator-659"><span class="linenos">659</span></a><span class="sd">        float</span>
</span><span id="CenterLocator-660"><a href="#CenterLocator-660"><span class="linenos">660</span></a><span class="sd">            Sum of pixel intensities along the circular path.</span>
</span><span id="CenterLocator-661"><a href="#CenterLocator-661"><span class="linenos">661</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator-662"><a href="#CenterLocator-662"><span class="linenos">662</span></a>        <span class="c1"># Get pixel intensities</span>
</span><span id="CenterLocator-663"><a href="#CenterLocator-663"><span class="linenos">663</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterLocator-664"><a href="#CenterLocator-664"><span class="linenos">664</span></a>        
</span><span id="CenterLocator-665"><a href="#CenterLocator-665"><span class="linenos">665</span></a>        <span class="c1"># Sum pixel intensities</span>
</span><span id="CenterLocator-666"><a href="#CenterLocator-666"><span class="linenos">666</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="CenterLocator-667"><a href="#CenterLocator-667"><span class="linenos">667</span></a>    
</span><span id="CenterLocator-668"><a href="#CenterLocator-668"><span class="linenos">668</span></a>    
</span><span id="CenterLocator-669"><a href="#CenterLocator-669"><span class="linenos">669</span></a>    <span class="k">def</span> <span class="nf">intensity_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterLocator-670"><a href="#CenterLocator-670"><span class="linenos">670</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterLocator-671"><a href="#CenterLocator-671"><span class="linenos">671</span></a><span class="sd">        Variance of intensity values of pixels of a diffraction pattern.</span>
</span><span id="CenterLocator-672"><a href="#CenterLocator-672"><span class="linenos">672</span></a>
</span><span id="CenterLocator-673"><a href="#CenterLocator-673"><span class="linenos">673</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-674"><a href="#CenterLocator-674"><span class="linenos">674</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-675"><a href="#CenterLocator-675"><span class="linenos">675</span></a><span class="sd">        image : array of uint8</span>
</span><span id="CenterLocator-676"><a href="#CenterLocator-676"><span class="linenos">676</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="CenterLocator-677"><a href="#CenterLocator-677"><span class="linenos">677</span></a><span class="sd">        </span>
</span><span id="CenterLocator-678"><a href="#CenterLocator-678"><span class="linenos">678</span></a><span class="sd">        px : float64</span>
</span><span id="CenterLocator-679"><a href="#CenterLocator-679"><span class="linenos">679</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator-680"><a href="#CenterLocator-680"><span class="linenos">680</span></a><span class="sd">        </span>
</span><span id="CenterLocator-681"><a href="#CenterLocator-681"><span class="linenos">681</span></a><span class="sd">        py : float64</span>
</span><span id="CenterLocator-682"><a href="#CenterLocator-682"><span class="linenos">682</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator-683"><a href="#CenterLocator-683"><span class="linenos">683</span></a><span class="sd">        </span>
</span><span id="CenterLocator-684"><a href="#CenterLocator-684"><span class="linenos">684</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterLocator-685"><a href="#CenterLocator-685"><span class="linenos">685</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterLocator-686"><a href="#CenterLocator-686"><span class="linenos">686</span></a>
</span><span id="CenterLocator-687"><a href="#CenterLocator-687"><span class="linenos">687</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-688"><a href="#CenterLocator-688"><span class="linenos">688</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-689"><a href="#CenterLocator-689"><span class="linenos">689</span></a><span class="sd">        s : float64</span>
</span><span id="CenterLocator-690"><a href="#CenterLocator-690"><span class="linenos">690</span></a><span class="sd">            intensity variance</span>
</span><span id="CenterLocator-691"><a href="#CenterLocator-691"><span class="linenos">691</span></a>
</span><span id="CenterLocator-692"><a href="#CenterLocator-692"><span class="linenos">692</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-693"><a href="#CenterLocator-693"><span class="linenos">693</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="CenterLocator-694"><a href="#CenterLocator-694"><span class="linenos">694</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterLocator-695"><a href="#CenterLocator-695"><span class="linenos">695</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator-696"><a href="#CenterLocator-696"><span class="linenos">696</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator-697"><a href="#CenterLocator-697"><span class="linenos">697</span></a>        
</span><span id="CenterLocator-698"><a href="#CenterLocator-698"><span class="linenos">698</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="CenterLocator-699"><a href="#CenterLocator-699"><span class="linenos">699</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span><span class="p">])</span>
</span><span id="CenterLocator-700"><a href="#CenterLocator-700"><span class="linenos">700</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="CenterLocator-701"><a href="#CenterLocator-701"><span class="linenos">701</span></a>    
</span><span id="CenterLocator-702"><a href="#CenterLocator-702"><span class="linenos">702</span></a>    
</span><span id="CenterLocator-703"><a href="#CenterLocator-703"><span class="linenos">703</span></a>    <span class="k">def</span> <span class="nf">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="CenterLocator-704"><a href="#CenterLocator-704"><span class="linenos">704</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-705"><a href="#CenterLocator-705"><span class="linenos">705</span></a><span class="sd">        Convert coordinates between numpy and matplotlib systems.</span>
</span><span id="CenterLocator-706"><a href="#CenterLocator-706"><span class="linenos">706</span></a>
</span><span id="CenterLocator-707"><a href="#CenterLocator-707"><span class="linenos">707</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-708"><a href="#CenterLocator-708"><span class="linenos">708</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-709"><a href="#CenterLocator-709"><span class="linenos">709</span></a><span class="sd">        x : int or float</span>
</span><span id="CenterLocator-710"><a href="#CenterLocator-710"><span class="linenos">710</span></a><span class="sd">            The x-coordinate in the numpy (column index) format.</span>
</span><span id="CenterLocator-711"><a href="#CenterLocator-711"><span class="linenos">711</span></a><span class="sd">        </span>
</span><span id="CenterLocator-712"><a href="#CenterLocator-712"><span class="linenos">712</span></a><span class="sd">        y : int or float</span>
</span><span id="CenterLocator-713"><a href="#CenterLocator-713"><span class="linenos">713</span></a><span class="sd">            The y-coordinate in the numpy (row index) format.</span>
</span><span id="CenterLocator-714"><a href="#CenterLocator-714"><span class="linenos">714</span></a>
</span><span id="CenterLocator-715"><a href="#CenterLocator-715"><span class="linenos">715</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-716"><a href="#CenterLocator-716"><span class="linenos">716</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-717"><a href="#CenterLocator-717"><span class="linenos">717</span></a><span class="sd">        tuple of (int or float, int or float)</span>
</span><span id="CenterLocator-718"><a href="#CenterLocator-718"><span class="linenos">718</span></a><span class="sd">            The converted coordinates in matplotlib format, where:</span>
</span><span id="CenterLocator-719"><a href="#CenterLocator-719"><span class="linenos">719</span></a><span class="sd">            - First element corresponds to y (new x in matplotlib).</span>
</span><span id="CenterLocator-720"><a href="#CenterLocator-720"><span class="linenos">720</span></a><span class="sd">            - Second element corresponds to x (new y in matplotlib).</span>
</span><span id="CenterLocator-721"><a href="#CenterLocator-721"><span class="linenos">721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator-722"><a href="#CenterLocator-722"><span class="linenos">722</span></a>        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
</span><span id="CenterLocator-723"><a href="#CenterLocator-723"><span class="linenos">723</span></a>
</span><span id="CenterLocator-724"><a href="#CenterLocator-724"><span class="linenos">724</span></a>
</span><span id="CenterLocator-725"><a href="#CenterLocator-725"><span class="linenos">725</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
</span><span id="CenterLocator-726"><a href="#CenterLocator-726"><span class="linenos">726</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator-727"><a href="#CenterLocator-727"><span class="linenos">727</span></a><span class="sd">        Visualize diffractogram and its center after</span>
</span><span id="CenterLocator-728"><a href="#CenterLocator-728"><span class="linenos">728</span></a><span class="sd">        center determination + refinement.</span>
</span><span id="CenterLocator-729"><a href="#CenterLocator-729"><span class="linenos">729</span></a><span class="sd">    </span>
</span><span id="CenterLocator-730"><a href="#CenterLocator-730"><span class="linenos">730</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-731"><a href="#CenterLocator-731"><span class="linenos">731</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-732"><a href="#CenterLocator-732"><span class="linenos">732</span></a><span class="sd">        csquare : int, optional, default is None</span>
</span><span id="CenterLocator-733"><a href="#CenterLocator-733"><span class="linenos">733</span></a><span class="sd">            If csquare argument is given,</span>
</span><span id="CenterLocator-734"><a href="#CenterLocator-734"><span class="linenos">734</span></a><span class="sd">            only the central square of the diffractogram will be plotted;</span>
</span><span id="CenterLocator-735"><a href="#CenterLocator-735"><span class="linenos">735</span></a><span class="sd">            the size of the central square will be equal to csquare argument.</span>
</span><span id="CenterLocator-736"><a href="#CenterLocator-736"><span class="linenos">736</span></a><span class="sd">        </span>
</span><span id="CenterLocator-737"><a href="#CenterLocator-737"><span class="linenos">737</span></a><span class="sd">        out_file : str, optional, default is None</span>
</span><span id="CenterLocator-738"><a href="#CenterLocator-738"><span class="linenos">738</span></a><span class="sd">            If out_file is given,</span>
</span><span id="CenterLocator-739"><a href="#CenterLocator-739"><span class="linenos">739</span></a><span class="sd">            save the final plot to image named *out_file*.</span>
</span><span id="CenterLocator-740"><a href="#CenterLocator-740"><span class="linenos">740</span></a><span class="sd">        </span>
</span><span id="CenterLocator-741"><a href="#CenterLocator-741"><span class="linenos">741</span></a><span class="sd">        out_dpi : int, optional, default is 200</span>
</span><span id="CenterLocator-742"><a href="#CenterLocator-742"><span class="linenos">742</span></a><span class="sd">            DPI of the output image file;</span>
</span><span id="CenterLocator-743"><a href="#CenterLocator-743"><span class="linenos">743</span></a><span class="sd">            this parameter is relevant only if out_file is given.</span>
</span><span id="CenterLocator-744"><a href="#CenterLocator-744"><span class="linenos">744</span></a><span class="sd">    </span>
</span><span id="CenterLocator-745"><a href="#CenterLocator-745"><span class="linenos">745</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-746"><a href="#CenterLocator-746"><span class="linenos">746</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-747"><a href="#CenterLocator-747"><span class="linenos">747</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-748"><a href="#CenterLocator-748"><span class="linenos">748</span></a><span class="sd">            The output is the image of the diffractogram</span>
</span><span id="CenterLocator-749"><a href="#CenterLocator-749"><span class="linenos">749</span></a><span class="sd">            showing also the central coordinates and refinement ring.</span>
</span><span id="CenterLocator-750"><a href="#CenterLocator-750"><span class="linenos">750</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-751"><a href="#CenterLocator-751"><span class="linenos">751</span></a>        
</span><span id="CenterLocator-752"><a href="#CenterLocator-752"><span class="linenos">752</span></a>        <span class="c1"># (0) Collect center coordinates and radii ----------------------------</span>
</span><span id="CenterLocator-753"><a href="#CenterLocator-753"><span class="linenos">753</span></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator-754"><a href="#CenterLocator-754"><span class="linenos">754</span></a>        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterLocator-755"><a href="#CenterLocator-755"><span class="linenos">755</span></a>
</span><span id="CenterLocator-756"><a href="#CenterLocator-756"><span class="linenos">756</span></a>        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator-757"><a href="#CenterLocator-757"><span class="linenos">757</span></a>        <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span>
</span><span id="CenterLocator-758"><a href="#CenterLocator-758"><span class="linenos">758</span></a>
</span><span id="CenterLocator-759"><a href="#CenterLocator-759"><span class="linenos">759</span></a>        <span class="c1"># (1) Prepare the image of the diffractogram --------------------------</span>
</span><span id="CenterLocator-760"><a href="#CenterLocator-760"><span class="linenos">760</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterLocator-761"><a href="#CenterLocator-761"><span class="linenos">761</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-762"><a href="#CenterLocator-762"><span class="linenos">762</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator-763"><a href="#CenterLocator-763"><span class="linenos">763</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-764"><a href="#CenterLocator-764"><span class="linenos">764</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator-765"><a href="#CenterLocator-765"><span class="linenos">765</span></a>            
</span><span id="CenterLocator-766"><a href="#CenterLocator-766"><span class="linenos">766</span></a>        <span class="c1"># (2) Calculate intensity sum or intensity variance -------------------</span>
</span><span id="CenterLocator-767"><a href="#CenterLocator-767"><span class="linenos">767</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="CenterLocator-768"><a href="#CenterLocator-768"><span class="linenos">768</span></a>            <span class="n">dvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator-769"><a href="#CenterLocator-769"><span class="linenos">769</span></a>            <span class="n">rvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator-770"><a href="#CenterLocator-770"><span class="linenos">770</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-var: </span><span class="si">{</span><span class="n">dvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator-771"><a href="#CenterLocator-771"><span class="linenos">771</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-var: </span><span class="si">{</span><span class="n">rvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator-772"><a href="#CenterLocator-772"><span class="linenos">772</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-773"><a href="#CenterLocator-773"><span class="linenos">773</span></a>            <span class="n">dsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator-774"><a href="#CenterLocator-774"><span class="linenos">774</span></a>            <span class="n">rsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator-775"><a href="#CenterLocator-775"><span class="linenos">775</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-sum: </span><span class="si">{</span><span class="n">dsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator-776"><a href="#CenterLocator-776"><span class="linenos">776</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-sum: </span><span class="si">{</span><span class="n">rsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator-777"><a href="#CenterLocator-777"><span class="linenos">777</span></a>            
</span><span id="CenterLocator-778"><a href="#CenterLocator-778"><span class="linenos">778</span></a>        <span class="c1"># (3) Calculate xy-limits if we want to see only the central square ---</span>
</span><span id="CenterLocator-779"><a href="#CenterLocator-779"><span class="linenos">779</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-780"><a href="#CenterLocator-780"><span class="linenos">780</span></a>            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterLocator-781"><a href="#CenterLocator-781"><span class="linenos">781</span></a>            <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterLocator-782"><a href="#CenterLocator-782"><span class="linenos">782</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator-783"><a href="#CenterLocator-783"><span class="linenos">783</span></a>            <span class="n">xmin</span> <span class="o">+=</span> <span class="n">edge</span>
</span><span id="CenterLocator-784"><a href="#CenterLocator-784"><span class="linenos">784</span></a>            <span class="n">xmax</span> <span class="o">-=</span> <span class="n">edge</span>
</span><span id="CenterLocator-785"><a href="#CenterLocator-785"><span class="linenos">785</span></a>            <span class="n">ymin</span> <span class="o">+=</span> <span class="n">edge</span>
</span><span id="CenterLocator-786"><a href="#CenterLocator-786"><span class="linenos">786</span></a>            <span class="n">ymax</span> <span class="o">-=</span> <span class="n">edge</span>
</span><span id="CenterLocator-787"><a href="#CenterLocator-787"><span class="linenos">787</span></a>    
</span><span id="CenterLocator-788"><a href="#CenterLocator-788"><span class="linenos">788</span></a>        <span class="c1"># (4) Final plot: show the diffractogram + refinement results ---------</span>
</span><span id="CenterLocator-789"><a href="#CenterLocator-789"><span class="linenos">789</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-790"><a href="#CenterLocator-790"><span class="linenos">790</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator-791"><a href="#CenterLocator-791"><span class="linenos">791</span></a>    
</span><span id="CenterLocator-792"><a href="#CenterLocator-792"><span class="linenos">792</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Center :: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-793"><a href="#CenterLocator-793"><span class="linenos">793</span></a>    
</span><span id="CenterLocator-794"><a href="#CenterLocator-794"><span class="linenos">794</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> 
</span><span id="CenterLocator-795"><a href="#CenterLocator-795"><span class="linenos">795</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labeld</span><span class="p">,</span> 
</span><span id="CenterLocator-796"><a href="#CenterLocator-796"><span class="linenos">796</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-797"><a href="#CenterLocator-797"><span class="linenos">797</span></a>                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-798"><a href="#CenterLocator-798"><span class="linenos">798</span></a>                   <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-799"><a href="#CenterLocator-799"><span class="linenos">799</span></a>        <span class="n">c0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">r1</span><span class="p">,</span> 
</span><span id="CenterLocator-800"><a href="#CenterLocator-800"><span class="linenos">800</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-801"><a href="#CenterLocator-801"><span class="linenos">801</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator-802"><a href="#CenterLocator-802"><span class="linenos">802</span></a>                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detected center&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-803"><a href="#CenterLocator-803"><span class="linenos">803</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-804"><a href="#CenterLocator-804"><span class="linenos">804</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>
</span><span id="CenterLocator-805"><a href="#CenterLocator-805"><span class="linenos">805</span></a>    
</span><span id="CenterLocator-806"><a href="#CenterLocator-806"><span class="linenos">806</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span>
</span><span id="CenterLocator-807"><a href="#CenterLocator-807"><span class="linenos">807</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labelr</span><span class="p">,</span> 
</span><span id="CenterLocator-808"><a href="#CenterLocator-808"><span class="linenos">808</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-809"><a href="#CenterLocator-809"><span class="linenos">809</span></a>                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterLocator-810"><a href="#CenterLocator-810"><span class="linenos">810</span></a>        <span class="n">c1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">r2</span><span class="p">,</span> 
</span><span id="CenterLocator-811"><a href="#CenterLocator-811"><span class="linenos">811</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-812"><a href="#CenterLocator-812"><span class="linenos">812</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator-813"><a href="#CenterLocator-813"><span class="linenos">813</span></a>                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refined center&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator-814"><a href="#CenterLocator-814"><span class="linenos">814</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-815"><a href="#CenterLocator-815"><span class="linenos">815</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span><span id="CenterLocator-816"><a href="#CenterLocator-816"><span class="linenos">816</span></a>    
</span><span id="CenterLocator-817"><a href="#CenterLocator-817"><span class="linenos">817</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator-818"><a href="#CenterLocator-818"><span class="linenos">818</span></a>                  <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="n">Circle</span><span class="p">:</span> <span class="n">HandlerCircle</span><span class="p">()},</span> 
</span><span id="CenterLocator-819"><a href="#CenterLocator-819"><span class="linenos">819</span></a>                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.98</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> 
</span><span id="CenterLocator-820"><a href="#CenterLocator-820"><span class="linenos">820</span></a>                  <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="CenterLocator-821"><a href="#CenterLocator-821"><span class="linenos">821</span></a>    
</span><span id="CenterLocator-822"><a href="#CenterLocator-822"><span class="linenos">822</span></a>        <span class="c1"># Remove axes (= tick and ticklabels) around the diffractogram</span>
</span><span id="CenterLocator-823"><a href="#CenterLocator-823"><span class="linenos">823</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-824"><a href="#CenterLocator-824"><span class="linenos">824</span></a>        
</span><span id="CenterLocator-825"><a href="#CenterLocator-825"><span class="linenos">825</span></a>        <span class="c1"># Plot only the central square region if requested</span>
</span><span id="CenterLocator-826"><a href="#CenterLocator-826"><span class="linenos">826</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-827"><a href="#CenterLocator-827"><span class="linenos">827</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
</span><span id="CenterLocator-828"><a href="#CenterLocator-828"><span class="linenos">828</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
</span><span id="CenterLocator-829"><a href="#CenterLocator-829"><span class="linenos">829</span></a>        
</span><span id="CenterLocator-830"><a href="#CenterLocator-830"><span class="linenos">830</span></a>        <span class="c1"># Save the result to output file if requested</span>
</span><span id="CenterLocator-831"><a href="#CenterLocator-831"><span class="linenos">831</span></a>        <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-832"><a href="#CenterLocator-832"><span class="linenos">832</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">out_dpi</span><span class="p">)</span>
</span><span id="CenterLocator-833"><a href="#CenterLocator-833"><span class="linenos">833</span></a>        
</span><span id="CenterLocator-834"><a href="#CenterLocator-834"><span class="linenos">834</span></a>        <span class="c1"># Show the plot on screen</span>
</span><span id="CenterLocator-835"><a href="#CenterLocator-835"><span class="linenos">835</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterLocator-836"><a href="#CenterLocator-836"><span class="linenos">836</span></a>
</span><span id="CenterLocator-837"><a href="#CenterLocator-837"><span class="linenos">837</span></a>
</span><span id="CenterLocator-838"><a href="#CenterLocator-838"><span class="linenos">838</span></a>    <span class="k">def</span> <span class="nf">ellipse_distortion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CenterLocator-839"><a href="#CenterLocator-839"><span class="linenos">839</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-840"><a href="#CenterLocator-840"><span class="linenos">840</span></a><span class="sd">        Corrects elliptical distortion in an image by transforming 4 distorted </span>
</span><span id="CenterLocator-841"><a href="#CenterLocator-841"><span class="linenos">841</span></a><span class="sd">        points (which should ideally lie on a circle) to lie on a true circle.</span>
</span><span id="CenterLocator-842"><a href="#CenterLocator-842"><span class="linenos">842</span></a><span class="sd">    </span>
</span><span id="CenterLocator-843"><a href="#CenterLocator-843"><span class="linenos">843</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-844"><a href="#CenterLocator-844"><span class="linenos">844</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-845"><a href="#CenterLocator-845"><span class="linenos">845</span></a><span class="sd">        img : np.ndarray</span>
</span><span id="CenterLocator-846"><a href="#CenterLocator-846"><span class="linenos">846</span></a><span class="sd">            Input image (2D numpy array) containing an elliptical diffraction </span>
</span><span id="CenterLocator-847"><a href="#CenterLocator-847"><span class="linenos">847</span></a><span class="sd">            pattern.</span>
</span><span id="CenterLocator-848"><a href="#CenterLocator-848"><span class="linenos">848</span></a><span class="sd">        </span>
</span><span id="CenterLocator-849"><a href="#CenterLocator-849"><span class="linenos">849</span></a><span class="sd">        show : bool, optional</span>
</span><span id="CenterLocator-850"><a href="#CenterLocator-850"><span class="linenos">850</span></a><span class="sd">            If True, displays the original and corrected images. </span>
</span><span id="CenterLocator-851"><a href="#CenterLocator-851"><span class="linenos">851</span></a><span class="sd">            Default is True.</span>
</span><span id="CenterLocator-852"><a href="#CenterLocator-852"><span class="linenos">852</span></a><span class="sd">        </span>
</span><span id="CenterLocator-853"><a href="#CenterLocator-853"><span class="linenos">853</span></a><span class="sd">        method : str, optional</span>
</span><span id="CenterLocator-854"><a href="#CenterLocator-854"><span class="linenos">854</span></a><span class="sd">            Point selection method: &#39;manual&#39; or &#39;auto&#39;.</span>
</span><span id="CenterLocator-855"><a href="#CenterLocator-855"><span class="linenos">855</span></a><span class="sd">            - &#39;manual&#39;: User clicks four points on the image.</span>
</span><span id="CenterLocator-856"><a href="#CenterLocator-856"><span class="linenos">856</span></a><span class="sd">            - &#39;auto&#39;: Automatically detects the four brightest Bragg spots </span>
</span><span id="CenterLocator-857"><a href="#CenterLocator-857"><span class="linenos">857</span></a><span class="sd">              (not yet implemented).</span>
</span><span id="CenterLocator-858"><a href="#CenterLocator-858"><span class="linenos">858</span></a><span class="sd">    </span>
</span><span id="CenterLocator-859"><a href="#CenterLocator-859"><span class="linenos">859</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-860"><a href="#CenterLocator-860"><span class="linenos">860</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-861"><a href="#CenterLocator-861"><span class="linenos">861</span></a><span class="sd">        corrected : np.ndarray</span>
</span><span id="CenterLocator-862"><a href="#CenterLocator-862"><span class="linenos">862</span></a><span class="sd">            The distortion-corrected image.</span>
</span><span id="CenterLocator-863"><a href="#CenterLocator-863"><span class="linenos">863</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator-864"><a href="#CenterLocator-864"><span class="linenos">864</span></a>            
</span><span id="CenterLocator-865"><a href="#CenterLocator-865"><span class="linenos">865</span></a>        <span class="c1"># Helper function</span>
</span><span id="CenterLocator-866"><a href="#CenterLocator-866"><span class="linenos">866</span></a>        <span class="k">def</span> <span class="nf">refine_to_local_max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="CenterLocator-867"><a href="#CenterLocator-867"><span class="linenos">867</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-868"><a href="#CenterLocator-868"><span class="linenos">868</span></a><span class="sd">            Refine a point to the local maximum intensity within a neighborhood.</span>
</span><span id="CenterLocator-869"><a href="#CenterLocator-869"><span class="linenos">869</span></a><span class="sd">        </span>
</span><span id="CenterLocator-870"><a href="#CenterLocator-870"><span class="linenos">870</span></a><span class="sd">            This function searches for the brightest (maximum intensity) pixel</span>
</span><span id="CenterLocator-871"><a href="#CenterLocator-871"><span class="linenos">871</span></a><span class="sd">            within a square window centered around a given point. It is typi-</span>
</span><span id="CenterLocator-872"><a href="#CenterLocator-872"><span class="linenos">872</span></a><span class="sd">            cally used to improve the accuracy of an estimated center by snap-</span>
</span><span id="CenterLocator-873"><a href="#CenterLocator-873"><span class="linenos">873</span></a><span class="sd">            ping it to the nearest local maximum.</span>
</span><span id="CenterLocator-874"><a href="#CenterLocator-874"><span class="linenos">874</span></a><span class="sd">        </span>
</span><span id="CenterLocator-875"><a href="#CenterLocator-875"><span class="linenos">875</span></a><span class="sd">            Parameters</span>
</span><span id="CenterLocator-876"><a href="#CenterLocator-876"><span class="linenos">876</span></a><span class="sd">            ----------</span>
</span><span id="CenterLocator-877"><a href="#CenterLocator-877"><span class="linenos">877</span></a><span class="sd">            img : ndarray</span>
</span><span id="CenterLocator-878"><a href="#CenterLocator-878"><span class="linenos">878</span></a><span class="sd">                2D array (grayscale) in which the local maximum is to be found.</span>
</span><span id="CenterLocator-879"><a href="#CenterLocator-879"><span class="linenos">879</span></a><span class="sd">                </span>
</span><span id="CenterLocator-880"><a href="#CenterLocator-880"><span class="linenos">880</span></a><span class="sd">            pt : array-like of float</span>
</span><span id="CenterLocator-881"><a href="#CenterLocator-881"><span class="linenos">881</span></a><span class="sd">                Initial (x, y) point coordinates around which the local maximum </span>
</span><span id="CenterLocator-882"><a href="#CenterLocator-882"><span class="linenos">882</span></a><span class="sd">                is searched.</span>
</span><span id="CenterLocator-883"><a href="#CenterLocator-883"><span class="linenos">883</span></a><span class="sd">                </span>
</span><span id="CenterLocator-884"><a href="#CenterLocator-884"><span class="linenos">884</span></a><span class="sd">            window : int, optional</span>
</span><span id="CenterLocator-885"><a href="#CenterLocator-885"><span class="linenos">885</span></a><span class="sd">                Size of the square window for the local search (default is 9).</span>
</span><span id="CenterLocator-886"><a href="#CenterLocator-886"><span class="linenos">886</span></a><span class="sd">                The actual window will be `window x window` pixels, </span>
</span><span id="CenterLocator-887"><a href="#CenterLocator-887"><span class="linenos">887</span></a><span class="sd">                centered at `pt`.</span>
</span><span id="CenterLocator-888"><a href="#CenterLocator-888"><span class="linenos">888</span></a><span class="sd">        </span>
</span><span id="CenterLocator-889"><a href="#CenterLocator-889"><span class="linenos">889</span></a><span class="sd">            Returns</span>
</span><span id="CenterLocator-890"><a href="#CenterLocator-890"><span class="linenos">890</span></a><span class="sd">            -------</span>
</span><span id="CenterLocator-891"><a href="#CenterLocator-891"><span class="linenos">891</span></a><span class="sd">            refined_pt : ndarray of float</span>
</span><span id="CenterLocator-892"><a href="#CenterLocator-892"><span class="linenos">892</span></a><span class="sd">                Refined point coordinates [x, y] corresponding to the brightest </span>
</span><span id="CenterLocator-893"><a href="#CenterLocator-893"><span class="linenos">893</span></a><span class="sd">                pixel in the local window.</span>
</span><span id="CenterLocator-894"><a href="#CenterLocator-894"><span class="linenos">894</span></a><span class="sd">        </span>
</span><span id="CenterLocator-895"><a href="#CenterLocator-895"><span class="linenos">895</span></a><span class="sd">            Notes</span>
</span><span id="CenterLocator-896"><a href="#CenterLocator-896"><span class="linenos">896</span></a><span class="sd">            -----</span>
</span><span id="CenterLocator-897"><a href="#CenterLocator-897"><span class="linenos">897</span></a><span class="sd">            - If the window overlaps the image boundaries, it is clipped </span>
</span><span id="CenterLocator-898"><a href="#CenterLocator-898"><span class="linenos">898</span></a><span class="sd">              appropriately.</span>
</span><span id="CenterLocator-899"><a href="#CenterLocator-899"><span class="linenos">899</span></a><span class="sd">            - If the window is completely outside the image, the original point </span>
</span><span id="CenterLocator-900"><a href="#CenterLocator-900"><span class="linenos">900</span></a><span class="sd">              is returned.</span>
</span><span id="CenterLocator-901"><a href="#CenterLocator-901"><span class="linenos">901</span></a><span class="sd">            - Assumption : `img` uses (row, column) = (y, x) indexing.</span>
</span><span id="CenterLocator-902"><a href="#CenterLocator-902"><span class="linenos">902</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterLocator-903"><a href="#CenterLocator-903"><span class="linenos">903</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="CenterLocator-904"><a href="#CenterLocator-904"><span class="linenos">904</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">window</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator-905"><a href="#CenterLocator-905"><span class="linenos">905</span></a>            <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-906"><a href="#CenterLocator-906"><span class="linenos">906</span></a>            <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-907"><a href="#CenterLocator-907"><span class="linenos">907</span></a>    
</span><span id="CenterLocator-908"><a href="#CenterLocator-908"><span class="linenos">908</span></a>            <span class="n">local</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
</span><span id="CenterLocator-909"><a href="#CenterLocator-909"><span class="linenos">909</span></a>            <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterLocator-910"><a href="#CenterLocator-910"><span class="linenos">910</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator-911"><a href="#CenterLocator-911"><span class="linenos">911</span></a>    
</span><span id="CenterLocator-912"><a href="#CenterLocator-912"><span class="linenos">912</span></a>            <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="n">local</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="CenterLocator-913"><a href="#CenterLocator-913"><span class="linenos">913</span></a>            <span class="n">refined_x</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="n">dx</span>
</span><span id="CenterLocator-914"><a href="#CenterLocator-914"><span class="linenos">914</span></a>            <span class="n">refined_y</span> <span class="o">=</span> <span class="n">y_min</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterLocator-915"><a href="#CenterLocator-915"><span class="linenos">915</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">refined_x</span><span class="p">,</span> <span class="n">refined_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator-916"><a href="#CenterLocator-916"><span class="linenos">916</span></a>        
</span><span id="CenterLocator-917"><a href="#CenterLocator-917"><span class="linenos">917</span></a>        <span class="c1"># Elliptical correction workflow --------------------------------------</span>
</span><span id="CenterLocator-918"><a href="#CenterLocator-918"><span class="linenos">918</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterLocator-919"><a href="#CenterLocator-919"><span class="linenos">919</span></a>    
</span><span id="CenterLocator-920"><a href="#CenterLocator-920"><span class="linenos">920</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterLocator-921"><a href="#CenterLocator-921"><span class="linenos">921</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only user-assisted (&#39;manual&#39;) correction available.&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-922"><a href="#CenterLocator-922"><span class="linenos">922</span></a>            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;manual&quot;</span>
</span><span id="CenterLocator-923"><a href="#CenterLocator-923"><span class="linenos">923</span></a>    
</span><span id="CenterLocator-924"><a href="#CenterLocator-924"><span class="linenos">924</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
</span><span id="CenterLocator-925"><a href="#CenterLocator-925"><span class="linenos">925</span></a>            <span class="c1"># Manual point selection</span>
</span><span id="CenterLocator-926"><a href="#CenterLocator-926"><span class="linenos">926</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator-927"><a href="#CenterLocator-927"><span class="linenos">927</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Click 4 distorted points (in circular order)&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-928"><a href="#CenterLocator-928"><span class="linenos">928</span></a>            <span class="n">raw_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator-929"><a href="#CenterLocator-929"><span class="linenos">929</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="CenterLocator-930"><a href="#CenterLocator-930"><span class="linenos">930</span></a>    
</span><span id="CenterLocator-931"><a href="#CenterLocator-931"><span class="linenos">931</span></a>            <span class="c1"># Refine each point to local max</span>
</span><span id="CenterLocator-932"><a href="#CenterLocator-932"><span class="linenos">932</span></a>            <span class="n">distorted_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="CenterLocator-933"><a href="#CenterLocator-933"><span class="linenos">933</span></a>                <span class="n">refine_to_local_max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">raw_pts</span>
</span><span id="CenterLocator-934"><a href="#CenterLocator-934"><span class="linenos">934</span></a>            <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator-935"><a href="#CenterLocator-935"><span class="linenos">935</span></a>    
</span><span id="CenterLocator-936"><a href="#CenterLocator-936"><span class="linenos">936</span></a>        <span class="c1"># Compute center and average radius</span>
</span><span id="CenterLocator-937"><a href="#CenterLocator-937"><span class="linenos">937</span></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distorted_pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CenterLocator-938"><a href="#CenterLocator-938"><span class="linenos">938</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">distorted_pts</span> <span class="o">-</span> <span class="n">center</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-939"><a href="#CenterLocator-939"><span class="linenos">939</span></a>        <span class="n">avg_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
</span><span id="CenterLocator-940"><a href="#CenterLocator-940"><span class="linenos">940</span></a>    
</span><span id="CenterLocator-941"><a href="#CenterLocator-941"><span class="linenos">941</span></a>        <span class="c1"># Target points evenly on circle</span>
</span><span id="CenterLocator-942"><a href="#CenterLocator-942"><span class="linenos">942</span></a>        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-943"><a href="#CenterLocator-943"><span class="linenos">943</span></a>        <span class="n">circle_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
</span><span id="CenterLocator-944"><a href="#CenterLocator-944"><span class="linenos">944</span></a>            <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">avg_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
</span><span id="CenterLocator-945"><a href="#CenterLocator-945"><span class="linenos">945</span></a>            <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">avg_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
</span><span id="CenterLocator-946"><a href="#CenterLocator-946"><span class="linenos">946</span></a>        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator-947"><a href="#CenterLocator-947"><span class="linenos">947</span></a>    
</span><span id="CenterLocator-948"><a href="#CenterLocator-948"><span class="linenos">948</span></a>        <span class="c1"># Perspective transform</span>
</span><span id="CenterLocator-949"><a href="#CenterLocator-949"><span class="linenos">949</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">distorted_pts</span><span class="p">,</span> <span class="n">circle_pts</span><span class="p">)</span>
</span><span id="CenterLocator-950"><a href="#CenterLocator-950"><span class="linenos">950</span></a>        
</span><span id="CenterLocator-951"><a href="#CenterLocator-951"><span class="linenos">951</span></a>        <span class="c1"># Make output square by padding the image to max_dim x max_dim</span>
</span><span id="CenterLocator-952"><a href="#CenterLocator-952"><span class="linenos">952</span></a>        <span class="n">max_dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="CenterLocator-953"><a href="#CenterLocator-953"><span class="linenos">953</span></a>        
</span><span id="CenterLocator-954"><a href="#CenterLocator-954"><span class="linenos">954</span></a>        <span class="c1"># Compute offset to center the original image content in the square </span>
</span><span id="CenterLocator-955"><a href="#CenterLocator-955"><span class="linenos">955</span></a>        <span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_dim</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator-956"><a href="#CenterLocator-956"><span class="linenos">956</span></a>        <span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_dim</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator-957"><a href="#CenterLocator-957"><span class="linenos">957</span></a>        
</span><span id="CenterLocator-958"><a href="#CenterLocator-958"><span class="linenos">958</span></a>        <span class="c1"># Create a translation matrix to shift image content to center</span>
</span><span id="CenterLocator-959"><a href="#CenterLocator-959"><span class="linenos">959</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="CenterLocator-960"><a href="#CenterLocator-960"><span class="linenos">960</span></a>            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">],</span>
</span><span id="CenterLocator-961"><a href="#CenterLocator-961"><span class="linenos">961</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">],</span>
</span><span id="CenterLocator-962"><a href="#CenterLocator-962"><span class="linenos">962</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-963"><a href="#CenterLocator-963"><span class="linenos">963</span></a>        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator-964"><a href="#CenterLocator-964"><span class="linenos">964</span></a>        
</span><span id="CenterLocator-965"><a href="#CenterLocator-965"><span class="linenos">965</span></a>        <span class="c1"># Combine the original homography with the translation</span>
</span><span id="CenterLocator-966"><a href="#CenterLocator-966"><span class="linenos">966</span></a>        <span class="n">H_total</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">H</span>  <span class="c1"># Matrix multiplication</span>
</span><span id="CenterLocator-967"><a href="#CenterLocator-967"><span class="linenos">967</span></a>        
</span><span id="CenterLocator-968"><a href="#CenterLocator-968"><span class="linenos">968</span></a>        <span class="c1"># Apply the combined transformation</span>
</span><span id="CenterLocator-969"><a href="#CenterLocator-969"><span class="linenos">969</span></a>        <span class="n">corrected</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span>
</span><span id="CenterLocator-970"><a href="#CenterLocator-970"><span class="linenos">970</span></a>            <span class="n">img</span><span class="p">,</span> <span class="n">H_total</span><span class="p">,</span> <span class="p">(</span><span class="n">max_dim</span><span class="p">,</span> <span class="n">max_dim</span><span class="p">),</span>
</span><span id="CenterLocator-971"><a href="#CenterLocator-971"><span class="linenos">971</span></a>            <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span>
</span><span id="CenterLocator-972"><a href="#CenterLocator-972"><span class="linenos">972</span></a>            <span class="n">borderValue</span><span class="o">=</span><span class="mi">0</span>
</span><span id="CenterLocator-973"><a href="#CenterLocator-973"><span class="linenos">973</span></a>        <span class="p">)</span>
</span><span id="CenterLocator-974"><a href="#CenterLocator-974"><span class="linenos">974</span></a>
</span><span id="CenterLocator-975"><a href="#CenterLocator-975"><span class="linenos">975</span></a>        <span class="c1"># Show results</span>
</span><span id="CenterLocator-976"><a href="#CenterLocator-976"><span class="linenos">976</span></a>        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
</span><span id="CenterLocator-977"><a href="#CenterLocator-977"><span class="linenos">977</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="CenterLocator-978"><a href="#CenterLocator-978"><span class="linenos">978</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-979"><a href="#CenterLocator-979"><span class="linenos">979</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original with refined points&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-980"><a href="#CenterLocator-980"><span class="linenos">980</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator-981"><a href="#CenterLocator-981"><span class="linenos">981</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">distorted_pts</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
</span><span id="CenterLocator-982"><a href="#CenterLocator-982"><span class="linenos">982</span></a>    
</span><span id="CenterLocator-983"><a href="#CenterLocator-983"><span class="linenos">983</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterLocator-984"><a href="#CenterLocator-984"><span class="linenos">984</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Corrected image&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-985"><a href="#CenterLocator-985"><span class="linenos">985</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator-986"><a href="#CenterLocator-986"><span class="linenos">986</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterLocator-987"><a href="#CenterLocator-987"><span class="linenos">987</span></a>    
</span><span id="CenterLocator-988"><a href="#CenterLocator-988"><span class="linenos">988</span></a>        <span class="k">return</span> <span class="n">corrected</span>
</span></pre></div>


            <div class="docstring"><p>CenterLocator object : determine and refine the center of a 2D electron 
diffraction pattern (diffractogram)</p>

<p>This class detects the center of diffraction patterns. It offers several 
automatic or manual methods and optionally refines the center position.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_image</strong> (str, path, or numpy.ndarray):
The input 2D diffraction image, either a file path or a NumPy array.</li>
<li><strong>determination</strong> (str or None, optional, default=None):
Method used for the initial center determination.
Options include:
<ul>
<li>'manual': Manual detection = interactive plot where the user
selects 3 points defining a diffraction ring with a mouse.</li>
<li>'intensity' : Auto-detection = the intensity center
from the central region.</li>
<li>'curvefit': Automatic detection = fit the intensity center
from the central region using pseudo-Voigt profile.                      </li>
<li>'hough' : Automatic detection using Hough transform
to find center of ring-like structures.</li>
<li>'phase' : Automatic detection using phase correlation
to find the symmetry center.</li>
<li>'ccorr' : Automatic detection using cross-correlation
to find the symmetry center.</li>
<li>None : Skip the center determination;
it is supposed that the center coordinates
will be read from <em>in_file</em> argument - see below.</li>
</ul></li>
<li><strong>refinement</strong> (str or None, optional, default=None):
Method used for refining the initially detected center.
Options include:
<ul>
<li>'manual': Manual fine-tuning of the center along
the selected diffraction ring.</li>
<li>'sum' : Automatic refinement by maximizing the intensity sum
the selected diffraction ring.</li>
<li>'var': Automatic refinement by minimizing intensity variance
the selected diffraction ring.</li>
</ul></li>
<li><strong>rtype</strong> (int, default=1):
How to determine a radius of a difraction ring for center refinement.
In powder diffractograms, the diffraction rings are clearly defined.
In spotty diffractograms, the diffraction ring is an fictive ring
connecting at least three diffraction spots.
Options include:
<ul>
<li>0 : Peak matching method
(fast and simple, but failing for non-powders, historical).</li>
<li>1 : Radial distribution method
(slower but more universal, new default).</li>
</ul></li>
<li><strong>in_file</strong> (str or None, optional, default=None):
Path to a file from which the (previously saved)
center coordinates will be loaded.</li>
<li><strong>out_file</strong> (str or None, optional, default=None):
Path to a file where the determined
center coordinates will be saved.</li>
<li><strong>sobel</strong> (bool, optional, default=False):
If True, apply Sobel filter to the image before processing.</li>
<li><strong>heq</strong> (bool or None, optional, default=False):
If True, apply histogram equalization internally (display unchanged).</li>
<li><strong>icut</strong> (float or None, optional, default=None):
Cut-off intensity level for processing the image.</li>
<li><strong>cmap</strong> (str, optional, default='gray'):
Matplotlib colormap name used for displaying the image.</li>
<li><strong>csquare</strong> (int, optional, default=50):
Size (in pixels) of the central square used for initial center search.</li>
<li><strong>cintensity</strong> (float, optional, default=0.8):
Threshold intensity for finding the intensity center. Pixels with a 
(relative) intensity lower than cintensity are ignored.</li>
<li><strong>verbose</strong> (int, optional, default=0):
Verbosity level for printing messages during processing:
<ul>
<li>0 : Silent mode — no messages are printed.</li>
<li>1 : Show help messages during manual refinement only.</li>
<li>2 : Full verbose mode — print all messages and debug information.</li>
<li>3 : Progress mode — print brief status updates during time-consuming 
processing.</li>
</ul></li>
<li><strong>print_sums</strong> (bool, optional, default=False):
If True, print intensity sums after each adjustment (in manual modes).</li>
<li><strong>final_print</strong> (bool, optional, default=True):
If True, print final coordinates to stdout.</li>
<li><strong>live_plot</strong> (bool, optional, default=True):
If True, show live visualization of some processes if available.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong>: The result is stored in the instance variables:
<ul>
<li><code>(x1, y1)</code> for the initially determined center</li>
<li><code>(x2, y2)</code> for the refined center (if refinement is applied)</li>
</ul></li>
</ul>

<h6 id="technical-notes">Technical notes</h6>

<ul>
<li>The class automatically initializes and uses two internal components:
<code><a href="#CenterDetermination">CenterDetermination</a></code> and <code><a href="#CenterRefinement">CenterRefinement</a></code>.</li>
<li>These internal processes are hidden from the user but can be accessed 
directly if needed.</li>
</ul>

<h6 id="examples">Examples</h6>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ediff</span> <span class="k">as</span> <span class="nn">ed</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">locator</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">CenterLocator</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">input_image</span>   <span class="o">=</span> <span class="s1">&#39;.r/path/to/your/data.png&#39;</span><span class="p">,</span>   
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">determination</span> <span class="o">=</span> <span class="s1">&#39;manual&#39;</span><span class="p">,</span>           
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">refinement</span>    <span class="o">=</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">final_print</span>   <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre>
</div>
</div>


                            <div id="CenterLocator.output" class="classattr">
                                        <input id="CenterLocator.output-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">output</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.output-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.output"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.output-405"><a href="#CenterLocator.output-405"><span class="linenos">405</span></a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator.output-406"><a href="#CenterLocator.output-406"><span class="linenos">406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.output-407"><a href="#CenterLocator.output-407"><span class="linenos">407</span></a><span class="sd">        Return the final results of center determination and refinement. </span>
</span><span id="CenterLocator.output-408"><a href="#CenterLocator.output-408"><span class="linenos">408</span></a><span class="sd">        </span>
</span><span id="CenterLocator.output-409"><a href="#CenterLocator.output-409"><span class="linenos">409</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.output-410"><a href="#CenterLocator.output-410"><span class="linenos">410</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.output-411"><a href="#CenterLocator.output-411"><span class="linenos">411</span></a><span class="sd">        x1 : float</span>
</span><span id="CenterLocator.output-412"><a href="#CenterLocator.output-412"><span class="linenos">412</span></a><span class="sd">            x-coordinate of the center determined by the *determination* method.</span>
</span><span id="CenterLocator.output-413"><a href="#CenterLocator.output-413"><span class="linenos">413</span></a><span class="sd">            </span>
</span><span id="CenterLocator.output-414"><a href="#CenterLocator.output-414"><span class="linenos">414</span></a><span class="sd">        y1 : float</span>
</span><span id="CenterLocator.output-415"><a href="#CenterLocator.output-415"><span class="linenos">415</span></a><span class="sd">            y-coordinate of the center determined by the *determination* method.</span>
</span><span id="CenterLocator.output-416"><a href="#CenterLocator.output-416"><span class="linenos">416</span></a><span class="sd">        </span>
</span><span id="CenterLocator.output-417"><a href="#CenterLocator.output-417"><span class="linenos">417</span></a><span class="sd">        x2 : float</span>
</span><span id="CenterLocator.output-418"><a href="#CenterLocator.output-418"><span class="linenos">418</span></a><span class="sd">            x-coordinate of the center after *refinement*, or same as x1 if no </span>
</span><span id="CenterLocator.output-419"><a href="#CenterLocator.output-419"><span class="linenos">419</span></a><span class="sd">            refinement was used.</span>
</span><span id="CenterLocator.output-420"><a href="#CenterLocator.output-420"><span class="linenos">420</span></a><span class="sd">        </span>
</span><span id="CenterLocator.output-421"><a href="#CenterLocator.output-421"><span class="linenos">421</span></a><span class="sd">        y2 : float</span>
</span><span id="CenterLocator.output-422"><a href="#CenterLocator.output-422"><span class="linenos">422</span></a><span class="sd">            y-coordinate of the center after *refinement*, or same as y1 if no </span>
</span><span id="CenterLocator.output-423"><a href="#CenterLocator.output-423"><span class="linenos">423</span></a><span class="sd">            refinement was used.</span>
</span><span id="CenterLocator.output-424"><a href="#CenterLocator.output-424"><span class="linenos">424</span></a>
</span><span id="CenterLocator.output-425"><a href="#CenterLocator.output-425"><span class="linenos">425</span></a><span class="sd">            </span>
</span><span id="CenterLocator.output-426"><a href="#CenterLocator.output-426"><span class="linenos">426</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator.output-427"><a href="#CenterLocator.output-427"><span class="linenos">427</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator.output-428"><a href="#CenterLocator.output-428"><span class="linenos">428</span></a><span class="sd">        - The function always returns four values: (x1, y1, x2, y2).</span>
</span><span id="CenterLocator.output-429"><a href="#CenterLocator.output-429"><span class="linenos">429</span></a><span class="sd">        - If no refinement method was used (`refinement=None`), then (x2, y2) </span>
</span><span id="CenterLocator.output-430"><a href="#CenterLocator.output-430"><span class="linenos">430</span></a><span class="sd">          will be equal to (x1, y1).</span>
</span><span id="CenterLocator.output-431"><a href="#CenterLocator.output-431"><span class="linenos">431</span></a><span class="sd">        - All values are rounded to one decimal place before returning.</span>
</span><span id="CenterLocator.output-432"><a href="#CenterLocator.output-432"><span class="linenos">432</span></a><span class="sd">        - Coordinates are internally converted to float to ensure consistency </span>
</span><span id="CenterLocator.output-433"><a href="#CenterLocator.output-433"><span class="linenos">433</span></a><span class="sd">          in output.</span>
</span><span id="CenterLocator.output-434"><a href="#CenterLocator.output-434"><span class="linenos">434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator.output-435"><a href="#CenterLocator.output-435"><span class="linenos">435</span></a>        
</span><span id="CenterLocator.output-436"><a href="#CenterLocator.output-436"><span class="linenos">436</span></a>        <span class="c1"># (1) refinement=None -------------------------------------------------</span>
</span><span id="CenterLocator.output-437"><a href="#CenterLocator.output-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterLocator.output-438"><a href="#CenterLocator.output-438"><span class="linenos">438</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator.output-439"><a href="#CenterLocator.output-439"><span class="linenos">439</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator.output-440"><a href="#CenterLocator.output-440"><span class="linenos">440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> \
</span><span id="CenterLocator.output-441"><a href="#CenterLocator.output-441"><span class="linenos">441</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> 
</span><span id="CenterLocator.output-442"><a href="#CenterLocator.output-442"><span class="linenos">442</span></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)]</span>
</span><span id="CenterLocator.output-443"><a href="#CenterLocator.output-443"><span class="linenos">443</span></a>                    
</span><span id="CenterLocator.output-444"><a href="#CenterLocator.output-444"><span class="linenos">444</span></a>        <span class="c1"># (2) refinement!=None ------------------------------------------------</span>
</span><span id="CenterLocator.output-445"><a href="#CenterLocator.output-445"><span class="linenos">445</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.output-446"><a href="#CenterLocator.output-446"><span class="linenos">446</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator.output-447"><a href="#CenterLocator.output-447"><span class="linenos">447</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator.output-448"><a href="#CenterLocator.output-448"><span class="linenos">448</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> \
</span><span id="CenterLocator.output-449"><a href="#CenterLocator.output-449"><span class="linenos">449</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)]</span>
</span><span id="CenterLocator.output-450"><a href="#CenterLocator.output-450"><span class="linenos">450</span></a>            <span class="c1"># Define x2,y2 = x1,y1</span>
</span><span id="CenterLocator.output-451"><a href="#CenterLocator.output-451"><span class="linenos">451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
</span><span id="CenterLocator.output-452"><a href="#CenterLocator.output-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span>
</span><span id="CenterLocator.output-453"><a href="#CenterLocator.output-453"><span class="linenos">453</span></a>            
</span><span id="CenterLocator.output-454"><a href="#CenterLocator.output-454"><span class="linenos">454</span></a>        <span class="c1"># (3) Return (rounded) values of center coordinates -------------------</span>
</span><span id="CenterLocator.output-455"><a href="#CenterLocator.output-455"><span class="linenos">455</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
</span><span id="CenterLocator.output-456"><a href="#CenterLocator.output-456"><span class="linenos">456</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span></pre></div>


            <div class="docstring"><p>Return the final results of center determination and refinement. </p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>x1</strong> (float):
x-coordinate of the center determined by the <em>determination</em> method.</li>
<li><strong>y1</strong> (float):
y-coordinate of the center determined by the <em>determination</em> method.</li>
<li><strong>x2</strong> (float):
x-coordinate of the center after <em>refinement</em>, or same as x1 if no 
refinement was used.</li>
<li><strong>y2</strong> (float):
y-coordinate of the center after <em>refinement</em>, or same as y1 if no 
refinement was used.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The function always returns four values: (x1, y1, x2, y2).</li>
<li>If no refinement method was used (<code>refinement=None</code>), then (x2, y2) 
will be equal to (x1, y1).</li>
<li>All values are rounded to one decimal place before returning.</li>
<li>Coordinates are internally converted to float to ensure consistency 
in output.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.save_results" class="classattr">
                                        <input id="CenterLocator.save_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_results</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.save_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.save_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.save_results-459"><a href="#CenterLocator.save_results-459"><span class="linenos">459</span></a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator.save_results-460"><a href="#CenterLocator.save_results-460"><span class="linenos">460</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator.save_results-461"><a href="#CenterLocator.save_results-461"><span class="linenos">461</span></a><span class="sd">        Save the determined and refined center coordinates to a file.</span>
</span><span id="CenterLocator.save_results-462"><a href="#CenterLocator.save_results-462"><span class="linenos">462</span></a><span class="sd">    </span>
</span><span id="CenterLocator.save_results-463"><a href="#CenterLocator.save_results-463"><span class="linenos">463</span></a><span class="sd">        This method writes the coordinates (x1, y1) from the *determination*</span>
</span><span id="CenterLocator.save_results-464"><a href="#CenterLocator.save_results-464"><span class="linenos">464</span></a><span class="sd">        step and (x2, y2) from the *refinement* step to a file specified by the </span>
</span><span id="CenterLocator.save_results-465"><a href="#CenterLocator.save_results-465"><span class="linenos">465</span></a><span class="sd">        `out_file` attribute.</span>
</span><span id="CenterLocator.save_results-466"><a href="#CenterLocator.save_results-466"><span class="linenos">466</span></a><span class="sd">    </span>
</span><span id="CenterLocator.save_results-467"><a href="#CenterLocator.save_results-467"><span class="linenos">467</span></a><span class="sd">        - If the file already exists, the results are appended to the end.</span>
</span><span id="CenterLocator.save_results-468"><a href="#CenterLocator.save_results-468"><span class="linenos">468</span></a><span class="sd">        - If the file does not exist, it is created and the results are written.</span>
</span><span id="CenterLocator.save_results-469"><a href="#CenterLocator.save_results-469"><span class="linenos">469</span></a><span class="sd">        - Coordinates are formatted to four decimal places for clarity.</span>
</span><span id="CenterLocator.save_results-470"><a href="#CenterLocator.save_results-470"><span class="linenos">470</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-471"><a href="#CenterLocator.save_results-471"><span class="linenos">471</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-472"><a href="#CenterLocator.save_results-472"><span class="linenos">472</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.save_results-473"><a href="#CenterLocator.save_results-473"><span class="linenos">473</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.save_results-474"><a href="#CenterLocator.save_results-474"><span class="linenos">474</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.save_results-475"><a href="#CenterLocator.save_results-475"><span class="linenos">475</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-476"><a href="#CenterLocator.save_results-476"><span class="linenos">476</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.save_results-477"><a href="#CenterLocator.save_results-477"><span class="linenos">477</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.save_results-478"><a href="#CenterLocator.save_results-478"><span class="linenos">478</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.save_results-479"><a href="#CenterLocator.save_results-479"><span class="linenos">479</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-480"><a href="#CenterLocator.save_results-480"><span class="linenos">480</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator.save_results-481"><a href="#CenterLocator.save_results-481"><span class="linenos">481</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator.save_results-482"><a href="#CenterLocator.save_results-482"><span class="linenos">482</span></a><span class="sd">        - If `self.out_file` is None, the method does nothing.</span>
</span><span id="CenterLocator.save_results-483"><a href="#CenterLocator.save_results-483"><span class="linenos">483</span></a><span class="sd">        - The results are written in the format:</span>
</span><span id="CenterLocator.save_results-484"><a href="#CenterLocator.save_results-484"><span class="linenos">484</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator.save_results-485"><a href="#CenterLocator.save_results-485"><span class="linenos">485</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator.save_results-486"><a href="#CenterLocator.save_results-486"><span class="linenos">486</span></a><span class="sd">        - This method does not raise an error if the path is invalid;</span>
</span><span id="CenterLocator.save_results-487"><a href="#CenterLocator.save_results-487"><span class="linenos">487</span></a><span class="sd">          ensure `out_file` is a valid writable path.</span>
</span><span id="CenterLocator.save_results-488"><a href="#CenterLocator.save_results-488"><span class="linenos">488</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.save_results-489"><a href="#CenterLocator.save_results-489"><span class="linenos">489</span></a>        
</span><span id="CenterLocator.save_results-490"><a href="#CenterLocator.save_results-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.save_results-491"><a href="#CenterLocator.save_results-491"><span class="linenos">491</span></a>            <span class="c1"># Check if the specified file exists</span>
</span><span id="CenterLocator.save_results-492"><a href="#CenterLocator.save_results-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">):</span>
</span><span id="CenterLocator.save_results-493"><a href="#CenterLocator.save_results-493"><span class="linenos">493</span></a>                <span class="c1"># Append results to in_file</span>
</span><span id="CenterLocator.save_results-494"><a href="#CenterLocator.save_results-494"><span class="linenos">494</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in append mode</span>
</span><span id="CenterLocator.save_results-495"><a href="#CenterLocator.save_results-495"><span class="linenos">495</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.save_results-496"><a href="#CenterLocator.save_results-496"><span class="linenos">496</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.save_results-497"><a href="#CenterLocator.save_results-497"><span class="linenos">497</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.save_results-498"><a href="#CenterLocator.save_results-498"><span class="linenos">498</span></a>                <span class="c1"># If the file does not exist, create it and write results</span>
</span><span id="CenterLocator.save_results-499"><a href="#CenterLocator.save_results-499"><span class="linenos">499</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in write mode</span>
</span><span id="CenterLocator.save_results-500"><a href="#CenterLocator.save_results-500"><span class="linenos">500</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.save_results-501"><a href="#CenterLocator.save_results-501"><span class="linenos">501</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the determined and refined center coordinates to a file.</p>

<p>This method writes the coordinates (x1, y1) from the <em>determination</em>
step and (x2, y2) from the <em>refinement</em> step to a file specified by the 
<code>out_file</code> attribute.</p>

<ul>
<li>If the file already exists, the results are appended to the end.</li>
<li>If the file does not exist, it is created and the results are written.</li>
<li>Coordinates are formatted to four decimal places for clarity.</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>If <code>self.out_file</code> is None, the method does nothing.</li>
<li>The results are written in the format:
x1: <value>, y1: <value>
x2: <value>, y2: <value></li>
<li>This method does not raise an error if the path is invalid;
ensure <code>out_file</code> is a valid writable path.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.load_results" class="classattr">
                                        <input id="CenterLocator.load_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_results</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.load_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.load_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.load_results-504"><a href="#CenterLocator.load_results-504"><span class="linenos">504</span></a>    <span class="k">def</span> <span class="nf">load_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CenterLocator.load_results-505"><a href="#CenterLocator.load_results-505"><span class="linenos">505</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.load_results-506"><a href="#CenterLocator.load_results-506"><span class="linenos">506</span></a><span class="sd">        Load center coordinates from a results file.</span>
</span><span id="CenterLocator.load_results-507"><a href="#CenterLocator.load_results-507"><span class="linenos">507</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-508"><a href="#CenterLocator.load_results-508"><span class="linenos">508</span></a><span class="sd">        This method reads a text file (defaulting to `self.in_file` or</span>
</span><span id="CenterLocator.load_results-509"><a href="#CenterLocator.load_results-509"><span class="linenos">509</span></a><span class="sd">        a provided `path`) containing previously saved center coordinates.</span>
</span><span id="CenterLocator.load_results-510"><a href="#CenterLocator.load_results-510"><span class="linenos">510</span></a><span class="sd">        It extracts coordinate pairs (x1, y1) from the determination step and</span>
</span><span id="CenterLocator.load_results-511"><a href="#CenterLocator.load_results-511"><span class="linenos">511</span></a><span class="sd">        (x2, y2) from the refinement step. All sets of values are stored</span>
</span><span id="CenterLocator.load_results-512"><a href="#CenterLocator.load_results-512"><span class="linenos">512</span></a><span class="sd">        internally, with the most recent values assigned to instance variables </span>
</span><span id="CenterLocator.load_results-513"><a href="#CenterLocator.load_results-513"><span class="linenos">513</span></a><span class="sd">        `self.x1`, `self.y1`, `self.x2`, and `self.y2`.</span>
</span><span id="CenterLocator.load_results-514"><a href="#CenterLocator.load_results-514"><span class="linenos">514</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-515"><a href="#CenterLocator.load_results-515"><span class="linenos">515</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.load_results-516"><a href="#CenterLocator.load_results-516"><span class="linenos">516</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.load_results-517"><a href="#CenterLocator.load_results-517"><span class="linenos">517</span></a><span class="sd">        path : str, optional</span>
</span><span id="CenterLocator.load_results-518"><a href="#CenterLocator.load_results-518"><span class="linenos">518</span></a><span class="sd">            Path to the results file. </span>
</span><span id="CenterLocator.load_results-519"><a href="#CenterLocator.load_results-519"><span class="linenos">519</span></a><span class="sd">            If not provided, the method uses `self.in_file`.</span>
</span><span id="CenterLocator.load_results-520"><a href="#CenterLocator.load_results-520"><span class="linenos">520</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-521"><a href="#CenterLocator.load_results-521"><span class="linenos">521</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.load_results-522"><a href="#CenterLocator.load_results-522"><span class="linenos">522</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.load_results-523"><a href="#CenterLocator.load_results-523"><span class="linenos">523</span></a><span class="sd">        tuple or None</span>
</span><span id="CenterLocator.load_results-524"><a href="#CenterLocator.load_results-524"><span class="linenos">524</span></a><span class="sd">            If `path` is provided and successfully loaded:</span>
</span><span id="CenterLocator.load_results-525"><a href="#CenterLocator.load_results-525"><span class="linenos">525</span></a><span class="sd">                (x1_values, y1_values) : Lists of all loaded x1 and y1 values.</span>
</span><span id="CenterLocator.load_results-526"><a href="#CenterLocator.load_results-526"><span class="linenos">526</span></a><span class="sd">            If loading fails:</span>
</span><span id="CenterLocator.load_results-527"><a href="#CenterLocator.load_results-527"><span class="linenos">527</span></a><span class="sd">                None</span>
</span><span id="CenterLocator.load_results-528"><a href="#CenterLocator.load_results-528"><span class="linenos">528</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-529"><a href="#CenterLocator.load_results-529"><span class="linenos">529</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator.load_results-530"><a href="#CenterLocator.load_results-530"><span class="linenos">530</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator.load_results-531"><a href="#CenterLocator.load_results-531"><span class="linenos">531</span></a><span class="sd">        - The file is expected to contain lines in the following format:</span>
</span><span id="CenterLocator.load_results-532"><a href="#CenterLocator.load_results-532"><span class="linenos">532</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator.load_results-533"><a href="#CenterLocator.load_results-533"><span class="linenos">533</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator.load_results-534"><a href="#CenterLocator.load_results-534"><span class="linenos">534</span></a><span class="sd">        - Multiple coordinate entries can be loaded; the last set is stored in</span>
</span><span id="CenterLocator.load_results-535"><a href="#CenterLocator.load_results-535"><span class="linenos">535</span></a><span class="sd">          the instance variables for easy access.</span>
</span><span id="CenterLocator.load_results-536"><a href="#CenterLocator.load_results-536"><span class="linenos">536</span></a><span class="sd">        - If the file doesn&#39;t exist or is unreadable, a warning is printed and</span>
</span><span id="CenterLocator.load_results-537"><a href="#CenterLocator.load_results-537"><span class="linenos">537</span></a><span class="sd">          the function returns None.</span>
</span><span id="CenterLocator.load_results-538"><a href="#CenterLocator.load_results-538"><span class="linenos">538</span></a><span class="sd">        &quot;&quot;&quot;</span>      
</span><span id="CenterLocator.load_results-539"><a href="#CenterLocator.load_results-539"><span class="linenos">539</span></a>        
</span><span id="CenterLocator.load_results-540"><a href="#CenterLocator.load_results-540"><span class="linenos">540</span></a>        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-541"><a href="#CenterLocator.load_results-541"><span class="linenos">541</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="CenterLocator.load_results-542"><a href="#CenterLocator.load_results-542"><span class="linenos">542</span></a>            
</span><span id="CenterLocator.load_results-543"><a href="#CenterLocator.load_results-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">):</span>
</span><span id="CenterLocator.load_results-544"><a href="#CenterLocator.load_results-544"><span class="linenos">544</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-545"><a href="#CenterLocator.load_results-545"><span class="linenos">545</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CenterLocator.load_results-546"><a href="#CenterLocator.load_results-546"><span class="linenos">546</span></a>                
</span><span id="CenterLocator.load_results-547"><a href="#CenterLocator.load_results-547"><span class="linenos">547</span></a>                <span class="c1"># Initialize lists to hold multiple values</span>
</span><span id="CenterLocator.load_results-548"><a href="#CenterLocator.load_results-548"><span class="linenos">548</span></a>                <span class="n">x1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-549"><a href="#CenterLocator.load_results-549"><span class="linenos">549</span></a>                <span class="n">y1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-550"><a href="#CenterLocator.load_results-550"><span class="linenos">550</span></a>                <span class="n">x2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-551"><a href="#CenterLocator.load_results-551"><span class="linenos">551</span></a>                <span class="n">y2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-552"><a href="#CenterLocator.load_results-552"><span class="linenos">552</span></a>    
</span><span id="CenterLocator.load_results-553"><a href="#CenterLocator.load_results-553"><span class="linenos">553</span></a>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-554"><a href="#CenterLocator.load_results-554"><span class="linenos">554</span></a>                    <span class="c1"># Strip and split each line to get the coordinates</span>
</span><span id="CenterLocator.load_results-555"><a href="#CenterLocator.load_results-555"><span class="linenos">555</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-556"><a href="#CenterLocator.load_results-556"><span class="linenos">556</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-557"><a href="#CenterLocator.load_results-557"><span class="linenos">557</span></a>                        <span class="c1"># Extract x1 and y1 or x2 and y2 based on line content</span>
</span><span id="CenterLocator.load_results-558"><a href="#CenterLocator.load_results-558"><span class="linenos">558</span></a>                        <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator.load_results-559"><a href="#CenterLocator.load_results-559"><span class="linenos">559</span></a>                            <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-560"><a href="#CenterLocator.load_results-560"><span class="linenos">560</span></a>                            <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-561"><a href="#CenterLocator.load_results-561"><span class="linenos">561</span></a>                            <span class="n">x1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-562"><a href="#CenterLocator.load_results-562"><span class="linenos">562</span></a>                            <span class="n">y1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-563"><a href="#CenterLocator.load_results-563"><span class="linenos">563</span></a>                        <span class="k">elif</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator.load_results-564"><a href="#CenterLocator.load_results-564"><span class="linenos">564</span></a>                            <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-565"><a href="#CenterLocator.load_results-565"><span class="linenos">565</span></a>                            <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-566"><a href="#CenterLocator.load_results-566"><span class="linenos">566</span></a>                            <span class="n">x2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-567"><a href="#CenterLocator.load_results-567"><span class="linenos">567</span></a>                            <span class="n">y2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-568"><a href="#CenterLocator.load_results-568"><span class="linenos">568</span></a>    
</span><span id="CenterLocator.load_results-569"><a href="#CenterLocator.load_results-569"><span class="linenos">569</span></a>                <span class="c1"># Store the last set of values as instance variables </span>
</span><span id="CenterLocator.load_results-570"><a href="#CenterLocator.load_results-570"><span class="linenos">570</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span>
</span><span id="CenterLocator.load_results-571"><a href="#CenterLocator.load_results-571"><span class="linenos">571</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span>
</span><span id="CenterLocator.load_results-572"><a href="#CenterLocator.load_results-572"><span class="linenos">572</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span>
</span><span id="CenterLocator.load_results-573"><a href="#CenterLocator.load_results-573"><span class="linenos">573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span>
</span><span id="CenterLocator.load_results-574"><a href="#CenterLocator.load_results-574"><span class="linenos">574</span></a>    
</span><span id="CenterLocator.load_results-575"><a href="#CenterLocator.load_results-575"><span class="linenos">575</span></a>                <span class="c1"># Store the last loaded values:</span>
</span><span id="CenterLocator.load_results-576"><a href="#CenterLocator.load_results-576"><span class="linenos">576</span></a>                <span class="k">if</span> <span class="n">x1_values</span> <span class="ow">and</span> <span class="n">y1_values</span> <span class="ow">and</span> <span class="n">x2_values</span> <span class="ow">and</span> <span class="n">y2_values</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-577"><a href="#CenterLocator.load_results-577"><span class="linenos">577</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-578"><a href="#CenterLocator.load_results-578"><span class="linenos">578</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-579"><a href="#CenterLocator.load_results-579"><span class="linenos">579</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-580"><a href="#CenterLocator.load_results-580"><span class="linenos">580</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-581"><a href="#CenterLocator.load_results-581"><span class="linenos">581</span></a>                    
</span><span id="CenterLocator.load_results-582"><a href="#CenterLocator.load_results-582"><span class="linenos">582</span></a>                <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-583"><a href="#CenterLocator.load_results-583"><span class="linenos">583</span></a>                    <span class="k">return</span> <span class="n">x1_values</span><span class="p">,</span> <span class="n">y1_values</span>
</span><span id="CenterLocator.load_results-584"><a href="#CenterLocator.load_results-584"><span class="linenos">584</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-585"><a href="#CenterLocator.load_results-585"><span class="linenos">585</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error reading text file with center coordinates!&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-586"><a href="#CenterLocator.load_results-586"><span class="linenos">586</span></a>            <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Load center coordinates from a results file.</p>

<p>This method reads a text file (defaulting to <code>self.in_file</code> or
a provided <code>path</code>) containing previously saved center coordinates.
It extracts coordinate pairs (x1, y1) from the determination step and
(x2, y2) from the refinement step. All sets of values are stored
internally, with the most recent values assigned to instance variables 
<code>self.x1</code>, <code>self.y1</code>, <code>self.x2</code>, and <code>self.y2</code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>path</strong> (str, optional):
Path to the results file. 
If not provided, the method uses <code>self.in_file</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>tuple or None</strong>: If <code>path</code> is provided and successfully loaded:
(x1_values, y1_values) : Lists of all loaded x1 and y1 values.
If loading fails:
None</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The file is expected to contain lines in the following format:
x1: <value>, y1: <value>
x2: <value>, y2: <value></li>
<li>Multiple coordinate entries can be loaded; the last set is stored in
the instance variables for easy access.</li>
<li>If the file doesn't exist or is unreadable, a warning is printed and
the function returns None.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.get_circle_pixels" class="classattr">
                                        <input id="CenterLocator.get_circle_pixels-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_circle_pixels</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">cx</span>, </span><span class="param"><span class="n">cy</span>, </span><span class="param"><span class="n">r</span>, </span><span class="param"><span class="n">num_points</span><span class="o">=</span><span class="mi">360</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.get_circle_pixels-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.get_circle_pixels"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.get_circle_pixels-589"><a href="#CenterLocator.get_circle_pixels-589"><span class="linenos">589</span></a>    <span class="k">def</span> <span class="nf">get_circle_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
</span><span id="CenterLocator.get_circle_pixels-590"><a href="#CenterLocator.get_circle_pixels-590"><span class="linenos">590</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.get_circle_pixels-591"><a href="#CenterLocator.get_circle_pixels-591"><span class="linenos">591</span></a><span class="sd">        Extract pixel values along a circular path in the image.</span>
</span><span id="CenterLocator.get_circle_pixels-592"><a href="#CenterLocator.get_circle_pixels-592"><span class="linenos">592</span></a><span class="sd">    </span>
</span><span id="CenterLocator.get_circle_pixels-593"><a href="#CenterLocator.get_circle_pixels-593"><span class="linenos">593</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.get_circle_pixels-594"><a href="#CenterLocator.get_circle_pixels-594"><span class="linenos">594</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.get_circle_pixels-595"><a href="#CenterLocator.get_circle_pixels-595"><span class="linenos">595</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="CenterLocator.get_circle_pixels-596"><a href="#CenterLocator.get_circle_pixels-596"><span class="linenos">596</span></a><span class="sd">            2D grayscale image from which pixel values are extracted.</span>
</span><span id="CenterLocator.get_circle_pixels-597"><a href="#CenterLocator.get_circle_pixels-597"><span class="linenos">597</span></a><span class="sd">            </span>
</span><span id="CenterLocator.get_circle_pixels-598"><a href="#CenterLocator.get_circle_pixels-598"><span class="linenos">598</span></a><span class="sd">        cx : float</span>
</span><span id="CenterLocator.get_circle_pixels-599"><a href="#CenterLocator.get_circle_pixels-599"><span class="linenos">599</span></a><span class="sd">            X-coordinate (row) of the circle center.</span>
</span><span id="CenterLocator.get_circle_pixels-600"><a href="#CenterLocator.get_circle_pixels-600"><span class="linenos">600</span></a><span class="sd">        </span>
</span><span id="CenterLocator.get_circle_pixels-601"><a href="#CenterLocator.get_circle_pixels-601"><span class="linenos">601</span></a><span class="sd">        cy : float</span>
</span><span id="CenterLocator.get_circle_pixels-602"><a href="#CenterLocator.get_circle_pixels-602"><span class="linenos">602</span></a><span class="sd">            Y-coordinate (column) of the circle center.</span>
</span><span id="CenterLocator.get_circle_pixels-603"><a href="#CenterLocator.get_circle_pixels-603"><span class="linenos">603</span></a><span class="sd">        </span>
</span><span id="CenterLocator.get_circle_pixels-604"><a href="#CenterLocator.get_circle_pixels-604"><span class="linenos">604</span></a><span class="sd">        r : float</span>
</span><span id="CenterLocator.get_circle_pixels-605"><a href="#CenterLocator.get_circle_pixels-605"><span class="linenos">605</span></a><span class="sd">            Radius of the circle.</span>
</span><span id="CenterLocator.get_circle_pixels-606"><a href="#CenterLocator.get_circle_pixels-606"><span class="linenos">606</span></a><span class="sd">        </span>
</span><span id="CenterLocator.get_circle_pixels-607"><a href="#CenterLocator.get_circle_pixels-607"><span class="linenos">607</span></a><span class="sd">        num_points : int, optional</span>
</span><span id="CenterLocator.get_circle_pixels-608"><a href="#CenterLocator.get_circle_pixels-608"><span class="linenos">608</span></a><span class="sd">            Number of points to sample along the circular path. Default is 360.</span>
</span><span id="CenterLocator.get_circle_pixels-609"><a href="#CenterLocator.get_circle_pixels-609"><span class="linenos">609</span></a><span class="sd">    </span>
</span><span id="CenterLocator.get_circle_pixels-610"><a href="#CenterLocator.get_circle_pixels-610"><span class="linenos">610</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.get_circle_pixels-611"><a href="#CenterLocator.get_circle_pixels-611"><span class="linenos">611</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.get_circle_pixels-612"><a href="#CenterLocator.get_circle_pixels-612"><span class="linenos">612</span></a><span class="sd">        pixels : np.ndarray</span>
</span><span id="CenterLocator.get_circle_pixels-613"><a href="#CenterLocator.get_circle_pixels-613"><span class="linenos">613</span></a><span class="sd">            1D array of pixel intensity values sampled along the circular path.</span>
</span><span id="CenterLocator.get_circle_pixels-614"><a href="#CenterLocator.get_circle_pixels-614"><span class="linenos">614</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator.get_circle_pixels-615"><a href="#CenterLocator.get_circle_pixels-615"><span class="linenos">615</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
</span><span id="CenterLocator.get_circle_pixels-616"><a href="#CenterLocator.get_circle_pixels-616"><span class="linenos">616</span></a>        
</span><span id="CenterLocator.get_circle_pixels-617"><a href="#CenterLocator.get_circle_pixels-617"><span class="linenos">617</span></a>        <span class="c1"># Generate coordinates for the circle</span>
</span><span id="CenterLocator.get_circle_pixels-618"><a href="#CenterLocator.get_circle_pixels-618"><span class="linenos">618</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span id="CenterLocator.get_circle_pixels-619"><a href="#CenterLocator.get_circle_pixels-619"><span class="linenos">619</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span id="CenterLocator.get_circle_pixels-620"><a href="#CenterLocator.get_circle_pixels-620"><span class="linenos">620</span></a>        
</span><span id="CenterLocator.get_circle_pixels-621"><a href="#CenterLocator.get_circle_pixels-621"><span class="linenos">621</span></a>        <span class="c1"># Use map_coordinates for accurate sub-pixel interpolation</span>
</span><span id="CenterLocator.get_circle_pixels-622"><a href="#CenterLocator.get_circle_pixels-622"><span class="linenos">622</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</span><span id="CenterLocator.get_circle_pixels-623"><a href="#CenterLocator.get_circle_pixels-623"><span class="linenos">623</span></a>        
</span><span id="CenterLocator.get_circle_pixels-624"><a href="#CenterLocator.get_circle_pixels-624"><span class="linenos">624</span></a>        <span class="c1"># &#39;order=1&#39; is linear interpolation</span>
</span><span id="CenterLocator.get_circle_pixels-625"><a href="#CenterLocator.get_circle_pixels-625"><span class="linenos">625</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterLocator.get_circle_pixels-626"><a href="#CenterLocator.get_circle_pixels-626"><span class="linenos">626</span></a>                                 <span class="n">coords</span><span class="p">,</span> 
</span><span id="CenterLocator.get_circle_pixels-627"><a href="#CenterLocator.get_circle_pixels-627"><span class="linenos">627</span></a>                                 <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterLocator.get_circle_pixels-628"><a href="#CenterLocator.get_circle_pixels-628"><span class="linenos">628</span></a>                                 <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.get_circle_pixels-629"><a href="#CenterLocator.get_circle_pixels-629"><span class="linenos">629</span></a>                                 <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="CenterLocator.get_circle_pixels-630"><a href="#CenterLocator.get_circle_pixels-630"><span class="linenos">630</span></a>        
</span><span id="CenterLocator.get_circle_pixels-631"><a href="#CenterLocator.get_circle_pixels-631"><span class="linenos">631</span></a>        <span class="c1"># Return pixels</span>
</span><span id="CenterLocator.get_circle_pixels-632"><a href="#CenterLocator.get_circle_pixels-632"><span class="linenos">632</span></a>        <span class="k">return</span> <span class="n">pixels</span>
</span></pre></div>


            <div class="docstring"><p>Extract pixel values along a circular path in the image.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>image</strong> (np.ndarray):
2D grayscale image from which pixel values are extracted.</li>
<li><strong>cx</strong> (float):
X-coordinate (row) of the circle center.</li>
<li><strong>cy</strong> (float):
Y-coordinate (column) of the circle center.</li>
<li><strong>r</strong> (float):
Radius of the circle.</li>
<li><strong>num_points</strong> (int, optional):
Number of points to sample along the circular path. Default is 360.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>pixels</strong> (np.ndarray):
1D array of pixel intensity values sampled along the circular path.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.intensity_sum" class="classattr">
                                        <input id="CenterLocator.intensity_sum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">intensity_sum</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">im</span>, </span><span class="param"><span class="n">cx</span>, </span><span class="param"><span class="n">cy</span>, </span><span class="param"><span class="n">r</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.intensity_sum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.intensity_sum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.intensity_sum-635"><a href="#CenterLocator.intensity_sum-635"><span class="linenos">635</span></a>    <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterLocator.intensity_sum-636"><a href="#CenterLocator.intensity_sum-636"><span class="linenos">636</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.intensity_sum-637"><a href="#CenterLocator.intensity_sum-637"><span class="linenos">637</span></a><span class="sd">        Compute the sum of pixel intensities along a circular path.</span>
</span><span id="CenterLocator.intensity_sum-638"><a href="#CenterLocator.intensity_sum-638"><span class="linenos">638</span></a><span class="sd">    </span>
</span><span id="CenterLocator.intensity_sum-639"><a href="#CenterLocator.intensity_sum-639"><span class="linenos">639</span></a><span class="sd">        This function extracts pixel values along a circle defined by the </span>
</span><span id="CenterLocator.intensity_sum-640"><a href="#CenterLocator.intensity_sum-640"><span class="linenos">640</span></a><span class="sd">        given center coordinates (cx, cy) and radius r, then returns </span>
</span><span id="CenterLocator.intensity_sum-641"><a href="#CenterLocator.intensity_sum-641"><span class="linenos">641</span></a><span class="sd">        the sum of these intensities.</span>
</span><span id="CenterLocator.intensity_sum-642"><a href="#CenterLocator.intensity_sum-642"><span class="linenos">642</span></a><span class="sd">    </span>
</span><span id="CenterLocator.intensity_sum-643"><a href="#CenterLocator.intensity_sum-643"><span class="linenos">643</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.intensity_sum-644"><a href="#CenterLocator.intensity_sum-644"><span class="linenos">644</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.intensity_sum-645"><a href="#CenterLocator.intensity_sum-645"><span class="linenos">645</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="CenterLocator.intensity_sum-646"><a href="#CenterLocator.intensity_sum-646"><span class="linenos">646</span></a><span class="sd">            2D grayscale image from which the intensities are extracted.</span>
</span><span id="CenterLocator.intensity_sum-647"><a href="#CenterLocator.intensity_sum-647"><span class="linenos">647</span></a><span class="sd">        </span>
</span><span id="CenterLocator.intensity_sum-648"><a href="#CenterLocator.intensity_sum-648"><span class="linenos">648</span></a><span class="sd">        cx : float</span>
</span><span id="CenterLocator.intensity_sum-649"><a href="#CenterLocator.intensity_sum-649"><span class="linenos">649</span></a><span class="sd">            X-coordinate (row) of the circle center.</span>
</span><span id="CenterLocator.intensity_sum-650"><a href="#CenterLocator.intensity_sum-650"><span class="linenos">650</span></a><span class="sd">        </span>
</span><span id="CenterLocator.intensity_sum-651"><a href="#CenterLocator.intensity_sum-651"><span class="linenos">651</span></a><span class="sd">        cy : float</span>
</span><span id="CenterLocator.intensity_sum-652"><a href="#CenterLocator.intensity_sum-652"><span class="linenos">652</span></a><span class="sd">            Y-coordinate (column) of the circle center.</span>
</span><span id="CenterLocator.intensity_sum-653"><a href="#CenterLocator.intensity_sum-653"><span class="linenos">653</span></a><span class="sd">        </span>
</span><span id="CenterLocator.intensity_sum-654"><a href="#CenterLocator.intensity_sum-654"><span class="linenos">654</span></a><span class="sd">        r : float</span>
</span><span id="CenterLocator.intensity_sum-655"><a href="#CenterLocator.intensity_sum-655"><span class="linenos">655</span></a><span class="sd">            Radius of the circle.</span>
</span><span id="CenterLocator.intensity_sum-656"><a href="#CenterLocator.intensity_sum-656"><span class="linenos">656</span></a><span class="sd">    </span>
</span><span id="CenterLocator.intensity_sum-657"><a href="#CenterLocator.intensity_sum-657"><span class="linenos">657</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.intensity_sum-658"><a href="#CenterLocator.intensity_sum-658"><span class="linenos">658</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.intensity_sum-659"><a href="#CenterLocator.intensity_sum-659"><span class="linenos">659</span></a><span class="sd">        float</span>
</span><span id="CenterLocator.intensity_sum-660"><a href="#CenterLocator.intensity_sum-660"><span class="linenos">660</span></a><span class="sd">            Sum of pixel intensities along the circular path.</span>
</span><span id="CenterLocator.intensity_sum-661"><a href="#CenterLocator.intensity_sum-661"><span class="linenos">661</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator.intensity_sum-662"><a href="#CenterLocator.intensity_sum-662"><span class="linenos">662</span></a>        <span class="c1"># Get pixel intensities</span>
</span><span id="CenterLocator.intensity_sum-663"><a href="#CenterLocator.intensity_sum-663"><span class="linenos">663</span></a>        <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_sum-664"><a href="#CenterLocator.intensity_sum-664"><span class="linenos">664</span></a>        
</span><span id="CenterLocator.intensity_sum-665"><a href="#CenterLocator.intensity_sum-665"><span class="linenos">665</span></a>        <span class="c1"># Sum pixel intensities</span>
</span><span id="CenterLocator.intensity_sum-666"><a href="#CenterLocator.intensity_sum-666"><span class="linenos">666</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the sum of pixel intensities along a circular path.</p>

<p>This function extracts pixel values along a circle defined by the 
given center coordinates (cx, cy) and radius r, then returns 
the sum of these intensities.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>im</strong> (np.ndarray):
2D grayscale image from which the intensities are extracted.</li>
<li><strong>cx</strong> (float):
X-coordinate (row) of the circle center.</li>
<li><strong>cy</strong> (float):
Y-coordinate (column) of the circle center.</li>
<li><strong>r</strong> (float):
Radius of the circle.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: Sum of pixel intensities along the circular path.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.intensity_variance" class="classattr">
                                        <input id="CenterLocator.intensity_variance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">intensity_variance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.intensity_variance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.intensity_variance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.intensity_variance-669"><a href="#CenterLocator.intensity_variance-669"><span class="linenos">669</span></a>    <span class="k">def</span> <span class="nf">intensity_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterLocator.intensity_variance-670"><a href="#CenterLocator.intensity_variance-670"><span class="linenos">670</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterLocator.intensity_variance-671"><a href="#CenterLocator.intensity_variance-671"><span class="linenos">671</span></a><span class="sd">        Variance of intensity values of pixels of a diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-672"><a href="#CenterLocator.intensity_variance-672"><span class="linenos">672</span></a>
</span><span id="CenterLocator.intensity_variance-673"><a href="#CenterLocator.intensity_variance-673"><span class="linenos">673</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.intensity_variance-674"><a href="#CenterLocator.intensity_variance-674"><span class="linenos">674</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.intensity_variance-675"><a href="#CenterLocator.intensity_variance-675"><span class="linenos">675</span></a><span class="sd">        image : array of uint8</span>
</span><span id="CenterLocator.intensity_variance-676"><a href="#CenterLocator.intensity_variance-676"><span class="linenos">676</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="CenterLocator.intensity_variance-677"><a href="#CenterLocator.intensity_variance-677"><span class="linenos">677</span></a><span class="sd">        </span>
</span><span id="CenterLocator.intensity_variance-678"><a href="#CenterLocator.intensity_variance-678"><span class="linenos">678</span></a><span class="sd">        px : float64</span>
</span><span id="CenterLocator.intensity_variance-679"><a href="#CenterLocator.intensity_variance-679"><span class="linenos">679</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-680"><a href="#CenterLocator.intensity_variance-680"><span class="linenos">680</span></a><span class="sd">        </span>
</span><span id="CenterLocator.intensity_variance-681"><a href="#CenterLocator.intensity_variance-681"><span class="linenos">681</span></a><span class="sd">        py : float64</span>
</span><span id="CenterLocator.intensity_variance-682"><a href="#CenterLocator.intensity_variance-682"><span class="linenos">682</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-683"><a href="#CenterLocator.intensity_variance-683"><span class="linenos">683</span></a><span class="sd">        </span>
</span><span id="CenterLocator.intensity_variance-684"><a href="#CenterLocator.intensity_variance-684"><span class="linenos">684</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterLocator.intensity_variance-685"><a href="#CenterLocator.intensity_variance-685"><span class="linenos">685</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-686"><a href="#CenterLocator.intensity_variance-686"><span class="linenos">686</span></a>
</span><span id="CenterLocator.intensity_variance-687"><a href="#CenterLocator.intensity_variance-687"><span class="linenos">687</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.intensity_variance-688"><a href="#CenterLocator.intensity_variance-688"><span class="linenos">688</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.intensity_variance-689"><a href="#CenterLocator.intensity_variance-689"><span class="linenos">689</span></a><span class="sd">        s : float64</span>
</span><span id="CenterLocator.intensity_variance-690"><a href="#CenterLocator.intensity_variance-690"><span class="linenos">690</span></a><span class="sd">            intensity variance</span>
</span><span id="CenterLocator.intensity_variance-691"><a href="#CenterLocator.intensity_variance-691"><span class="linenos">691</span></a>
</span><span id="CenterLocator.intensity_variance-692"><a href="#CenterLocator.intensity_variance-692"><span class="linenos">692</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.intensity_variance-693"><a href="#CenterLocator.intensity_variance-693"><span class="linenos">693</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="CenterLocator.intensity_variance-694"><a href="#CenterLocator.intensity_variance-694"><span class="linenos">694</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_variance-695"><a href="#CenterLocator.intensity_variance-695"><span class="linenos">695</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_variance-696"><a href="#CenterLocator.intensity_variance-696"><span class="linenos">696</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_variance-697"><a href="#CenterLocator.intensity_variance-697"><span class="linenos">697</span></a>        
</span><span id="CenterLocator.intensity_variance-698"><a href="#CenterLocator.intensity_variance-698"><span class="linenos">698</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="CenterLocator.intensity_variance-699"><a href="#CenterLocator.intensity_variance-699"><span class="linenos">699</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span><span class="p">])</span>
</span><span id="CenterLocator.intensity_variance-700"><a href="#CenterLocator.intensity_variance-700"><span class="linenos">700</span></a>        <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Variance of intensity values of pixels of a diffraction pattern.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>image</strong> (array of uint8):
image from which the diffraction pattern has been detected.</li>
<li><strong>px</strong> (float64):
x-coordinate of the center of the diffraction pattern.</li>
<li><strong>py</strong> (float64):
y-coordinate of the center of the diffraction pattern.</li>
<li><strong>pr</strong> (float64):
radius of the diffraction pattern.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s</strong> (float64):
intensity variance</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.convert_coords" class="classattr">
                                        <input id="CenterLocator.convert_coords-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_coords</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.convert_coords-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.convert_coords"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.convert_coords-703"><a href="#CenterLocator.convert_coords-703"><span class="linenos">703</span></a>    <span class="k">def</span> <span class="nf">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="CenterLocator.convert_coords-704"><a href="#CenterLocator.convert_coords-704"><span class="linenos">704</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.convert_coords-705"><a href="#CenterLocator.convert_coords-705"><span class="linenos">705</span></a><span class="sd">        Convert coordinates between numpy and matplotlib systems.</span>
</span><span id="CenterLocator.convert_coords-706"><a href="#CenterLocator.convert_coords-706"><span class="linenos">706</span></a>
</span><span id="CenterLocator.convert_coords-707"><a href="#CenterLocator.convert_coords-707"><span class="linenos">707</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.convert_coords-708"><a href="#CenterLocator.convert_coords-708"><span class="linenos">708</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.convert_coords-709"><a href="#CenterLocator.convert_coords-709"><span class="linenos">709</span></a><span class="sd">        x : int or float</span>
</span><span id="CenterLocator.convert_coords-710"><a href="#CenterLocator.convert_coords-710"><span class="linenos">710</span></a><span class="sd">            The x-coordinate in the numpy (column index) format.</span>
</span><span id="CenterLocator.convert_coords-711"><a href="#CenterLocator.convert_coords-711"><span class="linenos">711</span></a><span class="sd">        </span>
</span><span id="CenterLocator.convert_coords-712"><a href="#CenterLocator.convert_coords-712"><span class="linenos">712</span></a><span class="sd">        y : int or float</span>
</span><span id="CenterLocator.convert_coords-713"><a href="#CenterLocator.convert_coords-713"><span class="linenos">713</span></a><span class="sd">            The y-coordinate in the numpy (row index) format.</span>
</span><span id="CenterLocator.convert_coords-714"><a href="#CenterLocator.convert_coords-714"><span class="linenos">714</span></a>
</span><span id="CenterLocator.convert_coords-715"><a href="#CenterLocator.convert_coords-715"><span class="linenos">715</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.convert_coords-716"><a href="#CenterLocator.convert_coords-716"><span class="linenos">716</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.convert_coords-717"><a href="#CenterLocator.convert_coords-717"><span class="linenos">717</span></a><span class="sd">        tuple of (int or float, int or float)</span>
</span><span id="CenterLocator.convert_coords-718"><a href="#CenterLocator.convert_coords-718"><span class="linenos">718</span></a><span class="sd">            The converted coordinates in matplotlib format, where:</span>
</span><span id="CenterLocator.convert_coords-719"><a href="#CenterLocator.convert_coords-719"><span class="linenos">719</span></a><span class="sd">            - First element corresponds to y (new x in matplotlib).</span>
</span><span id="CenterLocator.convert_coords-720"><a href="#CenterLocator.convert_coords-720"><span class="linenos">720</span></a><span class="sd">            - Second element corresponds to x (new y in matplotlib).</span>
</span><span id="CenterLocator.convert_coords-721"><a href="#CenterLocator.convert_coords-721"><span class="linenos">721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator.convert_coords-722"><a href="#CenterLocator.convert_coords-722"><span class="linenos">722</span></a>        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Convert coordinates between numpy and matplotlib systems.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>x</strong> (int or float):
The x-coordinate in the numpy (column index) format.</li>
<li><strong>y</strong> (int or float):
The y-coordinate in the numpy (row index) format.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>tuple of (int or float, int or float)</strong>: The converted coordinates in matplotlib format, where:
<ul>
<li>First element corresponds to y (new x in matplotlib).</li>
<li>Second element corresponds to x (new y in matplotlib).</li>
</ul></li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.visualize_results" class="classattr">
                                        <input id="CenterLocator.visualize_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_results</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csquare</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">out_file</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">out_dpi</span><span class="o">=</span><span class="mi">200</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.visualize_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.visualize_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.visualize_results-725"><a href="#CenterLocator.visualize_results-725"><span class="linenos">725</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
</span><span id="CenterLocator.visualize_results-726"><a href="#CenterLocator.visualize_results-726"><span class="linenos">726</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator.visualize_results-727"><a href="#CenterLocator.visualize_results-727"><span class="linenos">727</span></a><span class="sd">        Visualize diffractogram and its center after</span>
</span><span id="CenterLocator.visualize_results-728"><a href="#CenterLocator.visualize_results-728"><span class="linenos">728</span></a><span class="sd">        center determination + refinement.</span>
</span><span id="CenterLocator.visualize_results-729"><a href="#CenterLocator.visualize_results-729"><span class="linenos">729</span></a><span class="sd">    </span>
</span><span id="CenterLocator.visualize_results-730"><a href="#CenterLocator.visualize_results-730"><span class="linenos">730</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.visualize_results-731"><a href="#CenterLocator.visualize_results-731"><span class="linenos">731</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.visualize_results-732"><a href="#CenterLocator.visualize_results-732"><span class="linenos">732</span></a><span class="sd">        csquare : int, optional, default is None</span>
</span><span id="CenterLocator.visualize_results-733"><a href="#CenterLocator.visualize_results-733"><span class="linenos">733</span></a><span class="sd">            If csquare argument is given,</span>
</span><span id="CenterLocator.visualize_results-734"><a href="#CenterLocator.visualize_results-734"><span class="linenos">734</span></a><span class="sd">            only the central square of the diffractogram will be plotted;</span>
</span><span id="CenterLocator.visualize_results-735"><a href="#CenterLocator.visualize_results-735"><span class="linenos">735</span></a><span class="sd">            the size of the central square will be equal to csquare argument.</span>
</span><span id="CenterLocator.visualize_results-736"><a href="#CenterLocator.visualize_results-736"><span class="linenos">736</span></a><span class="sd">        </span>
</span><span id="CenterLocator.visualize_results-737"><a href="#CenterLocator.visualize_results-737"><span class="linenos">737</span></a><span class="sd">        out_file : str, optional, default is None</span>
</span><span id="CenterLocator.visualize_results-738"><a href="#CenterLocator.visualize_results-738"><span class="linenos">738</span></a><span class="sd">            If out_file is given,</span>
</span><span id="CenterLocator.visualize_results-739"><a href="#CenterLocator.visualize_results-739"><span class="linenos">739</span></a><span class="sd">            save the final plot to image named *out_file*.</span>
</span><span id="CenterLocator.visualize_results-740"><a href="#CenterLocator.visualize_results-740"><span class="linenos">740</span></a><span class="sd">        </span>
</span><span id="CenterLocator.visualize_results-741"><a href="#CenterLocator.visualize_results-741"><span class="linenos">741</span></a><span class="sd">        out_dpi : int, optional, default is 200</span>
</span><span id="CenterLocator.visualize_results-742"><a href="#CenterLocator.visualize_results-742"><span class="linenos">742</span></a><span class="sd">            DPI of the output image file;</span>
</span><span id="CenterLocator.visualize_results-743"><a href="#CenterLocator.visualize_results-743"><span class="linenos">743</span></a><span class="sd">            this parameter is relevant only if out_file is given.</span>
</span><span id="CenterLocator.visualize_results-744"><a href="#CenterLocator.visualize_results-744"><span class="linenos">744</span></a><span class="sd">    </span>
</span><span id="CenterLocator.visualize_results-745"><a href="#CenterLocator.visualize_results-745"><span class="linenos">745</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.visualize_results-746"><a href="#CenterLocator.visualize_results-746"><span class="linenos">746</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.visualize_results-747"><a href="#CenterLocator.visualize_results-747"><span class="linenos">747</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.visualize_results-748"><a href="#CenterLocator.visualize_results-748"><span class="linenos">748</span></a><span class="sd">            The output is the image of the diffractogram</span>
</span><span id="CenterLocator.visualize_results-749"><a href="#CenterLocator.visualize_results-749"><span class="linenos">749</span></a><span class="sd">            showing also the central coordinates and refinement ring.</span>
</span><span id="CenterLocator.visualize_results-750"><a href="#CenterLocator.visualize_results-750"><span class="linenos">750</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.visualize_results-751"><a href="#CenterLocator.visualize_results-751"><span class="linenos">751</span></a>        
</span><span id="CenterLocator.visualize_results-752"><a href="#CenterLocator.visualize_results-752"><span class="linenos">752</span></a>        <span class="c1"># (0) Collect center coordinates and radii ----------------------------</span>
</span><span id="CenterLocator.visualize_results-753"><a href="#CenterLocator.visualize_results-753"><span class="linenos">753</span></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-754"><a href="#CenterLocator.visualize_results-754"><span class="linenos">754</span></a>        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterLocator.visualize_results-755"><a href="#CenterLocator.visualize_results-755"><span class="linenos">755</span></a>
</span><span id="CenterLocator.visualize_results-756"><a href="#CenterLocator.visualize_results-756"><span class="linenos">756</span></a>        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-757"><a href="#CenterLocator.visualize_results-757"><span class="linenos">757</span></a>        <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span>
</span><span id="CenterLocator.visualize_results-758"><a href="#CenterLocator.visualize_results-758"><span class="linenos">758</span></a>
</span><span id="CenterLocator.visualize_results-759"><a href="#CenterLocator.visualize_results-759"><span class="linenos">759</span></a>        <span class="c1"># (1) Prepare the image of the diffractogram --------------------------</span>
</span><span id="CenterLocator.visualize_results-760"><a href="#CenterLocator.visualize_results-760"><span class="linenos">760</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-761"><a href="#CenterLocator.visualize_results-761"><span class="linenos">761</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-762"><a href="#CenterLocator.visualize_results-762"><span class="linenos">762</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-763"><a href="#CenterLocator.visualize_results-763"><span class="linenos">763</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-764"><a href="#CenterLocator.visualize_results-764"><span class="linenos">764</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-765"><a href="#CenterLocator.visualize_results-765"><span class="linenos">765</span></a>            
</span><span id="CenterLocator.visualize_results-766"><a href="#CenterLocator.visualize_results-766"><span class="linenos">766</span></a>        <span class="c1"># (2) Calculate intensity sum or intensity variance -------------------</span>
</span><span id="CenterLocator.visualize_results-767"><a href="#CenterLocator.visualize_results-767"><span class="linenos">767</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-768"><a href="#CenterLocator.visualize_results-768"><span class="linenos">768</span></a>            <span class="n">dvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-769"><a href="#CenterLocator.visualize_results-769"><span class="linenos">769</span></a>            <span class="n">rvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-770"><a href="#CenterLocator.visualize_results-770"><span class="linenos">770</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-var: </span><span class="si">{</span><span class="n">dvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator.visualize_results-771"><a href="#CenterLocator.visualize_results-771"><span class="linenos">771</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-var: </span><span class="si">{</span><span class="n">rvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator.visualize_results-772"><a href="#CenterLocator.visualize_results-772"><span class="linenos">772</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-773"><a href="#CenterLocator.visualize_results-773"><span class="linenos">773</span></a>            <span class="n">dsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-774"><a href="#CenterLocator.visualize_results-774"><span class="linenos">774</span></a>            <span class="n">rsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-775"><a href="#CenterLocator.visualize_results-775"><span class="linenos">775</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-sum: </span><span class="si">{</span><span class="n">dsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator.visualize_results-776"><a href="#CenterLocator.visualize_results-776"><span class="linenos">776</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">int-sum: </span><span class="si">{</span><span class="n">rsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="CenterLocator.visualize_results-777"><a href="#CenterLocator.visualize_results-777"><span class="linenos">777</span></a>            
</span><span id="CenterLocator.visualize_results-778"><a href="#CenterLocator.visualize_results-778"><span class="linenos">778</span></a>        <span class="c1"># (3) Calculate xy-limits if we want to see only the central square ---</span>
</span><span id="CenterLocator.visualize_results-779"><a href="#CenterLocator.visualize_results-779"><span class="linenos">779</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-780"><a href="#CenterLocator.visualize_results-780"><span class="linenos">780</span></a>            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterLocator.visualize_results-781"><a href="#CenterLocator.visualize_results-781"><span class="linenos">781</span></a>            <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterLocator.visualize_results-782"><a href="#CenterLocator.visualize_results-782"><span class="linenos">782</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator.visualize_results-783"><a href="#CenterLocator.visualize_results-783"><span class="linenos">783</span></a>            <span class="n">xmin</span> <span class="o">+=</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-784"><a href="#CenterLocator.visualize_results-784"><span class="linenos">784</span></a>            <span class="n">xmax</span> <span class="o">-=</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-785"><a href="#CenterLocator.visualize_results-785"><span class="linenos">785</span></a>            <span class="n">ymin</span> <span class="o">+=</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-786"><a href="#CenterLocator.visualize_results-786"><span class="linenos">786</span></a>            <span class="n">ymax</span> <span class="o">-=</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-787"><a href="#CenterLocator.visualize_results-787"><span class="linenos">787</span></a>    
</span><span id="CenterLocator.visualize_results-788"><a href="#CenterLocator.visualize_results-788"><span class="linenos">788</span></a>        <span class="c1"># (4) Final plot: show the diffractogram + refinement results ---------</span>
</span><span id="CenterLocator.visualize_results-789"><a href="#CenterLocator.visualize_results-789"><span class="linenos">789</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-790"><a href="#CenterLocator.visualize_results-790"><span class="linenos">790</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-791"><a href="#CenterLocator.visualize_results-791"><span class="linenos">791</span></a>    
</span><span id="CenterLocator.visualize_results-792"><a href="#CenterLocator.visualize_results-792"><span class="linenos">792</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Center :: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-793"><a href="#CenterLocator.visualize_results-793"><span class="linenos">793</span></a>    
</span><span id="CenterLocator.visualize_results-794"><a href="#CenterLocator.visualize_results-794"><span class="linenos">794</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-795"><a href="#CenterLocator.visualize_results-795"><span class="linenos">795</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labeld</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-796"><a href="#CenterLocator.visualize_results-796"><span class="linenos">796</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-797"><a href="#CenterLocator.visualize_results-797"><span class="linenos">797</span></a>                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-798"><a href="#CenterLocator.visualize_results-798"><span class="linenos">798</span></a>                   <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-799"><a href="#CenterLocator.visualize_results-799"><span class="linenos">799</span></a>        <span class="n">c0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">r1</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-800"><a href="#CenterLocator.visualize_results-800"><span class="linenos">800</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-801"><a href="#CenterLocator.visualize_results-801"><span class="linenos">801</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-802"><a href="#CenterLocator.visualize_results-802"><span class="linenos">802</span></a>                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detected center&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-803"><a href="#CenterLocator.visualize_results-803"><span class="linenos">803</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-804"><a href="#CenterLocator.visualize_results-804"><span class="linenos">804</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-805"><a href="#CenterLocator.visualize_results-805"><span class="linenos">805</span></a>    
</span><span id="CenterLocator.visualize_results-806"><a href="#CenterLocator.visualize_results-806"><span class="linenos">806</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span>
</span><span id="CenterLocator.visualize_results-807"><a href="#CenterLocator.visualize_results-807"><span class="linenos">807</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labelr</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-808"><a href="#CenterLocator.visualize_results-808"><span class="linenos">808</span></a>                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-809"><a href="#CenterLocator.visualize_results-809"><span class="linenos">809</span></a>                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-810"><a href="#CenterLocator.visualize_results-810"><span class="linenos">810</span></a>        <span class="n">c1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">r2</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-811"><a href="#CenterLocator.visualize_results-811"><span class="linenos">811</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-812"><a href="#CenterLocator.visualize_results-812"><span class="linenos">812</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-813"><a href="#CenterLocator.visualize_results-813"><span class="linenos">813</span></a>                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refined center&#39;</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-814"><a href="#CenterLocator.visualize_results-814"><span class="linenos">814</span></a>                        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-815"><a href="#CenterLocator.visualize_results-815"><span class="linenos">815</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-816"><a href="#CenterLocator.visualize_results-816"><span class="linenos">816</span></a>    
</span><span id="CenterLocator.visualize_results-817"><a href="#CenterLocator.visualize_results-817"><span class="linenos">817</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator.visualize_results-818"><a href="#CenterLocator.visualize_results-818"><span class="linenos">818</span></a>                  <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="n">Circle</span><span class="p">:</span> <span class="n">HandlerCircle</span><span class="p">()},</span> 
</span><span id="CenterLocator.visualize_results-819"><a href="#CenterLocator.visualize_results-819"><span class="linenos">819</span></a>                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.98</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> 
</span><span id="CenterLocator.visualize_results-820"><a href="#CenterLocator.visualize_results-820"><span class="linenos">820</span></a>                  <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-821"><a href="#CenterLocator.visualize_results-821"><span class="linenos">821</span></a>    
</span><span id="CenterLocator.visualize_results-822"><a href="#CenterLocator.visualize_results-822"><span class="linenos">822</span></a>        <span class="c1"># Remove axes (= tick and ticklabels) around the diffractogram</span>
</span><span id="CenterLocator.visualize_results-823"><a href="#CenterLocator.visualize_results-823"><span class="linenos">823</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-824"><a href="#CenterLocator.visualize_results-824"><span class="linenos">824</span></a>        
</span><span id="CenterLocator.visualize_results-825"><a href="#CenterLocator.visualize_results-825"><span class="linenos">825</span></a>        <span class="c1"># Plot only the central square region if requested</span>
</span><span id="CenterLocator.visualize_results-826"><a href="#CenterLocator.visualize_results-826"><span class="linenos">826</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-827"><a href="#CenterLocator.visualize_results-827"><span class="linenos">827</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-828"><a href="#CenterLocator.visualize_results-828"><span class="linenos">828</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-829"><a href="#CenterLocator.visualize_results-829"><span class="linenos">829</span></a>        
</span><span id="CenterLocator.visualize_results-830"><a href="#CenterLocator.visualize_results-830"><span class="linenos">830</span></a>        <span class="c1"># Save the result to output file if requested</span>
</span><span id="CenterLocator.visualize_results-831"><a href="#CenterLocator.visualize_results-831"><span class="linenos">831</span></a>        <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-832"><a href="#CenterLocator.visualize_results-832"><span class="linenos">832</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">out_dpi</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-833"><a href="#CenterLocator.visualize_results-833"><span class="linenos">833</span></a>        
</span><span id="CenterLocator.visualize_results-834"><a href="#CenterLocator.visualize_results-834"><span class="linenos">834</span></a>        <span class="c1"># Show the plot on screen</span>
</span><span id="CenterLocator.visualize_results-835"><a href="#CenterLocator.visualize_results-835"><span class="linenos">835</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize diffractogram and its center after
center determination + refinement.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>csquare</strong> (int, optional, default is None):
If csquare argument is given,
only the central square of the diffractogram will be plotted;
the size of the central square will be equal to csquare argument.</li>
<li><strong>out_file</strong> (str, optional, default is None):
If out_file is given,
save the final plot to image named *out_file*.</li>
<li><strong>out_dpi</strong> (int, optional, default is 200):
DPI of the output image file;
this parameter is relevant only if out_file is given.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong>: The output is the image of the diffractogram
showing also the central coordinates and refinement ring.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.ellipse_distortion" class="classattr">
                                        <input id="CenterLocator.ellipse_distortion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ellipse_distortion</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">img</span>, </span><span class="param"><span class="n">show</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">method</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.ellipse_distortion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.ellipse_distortion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.ellipse_distortion-838"><a href="#CenterLocator.ellipse_distortion-838"><span class="linenos">838</span></a>    <span class="k">def</span> <span class="nf">ellipse_distortion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CenterLocator.ellipse_distortion-839"><a href="#CenterLocator.ellipse_distortion-839"><span class="linenos">839</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.ellipse_distortion-840"><a href="#CenterLocator.ellipse_distortion-840"><span class="linenos">840</span></a><span class="sd">        Corrects elliptical distortion in an image by transforming 4 distorted </span>
</span><span id="CenterLocator.ellipse_distortion-841"><a href="#CenterLocator.ellipse_distortion-841"><span class="linenos">841</span></a><span class="sd">        points (which should ideally lie on a circle) to lie on a true circle.</span>
</span><span id="CenterLocator.ellipse_distortion-842"><a href="#CenterLocator.ellipse_distortion-842"><span class="linenos">842</span></a><span class="sd">    </span>
</span><span id="CenterLocator.ellipse_distortion-843"><a href="#CenterLocator.ellipse_distortion-843"><span class="linenos">843</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.ellipse_distortion-844"><a href="#CenterLocator.ellipse_distortion-844"><span class="linenos">844</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.ellipse_distortion-845"><a href="#CenterLocator.ellipse_distortion-845"><span class="linenos">845</span></a><span class="sd">        img : np.ndarray</span>
</span><span id="CenterLocator.ellipse_distortion-846"><a href="#CenterLocator.ellipse_distortion-846"><span class="linenos">846</span></a><span class="sd">            Input image (2D numpy array) containing an elliptical diffraction </span>
</span><span id="CenterLocator.ellipse_distortion-847"><a href="#CenterLocator.ellipse_distortion-847"><span class="linenos">847</span></a><span class="sd">            pattern.</span>
</span><span id="CenterLocator.ellipse_distortion-848"><a href="#CenterLocator.ellipse_distortion-848"><span class="linenos">848</span></a><span class="sd">        </span>
</span><span id="CenterLocator.ellipse_distortion-849"><a href="#CenterLocator.ellipse_distortion-849"><span class="linenos">849</span></a><span class="sd">        show : bool, optional</span>
</span><span id="CenterLocator.ellipse_distortion-850"><a href="#CenterLocator.ellipse_distortion-850"><span class="linenos">850</span></a><span class="sd">            If True, displays the original and corrected images. </span>
</span><span id="CenterLocator.ellipse_distortion-851"><a href="#CenterLocator.ellipse_distortion-851"><span class="linenos">851</span></a><span class="sd">            Default is True.</span>
</span><span id="CenterLocator.ellipse_distortion-852"><a href="#CenterLocator.ellipse_distortion-852"><span class="linenos">852</span></a><span class="sd">        </span>
</span><span id="CenterLocator.ellipse_distortion-853"><a href="#CenterLocator.ellipse_distortion-853"><span class="linenos">853</span></a><span class="sd">        method : str, optional</span>
</span><span id="CenterLocator.ellipse_distortion-854"><a href="#CenterLocator.ellipse_distortion-854"><span class="linenos">854</span></a><span class="sd">            Point selection method: &#39;manual&#39; or &#39;auto&#39;.</span>
</span><span id="CenterLocator.ellipse_distortion-855"><a href="#CenterLocator.ellipse_distortion-855"><span class="linenos">855</span></a><span class="sd">            - &#39;manual&#39;: User clicks four points on the image.</span>
</span><span id="CenterLocator.ellipse_distortion-856"><a href="#CenterLocator.ellipse_distortion-856"><span class="linenos">856</span></a><span class="sd">            - &#39;auto&#39;: Automatically detects the four brightest Bragg spots </span>
</span><span id="CenterLocator.ellipse_distortion-857"><a href="#CenterLocator.ellipse_distortion-857"><span class="linenos">857</span></a><span class="sd">              (not yet implemented).</span>
</span><span id="CenterLocator.ellipse_distortion-858"><a href="#CenterLocator.ellipse_distortion-858"><span class="linenos">858</span></a><span class="sd">    </span>
</span><span id="CenterLocator.ellipse_distortion-859"><a href="#CenterLocator.ellipse_distortion-859"><span class="linenos">859</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.ellipse_distortion-860"><a href="#CenterLocator.ellipse_distortion-860"><span class="linenos">860</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.ellipse_distortion-861"><a href="#CenterLocator.ellipse_distortion-861"><span class="linenos">861</span></a><span class="sd">        corrected : np.ndarray</span>
</span><span id="CenterLocator.ellipse_distortion-862"><a href="#CenterLocator.ellipse_distortion-862"><span class="linenos">862</span></a><span class="sd">            The distortion-corrected image.</span>
</span><span id="CenterLocator.ellipse_distortion-863"><a href="#CenterLocator.ellipse_distortion-863"><span class="linenos">863</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator.ellipse_distortion-864"><a href="#CenterLocator.ellipse_distortion-864"><span class="linenos">864</span></a>            
</span><span id="CenterLocator.ellipse_distortion-865"><a href="#CenterLocator.ellipse_distortion-865"><span class="linenos">865</span></a>        <span class="c1"># Helper function</span>
</span><span id="CenterLocator.ellipse_distortion-866"><a href="#CenterLocator.ellipse_distortion-866"><span class="linenos">866</span></a>        <span class="k">def</span> <span class="nf">refine_to_local_max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
</span><span id="CenterLocator.ellipse_distortion-867"><a href="#CenterLocator.ellipse_distortion-867"><span class="linenos">867</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.ellipse_distortion-868"><a href="#CenterLocator.ellipse_distortion-868"><span class="linenos">868</span></a><span class="sd">            Refine a point to the local maximum intensity within a neighborhood.</span>
</span><span id="CenterLocator.ellipse_distortion-869"><a href="#CenterLocator.ellipse_distortion-869"><span class="linenos">869</span></a><span class="sd">        </span>
</span><span id="CenterLocator.ellipse_distortion-870"><a href="#CenterLocator.ellipse_distortion-870"><span class="linenos">870</span></a><span class="sd">            This function searches for the brightest (maximum intensity) pixel</span>
</span><span id="CenterLocator.ellipse_distortion-871"><a href="#CenterLocator.ellipse_distortion-871"><span class="linenos">871</span></a><span class="sd">            within a square window centered around a given point. It is typi-</span>
</span><span id="CenterLocator.ellipse_distortion-872"><a href="#CenterLocator.ellipse_distortion-872"><span class="linenos">872</span></a><span class="sd">            cally used to improve the accuracy of an estimated center by snap-</span>
</span><span id="CenterLocator.ellipse_distortion-873"><a href="#CenterLocator.ellipse_distortion-873"><span class="linenos">873</span></a><span class="sd">            ping it to the nearest local maximum.</span>
</span><span id="CenterLocator.ellipse_distortion-874"><a href="#CenterLocator.ellipse_distortion-874"><span class="linenos">874</span></a><span class="sd">        </span>
</span><span id="CenterLocator.ellipse_distortion-875"><a href="#CenterLocator.ellipse_distortion-875"><span class="linenos">875</span></a><span class="sd">            Parameters</span>
</span><span id="CenterLocator.ellipse_distortion-876"><a href="#CenterLocator.ellipse_distortion-876"><span class="linenos">876</span></a><span class="sd">            ----------</span>
</span><span id="CenterLocator.ellipse_distortion-877"><a href="#CenterLocator.ellipse_distortion-877"><span class="linenos">877</span></a><span class="sd">            img : ndarray</span>
</span><span id="CenterLocator.ellipse_distortion-878"><a href="#CenterLocator.ellipse_distortion-878"><span class="linenos">878</span></a><span class="sd">                2D array (grayscale) in which the local maximum is to be found.</span>
</span><span id="CenterLocator.ellipse_distortion-879"><a href="#CenterLocator.ellipse_distortion-879"><span class="linenos">879</span></a><span class="sd">                </span>
</span><span id="CenterLocator.ellipse_distortion-880"><a href="#CenterLocator.ellipse_distortion-880"><span class="linenos">880</span></a><span class="sd">            pt : array-like of float</span>
</span><span id="CenterLocator.ellipse_distortion-881"><a href="#CenterLocator.ellipse_distortion-881"><span class="linenos">881</span></a><span class="sd">                Initial (x, y) point coordinates around which the local maximum </span>
</span><span id="CenterLocator.ellipse_distortion-882"><a href="#CenterLocator.ellipse_distortion-882"><span class="linenos">882</span></a><span class="sd">                is searched.</span>
</span><span id="CenterLocator.ellipse_distortion-883"><a href="#CenterLocator.ellipse_distortion-883"><span class="linenos">883</span></a><span class="sd">                </span>
</span><span id="CenterLocator.ellipse_distortion-884"><a href="#CenterLocator.ellipse_distortion-884"><span class="linenos">884</span></a><span class="sd">            window : int, optional</span>
</span><span id="CenterLocator.ellipse_distortion-885"><a href="#CenterLocator.ellipse_distortion-885"><span class="linenos">885</span></a><span class="sd">                Size of the square window for the local search (default is 9).</span>
</span><span id="CenterLocator.ellipse_distortion-886"><a href="#CenterLocator.ellipse_distortion-886"><span class="linenos">886</span></a><span class="sd">                The actual window will be `window x window` pixels, </span>
</span><span id="CenterLocator.ellipse_distortion-887"><a href="#CenterLocator.ellipse_distortion-887"><span class="linenos">887</span></a><span class="sd">                centered at `pt`.</span>
</span><span id="CenterLocator.ellipse_distortion-888"><a href="#CenterLocator.ellipse_distortion-888"><span class="linenos">888</span></a><span class="sd">        </span>
</span><span id="CenterLocator.ellipse_distortion-889"><a href="#CenterLocator.ellipse_distortion-889"><span class="linenos">889</span></a><span class="sd">            Returns</span>
</span><span id="CenterLocator.ellipse_distortion-890"><a href="#CenterLocator.ellipse_distortion-890"><span class="linenos">890</span></a><span class="sd">            -------</span>
</span><span id="CenterLocator.ellipse_distortion-891"><a href="#CenterLocator.ellipse_distortion-891"><span class="linenos">891</span></a><span class="sd">            refined_pt : ndarray of float</span>
</span><span id="CenterLocator.ellipse_distortion-892"><a href="#CenterLocator.ellipse_distortion-892"><span class="linenos">892</span></a><span class="sd">                Refined point coordinates [x, y] corresponding to the brightest </span>
</span><span id="CenterLocator.ellipse_distortion-893"><a href="#CenterLocator.ellipse_distortion-893"><span class="linenos">893</span></a><span class="sd">                pixel in the local window.</span>
</span><span id="CenterLocator.ellipse_distortion-894"><a href="#CenterLocator.ellipse_distortion-894"><span class="linenos">894</span></a><span class="sd">        </span>
</span><span id="CenterLocator.ellipse_distortion-895"><a href="#CenterLocator.ellipse_distortion-895"><span class="linenos">895</span></a><span class="sd">            Notes</span>
</span><span id="CenterLocator.ellipse_distortion-896"><a href="#CenterLocator.ellipse_distortion-896"><span class="linenos">896</span></a><span class="sd">            -----</span>
</span><span id="CenterLocator.ellipse_distortion-897"><a href="#CenterLocator.ellipse_distortion-897"><span class="linenos">897</span></a><span class="sd">            - If the window overlaps the image boundaries, it is clipped </span>
</span><span id="CenterLocator.ellipse_distortion-898"><a href="#CenterLocator.ellipse_distortion-898"><span class="linenos">898</span></a><span class="sd">              appropriately.</span>
</span><span id="CenterLocator.ellipse_distortion-899"><a href="#CenterLocator.ellipse_distortion-899"><span class="linenos">899</span></a><span class="sd">            - If the window is completely outside the image, the original point </span>
</span><span id="CenterLocator.ellipse_distortion-900"><a href="#CenterLocator.ellipse_distortion-900"><span class="linenos">900</span></a><span class="sd">              is returned.</span>
</span><span id="CenterLocator.ellipse_distortion-901"><a href="#CenterLocator.ellipse_distortion-901"><span class="linenos">901</span></a><span class="sd">            - Assumption : `img` uses (row, column) = (y, x) indexing.</span>
</span><span id="CenterLocator.ellipse_distortion-902"><a href="#CenterLocator.ellipse_distortion-902"><span class="linenos">902</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterLocator.ellipse_distortion-903"><a href="#CenterLocator.ellipse_distortion-903"><span class="linenos">903</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="CenterLocator.ellipse_distortion-904"><a href="#CenterLocator.ellipse_distortion-904"><span class="linenos">904</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="n">window</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator.ellipse_distortion-905"><a href="#CenterLocator.ellipse_distortion-905"><span class="linenos">905</span></a>            <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-906"><a href="#CenterLocator.ellipse_distortion-906"><span class="linenos">906</span></a>            <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-907"><a href="#CenterLocator.ellipse_distortion-907"><span class="linenos">907</span></a>    
</span><span id="CenterLocator.ellipse_distortion-908"><a href="#CenterLocator.ellipse_distortion-908"><span class="linenos">908</span></a>            <span class="n">local</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
</span><span id="CenterLocator.ellipse_distortion-909"><a href="#CenterLocator.ellipse_distortion-909"><span class="linenos">909</span></a>            <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterLocator.ellipse_distortion-910"><a href="#CenterLocator.ellipse_distortion-910"><span class="linenos">910</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-911"><a href="#CenterLocator.ellipse_distortion-911"><span class="linenos">911</span></a>    
</span><span id="CenterLocator.ellipse_distortion-912"><a href="#CenterLocator.ellipse_distortion-912"><span class="linenos">912</span></a>            <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="n">local</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-913"><a href="#CenterLocator.ellipse_distortion-913"><span class="linenos">913</span></a>            <span class="n">refined_x</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="n">dx</span>
</span><span id="CenterLocator.ellipse_distortion-914"><a href="#CenterLocator.ellipse_distortion-914"><span class="linenos">914</span></a>            <span class="n">refined_y</span> <span class="o">=</span> <span class="n">y_min</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterLocator.ellipse_distortion-915"><a href="#CenterLocator.ellipse_distortion-915"><span class="linenos">915</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">refined_x</span><span class="p">,</span> <span class="n">refined_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-916"><a href="#CenterLocator.ellipse_distortion-916"><span class="linenos">916</span></a>        
</span><span id="CenterLocator.ellipse_distortion-917"><a href="#CenterLocator.ellipse_distortion-917"><span class="linenos">917</span></a>        <span class="c1"># Elliptical correction workflow --------------------------------------</span>
</span><span id="CenterLocator.ellipse_distortion-918"><a href="#CenterLocator.ellipse_distortion-918"><span class="linenos">918</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterLocator.ellipse_distortion-919"><a href="#CenterLocator.ellipse_distortion-919"><span class="linenos">919</span></a>    
</span><span id="CenterLocator.ellipse_distortion-920"><a href="#CenterLocator.ellipse_distortion-920"><span class="linenos">920</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterLocator.ellipse_distortion-921"><a href="#CenterLocator.ellipse_distortion-921"><span class="linenos">921</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only user-assisted (&#39;manual&#39;) correction available.&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-922"><a href="#CenterLocator.ellipse_distortion-922"><span class="linenos">922</span></a>            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;manual&quot;</span>
</span><span id="CenterLocator.ellipse_distortion-923"><a href="#CenterLocator.ellipse_distortion-923"><span class="linenos">923</span></a>    
</span><span id="CenterLocator.ellipse_distortion-924"><a href="#CenterLocator.ellipse_distortion-924"><span class="linenos">924</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
</span><span id="CenterLocator.ellipse_distortion-925"><a href="#CenterLocator.ellipse_distortion-925"><span class="linenos">925</span></a>            <span class="c1"># Manual point selection</span>
</span><span id="CenterLocator.ellipse_distortion-926"><a href="#CenterLocator.ellipse_distortion-926"><span class="linenos">926</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-927"><a href="#CenterLocator.ellipse_distortion-927"><span class="linenos">927</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Click 4 distorted points (in circular order)&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-928"><a href="#CenterLocator.ellipse_distortion-928"><span class="linenos">928</span></a>            <span class="n">raw_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-929"><a href="#CenterLocator.ellipse_distortion-929"><span class="linenos">929</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="CenterLocator.ellipse_distortion-930"><a href="#CenterLocator.ellipse_distortion-930"><span class="linenos">930</span></a>    
</span><span id="CenterLocator.ellipse_distortion-931"><a href="#CenterLocator.ellipse_distortion-931"><span class="linenos">931</span></a>            <span class="c1"># Refine each point to local max</span>
</span><span id="CenterLocator.ellipse_distortion-932"><a href="#CenterLocator.ellipse_distortion-932"><span class="linenos">932</span></a>            <span class="n">distorted_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="CenterLocator.ellipse_distortion-933"><a href="#CenterLocator.ellipse_distortion-933"><span class="linenos">933</span></a>                <span class="n">refine_to_local_max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">raw_pts</span>
</span><span id="CenterLocator.ellipse_distortion-934"><a href="#CenterLocator.ellipse_distortion-934"><span class="linenos">934</span></a>            <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-935"><a href="#CenterLocator.ellipse_distortion-935"><span class="linenos">935</span></a>    
</span><span id="CenterLocator.ellipse_distortion-936"><a href="#CenterLocator.ellipse_distortion-936"><span class="linenos">936</span></a>        <span class="c1"># Compute center and average radius</span>
</span><span id="CenterLocator.ellipse_distortion-937"><a href="#CenterLocator.ellipse_distortion-937"><span class="linenos">937</span></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distorted_pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-938"><a href="#CenterLocator.ellipse_distortion-938"><span class="linenos">938</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">distorted_pts</span> <span class="o">-</span> <span class="n">center</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-939"><a href="#CenterLocator.ellipse_distortion-939"><span class="linenos">939</span></a>        <span class="n">avg_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-940"><a href="#CenterLocator.ellipse_distortion-940"><span class="linenos">940</span></a>    
</span><span id="CenterLocator.ellipse_distortion-941"><a href="#CenterLocator.ellipse_distortion-941"><span class="linenos">941</span></a>        <span class="c1"># Target points evenly on circle</span>
</span><span id="CenterLocator.ellipse_distortion-942"><a href="#CenterLocator.ellipse_distortion-942"><span class="linenos">942</span></a>        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.ellipse_distortion-943"><a href="#CenterLocator.ellipse_distortion-943"><span class="linenos">943</span></a>        <span class="n">circle_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
</span><span id="CenterLocator.ellipse_distortion-944"><a href="#CenterLocator.ellipse_distortion-944"><span class="linenos">944</span></a>            <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">avg_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
</span><span id="CenterLocator.ellipse_distortion-945"><a href="#CenterLocator.ellipse_distortion-945"><span class="linenos">945</span></a>            <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">avg_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-946"><a href="#CenterLocator.ellipse_distortion-946"><span class="linenos">946</span></a>        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-947"><a href="#CenterLocator.ellipse_distortion-947"><span class="linenos">947</span></a>    
</span><span id="CenterLocator.ellipse_distortion-948"><a href="#CenterLocator.ellipse_distortion-948"><span class="linenos">948</span></a>        <span class="c1"># Perspective transform</span>
</span><span id="CenterLocator.ellipse_distortion-949"><a href="#CenterLocator.ellipse_distortion-949"><span class="linenos">949</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">distorted_pts</span><span class="p">,</span> <span class="n">circle_pts</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-950"><a href="#CenterLocator.ellipse_distortion-950"><span class="linenos">950</span></a>        
</span><span id="CenterLocator.ellipse_distortion-951"><a href="#CenterLocator.ellipse_distortion-951"><span class="linenos">951</span></a>        <span class="c1"># Make output square by padding the image to max_dim x max_dim</span>
</span><span id="CenterLocator.ellipse_distortion-952"><a href="#CenterLocator.ellipse_distortion-952"><span class="linenos">952</span></a>        <span class="n">max_dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-953"><a href="#CenterLocator.ellipse_distortion-953"><span class="linenos">953</span></a>        
</span><span id="CenterLocator.ellipse_distortion-954"><a href="#CenterLocator.ellipse_distortion-954"><span class="linenos">954</span></a>        <span class="c1"># Compute offset to center the original image content in the square </span>
</span><span id="CenterLocator.ellipse_distortion-955"><a href="#CenterLocator.ellipse_distortion-955"><span class="linenos">955</span></a>        <span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_dim</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator.ellipse_distortion-956"><a href="#CenterLocator.ellipse_distortion-956"><span class="linenos">956</span></a>        <span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_dim</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator.ellipse_distortion-957"><a href="#CenterLocator.ellipse_distortion-957"><span class="linenos">957</span></a>        
</span><span id="CenterLocator.ellipse_distortion-958"><a href="#CenterLocator.ellipse_distortion-958"><span class="linenos">958</span></a>        <span class="c1"># Create a translation matrix to shift image content to center</span>
</span><span id="CenterLocator.ellipse_distortion-959"><a href="#CenterLocator.ellipse_distortion-959"><span class="linenos">959</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="CenterLocator.ellipse_distortion-960"><a href="#CenterLocator.ellipse_distortion-960"><span class="linenos">960</span></a>            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">],</span>
</span><span id="CenterLocator.ellipse_distortion-961"><a href="#CenterLocator.ellipse_distortion-961"><span class="linenos">961</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">],</span>
</span><span id="CenterLocator.ellipse_distortion-962"><a href="#CenterLocator.ellipse_distortion-962"><span class="linenos">962</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.ellipse_distortion-963"><a href="#CenterLocator.ellipse_distortion-963"><span class="linenos">963</span></a>        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-964"><a href="#CenterLocator.ellipse_distortion-964"><span class="linenos">964</span></a>        
</span><span id="CenterLocator.ellipse_distortion-965"><a href="#CenterLocator.ellipse_distortion-965"><span class="linenos">965</span></a>        <span class="c1"># Combine the original homography with the translation</span>
</span><span id="CenterLocator.ellipse_distortion-966"><a href="#CenterLocator.ellipse_distortion-966"><span class="linenos">966</span></a>        <span class="n">H_total</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">H</span>  <span class="c1"># Matrix multiplication</span>
</span><span id="CenterLocator.ellipse_distortion-967"><a href="#CenterLocator.ellipse_distortion-967"><span class="linenos">967</span></a>        
</span><span id="CenterLocator.ellipse_distortion-968"><a href="#CenterLocator.ellipse_distortion-968"><span class="linenos">968</span></a>        <span class="c1"># Apply the combined transformation</span>
</span><span id="CenterLocator.ellipse_distortion-969"><a href="#CenterLocator.ellipse_distortion-969"><span class="linenos">969</span></a>        <span class="n">corrected</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span>
</span><span id="CenterLocator.ellipse_distortion-970"><a href="#CenterLocator.ellipse_distortion-970"><span class="linenos">970</span></a>            <span class="n">img</span><span class="p">,</span> <span class="n">H_total</span><span class="p">,</span> <span class="p">(</span><span class="n">max_dim</span><span class="p">,</span> <span class="n">max_dim</span><span class="p">),</span>
</span><span id="CenterLocator.ellipse_distortion-971"><a href="#CenterLocator.ellipse_distortion-971"><span class="linenos">971</span></a>            <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span>
</span><span id="CenterLocator.ellipse_distortion-972"><a href="#CenterLocator.ellipse_distortion-972"><span class="linenos">972</span></a>            <span class="n">borderValue</span><span class="o">=</span><span class="mi">0</span>
</span><span id="CenterLocator.ellipse_distortion-973"><a href="#CenterLocator.ellipse_distortion-973"><span class="linenos">973</span></a>        <span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-974"><a href="#CenterLocator.ellipse_distortion-974"><span class="linenos">974</span></a>
</span><span id="CenterLocator.ellipse_distortion-975"><a href="#CenterLocator.ellipse_distortion-975"><span class="linenos">975</span></a>        <span class="c1"># Show results</span>
</span><span id="CenterLocator.ellipse_distortion-976"><a href="#CenterLocator.ellipse_distortion-976"><span class="linenos">976</span></a>        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
</span><span id="CenterLocator.ellipse_distortion-977"><a href="#CenterLocator.ellipse_distortion-977"><span class="linenos">977</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="CenterLocator.ellipse_distortion-978"><a href="#CenterLocator.ellipse_distortion-978"><span class="linenos">978</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-979"><a href="#CenterLocator.ellipse_distortion-979"><span class="linenos">979</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original with refined points&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-980"><a href="#CenterLocator.ellipse_distortion-980"><span class="linenos">980</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-981"><a href="#CenterLocator.ellipse_distortion-981"><span class="linenos">981</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">distorted_pts</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-982"><a href="#CenterLocator.ellipse_distortion-982"><span class="linenos">982</span></a>    
</span><span id="CenterLocator.ellipse_distortion-983"><a href="#CenterLocator.ellipse_distortion-983"><span class="linenos">983</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-984"><a href="#CenterLocator.ellipse_distortion-984"><span class="linenos">984</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Corrected image&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-985"><a href="#CenterLocator.ellipse_distortion-985"><span class="linenos">985</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterLocator.ellipse_distortion-986"><a href="#CenterLocator.ellipse_distortion-986"><span class="linenos">986</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterLocator.ellipse_distortion-987"><a href="#CenterLocator.ellipse_distortion-987"><span class="linenos">987</span></a>    
</span><span id="CenterLocator.ellipse_distortion-988"><a href="#CenterLocator.ellipse_distortion-988"><span class="linenos">988</span></a>        <span class="k">return</span> <span class="n">corrected</span>
</span></pre></div>


            <div class="docstring"><p>Corrects elliptical distortion in an image by transforming 4 distorted 
points (which should ideally lie on a circle) to lie on a true circle.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>img</strong> (np.ndarray):
Input image (2D numpy array) containing an elliptical diffraction 
pattern.</li>
<li><strong>show</strong> (bool, optional):
If True, displays the original and corrected images. 
Default is True.</li>
<li><strong>method</strong> (str, optional):
Point selection method: 'manual' or 'auto'.
<ul>
<li>'manual': User clicks four points on the image.</li>
<li>'auto': Automatically detects the four brightest Bragg spots 
(not yet implemented).</li>
</ul></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>corrected</strong> (np.ndarray):
The distortion-corrected image.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="CenterDetermination">
                            <input id="CenterDetermination-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CenterDetermination</span>:

                <label class="view-source-button" for="CenterDetermination-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination-991"><a href="#CenterDetermination-991"><span class="linenos"> 991</span></a><span class="k">class</span> <span class="nc">CenterDetermination</span><span class="p">:</span>
</span><span id="CenterDetermination-992"><a href="#CenterDetermination-992"><span class="linenos"> 992</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination-993"><a href="#CenterDetermination-993"><span class="linenos"> 993</span></a><span class="sd">    CenterDetermination object - initial detection of a diffractogram center.</span>
</span><span id="CenterDetermination-994"><a href="#CenterDetermination-994"><span class="linenos"> 994</span></a>
</span><span id="CenterDetermination-995"><a href="#CenterDetermination-995"><span class="linenos"> 995</span></a><span class="sd">    This class is responsible for identifying the center coordinates of </span>
</span><span id="CenterDetermination-996"><a href="#CenterDetermination-996"><span class="linenos"> 996</span></a><span class="sd">    a 2D diffraction pattern image using various detection methods specified </span>
</span><span id="CenterDetermination-997"><a href="#CenterDetermination-997"><span class="linenos"> 997</span></a><span class="sd">    by the user. It initializes with the input image and other parameters</span>
</span><span id="CenterDetermination-998"><a href="#CenterDetermination-998"><span class="linenos"> 998</span></a><span class="sd">    that influence the center detection process.</span>
</span><span id="CenterDetermination-999"><a href="#CenterDetermination-999"><span class="linenos"> 999</span></a>
</span><span id="CenterDetermination-1000"><a href="#CenterDetermination-1000"><span class="linenos">1000</span></a><span class="sd">    Parameters</span>
</span><span id="CenterDetermination-1001"><a href="#CenterDetermination-1001"><span class="linenos">1001</span></a><span class="sd">    ----------</span>
</span><span id="CenterDetermination-1002"><a href="#CenterDetermination-1002"><span class="linenos">1002</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="CenterDetermination-1003"><a href="#CenterDetermination-1003"><span class="linenos">1003</span></a><span class="sd">        Reference to the parent CenterLocator object, allowing access </span>
</span><span id="CenterDetermination-1004"><a href="#CenterDetermination-1004"><span class="linenos">1004</span></a><span class="sd">        to shared attributes and methods.</span>
</span><span id="CenterDetermination-1005"><a href="#CenterDetermination-1005"><span class="linenos">1005</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1006"><a href="#CenterDetermination-1006"><span class="linenos">1006</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="CenterDetermination-1007"><a href="#CenterDetermination-1007"><span class="linenos">1007</span></a><span class="sd">        The input image representing a 2D diffraction pattern, provided as </span>
</span><span id="CenterDetermination-1008"><a href="#CenterDetermination-1008"><span class="linenos">1008</span></a><span class="sd">        a file path or a NumPy array.</span>
</span><span id="CenterDetermination-1009"><a href="#CenterDetermination-1009"><span class="linenos">1009</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1010"><a href="#CenterDetermination-1010"><span class="linenos">1010</span></a><span class="sd">    determination : str or None, optional, default=None</span>
</span><span id="CenterDetermination-1011"><a href="#CenterDetermination-1011"><span class="linenos">1011</span></a><span class="sd">        Method used for the initial center determination.</span>
</span><span id="CenterDetermination-1012"><a href="#CenterDetermination-1012"><span class="linenos">1012</span></a><span class="sd">        Options include:</span>
</span><span id="CenterDetermination-1013"><a href="#CenterDetermination-1013"><span class="linenos">1013</span></a><span class="sd">        - &#39;manual&#39;   : Manual selection of 3 points on a diffraction ring.</span>
</span><span id="CenterDetermination-1014"><a href="#CenterDetermination-1014"><span class="linenos">1014</span></a><span class="sd">        - &#39;hough&#39;    : Automatic detection using Hough transform.</span>
</span><span id="CenterDetermination-1015"><a href="#CenterDetermination-1015"><span class="linenos">1015</span></a><span class="sd">        - &#39;intensity&#39;: Automatic detection based on the intensity center </span>
</span><span id="CenterDetermination-1016"><a href="#CenterDetermination-1016"><span class="linenos">1016</span></a><span class="sd">                       of the central region.</span>
</span><span id="CenterDetermination-1017"><a href="#CenterDetermination-1017"><span class="linenos">1017</span></a><span class="sd">        - &#39;phase&#39;    : Automatic detection using phase correlation to find </span>
</span><span id="CenterDetermination-1018"><a href="#CenterDetermination-1018"><span class="linenos">1018</span></a><span class="sd">                       the symmetry center.</span>
</span><span id="CenterDetermination-1019"><a href="#CenterDetermination-1019"><span class="linenos">1019</span></a><span class="sd">        - &#39;ccorr&#39;    : Automatic detection using cross-correlation to find </span>
</span><span id="CenterDetermination-1020"><a href="#CenterDetermination-1020"><span class="linenos">1020</span></a><span class="sd">                       the symmetry center.</span>
</span><span id="CenterDetermination-1021"><a href="#CenterDetermination-1021"><span class="linenos">1021</span></a><span class="sd">        - &#39;curvefit&#39; : Automatic detecting using pseudo-Voigt profile fitting </span>
</span><span id="CenterDetermination-1022"><a href="#CenterDetermination-1022"><span class="linenos">1022</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1023"><a href="#CenterDetermination-1023"><span class="linenos">1023</span></a><span class="sd">    in_file : str or None, optional, default=None</span>
</span><span id="CenterDetermination-1024"><a href="#CenterDetermination-1024"><span class="linenos">1024</span></a><span class="sd">        Path to the file from which previously saved coordinates will be loaded.</span>
</span><span id="CenterDetermination-1025"><a href="#CenterDetermination-1025"><span class="linenos">1025</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1026"><a href="#CenterDetermination-1026"><span class="linenos">1026</span></a><span class="sd">    out_file : str or None, optional, default=None</span>
</span><span id="CenterDetermination-1027"><a href="#CenterDetermination-1027"><span class="linenos">1027</span></a><span class="sd">        Path to the file where the determined coordinates will be saved.</span>
</span><span id="CenterDetermination-1028"><a href="#CenterDetermination-1028"><span class="linenos">1028</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1029"><a href="#CenterDetermination-1029"><span class="linenos">1029</span></a><span class="sd">    sobel : bool, optional, default=False</span>
</span><span id="CenterDetermination-1030"><a href="#CenterDetermination-1030"><span class="linenos">1030</span></a><span class="sd">        If True, apply Sobel filter to the image before processing.</span>
</span><span id="CenterDetermination-1031"><a href="#CenterDetermination-1031"><span class="linenos">1031</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1032"><a href="#CenterDetermination-1032"><span class="linenos">1032</span></a><span class="sd">    heq : bool or None, optional, default=False</span>
</span><span id="CenterDetermination-1033"><a href="#CenterDetermination-1033"><span class="linenos">1033</span></a><span class="sd">        If True, apply histogram equalization internally (display unchanged).</span>
</span><span id="CenterDetermination-1034"><a href="#CenterDetermination-1034"><span class="linenos">1034</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1035"><a href="#CenterDetermination-1035"><span class="linenos">1035</span></a><span class="sd">    icut : float or None, optional, default=None</span>
</span><span id="CenterDetermination-1036"><a href="#CenterDetermination-1036"><span class="linenos">1036</span></a><span class="sd">        Cut-off intensity level for processing the image.</span>
</span><span id="CenterDetermination-1037"><a href="#CenterDetermination-1037"><span class="linenos">1037</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1038"><a href="#CenterDetermination-1038"><span class="linenos">1038</span></a><span class="sd">    cmap : str, optional, default=&#39;gray&#39;</span>
</span><span id="CenterDetermination-1039"><a href="#CenterDetermination-1039"><span class="linenos">1039</span></a><span class="sd">        Matplotlib colormap name used for displaying the image.</span>
</span><span id="CenterDetermination-1040"><a href="#CenterDetermination-1040"><span class="linenos">1040</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1041"><a href="#CenterDetermination-1041"><span class="linenos">1041</span></a><span class="sd">    csquare : int, optional, defaul=50</span>
</span><span id="CenterDetermination-1042"><a href="#CenterDetermination-1042"><span class="linenos">1042</span></a><span class="sd">        Size (in pixels) of the central square used for initial center search.</span>
</span><span id="CenterDetermination-1043"><a href="#CenterDetermination-1043"><span class="linenos">1043</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1044"><a href="#CenterDetermination-1044"><span class="linenos">1044</span></a><span class="sd">    cintensity : float, optional, default=0.8</span>
</span><span id="CenterDetermination-1045"><a href="#CenterDetermination-1045"><span class="linenos">1045</span></a><span class="sd">        Threshold intensity for finding the intensity center. Pixels with a </span>
</span><span id="CenterDetermination-1046"><a href="#CenterDetermination-1046"><span class="linenos">1046</span></a><span class="sd">        (relative) intensity lower than cintensity are ignored.</span>
</span><span id="CenterDetermination-1047"><a href="#CenterDetermination-1047"><span class="linenos">1047</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1048"><a href="#CenterDetermination-1048"><span class="linenos">1048</span></a><span class="sd">    verbose : bool, optional, default=False</span>
</span><span id="CenterDetermination-1049"><a href="#CenterDetermination-1049"><span class="linenos">1049</span></a><span class="sd">        If True, print informational verbose during the detection process.</span>
</span><span id="CenterDetermination-1050"><a href="#CenterDetermination-1050"><span class="linenos">1050</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1051"><a href="#CenterDetermination-1051"><span class="linenos">1051</span></a><span class="sd">    print_sums : bool, optional, default=False</span>
</span><span id="CenterDetermination-1052"><a href="#CenterDetermination-1052"><span class="linenos">1052</span></a><span class="sd">        If True, print intensity sums after each adjustment (in manual modes).</span>
</span><span id="CenterDetermination-1053"><a href="#CenterDetermination-1053"><span class="linenos">1053</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1054"><a href="#CenterDetermination-1054"><span class="linenos">1054</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1055"><a href="#CenterDetermination-1055"><span class="linenos">1055</span></a>
</span><span id="CenterDetermination-1056"><a href="#CenterDetermination-1056"><span class="linenos">1056</span></a><span class="sd">    Returns</span>
</span><span id="CenterDetermination-1057"><a href="#CenterDetermination-1057"><span class="linenos">1057</span></a><span class="sd">    -------</span>
</span><span id="CenterDetermination-1058"><a href="#CenterDetermination-1058"><span class="linenos">1058</span></a><span class="sd">    None</span>
</span><span id="CenterDetermination-1059"><a href="#CenterDetermination-1059"><span class="linenos">1059</span></a>
</span><span id="CenterDetermination-1060"><a href="#CenterDetermination-1060"><span class="linenos">1060</span></a><span class="sd">    Notes</span>
</span><span id="CenterDetermination-1061"><a href="#CenterDetermination-1061"><span class="linenos">1061</span></a><span class="sd">    -----</span>
</span><span id="CenterDetermination-1062"><a href="#CenterDetermination-1062"><span class="linenos">1062</span></a><span class="sd">    - The class preprocesses the input image and then applies the specified </span>
</span><span id="CenterDetermination-1063"><a href="#CenterDetermination-1063"><span class="linenos">1063</span></a><span class="sd">      center detection method.</span>
</span><span id="CenterDetermination-1064"><a href="#CenterDetermination-1064"><span class="linenos">1064</span></a><span class="sd">    - The detected center coordinates are stored in instance variables</span>
</span><span id="CenterDetermination-1065"><a href="#CenterDetermination-1065"><span class="linenos">1065</span></a><span class="sd">      `x`, `y`, and `r`, representing the center&#39;s x-coordinate, </span>
</span><span id="CenterDetermination-1066"><a href="#CenterDetermination-1066"><span class="linenos">1066</span></a><span class="sd">      y-coordinate, and radius, respectively.</span>
</span><span id="CenterDetermination-1067"><a href="#CenterDetermination-1067"><span class="linenos">1067</span></a><span class="sd">      </span>
</span><span id="CenterDetermination-1068"><a href="#CenterDetermination-1068"><span class="linenos">1068</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1069"><a href="#CenterDetermination-1069"><span class="linenos">1069</span></a>    
</span><span id="CenterDetermination-1070"><a href="#CenterDetermination-1070"><span class="linenos">1070</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="CenterDetermination-1071"><a href="#CenterDetermination-1071"><span class="linenos">1071</span></a>                 <span class="n">input_image</span><span class="p">,</span>
</span><span id="CenterDetermination-1072"><a href="#CenterDetermination-1072"><span class="linenos">1072</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="CenterDetermination-1073"><a href="#CenterDetermination-1073"><span class="linenos">1073</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterDetermination-1074"><a href="#CenterDetermination-1074"><span class="linenos">1074</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterDetermination-1075"><a href="#CenterDetermination-1075"><span class="linenos">1075</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination-1076"><a href="#CenterDetermination-1076"><span class="linenos">1076</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterDetermination-1077"><a href="#CenterDetermination-1077"><span class="linenos">1077</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="CenterDetermination-1078"><a href="#CenterDetermination-1078"><span class="linenos">1078</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="CenterDetermination-1079"><a href="#CenterDetermination-1079"><span class="linenos">1079</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="CenterDetermination-1080"><a href="#CenterDetermination-1080"><span class="linenos">1080</span></a>                 <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CenterDetermination-1081"><a href="#CenterDetermination-1081"><span class="linenos">1081</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination-1082"><a href="#CenterDetermination-1082"><span class="linenos">1082</span></a>
</span><span id="CenterDetermination-1083"><a href="#CenterDetermination-1083"><span class="linenos">1083</span></a>        
</span><span id="CenterDetermination-1084"><a href="#CenterDetermination-1084"><span class="linenos">1084</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterDetermination-1085"><a href="#CenterDetermination-1085"><span class="linenos">1085</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="CenterDetermination-1086"><a href="#CenterDetermination-1086"><span class="linenos">1086</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="CenterDetermination-1087"><a href="#CenterDetermination-1087"><span class="linenos">1087</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterDetermination-1088"><a href="#CenterDetermination-1088"><span class="linenos">1088</span></a>        
</span><span id="CenterDetermination-1089"><a href="#CenterDetermination-1089"><span class="linenos">1089</span></a>        <span class="c1">## (0) Initialize input attributes -----------------------------------</span>
</span><span id="CenterDetermination-1090"><a href="#CenterDetermination-1090"><span class="linenos">1090</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="CenterDetermination-1091"><a href="#CenterDetermination-1091"><span class="linenos">1091</span></a>        
</span><span id="CenterDetermination-1092"><a href="#CenterDetermination-1092"><span class="linenos">1092</span></a>        <span class="c1">## (1) Initialize new attributes -------------------------------------</span>
</span><span id="CenterDetermination-1093"><a href="#CenterDetermination-1093"><span class="linenos">1093</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span> 
</span><span id="CenterDetermination-1094"><a href="#CenterDetermination-1094"><span class="linenos">1094</span></a>        
</span><span id="CenterDetermination-1095"><a href="#CenterDetermination-1095"><span class="linenos">1095</span></a>        <span class="c1">## (2) Run functions -------------------------------------------------</span>
</span><span id="CenterDetermination-1096"><a href="#CenterDetermination-1096"><span class="linenos">1096</span></a>        <span class="c1">#  (2a) Preprocess data</span>
</span><span id="CenterDetermination-1097"><a href="#CenterDetermination-1097"><span class="linenos">1097</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">preInit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1098"><a href="#CenterDetermination-1098"><span class="linenos">1098</span></a>        
</span><span id="CenterDetermination-1099"><a href="#CenterDetermination-1099"><span class="linenos">1099</span></a>        <span class="c1">#  (2b) Center detection methods</span>
</span><span id="CenterDetermination-1100"><a href="#CenterDetermination-1100"><span class="linenos">1100</span></a>        <span class="k">if</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-1101"><a href="#CenterDetermination-1101"><span class="linenos">1101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_3points</span><span class="p">()</span>
</span><span id="CenterDetermination-1102"><a href="#CenterDetermination-1102"><span class="linenos">1102</span></a>            
</span><span id="CenterDetermination-1103"><a href="#CenterDetermination-1103"><span class="linenos">1103</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hough&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-1104"><a href="#CenterDetermination-1104"><span class="linenos">1104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_Hough</span><span class="p">(</span>
</span><span id="CenterDetermination-1105"><a href="#CenterDetermination-1105"><span class="linenos">1105</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">,</span>
</span><span id="CenterDetermination-1106"><a href="#CenterDetermination-1106"><span class="linenos">1106</span></a>                <span class="n">live_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">live_plot</span><span class="p">)</span>
</span><span id="CenterDetermination-1107"><a href="#CenterDetermination-1107"><span class="linenos">1107</span></a>            
</span><span id="CenterDetermination-1108"><a href="#CenterDetermination-1108"><span class="linenos">1108</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-1109"><a href="#CenterDetermination-1109"><span class="linenos">1109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_intensity</span><span class="p">(</span>
</span><span id="CenterDetermination-1110"><a href="#CenterDetermination-1110"><span class="linenos">1110</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span> 
</span><span id="CenterDetermination-1111"><a href="#CenterDetermination-1111"><span class="linenos">1111</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cintensity</span><span class="p">,</span>
</span><span id="CenterDetermination-1112"><a href="#CenterDetermination-1112"><span class="linenos">1112</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">)</span>
</span><span id="CenterDetermination-1113"><a href="#CenterDetermination-1113"><span class="linenos">1113</span></a>            
</span><span id="CenterDetermination-1114"><a href="#CenterDetermination-1114"><span class="linenos">1114</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;phase&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-1115"><a href="#CenterDetermination-1115"><span class="linenos">1115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_phase</span><span class="p">(</span>
</span><span id="CenterDetermination-1116"><a href="#CenterDetermination-1116"><span class="linenos">1116</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">,</span>
</span><span id="CenterDetermination-1117"><a href="#CenterDetermination-1117"><span class="linenos">1117</span></a>                <span class="n">masking</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">masking</span><span class="p">)</span>
</span><span id="CenterDetermination-1118"><a href="#CenterDetermination-1118"><span class="linenos">1118</span></a>         
</span><span id="CenterDetermination-1119"><a href="#CenterDetermination-1119"><span class="linenos">1119</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ccorr&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-1120"><a href="#CenterDetermination-1120"><span class="linenos">1120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_crosscorr</span><span class="p">(</span>
</span><span id="CenterDetermination-1121"><a href="#CenterDetermination-1121"><span class="linenos">1121</span></a>                <span class="n">sobel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sobel</span><span class="p">,</span>
</span><span id="CenterDetermination-1122"><a href="#CenterDetermination-1122"><span class="linenos">1122</span></a>                <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1123"><a href="#CenterDetermination-1123"><span class="linenos">1123</span></a>        
</span><span id="CenterDetermination-1124"><a href="#CenterDetermination-1124"><span class="linenos">1124</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;curvefit&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-1125"><a href="#CenterDetermination-1125"><span class="linenos">1125</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_curvefit</span><span class="p">()</span>
</span><span id="CenterDetermination-1126"><a href="#CenterDetermination-1126"><span class="linenos">1126</span></a>                
</span><span id="CenterDetermination-1127"><a href="#CenterDetermination-1127"><span class="linenos">1127</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterDetermination-1128"><a href="#CenterDetermination-1128"><span class="linenos">1128</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected determination method does not exist.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1129"><a href="#CenterDetermination-1129"><span class="linenos">1129</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterDetermination-1130"><a href="#CenterDetermination-1130"><span class="linenos">1130</span></a>
</span><span id="CenterDetermination-1131"><a href="#CenterDetermination-1131"><span class="linenos">1131</span></a>
</span><span id="CenterDetermination-1132"><a href="#CenterDetermination-1132"><span class="linenos">1132</span></a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preInit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preHough</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preManual</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CenterDetermination-1133"><a href="#CenterDetermination-1133"><span class="linenos">1133</span></a>                   <span class="n">preVar</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preSum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preInt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  
</span><span id="CenterDetermination-1134"><a href="#CenterDetermination-1134"><span class="linenos">1134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1135"><a href="#CenterDetermination-1135"><span class="linenos">1135</span></a><span class="sd">        Preprocess the input image based on the selected automatic detection </span>
</span><span id="CenterDetermination-1136"><a href="#CenterDetermination-1136"><span class="linenos">1136</span></a><span class="sd">        and refinement methods.</span>
</span><span id="CenterDetermination-1137"><a href="#CenterDetermination-1137"><span class="linenos">1137</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1138"><a href="#CenterDetermination-1138"><span class="linenos">1138</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1139"><a href="#CenterDetermination-1139"><span class="linenos">1139</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1140"><a href="#CenterDetermination-1140"><span class="linenos">1140</span></a><span class="sd">        preInit : bool, optional, default=0</span>
</span><span id="CenterDetermination-1141"><a href="#CenterDetermination-1141"><span class="linenos">1141</span></a><span class="sd">            Preprocess the original image using initialization methods such as</span>
</span><span id="CenterDetermination-1142"><a href="#CenterDetermination-1142"><span class="linenos">1142</span></a><span class="sd">            histogram equalization (heq) or contrast clipping (icut). This</span>
</span><span id="CenterDetermination-1143"><a href="#CenterDetermination-1143"><span class="linenos">1143</span></a><span class="sd">            is used to enhance the input image prior to any detection or</span>
</span><span id="CenterDetermination-1144"><a href="#CenterDetermination-1144"><span class="linenos">1144</span></a><span class="sd">            correction.</span>
</span><span id="CenterDetermination-1145"><a href="#CenterDetermination-1145"><span class="linenos">1145</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1146"><a href="#CenterDetermination-1146"><span class="linenos">1146</span></a><span class="sd">        preHough : bool, optional, default=0</span>
</span><span id="CenterDetermination-1147"><a href="#CenterDetermination-1147"><span class="linenos">1147</span></a><span class="sd">            Perform preprocessing required for Hough transform-based automatic </span>
</span><span id="CenterDetermination-1148"><a href="#CenterDetermination-1148"><span class="linenos">1148</span></a><span class="sd">            detection. This includes edge detection and handling beamstoppers. </span>
</span><span id="CenterDetermination-1149"><a href="#CenterDetermination-1149"><span class="linenos">1149</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1150"><a href="#CenterDetermination-1150"><span class="linenos">1150</span></a><span class="sd">        preManual, preVar, preSum, preInt : bool, optional, default=0</span>
</span><span id="CenterDetermination-1151"><a href="#CenterDetermination-1151"><span class="linenos">1151</span></a><span class="sd">            Placeholder flags for future preprocessing needs for manual </span>
</span><span id="CenterDetermination-1152"><a href="#CenterDetermination-1152"><span class="linenos">1152</span></a><span class="sd">            detection and different refinement methods (variance, sum, </span>
</span><span id="CenterDetermination-1153"><a href="#CenterDetermination-1153"><span class="linenos">1153</span></a><span class="sd">            intensity-based). Currently unused.</span>
</span><span id="CenterDetermination-1154"><a href="#CenterDetermination-1154"><span class="linenos">1154</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1155"><a href="#CenterDetermination-1155"><span class="linenos">1155</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1156"><a href="#CenterDetermination-1156"><span class="linenos">1156</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1157"><a href="#CenterDetermination-1157"><span class="linenos">1157</span></a><span class="sd">        edges : np.ndarray of bool, optional</span>
</span><span id="CenterDetermination-1158"><a href="#CenterDetermination-1158"><span class="linenos">1158</span></a><span class="sd">            Edge map obtained using the Canny edge detector, required for Hough</span>
</span><span id="CenterDetermination-1159"><a href="#CenterDetermination-1159"><span class="linenos">1159</span></a><span class="sd">            transform. Only returned if `preHough` is True.</span>
</span><span id="CenterDetermination-1160"><a href="#CenterDetermination-1160"><span class="linenos">1160</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1161"><a href="#CenterDetermination-1161"><span class="linenos">1161</span></a><span class="sd">        Notes</span>
</span><span id="CenterDetermination-1162"><a href="#CenterDetermination-1162"><span class="linenos">1162</span></a><span class="sd">        -----</span>
</span><span id="CenterDetermination-1163"><a href="#CenterDetermination-1163"><span class="linenos">1163</span></a><span class="sd">        This function performs different preprocessing steps depending on the</span>
</span><span id="CenterDetermination-1164"><a href="#CenterDetermination-1164"><span class="linenos">1164</span></a><span class="sd">        detection/refinement strategy selected. It is modular and supports</span>
</span><span id="CenterDetermination-1165"><a href="#CenterDetermination-1165"><span class="linenos">1165</span></a><span class="sd">        optional display of intermediate results if `self.parent.verbose` is True.</span>
</span><span id="CenterDetermination-1166"><a href="#CenterDetermination-1166"><span class="linenos">1166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1167"><a href="#CenterDetermination-1167"><span class="linenos">1167</span></a>    
</span><span id="CenterDetermination-1168"><a href="#CenterDetermination-1168"><span class="linenos">1168</span></a>        <span class="c1"># Flags</span>
</span><span id="CenterDetermination-1169"><a href="#CenterDetermination-1169"><span class="linenos">1169</span></a>        <span class="n">control_print</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-1170"><a href="#CenterDetermination-1170"><span class="linenos">1170</span></a>        
</span><span id="CenterDetermination-1171"><a href="#CenterDetermination-1171"><span class="linenos">1171</span></a>        <span class="c1"># Load original image</span>
</span><span id="CenterDetermination-1172"><a href="#CenterDetermination-1172"><span class="linenos">1172</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-1173"><a href="#CenterDetermination-1173"><span class="linenos">1173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1174"><a href="#CenterDetermination-1174"><span class="linenos">1174</span></a>            
</span><span id="CenterDetermination-1175"><a href="#CenterDetermination-1175"><span class="linenos">1175</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-1176"><a href="#CenterDetermination-1176"><span class="linenos">1176</span></a>        
</span><span id="CenterDetermination-1177"><a href="#CenterDetermination-1177"><span class="linenos">1177</span></a>        <span class="c1">### After initialization: perform an image enhancement if specified</span>
</span><span id="CenterDetermination-1178"><a href="#CenterDetermination-1178"><span class="linenos">1178</span></a>        <span class="k">if</span> <span class="n">preInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1179"><a href="#CenterDetermination-1179"><span class="linenos">1179</span></a>            <span class="c1"># Enhance diffraction pattern to make it more visible</span>
</span><span id="CenterDetermination-1180"><a href="#CenterDetermination-1180"><span class="linenos">1180</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1181"><a href="#CenterDetermination-1181"><span class="linenos">1181</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-1182"><a href="#CenterDetermination-1182"><span class="linenos">1182</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Histogram equalized.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1183"><a href="#CenterDetermination-1183"><span class="linenos">1183</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">equalize_adapthist</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-1184"><a href="#CenterDetermination-1184"><span class="linenos">1184</span></a>
</span><span id="CenterDetermination-1185"><a href="#CenterDetermination-1185"><span class="linenos">1185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="CenterDetermination-1186"><a href="#CenterDetermination-1186"><span class="linenos">1186</span></a>            <span class="k">return</span>
</span><span id="CenterDetermination-1187"><a href="#CenterDetermination-1187"><span class="linenos">1187</span></a>        
</span><span id="CenterDetermination-1188"><a href="#CenterDetermination-1188"><span class="linenos">1188</span></a>        <span class="c1">### Hough transform: perform pre-processing necessary for the detection</span>
</span><span id="CenterDetermination-1189"><a href="#CenterDetermination-1189"><span class="linenos">1189</span></a>        <span class="k">if</span> <span class="n">preHough</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>           
</span><span id="CenterDetermination-1190"><a href="#CenterDetermination-1190"><span class="linenos">1190</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-1191"><a href="#CenterDetermination-1191"><span class="linenos">1191</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination-1192"><a href="#CenterDetermination-1192"><span class="linenos">1192</span></a>                
</span><span id="CenterDetermination-1193"><a href="#CenterDetermination-1193"><span class="linenos">1193</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination-1194"><a href="#CenterDetermination-1194"><span class="linenos">1194</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-1195"><a href="#CenterDetermination-1195"><span class="linenos">1195</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-1196"><a href="#CenterDetermination-1196"><span class="linenos">1196</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beamstopper removed.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1197"><a href="#CenterDetermination-1197"><span class="linenos">1197</span></a>                    <span class="n">max_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination-1198"><a href="#CenterDetermination-1198"><span class="linenos">1198</span></a>        
</span><span id="CenterDetermination-1199"><a href="#CenterDetermination-1199"><span class="linenos">1199</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-1200"><a href="#CenterDetermination-1200"><span class="linenos">1200</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1201"><a href="#CenterDetermination-1201"><span class="linenos">1201</span></a>        
</span><span id="CenterDetermination-1202"><a href="#CenterDetermination-1202"><span class="linenos">1202</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination-1203"><a href="#CenterDetermination-1203"><span class="linenos">1203</span></a>                    
</span><span id="CenterDetermination-1204"><a href="#CenterDetermination-1204"><span class="linenos">1204</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1205"><a href="#CenterDetermination-1205"><span class="linenos">1205</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination-1206"><a href="#CenterDetermination-1206"><span class="linenos">1206</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-1207"><a href="#CenterDetermination-1207"><span class="linenos">1207</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1208"><a href="#CenterDetermination-1208"><span class="linenos">1208</span></a>        
</span><span id="CenterDetermination-1209"><a href="#CenterDetermination-1209"><span class="linenos">1209</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   
</span><span id="CenterDetermination-1210"><a href="#CenterDetermination-1210"><span class="linenos">1210</span></a>                    
</span><span id="CenterDetermination-1211"><a href="#CenterDetermination-1211"><span class="linenos">1211</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-1212"><a href="#CenterDetermination-1212"><span class="linenos">1212</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-1213"><a href="#CenterDetermination-1213"><span class="linenos">1213</span></a>                            <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1214"><a href="#CenterDetermination-1214"><span class="linenos">1214</span></a>                            <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination-1215"><a href="#CenterDetermination-1215"><span class="linenos">1215</span></a>                            <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-1216"><a href="#CenterDetermination-1216"><span class="linenos">1216</span></a>                    
</span><span id="CenterDetermination-1217"><a href="#CenterDetermination-1217"><span class="linenos">1217</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination-1218"><a href="#CenterDetermination-1218"><span class="linenos">1218</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="CenterDetermination-1219"><a href="#CenterDetermination-1219"><span class="linenos">1219</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-1220"><a href="#CenterDetermination-1220"><span class="linenos">1220</span></a>                    
</span><span id="CenterDetermination-1221"><a href="#CenterDetermination-1221"><span class="linenos">1221</span></a>                    <span class="c1"># Erode the dilated edges</span>
</span><span id="CenterDetermination-1222"><a href="#CenterDetermination-1222"><span class="linenos">1222</span></a>                    <span class="c1"># to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination-1223"><a href="#CenterDetermination-1223"><span class="linenos">1223</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-1224"><a href="#CenterDetermination-1224"><span class="linenos">1224</span></a>
</span><span id="CenterDetermination-1225"><a href="#CenterDetermination-1225"><span class="linenos">1225</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1226"><a href="#CenterDetermination-1226"><span class="linenos">1226</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1227"><a href="#CenterDetermination-1227"><span class="linenos">1227</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1228"><a href="#CenterDetermination-1228"><span class="linenos">1228</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1229"><a href="#CenterDetermination-1229"><span class="linenos">1229</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1230"><a href="#CenterDetermination-1230"><span class="linenos">1230</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1231"><a href="#CenterDetermination-1231"><span class="linenos">1231</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1232"><a href="#CenterDetermination-1232"><span class="linenos">1232</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1233"><a href="#CenterDetermination-1233"><span class="linenos">1233</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1234"><a href="#CenterDetermination-1234"><span class="linenos">1234</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1235"><a href="#CenterDetermination-1235"><span class="linenos">1235</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1236"><a href="#CenterDetermination-1236"><span class="linenos">1236</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1237"><a href="#CenterDetermination-1237"><span class="linenos">1237</span></a>                        
</span><span id="CenterDetermination-1238"><a href="#CenterDetermination-1238"><span class="linenos">1238</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination-1239"><a href="#CenterDetermination-1239"><span class="linenos">1239</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1240"><a href="#CenterDetermination-1240"><span class="linenos">1240</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-1241"><a href="#CenterDetermination-1241"><span class="linenos">1241</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No beamstopper.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1242"><a href="#CenterDetermination-1242"><span class="linenos">1242</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-1243"><a href="#CenterDetermination-1243"><span class="linenos">1243</span></a>                                             <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1244"><a href="#CenterDetermination-1244"><span class="linenos">1244</span></a>                                             <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination-1245"><a href="#CenterDetermination-1245"><span class="linenos">1245</span></a>                                             <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination-1246"><a href="#CenterDetermination-1246"><span class="linenos">1246</span></a>                    
</span><span id="CenterDetermination-1247"><a href="#CenterDetermination-1247"><span class="linenos">1247</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination-1248"><a href="#CenterDetermination-1248"><span class="linenos">1248</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="CenterDetermination-1249"><a href="#CenterDetermination-1249"><span class="linenos">1249</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-1250"><a href="#CenterDetermination-1250"><span class="linenos">1250</span></a>                    
</span><span id="CenterDetermination-1251"><a href="#CenterDetermination-1251"><span class="linenos">1251</span></a>                    <span class="c1"># Erode the dilated edges</span>
</span><span id="CenterDetermination-1252"><a href="#CenterDetermination-1252"><span class="linenos">1252</span></a>                    <span class="c1"># to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination-1253"><a href="#CenterDetermination-1253"><span class="linenos">1253</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-1254"><a href="#CenterDetermination-1254"><span class="linenos">1254</span></a>                    <span class="n">connected_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
</span><span id="CenterDetermination-1255"><a href="#CenterDetermination-1255"><span class="linenos">1255</span></a>                        <span class="n">connected_edges</span><span class="p">,</span> 
</span><span id="CenterDetermination-1256"><a href="#CenterDetermination-1256"><span class="linenos">1256</span></a>                        <span class="n">min_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination-1257"><a href="#CenterDetermination-1257"><span class="linenos">1257</span></a>                    
</span><span id="CenterDetermination-1258"><a href="#CenterDetermination-1258"><span class="linenos">1258</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1259"><a href="#CenterDetermination-1259"><span class="linenos">1259</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1260"><a href="#CenterDetermination-1260"><span class="linenos">1260</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1261"><a href="#CenterDetermination-1261"><span class="linenos">1261</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1262"><a href="#CenterDetermination-1262"><span class="linenos">1262</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1263"><a href="#CenterDetermination-1263"><span class="linenos">1263</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1264"><a href="#CenterDetermination-1264"><span class="linenos">1264</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,)</span>
</span><span id="CenterDetermination-1265"><a href="#CenterDetermination-1265"><span class="linenos">1265</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1266"><a href="#CenterDetermination-1266"><span class="linenos">1266</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1267"><a href="#CenterDetermination-1267"><span class="linenos">1267</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1268"><a href="#CenterDetermination-1268"><span class="linenos">1268</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1269"><a href="#CenterDetermination-1269"><span class="linenos">1269</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1270"><a href="#CenterDetermination-1270"><span class="linenos">1270</span></a>                
</span><span id="CenterDetermination-1271"><a href="#CenterDetermination-1271"><span class="linenos">1271</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
</span><span id="CenterDetermination-1272"><a href="#CenterDetermination-1272"><span class="linenos">1272</span></a>                <span class="c1"># Central square extraction</span>
</span><span id="CenterDetermination-1273"><a href="#CenterDetermination-1273"><span class="linenos">1273</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination-1274"><a href="#CenterDetermination-1274"><span class="linenos">1274</span></a>
</span><span id="CenterDetermination-1275"><a href="#CenterDetermination-1275"><span class="linenos">1275</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination-1276"><a href="#CenterDetermination-1276"><span class="linenos">1276</span></a>                <span class="k">if</span> <span class="mf">0.4</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.6</span><span class="p">:</span>
</span><span id="CenterDetermination-1277"><a href="#CenterDetermination-1277"><span class="linenos">1277</span></a>                    
</span><span id="CenterDetermination-1278"><a href="#CenterDetermination-1278"><span class="linenos">1278</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1279"><a href="#CenterDetermination-1279"><span class="linenos">1279</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-1280"><a href="#CenterDetermination-1280"><span class="linenos">1280</span></a>    
</span><span id="CenterDetermination-1281"><a href="#CenterDetermination-1281"><span class="linenos">1281</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-1282"><a href="#CenterDetermination-1282"><span class="linenos">1282</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1283"><a href="#CenterDetermination-1283"><span class="linenos">1283</span></a>    
</span><span id="CenterDetermination-1284"><a href="#CenterDetermination-1284"><span class="linenos">1284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="CenterDetermination-1285"><a href="#CenterDetermination-1285"><span class="linenos">1285</span></a>                                                     
</span><span id="CenterDetermination-1286"><a href="#CenterDetermination-1286"><span class="linenos">1286</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-1287"><a href="#CenterDetermination-1287"><span class="linenos">1287</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination-1288"><a href="#CenterDetermination-1288"><span class="linenos">1288</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-1289"><a href="#CenterDetermination-1289"><span class="linenos">1289</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1290"><a href="#CenterDetermination-1290"><span class="linenos">1290</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination-1291"><a href="#CenterDetermination-1291"><span class="linenos">1291</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-1292"><a href="#CenterDetermination-1292"><span class="linenos">1292</span></a>
</span><span id="CenterDetermination-1293"><a href="#CenterDetermination-1293"><span class="linenos">1293</span></a>                    
</span><span id="CenterDetermination-1294"><a href="#CenterDetermination-1294"><span class="linenos">1294</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1295"><a href="#CenterDetermination-1295"><span class="linenos">1295</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1296"><a href="#CenterDetermination-1296"><span class="linenos">1296</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1297"><a href="#CenterDetermination-1297"><span class="linenos">1297</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1298"><a href="#CenterDetermination-1298"><span class="linenos">1298</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1299"><a href="#CenterDetermination-1299"><span class="linenos">1299</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1300"><a href="#CenterDetermination-1300"><span class="linenos">1300</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1301"><a href="#CenterDetermination-1301"><span class="linenos">1301</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1302"><a href="#CenterDetermination-1302"><span class="linenos">1302</span></a>                      <span class="c1">#  ax[1,1].imshow(connected_edges)</span>
</span><span id="CenterDetermination-1303"><a href="#CenterDetermination-1303"><span class="linenos">1303</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1304"><a href="#CenterDetermination-1304"><span class="linenos">1304</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1305"><a href="#CenterDetermination-1305"><span class="linenos">1305</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1306"><a href="#CenterDetermination-1306"><span class="linenos">1306</span></a>                    
</span><span id="CenterDetermination-1307"><a href="#CenterDetermination-1307"><span class="linenos">1307</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination-1308"><a href="#CenterDetermination-1308"><span class="linenos">1308</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1309"><a href="#CenterDetermination-1309"><span class="linenos">1309</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-1310"><a href="#CenterDetermination-1310"><span class="linenos">1310</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination-1311"><a href="#CenterDetermination-1311"><span class="linenos">1311</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-1312"><a href="#CenterDetermination-1312"><span class="linenos">1312</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1313"><a href="#CenterDetermination-1313"><span class="linenos">1313</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination-1314"><a href="#CenterDetermination-1314"><span class="linenos">1314</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-1315"><a href="#CenterDetermination-1315"><span class="linenos">1315</span></a>
</span><span id="CenterDetermination-1316"><a href="#CenterDetermination-1316"><span class="linenos">1316</span></a>                    
</span><span id="CenterDetermination-1317"><a href="#CenterDetermination-1317"><span class="linenos">1317</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1318"><a href="#CenterDetermination-1318"><span class="linenos">1318</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1319"><a href="#CenterDetermination-1319"><span class="linenos">1319</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1320"><a href="#CenterDetermination-1320"><span class="linenos">1320</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1321"><a href="#CenterDetermination-1321"><span class="linenos">1321</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1322"><a href="#CenterDetermination-1322"><span class="linenos">1322</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1323"><a href="#CenterDetermination-1323"><span class="linenos">1323</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1324"><a href="#CenterDetermination-1324"><span class="linenos">1324</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1325"><a href="#CenterDetermination-1325"><span class="linenos">1325</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1326"><a href="#CenterDetermination-1326"><span class="linenos">1326</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1327"><a href="#CenterDetermination-1327"><span class="linenos">1327</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1328"><a href="#CenterDetermination-1328"><span class="linenos">1328</span></a>            
</span><span id="CenterDetermination-1329"><a href="#CenterDetermination-1329"><span class="linenos">1329</span></a>            <span class="k">return</span> <span class="n">edges</span>
</span><span id="CenterDetermination-1330"><a href="#CenterDetermination-1330"><span class="linenos">1330</span></a>        
</span><span id="CenterDetermination-1331"><a href="#CenterDetermination-1331"><span class="linenos">1331</span></a>
</span><span id="CenterDetermination-1332"><a href="#CenterDetermination-1332"><span class="linenos">1332</span></a>    <span class="k">def</span> <span class="nf">sobel_filt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>   
</span><span id="CenterDetermination-1333"><a href="#CenterDetermination-1333"><span class="linenos">1333</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1334"><a href="#CenterDetermination-1334"><span class="linenos">1334</span></a><span class="sd">        The Sobel filter, which is a simple 3×3 kernel convolved with the image </span>
</span><span id="CenterDetermination-1335"><a href="#CenterDetermination-1335"><span class="linenos">1335</span></a><span class="sd">        which approximates the gradient of intensity in a certain direction. </span>
</span><span id="CenterDetermination-1336"><a href="#CenterDetermination-1336"><span class="linenos">1336</span></a><span class="sd">        Since the Sobel filter is a simple matrix, it can be applied across </span>
</span><span id="CenterDetermination-1337"><a href="#CenterDetermination-1337"><span class="linenos">1337</span></a><span class="sd">        datasets without concern for effects caused by changing user defined </span>
</span><span id="CenterDetermination-1338"><a href="#CenterDetermination-1338"><span class="linenos">1338</span></a><span class="sd">        thresholds, and is much faster and impartial than an iterative method</span>
</span><span id="CenterDetermination-1339"><a href="#CenterDetermination-1339"><span class="linenos">1339</span></a>
</span><span id="CenterDetermination-1340"><a href="#CenterDetermination-1340"><span class="linenos">1340</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1341"><a href="#CenterDetermination-1341"><span class="linenos">1341</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1342"><a href="#CenterDetermination-1342"><span class="linenos">1342</span></a><span class="sd">        image : TYPE</span>
</span><span id="CenterDetermination-1343"><a href="#CenterDetermination-1343"><span class="linenos">1343</span></a><span class="sd">            DESCRIPTION.</span>
</span><span id="CenterDetermination-1344"><a href="#CenterDetermination-1344"><span class="linenos">1344</span></a><span class="sd">        disp : TYPE, optional</span>
</span><span id="CenterDetermination-1345"><a href="#CenterDetermination-1345"><span class="linenos">1345</span></a><span class="sd">            DESCRIPTION. The default is False.</span>
</span><span id="CenterDetermination-1346"><a href="#CenterDetermination-1346"><span class="linenos">1346</span></a>
</span><span id="CenterDetermination-1347"><a href="#CenterDetermination-1347"><span class="linenos">1347</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1348"><a href="#CenterDetermination-1348"><span class="linenos">1348</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1349"><a href="#CenterDetermination-1349"><span class="linenos">1349</span></a><span class="sd">        sobel_magnitude : TYPE</span>
</span><span id="CenterDetermination-1350"><a href="#CenterDetermination-1350"><span class="linenos">1350</span></a><span class="sd">            DESCRIPTION.</span>
</span><span id="CenterDetermination-1351"><a href="#CenterDetermination-1351"><span class="linenos">1351</span></a>
</span><span id="CenterDetermination-1352"><a href="#CenterDetermination-1352"><span class="linenos">1352</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1353"><a href="#CenterDetermination-1353"><span class="linenos">1353</span></a>        <span class="c1"># Apply Sobel filter</span>
</span><span id="CenterDetermination-1354"><a href="#CenterDetermination-1354"><span class="linenos">1354</span></a>        <span class="n">sobel_x</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination-1355"><a href="#CenterDetermination-1355"><span class="linenos">1355</span></a>                            <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> 
</span><span id="CenterDetermination-1356"><a href="#CenterDetermination-1356"><span class="linenos">1356</span></a>                            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
</span><span id="CenterDetermination-1357"><a href="#CenterDetermination-1357"><span class="linenos">1357</span></a>                            <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Horizontal edges</span>
</span><span id="CenterDetermination-1358"><a href="#CenterDetermination-1358"><span class="linenos">1358</span></a>        <span class="n">sobel_y</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination-1359"><a href="#CenterDetermination-1359"><span class="linenos">1359</span></a>                            <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> 
</span><span id="CenterDetermination-1360"><a href="#CenterDetermination-1360"><span class="linenos">1360</span></a>                            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="CenterDetermination-1361"><a href="#CenterDetermination-1361"><span class="linenos">1361</span></a>                            <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Vertical edges</span>
</span><span id="CenterDetermination-1362"><a href="#CenterDetermination-1362"><span class="linenos">1362</span></a>        
</span><span id="CenterDetermination-1363"><a href="#CenterDetermination-1363"><span class="linenos">1363</span></a>        <span class="c1"># # Take absolute values to remove negatives</span>
</span><span id="CenterDetermination-1364"><a href="#CenterDetermination-1364"><span class="linenos">1364</span></a>        <span class="c1"># sobel_x = np.abs(sobel_x)</span>
</span><span id="CenterDetermination-1365"><a href="#CenterDetermination-1365"><span class="linenos">1365</span></a>        <span class="c1"># sobel_y = np.abs(sobel_y)</span>
</span><span id="CenterDetermination-1366"><a href="#CenterDetermination-1366"><span class="linenos">1366</span></a>
</span><span id="CenterDetermination-1367"><a href="#CenterDetermination-1367"><span class="linenos">1367</span></a>        
</span><span id="CenterDetermination-1368"><a href="#CenterDetermination-1368"><span class="linenos">1368</span></a>        <span class="c1"># Compute gradient magnitude</span>
</span><span id="CenterDetermination-1369"><a href="#CenterDetermination-1369"><span class="linenos">1369</span></a>        <span class="n">sobel_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sobel_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sobel_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1370"><a href="#CenterDetermination-1370"><span class="linenos">1370</span></a>        
</span><span id="CenterDetermination-1371"><a href="#CenterDetermination-1371"><span class="linenos">1371</span></a>        <span class="c1"># Normalize</span>
</span><span id="CenterDetermination-1372"><a href="#CenterDetermination-1372"><span class="linenos">1372</span></a>        <span class="n">sobel_magnitude</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1373"><a href="#CenterDetermination-1373"><span class="linenos">1373</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">sobel_magnitude</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sobel_magnitude</span><span class="p">))</span>  
</span><span id="CenterDetermination-1374"><a href="#CenterDetermination-1374"><span class="linenos">1374</span></a>        
</span><span id="CenterDetermination-1375"><a href="#CenterDetermination-1375"><span class="linenos">1375</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination-1376"><a href="#CenterDetermination-1376"><span class="linenos">1376</span></a>            <span class="c1"># Display results</span>
</span><span id="CenterDetermination-1377"><a href="#CenterDetermination-1377"><span class="linenos">1377</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="CenterDetermination-1378"><a href="#CenterDetermination-1378"><span class="linenos">1378</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span><span id="CenterDetermination-1379"><a href="#CenterDetermination-1379"><span class="linenos">1379</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_x</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span> 
</span><span id="CenterDetermination-1380"><a href="#CenterDetermination-1380"><span class="linenos">1380</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sobel X&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1381"><a href="#CenterDetermination-1381"><span class="linenos">1381</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="CenterDetermination-1382"><a href="#CenterDetermination-1382"><span class="linenos">1382</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_y</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span>
</span><span id="CenterDetermination-1383"><a href="#CenterDetermination-1383"><span class="linenos">1383</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sobel Y&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1384"><a href="#CenterDetermination-1384"><span class="linenos">1384</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
</span><span id="CenterDetermination-1385"><a href="#CenterDetermination-1385"><span class="linenos">1385</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_magnitude</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span> 
</span><span id="CenterDetermination-1386"><a href="#CenterDetermination-1386"><span class="linenos">1386</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gradient Magnitude&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1387"><a href="#CenterDetermination-1387"><span class="linenos">1387</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-1388"><a href="#CenterDetermination-1388"><span class="linenos">1388</span></a>        
</span><span id="CenterDetermination-1389"><a href="#CenterDetermination-1389"><span class="linenos">1389</span></a>        <span class="k">return</span> <span class="n">sobel_magnitude</span>
</span><span id="CenterDetermination-1390"><a href="#CenterDetermination-1390"><span class="linenos">1390</span></a>    
</span><span id="CenterDetermination-1391"><a href="#CenterDetermination-1391"><span class="linenos">1391</span></a>    
</span><span id="CenterDetermination-1392"><a href="#CenterDetermination-1392"><span class="linenos">1392</span></a>    <span class="k">def</span> <span class="nf">detection_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination-1393"><a href="#CenterDetermination-1393"><span class="linenos">1393</span></a>                        <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">masking</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="CenterDetermination-1394"><a href="#CenterDetermination-1394"><span class="linenos">1394</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1395"><a href="#CenterDetermination-1395"><span class="linenos">1395</span></a><span class="sd">        Detects the center of symmetry in a diffraction image using a </span>
</span><span id="CenterDetermination-1396"><a href="#CenterDetermination-1396"><span class="linenos">1396</span></a><span class="sd">        combination of weighted intensity averaging and phase cross-correlation.</span>
</span><span id="CenterDetermination-1397"><a href="#CenterDetermination-1397"><span class="linenos">1397</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1398"><a href="#CenterDetermination-1398"><span class="linenos">1398</span></a><span class="sd">        This method performs the following steps:</span>
</span><span id="CenterDetermination-1399"><a href="#CenterDetermination-1399"><span class="linenos">1399</span></a><span class="sd">            1. Estimates an initial center using a weighted average of pixel </span>
</span><span id="CenterDetermination-1400"><a href="#CenterDetermination-1400"><span class="linenos">1400</span></a><span class="sd">               intensities.</span>
</span><span id="CenterDetermination-1401"><a href="#CenterDetermination-1401"><span class="linenos">1401</span></a><span class="sd">            2. Crops the image to focus on its central region.</span>
</span><span id="CenterDetermination-1402"><a href="#CenterDetermination-1402"><span class="linenos">1402</span></a><span class="sd">            3. Optionally normalizes the background to mitigate experimental </span>
</span><span id="CenterDetermination-1403"><a href="#CenterDetermination-1403"><span class="linenos">1403</span></a><span class="sd">               artifacts.</span>
</span><span id="CenterDetermination-1404"><a href="#CenterDetermination-1404"><span class="linenos">1404</span></a><span class="sd">            4. Computes a refined center via inversion symmetry and phase </span>
</span><span id="CenterDetermination-1405"><a href="#CenterDetermination-1405"><span class="linenos">1405</span></a><span class="sd">               cross-correlation.</span>
</span><span id="CenterDetermination-1406"><a href="#CenterDetermination-1406"><span class="linenos">1406</span></a><span class="sd">            5. Returns the final refined center coordinates.</span>
</span><span id="CenterDetermination-1407"><a href="#CenterDetermination-1407"><span class="linenos">1407</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1408"><a href="#CenterDetermination-1408"><span class="linenos">1408</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1409"><a href="#CenterDetermination-1409"><span class="linenos">1409</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1410"><a href="#CenterDetermination-1410"><span class="linenos">1410</span></a><span class="sd">        normalize_bg : bool, optional, default=True</span>
</span><span id="CenterDetermination-1411"><a href="#CenterDetermination-1411"><span class="linenos">1411</span></a><span class="sd">            If True, normalize background intensity to reduce artifacts.</span>
</span><span id="CenterDetermination-1412"><a href="#CenterDetermination-1412"><span class="linenos">1412</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1413"><a href="#CenterDetermination-1413"><span class="linenos">1413</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="CenterDetermination-1414"><a href="#CenterDetermination-1414"><span class="linenos">1414</span></a><span class="sd">            If True, applies Sobel filtering (currently unused if not implemented)</span>
</span><span id="CenterDetermination-1415"><a href="#CenterDetermination-1415"><span class="linenos">1415</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1416"><a href="#CenterDetermination-1416"><span class="linenos">1416</span></a><span class="sd">        disp : bool, optional, default=False</span>
</span><span id="CenterDetermination-1417"><a href="#CenterDetermination-1417"><span class="linenos">1417</span></a><span class="sd">            If True, displays intermediate processing results. </span>
</span><span id="CenterDetermination-1418"><a href="#CenterDetermination-1418"><span class="linenos">1418</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1419"><a href="#CenterDetermination-1419"><span class="linenos">1419</span></a><span class="sd">        masking : bool, optional, default=True</span>
</span><span id="CenterDetermination-1420"><a href="#CenterDetermination-1420"><span class="linenos">1420</span></a><span class="sd">            If True, applies masking to exclude unwanted regions from analysis</span>
</span><span id="CenterDetermination-1421"><a href="#CenterDetermination-1421"><span class="linenos">1421</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1422"><a href="#CenterDetermination-1422"><span class="linenos">1422</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1423"><a href="#CenterDetermination-1423"><span class="linenos">1423</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1424"><a href="#CenterDetermination-1424"><span class="linenos">1424</span></a><span class="sd">        r_final : float</span>
</span><span id="CenterDetermination-1425"><a href="#CenterDetermination-1425"><span class="linenos">1425</span></a><span class="sd">            Estimated row-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination-1426"><a href="#CenterDetermination-1426"><span class="linenos">1426</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1427"><a href="#CenterDetermination-1427"><span class="linenos">1427</span></a><span class="sd">        c_final : float</span>
</span><span id="CenterDetermination-1428"><a href="#CenterDetermination-1428"><span class="linenos">1428</span></a><span class="sd">            Estimated column-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination-1429"><a href="#CenterDetermination-1429"><span class="linenos">1429</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1430"><a href="#CenterDetermination-1430"><span class="linenos">1430</span></a><span class="sd">        None : NoneType</span>
</span><span id="CenterDetermination-1431"><a href="#CenterDetermination-1431"><span class="linenos">1431</span></a><span class="sd">            Placeholder for future functionality (e.g., radius estimation).</span>
</span><span id="CenterDetermination-1432"><a href="#CenterDetermination-1432"><span class="linenos">1432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1433"><a href="#CenterDetermination-1433"><span class="linenos">1433</span></a>        <span class="c1"># (1) Get image  ------------------------------------------------------</span>
</span><span id="CenterDetermination-1434"><a href="#CenterDetermination-1434"><span class="linenos">1434</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1435"><a href="#CenterDetermination-1435"><span class="linenos">1435</span></a>        
</span><span id="CenterDetermination-1436"><a href="#CenterDetermination-1436"><span class="linenos">1436</span></a>        <span class="c1"># if Sobel==True, perform Sobel filtration</span>
</span><span id="CenterDetermination-1437"><a href="#CenterDetermination-1437"><span class="linenos">1437</span></a>        <span class="c1"># https://doi.org/10.1016/j.ultramic.2016.12.021</span>
</span><span id="CenterDetermination-1438"><a href="#CenterDetermination-1438"><span class="linenos">1438</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination-1439"><a href="#CenterDetermination-1439"><span class="linenos">1439</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">disp</span><span class="p">)</span>
</span><span id="CenterDetermination-1440"><a href="#CenterDetermination-1440"><span class="linenos">1440</span></a>        
</span><span id="CenterDetermination-1441"><a href="#CenterDetermination-1441"><span class="linenos">1441</span></a>        
</span><span id="CenterDetermination-1442"><a href="#CenterDetermination-1442"><span class="linenos">1442</span></a>        <span class="c1"># shift the pixel values (smallest value is zero -&gt; non-negative image)</span>
</span><span id="CenterDetermination-1443"><a href="#CenterDetermination-1443"><span class="linenos">1443</span></a>        <span class="n">image</span> <span class="o">-=</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="CenterDetermination-1444"><a href="#CenterDetermination-1444"><span class="linenos">1444</span></a>
</span><span id="CenterDetermination-1445"><a href="#CenterDetermination-1445"><span class="linenos">1445</span></a>        <span class="c1"># (2) Prepare mask and compute weighted center ------------------------</span>
</span><span id="CenterDetermination-1446"><a href="#CenterDetermination-1446"><span class="linenos">1446</span></a>        <span class="k">if</span> <span class="n">masking</span><span class="p">:</span>
</span><span id="CenterDetermination-1447"><a href="#CenterDetermination-1447"><span class="linenos">1447</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_masking</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> 
</span><span id="CenterDetermination-1448"><a href="#CenterDetermination-1448"><span class="linenos">1448</span></a>            <span class="c1"># print(&quot;masked&quot;)</span>
</span><span id="CenterDetermination-1449"><a href="#CenterDetermination-1449"><span class="linenos">1449</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># binary mask</span>
</span><span id="CenterDetermination-1450"><a href="#CenterDetermination-1450"><span class="linenos">1450</span></a>        
</span><span id="CenterDetermination-1451"><a href="#CenterDetermination-1451"><span class="linenos">1451</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">image</span>                        <span class="c1"># </span>
</span><span id="CenterDetermination-1452"><a href="#CenterDetermination-1452"><span class="linenos">1452</span></a>        
</span><span id="CenterDetermination-1453"><a href="#CenterDetermination-1453"><span class="linenos">1453</span></a>        <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>       <span class="c1"># matrices of row/col indices</span>
</span><span id="CenterDetermination-1454"><a href="#CenterDetermination-1454"><span class="linenos">1454</span></a>
</span><span id="CenterDetermination-1455"><a href="#CenterDetermination-1455"><span class="linenos">1455</span></a>        <span class="c1"># Weighted center of mass (brighter pixels contribute more)</span>
</span><span id="CenterDetermination-1456"><a href="#CenterDetermination-1456"><span class="linenos">1456</span></a>        <span class="c1"># This gives an initial estimate of the center (r_, c_).</span>
</span><span id="CenterDetermination-1457"><a href="#CenterDetermination-1457"><span class="linenos">1457</span></a>        <span class="n">r_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
</span><span id="CenterDetermination-1458"><a href="#CenterDetermination-1458"><span class="linenos">1458</span></a>        <span class="n">c_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
</span><span id="CenterDetermination-1459"><a href="#CenterDetermination-1459"><span class="linenos">1459</span></a>
</span><span id="CenterDetermination-1460"><a href="#CenterDetermination-1460"><span class="linenos">1460</span></a>        <span class="c1"># (3) Crop the image around the estimated center ----------------------</span>
</span><span id="CenterDetermination-1461"><a href="#CenterDetermination-1461"><span class="linenos">1461</span></a>        <span class="c1"># Some diffraction patterns are not centered, and so there&#39;s a lot of </span>
</span><span id="CenterDetermination-1462"><a href="#CenterDetermination-1462"><span class="linenos">1462</span></a>        <span class="c1"># image area that cannot be used for registration.</span>
</span><span id="CenterDetermination-1463"><a href="#CenterDetermination-1463"><span class="linenos">1463</span></a>        <span class="c1"># Radial inversion becomes simple inversion of dimensions</span>
</span><span id="CenterDetermination-1464"><a href="#CenterDetermination-1464"><span class="linenos">1464</span></a>        <span class="n">side_length</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1465"><a href="#CenterDetermination-1465"><span class="linenos">1465</span></a>            <span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">r_</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">r_</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">c_</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">c_</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
</span><span id="CenterDetermination-1466"><a href="#CenterDetermination-1466"><span class="linenos">1466</span></a>        <span class="n">rs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">r_</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">r_</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">)</span>
</span><span id="CenterDetermination-1467"><a href="#CenterDetermination-1467"><span class="linenos">1467</span></a>        <span class="n">cs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">c_</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">c_</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">)</span>
</span><span id="CenterDetermination-1468"><a href="#CenterDetermination-1468"><span class="linenos">1468</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">rs</span><span class="p">,</span> <span class="n">cs</span><span class="p">]</span>
</span><span id="CenterDetermination-1469"><a href="#CenterDetermination-1469"><span class="linenos">1469</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">rs</span><span class="p">,</span> <span class="n">cs</span><span class="p">]</span>
</span><span id="CenterDetermination-1470"><a href="#CenterDetermination-1470"><span class="linenos">1470</span></a>    
</span><span id="CenterDetermination-1471"><a href="#CenterDetermination-1471"><span class="linenos">1471</span></a>        <span class="c1"># (4) Normalize background intensity (optional) -----------------------</span>
</span><span id="CenterDetermination-1472"><a href="#CenterDetermination-1472"><span class="linenos">1472</span></a>        <span class="c1"># This step removes intensity variations due to experimental artifacts, </span>
</span><span id="CenterDetermination-1473"><a href="#CenterDetermination-1473"><span class="linenos">1473</span></a>        <span class="c1"># such as uneven illumination.</span>
</span><span id="CenterDetermination-1474"><a href="#CenterDetermination-1474"><span class="linenos">1474</span></a>        <span class="k">if</span> <span class="n">normalize_bg</span><span class="p">:</span>
</span><span id="CenterDetermination-1475"><a href="#CenterDetermination-1475"><span class="linenos">1475</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="CenterDetermination-1476"><a href="#CenterDetermination-1476"><span class="linenos">1476</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="CenterDetermination-1477"><a href="#CenterDetermination-1477"><span class="linenos">1477</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># float64 before division</span>
</span><span id="CenterDetermination-1478"><a href="#CenterDetermination-1478"><span class="linenos">1478</span></a>                <span class="n">image</span> <span class="o">/=</span> <span class="n">gaussian_filter</span><span class="p">(</span>
</span><span id="CenterDetermination-1479"><a href="#CenterDetermination-1479"><span class="linenos">1479</span></a>                    <span class="nb">input</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1480"><a href="#CenterDetermination-1480"><span class="linenos">1480</span></a>        
</span><span id="CenterDetermination-1481"><a href="#CenterDetermination-1481"><span class="linenos">1481</span></a>        <span class="c1"># Replace NaN values with 0s</span>
</span><span id="CenterDetermination-1482"><a href="#CenterDetermination-1482"><span class="linenos">1482</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1483"><a href="#CenterDetermination-1483"><span class="linenos">1483</span></a>
</span><span id="CenterDetermination-1484"><a href="#CenterDetermination-1484"><span class="linenos">1484</span></a>
</span><span id="CenterDetermination-1485"><a href="#CenterDetermination-1485"><span class="linenos">1485</span></a>        <span class="c1"># (5) Compute inversion symmetry using Fourier methods ----------------</span>
</span><span id="CenterDetermination-1486"><a href="#CenterDetermination-1486"><span class="linenos">1486</span></a>        <span class="c1"># an inverted copy of the image (im_i) and mask (mask_i), </span>
</span><span id="CenterDetermination-1487"><a href="#CenterDetermination-1487"><span class="linenos">1487</span></a>        <span class="c1"># flipping both horizontally and vertically ::-1</span>
</span><span id="CenterDetermination-1488"><a href="#CenterDetermination-1488"><span class="linenos">1488</span></a>        <span class="n">im_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1489"><a href="#CenterDetermination-1489"><span class="linenos">1489</span></a>        <span class="n">mask_i</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1490"><a href="#CenterDetermination-1490"><span class="linenos">1490</span></a>
</span><span id="CenterDetermination-1491"><a href="#CenterDetermination-1491"><span class="linenos">1491</span></a>        <span class="c1"># downsampling to speed up processing (for too large images)</span>
</span><span id="CenterDetermination-1492"><a href="#CenterDetermination-1492"><span class="linenos">1492</span></a>        <span class="n">downsampling</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-1493"><a href="#CenterDetermination-1493"><span class="linenos">1493</span></a>        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="CenterDetermination-1494"><a href="#CenterDetermination-1494"><span class="linenos">1494</span></a>            <span class="n">downsampling</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1495"><a href="#CenterDetermination-1495"><span class="linenos">1495</span></a>    
</span><span id="CenterDetermination-1496"><a href="#CenterDetermination-1496"><span class="linenos">1496</span></a>        <span class="c1"># phase cross-correlation finds the best alignment between the image</span>
</span><span id="CenterDetermination-1497"><a href="#CenterDetermination-1497"><span class="linenos">1497</span></a>        <span class="c1"># and its inverted copy</span>
</span><span id="CenterDetermination-1498"><a href="#CenterDetermination-1498"><span class="linenos">1498</span></a>        <span class="c1"># the shift tells us how much the center is offset from perfect </span>
</span><span id="CenterDetermination-1499"><a href="#CenterDetermination-1499"><span class="linenos">1499</span></a>        <span class="c1"># inversion symmetry.</span>
</span><span id="CenterDetermination-1500"><a href="#CenterDetermination-1500"><span class="linenos">1500</span></a>        <span class="n">shift</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_fft</span><span class="p">(</span><span class="n">phase_cross_correlation</span><span class="p">)(</span>
</span><span id="CenterDetermination-1501"><a href="#CenterDetermination-1501"><span class="linenos">1501</span></a>            <span class="n">reference_image</span><span class="o">=</span><span class="n">image</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination-1502"><a href="#CenterDetermination-1502"><span class="linenos">1502</span></a>            <span class="n">moving_image</span><span class="o">=</span><span class="n">im_i</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination-1503"><a href="#CenterDetermination-1503"><span class="linenos">1503</span></a>            <span class="n">reference_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination-1504"><a href="#CenterDetermination-1504"><span class="linenos">1504</span></a>            <span class="n">moving_mask</span><span class="o">=</span><span class="n">mask_i</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination-1505"><a href="#CenterDetermination-1505"><span class="linenos">1505</span></a>        <span class="p">)</span>
</span><span id="CenterDetermination-1506"><a href="#CenterDetermination-1506"><span class="linenos">1506</span></a>        
</span><span id="CenterDetermination-1507"><a href="#CenterDetermination-1507"><span class="linenos">1507</span></a>        <span class="c1"># The computed shift is rescaled to match the original image resolution.</span>
</span><span id="CenterDetermination-1508"><a href="#CenterDetermination-1508"><span class="linenos">1508</span></a>        <span class="n">correction</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="n">downsampling</span>
</span><span id="CenterDetermination-1509"><a href="#CenterDetermination-1509"><span class="linenos">1509</span></a>
</span><span id="CenterDetermination-1510"><a href="#CenterDetermination-1510"><span class="linenos">1510</span></a>
</span><span id="CenterDetermination-1511"><a href="#CenterDetermination-1511"><span class="linenos">1511</span></a>        <span class="c1"># (6) User information (if required) ----------------------------------</span>
</span><span id="CenterDetermination-1512"><a href="#CenterDetermination-1512"><span class="linenos">1512</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination-1513"><a href="#CenterDetermination-1513"><span class="linenos">1513</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1514"><a href="#CenterDetermination-1514"><span class="linenos">1514</span></a>                <span class="s2">&quot;Center Determination (PhaseCorrCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-1515"><a href="#CenterDetermination-1515"><span class="linenos">1515</span></a>        
</span><span id="CenterDetermination-1516"><a href="#CenterDetermination-1516"><span class="linenos">1516</span></a>        <span class="c1"># Ensure correction is a tuple or list before extracting elements</span>
</span><span id="CenterDetermination-1517"><a href="#CenterDetermination-1517"><span class="linenos">1517</span></a>        <span class="n">correction_r</span><span class="p">,</span> <span class="n">correction_c</span> <span class="o">=</span> <span class="n">correction</span> \
</span><span id="CenterDetermination-1518"><a href="#CenterDetermination-1518"><span class="linenos">1518</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correction</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> \
</span><span id="CenterDetermination-1519"><a href="#CenterDetermination-1519"><span class="linenos">1519</span></a>                <span class="k">else</span> <span class="p">(</span><span class="n">correction</span><span class="p">,</span> <span class="n">correction</span><span class="p">)</span>
</span><span id="CenterDetermination-1520"><a href="#CenterDetermination-1520"><span class="linenos">1520</span></a>        
</span><span id="CenterDetermination-1521"><a href="#CenterDetermination-1521"><span class="linenos">1521</span></a>        <span class="n">r_final</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">+</span> <span class="n">correction_r</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1522"><a href="#CenterDetermination-1522"><span class="linenos">1522</span></a>        <span class="n">c_final</span> <span class="o">=</span> <span class="n">c_</span> <span class="o">+</span> <span class="n">correction_c</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1523"><a href="#CenterDetermination-1523"><span class="linenos">1523</span></a>                
</span><span id="CenterDetermination-1524"><a href="#CenterDetermination-1524"><span class="linenos">1524</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">r_final</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c_final</span><span class="p">),</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1525"><a href="#CenterDetermination-1525"><span class="linenos">1525</span></a>    
</span><span id="CenterDetermination-1526"><a href="#CenterDetermination-1526"><span class="linenos">1526</span></a>
</span><span id="CenterDetermination-1527"><a href="#CenterDetermination-1527"><span class="linenos">1527</span></a>    <span class="k">def</span> <span class="nf">detection_crosscorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination-1528"><a href="#CenterDetermination-1528"><span class="linenos">1528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1529"><a href="#CenterDetermination-1529"><span class="linenos">1529</span></a><span class="sd">        Detects the center of symmetry in a diffraction image using a </span>
</span><span id="CenterDetermination-1530"><a href="#CenterDetermination-1530"><span class="linenos">1530</span></a><span class="sd">        combination of weighted intensity averaging and cross-correlation.</span>
</span><span id="CenterDetermination-1531"><a href="#CenterDetermination-1531"><span class="linenos">1531</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1532"><a href="#CenterDetermination-1532"><span class="linenos">1532</span></a><span class="sd">        This method performs the following steps:</span>
</span><span id="CenterDetermination-1533"><a href="#CenterDetermination-1533"><span class="linenos">1533</span></a><span class="sd">            1. Estimates an initial center using the weighted average of pixel</span>
</span><span id="CenterDetermination-1534"><a href="#CenterDetermination-1534"><span class="linenos">1534</span></a><span class="sd">               intensities.</span>
</span><span id="CenterDetermination-1535"><a href="#CenterDetermination-1535"><span class="linenos">1535</span></a><span class="sd">            2. Crops the image to focus on its central region.</span>
</span><span id="CenterDetermination-1536"><a href="#CenterDetermination-1536"><span class="linenos">1536</span></a><span class="sd">            3. Optionally normalizes the background to reduce experimental</span>
</span><span id="CenterDetermination-1537"><a href="#CenterDetermination-1537"><span class="linenos">1537</span></a><span class="sd">               artifacts.</span>
</span><span id="CenterDetermination-1538"><a href="#CenterDetermination-1538"><span class="linenos">1538</span></a><span class="sd">            4. Computes a refined center by analyzing inversion symmetry </span>
</span><span id="CenterDetermination-1539"><a href="#CenterDetermination-1539"><span class="linenos">1539</span></a><span class="sd">               using cross-correlation.</span>
</span><span id="CenterDetermination-1540"><a href="#CenterDetermination-1540"><span class="linenos">1540</span></a><span class="sd">            5. Returns the final corrected center coordinates.</span>
</span><span id="CenterDetermination-1541"><a href="#CenterDetermination-1541"><span class="linenos">1541</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1542"><a href="#CenterDetermination-1542"><span class="linenos">1542</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1543"><a href="#CenterDetermination-1543"><span class="linenos">1543</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1544"><a href="#CenterDetermination-1544"><span class="linenos">1544</span></a><span class="sd">        normalize_bg : bool, optional, default=True</span>
</span><span id="CenterDetermination-1545"><a href="#CenterDetermination-1545"><span class="linenos">1545</span></a><span class="sd">            If True, normalizes the background intensity to reduce illumination </span>
</span><span id="CenterDetermination-1546"><a href="#CenterDetermination-1546"><span class="linenos">1546</span></a><span class="sd">            artifacts. </span>
</span><span id="CenterDetermination-1547"><a href="#CenterDetermination-1547"><span class="linenos">1547</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1548"><a href="#CenterDetermination-1548"><span class="linenos">1548</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="CenterDetermination-1549"><a href="#CenterDetermination-1549"><span class="linenos">1549</span></a><span class="sd">            If True, applies Sobel filtering to enhance edges prior to processing. </span>
</span><span id="CenterDetermination-1550"><a href="#CenterDetermination-1550"><span class="linenos">1550</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1551"><a href="#CenterDetermination-1551"><span class="linenos">1551</span></a><span class="sd">        disp : bool, optional, default=False</span>
</span><span id="CenterDetermination-1552"><a href="#CenterDetermination-1552"><span class="linenos">1552</span></a><span class="sd">            If True, displays intermediate processing results.</span>
</span><span id="CenterDetermination-1553"><a href="#CenterDetermination-1553"><span class="linenos">1553</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1554"><a href="#CenterDetermination-1554"><span class="linenos">1554</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1555"><a href="#CenterDetermination-1555"><span class="linenos">1555</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1556"><a href="#CenterDetermination-1556"><span class="linenos">1556</span></a><span class="sd">        r_final : float</span>
</span><span id="CenterDetermination-1557"><a href="#CenterDetermination-1557"><span class="linenos">1557</span></a><span class="sd">            Estimated row-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination-1558"><a href="#CenterDetermination-1558"><span class="linenos">1558</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1559"><a href="#CenterDetermination-1559"><span class="linenos">1559</span></a><span class="sd">        c_final : float</span>
</span><span id="CenterDetermination-1560"><a href="#CenterDetermination-1560"><span class="linenos">1560</span></a><span class="sd">            Estimated column-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination-1561"><a href="#CenterDetermination-1561"><span class="linenos">1561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1562"><a href="#CenterDetermination-1562"><span class="linenos">1562</span></a>       
</span><span id="CenterDetermination-1563"><a href="#CenterDetermination-1563"><span class="linenos">1563</span></a>        <span class="c1"># (1) Get image -------------------------------------------------------</span>
</span><span id="CenterDetermination-1564"><a href="#CenterDetermination-1564"><span class="linenos">1564</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1565"><a href="#CenterDetermination-1565"><span class="linenos">1565</span></a>        
</span><span id="CenterDetermination-1566"><a href="#CenterDetermination-1566"><span class="linenos">1566</span></a>        <span class="c1"># Apply Sobel filter if requested</span>
</span><span id="CenterDetermination-1567"><a href="#CenterDetermination-1567"><span class="linenos">1567</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination-1568"><a href="#CenterDetermination-1568"><span class="linenos">1568</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1569"><a href="#CenterDetermination-1569"><span class="linenos">1569</span></a>        
</span><span id="CenterDetermination-1570"><a href="#CenterDetermination-1570"><span class="linenos">1570</span></a>        <span class="c1"># Shift pixel values to ensure non-negative image</span>
</span><span id="CenterDetermination-1571"><a href="#CenterDetermination-1571"><span class="linenos">1571</span></a>        <span class="n">image</span> <span class="o">-=</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="CenterDetermination-1572"><a href="#CenterDetermination-1572"><span class="linenos">1572</span></a>     
</span><span id="CenterDetermination-1573"><a href="#CenterDetermination-1573"><span class="linenos">1573</span></a>    
</span><span id="CenterDetermination-1574"><a href="#CenterDetermination-1574"><span class="linenos">1574</span></a>        <span class="c1"># (2) Normalize background intensity (optional) -----------------------</span>
</span><span id="CenterDetermination-1575"><a href="#CenterDetermination-1575"><span class="linenos">1575</span></a>        <span class="k">if</span> <span class="n">normalize_bg</span><span class="p">:</span>
</span><span id="CenterDetermination-1576"><a href="#CenterDetermination-1576"><span class="linenos">1576</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="CenterDetermination-1577"><a href="#CenterDetermination-1577"><span class="linenos">1577</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="CenterDetermination-1578"><a href="#CenterDetermination-1578"><span class="linenos">1578</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 
</span><span id="CenterDetermination-1579"><a href="#CenterDetermination-1579"><span class="linenos">1579</span></a>                <span class="n">image</span> <span class="o">/=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination-1580"><a href="#CenterDetermination-1580"><span class="linenos">1580</span></a>                                         <span class="n">sigma</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> 
</span><span id="CenterDetermination-1581"><a href="#CenterDetermination-1581"><span class="linenos">1581</span></a>                                         <span class="n">truncate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1582"><a href="#CenterDetermination-1582"><span class="linenos">1582</span></a>        
</span><span id="CenterDetermination-1583"><a href="#CenterDetermination-1583"><span class="linenos">1583</span></a>        <span class="c1"># Replace NaN values with 0s</span>
</span><span id="CenterDetermination-1584"><a href="#CenterDetermination-1584"><span class="linenos">1584</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1585"><a href="#CenterDetermination-1585"><span class="linenos">1585</span></a>    
</span><span id="CenterDetermination-1586"><a href="#CenterDetermination-1586"><span class="linenos">1586</span></a>        <span class="c1"># (3) Compute inversion symmetry using cross-correlation --------------</span>
</span><span id="CenterDetermination-1587"><a href="#CenterDetermination-1587"><span class="linenos">1587</span></a>        <span class="c1"># Dynamically set the margin to a reasonable fraction of the image size</span>
</span><span id="CenterDetermination-1588"><a href="#CenterDetermination-1588"><span class="linenos">1588</span></a>        <span class="n">margin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="CenterDetermination-1589"><a href="#CenterDetermination-1589"><span class="linenos">1589</span></a>        <span class="n">im_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">]</span>  <span class="c1"># Crop slightly</span>
</span><span id="CenterDetermination-1590"><a href="#CenterDetermination-1590"><span class="linenos">1590</span></a>        
</span><span id="CenterDetermination-1591"><a href="#CenterDetermination-1591"><span class="linenos">1591</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">im_i</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Inverted image for symmetry comparison</span>
</span><span id="CenterDetermination-1592"><a href="#CenterDetermination-1592"><span class="linenos">1592</span></a>    
</span><span id="CenterDetermination-1593"><a href="#CenterDetermination-1593"><span class="linenos">1593</span></a>        <span class="c1"># Compute cross-correlation using OpenCV template matching</span>
</span><span id="CenterDetermination-1594"><a href="#CenterDetermination-1594"><span class="linenos">1594</span></a>        <span class="c1"># it finds areas in an image that best match a given template. </span>
</span><span id="CenterDetermination-1595"><a href="#CenterDetermination-1595"><span class="linenos">1595</span></a>        <span class="c1"># it compares the original image with its inverted version to measure </span>
</span><span id="CenterDetermination-1596"><a href="#CenterDetermination-1596"><span class="linenos">1596</span></a>        <span class="c1"># inversion symmetry</span>
</span><span id="CenterDetermination-1597"><a href="#CenterDetermination-1597"><span class="linenos">1597</span></a>        <span class="c1"># im_i (template) slides over image in a pixel-by-pixel manner.</span>
</span><span id="CenterDetermination-1598"><a href="#CenterDetermination-1598"><span class="linenos">1598</span></a>        <span class="c1"># at each position, it computes the cross-correlation between </span>
</span><span id="CenterDetermination-1599"><a href="#CenterDetermination-1599"><span class="linenos">1599</span></a>        <span class="c1"># overlapping pixels.</span>
</span><span id="CenterDetermination-1600"><a href="#CenterDetermination-1600"><span class="linenos">1600</span></a>        <span class="c1"># result is a 2D matrix, where each value represents the correlation </span>
</span><span id="CenterDetermination-1601"><a href="#CenterDetermination-1601"><span class="linenos">1601</span></a>        <span class="c1"># score at a particular location. Higher values indicate</span>
</span><span id="CenterDetermination-1602"><a href="#CenterDetermination-1602"><span class="linenos">1602</span></a>        <span class="c1"># better symmetry at that position.</span>
</span><span id="CenterDetermination-1603"><a href="#CenterDetermination-1603"><span class="linenos">1603</span></a>        
</span><span id="CenterDetermination-1604"><a href="#CenterDetermination-1604"><span class="linenos">1604</span></a>        <span class="c1"># Ensure template is smaller than image</span>
</span><span id="CenterDetermination-1605"><a href="#CenterDetermination-1605"><span class="linenos">1605</span></a>        <span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
</span><span id="CenterDetermination-1606"><a href="#CenterDetermination-1606"><span class="linenos">1606</span></a>            <span class="ow">and</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
</span><span id="CenterDetermination-1607"><a href="#CenterDetermination-1607"><span class="linenos">1607</span></a>            <span class="s2">&quot;Template is larger than the image&quot;</span>
</span><span id="CenterDetermination-1608"><a href="#CenterDetermination-1608"><span class="linenos">1608</span></a>        
</span><span id="CenterDetermination-1609"><a href="#CenterDetermination-1609"><span class="linenos">1609</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
</span><span id="CenterDetermination-1610"><a href="#CenterDetermination-1610"><span class="linenos">1610</span></a>                                   <span class="n">template</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
</span><span id="CenterDetermination-1611"><a href="#CenterDetermination-1611"><span class="linenos">1611</span></a>                                   <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCORR_NORMED</span><span class="p">)</span>
</span><span id="CenterDetermination-1612"><a href="#CenterDetermination-1612"><span class="linenos">1612</span></a>        
</span><span id="CenterDetermination-1613"><a href="#CenterDetermination-1613"><span class="linenos">1613</span></a>        <span class="c1"># Get the location of the best match in `result`</span>
</span><span id="CenterDetermination-1614"><a href="#CenterDetermination-1614"><span class="linenos">1614</span></a>        <span class="n">max_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
</span><span id="CenterDetermination-1615"><a href="#CenterDetermination-1615"><span class="linenos">1615</span></a>        <span class="n">correction_r</span><span class="p">,</span> <span class="n">correction_c</span> <span class="o">=</span> <span class="n">max_location</span>  
</span><span id="CenterDetermination-1616"><a href="#CenterDetermination-1616"><span class="linenos">1616</span></a>        
</span><span id="CenterDetermination-1617"><a href="#CenterDetermination-1617"><span class="linenos">1617</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span> 
</span><span id="CenterDetermination-1618"><a href="#CenterDetermination-1618"><span class="linenos">1618</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="CenterDetermination-1619"><a href="#CenterDetermination-1619"><span class="linenos">1619</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1620"><a href="#CenterDetermination-1620"><span class="linenos">1620</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation matrix&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1621"><a href="#CenterDetermination-1621"><span class="linenos">1621</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-1622"><a href="#CenterDetermination-1622"><span class="linenos">1622</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1623"><a href="#CenterDetermination-1623"><span class="linenos">1623</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1624"><a href="#CenterDetermination-1624"><span class="linenos">1624</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-1625"><a href="#CenterDetermination-1625"><span class="linenos">1625</span></a>        
</span><span id="CenterDetermination-1626"><a href="#CenterDetermination-1626"><span class="linenos">1626</span></a>        <span class="c1"># Adjust to original image coordinates (account for template cropping)</span>
</span><span id="CenterDetermination-1627"><a href="#CenterDetermination-1627"><span class="linenos">1627</span></a>        <span class="n">corrected_r</span> <span class="o">=</span> <span class="n">correction_r</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1628"><a href="#CenterDetermination-1628"><span class="linenos">1628</span></a>        <span class="n">corrected_c</span> <span class="o">=</span> <span class="n">correction_c</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1629"><a href="#CenterDetermination-1629"><span class="linenos">1629</span></a>        
</span><span id="CenterDetermination-1630"><a href="#CenterDetermination-1630"><span class="linenos">1630</span></a>        <span class="c1"># (4) Visualization ---------------------------------------------------</span>
</span><span id="CenterDetermination-1631"><a href="#CenterDetermination-1631"><span class="linenos">1631</span></a>        <span class="c1"># Plot with correct alignment</span>
</span><span id="CenterDetermination-1632"><a href="#CenterDetermination-1632"><span class="linenos">1632</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination-1633"><a href="#CenterDetermination-1633"><span class="linenos">1633</span></a>            
</span><span id="CenterDetermination-1634"><a href="#CenterDetermination-1634"><span class="linenos">1634</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="CenterDetermination-1635"><a href="#CenterDetermination-1635"><span class="linenos">1635</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">:</span>
</span><span id="CenterDetermination-1636"><a href="#CenterDetermination-1636"><span class="linenos">1636</span></a>                <span class="n">orig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="CenterDetermination-1637"><a href="#CenterDetermination-1637"><span class="linenos">1637</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1638"><a href="#CenterDetermination-1638"><span class="linenos">1638</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1639"><a href="#CenterDetermination-1639"><span class="linenos">1639</span></a>            
</span><span id="CenterDetermination-1640"><a href="#CenterDetermination-1640"><span class="linenos">1640</span></a>            <span class="c1"># Assuming fft_im_i is your Fourier transform image</span>
</span><span id="CenterDetermination-1641"><a href="#CenterDetermination-1641"><span class="linenos">1641</span></a>            <span class="n">center_size</span> <span class="o">=</span> <span class="mi">513</span>
</span><span id="CenterDetermination-1642"><a href="#CenterDetermination-1642"><span class="linenos">1642</span></a>            <span class="n">center_x</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1643"><a href="#CenterDetermination-1643"><span class="linenos">1643</span></a>            <span class="n">center_y</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1644"><a href="#CenterDetermination-1644"><span class="linenos">1644</span></a>
</span><span id="CenterDetermination-1645"><a href="#CenterDetermination-1645"><span class="linenos">1645</span></a>            <span class="c1"># Crop the central part of the spectrum</span>
</span><span id="CenterDetermination-1646"><a href="#CenterDetermination-1646"><span class="linenos">1646</span></a>            <span class="n">orig</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span>
</span><span id="CenterDetermination-1647"><a href="#CenterDetermination-1647"><span class="linenos">1647</span></a>                <span class="n">center_y</span> <span class="o">-</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">center_y</span> <span class="o">+</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="CenterDetermination-1648"><a href="#CenterDetermination-1648"><span class="linenos">1648</span></a>                <span class="n">center_x</span> <span class="o">-</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">center_x</span> <span class="o">+</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="CenterDetermination-1649"><a href="#CenterDetermination-1649"><span class="linenos">1649</span></a>            
</span><span id="CenterDetermination-1650"><a href="#CenterDetermination-1650"><span class="linenos">1650</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1651"><a href="#CenterDetermination-1651"><span class="linenos">1651</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">corrected_c</span><span class="o">-</span><span class="n">center_x</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">corrected_r</span><span class="o">-</span><span class="n">center_y</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1652"><a href="#CenterDetermination-1652"><span class="linenos">1652</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="CenterDetermination-1653"><a href="#CenterDetermination-1653"><span class="linenos">1653</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1654"><a href="#CenterDetermination-1654"><span class="linenos">1654</span></a>            <span class="n">my_title</span> <span class="o">=</span>  <span class="s2">&quot;Location of the highest correlation coefficient&quot;</span>
</span><span id="CenterDetermination-1655"><a href="#CenterDetermination-1655"><span class="linenos">1655</span></a>            <span class="n">my_title</span> <span class="o">+=</span> <span class="s2">&quot;in the original image.&quot;</span>
</span><span id="CenterDetermination-1656"><a href="#CenterDetermination-1656"><span class="linenos">1656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_title</span><span class="p">)</span>
</span><span id="CenterDetermination-1657"><a href="#CenterDetermination-1657"><span class="linenos">1657</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1658"><a href="#CenterDetermination-1658"><span class="linenos">1658</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1659"><a href="#CenterDetermination-1659"><span class="linenos">1659</span></a>            
</span><span id="CenterDetermination-1660"><a href="#CenterDetermination-1660"><span class="linenos">1660</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-1661"><a href="#CenterDetermination-1661"><span class="linenos">1661</span></a>        
</span><span id="CenterDetermination-1662"><a href="#CenterDetermination-1662"><span class="linenos">1662</span></a>        <span class="c1"># (5) User information (if required) ----------------------------------</span>
</span><span id="CenterDetermination-1663"><a href="#CenterDetermination-1663"><span class="linenos">1663</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="CenterDetermination-1664"><a href="#CenterDetermination-1664"><span class="linenos">1664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1665"><a href="#CenterDetermination-1665"><span class="linenos">1665</span></a>                <span class="s2">&quot;Center Determination (CrossCorrCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-1666"><a href="#CenterDetermination-1666"><span class="linenos">1666</span></a>
</span><span id="CenterDetermination-1667"><a href="#CenterDetermination-1667"><span class="linenos">1667</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">corrected_r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">corrected_c</span><span class="p">),</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1668"><a href="#CenterDetermination-1668"><span class="linenos">1668</span></a>
</span><span id="CenterDetermination-1669"><a href="#CenterDetermination-1669"><span class="linenos">1669</span></a>    
</span><span id="CenterDetermination-1670"><a href="#CenterDetermination-1670"><span class="linenos">1670</span></a>    <span class="k">def</span> <span class="nf">detection_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="CenterDetermination-1671"><a href="#CenterDetermination-1671"><span class="linenos">1671</span></a>                            <span class="n">csquare</span><span class="p">,</span> <span class="n">cintensity</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination-1672"><a href="#CenterDetermination-1672"><span class="linenos">1672</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1673"><a href="#CenterDetermination-1673"><span class="linenos">1673</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="CenterDetermination-1674"><a href="#CenterDetermination-1674"><span class="linenos">1674</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1675"><a href="#CenterDetermination-1675"><span class="linenos">1675</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1676"><a href="#CenterDetermination-1676"><span class="linenos">1676</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1677"><a href="#CenterDetermination-1677"><span class="linenos">1677</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="CenterDetermination-1678"><a href="#CenterDetermination-1678"><span class="linenos">1678</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="CenterDetermination-1679"><a href="#CenterDetermination-1679"><span class="linenos">1679</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1680"><a href="#CenterDetermination-1680"><span class="linenos">1680</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="CenterDetermination-1681"><a href="#CenterDetermination-1681"><span class="linenos">1681</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="CenterDetermination-1682"><a href="#CenterDetermination-1682"><span class="linenos">1682</span></a><span class="sd">            The intensity center will be searched only within the central</span>
</span><span id="CenterDetermination-1683"><a href="#CenterDetermination-1683"><span class="linenos">1683</span></a><span class="sd">            square.</span>
</span><span id="CenterDetermination-1684"><a href="#CenterDetermination-1684"><span class="linenos">1684</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="CenterDetermination-1685"><a href="#CenterDetermination-1685"><span class="linenos">1685</span></a><span class="sd">            to minimize the effect of possible intensity assymetry</span>
</span><span id="CenterDetermination-1686"><a href="#CenterDetermination-1686"><span class="linenos">1686</span></a><span class="sd">            around the center. </span>
</span><span id="CenterDetermination-1687"><a href="#CenterDetermination-1687"><span class="linenos">1687</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1688"><a href="#CenterDetermination-1688"><span class="linenos">1688</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="CenterDetermination-1689"><a href="#CenterDetermination-1689"><span class="linenos">1689</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="CenterDetermination-1690"><a href="#CenterDetermination-1690"><span class="linenos">1690</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="CenterDetermination-1691"><a href="#CenterDetermination-1691"><span class="linenos">1691</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="CenterDetermination-1692"><a href="#CenterDetermination-1692"><span class="linenos">1692</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1693"><a href="#CenterDetermination-1693"><span class="linenos">1693</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1694"><a href="#CenterDetermination-1694"><span class="linenos">1694</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1695"><a href="#CenterDetermination-1695"><span class="linenos">1695</span></a><span class="sd">        xc, yc : float,float</span>
</span><span id="CenterDetermination-1696"><a href="#CenterDetermination-1696"><span class="linenos">1696</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="CenterDetermination-1697"><a href="#CenterDetermination-1697"><span class="linenos">1697</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.</span>
</span><span id="CenterDetermination-1698"><a href="#CenterDetermination-1698"><span class="linenos">1698</span></a><span class="sd">        &#39;&#39;&#39;</span>  
</span><span id="CenterDetermination-1699"><a href="#CenterDetermination-1699"><span class="linenos">1699</span></a>        
</span><span id="CenterDetermination-1700"><a href="#CenterDetermination-1700"><span class="linenos">1700</span></a>        <span class="c1"># (1) Get image/array size --------------------------------------------</span>
</span><span id="CenterDetermination-1701"><a href="#CenterDetermination-1701"><span class="linenos">1701</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1702"><a href="#CenterDetermination-1702"><span class="linenos">1702</span></a>        
</span><span id="CenterDetermination-1703"><a href="#CenterDetermination-1703"><span class="linenos">1703</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination-1704"><a href="#CenterDetermination-1704"><span class="linenos">1704</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1705"><a href="#CenterDetermination-1705"><span class="linenos">1705</span></a>             
</span><span id="CenterDetermination-1706"><a href="#CenterDetermination-1706"><span class="linenos">1706</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-1707"><a href="#CenterDetermination-1707"><span class="linenos">1707</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterDetermination-1708"><a href="#CenterDetermination-1708"><span class="linenos">1708</span></a>        
</span><span id="CenterDetermination-1709"><a href="#CenterDetermination-1709"><span class="linenos">1709</span></a>        <span class="c1"># (2) Calculate borders around the central square ---------------------</span>
</span><span id="CenterDetermination-1710"><a href="#CenterDetermination-1710"><span class="linenos">1710</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1711"><a href="#CenterDetermination-1711"><span class="linenos">1711</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1712"><a href="#CenterDetermination-1712"><span class="linenos">1712</span></a>        
</span><span id="CenterDetermination-1713"><a href="#CenterDetermination-1713"><span class="linenos">1713</span></a>        <span class="c1"># (3) Create the central square, --------------------------------------</span>
</span><span id="CenterDetermination-1714"><a href="#CenterDetermination-1714"><span class="linenos">1714</span></a>        <span class="c1"># from which the intensity center will be detected</span>
</span><span id="CenterDetermination-1715"><a href="#CenterDetermination-1715"><span class="linenos">1715</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="CenterDetermination-1716"><a href="#CenterDetermination-1716"><span class="linenos">1716</span></a>        
</span><span id="CenterDetermination-1717"><a href="#CenterDetermination-1717"><span class="linenos">1717</span></a>        <span class="c1"># (4) In the central square, ------------------------------------------</span>
</span><span id="CenterDetermination-1718"><a href="#CenterDetermination-1718"><span class="linenos">1718</span></a>        <span class="c1"># set all values below cintenstity to zero</span>
</span><span id="CenterDetermination-1719"><a href="#CenterDetermination-1719"><span class="linenos">1719</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination-1720"><a href="#CenterDetermination-1720"><span class="linenos">1720</span></a>        
</span><span id="CenterDetermination-1721"><a href="#CenterDetermination-1721"><span class="linenos">1721</span></a>        <span class="c1"># (5) Determine the intensity center from image moments ---------------</span>
</span><span id="CenterDetermination-1722"><a href="#CenterDetermination-1722"><span class="linenos">1722</span></a>        <span class="c1"># see image moments in...</span>
</span><span id="CenterDetermination-1723"><a href="#CenterDetermination-1723"><span class="linenos">1723</span></a>        <span class="c1"># skimage: https://scikit-image.org/docs/dev/api/skimage.measure.html</span>
</span><span id="CenterDetermination-1724"><a href="#CenterDetermination-1724"><span class="linenos">1724</span></a>        <span class="c1"># wikipedia: https://en.wikipedia.org/wiki/Image_moment -&gt; Centroid</span>
</span><span id="CenterDetermination-1725"><a href="#CenterDetermination-1725"><span class="linenos">1725</span></a>        <span class="c1"># ---</span>
</span><span id="CenterDetermination-1726"><a href="#CenterDetermination-1726"><span class="linenos">1726</span></a>        <span class="c1"># (a) Calculate 1st central moments of the image</span>
</span><span id="CenterDetermination-1727"><a href="#CenterDetermination-1727"><span class="linenos">1727</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1728"><a href="#CenterDetermination-1728"><span class="linenos">1728</span></a>        <span class="c1"># (b) Calculate the intensity center = centroid according to www-help</span>
</span><span id="CenterDetermination-1729"><a href="#CenterDetermination-1729"><span class="linenos">1729</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination-1730"><a href="#CenterDetermination-1730"><span class="linenos">1730</span></a>        <span class="c1"># (c) We have centroid of the central square</span>
</span><span id="CenterDetermination-1731"><a href="#CenterDetermination-1731"><span class="linenos">1731</span></a>        <span class="c1"># but we have to recalculate it to the whole image</span>
</span><span id="CenterDetermination-1732"><a href="#CenterDetermination-1732"><span class="linenos">1732</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">xborder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">yborder</span><span class="p">)</span>
</span><span id="CenterDetermination-1733"><a href="#CenterDetermination-1733"><span class="linenos">1733</span></a>        <span class="c1"># (d) Radius of a diffraction ring </span>
</span><span id="CenterDetermination-1734"><a href="#CenterDetermination-1734"><span class="linenos">1734</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span>
</span><span id="CenterDetermination-1735"><a href="#CenterDetermination-1735"><span class="linenos">1735</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rtype</span><span class="p">,</span> 
</span><span id="CenterDetermination-1736"><a href="#CenterDetermination-1736"><span class="linenos">1736</span></a>            <span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination-1737"><a href="#CenterDetermination-1737"><span class="linenos">1737</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="CenterDetermination-1738"><a href="#CenterDetermination-1738"><span class="linenos">1738</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination-1739"><a href="#CenterDetermination-1739"><span class="linenos">1739</span></a>            <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1740"><a href="#CenterDetermination-1740"><span class="linenos">1740</span></a>        
</span><span id="CenterDetermination-1741"><a href="#CenterDetermination-1741"><span class="linenos">1741</span></a>        <span class="c1"># (6) User information (if required) ----------------------------------</span>
</span><span id="CenterDetermination-1742"><a href="#CenterDetermination-1742"><span class="linenos">1742</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination-1743"><a href="#CenterDetermination-1743"><span class="linenos">1743</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span>\
</span><span id="CenterDetermination-1744"><a href="#CenterDetermination-1744"><span class="linenos">1744</span></a>                <span class="s2">&quot;Center Determination (IntensityCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-1745"><a href="#CenterDetermination-1745"><span class="linenos">1745</span></a>
</span><span id="CenterDetermination-1746"><a href="#CenterDetermination-1746"><span class="linenos">1746</span></a>        <span class="c1"># (7) Plot results (if required) --------------------------------------</span>
</span><span id="CenterDetermination-1747"><a href="#CenterDetermination-1747"><span class="linenos">1747</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1748"><a href="#CenterDetermination-1748"><span class="linenos">1748</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="CenterDetermination-1749"><a href="#CenterDetermination-1749"><span class="linenos">1749</span></a>                
</span><span id="CenterDetermination-1750"><a href="#CenterDetermination-1750"><span class="linenos">1750</span></a>        <span class="c1"># (8) Return the results: ---------------------------------------------</span>
</span><span id="CenterDetermination-1751"><a href="#CenterDetermination-1751"><span class="linenos">1751</span></a>        <span class="c1">#  a) XY-coordinates of the center</span>
</span><span id="CenterDetermination-1752"><a href="#CenterDetermination-1752"><span class="linenos">1752</span></a>        <span class="c1">#  b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination-1753"><a href="#CenterDetermination-1753"><span class="linenos">1753</span></a>        <span class="c1">#     from which the center was determined</span>
</span><span id="CenterDetermination-1754"><a href="#CenterDetermination-1754"><span class="linenos">1754</span></a>
</span><span id="CenterDetermination-1755"><a href="#CenterDetermination-1755"><span class="linenos">1755</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-1756"><a href="#CenterDetermination-1756"><span class="linenos">1756</span></a>    
</span><span id="CenterDetermination-1757"><a href="#CenterDetermination-1757"><span class="linenos">1757</span></a>
</span><span id="CenterDetermination-1758"><a href="#CenterDetermination-1758"><span class="linenos">1758</span></a>    <span class="k">def</span> <span class="nf">detection_Hough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="CenterDetermination-1759"><a href="#CenterDetermination-1759"><span class="linenos">1759</span></a>                        <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination-1760"><a href="#CenterDetermination-1760"><span class="linenos">1760</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;        </span>
</span><span id="CenterDetermination-1761"><a href="#CenterDetermination-1761"><span class="linenos">1761</span></a><span class="sd">        Perform Hough transform to detect the center of diffraction patterns </span>
</span><span id="CenterDetermination-1762"><a href="#CenterDetermination-1762"><span class="linenos">1762</span></a><span class="sd">        with optional real-time visualization and a final image showing all </span>
</span><span id="CenterDetermination-1763"><a href="#CenterDetermination-1763"><span class="linenos">1763</span></a><span class="sd">        detected circles.</span>
</span><span id="CenterDetermination-1764"><a href="#CenterDetermination-1764"><span class="linenos">1764</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1765"><a href="#CenterDetermination-1765"><span class="linenos">1765</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1766"><a href="#CenterDetermination-1766"><span class="linenos">1766</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1767"><a href="#CenterDetermination-1767"><span class="linenos">1767</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination-1768"><a href="#CenterDetermination-1768"><span class="linenos">1768</span></a><span class="sd">            If 1, shows the final detected circle.</span>
</span><span id="CenterDetermination-1769"><a href="#CenterDetermination-1769"><span class="linenos">1769</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1770"><a href="#CenterDetermination-1770"><span class="linenos">1770</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="CenterDetermination-1771"><a href="#CenterDetermination-1771"><span class="linenos">1771</span></a><span class="sd">            If True, applies Sobel filtering to enhance edges prior to processing. </span>
</span><span id="CenterDetermination-1772"><a href="#CenterDetermination-1772"><span class="linenos">1772</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1773"><a href="#CenterDetermination-1773"><span class="linenos">1773</span></a><span class="sd">        sobel            </span>
</span><span id="CenterDetermination-1774"><a href="#CenterDetermination-1774"><span class="linenos">1774</span></a><span class="sd">        live_plot : bool, optional, default=False</span>
</span><span id="CenterDetermination-1775"><a href="#CenterDetermination-1775"><span class="linenos">1775</span></a><span class="sd">            If True, animates the circle detection process and shows all </span>
</span><span id="CenterDetermination-1776"><a href="#CenterDetermination-1776"><span class="linenos">1776</span></a><span class="sd">            detected circles.</span>
</span><span id="CenterDetermination-1777"><a href="#CenterDetermination-1777"><span class="linenos">1777</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1778"><a href="#CenterDetermination-1778"><span class="linenos">1778</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1779"><a href="#CenterDetermination-1779"><span class="linenos">1779</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1780"><a href="#CenterDetermination-1780"><span class="linenos">1780</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination-1781"><a href="#CenterDetermination-1781"><span class="linenos">1781</span></a><span class="sd">            x-coordinate of the detected center.</span>
</span><span id="CenterDetermination-1782"><a href="#CenterDetermination-1782"><span class="linenos">1782</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1783"><a href="#CenterDetermination-1783"><span class="linenos">1783</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination-1784"><a href="#CenterDetermination-1784"><span class="linenos">1784</span></a><span class="sd">            y-coordinate of the detected center.</span>
</span><span id="CenterDetermination-1785"><a href="#CenterDetermination-1785"><span class="linenos">1785</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1786"><a href="#CenterDetermination-1786"><span class="linenos">1786</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination-1787"><a href="#CenterDetermination-1787"><span class="linenos">1787</span></a><span class="sd">            Radius of the detected circle.</span>
</span><span id="CenterDetermination-1788"><a href="#CenterDetermination-1788"><span class="linenos">1788</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1789"><a href="#CenterDetermination-1789"><span class="linenos">1789</span></a>        
</span><span id="CenterDetermination-1790"><a href="#CenterDetermination-1790"><span class="linenos">1790</span></a>        <span class="c1">## (0) Image preprocessing --------------------------------------------</span>
</span><span id="CenterDetermination-1791"><a href="#CenterDetermination-1791"><span class="linenos">1791</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1792"><a href="#CenterDetermination-1792"><span class="linenos">1792</span></a>                    
</span><span id="CenterDetermination-1793"><a href="#CenterDetermination-1793"><span class="linenos">1793</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-1794"><a href="#CenterDetermination-1794"><span class="linenos">1794</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">:</span>
</span><span id="CenterDetermination-1795"><a href="#CenterDetermination-1795"><span class="linenos">1795</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  
</span><span id="CenterDetermination-1796"><a href="#CenterDetermination-1796"><span class="linenos">1796</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">skf</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination-1797"><a href="#CenterDetermination-1797"><span class="linenos">1797</span></a>                              <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1798"><a href="#CenterDetermination-1798"><span class="linenos">1798</span></a>                              <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination-1799"><a href="#CenterDetermination-1799"><span class="linenos">1799</span></a>                              <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination-1800"><a href="#CenterDetermination-1800"><span class="linenos">1800</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1801"><a href="#CenterDetermination-1801"><span class="linenos">1801</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">:</span>
</span><span id="CenterDetermination-1802"><a href="#CenterDetermination-1802"><span class="linenos">1802</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  
</span><span id="CenterDetermination-1803"><a href="#CenterDetermination-1803"><span class="linenos">1803</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">skf</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination-1804"><a href="#CenterDetermination-1804"><span class="linenos">1804</span></a>                              <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1805"><a href="#CenterDetermination-1805"><span class="linenos">1805</span></a>                              <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> 
</span><span id="CenterDetermination-1806"><a href="#CenterDetermination-1806"><span class="linenos">1806</span></a>                              <span class="n">high_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1807"><a href="#CenterDetermination-1807"><span class="linenos">1807</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination-1808"><a href="#CenterDetermination-1808"><span class="linenos">1808</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1809"><a href="#CenterDetermination-1809"><span class="linenos">1809</span></a>
</span><span id="CenterDetermination-1810"><a href="#CenterDetermination-1810"><span class="linenos">1810</span></a>        <span class="c1">## (1) Define the radii range for concentric circles ------------------</span>
</span><span id="CenterDetermination-1811"><a href="#CenterDetermination-1811"><span class="linenos">1811</span></a>        <span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">radius_step</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">10</span>
</span><span id="CenterDetermination-1812"><a href="#CenterDetermination-1812"><span class="linenos">1812</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span> <span class="o">+</span> <span class="n">radius_step</span><span class="p">,</span> <span class="n">radius_step</span><span class="p">)</span>
</span><span id="CenterDetermination-1813"><a href="#CenterDetermination-1813"><span class="linenos">1813</span></a>    
</span><span id="CenterDetermination-1814"><a href="#CenterDetermination-1814"><span class="linenos">1814</span></a>        <span class="c1"># Store detected circles</span>
</span><span id="CenterDetermination-1815"><a href="#CenterDetermination-1815"><span class="linenos">1815</span></a>        <span class="n">detected_circles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterDetermination-1816"><a href="#CenterDetermination-1816"><span class="linenos">1816</span></a>    
</span><span id="CenterDetermination-1817"><a href="#CenterDetermination-1817"><span class="linenos">1817</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterDetermination-1818"><a href="#CenterDetermination-1818"><span class="linenos">1818</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-1819"><a href="#CenterDetermination-1819"><span class="linenos">1819</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination-1820"><a href="#CenterDetermination-1820"><span class="linenos">1820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1821"><a href="#CenterDetermination-1821"><span class="linenos">1821</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination-1822"><a href="#CenterDetermination-1822"><span class="linenos">1822</span></a>                
</span><span id="CenterDetermination-1823"><a href="#CenterDetermination-1823"><span class="linenos">1823</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination-1824"><a href="#CenterDetermination-1824"><span class="linenos">1824</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1825"><a href="#CenterDetermination-1825"><span class="linenos">1825</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination-1826"><a href="#CenterDetermination-1826"><span class="linenos">1826</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Live Hough Circle Detection&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1827"><a href="#CenterDetermination-1827"><span class="linenos">1827</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>  <span class="c1"># Turn on interactive mode</span>
</span><span id="CenterDetermination-1828"><a href="#CenterDetermination-1828"><span class="linenos">1828</span></a>    
</span><span id="CenterDetermination-1829"><a href="#CenterDetermination-1829"><span class="linenos">1829</span></a>        <span class="c1">## (2) Process each radius one at a time ------------------------------</span>
</span><span id="CenterDetermination-1830"><a href="#CenterDetermination-1830"><span class="linenos">1830</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterDetermination-1831"><a href="#CenterDetermination-1831"><span class="linenos">1831</span></a>            <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">]))</span>
</span><span id="CenterDetermination-1832"><a href="#CenterDetermination-1832"><span class="linenos">1832</span></a>            <span class="n">accums</span><span class="p">,</span> <span class="n">x_peaks</span><span class="p">,</span> <span class="n">y_peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> 
</span><span id="CenterDetermination-1833"><a href="#CenterDetermination-1833"><span class="linenos">1833</span></a>                                                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">]),</span> 
</span><span id="CenterDetermination-1834"><a href="#CenterDetermination-1834"><span class="linenos">1834</span></a>                                                             <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1835"><a href="#CenterDetermination-1835"><span class="linenos">1835</span></a>    
</span><span id="CenterDetermination-1836"><a href="#CenterDetermination-1836"><span class="linenos">1836</span></a>            <span class="c1"># Store circle if detected</span>
</span><span id="CenterDetermination-1837"><a href="#CenterDetermination-1837"><span class="linenos">1837</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-1838"><a href="#CenterDetermination-1838"><span class="linenos">1838</span></a>                <span class="n">detected_circles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">))</span>
</span><span id="CenterDetermination-1839"><a href="#CenterDetermination-1839"><span class="linenos">1839</span></a>    
</span><span id="CenterDetermination-1840"><a href="#CenterDetermination-1840"><span class="linenos">1840</span></a>            <span class="c1"># Live animation (if enabled)</span>
</span><span id="CenterDetermination-1841"><a href="#CenterDetermination-1841"><span class="linenos">1841</span></a>            <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterDetermination-1842"><a href="#CenterDetermination-1842"><span class="linenos">1842</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination-1843"><a href="#CenterDetermination-1843"><span class="linenos">1843</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination-1844"><a href="#CenterDetermination-1844"><span class="linenos">1844</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detecting Circles: Radius </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1845"><a href="#CenterDetermination-1845"><span class="linenos">1845</span></a>                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">detected_circles</span><span class="p">:</span>
</span><span id="CenterDetermination-1846"><a href="#CenterDetermination-1846"><span class="linenos">1846</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1847"><a href="#CenterDetermination-1847"><span class="linenos">1847</span></a>                    <span class="n">circ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rad</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1848"><a href="#CenterDetermination-1848"><span class="linenos">1848</span></a>                                      <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1849"><a href="#CenterDetermination-1849"><span class="linenos">1849</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
</span><span id="CenterDetermination-1850"><a href="#CenterDetermination-1850"><span class="linenos">1850</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="CenterDetermination-1851"><a href="#CenterDetermination-1851"><span class="linenos">1851</span></a>    
</span><span id="CenterDetermination-1852"><a href="#CenterDetermination-1852"><span class="linenos">1852</span></a>        <span class="c1">## (3) Final detected circle ------------------------------------------</span>
</span><span id="CenterDetermination-1853"><a href="#CenterDetermination-1853"><span class="linenos">1853</span></a>        <span class="n">accums</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span>
</span><span id="CenterDetermination-1854"><a href="#CenterDetermination-1854"><span class="linenos">1854</span></a>            <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">radii</span><span class="p">),</span>
</span><span id="CenterDetermination-1855"><a href="#CenterDetermination-1855"><span class="linenos">1855</span></a>            <span class="n">radii</span><span class="p">,</span>
</span><span id="CenterDetermination-1856"><a href="#CenterDetermination-1856"><span class="linenos">1856</span></a>            <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">5</span>
</span><span id="CenterDetermination-1857"><a href="#CenterDetermination-1857"><span class="linenos">1857</span></a>        <span class="p">)</span>
</span><span id="CenterDetermination-1858"><a href="#CenterDetermination-1858"><span class="linenos">1858</span></a>        
</span><span id="CenterDetermination-1859"><a href="#CenterDetermination-1859"><span class="linenos">1859</span></a>        
</span><span id="CenterDetermination-1860"><a href="#CenterDetermination-1860"><span class="linenos">1860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1861"><a href="#CenterDetermination-1861"><span class="linenos">1861</span></a>            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination-1862"><a href="#CenterDetermination-1862"><span class="linenos">1862</span></a>    
</span><span id="CenterDetermination-1863"><a href="#CenterDetermination-1863"><span class="linenos">1863</span></a>        <span class="c1">## (4) User information -----------------------------------------------</span>
</span><span id="CenterDetermination-1864"><a href="#CenterDetermination-1864"><span class="linenos">1864</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination-1865"><a href="#CenterDetermination-1865"><span class="linenos">1865</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1866"><a href="#CenterDetermination-1866"><span class="linenos">1866</span></a>                <span class="s2">&quot;Center Determination (HoughTransform) : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span>\
</span><span id="CenterDetermination-1867"><a href="#CenterDetermination-1867"><span class="linenos">1867</span></a>                    <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination-1868"><a href="#CenterDetermination-1868"><span class="linenos">1868</span></a>    
</span><span id="CenterDetermination-1869"><a href="#CenterDetermination-1869"><span class="linenos">1869</span></a>        <span class="c1">## (5) Final plot with all detected circles (if enabled) --------------</span>
</span><span id="CenterDetermination-1870"><a href="#CenterDetermination-1870"><span class="linenos">1870</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterDetermination-1871"><a href="#CenterDetermination-1871"><span class="linenos">1871</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>  <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination-1872"><a href="#CenterDetermination-1872"><span class="linenos">1872</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1873"><a href="#CenterDetermination-1873"><span class="linenos">1873</span></a>        
</span><span id="CenterDetermination-1874"><a href="#CenterDetermination-1874"><span class="linenos">1874</span></a>        
</span><span id="CenterDetermination-1875"><a href="#CenterDetermination-1875"><span class="linenos">1875</span></a>            <span class="n">fig_final</span><span class="p">,</span> <span class="n">ax_final</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination-1876"><a href="#CenterDetermination-1876"><span class="linenos">1876</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination-1877"><a href="#CenterDetermination-1877"><span class="linenos">1877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hough Transform Preliminary Detection&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1878"><a href="#CenterDetermination-1878"><span class="linenos">1878</span></a>        
</span><span id="CenterDetermination-1879"><a href="#CenterDetermination-1879"><span class="linenos">1879</span></a>            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">detected_circles</span><span class="p">:</span>
</span><span id="CenterDetermination-1880"><a href="#CenterDetermination-1880"><span class="linenos">1880</span></a>                <span class="n">circ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rad</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1881"><a href="#CenterDetermination-1881"><span class="linenos">1881</span></a>                                  <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1882"><a href="#CenterDetermination-1882"><span class="linenos">1882</span></a>                <span class="n">ax_final</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
</span><span id="CenterDetermination-1883"><a href="#CenterDetermination-1883"><span class="linenos">1883</span></a>        
</span><span id="CenterDetermination-1884"><a href="#CenterDetermination-1884"><span class="linenos">1884</span></a>            <span class="c1"># Highlight the final detected circle (red)</span>
</span><span id="CenterDetermination-1885"><a href="#CenterDetermination-1885"><span class="linenos">1885</span></a>            <span class="n">circ_final</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="CenterDetermination-1886"><a href="#CenterDetermination-1886"><span class="linenos">1886</span></a>                                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination-1887"><a href="#CenterDetermination-1887"><span class="linenos">1887</span></a>                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Selected Circle&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1888"><a href="#CenterDetermination-1888"><span class="linenos">1888</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1889"><a href="#CenterDetermination-1889"><span class="linenos">1889</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ_final</span><span class="p">)</span>
</span><span id="CenterDetermination-1890"><a href="#CenterDetermination-1890"><span class="linenos">1890</span></a>        
</span><span id="CenterDetermination-1891"><a href="#CenterDetermination-1891"><span class="linenos">1891</span></a>            <span class="c1"># Create a single blue circle just for the legend</span>
</span><span id="CenterDetermination-1892"><a href="#CenterDetermination-1892"><span class="linenos">1892</span></a>            <span class="n">legend_blue</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterDetermination-1893"><a href="#CenterDetermination-1893"><span class="linenos">1893</span></a>                                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1894"><a href="#CenterDetermination-1894"><span class="linenos">1894</span></a>                                     <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination-1895"><a href="#CenterDetermination-1895"><span class="linenos">1895</span></a>                                     <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1896"><a href="#CenterDetermination-1896"><span class="linenos">1896</span></a>                                     <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Searching Space&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1897"><a href="#CenterDetermination-1897"><span class="linenos">1897</span></a>        
</span><span id="CenterDetermination-1898"><a href="#CenterDetermination-1898"><span class="linenos">1898</span></a>            <span class="c1"># Add the legend</span>
</span><span id="CenterDetermination-1899"><a href="#CenterDetermination-1899"><span class="linenos">1899</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">legend_blue</span><span class="p">,</span> <span class="n">circ_final</span><span class="p">])</span>
</span><span id="CenterDetermination-1900"><a href="#CenterDetermination-1900"><span class="linenos">1900</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1901"><a href="#CenterDetermination-1901"><span class="linenos">1901</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1902"><a href="#CenterDetermination-1902"><span class="linenos">1902</span></a>
</span><span id="CenterDetermination-1903"><a href="#CenterDetermination-1903"><span class="linenos">1903</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-1904"><a href="#CenterDetermination-1904"><span class="linenos">1904</span></a>    
</span><span id="CenterDetermination-1905"><a href="#CenterDetermination-1905"><span class="linenos">1905</span></a>        <span class="c1"># Close live plot (to avoid non-closed windows in Jupyter)</span>
</span><span id="CenterDetermination-1906"><a href="#CenterDetermination-1906"><span class="linenos">1906</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1907"><a href="#CenterDetermination-1907"><span class="linenos">1907</span></a>        
</span><span id="CenterDetermination-1908"><a href="#CenterDetermination-1908"><span class="linenos">1908</span></a>        <span class="c1">## (6) Final detected circle visualization (if requested) --------------</span>
</span><span id="CenterDetermination-1909"><a href="#CenterDetermination-1909"><span class="linenos">1909</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
</span><span id="CenterDetermination-1910"><a href="#CenterDetermination-1910"><span class="linenos">1910</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-1911"><a href="#CenterDetermination-1911"><span class="linenos">1911</span></a>    
</span><span id="CenterDetermination-1912"><a href="#CenterDetermination-1912"><span class="linenos">1912</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterDetermination-1913"><a href="#CenterDetermination-1913"><span class="linenos">1913</span></a>
</span><span id="CenterDetermination-1914"><a href="#CenterDetermination-1914"><span class="linenos">1914</span></a>   
</span><span id="CenterDetermination-1915"><a href="#CenterDetermination-1915"><span class="linenos">1915</span></a>    <span class="k">def</span> <span class="nf">detection_curvefit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination-1916"><a href="#CenterDetermination-1916"><span class="linenos">1916</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1917"><a href="#CenterDetermination-1917"><span class="linenos">1917</span></a><span class="sd">        Detects the center of a diffraction pattern by fitting a 2D pseudo-Voigt </span>
</span><span id="CenterDetermination-1918"><a href="#CenterDetermination-1918"><span class="linenos">1918</span></a><span class="sd">        function to the central region of the image.</span>
</span><span id="CenterDetermination-1919"><a href="#CenterDetermination-1919"><span class="linenos">1919</span></a><span class="sd">     </span>
</span><span id="CenterDetermination-1920"><a href="#CenterDetermination-1920"><span class="linenos">1920</span></a><span class="sd">        This method:</span>
</span><span id="CenterDetermination-1921"><a href="#CenterDetermination-1921"><span class="linenos">1921</span></a><span class="sd">            - Crops a square region around the image center.</span>
</span><span id="CenterDetermination-1922"><a href="#CenterDetermination-1922"><span class="linenos">1922</span></a><span class="sd">            - Fits a 2D pseudo-Voigt peak to the cropped region.</span>
</span><span id="CenterDetermination-1923"><a href="#CenterDetermination-1923"><span class="linenos">1923</span></a><span class="sd">            - Returns the refined center coordinates in the original image space.</span>
</span><span id="CenterDetermination-1924"><a href="#CenterDetermination-1924"><span class="linenos">1924</span></a><span class="sd">            - Optionally visualizes the result.</span>
</span><span id="CenterDetermination-1925"><a href="#CenterDetermination-1925"><span class="linenos">1925</span></a><span class="sd">            - Falls back to the crop center if fitting fails.</span>
</span><span id="CenterDetermination-1926"><a href="#CenterDetermination-1926"><span class="linenos">1926</span></a><span class="sd">     </span>
</span><span id="CenterDetermination-1927"><a href="#CenterDetermination-1927"><span class="linenos">1927</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1928"><a href="#CenterDetermination-1928"><span class="linenos">1928</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1929"><a href="#CenterDetermination-1929"><span class="linenos">1929</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="CenterDetermination-1930"><a href="#CenterDetermination-1930"><span class="linenos">1930</span></a><span class="sd">            If True, displays the fitted center location on the image. </span>
</span><span id="CenterDetermination-1931"><a href="#CenterDetermination-1931"><span class="linenos">1931</span></a><span class="sd">     </span>
</span><span id="CenterDetermination-1932"><a href="#CenterDetermination-1932"><span class="linenos">1932</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1933"><a href="#CenterDetermination-1933"><span class="linenos">1933</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1934"><a href="#CenterDetermination-1934"><span class="linenos">1934</span></a><span class="sd">        x : float</span>
</span><span id="CenterDetermination-1935"><a href="#CenterDetermination-1935"><span class="linenos">1935</span></a><span class="sd">            Refined x-coordinate of the center (column index).</span>
</span><span id="CenterDetermination-1936"><a href="#CenterDetermination-1936"><span class="linenos">1936</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-1937"><a href="#CenterDetermination-1937"><span class="linenos">1937</span></a><span class="sd">        y : float</span>
</span><span id="CenterDetermination-1938"><a href="#CenterDetermination-1938"><span class="linenos">1938</span></a><span class="sd">            Refined y-coordinate of the center (row index).</span>
</span><span id="CenterDetermination-1939"><a href="#CenterDetermination-1939"><span class="linenos">1939</span></a>
</span><span id="CenterDetermination-1940"><a href="#CenterDetermination-1940"><span class="linenos">1940</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1941"><a href="#CenterDetermination-1941"><span class="linenos">1941</span></a>    
</span><span id="CenterDetermination-1942"><a href="#CenterDetermination-1942"><span class="linenos">1942</span></a>        <span class="k">def</span> <span class="nf">pseudo_voigt_2d</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="CenterDetermination-1943"><a href="#CenterDetermination-1943"><span class="linenos">1943</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1944"><a href="#CenterDetermination-1944"><span class="linenos">1944</span></a><span class="sd">            Computes a 2D pseudo-Voigt function, which is a linear combination </span>
</span><span id="CenterDetermination-1945"><a href="#CenterDetermination-1945"><span class="linenos">1945</span></a><span class="sd">            of a Gaussian and a Lorentzian function.</span>
</span><span id="CenterDetermination-1946"><a href="#CenterDetermination-1946"><span class="linenos">1946</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1947"><a href="#CenterDetermination-1947"><span class="linenos">1947</span></a><span class="sd">            Parameters</span>
</span><span id="CenterDetermination-1948"><a href="#CenterDetermination-1948"><span class="linenos">1948</span></a><span class="sd">            ----------</span>
</span><span id="CenterDetermination-1949"><a href="#CenterDetermination-1949"><span class="linenos">1949</span></a><span class="sd">            xy : tuple of numpy.ndarray</span>
</span><span id="CenterDetermination-1950"><a href="#CenterDetermination-1950"><span class="linenos">1950</span></a><span class="sd">                A tuple (x, y) containing coordinate meshgrids.</span>
</span><span id="CenterDetermination-1951"><a href="#CenterDetermination-1951"><span class="linenos">1951</span></a><span class="sd">                </span>
</span><span id="CenterDetermination-1952"><a href="#CenterDetermination-1952"><span class="linenos">1952</span></a><span class="sd">            amp : float</span>
</span><span id="CenterDetermination-1953"><a href="#CenterDetermination-1953"><span class="linenos">1953</span></a><span class="sd">                Amplitude of the peak.</span>
</span><span id="CenterDetermination-1954"><a href="#CenterDetermination-1954"><span class="linenos">1954</span></a><span class="sd">                </span>
</span><span id="CenterDetermination-1955"><a href="#CenterDetermination-1955"><span class="linenos">1955</span></a><span class="sd">            x0, y0 : float</span>
</span><span id="CenterDetermination-1956"><a href="#CenterDetermination-1956"><span class="linenos">1956</span></a><span class="sd">                Coordinates of the center of the peak.</span>
</span><span id="CenterDetermination-1957"><a href="#CenterDetermination-1957"><span class="linenos">1957</span></a><span class="sd">                </span>
</span><span id="CenterDetermination-1958"><a href="#CenterDetermination-1958"><span class="linenos">1958</span></a><span class="sd">            sigma_x, sigma_y : float</span>
</span><span id="CenterDetermination-1959"><a href="#CenterDetermination-1959"><span class="linenos">1959</span></a><span class="sd">                Width (standard deviation) of the peak along the x and y axes.</span>
</span><span id="CenterDetermination-1960"><a href="#CenterDetermination-1960"><span class="linenos">1960</span></a><span class="sd">                </span>
</span><span id="CenterDetermination-1961"><a href="#CenterDetermination-1961"><span class="linenos">1961</span></a><span class="sd">            eta : float</span>
</span><span id="CenterDetermination-1962"><a href="#CenterDetermination-1962"><span class="linenos">1962</span></a><span class="sd">                Mixing parameter (0 = pure Gaussian, 1 = pure Lorentzian).</span>
</span><span id="CenterDetermination-1963"><a href="#CenterDetermination-1963"><span class="linenos">1963</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1964"><a href="#CenterDetermination-1964"><span class="linenos">1964</span></a><span class="sd">            Returns</span>
</span><span id="CenterDetermination-1965"><a href="#CenterDetermination-1965"><span class="linenos">1965</span></a><span class="sd">            -------</span>
</span><span id="CenterDetermination-1966"><a href="#CenterDetermination-1966"><span class="linenos">1966</span></a><span class="sd">            numpy.ndarray</span>
</span><span id="CenterDetermination-1967"><a href="#CenterDetermination-1967"><span class="linenos">1967</span></a><span class="sd">                Flattened 1D array of function values evaluated at the input </span>
</span><span id="CenterDetermination-1968"><a href="#CenterDetermination-1968"><span class="linenos">1968</span></a><span class="sd">                coordinates.</span>
</span><span id="CenterDetermination-1969"><a href="#CenterDetermination-1969"><span class="linenos">1969</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1970"><a href="#CenterDetermination-1970"><span class="linenos">1970</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
</span><span id="CenterDetermination-1971"><a href="#CenterDetermination-1971"><span class="linenos">1971</span></a>            <span class="n">r_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_x</span>
</span><span id="CenterDetermination-1972"><a href="#CenterDetermination-1972"><span class="linenos">1972</span></a>            <span class="n">r_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_y</span>
</span><span id="CenterDetermination-1973"><a href="#CenterDetermination-1973"><span class="linenos">1973</span></a>    
</span><span id="CenterDetermination-1974"><a href="#CenterDetermination-1974"><span class="linenos">1974</span></a>            <span class="n">gaussian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1975"><a href="#CenterDetermination-1975"><span class="linenos">1975</span></a>            <span class="n">lorentzian</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1976"><a href="#CenterDetermination-1976"><span class="linenos">1976</span></a>    
</span><span id="CenterDetermination-1977"><a href="#CenterDetermination-1977"><span class="linenos">1977</span></a>            <span class="k">return</span> <span class="n">amp</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">gaussian</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">lorentzian</span><span class="p">)</span>
</span><span id="CenterDetermination-1978"><a href="#CenterDetermination-1978"><span class="linenos">1978</span></a>        
</span><span id="CenterDetermination-1979"><a href="#CenterDetermination-1979"><span class="linenos">1979</span></a>        <span class="c1"># Define crop size around the center of the image</span>
</span><span id="CenterDetermination-1980"><a href="#CenterDetermination-1980"><span class="linenos">1980</span></a>        <span class="n">crop_size</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterDetermination-1981"><a href="#CenterDetermination-1981"><span class="linenos">1981</span></a>        
</span><span id="CenterDetermination-1982"><a href="#CenterDetermination-1982"><span class="linenos">1982</span></a>        <span class="c1"># Make a copy of the image to avoid modifying the original</span>
</span><span id="CenterDetermination-1983"><a href="#CenterDetermination-1983"><span class="linenos">1983</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1984"><a href="#CenterDetermination-1984"><span class="linenos">1984</span></a>        
</span><span id="CenterDetermination-1985"><a href="#CenterDetermination-1985"><span class="linenos">1985</span></a>        <span class="c1"># Get the image dimensions</span>
</span><span id="CenterDetermination-1986"><a href="#CenterDetermination-1986"><span class="linenos">1986</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterDetermination-1987"><a href="#CenterDetermination-1987"><span class="linenos">1987</span></a>        
</span><span id="CenterDetermination-1988"><a href="#CenterDetermination-1988"><span class="linenos">1988</span></a>        <span class="c1"># Estimate the center of the image</span>
</span><span id="CenterDetermination-1989"><a href="#CenterDetermination-1989"><span class="linenos">1989</span></a>        <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">=</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1990"><a href="#CenterDetermination-1990"><span class="linenos">1990</span></a>    
</span><span id="CenterDetermination-1991"><a href="#CenterDetermination-1991"><span class="linenos">1991</span></a>        <span class="c1"># Calculate the bounds of the cropped square region</span>
</span><span id="CenterDetermination-1992"><a href="#CenterDetermination-1992"><span class="linenos">1992</span></a>        <span class="n">half_crop</span> <span class="o">=</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1993"><a href="#CenterDetermination-1993"><span class="linenos">1993</span></a>        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_center</span> <span class="o">-</span> <span class="n">half_crop</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">half_crop</span><span class="p">)</span>
</span><span id="CenterDetermination-1994"><a href="#CenterDetermination-1994"><span class="linenos">1994</span></a>        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">-</span> <span class="n">half_crop</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">+</span> <span class="n">half_crop</span><span class="p">)</span>
</span><span id="CenterDetermination-1995"><a href="#CenterDetermination-1995"><span class="linenos">1995</span></a>    
</span><span id="CenterDetermination-1996"><a href="#CenterDetermination-1996"><span class="linenos">1996</span></a>        <span class="c1"># Crop the image around the center for curve fitting</span>
</span><span id="CenterDetermination-1997"><a href="#CenterDetermination-1997"><span class="linenos">1997</span></a>        <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
</span><span id="CenterDetermination-1998"><a href="#CenterDetermination-1998"><span class="linenos">1998</span></a>    
</span><span id="CenterDetermination-1999"><a href="#CenterDetermination-1999"><span class="linenos">1999</span></a>        <span class="c1"># Create a meshgrid of x and y coordinates for the cropped region</span>
</span><span id="CenterDetermination-2000"><a href="#CenterDetermination-2000"><span class="linenos">2000</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="CenterDetermination-2001"><a href="#CenterDetermination-2001"><span class="linenos">2001</span></a>                           <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="CenterDetermination-2002"><a href="#CenterDetermination-2002"><span class="linenos">2002</span></a>        
</span><span id="CenterDetermination-2003"><a href="#CenterDetermination-2003"><span class="linenos">2003</span></a>        <span class="c1"># Flatten the meshgrid coordinates and image for use with curve fitting</span>
</span><span id="CenterDetermination-2004"><a href="#CenterDetermination-2004"><span class="linenos">2004</span></a>        <span class="n">x_flat</span><span class="p">,</span> <span class="n">y_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="CenterDetermination-2005"><a href="#CenterDetermination-2005"><span class="linenos">2005</span></a>        <span class="n">image_flat</span> <span class="o">=</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="CenterDetermination-2006"><a href="#CenterDetermination-2006"><span class="linenos">2006</span></a>
</span><span id="CenterDetermination-2007"><a href="#CenterDetermination-2007"><span class="linenos">2007</span></a>        <span class="c1"># Set initial parameter guesses for curve fitting:</span>
</span><span id="CenterDetermination-2008"><a href="#CenterDetermination-2008"><span class="linenos">2008</span></a>        <span class="c1"># [amplitude, x0, y0, sigma_x, sigma_y, eta]    </span>
</span><span id="CenterDetermination-2009"><a href="#CenterDetermination-2009"><span class="linenos">2009</span></a>        <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CenterDetermination-2010"><a href="#CenterDetermination-2010"><span class="linenos">2010</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">),</span>
</span><span id="CenterDetermination-2011"><a href="#CenterDetermination-2011"><span class="linenos">2011</span></a>            <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="CenterDetermination-2012"><a href="#CenterDetermination-2012"><span class="linenos">2012</span></a>            <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="CenterDetermination-2013"><a href="#CenterDetermination-2013"><span class="linenos">2013</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="CenterDetermination-2014"><a href="#CenterDetermination-2014"><span class="linenos">2014</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="CenterDetermination-2015"><a href="#CenterDetermination-2015"><span class="linenos">2015</span></a>            <span class="mf">0.5</span>
</span><span id="CenterDetermination-2016"><a href="#CenterDetermination-2016"><span class="linenos">2016</span></a>        <span class="p">]</span>
</span><span id="CenterDetermination-2017"><a href="#CenterDetermination-2017"><span class="linenos">2017</span></a>        
</span><span id="CenterDetermination-2018"><a href="#CenterDetermination-2018"><span class="linenos">2018</span></a>        <span class="c1"># Define bounds for each parameter during optimization</span>
</span><span id="CenterDetermination-2019"><a href="#CenterDetermination-2019"><span class="linenos">2019</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination-2020"><a href="#CenterDetermination-2020"><span class="linenos">2020</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="CenterDetermination-2021"><a href="#CenterDetermination-2021"><span class="linenos">2021</span></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-2022"><a href="#CenterDetermination-2022"><span class="linenos">2022</span></a>        <span class="p">)</span>
</span><span id="CenterDetermination-2023"><a href="#CenterDetermination-2023"><span class="linenos">2023</span></a>    
</span><span id="CenterDetermination-2024"><a href="#CenterDetermination-2024"><span class="linenos">2024</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination-2025"><a href="#CenterDetermination-2025"><span class="linenos">2025</span></a>            <span class="c1"># Fit the pseudo-Voigt function to the cropped image</span>
</span><span id="CenterDetermination-2026"><a href="#CenterDetermination-2026"><span class="linenos">2026</span></a>            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
</span><span id="CenterDetermination-2027"><a href="#CenterDetermination-2027"><span class="linenos">2027</span></a>                <span class="n">pseudo_voigt_2d</span><span class="p">,</span>
</span><span id="CenterDetermination-2028"><a href="#CenterDetermination-2028"><span class="linenos">2028</span></a>                <span class="p">(</span><span class="n">x_flat</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">),</span>
</span><span id="CenterDetermination-2029"><a href="#CenterDetermination-2029"><span class="linenos">2029</span></a>                <span class="n">image_flat</span><span class="p">,</span>
</span><span id="CenterDetermination-2030"><a href="#CenterDetermination-2030"><span class="linenos">2030</span></a>                <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span>
</span><span id="CenterDetermination-2031"><a href="#CenterDetermination-2031"><span class="linenos">2031</span></a>                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="CenterDetermination-2032"><a href="#CenterDetermination-2032"><span class="linenos">2032</span></a>                <span class="n">max_nfev</span><span class="o">=</span><span class="mi">2000</span>  <span class="c1"># increase if needed</span>
</span><span id="CenterDetermination-2033"><a href="#CenterDetermination-2033"><span class="linenos">2033</span></a>            <span class="p">)</span>
</span><span id="CenterDetermination-2034"><a href="#CenterDetermination-2034"><span class="linenos">2034</span></a>            
</span><span id="CenterDetermination-2035"><a href="#CenterDetermination-2035"><span class="linenos">2035</span></a>            <span class="c1"># Extract refined x and y center coordinates from fit</span>
</span><span id="CenterDetermination-2036"><a href="#CenterDetermination-2036"><span class="linenos">2036</span></a>            <span class="n">x_refined</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="CenterDetermination-2037"><a href="#CenterDetermination-2037"><span class="linenos">2037</span></a>            <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterDetermination-2038"><a href="#CenterDetermination-2038"><span class="linenos">2038</span></a>    
</span><span id="CenterDetermination-2039"><a href="#CenterDetermination-2039"><span class="linenos">2039</span></a>        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="CenterDetermination-2040"><a href="#CenterDetermination-2040"><span class="linenos">2040</span></a>            <span class="c1"># If fitting fails, fall back to geometric center </span>
</span><span id="CenterDetermination-2041"><a href="#CenterDetermination-2041"><span class="linenos">2041</span></a>            <span class="n">x_refined</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">=</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-2042"><a href="#CenterDetermination-2042"><span class="linenos">2042</span></a>            <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-2043"><a href="#CenterDetermination-2043"><span class="linenos">2043</span></a>            
</span><span id="CenterDetermination-2044"><a href="#CenterDetermination-2044"><span class="linenos">2044</span></a>        <span class="c1"># Add the offset of the cropped region to get coordinates in full image</span>
</span><span id="CenterDetermination-2045"><a href="#CenterDetermination-2045"><span class="linenos">2045</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">x_refined</span> <span class="o">+</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">+</span> <span class="n">y_min</span>
</span><span id="CenterDetermination-2046"><a href="#CenterDetermination-2046"><span class="linenos">2046</span></a>        
</span><span id="CenterDetermination-2047"><a href="#CenterDetermination-2047"><span class="linenos">2047</span></a>        <span class="c1"># Print the result if verbose are enabled</span>
</span><span id="CenterDetermination-2048"><a href="#CenterDetermination-2048"><span class="linenos">2048</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="CenterDetermination-2049"><a href="#CenterDetermination-2049"><span class="linenos">2049</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination-2050"><a href="#CenterDetermination-2050"><span class="linenos">2050</span></a>                <span class="sa">f</span><span class="s2">&quot;Center Determination (CurveFitting) :   (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-2051"><a href="#CenterDetermination-2051"><span class="linenos">2051</span></a>                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; [fallback]&quot;</span> <span class="k">if</span> <span class="n">used_fallback</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2052"><a href="#CenterDetermination-2052"><span class="linenos">2052</span></a>            <span class="p">)</span>
</span><span id="CenterDetermination-2053"><a href="#CenterDetermination-2053"><span class="linenos">2053</span></a>            
</span><span id="CenterDetermination-2054"><a href="#CenterDetermination-2054"><span class="linenos">2054</span></a>        <span class="c1"># Optionally show the result visually</span>
</span><span id="CenterDetermination-2055"><a href="#CenterDetermination-2055"><span class="linenos">2055</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
</span><span id="CenterDetermination-2056"><a href="#CenterDetermination-2056"><span class="linenos">2056</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination-2057"><a href="#CenterDetermination-2057"><span class="linenos">2057</span></a>    
</span><span id="CenterDetermination-2058"><a href="#CenterDetermination-2058"><span class="linenos">2058</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2059"><a href="#CenterDetermination-2059"><span class="linenos">2059</span></a>
</span><span id="CenterDetermination-2060"><a href="#CenterDetermination-2060"><span class="linenos">2060</span></a>
</span><span id="CenterDetermination-2061"><a href="#CenterDetermination-2061"><span class="linenos">2061</span></a>    <span class="k">def</span> <span class="nf">detection_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination-2062"><a href="#CenterDetermination-2062"><span class="linenos">2062</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination-2063"><a href="#CenterDetermination-2063"><span class="linenos">2063</span></a><span class="sd">        Semi-automated detection of the diffraction pattern center using manual </span>
</span><span id="CenterDetermination-2064"><a href="#CenterDetermination-2064"><span class="linenos">2064</span></a><span class="sd">        selection of 3 points.</span>
</span><span id="CenterDetermination-2065"><a href="#CenterDetermination-2065"><span class="linenos">2065</span></a>
</span><span id="CenterDetermination-2066"><a href="#CenterDetermination-2066"><span class="linenos">2066</span></a><span class="sd">        This method allows the user to manually select 3 points along a visible </span>
</span><span id="CenterDetermination-2067"><a href="#CenterDetermination-2067"><span class="linenos">2067</span></a><span class="sd">        diffraction ring in the image to define a circle. Once selected, </span>
</span><span id="CenterDetermination-2068"><a href="#CenterDetermination-2068"><span class="linenos">2068</span></a><span class="sd">        the center and radius of the circle are automatically computed. After </span>
</span><span id="CenterDetermination-2069"><a href="#CenterDetermination-2069"><span class="linenos">2069</span></a><span class="sd">        that, the user can manually adjust the center position using</span>
</span><span id="CenterDetermination-2070"><a href="#CenterDetermination-2070"><span class="linenos">2070</span></a><span class="sd">        an interactive interface.</span>
</span><span id="CenterDetermination-2071"><a href="#CenterDetermination-2071"><span class="linenos">2071</span></a>
</span><span id="CenterDetermination-2072"><a href="#CenterDetermination-2072"><span class="linenos">2072</span></a><span class="sd">        User Controls (during point selection)</span>
</span><span id="CenterDetermination-2073"><a href="#CenterDetermination-2073"><span class="linenos">2073</span></a><span class="sd">        --------------------------------------</span>
</span><span id="CenterDetermination-2074"><a href="#CenterDetermination-2074"><span class="linenos">2074</span></a><span class="sd">        - **&#39;1&#39;**: Add a point at the current mouse cursor position </span>
</span><span id="CenterDetermination-2075"><a href="#CenterDetermination-2075"><span class="linenos">2075</span></a><span class="sd">                         (max 3 points).</span>
</span><span id="CenterDetermination-2076"><a href="#CenterDetermination-2076"><span class="linenos">2076</span></a><span class="sd">        - **&#39;2&#39;**: Delete the most recently added point.</span>
</span><span id="CenterDetermination-2077"><a href="#CenterDetermination-2077"><span class="linenos">2077</span></a><span class="sd">        - **&#39;3&#39;**: Delete the point closest to the mouse cursor.</span>
</span><span id="CenterDetermination-2078"><a href="#CenterDetermination-2078"><span class="linenos">2078</span></a><span class="sd">        - **&#39;d&#39;**: When 3 points are selected (DONE), proceed </span>
</span><span id="CenterDetermination-2079"><a href="#CenterDetermination-2079"><span class="linenos">2079</span></a><span class="sd">        - **Close**    : Terminate the process without detecting a center.</span>
</span><span id="CenterDetermination-2080"><a href="#CenterDetermination-2080"><span class="linenos">2080</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2081"><a href="#CenterDetermination-2081"><span class="linenos">2081</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-2082"><a href="#CenterDetermination-2082"><span class="linenos">2082</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-2083"><a href="#CenterDetermination-2083"><span class="linenos">2083</span></a><span class="sd">        plot_results : int, binary, default=0</span>
</span><span id="CenterDetermination-2084"><a href="#CenterDetermination-2084"><span class="linenos">2084</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="CenterDetermination-2085"><a href="#CenterDetermination-2085"><span class="linenos">2085</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2086"><a href="#CenterDetermination-2086"><span class="linenos">2086</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-2087"><a href="#CenterDetermination-2087"><span class="linenos">2087</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-2088"><a href="#CenterDetermination-2088"><span class="linenos">2088</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination-2089"><a href="#CenterDetermination-2089"><span class="linenos">2089</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination-2090"><a href="#CenterDetermination-2090"><span class="linenos">2090</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2091"><a href="#CenterDetermination-2091"><span class="linenos">2091</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination-2092"><a href="#CenterDetermination-2092"><span class="linenos">2092</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination-2093"><a href="#CenterDetermination-2093"><span class="linenos">2093</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2094"><a href="#CenterDetermination-2094"><span class="linenos">2094</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination-2095"><a href="#CenterDetermination-2095"><span class="linenos">2095</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination-2096"><a href="#CenterDetermination-2096"><span class="linenos">2096</span></a><span class="sd">            (if available, othervise returns None)</span>
</span><span id="CenterDetermination-2097"><a href="#CenterDetermination-2097"><span class="linenos">2097</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination-2098"><a href="#CenterDetermination-2098"><span class="linenos">2098</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-2099"><a href="#CenterDetermination-2099"><span class="linenos">2099</span></a>        <span class="c1"># (0) Load and prepare image ------------------------------------------</span>
</span><span id="CenterDetermination-2100"><a href="#CenterDetermination-2100"><span class="linenos">2100</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span>
</span><span id="CenterDetermination-2101"><a href="#CenterDetermination-2101"><span class="linenos">2101</span></a>        
</span><span id="CenterDetermination-2102"><a href="#CenterDetermination-2102"><span class="linenos">2102</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterDetermination-2103"><a href="#CenterDetermination-2103"><span class="linenos">2103</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-2104"><a href="#CenterDetermination-2104"><span class="linenos">2104</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2105"><a href="#CenterDetermination-2105"><span class="linenos">2105</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2106"><a href="#CenterDetermination-2106"><span class="linenos">2106</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination-2107"><a href="#CenterDetermination-2107"><span class="linenos">2107</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination-2108"><a href="#CenterDetermination-2108"><span class="linenos">2108</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination-2109"><a href="#CenterDetermination-2109"><span class="linenos">2109</span></a>            
</span><span id="CenterDetermination-2110"><a href="#CenterDetermination-2110"><span class="linenos">2110</span></a>        <span class="c1"># (2) Create a figure and display the image ---------------------------</span>
</span><span id="CenterDetermination-2111"><a href="#CenterDetermination-2111"><span class="linenos">2111</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> 
</span><span id="CenterDetermination-2112"><a href="#CenterDetermination-2112"><span class="linenos">2112</span></a>        
</span><span id="CenterDetermination-2113"><a href="#CenterDetermination-2113"><span class="linenos">2113</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination-2114"><a href="#CenterDetermination-2114"><span class="linenos">2114</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2115"><a href="#CenterDetermination-2115"><span class="linenos">2115</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2116"><a href="#CenterDetermination-2116"><span class="linenos">2116</span></a> 
</span><span id="CenterDetermination-2117"><a href="#CenterDetermination-2117"><span class="linenos">2117</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Select 3 points defining one of diffraction circles&quot;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2118"><a href="#CenterDetermination-2118"><span class="linenos">2118</span></a>                  <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-2119"><a href="#CenterDetermination-2119"><span class="linenos">2119</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2120"><a href="#CenterDetermination-2120"><span class="linenos">2120</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2121"><a href="#CenterDetermination-2121"><span class="linenos">2121</span></a>
</span><span id="CenterDetermination-2122"><a href="#CenterDetermination-2122"><span class="linenos">2122</span></a>        <span class="c1"># (3) User information ------------------------------------------------</span>
</span><span id="CenterDetermination-2123"><a href="#CenterDetermination-2123"><span class="linenos">2123</span></a>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination-2124"><a href="#CenterDetermination-2124"><span class="linenos">2124</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2125"><a href="#CenterDetermination-2125"><span class="linenos">2125</span></a><span class="sd">            CenterDetermination :: ThreePoints (semi-automated method)</span>
</span><span id="CenterDetermination-2126"><a href="#CenterDetermination-2126"><span class="linenos">2126</span></a><span class="sd">            Select 3 points to define a diffraction circle using keys:</span>
</span><span id="CenterDetermination-2127"><a href="#CenterDetermination-2127"><span class="linenos">2127</span></a><span class="sd">              - &#39;1&#39; : define a point at current cursor position</span>
</span><span id="CenterDetermination-2128"><a href="#CenterDetermination-2128"><span class="linenos">2128</span></a><span class="sd">              - &#39;2&#39; : delete the last point</span>
</span><span id="CenterDetermination-2129"><a href="#CenterDetermination-2129"><span class="linenos">2129</span></a><span class="sd">              - &#39;3&#39; : delete the point closest to the cursor</span>
</span><span id="CenterDetermination-2130"><a href="#CenterDetermination-2130"><span class="linenos">2130</span></a><span class="sd">              - &#39;d&#39; : done = finished = go to the next step</span>
</span><span id="CenterDetermination-2131"><a href="#CenterDetermination-2131"><span class="linenos">2131</span></a><span class="sd">            Close the figure to terminate. No center will be detected.</span>
</span><span id="CenterDetermination-2132"><a href="#CenterDetermination-2132"><span class="linenos">2132</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2133"><a href="#CenterDetermination-2133"><span class="linenos">2133</span></a>
</span><span id="CenterDetermination-2134"><a href="#CenterDetermination-2134"><span class="linenos">2134</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterDetermination-2135"><a href="#CenterDetermination-2135"><span class="linenos">2135</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination-2136"><a href="#CenterDetermination-2136"><span class="linenos">2136</span></a>       
</span><span id="CenterDetermination-2137"><a href="#CenterDetermination-2137"><span class="linenos">2137</span></a>        <span class="c1"># (4) Enable interactive mode -----------------------------------------</span>
</span><span id="CenterDetermination-2138"><a href="#CenterDetermination-2138"><span class="linenos">2138</span></a>        <span class="c1"># (figure is updated after every plotting command</span>
</span><span id="CenterDetermination-2139"><a href="#CenterDetermination-2139"><span class="linenos">2139</span></a>        <span class="c1"># (so that calling figure.show() is not necessary</span>
</span><span id="CenterDetermination-2140"><a href="#CenterDetermination-2140"><span class="linenos">2140</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination-2141"><a href="#CenterDetermination-2141"><span class="linenos">2141</span></a> 
</span><span id="CenterDetermination-2142"><a href="#CenterDetermination-2142"><span class="linenos">2142</span></a>        <span class="c1"># (5) Initialization</span>
</span><span id="CenterDetermination-2143"><a href="#CenterDetermination-2143"><span class="linenos">2143</span></a>        <span class="c1"># Initialize the list of coordinates</span>
</span><span id="CenterDetermination-2144"><a href="#CenterDetermination-2144"><span class="linenos">2144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span> 
</span><span id="CenterDetermination-2145"><a href="#CenterDetermination-2145"><span class="linenos">2145</span></a>        
</span><span id="CenterDetermination-2146"><a href="#CenterDetermination-2146"><span class="linenos">2146</span></a>        <span class="c1"># Initialize all flags and counters</span>
</span><span id="CenterDetermination-2147"><a href="#CenterDetermination-2147"><span class="linenos">2147</span></a>        <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># press &#39;d&#39; event</span>
</span><span id="CenterDetermination-2148"><a href="#CenterDetermination-2148"><span class="linenos">2148</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># close window event</span>
</span><span id="CenterDetermination-2149"><a href="#CenterDetermination-2149"><span class="linenos">2149</span></a>        <span class="n">point_counter</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># number of selected points</span>
</span><span id="CenterDetermination-2150"><a href="#CenterDetermination-2150"><span class="linenos">2150</span></a>        
</span><span id="CenterDetermination-2151"><a href="#CenterDetermination-2151"><span class="linenos">2151</span></a>        <span class="c1"># (6) Define the event handler for figure close event -----------------</span>
</span><span id="CenterDetermination-2152"><a href="#CenterDetermination-2152"><span class="linenos">2152</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-2153"><a href="#CenterDetermination-2153"><span class="linenos">2153</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-2154"><a href="#CenterDetermination-2154"><span class="linenos">2154</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-2155"><a href="#CenterDetermination-2155"><span class="linenos">2155</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2156"><a href="#CenterDetermination-2156"><span class="linenos">2156</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execution terminated.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2157"><a href="#CenterDetermination-2157"><span class="linenos">2157</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2158"><a href="#CenterDetermination-2158"><span class="linenos">2158</span></a>
</span><span id="CenterDetermination-2159"><a href="#CenterDetermination-2159"><span class="linenos">2159</span></a> 
</span><span id="CenterDetermination-2160"><a href="#CenterDetermination-2160"><span class="linenos">2160</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination-2161"><a href="#CenterDetermination-2161"><span class="linenos">2161</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination-2162"><a href="#CenterDetermination-2162"><span class="linenos">2162</span></a>        
</span><span id="CenterDetermination-2163"><a href="#CenterDetermination-2163"><span class="linenos">2163</span></a>        
</span><span id="CenterDetermination-2164"><a href="#CenterDetermination-2164"><span class="linenos">2164</span></a>        <span class="c1"># (7) Define the callback function for key press events ---------------</span>
</span><span id="CenterDetermination-2165"><a href="#CenterDetermination-2165"><span class="linenos">2165</span></a>        <span class="k">def</span> <span class="nf">onkeypress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-2166"><a href="#CenterDetermination-2166"><span class="linenos">2166</span></a>            <span class="c1"># nonlocal to modify the flag variable in the outer scope</span>
</span><span id="CenterDetermination-2167"><a href="#CenterDetermination-2167"><span class="linenos">2167</span></a>            <span class="k">nonlocal</span> <span class="n">calculate_circle_flag</span><span class="p">,</span> <span class="n">point_counter</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-2168"><a href="#CenterDetermination-2168"><span class="linenos">2168</span></a>            
</span><span id="CenterDetermination-2169"><a href="#CenterDetermination-2169"><span class="linenos">2169</span></a>            <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination-2170"><a href="#CenterDetermination-2170"><span class="linenos">2170</span></a>            <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination-2171"><a href="#CenterDetermination-2171"><span class="linenos">2171</span></a>            <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination-2172"><a href="#CenterDetermination-2172"><span class="linenos">2172</span></a> 
</span><span id="CenterDetermination-2173"><a href="#CenterDetermination-2173"><span class="linenos">2173</span></a>            <span class="c1">## Delete points -- the closest to the cursor</span>
</span><span id="CenterDetermination-2174"><a href="#CenterDetermination-2174"><span class="linenos">2174</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2175"><a href="#CenterDetermination-2175"><span class="linenos">2175</span></a>                <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-2176"><a href="#CenterDetermination-2176"><span class="linenos">2176</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-2177"><a href="#CenterDetermination-2177"><span class="linenos">2177</span></a>                    <span class="n">pointer_x</span><span class="p">,</span> <span class="n">pointer_y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
</span><span id="CenterDetermination-2178"><a href="#CenterDetermination-2178"><span class="linenos">2178</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CenterDetermination-2179"><a href="#CenterDetermination-2179"><span class="linenos">2179</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">pointer_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">pointer_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-2180"><a href="#CenterDetermination-2180"><span class="linenos">2180</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">]</span>
</span><span id="CenterDetermination-2181"><a href="#CenterDetermination-2181"><span class="linenos">2181</span></a>                    <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
</span><span id="CenterDetermination-2182"><a href="#CenterDetermination-2182"><span class="linenos">2182</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">closest_index</span><span class="p">]</span>
</span><span id="CenterDetermination-2183"><a href="#CenterDetermination-2183"><span class="linenos">2183</span></a>    
</span><span id="CenterDetermination-2184"><a href="#CenterDetermination-2184"><span class="linenos">2184</span></a>                    <span class="c1">## Redraw the image without the deleted point</span>
</span><span id="CenterDetermination-2185"><a href="#CenterDetermination-2185"><span class="linenos">2185</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination-2186"><a href="#CenterDetermination-2186"><span class="linenos">2186</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-2187"><a href="#CenterDetermination-2187"><span class="linenos">2187</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2188"><a href="#CenterDetermination-2188"><span class="linenos">2188</span></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination-2189"><a href="#CenterDetermination-2189"><span class="linenos">2189</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination-2190"><a href="#CenterDetermination-2190"><span class="linenos">2190</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2191"><a href="#CenterDetermination-2191"><span class="linenos">2191</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination-2192"><a href="#CenterDetermination-2192"><span class="linenos">2192</span></a>
</span><span id="CenterDetermination-2193"><a href="#CenterDetermination-2193"><span class="linenos">2193</span></a>                    <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination-2194"><a href="#CenterDetermination-2194"><span class="linenos">2194</span></a>                        <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination-2195"><a href="#CenterDetermination-2195"><span class="linenos">2195</span></a>                        <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2196"><a href="#CenterDetermination-2196"><span class="linenos">2196</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-2197"><a href="#CenterDetermination-2197"><span class="linenos">2197</span></a>                    
</span><span id="CenterDetermination-2198"><a href="#CenterDetermination-2198"><span class="linenos">2198</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination-2199"><a href="#CenterDetermination-2199"><span class="linenos">2199</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-2200"><a href="#CenterDetermination-2200"><span class="linenos">2200</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-2201"><a href="#CenterDetermination-2201"><span class="linenos">2201</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2202"><a href="#CenterDetermination-2202"><span class="linenos">2202</span></a>                    
</span><span id="CenterDetermination-2203"><a href="#CenterDetermination-2203"><span class="linenos">2203</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-2204"><a href="#CenterDetermination-2204"><span class="linenos">2204</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2205"><a href="#CenterDetermination-2205"><span class="linenos">2205</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2206"><a href="#CenterDetermination-2206"><span class="linenos">2206</span></a>    
</span><span id="CenterDetermination-2207"><a href="#CenterDetermination-2207"><span class="linenos">2207</span></a>            <span class="c1"># Delete recent point (last added) -- independent on the cursor</span>
</span><span id="CenterDetermination-2208"><a href="#CenterDetermination-2208"><span class="linenos">2208</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2209"><a href="#CenterDetermination-2209"><span class="linenos">2209</span></a>                <span class="c1"># Check if there are points to delete</span>
</span><span id="CenterDetermination-2210"><a href="#CenterDetermination-2210"><span class="linenos">2210</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span><span id="CenterDetermination-2211"><a href="#CenterDetermination-2211"><span class="linenos">2211</span></a>                    <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-2212"><a href="#CenterDetermination-2212"><span class="linenos">2212</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-2213"><a href="#CenterDetermination-2213"><span class="linenos">2213</span></a>                        <span class="c1"># Delete the last point in the list</span>
</span><span id="CenterDetermination-2214"><a href="#CenterDetermination-2214"><span class="linenos">2214</span></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-2215"><a href="#CenterDetermination-2215"><span class="linenos">2215</span></a>    
</span><span id="CenterDetermination-2216"><a href="#CenterDetermination-2216"><span class="linenos">2216</span></a>                        <span class="c1"># Redraw the image without the deleted point</span>
</span><span id="CenterDetermination-2217"><a href="#CenterDetermination-2217"><span class="linenos">2217</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination-2218"><a href="#CenterDetermination-2218"><span class="linenos">2218</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-2219"><a href="#CenterDetermination-2219"><span class="linenos">2219</span></a>                                  <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2220"><a href="#CenterDetermination-2220"><span class="linenos">2220</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination-2221"><a href="#CenterDetermination-2221"><span class="linenos">2221</span></a>                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination-2222"><a href="#CenterDetermination-2222"><span class="linenos">2222</span></a>                                       <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2223"><a href="#CenterDetermination-2223"><span class="linenos">2223</span></a>                                       <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination-2224"><a href="#CenterDetermination-2224"><span class="linenos">2224</span></a>
</span><span id="CenterDetermination-2225"><a href="#CenterDetermination-2225"><span class="linenos">2225</span></a>                        <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination-2226"><a href="#CenterDetermination-2226"><span class="linenos">2226</span></a>                            <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination-2227"><a href="#CenterDetermination-2227"><span class="linenos">2227</span></a>                            <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2228"><a href="#CenterDetermination-2228"><span class="linenos">2228</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">)</span>
</span><span id="CenterDetermination-2229"><a href="#CenterDetermination-2229"><span class="linenos">2229</span></a>                        
</span><span id="CenterDetermination-2230"><a href="#CenterDetermination-2230"><span class="linenos">2230</span></a>                        <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination-2231"><a href="#CenterDetermination-2231"><span class="linenos">2231</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-2232"><a href="#CenterDetermination-2232"><span class="linenos">2232</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-2233"><a href="#CenterDetermination-2233"><span class="linenos">2233</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2234"><a href="#CenterDetermination-2234"><span class="linenos">2234</span></a>
</span><span id="CenterDetermination-2235"><a href="#CenterDetermination-2235"><span class="linenos">2235</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-2236"><a href="#CenterDetermination-2236"><span class="linenos">2236</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2237"><a href="#CenterDetermination-2237"><span class="linenos">2237</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2238"><a href="#CenterDetermination-2238"><span class="linenos">2238</span></a>                    
</span><span id="CenterDetermination-2239"><a href="#CenterDetermination-2239"><span class="linenos">2239</span></a>            <span class="c1">## Select points </span>
</span><span id="CenterDetermination-2240"><a href="#CenterDetermination-2240"><span class="linenos">2240</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2241"><a href="#CenterDetermination-2241"><span class="linenos">2241</span></a>                <span class="c1"># Only allow selecting up to three points</span>
</span><span id="CenterDetermination-2242"><a href="#CenterDetermination-2242"><span class="linenos">2242</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  
</span><span id="CenterDetermination-2243"><a href="#CenterDetermination-2243"><span class="linenos">2243</span></a>                    <span class="c1"># Save the coordinates of the clicked point</span>
</span><span id="CenterDetermination-2244"><a href="#CenterDetermination-2244"><span class="linenos">2244</span></a>                    <span class="n">new_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</span><span id="CenterDetermination-2245"><a href="#CenterDetermination-2245"><span class="linenos">2245</span></a>                    
</span><span id="CenterDetermination-2246"><a href="#CenterDetermination-2246"><span class="linenos">2246</span></a>                    <span class="k">if</span> <span class="n">new_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination-2247"><a href="#CenterDetermination-2247"><span class="linenos">2247</span></a>                        <span class="c1"># Do not allow multiple selection of one point</span>
</span><span id="CenterDetermination-2248"><a href="#CenterDetermination-2248"><span class="linenos">2248</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The selected point already exists.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2249"><a href="#CenterDetermination-2249"><span class="linenos">2249</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2250"><a href="#CenterDetermination-2250"><span class="linenos">2250</span></a>                        <span class="c1"># Add selected point</span>
</span><span id="CenterDetermination-2251"><a href="#CenterDetermination-2251"><span class="linenos">2251</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
</span><span id="CenterDetermination-2252"><a href="#CenterDetermination-2252"><span class="linenos">2252</span></a>    
</span><span id="CenterDetermination-2253"><a href="#CenterDetermination-2253"><span class="linenos">2253</span></a>                        <span class="c1"># Visualize the selected point on the image</span>
</span><span id="CenterDetermination-2254"><a href="#CenterDetermination-2254"><span class="linenos">2254</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="CenterDetermination-2255"><a href="#CenterDetermination-2255"><span class="linenos">2255</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2256"><a href="#CenterDetermination-2256"><span class="linenos">2256</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination-2257"><a href="#CenterDetermination-2257"><span class="linenos">2257</span></a>
</span><span id="CenterDetermination-2258"><a href="#CenterDetermination-2258"><span class="linenos">2258</span></a>                        <span class="c1"># Restore the previous zoom level</span>
</span><span id="CenterDetermination-2259"><a href="#CenterDetermination-2259"><span class="linenos">2259</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-2260"><a href="#CenterDetermination-2260"><span class="linenos">2260</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-2261"><a href="#CenterDetermination-2261"><span class="linenos">2261</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2262"><a href="#CenterDetermination-2262"><span class="linenos">2262</span></a>
</span><span id="CenterDetermination-2263"><a href="#CenterDetermination-2263"><span class="linenos">2263</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-2264"><a href="#CenterDetermination-2264"><span class="linenos">2264</span></a>    
</span><span id="CenterDetermination-2265"><a href="#CenterDetermination-2265"><span class="linenos">2265</span></a>                        <span class="n">point_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-2266"><a href="#CenterDetermination-2266"><span class="linenos">2266</span></a>
</span><span id="CenterDetermination-2267"><a href="#CenterDetermination-2267"><span class="linenos">2267</span></a>    
</span><span id="CenterDetermination-2268"><a href="#CenterDetermination-2268"><span class="linenos">2268</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination-2269"><a href="#CenterDetermination-2269"><span class="linenos">2269</span></a>                    <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination-2270"><a href="#CenterDetermination-2270"><span class="linenos">2270</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination-2271"><a href="#CenterDetermination-2271"><span class="linenos">2271</span></a>    
</span><span id="CenterDetermination-2272"><a href="#CenterDetermination-2272"><span class="linenos">2272</span></a>
</span><span id="CenterDetermination-2273"><a href="#CenterDetermination-2273"><span class="linenos">2273</span></a>    
</span><span id="CenterDetermination-2274"><a href="#CenterDetermination-2274"><span class="linenos">2274</span></a>            <span class="c1"># (8) Calculate circle or terminate -------------------------------</span>
</span><span id="CenterDetermination-2275"><a href="#CenterDetermination-2275"><span class="linenos">2275</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2276"><a href="#CenterDetermination-2276"><span class="linenos">2276</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination-2277"><a href="#CenterDetermination-2277"><span class="linenos">2277</span></a>                    <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-2278"><a href="#CenterDetermination-2278"><span class="linenos">2278</span></a> 
</span><span id="CenterDetermination-2279"><a href="#CenterDetermination-2279"><span class="linenos">2279</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2280"><a href="#CenterDetermination-2280"><span class="linenos">2280</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select exactly 3 points to calculate the circle.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2281"><a href="#CenterDetermination-2281"><span class="linenos">2281</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-2282"><a href="#CenterDetermination-2282"><span class="linenos">2282</span></a>    
</span><span id="CenterDetermination-2283"><a href="#CenterDetermination-2283"><span class="linenos">2283</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination-2284"><a href="#CenterDetermination-2284"><span class="linenos">2284</span></a>        <span class="n">cid0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress</span><span class="p">)</span>
</span><span id="CenterDetermination-2285"><a href="#CenterDetermination-2285"><span class="linenos">2285</span></a>
</span><span id="CenterDetermination-2286"><a href="#CenterDetermination-2286"><span class="linenos">2286</span></a>        <span class="c1"># Show the plot </span>
</span><span id="CenterDetermination-2287"><a href="#CenterDetermination-2287"><span class="linenos">2287</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-2288"><a href="#CenterDetermination-2288"><span class="linenos">2288</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2289"><a href="#CenterDetermination-2289"><span class="linenos">2289</span></a>
</span><span id="CenterDetermination-2290"><a href="#CenterDetermination-2290"><span class="linenos">2290</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-2291"><a href="#CenterDetermination-2291"><span class="linenos">2291</span></a>      
</span><span id="CenterDetermination-2292"><a href="#CenterDetermination-2292"><span class="linenos">2292</span></a>        <span class="c1"># Wait for &#39;d&#39; key event or close the figure if no points are selected</span>
</span><span id="CenterDetermination-2293"><a href="#CenterDetermination-2293"><span class="linenos">2293</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">calculate_circle_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination-2294"><a href="#CenterDetermination-2294"><span class="linenos">2294</span></a> 
</span><span id="CenterDetermination-2295"><a href="#CenterDetermination-2295"><span class="linenos">2295</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination-2296"><a href="#CenterDetermination-2296"><span class="linenos">2296</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination-2297"><a href="#CenterDetermination-2297"><span class="linenos">2297</span></a>                <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination-2298"><a href="#CenterDetermination-2298"><span class="linenos">2298</span></a>                <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination-2299"><a href="#CenterDetermination-2299"><span class="linenos">2299</span></a>                <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination-2300"><a href="#CenterDetermination-2300"><span class="linenos">2300</span></a> 
</span><span id="CenterDetermination-2301"><a href="#CenterDetermination-2301"><span class="linenos">2301</span></a>                <span class="c1"># Plot detected diffraction pattern</span>
</span><span id="CenterDetermination-2302"><a href="#CenterDetermination-2302"><span class="linenos">2302</span></a>                <span class="k">if</span> <span class="n">calculate_circle_flag</span><span class="p">:</span>
</span><span id="CenterDetermination-2303"><a href="#CenterDetermination-2303"><span class="linenos">2303</span></a> 
</span><span id="CenterDetermination-2304"><a href="#CenterDetermination-2304"><span class="linenos">2304</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_circle</span><span class="p">(</span><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination-2305"><a href="#CenterDetermination-2305"><span class="linenos">2305</span></a>                    
</span><span id="CenterDetermination-2306"><a href="#CenterDetermination-2306"><span class="linenos">2306</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination-2307"><a href="#CenterDetermination-2307"><span class="linenos">2307</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-2308"><a href="#CenterDetermination-2308"><span class="linenos">2308</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2309"><a href="#CenterDetermination-2309"><span class="linenos">2309</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination-2310"><a href="#CenterDetermination-2310"><span class="linenos">2310</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-2311"><a href="#CenterDetermination-2311"><span class="linenos">2311</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-2312"><a href="#CenterDetermination-2312"><span class="linenos">2312</span></a>                 
</span><span id="CenterDetermination-2313"><a href="#CenterDetermination-2313"><span class="linenos">2313</span></a>                    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterDetermination-2314"><a href="#CenterDetermination-2314"><span class="linenos">2314</span></a>                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-2315"><a href="#CenterDetermination-2315"><span class="linenos">2315</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination-2316"><a href="#CenterDetermination-2316"><span class="linenos">2316</span></a>        
</span><span id="CenterDetermination-2317"><a href="#CenterDetermination-2317"><span class="linenos">2317</span></a>                    <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination-2318"><a href="#CenterDetermination-2318"><span class="linenos">2318</span></a>                    <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination-2319"><a href="#CenterDetermination-2319"><span class="linenos">2319</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the position of the center using keys.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2320"><a href="#CenterDetermination-2320"><span class="linenos">2320</span></a>        
</span><span id="CenterDetermination-2321"><a href="#CenterDetermination-2321"><span class="linenos">2321</span></a>                    <span class="c1"># Display the image</span>
</span><span id="CenterDetermination-2322"><a href="#CenterDetermination-2322"><span class="linenos">2322</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-2323"><a href="#CenterDetermination-2323"><span class="linenos">2323</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2324"><a href="#CenterDetermination-2324"><span class="linenos">2324</span></a>
</span><span id="CenterDetermination-2325"><a href="#CenterDetermination-2325"><span class="linenos">2325</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-2326"><a href="#CenterDetermination-2326"><span class="linenos">2326</span></a>
</span><span id="CenterDetermination-2327"><a href="#CenterDetermination-2327"><span class="linenos">2327</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination-2328"><a href="#CenterDetermination-2328"><span class="linenos">2328</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution manually interrupted by user.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2329"><a href="#CenterDetermination-2329"><span class="linenos">2329</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination-2330"><a href="#CenterDetermination-2330"><span class="linenos">2330</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="CenterDetermination-2331"><a href="#CenterDetermination-2331"><span class="linenos">2331</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ValueError:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="CenterDetermination-2332"><a href="#CenterDetermination-2332"><span class="linenos">2332</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination-2333"><a href="#CenterDetermination-2333"><span class="linenos">2333</span></a>           
</span><span id="CenterDetermination-2334"><a href="#CenterDetermination-2334"><span class="linenos">2334</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination-2335"><a href="#CenterDetermination-2335"><span class="linenos">2335</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination-2336"><a href="#CenterDetermination-2336"><span class="linenos">2336</span></a>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points selected. Returned None values.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2337"><a href="#CenterDetermination-2337"><span class="linenos">2337</span></a>             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterDetermination-2338"><a href="#CenterDetermination-2338"><span class="linenos">2338</span></a>             <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2339"><a href="#CenterDetermination-2339"><span class="linenos">2339</span></a>        
</span><span id="CenterDetermination-2340"><a href="#CenterDetermination-2340"><span class="linenos">2340</span></a>        <span class="c1"># Disconnect key press events</span>
</span><span id="CenterDetermination-2341"><a href="#CenterDetermination-2341"><span class="linenos">2341</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">cid0</span><span class="p">)</span> 
</span><span id="CenterDetermination-2342"><a href="#CenterDetermination-2342"><span class="linenos">2342</span></a>        
</span><span id="CenterDetermination-2343"><a href="#CenterDetermination-2343"><span class="linenos">2343</span></a>        <span class="c1"># local variables save</span>
</span><span id="CenterDetermination-2344"><a href="#CenterDetermination-2344"><span class="linenos">2344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
</span><span id="CenterDetermination-2345"><a href="#CenterDetermination-2345"><span class="linenos">2345</span></a>        
</span><span id="CenterDetermination-2346"><a href="#CenterDetermination-2346"><span class="linenos">2346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]</span>
</span><span id="CenterDetermination-2347"><a href="#CenterDetermination-2347"><span class="linenos">2347</span></a>        <span class="c1"># Manually adjust the calculated center coordinates</span>
</span><span id="CenterDetermination-2348"><a href="#CenterDetermination-2348"><span class="linenos">2348</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjustment_3points</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
</span><span id="CenterDetermination-2349"><a href="#CenterDetermination-2349"><span class="linenos">2349</span></a>
</span><span id="CenterDetermination-2350"><a href="#CenterDetermination-2350"><span class="linenos">2350</span></a>        <span class="c1"># Return the results:</span>
</span><span id="CenterDetermination-2351"><a href="#CenterDetermination-2351"><span class="linenos">2351</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="CenterDetermination-2352"><a href="#CenterDetermination-2352"><span class="linenos">2352</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination-2353"><a href="#CenterDetermination-2353"><span class="linenos">2353</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="CenterDetermination-2354"><a href="#CenterDetermination-2354"><span class="linenos">2354</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-2355"><a href="#CenterDetermination-2355"><span class="linenos">2355</span></a>    
</span><span id="CenterDetermination-2356"><a href="#CenterDetermination-2356"><span class="linenos">2356</span></a>    
</span><span id="CenterDetermination-2357"><a href="#CenterDetermination-2357"><span class="linenos">2357</span></a>    <span class="k">def</span> <span class="nf">adjustment_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="CenterDetermination-2358"><a href="#CenterDetermination-2358"><span class="linenos">2358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2359"><a href="#CenterDetermination-2359"><span class="linenos">2359</span></a><span class="sd">        Manual/interactive refinement of the diffraction pattern center</span>
</span><span id="CenterDetermination-2360"><a href="#CenterDetermination-2360"><span class="linenos">2360</span></a><span class="sd">        after initial detection via 3 points.</span>
</span><span id="CenterDetermination-2361"><a href="#CenterDetermination-2361"><span class="linenos">2361</span></a>
</span><span id="CenterDetermination-2362"><a href="#CenterDetermination-2362"><span class="linenos">2362</span></a><span class="sd">        User Controls (during point selection)</span>
</span><span id="CenterDetermination-2363"><a href="#CenterDetermination-2363"><span class="linenos">2363</span></a><span class="sd">        --------------------------------------</span>
</span><span id="CenterDetermination-2364"><a href="#CenterDetermination-2364"><span class="linenos">2364</span></a><span class="sd">        This method allows the user to fine-tune the estimated</span>
</span><span id="CenterDetermination-2365"><a href="#CenterDetermination-2365"><span class="linenos">2365</span></a><span class="sd">        center and radius of a diffraction ring,</span>
</span><span id="CenterDetermination-2366"><a href="#CenterDetermination-2366"><span class="linenos">2366</span></a><span class="sd">        (which was determined manually by selecting 3 points)</span>
</span><span id="CenterDetermination-2367"><a href="#CenterDetermination-2367"><span class="linenos">2367</span></a><span class="sd">        by means of the following interactive keyboard controls:</span>
</span><span id="CenterDetermination-2368"><a href="#CenterDetermination-2368"><span class="linenos">2368</span></a>
</span><span id="CenterDetermination-2369"><a href="#CenterDetermination-2369"><span class="linenos">2369</span></a><span class="sd">        - Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</span>
</span><span id="CenterDetermination-2370"><a href="#CenterDetermination-2370"><span class="linenos">2370</span></a><span class="sd">        - **&#39;+&#39;** : Increase the radius</span>
</span><span id="CenterDetermination-2371"><a href="#CenterDetermination-2371"><span class="linenos">2371</span></a><span class="sd">        - **&#39;-&#39;** : Decrease the radius</span>
</span><span id="CenterDetermination-2372"><a href="#CenterDetermination-2372"><span class="linenos">2372</span></a><span class="sd">        - **&#39;b&#39;** : Increase step size (×5)</span>
</span><span id="CenterDetermination-2373"><a href="#CenterDetermination-2373"><span class="linenos">2373</span></a><span class="sd">        - **&#39;l&#39;** : Decrease step size (/5, with minimum step size 0.5)</span>
</span><span id="CenterDetermination-2374"><a href="#CenterDetermination-2374"><span class="linenos">2374</span></a><span class="sd">        - **&#39;d&#39;**: Done — finalize the center and radius</span>
</span><span id="CenterDetermination-2375"><a href="#CenterDetermination-2375"><span class="linenos">2375</span></a><span class="sd">        - Closing the figure: Cancels refinement and returns the original input </span>
</span><span id="CenterDetermination-2376"><a href="#CenterDetermination-2376"><span class="linenos">2376</span></a><span class="sd">          center and radius</span>
</span><span id="CenterDetermination-2377"><a href="#CenterDetermination-2377"><span class="linenos">2377</span></a>
</span><span id="CenterDetermination-2378"><a href="#CenterDetermination-2378"><span class="linenos">2378</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-2379"><a href="#CenterDetermination-2379"><span class="linenos">2379</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-2380"><a href="#CenterDetermination-2380"><span class="linenos">2380</span></a><span class="sd">        fig : matplotlib.figure.Figure</span>
</span><span id="CenterDetermination-2381"><a href="#CenterDetermination-2381"><span class="linenos">2381</span></a><span class="sd">            The figure window used for interactive refinement.</span>
</span><span id="CenterDetermination-2382"><a href="#CenterDetermination-2382"><span class="linenos">2382</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2383"><a href="#CenterDetermination-2383"><span class="linenos">2383</span></a><span class="sd">        circle : matplotlib.patches.Circle</span>
</span><span id="CenterDetermination-2384"><a href="#CenterDetermination-2384"><span class="linenos">2384</span></a><span class="sd">            The circle object initially defined from 3 selected points.</span>
</span><span id="CenterDetermination-2385"><a href="#CenterDetermination-2385"><span class="linenos">2385</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2386"><a href="#CenterDetermination-2386"><span class="linenos">2386</span></a><span class="sd">        center : tuple</span>
</span><span id="CenterDetermination-2387"><a href="#CenterDetermination-2387"><span class="linenos">2387</span></a><span class="sd">            The initial (x, y) center coordinates estimated from the selected </span>
</span><span id="CenterDetermination-2388"><a href="#CenterDetermination-2388"><span class="linenos">2388</span></a><span class="sd">            points.</span>
</span><span id="CenterDetermination-2389"><a href="#CenterDetermination-2389"><span class="linenos">2389</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2390"><a href="#CenterDetermination-2390"><span class="linenos">2390</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="CenterDetermination-2391"><a href="#CenterDetermination-2391"><span class="linenos">2391</span></a><span class="sd">            If True, the results of the adjustment are visualized.</span>
</span><span id="CenterDetermination-2392"><a href="#CenterDetermination-2392"><span class="linenos">2392</span></a>
</span><span id="CenterDetermination-2393"><a href="#CenterDetermination-2393"><span class="linenos">2393</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-2394"><a href="#CenterDetermination-2394"><span class="linenos">2394</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-2395"><a href="#CenterDetermination-2395"><span class="linenos">2395</span></a><span class="sd">        xy[0] : float</span>
</span><span id="CenterDetermination-2396"><a href="#CenterDetermination-2396"><span class="linenos">2396</span></a><span class="sd">            x-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterDetermination-2397"><a href="#CenterDetermination-2397"><span class="linenos">2397</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2398"><a href="#CenterDetermination-2398"><span class="linenos">2398</span></a><span class="sd">        xy[1] : float</span>
</span><span id="CenterDetermination-2399"><a href="#CenterDetermination-2399"><span class="linenos">2399</span></a><span class="sd">            y-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterDetermination-2400"><a href="#CenterDetermination-2400"><span class="linenos">2400</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2401"><a href="#CenterDetermination-2401"><span class="linenos">2401</span></a><span class="sd">        r : float</span>
</span><span id="CenterDetermination-2402"><a href="#CenterDetermination-2402"><span class="linenos">2402</span></a><span class="sd">            Adjusted radius of the diffraction ring.</span>
</span><span id="CenterDetermination-2403"><a href="#CenterDetermination-2403"><span class="linenos">2403</span></a>
</span><span id="CenterDetermination-2404"><a href="#CenterDetermination-2404"><span class="linenos">2404</span></a><span class="sd">        Notes</span>
</span><span id="CenterDetermination-2405"><a href="#CenterDetermination-2405"><span class="linenos">2405</span></a><span class="sd">        -----</span>
</span><span id="CenterDetermination-2406"><a href="#CenterDetermination-2406"><span class="linenos">2406</span></a><span class="sd">        - Interactive adjustments are visualized in real time.</span>
</span><span id="CenterDetermination-2407"><a href="#CenterDetermination-2407"><span class="linenos">2407</span></a><span class="sd">        - Intensity sum at the current center/radius is printed if print_sums</span>
</span><span id="CenterDetermination-2408"><a href="#CenterDetermination-2408"><span class="linenos">2408</span></a><span class="sd">          is True.</span>
</span><span id="CenterDetermination-2409"><a href="#CenterDetermination-2409"><span class="linenos">2409</span></a><span class="sd">        - Arrow key defaults in Matplotlib (e.g., navigation) are temporarily </span>
</span><span id="CenterDetermination-2410"><a href="#CenterDetermination-2410"><span class="linenos">2410</span></a><span class="sd">          disabled to allow movement control.</span>
</span><span id="CenterDetermination-2411"><a href="#CenterDetermination-2411"><span class="linenos">2411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2412"><a href="#CenterDetermination-2412"><span class="linenos">2412</span></a>                    
</span><span id="CenterDetermination-2413"><a href="#CenterDetermination-2413"><span class="linenos">2413</span></a>        <span class="c1"># Remove default left / right arrow key press events</span>
</span><span id="CenterDetermination-2414"><a href="#CenterDetermination-2414"><span class="linenos">2414</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2415"><a href="#CenterDetermination-2415"><span class="linenos">2415</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2416"><a href="#CenterDetermination-2416"><span class="linenos">2416</span></a>        
</span><span id="CenterDetermination-2417"><a href="#CenterDetermination-2417"><span class="linenos">2417</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterDetermination-2418"><a href="#CenterDetermination-2418"><span class="linenos">2418</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination-2419"><a href="#CenterDetermination-2419"><span class="linenos">2419</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2420"><a href="#CenterDetermination-2420"><span class="linenos">2420</span></a><span class="sd">            CenterDetermination :: ThreePoints (interactive adjustment)</span>
</span><span id="CenterDetermination-2421"><a href="#CenterDetermination-2421"><span class="linenos">2421</span></a><span class="sd">            Use these keys:</span>
</span><span id="CenterDetermination-2422"><a href="#CenterDetermination-2422"><span class="linenos">2422</span></a><span class="sd">              - &#39;←&#39; : move left</span>
</span><span id="CenterDetermination-2423"><a href="#CenterDetermination-2423"><span class="linenos">2423</span></a><span class="sd">              - &#39;→&#39; : move right</span>
</span><span id="CenterDetermination-2424"><a href="#CenterDetermination-2424"><span class="linenos">2424</span></a><span class="sd">              - &#39;↑&#39; : move up</span>
</span><span id="CenterDetermination-2425"><a href="#CenterDetermination-2425"><span class="linenos">2425</span></a><span class="sd">              - &#39;↓&#39; : move down</span>
</span><span id="CenterDetermination-2426"><a href="#CenterDetermination-2426"><span class="linenos">2426</span></a><span class="sd">              - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterDetermination-2427"><a href="#CenterDetermination-2427"><span class="linenos">2427</span></a><span class="sd">              - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterDetermination-2428"><a href="#CenterDetermination-2428"><span class="linenos">2428</span></a><span class="sd">              - &#39;b&#39; : increase step size</span>
</span><span id="CenterDetermination-2429"><a href="#CenterDetermination-2429"><span class="linenos">2429</span></a><span class="sd">              - &#39;l&#39; : decrease step size</span>
</span><span id="CenterDetermination-2430"><a href="#CenterDetermination-2430"><span class="linenos">2430</span></a><span class="sd">              - &#39;d&#39; : refinement done</span>
</span><span id="CenterDetermination-2431"><a href="#CenterDetermination-2431"><span class="linenos">2431</span></a><span class="sd">                  </span>
</span><span id="CenterDetermination-2432"><a href="#CenterDetermination-2432"><span class="linenos">2432</span></a><span class="sd">            DISCLAIMER: For the purpose of the center position adjustment, </span>
</span><span id="CenterDetermination-2433"><a href="#CenterDetermination-2433"><span class="linenos">2433</span></a><span class="sd">                        the default shortcuts for arrows were removed.</span>
</span><span id="CenterDetermination-2434"><a href="#CenterDetermination-2434"><span class="linenos">2434</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2435"><a href="#CenterDetermination-2435"><span class="linenos">2435</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination-2436"><a href="#CenterDetermination-2436"><span class="linenos">2436</span></a>        
</span><span id="CenterDetermination-2437"><a href="#CenterDetermination-2437"><span class="linenos">2437</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination-2438"><a href="#CenterDetermination-2438"><span class="linenos">2438</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2439"><a href="#CenterDetermination-2439"><span class="linenos">2439</span></a>            
</span><span id="CenterDetermination-2440"><a href="#CenterDetermination-2440"><span class="linenos">2440</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="CenterDetermination-2441"><a href="#CenterDetermination-2441"><span class="linenos">2441</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination-2442"><a href="#CenterDetermination-2442"><span class="linenos">2442</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination-2443"><a href="#CenterDetermination-2443"><span class="linenos">2443</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-2444"><a href="#CenterDetermination-2444"><span class="linenos">2444</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterDetermination-2445"><a href="#CenterDetermination-2445"><span class="linenos">2445</span></a>        
</span><span id="CenterDetermination-2446"><a href="#CenterDetermination-2446"><span class="linenos">2446</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-2447"><a href="#CenterDetermination-2447"><span class="linenos">2447</span></a>
</span><span id="CenterDetermination-2448"><a href="#CenterDetermination-2448"><span class="linenos">2448</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination-2449"><a href="#CenterDetermination-2449"><span class="linenos">2449</span></a>          
</span><span id="CenterDetermination-2450"><a href="#CenterDetermination-2450"><span class="linenos">2450</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterDetermination-2451"><a href="#CenterDetermination-2451"><span class="linenos">2451</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-2452"><a href="#CenterDetermination-2452"><span class="linenos">2452</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-2453"><a href="#CenterDetermination-2453"><span class="linenos">2453</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-2454"><a href="#CenterDetermination-2454"><span class="linenos">2454</span></a>
</span><span id="CenterDetermination-2455"><a href="#CenterDetermination-2455"><span class="linenos">2455</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination-2456"><a href="#CenterDetermination-2456"><span class="linenos">2456</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination-2457"><a href="#CenterDetermination-2457"><span class="linenos">2457</span></a>        
</span><span id="CenterDetermination-2458"><a href="#CenterDetermination-2458"><span class="linenos">2458</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="CenterDetermination-2459"><a href="#CenterDetermination-2459"><span class="linenos">2459</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-2460"><a href="#CenterDetermination-2460"><span class="linenos">2460</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterDetermination-2461"><a href="#CenterDetermination-2461"><span class="linenos">2461</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-2462"><a href="#CenterDetermination-2462"><span class="linenos">2462</span></a>        
</span><span id="CenterDetermination-2463"><a href="#CenterDetermination-2463"><span class="linenos">2463</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterDetermination-2464"><a href="#CenterDetermination-2464"><span class="linenos">2464</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterDetermination-2465"><a href="#CenterDetermination-2465"><span class="linenos">2465</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterDetermination-2466"><a href="#CenterDetermination-2466"><span class="linenos">2466</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterDetermination-2467"><a href="#CenterDetermination-2467"><span class="linenos">2467</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterDetermination-2468"><a href="#CenterDetermination-2468"><span class="linenos">2468</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterDetermination-2469"><a href="#CenterDetermination-2469"><span class="linenos">2469</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterDetermination-2470"><a href="#CenterDetermination-2470"><span class="linenos">2470</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterDetermination-2471"><a href="#CenterDetermination-2471"><span class="linenos">2471</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterDetermination-2472"><a href="#CenterDetermination-2472"><span class="linenos">2472</span></a>        
</span><span id="CenterDetermination-2473"><a href="#CenterDetermination-2473"><span class="linenos">2473</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterDetermination-2474"><a href="#CenterDetermination-2474"><span class="linenos">2474</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterDetermination-2475"><a href="#CenterDetermination-2475"><span class="linenos">2475</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterDetermination-2476"><a href="#CenterDetermination-2476"><span class="linenos">2476</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2477"><a href="#CenterDetermination-2477"><span class="linenos">2477</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterDetermination-2478"><a href="#CenterDetermination-2478"><span class="linenos">2478</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2479"><a href="#CenterDetermination-2479"><span class="linenos">2479</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-2480"><a href="#CenterDetermination-2480"><span class="linenos">2480</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2481"><a href="#CenterDetermination-2481"><span class="linenos">2481</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-2482"><a href="#CenterDetermination-2482"><span class="linenos">2482</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2483"><a href="#CenterDetermination-2483"><span class="linenos">2483</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-2484"><a href="#CenterDetermination-2484"><span class="linenos">2484</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2485"><a href="#CenterDetermination-2485"><span class="linenos">2485</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-2486"><a href="#CenterDetermination-2486"><span class="linenos">2486</span></a>                    
</span><span id="CenterDetermination-2487"><a href="#CenterDetermination-2487"><span class="linenos">2487</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterDetermination-2488"><a href="#CenterDetermination-2488"><span class="linenos">2488</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination-2489"><a href="#CenterDetermination-2489"><span class="linenos">2489</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-2490"><a href="#CenterDetermination-2490"><span class="linenos">2490</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-2491"><a href="#CenterDetermination-2491"><span class="linenos">2491</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2492"><a href="#CenterDetermination-2492"><span class="linenos">2492</span></a>            
</span><span id="CenterDetermination-2493"><a href="#CenterDetermination-2493"><span class="linenos">2493</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterDetermination-2494"><a href="#CenterDetermination-2494"><span class="linenos">2494</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2495"><a href="#CenterDetermination-2495"><span class="linenos">2495</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-2496"><a href="#CenterDetermination-2496"><span class="linenos">2496</span></a>        
</span><span id="CenterDetermination-2497"><a href="#CenterDetermination-2497"><span class="linenos">2497</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterDetermination-2498"><a href="#CenterDetermination-2498"><span class="linenos">2498</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2499"><a href="#CenterDetermination-2499"><span class="linenos">2499</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterDetermination-2500"><a href="#CenterDetermination-2500"><span class="linenos">2500</span></a>        
</span><span id="CenterDetermination-2501"><a href="#CenterDetermination-2501"><span class="linenos">2501</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-2502"><a href="#CenterDetermination-2502"><span class="linenos">2502</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterDetermination-2503"><a href="#CenterDetermination-2503"><span class="linenos">2503</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterDetermination-2504"><a href="#CenterDetermination-2504"><span class="linenos">2504</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterDetermination-2505"><a href="#CenterDetermination-2505"><span class="linenos">2505</span></a>        
</span><span id="CenterDetermination-2506"><a href="#CenterDetermination-2506"><span class="linenos">2506</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterDetermination-2507"><a href="#CenterDetermination-2507"><span class="linenos">2507</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterDetermination-2508"><a href="#CenterDetermination-2508"><span class="linenos">2508</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterDetermination-2509"><a href="#CenterDetermination-2509"><span class="linenos">2509</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterDetermination-2510"><a href="#CenterDetermination-2510"><span class="linenos">2510</span></a>        
</span><span id="CenterDetermination-2511"><a href="#CenterDetermination-2511"><span class="linenos">2511</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-2512"><a href="#CenterDetermination-2512"><span class="linenos">2512</span></a>        
</span><span id="CenterDetermination-2513"><a href="#CenterDetermination-2513"><span class="linenos">2513</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterDetermination-2514"><a href="#CenterDetermination-2514"><span class="linenos">2514</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-2515"><a href="#CenterDetermination-2515"><span class="linenos">2515</span></a>
</span><span id="CenterDetermination-2516"><a href="#CenterDetermination-2516"><span class="linenos">2516</span></a>                
</span><span id="CenterDetermination-2517"><a href="#CenterDetermination-2517"><span class="linenos">2517</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterDetermination-2518"><a href="#CenterDetermination-2518"><span class="linenos">2518</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterDetermination-2519"><a href="#CenterDetermination-2519"><span class="linenos">2519</span></a>        
</span><span id="CenterDetermination-2520"><a href="#CenterDetermination-2520"><span class="linenos">2520</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination-2521"><a href="#CenterDetermination-2521"><span class="linenos">2521</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterDetermination-2522"><a href="#CenterDetermination-2522"><span class="linenos">2522</span></a>
</span><span id="CenterDetermination-2523"><a href="#CenterDetermination-2523"><span class="linenos">2523</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterDetermination-2524"><a href="#CenterDetermination-2524"><span class="linenos">2524</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterDetermination-2525"><a href="#CenterDetermination-2525"><span class="linenos">2525</span></a>               
</span><span id="CenterDetermination-2526"><a href="#CenterDetermination-2526"><span class="linenos">2526</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterDetermination-2527"><a href="#CenterDetermination-2527"><span class="linenos">2527</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination-2528"><a href="#CenterDetermination-2528"><span class="linenos">2528</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination-2529"><a href="#CenterDetermination-2529"><span class="linenos">2529</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination-2530"><a href="#CenterDetermination-2530"><span class="linenos">2530</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination-2531"><a href="#CenterDetermination-2531"><span class="linenos">2531</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterDetermination-2532"><a href="#CenterDetermination-2532"><span class="linenos">2532</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-2533"><a href="#CenterDetermination-2533"><span class="linenos">2533</span></a>                
</span><span id="CenterDetermination-2534"><a href="#CenterDetermination-2534"><span class="linenos">2534</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination-2535"><a href="#CenterDetermination-2535"><span class="linenos">2535</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination-2536"><a href="#CenterDetermination-2536"><span class="linenos">2536</span></a>        
</span><span id="CenterDetermination-2537"><a href="#CenterDetermination-2537"><span class="linenos">2537</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterDetermination-2538"><a href="#CenterDetermination-2538"><span class="linenos">2538</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-2539"><a href="#CenterDetermination-2539"><span class="linenos">2539</span></a>
</span><span id="CenterDetermination-2540"><a href="#CenterDetermination-2540"><span class="linenos">2540</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-2541"><a href="#CenterDetermination-2541"><span class="linenos">2541</span></a>        
</span><span id="CenterDetermination-2542"><a href="#CenterDetermination-2542"><span class="linenos">2542</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination-2543"><a href="#CenterDetermination-2543"><span class="linenos">2543</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination-2544"><a href="#CenterDetermination-2544"><span class="linenos">2544</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterDetermination-2545"><a href="#CenterDetermination-2545"><span class="linenos">2545</span></a>
</span><span id="CenterDetermination-2546"><a href="#CenterDetermination-2546"><span class="linenos">2546</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination-2547"><a href="#CenterDetermination-2547"><span class="linenos">2547</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination-2548"><a href="#CenterDetermination-2548"><span class="linenos">2548</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (ThreePoints)    : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-2549"><a href="#CenterDetermination-2549"><span class="linenos">2549</span></a>        
</span><span id="CenterDetermination-2550"><a href="#CenterDetermination-2550"><span class="linenos">2550</span></a>    
</span><span id="CenterDetermination-2551"><a href="#CenterDetermination-2551"><span class="linenos">2551</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>
</span><span id="CenterDetermination-2552"><a href="#CenterDetermination-2552"><span class="linenos">2552</span></a>        
</span><span id="CenterDetermination-2553"><a href="#CenterDetermination-2553"><span class="linenos">2553</span></a>
</span><span id="CenterDetermination-2554"><a href="#CenterDetermination-2554"><span class="linenos">2554</span></a>    <span class="k">def</span> <span class="nf">calculate_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span>
</span><span id="CenterDetermination-2555"><a href="#CenterDetermination-2555"><span class="linenos">2555</span></a>            <span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">]:</span>
</span><span id="CenterDetermination-2556"><a href="#CenterDetermination-2556"><span class="linenos">2556</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2557"><a href="#CenterDetermination-2557"><span class="linenos">2557</span></a><span class="sd">        Calculate the center and radius of a circle defined by 3 manually </span>
</span><span id="CenterDetermination-2558"><a href="#CenterDetermination-2558"><span class="linenos">2558</span></a><span class="sd">        selected points.</span>
</span><span id="CenterDetermination-2559"><a href="#CenterDetermination-2559"><span class="linenos">2559</span></a>
</span><span id="CenterDetermination-2560"><a href="#CenterDetermination-2560"><span class="linenos">2560</span></a><span class="sd">        Given three user-defined points (typically on a diffraction ring), this </span>
</span><span id="CenterDetermination-2561"><a href="#CenterDetermination-2561"><span class="linenos">2561</span></a><span class="sd">        method computes the center and radius of the circle that passes through </span>
</span><span id="CenterDetermination-2562"><a href="#CenterDetermination-2562"><span class="linenos">2562</span></a><span class="sd">        them. Optionally, it visualizes the result including the circle, center, </span>
</span><span id="CenterDetermination-2563"><a href="#CenterDetermination-2563"><span class="linenos">2563</span></a><span class="sd">        and selected points overlaid on the image.</span>
</span><span id="CenterDetermination-2564"><a href="#CenterDetermination-2564"><span class="linenos">2564</span></a>
</span><span id="CenterDetermination-2565"><a href="#CenterDetermination-2565"><span class="linenos">2565</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-2566"><a href="#CenterDetermination-2566"><span class="linenos">2566</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-2567"><a href="#CenterDetermination-2567"><span class="linenos">2567</span></a><span class="sd">        plot_results : int (binary: 0 or 1)</span>
</span><span id="CenterDetermination-2568"><a href="#CenterDetermination-2568"><span class="linenos">2568</span></a><span class="sd">            If 1, displays the image with the fitted circle and center.</span>
</span><span id="CenterDetermination-2569"><a href="#CenterDetermination-2569"><span class="linenos">2569</span></a><span class="sd">            If 0, skips visualization.</span>
</span><span id="CenterDetermination-2570"><a href="#CenterDetermination-2570"><span class="linenos">2570</span></a>
</span><span id="CenterDetermination-2571"><a href="#CenterDetermination-2571"><span class="linenos">2571</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-2572"><a href="#CenterDetermination-2572"><span class="linenos">2572</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-2573"><a href="#CenterDetermination-2573"><span class="linenos">2573</span></a><span class="sd">        self.x : float</span>
</span><span id="CenterDetermination-2574"><a href="#CenterDetermination-2574"><span class="linenos">2574</span></a><span class="sd">            x-coordinate of the detected circle center.</span>
</span><span id="CenterDetermination-2575"><a href="#CenterDetermination-2575"><span class="linenos">2575</span></a>
</span><span id="CenterDetermination-2576"><a href="#CenterDetermination-2576"><span class="linenos">2576</span></a><span class="sd">        self.y : float</span>
</span><span id="CenterDetermination-2577"><a href="#CenterDetermination-2577"><span class="linenos">2577</span></a><span class="sd">            y-coordinate of the detected circle center.</span>
</span><span id="CenterDetermination-2578"><a href="#CenterDetermination-2578"><span class="linenos">2578</span></a>
</span><span id="CenterDetermination-2579"><a href="#CenterDetermination-2579"><span class="linenos">2579</span></a><span class="sd">        self.r : float</span>
</span><span id="CenterDetermination-2580"><a href="#CenterDetermination-2580"><span class="linenos">2580</span></a><span class="sd">            Radius of the detected circle.</span>
</span><span id="CenterDetermination-2581"><a href="#CenterDetermination-2581"><span class="linenos">2581</span></a>
</span><span id="CenterDetermination-2582"><a href="#CenterDetermination-2582"><span class="linenos">2582</span></a><span class="sd">        self.center : tuple[float, float]</span>
</span><span id="CenterDetermination-2583"><a href="#CenterDetermination-2583"><span class="linenos">2583</span></a><span class="sd">            The (x, y) coordinates of the circle center.</span>
</span><span id="CenterDetermination-2584"><a href="#CenterDetermination-2584"><span class="linenos">2584</span></a>
</span><span id="CenterDetermination-2585"><a href="#CenterDetermination-2585"><span class="linenos">2585</span></a><span class="sd">        self.circle : matplotlib.patches.Circle</span>
</span><span id="CenterDetermination-2586"><a href="#CenterDetermination-2586"><span class="linenos">2586</span></a><span class="sd">            A matplotlib Circle object that can be reused for future plotting.</span>
</span><span id="CenterDetermination-2587"><a href="#CenterDetermination-2587"><span class="linenos">2587</span></a>
</span><span id="CenterDetermination-2588"><a href="#CenterDetermination-2588"><span class="linenos">2588</span></a><span class="sd">        Notes</span>
</span><span id="CenterDetermination-2589"><a href="#CenterDetermination-2589"><span class="linenos">2589</span></a><span class="sd">        -----</span>
</span><span id="CenterDetermination-2590"><a href="#CenterDetermination-2590"><span class="linenos">2590</span></a><span class="sd">        - The method uses a geometric approach to calculate the circumcenter</span>
</span><span id="CenterDetermination-2591"><a href="#CenterDetermination-2591"><span class="linenos">2591</span></a><span class="sd">          and circumradius.</span>
</span><span id="CenterDetermination-2592"><a href="#CenterDetermination-2592"><span class="linenos">2592</span></a><span class="sd">        - For best visual results, ensure the selected points are well spaced </span>
</span><span id="CenterDetermination-2593"><a href="#CenterDetermination-2593"><span class="linenos">2593</span></a><span class="sd">          and belong to the same circular ring.</span>
</span><span id="CenterDetermination-2594"><a href="#CenterDetermination-2594"><span class="linenos">2594</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2595"><a href="#CenterDetermination-2595"><span class="linenos">2595</span></a>        <span class="c1"># Extract the coordinates of the points        </span>
</span><span id="CenterDetermination-2596"><a href="#CenterDetermination-2596"><span class="linenos">2596</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination-2597"><a href="#CenterDetermination-2597"><span class="linenos">2597</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination-2598"><a href="#CenterDetermination-2598"><span class="linenos">2598</span></a>        
</span><span id="CenterDetermination-2599"><a href="#CenterDetermination-2599"><span class="linenos">2599</span></a>        <span class="c1"># Compute the radius and center coordinates of the circle</span>
</span><span id="CenterDetermination-2600"><a href="#CenterDetermination-2600"><span class="linenos">2600</span></a>            <span class="c1"># a: the squared length of the side between the second </span>
</span><span id="CenterDetermination-2601"><a href="#CenterDetermination-2601"><span class="linenos">2601</span></a>            <span class="c1">#    and third points (x[1], y[1]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination-2602"><a href="#CenterDetermination-2602"><span class="linenos">2602</span></a>            <span class="c1"># b: the squared length of the side between the first </span>
</span><span id="CenterDetermination-2603"><a href="#CenterDetermination-2603"><span class="linenos">2603</span></a>            <span class="c1">#    and third points (x[0], y[0]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination-2604"><a href="#CenterDetermination-2604"><span class="linenos">2604</span></a>            <span class="c1"># c: the squared length of the side between the first </span>
</span><span id="CenterDetermination-2605"><a href="#CenterDetermination-2605"><span class="linenos">2605</span></a>            <span class="c1">#    and second points (x[0], y[0]) and (x[1], y[1]).</span>
</span><span id="CenterDetermination-2606"><a href="#CenterDetermination-2606"><span class="linenos">2606</span></a>            <span class="c1"># s: the twice the signed area of the triangle formed by 3 points</span>
</span><span id="CenterDetermination-2607"><a href="#CenterDetermination-2607"><span class="linenos">2607</span></a>            
</span><span id="CenterDetermination-2608"><a href="#CenterDetermination-2608"><span class="linenos">2608</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination-2609"><a href="#CenterDetermination-2609"><span class="linenos">2609</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination-2610"><a href="#CenterDetermination-2610"><span class="linenos">2610</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination-2611"><a href="#CenterDetermination-2611"><span class="linenos">2611</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> 
</span><span id="CenterDetermination-2612"><a href="#CenterDetermination-2612"><span class="linenos">2612</span></a>        
</span><span id="CenterDetermination-2613"><a href="#CenterDetermination-2613"><span class="linenos">2613</span></a>        <span class="c1"># coordinates of the center</span>
</span><span id="CenterDetermination-2614"><a href="#CenterDetermination-2614"><span class="linenos">2614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span>
</span><span id="CenterDetermination-2615"><a href="#CenterDetermination-2615"><span class="linenos">2615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span> 
</span><span id="CenterDetermination-2616"><a href="#CenterDetermination-2616"><span class="linenos">2616</span></a>        
</span><span id="CenterDetermination-2617"><a href="#CenterDetermination-2617"><span class="linenos">2617</span></a>        <span class="c1"># radius</span>
</span><span id="CenterDetermination-2618"><a href="#CenterDetermination-2618"><span class="linenos">2618</span></a>        <span class="n">ar</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination-2619"><a href="#CenterDetermination-2619"><span class="linenos">2619</span></a>        <span class="n">br</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination-2620"><a href="#CenterDetermination-2620"><span class="linenos">2620</span></a>        <span class="n">cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="mf">0.5</span> 
</span><span id="CenterDetermination-2621"><a href="#CenterDetermination-2621"><span class="linenos">2621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">ar</span><span class="o">*</span><span class="n">br</span><span class="o">*</span><span class="n">cr</span><span class="o">/</span><span class="p">((</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">-</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">-</span><span class="n">cr</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination-2622"><a href="#CenterDetermination-2622"><span class="linenos">2622</span></a>        
</span><span id="CenterDetermination-2623"><a href="#CenterDetermination-2623"><span class="linenos">2623</span></a>        <span class="c1"># # Print results</span>
</span><span id="CenterDetermination-2624"><a href="#CenterDetermination-2624"><span class="linenos">2624</span></a>        <span class="c1"># if self.parent.verbose:</span>
</span><span id="CenterDetermination-2625"><a href="#CenterDetermination-2625"><span class="linenos">2625</span></a>        <span class="c1">#     print(&quot;CenterEstimator :: manual center detection&quot;)</span>
</span><span id="CenterDetermination-2626"><a href="#CenterDetermination-2626"><span class="linenos">2626</span></a>        <span class="c1">#     print(f&quot;Center coordinates: {self.x:.2f} {self.y:.2f}&quot;)</span>
</span><span id="CenterDetermination-2627"><a href="#CenterDetermination-2627"><span class="linenos">2627</span></a>                    
</span><span id="CenterDetermination-2628"><a href="#CenterDetermination-2628"><span class="linenos">2628</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-2629"><a href="#CenterDetermination-2629"><span class="linenos">2629</span></a>            <span class="c1"># Create and manage the figure</span>
</span><span id="CenterDetermination-2630"><a href="#CenterDetermination-2630"><span class="linenos">2630</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination-2631"><a href="#CenterDetermination-2631"><span class="linenos">2631</span></a>            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
</span><span id="CenterDetermination-2632"><a href="#CenterDetermination-2632"><span class="linenos">2632</span></a>            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
</span><span id="CenterDetermination-2633"><a href="#CenterDetermination-2633"><span class="linenos">2633</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-2634"><a href="#CenterDetermination-2634"><span class="linenos">2634</span></a>                      <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2635"><a href="#CenterDetermination-2635"><span class="linenos">2635</span></a>            
</span><span id="CenterDetermination-2636"><a href="#CenterDetermination-2636"><span class="linenos">2636</span></a>            <span class="c1"># Plot center and points</span>
</span><span id="CenterDetermination-2637"><a href="#CenterDetermination-2637"><span class="linenos">2637</span></a>            <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination-2638"><a href="#CenterDetermination-2638"><span class="linenos">2638</span></a>                     <span class="s1">&#39;rx&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2639"><a href="#CenterDetermination-2639"><span class="linenos">2639</span></a>                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2640"><a href="#CenterDetermination-2640"><span class="linenos">2640</span></a>                     <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination-2641"><a href="#CenterDetermination-2641"><span class="linenos">2641</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination-2642"><a href="#CenterDetermination-2642"><span class="linenos">2642</span></a>                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2643"><a href="#CenterDetermination-2643"><span class="linenos">2643</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2644"><a href="#CenterDetermination-2644"><span class="linenos">2644</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Circle points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2645"><a href="#CenterDetermination-2645"><span class="linenos">2645</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Circle found using 3 manually detected points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2646"><a href="#CenterDetermination-2646"><span class="linenos">2646</span></a>            
</span><span id="CenterDetermination-2647"><a href="#CenterDetermination-2647"><span class="linenos">2647</span></a>            <span class="c1"># Circle visualization</span>
</span><span id="CenterDetermination-2648"><a href="#CenterDetermination-2648"><span class="linenos">2648</span></a>            <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterDetermination-2649"><a href="#CenterDetermination-2649"><span class="linenos">2649</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="CenterDetermination-2650"><a href="#CenterDetermination-2650"><span class="linenos">2650</span></a>                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2651"><a href="#CenterDetermination-2651"><span class="linenos">2651</span></a>                                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="CenterDetermination-2652"><a href="#CenterDetermination-2652"><span class="linenos">2652</span></a>                                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2653"><a href="#CenterDetermination-2653"><span class="linenos">2653</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination-2654"><a href="#CenterDetermination-2654"><span class="linenos">2654</span></a>            
</span><span id="CenterDetermination-2655"><a href="#CenterDetermination-2655"><span class="linenos">2655</span></a>            <span class="c1"># Set the aspect ratio to equal to have a circular shape</span>
</span><span id="CenterDetermination-2656"><a href="#CenterDetermination-2656"><span class="linenos">2656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2657"><a href="#CenterDetermination-2657"><span class="linenos">2657</span></a>            
</span><span id="CenterDetermination-2658"><a href="#CenterDetermination-2658"><span class="linenos">2658</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2659"><a href="#CenterDetermination-2659"><span class="linenos">2659</span></a>                       <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="CenterDetermination-2660"><a href="#CenterDetermination-2660"><span class="linenos">2660</span></a>                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> 
</span><span id="CenterDetermination-2661"><a href="#CenterDetermination-2661"><span class="linenos">2661</span></a>                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2662"><a href="#CenterDetermination-2662"><span class="linenos">2662</span></a>                       <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-2663"><a href="#CenterDetermination-2663"><span class="linenos">2663</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2664"><a href="#CenterDetermination-2664"><span class="linenos">2664</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-2665"><a href="#CenterDetermination-2665"><span class="linenos">2665</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-2666"><a href="#CenterDetermination-2666"><span class="linenos">2666</span></a>
</span><span id="CenterDetermination-2667"><a href="#CenterDetermination-2667"><span class="linenos">2667</span></a>        
</span><span id="CenterDetermination-2668"><a href="#CenterDetermination-2668"><span class="linenos">2668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination-2669"><a href="#CenterDetermination-2669"><span class="linenos">2669</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-2670"><a href="#CenterDetermination-2670"><span class="linenos">2670</span></a>        
</span><span id="CenterDetermination-2671"><a href="#CenterDetermination-2671"><span class="linenos">2671</span></a>
</span><span id="CenterDetermination-2672"><a href="#CenterDetermination-2672"><span class="linenos">2672</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle</span>
</span><span id="CenterDetermination-2673"><a href="#CenterDetermination-2673"><span class="linenos">2673</span></a>
</span><span id="CenterDetermination-2674"><a href="#CenterDetermination-2674"><span class="linenos">2674</span></a>
</span><span id="CenterDetermination-2675"><a href="#CenterDetermination-2675"><span class="linenos">2675</span></a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span>
</span><span id="CenterDetermination-2676"><a href="#CenterDetermination-2676"><span class="linenos">2676</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">rtype</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">disp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterDetermination-2677"><a href="#CenterDetermination-2677"><span class="linenos">2677</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2678"><a href="#CenterDetermination-2678"><span class="linenos">2678</span></a><span class="sd">        Calculate the radius of a circle based on intensity profiles along </span>
</span><span id="CenterDetermination-2679"><a href="#CenterDetermination-2679"><span class="linenos">2679</span></a><span class="sd">        horizontal and vertical axes.</span>
</span><span id="CenterDetermination-2680"><a href="#CenterDetermination-2680"><span class="linenos">2680</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-2681"><a href="#CenterDetermination-2681"><span class="linenos">2681</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-2682"><a href="#CenterDetermination-2682"><span class="linenos">2682</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-2683"><a href="#CenterDetermination-2683"><span class="linenos">2683</span></a><span class="sd">        rtype : integer</span>
</span><span id="CenterDetermination-2684"><a href="#CenterDetermination-2684"><span class="linenos">2684</span></a><span class="sd">            Method for radius calculation. Default is 0.</span>
</span><span id="CenterDetermination-2685"><a href="#CenterDetermination-2685"><span class="linenos">2685</span></a><span class="sd">            - rtype=0 : peaks matching method</span>
</span><span id="CenterDetermination-2686"><a href="#CenterDetermination-2686"><span class="linenos">2686</span></a><span class="sd">            - rtype=1 : radial distribution method</span>
</span><span id="CenterDetermination-2687"><a href="#CenterDetermination-2687"><span class="linenos">2687</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2688"><a href="#CenterDetermination-2688"><span class="linenos">2688</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="CenterDetermination-2689"><a href="#CenterDetermination-2689"><span class="linenos">2689</span></a><span class="sd">            The 2D image array containing the circle. </span>
</span><span id="CenterDetermination-2690"><a href="#CenterDetermination-2690"><span class="linenos">2690</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2691"><a href="#CenterDetermination-2691"><span class="linenos">2691</span></a><span class="sd">        x : float</span>
</span><span id="CenterDetermination-2692"><a href="#CenterDetermination-2692"><span class="linenos">2692</span></a><span class="sd">            The x-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination-2693"><a href="#CenterDetermination-2693"><span class="linenos">2693</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2694"><a href="#CenterDetermination-2694"><span class="linenos">2694</span></a><span class="sd">        y : float</span>
</span><span id="CenterDetermination-2695"><a href="#CenterDetermination-2695"><span class="linenos">2695</span></a><span class="sd">            The y-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination-2696"><a href="#CenterDetermination-2696"><span class="linenos">2696</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-2697"><a href="#CenterDetermination-2697"><span class="linenos">2697</span></a><span class="sd">        disp : bool, optional</span>
</span><span id="CenterDetermination-2698"><a href="#CenterDetermination-2698"><span class="linenos">2698</span></a><span class="sd">            If True, visualizes the detected intensity profiles and peaks </span>
</span><span id="CenterDetermination-2699"><a href="#CenterDetermination-2699"><span class="linenos">2699</span></a><span class="sd">            (default is False).</span>
</span><span id="CenterDetermination-2700"><a href="#CenterDetermination-2700"><span class="linenos">2700</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-2701"><a href="#CenterDetermination-2701"><span class="linenos">2701</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-2702"><a href="#CenterDetermination-2702"><span class="linenos">2702</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-2703"><a href="#CenterDetermination-2703"><span class="linenos">2703</span></a><span class="sd">        float</span>
</span><span id="CenterDetermination-2704"><a href="#CenterDetermination-2704"><span class="linenos">2704</span></a><span class="sd">            The estimated radius of the circle. Defaults to 100 if no valid </span>
</span><span id="CenterDetermination-2705"><a href="#CenterDetermination-2705"><span class="linenos">2705</span></a><span class="sd">            radius is detected.</span>
</span><span id="CenterDetermination-2706"><a href="#CenterDetermination-2706"><span class="linenos">2706</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2707"><a href="#CenterDetermination-2707"><span class="linenos">2707</span></a>        <span class="c1"># Helper function -----------------------------------------------------</span>
</span><span id="CenterDetermination-2708"><a href="#CenterDetermination-2708"><span class="linenos">2708</span></a>        <span class="k">def</span> <span class="nf">match_peaks</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span><span id="CenterDetermination-2709"><a href="#CenterDetermination-2709"><span class="linenos">2709</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2710"><a href="#CenterDetermination-2710"><span class="linenos">2710</span></a><span class="sd">            Find the most similar values across the left and right halves of </span>
</span><span id="CenterDetermination-2711"><a href="#CenterDetermination-2711"><span class="linenos">2711</span></a><span class="sd">            an array, excluding the global maximum.</span>
</span><span id="CenterDetermination-2712"><a href="#CenterDetermination-2712"><span class="linenos">2712</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2713"><a href="#CenterDetermination-2713"><span class="linenos">2713</span></a><span class="sd">            This function is typically used for analyzing symmetric patterns </span>
</span><span id="CenterDetermination-2714"><a href="#CenterDetermination-2714"><span class="linenos">2714</span></a><span class="sd">            such as diffraction profiles or intensity histograms. It identifies </span>
</span><span id="CenterDetermination-2715"><a href="#CenterDetermination-2715"><span class="linenos">2715</span></a><span class="sd">            the most similar pair of peaks on either side of the central maximum, </span>
</span><span id="CenterDetermination-2716"><a href="#CenterDetermination-2716"><span class="linenos">2716</span></a><span class="sd">            which is excluded from the comparison.</span>
</span><span id="CenterDetermination-2717"><a href="#CenterDetermination-2717"><span class="linenos">2717</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2718"><a href="#CenterDetermination-2718"><span class="linenos">2718</span></a><span class="sd">            Special case:</span>
</span><span id="CenterDetermination-2719"><a href="#CenterDetermination-2719"><span class="linenos">2719</span></a><span class="sd">            - If the array contains exactly two elements, it assumes they form </span>
</span><span id="CenterDetermination-2720"><a href="#CenterDetermination-2720"><span class="linenos">2720</span></a><span class="sd">              the best pair and returns their indices directly.</span>
</span><span id="CenterDetermination-2721"><a href="#CenterDetermination-2721"><span class="linenos">2721</span></a><span class="sd">            - If one half is empty after removing the central peak,</span>
</span><span id="CenterDetermination-2722"><a href="#CenterDetermination-2722"><span class="linenos">2722</span></a><span class="sd">              it returns (None, None).</span>
</span><span id="CenterDetermination-2723"><a href="#CenterDetermination-2723"><span class="linenos">2723</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2724"><a href="#CenterDetermination-2724"><span class="linenos">2724</span></a><span class="sd">            Parameters</span>
</span><span id="CenterDetermination-2725"><a href="#CenterDetermination-2725"><span class="linenos">2725</span></a><span class="sd">            ----------</span>
</span><span id="CenterDetermination-2726"><a href="#CenterDetermination-2726"><span class="linenos">2726</span></a><span class="sd">            arr : np.ndarray or list of float</span>
</span><span id="CenterDetermination-2727"><a href="#CenterDetermination-2727"><span class="linenos">2727</span></a><span class="sd">                1D array of values (intensity profile) where symmetric peak</span>
</span><span id="CenterDetermination-2728"><a href="#CenterDetermination-2728"><span class="linenos">2728</span></a><span class="sd">                positions are to be matched.</span>
</span><span id="CenterDetermination-2729"><a href="#CenterDetermination-2729"><span class="linenos">2729</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2730"><a href="#CenterDetermination-2730"><span class="linenos">2730</span></a><span class="sd">            Returns</span>
</span><span id="CenterDetermination-2731"><a href="#CenterDetermination-2731"><span class="linenos">2731</span></a><span class="sd">            -------</span>
</span><span id="CenterDetermination-2732"><a href="#CenterDetermination-2732"><span class="linenos">2732</span></a><span class="sd">            best_pair : tuple[int or None, int or None]</span>
</span><span id="CenterDetermination-2733"><a href="#CenterDetermination-2733"><span class="linenos">2733</span></a><span class="sd">                Indices of the two most similar values, one from each half of </span>
</span><span id="CenterDetermination-2734"><a href="#CenterDetermination-2734"><span class="linenos">2734</span></a><span class="sd">                the array. Returns (None, None) if no valid pair is found.</span>
</span><span id="CenterDetermination-2735"><a href="#CenterDetermination-2735"><span class="linenos">2735</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2736"><a href="#CenterDetermination-2736"><span class="linenos">2736</span></a><span class="sd">            Notes</span>
</span><span id="CenterDetermination-2737"><a href="#CenterDetermination-2737"><span class="linenos">2737</span></a><span class="sd">            -----</span>
</span><span id="CenterDetermination-2738"><a href="#CenterDetermination-2738"><span class="linenos">2738</span></a><span class="sd">            - The function assumes the most prominent peak (maximum value) lies </span>
</span><span id="CenterDetermination-2739"><a href="#CenterDetermination-2739"><span class="linenos">2739</span></a><span class="sd">              at or near the center and represents the central feature.</span>
</span><span id="CenterDetermination-2740"><a href="#CenterDetermination-2740"><span class="linenos">2740</span></a><span class="sd">            - The left and right halves are compared pairwise, and the closest </span>
</span><span id="CenterDetermination-2741"><a href="#CenterDetermination-2741"><span class="linenos">2741</span></a><span class="sd">              match in absolute value difference is returned.</span>
</span><span id="CenterDetermination-2742"><a href="#CenterDetermination-2742"><span class="linenos">2742</span></a><span class="sd">            - This is useful for refining radial symmetry or finding symmetric </span>
</span><span id="CenterDetermination-2743"><a href="#CenterDetermination-2743"><span class="linenos">2743</span></a><span class="sd">              ring peaks.</span>
</span><span id="CenterDetermination-2744"><a href="#CenterDetermination-2744"><span class="linenos">2744</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2745"><a href="#CenterDetermination-2745"><span class="linenos">2745</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not enough values to compare</span>
</span><span id="CenterDetermination-2746"><a href="#CenterDetermination-2746"><span class="linenos">2746</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2747"><a href="#CenterDetermination-2747"><span class="linenos">2747</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough values to find similar pairs.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2748"><a href="#CenterDetermination-2748"><span class="linenos">2748</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2749"><a href="#CenterDetermination-2749"><span class="linenos">2749</span></a>    
</span><span id="CenterDetermination-2750"><a href="#CenterDetermination-2750"><span class="linenos">2750</span></a>            <span class="c1"># Special case: if there are exactly 2 peaks, return them</span>
</span><span id="CenterDetermination-2751"><a href="#CenterDetermination-2751"><span class="linenos">2751</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2752"><a href="#CenterDetermination-2752"><span class="linenos">2752</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2753"><a href="#CenterDetermination-2753"><span class="linenos">2753</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exactly two peaks detected. Returning them as the best pair.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2754"><a href="#CenterDetermination-2754"><span class="linenos">2754</span></a>                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span id="CenterDetermination-2755"><a href="#CenterDetermination-2755"><span class="linenos">2755</span></a>    
</span><span id="CenterDetermination-2756"><a href="#CenterDetermination-2756"><span class="linenos">2756</span></a>            <span class="c1"># Find the index of the highest value</span>
</span><span id="CenterDetermination-2757"><a href="#CenterDetermination-2757"><span class="linenos">2757</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span id="CenterDetermination-2758"><a href="#CenterDetermination-2758"><span class="linenos">2758</span></a>    
</span><span id="CenterDetermination-2759"><a href="#CenterDetermination-2759"><span class="linenos">2759</span></a>            <span class="c1"># Split into left and right halves, excluding the highest value</span>
</span><span id="CenterDetermination-2760"><a href="#CenterDetermination-2760"><span class="linenos">2760</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="CenterDetermination-2761"><a href="#CenterDetermination-2761"><span class="linenos">2761</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="CenterDetermination-2762"><a href="#CenterDetermination-2762"><span class="linenos">2762</span></a>            <span class="n">left_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>
</span><span id="CenterDetermination-2763"><a href="#CenterDetermination-2763"><span class="linenos">2763</span></a>            <span class="n">right_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
</span><span id="CenterDetermination-2764"><a href="#CenterDetermination-2764"><span class="linenos">2764</span></a>    
</span><span id="CenterDetermination-2765"><a href="#CenterDetermination-2765"><span class="linenos">2765</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check for empty halves</span>
</span><span id="CenterDetermination-2766"><a href="#CenterDetermination-2766"><span class="linenos">2766</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2767"><a href="#CenterDetermination-2767"><span class="linenos">2767</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One of the halves is empty.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2768"><a href="#CenterDetermination-2768"><span class="linenos">2768</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2769"><a href="#CenterDetermination-2769"><span class="linenos">2769</span></a>    
</span><span id="CenterDetermination-2770"><a href="#CenterDetermination-2770"><span class="linenos">2770</span></a>            <span class="c1"># Initialize variables for tracking the smallest difference</span>
</span><span id="CenterDetermination-2771"><a href="#CenterDetermination-2771"><span class="linenos">2771</span></a>            <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="CenterDetermination-2772"><a href="#CenterDetermination-2772"><span class="linenos">2772</span></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="CenterDetermination-2773"><a href="#CenterDetermination-2773"><span class="linenos">2773</span></a>    
</span><span id="CenterDetermination-2774"><a href="#CenterDetermination-2774"><span class="linenos">2774</span></a>            <span class="c1"># Compare each value in the left with every value in the right</span>
</span><span id="CenterDetermination-2775"><a href="#CenterDetermination-2775"><span class="linenos">2775</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
</span><span id="CenterDetermination-2776"><a href="#CenterDetermination-2776"><span class="linenos">2776</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
</span><span id="CenterDetermination-2777"><a href="#CenterDetermination-2777"><span class="linenos">2777</span></a>                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l_val</span> <span class="o">-</span> <span class="n">r_val</span><span class="p">)</span>
</span><span id="CenterDetermination-2778"><a href="#CenterDetermination-2778"><span class="linenos">2778</span></a>                    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">smallest_diff</span><span class="p">:</span>
</span><span id="CenterDetermination-2779"><a href="#CenterDetermination-2779"><span class="linenos">2779</span></a>                        <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">diff</span>
</span><span id="CenterDetermination-2780"><a href="#CenterDetermination-2780"><span class="linenos">2780</span></a>                        <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_indices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="CenterDetermination-2781"><a href="#CenterDetermination-2781"><span class="linenos">2781</span></a>    
</span><span id="CenterDetermination-2782"><a href="#CenterDetermination-2782"><span class="linenos">2782</span></a>            <span class="k">return</span> <span class="n">best_pair</span>
</span><span id="CenterDetermination-2783"><a href="#CenterDetermination-2783"><span class="linenos">2783</span></a>        
</span><span id="CenterDetermination-2784"><a href="#CenterDetermination-2784"><span class="linenos">2784</span></a>        <span class="c1"># Peak matching method ------------------------------------------------</span>
</span><span id="CenterDetermination-2785"><a href="#CenterDetermination-2785"><span class="linenos">2785</span></a>        <span class="k">if</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-2786"><a href="#CenterDetermination-2786"><span class="linenos">2786</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2787"><a href="#CenterDetermination-2787"><span class="linenos">2787</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2788"><a href="#CenterDetermination-2788"><span class="linenos">2788</span></a>        
</span><span id="CenterDetermination-2789"><a href="#CenterDetermination-2789"><span class="linenos">2789</span></a>            <span class="n">x_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="CenterDetermination-2790"><a href="#CenterDetermination-2790"><span class="linenos">2790</span></a>            <span class="n">y_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</span><span id="CenterDetermination-2791"><a href="#CenterDetermination-2791"><span class="linenos">2791</span></a>        
</span><span id="CenterDetermination-2792"><a href="#CenterDetermination-2792"><span class="linenos">2792</span></a>            <span class="c1"># Define threshold for peak detection</span>
</span><span id="CenterDetermination-2793"><a href="#CenterDetermination-2793"><span class="linenos">2793</span></a>            <span class="n">x_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span>
</span><span id="CenterDetermination-2794"><a href="#CenterDetermination-2794"><span class="linenos">2794</span></a>            <span class="n">y_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_line</span><span class="p">)</span>
</span><span id="CenterDetermination-2795"><a href="#CenterDetermination-2795"><span class="linenos">2795</span></a>        
</span><span id="CenterDetermination-2796"><a href="#CenterDetermination-2796"><span class="linenos">2796</span></a>            <span class="c1"># Find peaks with dynamic height thresholds</span>
</span><span id="CenterDetermination-2797"><a href="#CenterDetermination-2797"><span class="linenos">2797</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> 
</span><span id="CenterDetermination-2798"><a href="#CenterDetermination-2798"><span class="linenos">2798</span></a>                                        <span class="n">height</span><span class="o">=</span><span class="n">x_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination-2799"><a href="#CenterDetermination-2799"><span class="linenos">2799</span></a>                                        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination-2800"><a href="#CenterDetermination-2800"><span class="linenos">2800</span></a>                                        <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination-2801"><a href="#CenterDetermination-2801"><span class="linenos">2801</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span> <span class="o">=</span> <span class="n">x_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">]</span>
</span><span id="CenterDetermination-2802"><a href="#CenterDetermination-2802"><span class="linenos">2802</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> 
</span><span id="CenterDetermination-2803"><a href="#CenterDetermination-2803"><span class="linenos">2803</span></a>                                        <span class="n">height</span><span class="o">=</span><span class="n">y_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination-2804"><a href="#CenterDetermination-2804"><span class="linenos">2804</span></a>                                        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination-2805"><a href="#CenterDetermination-2805"><span class="linenos">2805</span></a>                                        <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination-2806"><a href="#CenterDetermination-2806"><span class="linenos">2806</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="n">y_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">]</span>
</span><span id="CenterDetermination-2807"><a href="#CenterDetermination-2807"><span class="linenos">2807</span></a>        
</span><span id="CenterDetermination-2808"><a href="#CenterDetermination-2808"><span class="linenos">2808</span></a>            <span class="c1"># Define half the length of the image</span>
</span><span id="CenterDetermination-2809"><a href="#CenterDetermination-2809"><span class="linenos">2809</span></a>            <span class="n">half_length_x</span> <span class="o">=</span> <span class="n">x_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-2810"><a href="#CenterDetermination-2810"><span class="linenos">2810</span></a>            <span class="n">half_length_y</span> <span class="o">=</span> <span class="n">y_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-2811"><a href="#CenterDetermination-2811"><span class="linenos">2811</span></a>        
</span><span id="CenterDetermination-2812"><a href="#CenterDetermination-2812"><span class="linenos">2812</span></a>            <span class="c1"># Check the additional condition for xpeaks</span>
</span><span id="CenterDetermination-2813"><a href="#CenterDetermination-2813"><span class="linenos">2813</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination-2814"><a href="#CenterDetermination-2814"><span class="linenos">2814</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination-2815"><a href="#CenterDetermination-2815"><span class="linenos">2815</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span><span class="p">)):</span>
</span><span id="CenterDetermination-2816"><a href="#CenterDetermination-2816"><span class="linenos">2816</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2817"><a href="#CenterDetermination-2817"><span class="linenos">2817</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xpeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2818"><a href="#CenterDetermination-2818"><span class="linenos">2818</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2819"><a href="#CenterDetermination-2819"><span class="linenos">2819</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2820"><a href="#CenterDetermination-2820"><span class="linenos">2820</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">)</span>
</span><span id="CenterDetermination-2821"><a href="#CenterDetermination-2821"><span class="linenos">2821</span></a>        
</span><span id="CenterDetermination-2822"><a href="#CenterDetermination-2822"><span class="linenos">2822</span></a>            <span class="c1"># Check the additional condition for ypeaks</span>
</span><span id="CenterDetermination-2823"><a href="#CenterDetermination-2823"><span class="linenos">2823</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination-2824"><a href="#CenterDetermination-2824"><span class="linenos">2824</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination-2825"><a href="#CenterDetermination-2825"><span class="linenos">2825</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span><span class="p">)):</span>
</span><span id="CenterDetermination-2826"><a href="#CenterDetermination-2826"><span class="linenos">2826</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2827"><a href="#CenterDetermination-2827"><span class="linenos">2827</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ypeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2828"><a href="#CenterDetermination-2828"><span class="linenos">2828</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2829"><a href="#CenterDetermination-2829"><span class="linenos">2829</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2830"><a href="#CenterDetermination-2830"><span class="linenos">2830</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">)</span>
</span><span id="CenterDetermination-2831"><a href="#CenterDetermination-2831"><span class="linenos">2831</span></a>        
</span><span id="CenterDetermination-2832"><a href="#CenterDetermination-2832"><span class="linenos">2832</span></a>            <span class="c1"># Determine radius based on available pairs</span>
</span><span id="CenterDetermination-2833"><a href="#CenterDetermination-2833"><span class="linenos">2833</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">:</span>
</span><span id="CenterDetermination-2834"><a href="#CenterDetermination-2834"><span class="linenos">2834</span></a>                <span class="n">rx_x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2835"><a href="#CenterDetermination-2835"><span class="linenos">2835</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2836"><a href="#CenterDetermination-2836"><span class="linenos">2836</span></a>                <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination-2837"><a href="#CenterDetermination-2837"><span class="linenos">2837</span></a>                <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination-2838"><a href="#CenterDetermination-2838"><span class="linenos">2838</span></a>                <span class="n">rx_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-2839"><a href="#CenterDetermination-2839"><span class="linenos">2839</span></a>        
</span><span id="CenterDetermination-2840"><a href="#CenterDetermination-2840"><span class="linenos">2840</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">:</span>
</span><span id="CenterDetermination-2841"><a href="#CenterDetermination-2841"><span class="linenos">2841</span></a>                <span class="n">rx_y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-2842"><a href="#CenterDetermination-2842"><span class="linenos">2842</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2843"><a href="#CenterDetermination-2843"><span class="linenos">2843</span></a>                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination-2844"><a href="#CenterDetermination-2844"><span class="linenos">2844</span></a>                <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination-2845"><a href="#CenterDetermination-2845"><span class="linenos">2845</span></a>                <span class="n">rx_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-2846"><a href="#CenterDetermination-2846"><span class="linenos">2846</span></a>        
</span><span id="CenterDetermination-2847"><a href="#CenterDetermination-2847"><span class="linenos">2847</span></a>            <span class="k">if</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-2848"><a href="#CenterDetermination-2848"><span class="linenos">2848</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">rx_x</span><span class="p">,</span> <span class="n">rx_y</span><span class="p">])</span>
</span><span id="CenterDetermination-2849"><a href="#CenterDetermination-2849"><span class="linenos">2849</span></a>            <span class="k">elif</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-2850"><a href="#CenterDetermination-2850"><span class="linenos">2850</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_x</span>
</span><span id="CenterDetermination-2851"><a href="#CenterDetermination-2851"><span class="linenos">2851</span></a>            <span class="k">elif</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-2852"><a href="#CenterDetermination-2852"><span class="linenos">2852</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_y</span>
</span><span id="CenterDetermination-2853"><a href="#CenterDetermination-2853"><span class="linenos">2853</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-2854"><a href="#CenterDetermination-2854"><span class="linenos">2854</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-2855"><a href="#CenterDetermination-2855"><span class="linenos">2855</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pairs detected for radius calculation.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2856"><a href="#CenterDetermination-2856"><span class="linenos">2856</span></a>                <span class="k">return</span> <span class="mi">100</span>  <span class="c1"># Default radius or error handling</span>
</span><span id="CenterDetermination-2857"><a href="#CenterDetermination-2857"><span class="linenos">2857</span></a>        
</span><span id="CenterDetermination-2858"><a href="#CenterDetermination-2858"><span class="linenos">2858</span></a>            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination-2859"><a href="#CenterDetermination-2859"><span class="linenos">2859</span></a>                <span class="c1"># Plot xline with peaks</span>
</span><span id="CenterDetermination-2860"><a href="#CenterDetermination-2860"><span class="linenos">2860</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="CenterDetermination-2861"><a href="#CenterDetermination-2861"><span class="linenos">2861</span></a>        
</span><span id="CenterDetermination-2862"><a href="#CenterDetermination-2862"><span class="linenos">2862</span></a>                <span class="c1"># Plot for xline</span>
</span><span id="CenterDetermination-2863"><a href="#CenterDetermination-2863"><span class="linenos">2863</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-2864"><a href="#CenterDetermination-2864"><span class="linenos">2864</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2865"><a href="#CenterDetermination-2865"><span class="linenos">2865</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2866"><a href="#CenterDetermination-2866"><span class="linenos">2866</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2867"><a href="#CenterDetermination-2867"><span class="linenos">2867</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2868"><a href="#CenterDetermination-2868"><span class="linenos">2868</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2869"><a href="#CenterDetermination-2869"><span class="linenos">2869</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination-2870"><a href="#CenterDetermination-2870"><span class="linenos">2870</span></a>        
</span><span id="CenterDetermination-2871"><a href="#CenterDetermination-2871"><span class="linenos">2871</span></a>                <span class="c1"># Plot for yline</span>
</span><span id="CenterDetermination-2872"><a href="#CenterDetermination-2872"><span class="linenos">2872</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-2873"><a href="#CenterDetermination-2873"><span class="linenos">2873</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2874"><a href="#CenterDetermination-2874"><span class="linenos">2874</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>  
</span><span id="CenterDetermination-2875"><a href="#CenterDetermination-2875"><span class="linenos">2875</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2876"><a href="#CenterDetermination-2876"><span class="linenos">2876</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2877"><a href="#CenterDetermination-2877"><span class="linenos">2877</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2878"><a href="#CenterDetermination-2878"><span class="linenos">2878</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination-2879"><a href="#CenterDetermination-2879"><span class="linenos">2879</span></a>        
</span><span id="CenterDetermination-2880"><a href="#CenterDetermination-2880"><span class="linenos">2880</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-2881"><a href="#CenterDetermination-2881"><span class="linenos">2881</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-2882"><a href="#CenterDetermination-2882"><span class="linenos">2882</span></a>        
</span><span id="CenterDetermination-2883"><a href="#CenterDetermination-2883"><span class="linenos">2883</span></a>        <span class="c1"># Radial distribution method ------------------------------------------</span>
</span><span id="CenterDetermination-2884"><a href="#CenterDetermination-2884"><span class="linenos">2884</span></a>        <span class="k">elif</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-2885"><a href="#CenterDetermination-2885"><span class="linenos">2885</span></a>            <span class="n">profile</span> <span class="o">=</span> <span class="n">ediff</span><span class="o">.</span><span class="n">radial</span><span class="o">.</span><span class="n">calc_radial_distribution</span><span class="p">(</span>
</span><span id="CenterDetermination-2886"><a href="#CenterDetermination-2886"><span class="linenos">2886</span></a>                <span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination-2887"><a href="#CenterDetermination-2887"><span class="linenos">2887</span></a>                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination-2888"><a href="#CenterDetermination-2888"><span class="linenos">2888</span></a>                <span class="p">)</span>
</span><span id="CenterDetermination-2889"><a href="#CenterDetermination-2889"><span class="linenos">2889</span></a>            <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">profile</span>
</span><span id="CenterDetermination-2890"><a href="#CenterDetermination-2890"><span class="linenos">2890</span></a>            <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">50</span><span class="p">:])</span> <span class="o">+</span> <span class="mi">50</span>
</span><span id="CenterDetermination-2891"><a href="#CenterDetermination-2891"><span class="linenos">2891</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
</span><span id="CenterDetermination-2892"><a href="#CenterDetermination-2892"><span class="linenos">2892</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
</span><span id="CenterDetermination-2893"><a href="#CenterDetermination-2893"><span class="linenos">2893</span></a>    
</span><span id="CenterDetermination-2894"><a href="#CenterDetermination-2894"><span class="linenos">2894</span></a>            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination-2895"><a href="#CenterDetermination-2895"><span class="linenos">2895</span></a>                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="CenterDetermination-2896"><a href="#CenterDetermination-2896"><span class="linenos">2896</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination-2897"><a href="#CenterDetermination-2897"><span class="linenos">2897</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="CenterDetermination-2898"><a href="#CenterDetermination-2898"><span class="linenos">2898</span></a>                    <span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterDetermination-2899"><a href="#CenterDetermination-2899"><span class="linenos">2899</span></a>                        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">rx</span><span class="p">,</span> 
</span><span id="CenterDetermination-2900"><a href="#CenterDetermination-2900"><span class="linenos">2900</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2901"><a href="#CenterDetermination-2901"><span class="linenos">2901</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination-2902"><a href="#CenterDetermination-2902"><span class="linenos">2902</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="CenterDetermination-2903"><a href="#CenterDetermination-2903"><span class="linenos">2903</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2904"><a href="#CenterDetermination-2904"><span class="linenos">2904</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Initial Estimate&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2905"><a href="#CenterDetermination-2905"><span class="linenos">2905</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2906"><a href="#CenterDetermination-2906"><span class="linenos">2906</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
</span><span id="CenterDetermination-2907"><a href="#CenterDetermination-2907"><span class="linenos">2907</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_val</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-2908"><a href="#CenterDetermination-2908"><span class="linenos">2908</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> 
</span><span id="CenterDetermination-2909"><a href="#CenterDetermination-2909"><span class="linenos">2909</span></a>                               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2910"><a href="#CenterDetermination-2910"><span class="linenos">2910</span></a>                               <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-2911"><a href="#CenterDetermination-2911"><span class="linenos">2911</span></a>                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Radius&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-2912"><a href="#CenterDetermination-2912"><span class="linenos">2912</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Radial Profile&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-2913"><a href="#CenterDetermination-2913"><span class="linenos">2913</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination-2914"><a href="#CenterDetermination-2914"><span class="linenos">2914</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-2915"><a href="#CenterDetermination-2915"><span class="linenos">2915</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-2916"><a href="#CenterDetermination-2916"><span class="linenos">2916</span></a>        
</span><span id="CenterDetermination-2917"><a href="#CenterDetermination-2917"><span class="linenos">2917</span></a>        <span class="c1"># Return found radius</span>
</span><span id="CenterDetermination-2918"><a href="#CenterDetermination-2918"><span class="linenos">2918</span></a>        <span class="k">return</span> <span class="n">rx</span>
</span><span id="CenterDetermination-2919"><a href="#CenterDetermination-2919"><span class="linenos">2919</span></a>
</span><span id="CenterDetermination-2920"><a href="#CenterDetermination-2920"><span class="linenos">2920</span></a>
</span><span id="CenterDetermination-2921"><a href="#CenterDetermination-2921"><span class="linenos">2921</span></a>    <span class="k">def</span> <span class="nf">backend_fft</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="CenterDetermination-2922"><a href="#CenterDetermination-2922"><span class="linenos">2922</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2923"><a href="#CenterDetermination-2923"><span class="linenos">2923</span></a><span class="sd">        Decorator to enforce the use of PocketFFTBackend when utilizing the </span>
</span><span id="CenterDetermination-2924"><a href="#CenterDetermination-2924"><span class="linenos">2924</span></a><span class="sd">        `scipy.fft` module. This ensures that all FFT computations leverage </span>
</span><span id="CenterDetermination-2925"><a href="#CenterDetermination-2925"><span class="linenos">2925</span></a><span class="sd">        the optimized PocketFFT implementation, improving performance, </span>
</span><span id="CenterDetermination-2926"><a href="#CenterDetermination-2926"><span class="linenos">2926</span></a><span class="sd">        particularly for multi-threaded execution.</span>
</span><span id="CenterDetermination-2927"><a href="#CenterDetermination-2927"><span class="linenos">2927</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-2928"><a href="#CenterDetermination-2928"><span class="linenos">2928</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-2929"><a href="#CenterDetermination-2929"><span class="linenos">2929</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-2930"><a href="#CenterDetermination-2930"><span class="linenos">2930</span></a><span class="sd">        f : callable</span>
</span><span id="CenterDetermination-2931"><a href="#CenterDetermination-2931"><span class="linenos">2931</span></a><span class="sd">            The function to be wrapped, ensuring it executes within the </span>
</span><span id="CenterDetermination-2932"><a href="#CenterDetermination-2932"><span class="linenos">2932</span></a><span class="sd">            PocketFFTBackend context.</span>
</span><span id="CenterDetermination-2933"><a href="#CenterDetermination-2933"><span class="linenos">2933</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-2934"><a href="#CenterDetermination-2934"><span class="linenos">2934</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-2935"><a href="#CenterDetermination-2935"><span class="linenos">2935</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-2936"><a href="#CenterDetermination-2936"><span class="linenos">2936</span></a><span class="sd">        callable</span>
</span><span id="CenterDetermination-2937"><a href="#CenterDetermination-2937"><span class="linenos">2937</span></a><span class="sd">            A wrapped function that forces the use of PocketFFTBackend.</span>
</span><span id="CenterDetermination-2938"><a href="#CenterDetermination-2938"><span class="linenos">2938</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2939"><a href="#CenterDetermination-2939"><span class="linenos">2939</span></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="CenterDetermination-2940"><a href="#CenterDetermination-2940"><span class="linenos">2940</span></a>        <span class="k">def</span> <span class="nf">newf</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="CenterDetermination-2941"><a href="#CenterDetermination-2941"><span class="linenos">2941</span></a>            <span class="k">with</span> <span class="n">set_backend</span><span class="p">(</span><span class="n">PocketFFTBackend</span><span class="p">):</span>
</span><span id="CenterDetermination-2942"><a href="#CenterDetermination-2942"><span class="linenos">2942</span></a>                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="CenterDetermination-2943"><a href="#CenterDetermination-2943"><span class="linenos">2943</span></a>        <span class="k">return</span> <span class="n">newf</span>
</span><span id="CenterDetermination-2944"><a href="#CenterDetermination-2944"><span class="linenos">2944</span></a>    
</span><span id="CenterDetermination-2945"><a href="#CenterDetermination-2945"><span class="linenos">2945</span></a>    <span class="nd">@backend_fft</span>
</span><span id="CenterDetermination-2946"><a href="#CenterDetermination-2946"><span class="linenos">2946</span></a>    <span class="k">def</span> <span class="nf">calc_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fft_function</span><span class="p">):</span>
</span><span id="CenterDetermination-2947"><a href="#CenterDetermination-2947"><span class="linenos">2947</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2948"><a href="#CenterDetermination-2948"><span class="linenos">2948</span></a><span class="sd">        Computes the Fast Fourier Transform (FFT) using the specified function.</span>
</span><span id="CenterDetermination-2949"><a href="#CenterDetermination-2949"><span class="linenos">2949</span></a>
</span><span id="CenterDetermination-2950"><a href="#CenterDetermination-2950"><span class="linenos">2950</span></a><span class="sd">        This method ensures that the FFT operation is executed using </span>
</span><span id="CenterDetermination-2951"><a href="#CenterDetermination-2951"><span class="linenos">2951</span></a><span class="sd">        the PocketFFTBackend, applying optimized settings for improved efficiency.</span>
</span><span id="CenterDetermination-2952"><a href="#CenterDetermination-2952"><span class="linenos">2952</span></a>
</span><span id="CenterDetermination-2953"><a href="#CenterDetermination-2953"><span class="linenos">2953</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-2954"><a href="#CenterDetermination-2954"><span class="linenos">2954</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-2955"><a href="#CenterDetermination-2955"><span class="linenos">2955</span></a><span class="sd">        fft_function : callable</span>
</span><span id="CenterDetermination-2956"><a href="#CenterDetermination-2956"><span class="linenos">2956</span></a><span class="sd">            The FFT function to be applied to the data.</span>
</span><span id="CenterDetermination-2957"><a href="#CenterDetermination-2957"><span class="linenos">2957</span></a>
</span><span id="CenterDetermination-2958"><a href="#CenterDetermination-2958"><span class="linenos">2958</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-2959"><a href="#CenterDetermination-2959"><span class="linenos">2959</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-2960"><a href="#CenterDetermination-2960"><span class="linenos">2960</span></a><span class="sd">        object</span>
</span><span id="CenterDetermination-2961"><a href="#CenterDetermination-2961"><span class="linenos">2961</span></a><span class="sd">            The result of the FFT computation.</span>
</span><span id="CenterDetermination-2962"><a href="#CenterDetermination-2962"><span class="linenos">2962</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2963"><a href="#CenterDetermination-2963"><span class="linenos">2963</span></a>        <span class="k">return</span> <span class="n">fft_function</span>
</span><span id="CenterDetermination-2964"><a href="#CenterDetermination-2964"><span class="linenos">2964</span></a>
</span><span id="CenterDetermination-2965"><a href="#CenterDetermination-2965"><span class="linenos">2965</span></a>   
</span><span id="CenterDetermination-2966"><a href="#CenterDetermination-2966"><span class="linenos">2966</span></a>    <span class="k">def</span> <span class="nf">auto_masking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">show_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination-2967"><a href="#CenterDetermination-2967"><span class="linenos">2967</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2968"><a href="#CenterDetermination-2968"><span class="linenos">2968</span></a><span class="sd">        Automatically generates a binary mask for an image based on intensity </span>
</span><span id="CenterDetermination-2969"><a href="#CenterDetermination-2969"><span class="linenos">2969</span></a><span class="sd">        thresholding.</span>
</span><span id="CenterDetermination-2970"><a href="#CenterDetermination-2970"><span class="linenos">2970</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2971"><a href="#CenterDetermination-2971"><span class="linenos">2971</span></a><span class="sd">        This function determines a lower intensity limit by taking a fraction </span>
</span><span id="CenterDetermination-2972"><a href="#CenterDetermination-2972"><span class="linenos">2972</span></a><span class="sd">        (threshold) of the median of the highest intensity values in the image. </span>
</span><span id="CenterDetermination-2973"><a href="#CenterDetermination-2973"><span class="linenos">2973</span></a><span class="sd">        This helps filter out noise while preserving meaningful features, </span>
</span><span id="CenterDetermination-2974"><a href="#CenterDetermination-2974"><span class="linenos">2974</span></a><span class="sd">        avoiding the influence of hot spots.</span>
</span><span id="CenterDetermination-2975"><a href="#CenterDetermination-2975"><span class="linenos">2975</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-2976"><a href="#CenterDetermination-2976"><span class="linenos">2976</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-2977"><a href="#CenterDetermination-2977"><span class="linenos">2977</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-2978"><a href="#CenterDetermination-2978"><span class="linenos">2978</span></a><span class="sd">        im : ndarray</span>
</span><span id="CenterDetermination-2979"><a href="#CenterDetermination-2979"><span class="linenos">2979</span></a><span class="sd">            Input grayscale image as a 2D NumPy array.</span>
</span><span id="CenterDetermination-2980"><a href="#CenterDetermination-2980"><span class="linenos">2980</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-2981"><a href="#CenterDetermination-2981"><span class="linenos">2981</span></a><span class="sd">        threshold : float, optional</span>
</span><span id="CenterDetermination-2982"><a href="#CenterDetermination-2982"><span class="linenos">2982</span></a><span class="sd">            A fraction (default is 0.1) of the median of the highest intensity </span>
</span><span id="CenterDetermination-2983"><a href="#CenterDetermination-2983"><span class="linenos">2983</span></a><span class="sd">            values. Pixels with intensity above this computed limit will be </span>
</span><span id="CenterDetermination-2984"><a href="#CenterDetermination-2984"><span class="linenos">2984</span></a><span class="sd">            included in the mask.</span>
</span><span id="CenterDetermination-2985"><a href="#CenterDetermination-2985"><span class="linenos">2985</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-2986"><a href="#CenterDetermination-2986"><span class="linenos">2986</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-2987"><a href="#CenterDetermination-2987"><span class="linenos">2987</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-2988"><a href="#CenterDetermination-2988"><span class="linenos">2988</span></a><span class="sd">        mask : ndarray</span>
</span><span id="CenterDetermination-2989"><a href="#CenterDetermination-2989"><span class="linenos">2989</span></a><span class="sd">            A boolean mask (same shape as `im`), where `True` indicates pixels </span>
</span><span id="CenterDetermination-2990"><a href="#CenterDetermination-2990"><span class="linenos">2990</span></a><span class="sd">            above the threshold and `False` represents background or noise.</span>
</span><span id="CenterDetermination-2991"><a href="#CenterDetermination-2991"><span class="linenos">2991</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-2992"><a href="#CenterDetermination-2992"><span class="linenos">2992</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-2993"><a href="#CenterDetermination-2993"><span class="linenos">2993</span></a>        <span class="c1"># Find the median of the highest intensity value of the image to avoid </span>
</span><span id="CenterDetermination-2994"><a href="#CenterDetermination-2994"><span class="linenos">2994</span></a>        <span class="c1"># hot spots (More stable than median scaling)</span>
</span><span id="CenterDetermination-2995"><a href="#CenterDetermination-2995"><span class="linenos">2995</span></a>        <span class="n">lower_limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> 
</span><span id="CenterDetermination-2996"><a href="#CenterDetermination-2996"><span class="linenos">2996</span></a>        
</span><span id="CenterDetermination-2997"><a href="#CenterDetermination-2997"><span class="linenos">2997</span></a>        <span class="c1"># Generate a mask</span>
</span><span id="CenterDetermination-2998"><a href="#CenterDetermination-2998"><span class="linenos">2998</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">im</span> <span class="o">&gt;</span> <span class="n">lower_limit</span>
</span><span id="CenterDetermination-2999"><a href="#CenterDetermination-2999"><span class="linenos">2999</span></a>        
</span><span id="CenterDetermination-3000"><a href="#CenterDetermination-3000"><span class="linenos">3000</span></a>        <span class="k">if</span> <span class="n">show_mask</span><span class="p">:</span>
</span><span id="CenterDetermination-3001"><a href="#CenterDetermination-3001"><span class="linenos">3001</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="CenterDetermination-3002"><a href="#CenterDetermination-3002"><span class="linenos">3002</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="CenterDetermination-3003"><a href="#CenterDetermination-3003"><span class="linenos">3003</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Beam Stopper Masking&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-3004"><a href="#CenterDetermination-3004"><span class="linenos">3004</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-3005"><a href="#CenterDetermination-3005"><span class="linenos">3005</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-3006"><a href="#CenterDetermination-3006"><span class="linenos">3006</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-3007"><a href="#CenterDetermination-3007"><span class="linenos">3007</span></a>        
</span><span id="CenterDetermination-3008"><a href="#CenterDetermination-3008"><span class="linenos">3008</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="CenterDetermination-3009"><a href="#CenterDetermination-3009"><span class="linenos">3009</span></a>
</span><span id="CenterDetermination-3010"><a href="#CenterDetermination-3010"><span class="linenos">3010</span></a>        
</span><span id="CenterDetermination-3011"><a href="#CenterDetermination-3011"><span class="linenos">3011</span></a>    <span class="k">def</span> <span class="nf">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-3012"><a href="#CenterDetermination-3012"><span class="linenos">3012</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination-3013"><a href="#CenterDetermination-3013"><span class="linenos">3013</span></a><span class="sd">        Visualize detected diffraction patterns and mark the center.</span>
</span><span id="CenterDetermination-3014"><a href="#CenterDetermination-3014"><span class="linenos">3014</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-3015"><a href="#CenterDetermination-3015"><span class="linenos">3015</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-3016"><a href="#CenterDetermination-3016"><span class="linenos">3016</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-3017"><a href="#CenterDetermination-3017"><span class="linenos">3017</span></a><span class="sd">        tit : string</span>
</span><span id="CenterDetermination-3018"><a href="#CenterDetermination-3018"><span class="linenos">3018</span></a><span class="sd">            name of the method used for circle detection</span>
</span><span id="CenterDetermination-3019"><a href="#CenterDetermination-3019"><span class="linenos">3019</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-3020"><a href="#CenterDetermination-3020"><span class="linenos">3020</span></a><span class="sd">        x : float64</span>
</span><span id="CenterDetermination-3021"><a href="#CenterDetermination-3021"><span class="linenos">3021</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination-3022"><a href="#CenterDetermination-3022"><span class="linenos">3022</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-3023"><a href="#CenterDetermination-3023"><span class="linenos">3023</span></a><span class="sd">        y : float64</span>
</span><span id="CenterDetermination-3024"><a href="#CenterDetermination-3024"><span class="linenos">3024</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination-3025"><a href="#CenterDetermination-3025"><span class="linenos">3025</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-3026"><a href="#CenterDetermination-3026"><span class="linenos">3026</span></a><span class="sd">        r : float64</span>
</span><span id="CenterDetermination-3027"><a href="#CenterDetermination-3027"><span class="linenos">3027</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination-3028"><a href="#CenterDetermination-3028"><span class="linenos">3028</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-3029"><a href="#CenterDetermination-3029"><span class="linenos">3029</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-3030"><a href="#CenterDetermination-3030"><span class="linenos">3030</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-3031"><a href="#CenterDetermination-3031"><span class="linenos">3031</span></a><span class="sd">        None.</span>
</span><span id="CenterDetermination-3032"><a href="#CenterDetermination-3032"><span class="linenos">3032</span></a><span class="sd">                            </span>
</span><span id="CenterDetermination-3033"><a href="#CenterDetermination-3033"><span class="linenos">3033</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-3034"><a href="#CenterDetermination-3034"><span class="linenos">3034</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterDetermination-3035"><a href="#CenterDetermination-3035"><span class="linenos">3035</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-3036"><a href="#CenterDetermination-3036"><span class="linenos">3036</span></a>    
</span><span id="CenterDetermination-3037"><a href="#CenterDetermination-3037"><span class="linenos">3037</span></a>        <span class="k">if</span> <span class="n">rd</span><span class="o">==</span><span class="s2">&quot;d&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-3038"><a href="#CenterDetermination-3038"><span class="linenos">3038</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Detected center position&quot;</span>
</span><span id="CenterDetermination-3039"><a href="#CenterDetermination-3039"><span class="linenos">3039</span></a>        <span class="k">elif</span> <span class="n">rd</span><span class="o">==</span><span class="s2">&quot;r&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-3040"><a href="#CenterDetermination-3040"><span class="linenos">3040</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Refined center position&quot;</span>
</span><span id="CenterDetermination-3041"><a href="#CenterDetermination-3041"><span class="linenos">3041</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterDetermination-3042"><a href="#CenterDetermination-3042"><span class="linenos">3042</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Center position&quot;</span>
</span><span id="CenterDetermination-3043"><a href="#CenterDetermination-3043"><span class="linenos">3043</span></a>            
</span><span id="CenterDetermination-3044"><a href="#CenterDetermination-3044"><span class="linenos">3044</span></a>            
</span><span id="CenterDetermination-3045"><a href="#CenterDetermination-3045"><span class="linenos">3045</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-3046"><a href="#CenterDetermination-3046"><span class="linenos">3046</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-3047"><a href="#CenterDetermination-3047"><span class="linenos">3047</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-3048"><a href="#CenterDetermination-3048"><span class="linenos">3048</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-3049"><a href="#CenterDetermination-3049"><span class="linenos">3049</span></a>            
</span><span id="CenterDetermination-3050"><a href="#CenterDetermination-3050"><span class="linenos">3050</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterDetermination-3051"><a href="#CenterDetermination-3051"><span class="linenos">3051</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination-3052"><a href="#CenterDetermination-3052"><span class="linenos">3052</span></a>        
</span><span id="CenterDetermination-3053"><a href="#CenterDetermination-3053"><span class="linenos">3053</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination-3054"><a href="#CenterDetermination-3054"><span class="linenos">3054</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-3055"><a href="#CenterDetermination-3055"><span class="linenos">3055</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-3056"><a href="#CenterDetermination-3056"><span class="linenos">3056</span></a> 
</span><span id="CenterDetermination-3057"><a href="#CenterDetermination-3057"><span class="linenos">3057</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tit</span><span class="p">)</span>
</span><span id="CenterDetermination-3058"><a href="#CenterDetermination-3058"><span class="linenos">3058</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-3059"><a href="#CenterDetermination-3059"><span class="linenos">3059</span></a>
</span><span id="CenterDetermination-3060"><a href="#CenterDetermination-3060"><span class="linenos">3060</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination-3061"><a href="#CenterDetermination-3061"><span class="linenos">3061</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination-3062"><a href="#CenterDetermination-3062"><span class="linenos">3062</span></a>                <span class="n">label</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;center:  [</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span>
</span><span id="CenterDetermination-3063"><a href="#CenterDetermination-3063"><span class="linenos">3063</span></a>                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterDetermination-3064"><a href="#CenterDetermination-3064"><span class="linenos">3064</span></a>
</span><span id="CenterDetermination-3065"><a href="#CenterDetermination-3065"><span class="linenos">3065</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-3066"><a href="#CenterDetermination-3066"><span class="linenos">3066</span></a>        
</span><span id="CenterDetermination-3067"><a href="#CenterDetermination-3067"><span class="linenos">3067</span></a>        <span class="c1"># Display the image</span>
</span><span id="CenterDetermination-3068"><a href="#CenterDetermination-3068"><span class="linenos">3068</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-3069"><a href="#CenterDetermination-3069"><span class="linenos">3069</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-3070"><a href="#CenterDetermination-3070"><span class="linenos">3070</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-3071"><a href="#CenterDetermination-3071"><span class="linenos">3071</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>CenterDetermination object - initial detection of a diffractogram center.</p>

<p>This class is responsible for identifying the center coordinates of 
a 2D diffraction pattern image using various detection methods specified 
by the user. It initializes with the input image and other parameters
that influence the center detection process.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>parent</strong> (CenterLocator):
Reference to the parent CenterLocator object, allowing access 
to shared attributes and methods.</li>
<li><strong>input_image</strong> (str, path, or numpy.array):
The input image representing a 2D diffraction pattern, provided as 
a file path or a NumPy array.</li>
<li><strong>determination</strong> (str or None, optional, default=None):
Method used for the initial center determination.
Options include:
<ul>
<li>'manual'   : Manual selection of 3 points on a diffraction ring.</li>
<li>'hough'    : Automatic detection using Hough transform.</li>
<li>'intensity': Automatic detection based on the intensity center 
of the central region.</li>
<li>'phase'    : Automatic detection using phase correlation to find 
the symmetry center.</li>
<li>'ccorr'    : Automatic detection using cross-correlation to find 
the symmetry center.</li>
<li>'curvefit' : Automatic detecting using pseudo-Voigt profile fitting</li>
</ul></li>
<li><strong>in_file</strong> (str or None, optional, default=None):
Path to the file from which previously saved coordinates will be loaded.</li>
<li><strong>out_file</strong> (str or None, optional, default=None):
Path to the file where the determined coordinates will be saved.</li>
<li><strong>sobel</strong> (bool, optional, default=False):
If True, apply Sobel filter to the image before processing.</li>
<li><strong>heq</strong> (bool or None, optional, default=False):
If True, apply histogram equalization internally (display unchanged).</li>
<li><strong>icut</strong> (float or None, optional, default=None):
Cut-off intensity level for processing the image.</li>
<li><strong>cmap</strong> (str, optional, default='gray'):
Matplotlib colormap name used for displaying the image.</li>
<li><strong>csquare</strong> (int, optional, defaul=50):
Size (in pixels) of the central square used for initial center search.</li>
<li><strong>cintensity</strong> (float, optional, default=0.8):
Threshold intensity for finding the intensity center. Pixels with a 
(relative) intensity lower than cintensity are ignored.</li>
<li><strong>verbose</strong> (bool, optional, default=False):
If True, print informational verbose during the detection process.</li>
<li><strong>print_sums</strong> (bool, optional, default=False):
If True, print intensity sums after each adjustment (in manual modes).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The class preprocesses the input image and then applies the specified 
center detection method.</li>
<li>The detected center coordinates are stored in instance variables
<code>x</code>, <code>y</code>, and <code>r</code>, representing the center's x-coordinate, 
y-coordinate, and radius, respectively.</li>
</ul>
</div>


                            <div id="CenterDetermination.preprocess" class="classattr">
                                        <input id="CenterDetermination.preprocess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preprocess</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">preInit</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preHough</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preManual</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preVar</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preSum</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preInt</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.preprocess-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.preprocess"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.preprocess-1132"><a href="#CenterDetermination.preprocess-1132"><span class="linenos">1132</span></a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preInit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preHough</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preManual</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CenterDetermination.preprocess-1133"><a href="#CenterDetermination.preprocess-1133"><span class="linenos">1133</span></a>                   <span class="n">preVar</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preSum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preInt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  
</span><span id="CenterDetermination.preprocess-1134"><a href="#CenterDetermination.preprocess-1134"><span class="linenos">1134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.preprocess-1135"><a href="#CenterDetermination.preprocess-1135"><span class="linenos">1135</span></a><span class="sd">        Preprocess the input image based on the selected automatic detection </span>
</span><span id="CenterDetermination.preprocess-1136"><a href="#CenterDetermination.preprocess-1136"><span class="linenos">1136</span></a><span class="sd">        and refinement methods.</span>
</span><span id="CenterDetermination.preprocess-1137"><a href="#CenterDetermination.preprocess-1137"><span class="linenos">1137</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.preprocess-1138"><a href="#CenterDetermination.preprocess-1138"><span class="linenos">1138</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.preprocess-1139"><a href="#CenterDetermination.preprocess-1139"><span class="linenos">1139</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.preprocess-1140"><a href="#CenterDetermination.preprocess-1140"><span class="linenos">1140</span></a><span class="sd">        preInit : bool, optional, default=0</span>
</span><span id="CenterDetermination.preprocess-1141"><a href="#CenterDetermination.preprocess-1141"><span class="linenos">1141</span></a><span class="sd">            Preprocess the original image using initialization methods such as</span>
</span><span id="CenterDetermination.preprocess-1142"><a href="#CenterDetermination.preprocess-1142"><span class="linenos">1142</span></a><span class="sd">            histogram equalization (heq) or contrast clipping (icut). This</span>
</span><span id="CenterDetermination.preprocess-1143"><a href="#CenterDetermination.preprocess-1143"><span class="linenos">1143</span></a><span class="sd">            is used to enhance the input image prior to any detection or</span>
</span><span id="CenterDetermination.preprocess-1144"><a href="#CenterDetermination.preprocess-1144"><span class="linenos">1144</span></a><span class="sd">            correction.</span>
</span><span id="CenterDetermination.preprocess-1145"><a href="#CenterDetermination.preprocess-1145"><span class="linenos">1145</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.preprocess-1146"><a href="#CenterDetermination.preprocess-1146"><span class="linenos">1146</span></a><span class="sd">        preHough : bool, optional, default=0</span>
</span><span id="CenterDetermination.preprocess-1147"><a href="#CenterDetermination.preprocess-1147"><span class="linenos">1147</span></a><span class="sd">            Perform preprocessing required for Hough transform-based automatic </span>
</span><span id="CenterDetermination.preprocess-1148"><a href="#CenterDetermination.preprocess-1148"><span class="linenos">1148</span></a><span class="sd">            detection. This includes edge detection and handling beamstoppers. </span>
</span><span id="CenterDetermination.preprocess-1149"><a href="#CenterDetermination.preprocess-1149"><span class="linenos">1149</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.preprocess-1150"><a href="#CenterDetermination.preprocess-1150"><span class="linenos">1150</span></a><span class="sd">        preManual, preVar, preSum, preInt : bool, optional, default=0</span>
</span><span id="CenterDetermination.preprocess-1151"><a href="#CenterDetermination.preprocess-1151"><span class="linenos">1151</span></a><span class="sd">            Placeholder flags for future preprocessing needs for manual </span>
</span><span id="CenterDetermination.preprocess-1152"><a href="#CenterDetermination.preprocess-1152"><span class="linenos">1152</span></a><span class="sd">            detection and different refinement methods (variance, sum, </span>
</span><span id="CenterDetermination.preprocess-1153"><a href="#CenterDetermination.preprocess-1153"><span class="linenos">1153</span></a><span class="sd">            intensity-based). Currently unused.</span>
</span><span id="CenterDetermination.preprocess-1154"><a href="#CenterDetermination.preprocess-1154"><span class="linenos">1154</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.preprocess-1155"><a href="#CenterDetermination.preprocess-1155"><span class="linenos">1155</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.preprocess-1156"><a href="#CenterDetermination.preprocess-1156"><span class="linenos">1156</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.preprocess-1157"><a href="#CenterDetermination.preprocess-1157"><span class="linenos">1157</span></a><span class="sd">        edges : np.ndarray of bool, optional</span>
</span><span id="CenterDetermination.preprocess-1158"><a href="#CenterDetermination.preprocess-1158"><span class="linenos">1158</span></a><span class="sd">            Edge map obtained using the Canny edge detector, required for Hough</span>
</span><span id="CenterDetermination.preprocess-1159"><a href="#CenterDetermination.preprocess-1159"><span class="linenos">1159</span></a><span class="sd">            transform. Only returned if `preHough` is True.</span>
</span><span id="CenterDetermination.preprocess-1160"><a href="#CenterDetermination.preprocess-1160"><span class="linenos">1160</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.preprocess-1161"><a href="#CenterDetermination.preprocess-1161"><span class="linenos">1161</span></a><span class="sd">        Notes</span>
</span><span id="CenterDetermination.preprocess-1162"><a href="#CenterDetermination.preprocess-1162"><span class="linenos">1162</span></a><span class="sd">        -----</span>
</span><span id="CenterDetermination.preprocess-1163"><a href="#CenterDetermination.preprocess-1163"><span class="linenos">1163</span></a><span class="sd">        This function performs different preprocessing steps depending on the</span>
</span><span id="CenterDetermination.preprocess-1164"><a href="#CenterDetermination.preprocess-1164"><span class="linenos">1164</span></a><span class="sd">        detection/refinement strategy selected. It is modular and supports</span>
</span><span id="CenterDetermination.preprocess-1165"><a href="#CenterDetermination.preprocess-1165"><span class="linenos">1165</span></a><span class="sd">        optional display of intermediate results if `self.parent.verbose` is True.</span>
</span><span id="CenterDetermination.preprocess-1166"><a href="#CenterDetermination.preprocess-1166"><span class="linenos">1166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.preprocess-1167"><a href="#CenterDetermination.preprocess-1167"><span class="linenos">1167</span></a>    
</span><span id="CenterDetermination.preprocess-1168"><a href="#CenterDetermination.preprocess-1168"><span class="linenos">1168</span></a>        <span class="c1"># Flags</span>
</span><span id="CenterDetermination.preprocess-1169"><a href="#CenterDetermination.preprocess-1169"><span class="linenos">1169</span></a>        <span class="n">control_print</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.preprocess-1170"><a href="#CenterDetermination.preprocess-1170"><span class="linenos">1170</span></a>        
</span><span id="CenterDetermination.preprocess-1171"><a href="#CenterDetermination.preprocess-1171"><span class="linenos">1171</span></a>        <span class="c1"># Load original image</span>
</span><span id="CenterDetermination.preprocess-1172"><a href="#CenterDetermination.preprocess-1172"><span class="linenos">1172</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1173"><a href="#CenterDetermination.preprocess-1173"><span class="linenos">1173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1174"><a href="#CenterDetermination.preprocess-1174"><span class="linenos">1174</span></a>            
</span><span id="CenterDetermination.preprocess-1175"><a href="#CenterDetermination.preprocess-1175"><span class="linenos">1175</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1176"><a href="#CenterDetermination.preprocess-1176"><span class="linenos">1176</span></a>        
</span><span id="CenterDetermination.preprocess-1177"><a href="#CenterDetermination.preprocess-1177"><span class="linenos">1177</span></a>        <span class="c1">### After initialization: perform an image enhancement if specified</span>
</span><span id="CenterDetermination.preprocess-1178"><a href="#CenterDetermination.preprocess-1178"><span class="linenos">1178</span></a>        <span class="k">if</span> <span class="n">preInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1179"><a href="#CenterDetermination.preprocess-1179"><span class="linenos">1179</span></a>            <span class="c1"># Enhance diffraction pattern to make it more visible</span>
</span><span id="CenterDetermination.preprocess-1180"><a href="#CenterDetermination.preprocess-1180"><span class="linenos">1180</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1181"><a href="#CenterDetermination.preprocess-1181"><span class="linenos">1181</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1182"><a href="#CenterDetermination.preprocess-1182"><span class="linenos">1182</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Histogram equalized.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1183"><a href="#CenterDetermination.preprocess-1183"><span class="linenos">1183</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">equalize_adapthist</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1184"><a href="#CenterDetermination.preprocess-1184"><span class="linenos">1184</span></a>
</span><span id="CenterDetermination.preprocess-1185"><a href="#CenterDetermination.preprocess-1185"><span class="linenos">1185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="CenterDetermination.preprocess-1186"><a href="#CenterDetermination.preprocess-1186"><span class="linenos">1186</span></a>            <span class="k">return</span>
</span><span id="CenterDetermination.preprocess-1187"><a href="#CenterDetermination.preprocess-1187"><span class="linenos">1187</span></a>        
</span><span id="CenterDetermination.preprocess-1188"><a href="#CenterDetermination.preprocess-1188"><span class="linenos">1188</span></a>        <span class="c1">### Hough transform: perform pre-processing necessary for the detection</span>
</span><span id="CenterDetermination.preprocess-1189"><a href="#CenterDetermination.preprocess-1189"><span class="linenos">1189</span></a>        <span class="k">if</span> <span class="n">preHough</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>           
</span><span id="CenterDetermination.preprocess-1190"><a href="#CenterDetermination.preprocess-1190"><span class="linenos">1190</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1191"><a href="#CenterDetermination.preprocess-1191"><span class="linenos">1191</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination.preprocess-1192"><a href="#CenterDetermination.preprocess-1192"><span class="linenos">1192</span></a>                
</span><span id="CenterDetermination.preprocess-1193"><a href="#CenterDetermination.preprocess-1193"><span class="linenos">1193</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination.preprocess-1194"><a href="#CenterDetermination.preprocess-1194"><span class="linenos">1194</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1195"><a href="#CenterDetermination.preprocess-1195"><span class="linenos">1195</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1196"><a href="#CenterDetermination.preprocess-1196"><span class="linenos">1196</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beamstopper removed.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1197"><a href="#CenterDetermination.preprocess-1197"><span class="linenos">1197</span></a>                    <span class="n">max_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-1198"><a href="#CenterDetermination.preprocess-1198"><span class="linenos">1198</span></a>        
</span><span id="CenterDetermination.preprocess-1199"><a href="#CenterDetermination.preprocess-1199"><span class="linenos">1199</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-1200"><a href="#CenterDetermination.preprocess-1200"><span class="linenos">1200</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-1201"><a href="#CenterDetermination.preprocess-1201"><span class="linenos">1201</span></a>        
</span><span id="CenterDetermination.preprocess-1202"><a href="#CenterDetermination.preprocess-1202"><span class="linenos">1202</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination.preprocess-1203"><a href="#CenterDetermination.preprocess-1203"><span class="linenos">1203</span></a>                    
</span><span id="CenterDetermination.preprocess-1204"><a href="#CenterDetermination.preprocess-1204"><span class="linenos">1204</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination.preprocess-1205"><a href="#CenterDetermination.preprocess-1205"><span class="linenos">1205</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-1206"><a href="#CenterDetermination.preprocess-1206"><span class="linenos">1206</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-1207"><a href="#CenterDetermination.preprocess-1207"><span class="linenos">1207</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-1208"><a href="#CenterDetermination.preprocess-1208"><span class="linenos">1208</span></a>        
</span><span id="CenterDetermination.preprocess-1209"><a href="#CenterDetermination.preprocess-1209"><span class="linenos">1209</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   
</span><span id="CenterDetermination.preprocess-1210"><a href="#CenterDetermination.preprocess-1210"><span class="linenos">1210</span></a>                    
</span><span id="CenterDetermination.preprocess-1211"><a href="#CenterDetermination.preprocess-1211"><span class="linenos">1211</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-1212"><a href="#CenterDetermination.preprocess-1212"><span class="linenos">1212</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1213"><a href="#CenterDetermination.preprocess-1213"><span class="linenos">1213</span></a>                            <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1214"><a href="#CenterDetermination.preprocess-1214"><span class="linenos">1214</span></a>                            <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination.preprocess-1215"><a href="#CenterDetermination.preprocess-1215"><span class="linenos">1215</span></a>                            <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-1216"><a href="#CenterDetermination.preprocess-1216"><span class="linenos">1216</span></a>                    
</span><span id="CenterDetermination.preprocess-1217"><a href="#CenterDetermination.preprocess-1217"><span class="linenos">1217</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination.preprocess-1218"><a href="#CenterDetermination.preprocess-1218"><span class="linenos">1218</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1219"><a href="#CenterDetermination.preprocess-1219"><span class="linenos">1219</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1220"><a href="#CenterDetermination.preprocess-1220"><span class="linenos">1220</span></a>                    
</span><span id="CenterDetermination.preprocess-1221"><a href="#CenterDetermination.preprocess-1221"><span class="linenos">1221</span></a>                    <span class="c1"># Erode the dilated edges</span>
</span><span id="CenterDetermination.preprocess-1222"><a href="#CenterDetermination.preprocess-1222"><span class="linenos">1222</span></a>                    <span class="c1"># to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination.preprocess-1223"><a href="#CenterDetermination.preprocess-1223"><span class="linenos">1223</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1224"><a href="#CenterDetermination.preprocess-1224"><span class="linenos">1224</span></a>
</span><span id="CenterDetermination.preprocess-1225"><a href="#CenterDetermination.preprocess-1225"><span class="linenos">1225</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1226"><a href="#CenterDetermination.preprocess-1226"><span class="linenos">1226</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1227"><a href="#CenterDetermination.preprocess-1227"><span class="linenos">1227</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1228"><a href="#CenterDetermination.preprocess-1228"><span class="linenos">1228</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1229"><a href="#CenterDetermination.preprocess-1229"><span class="linenos">1229</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1230"><a href="#CenterDetermination.preprocess-1230"><span class="linenos">1230</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1231"><a href="#CenterDetermination.preprocess-1231"><span class="linenos">1231</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1232"><a href="#CenterDetermination.preprocess-1232"><span class="linenos">1232</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1233"><a href="#CenterDetermination.preprocess-1233"><span class="linenos">1233</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1234"><a href="#CenterDetermination.preprocess-1234"><span class="linenos">1234</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1235"><a href="#CenterDetermination.preprocess-1235"><span class="linenos">1235</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-1236"><a href="#CenterDetermination.preprocess-1236"><span class="linenos">1236</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1237"><a href="#CenterDetermination.preprocess-1237"><span class="linenos">1237</span></a>                        
</span><span id="CenterDetermination.preprocess-1238"><a href="#CenterDetermination.preprocess-1238"><span class="linenos">1238</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination.preprocess-1239"><a href="#CenterDetermination.preprocess-1239"><span class="linenos">1239</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1240"><a href="#CenterDetermination.preprocess-1240"><span class="linenos">1240</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-1241"><a href="#CenterDetermination.preprocess-1241"><span class="linenos">1241</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No beamstopper.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1242"><a href="#CenterDetermination.preprocess-1242"><span class="linenos">1242</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1243"><a href="#CenterDetermination.preprocess-1243"><span class="linenos">1243</span></a>                                             <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1244"><a href="#CenterDetermination.preprocess-1244"><span class="linenos">1244</span></a>                                             <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1245"><a href="#CenterDetermination.preprocess-1245"><span class="linenos">1245</span></a>                                             <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1246"><a href="#CenterDetermination.preprocess-1246"><span class="linenos">1246</span></a>                    
</span><span id="CenterDetermination.preprocess-1247"><a href="#CenterDetermination.preprocess-1247"><span class="linenos">1247</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination.preprocess-1248"><a href="#CenterDetermination.preprocess-1248"><span class="linenos">1248</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1249"><a href="#CenterDetermination.preprocess-1249"><span class="linenos">1249</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1250"><a href="#CenterDetermination.preprocess-1250"><span class="linenos">1250</span></a>                    
</span><span id="CenterDetermination.preprocess-1251"><a href="#CenterDetermination.preprocess-1251"><span class="linenos">1251</span></a>                    <span class="c1"># Erode the dilated edges</span>
</span><span id="CenterDetermination.preprocess-1252"><a href="#CenterDetermination.preprocess-1252"><span class="linenos">1252</span></a>                    <span class="c1"># to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination.preprocess-1253"><a href="#CenterDetermination.preprocess-1253"><span class="linenos">1253</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1254"><a href="#CenterDetermination.preprocess-1254"><span class="linenos">1254</span></a>                    <span class="n">connected_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
</span><span id="CenterDetermination.preprocess-1255"><a href="#CenterDetermination.preprocess-1255"><span class="linenos">1255</span></a>                        <span class="n">connected_edges</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1256"><a href="#CenterDetermination.preprocess-1256"><span class="linenos">1256</span></a>                        <span class="n">min_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1257"><a href="#CenterDetermination.preprocess-1257"><span class="linenos">1257</span></a>                    
</span><span id="CenterDetermination.preprocess-1258"><a href="#CenterDetermination.preprocess-1258"><span class="linenos">1258</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1259"><a href="#CenterDetermination.preprocess-1259"><span class="linenos">1259</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1260"><a href="#CenterDetermination.preprocess-1260"><span class="linenos">1260</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1261"><a href="#CenterDetermination.preprocess-1261"><span class="linenos">1261</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1262"><a href="#CenterDetermination.preprocess-1262"><span class="linenos">1262</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1263"><a href="#CenterDetermination.preprocess-1263"><span class="linenos">1263</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1264"><a href="#CenterDetermination.preprocess-1264"><span class="linenos">1264</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,)</span>
</span><span id="CenterDetermination.preprocess-1265"><a href="#CenterDetermination.preprocess-1265"><span class="linenos">1265</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1266"><a href="#CenterDetermination.preprocess-1266"><span class="linenos">1266</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1267"><a href="#CenterDetermination.preprocess-1267"><span class="linenos">1267</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1268"><a href="#CenterDetermination.preprocess-1268"><span class="linenos">1268</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-1269"><a href="#CenterDetermination.preprocess-1269"><span class="linenos">1269</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1270"><a href="#CenterDetermination.preprocess-1270"><span class="linenos">1270</span></a>                
</span><span id="CenterDetermination.preprocess-1271"><a href="#CenterDetermination.preprocess-1271"><span class="linenos">1271</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
</span><span id="CenterDetermination.preprocess-1272"><a href="#CenterDetermination.preprocess-1272"><span class="linenos">1272</span></a>                <span class="c1"># Central square extraction</span>
</span><span id="CenterDetermination.preprocess-1273"><a href="#CenterDetermination.preprocess-1273"><span class="linenos">1273</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination.preprocess-1274"><a href="#CenterDetermination.preprocess-1274"><span class="linenos">1274</span></a>
</span><span id="CenterDetermination.preprocess-1275"><a href="#CenterDetermination.preprocess-1275"><span class="linenos">1275</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination.preprocess-1276"><a href="#CenterDetermination.preprocess-1276"><span class="linenos">1276</span></a>                <span class="k">if</span> <span class="mf">0.4</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.6</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1277"><a href="#CenterDetermination.preprocess-1277"><span class="linenos">1277</span></a>                    
</span><span id="CenterDetermination.preprocess-1278"><a href="#CenterDetermination.preprocess-1278"><span class="linenos">1278</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination.preprocess-1279"><a href="#CenterDetermination.preprocess-1279"><span class="linenos">1279</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-1280"><a href="#CenterDetermination.preprocess-1280"><span class="linenos">1280</span></a>    
</span><span id="CenterDetermination.preprocess-1281"><a href="#CenterDetermination.preprocess-1281"><span class="linenos">1281</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-1282"><a href="#CenterDetermination.preprocess-1282"><span class="linenos">1282</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-1283"><a href="#CenterDetermination.preprocess-1283"><span class="linenos">1283</span></a>    
</span><span id="CenterDetermination.preprocess-1284"><a href="#CenterDetermination.preprocess-1284"><span class="linenos">1284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="CenterDetermination.preprocess-1285"><a href="#CenterDetermination.preprocess-1285"><span class="linenos">1285</span></a>                                                     
</span><span id="CenterDetermination.preprocess-1286"><a href="#CenterDetermination.preprocess-1286"><span class="linenos">1286</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-1287"><a href="#CenterDetermination.preprocess-1287"><span class="linenos">1287</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination.preprocess-1288"><a href="#CenterDetermination.preprocess-1288"><span class="linenos">1288</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1289"><a href="#CenterDetermination.preprocess-1289"><span class="linenos">1289</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1290"><a href="#CenterDetermination.preprocess-1290"><span class="linenos">1290</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination.preprocess-1291"><a href="#CenterDetermination.preprocess-1291"><span class="linenos">1291</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-1292"><a href="#CenterDetermination.preprocess-1292"><span class="linenos">1292</span></a>
</span><span id="CenterDetermination.preprocess-1293"><a href="#CenterDetermination.preprocess-1293"><span class="linenos">1293</span></a>                    
</span><span id="CenterDetermination.preprocess-1294"><a href="#CenterDetermination.preprocess-1294"><span class="linenos">1294</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1295"><a href="#CenterDetermination.preprocess-1295"><span class="linenos">1295</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1296"><a href="#CenterDetermination.preprocess-1296"><span class="linenos">1296</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1297"><a href="#CenterDetermination.preprocess-1297"><span class="linenos">1297</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1298"><a href="#CenterDetermination.preprocess-1298"><span class="linenos">1298</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1299"><a href="#CenterDetermination.preprocess-1299"><span class="linenos">1299</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1300"><a href="#CenterDetermination.preprocess-1300"><span class="linenos">1300</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1301"><a href="#CenterDetermination.preprocess-1301"><span class="linenos">1301</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1302"><a href="#CenterDetermination.preprocess-1302"><span class="linenos">1302</span></a>                      <span class="c1">#  ax[1,1].imshow(connected_edges)</span>
</span><span id="CenterDetermination.preprocess-1303"><a href="#CenterDetermination.preprocess-1303"><span class="linenos">1303</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1304"><a href="#CenterDetermination.preprocess-1304"><span class="linenos">1304</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-1305"><a href="#CenterDetermination.preprocess-1305"><span class="linenos">1305</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1306"><a href="#CenterDetermination.preprocess-1306"><span class="linenos">1306</span></a>                    
</span><span id="CenterDetermination.preprocess-1307"><a href="#CenterDetermination.preprocess-1307"><span class="linenos">1307</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination.preprocess-1308"><a href="#CenterDetermination.preprocess-1308"><span class="linenos">1308</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1309"><a href="#CenterDetermination.preprocess-1309"><span class="linenos">1309</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-1310"><a href="#CenterDetermination.preprocess-1310"><span class="linenos">1310</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination.preprocess-1311"><a href="#CenterDetermination.preprocess-1311"><span class="linenos">1311</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1312"><a href="#CenterDetermination.preprocess-1312"><span class="linenos">1312</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-1313"><a href="#CenterDetermination.preprocess-1313"><span class="linenos">1313</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination.preprocess-1314"><a href="#CenterDetermination.preprocess-1314"><span class="linenos">1314</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-1315"><a href="#CenterDetermination.preprocess-1315"><span class="linenos">1315</span></a>
</span><span id="CenterDetermination.preprocess-1316"><a href="#CenterDetermination.preprocess-1316"><span class="linenos">1316</span></a>                    
</span><span id="CenterDetermination.preprocess-1317"><a href="#CenterDetermination.preprocess-1317"><span class="linenos">1317</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-1318"><a href="#CenterDetermination.preprocess-1318"><span class="linenos">1318</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1319"><a href="#CenterDetermination.preprocess-1319"><span class="linenos">1319</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1320"><a href="#CenterDetermination.preprocess-1320"><span class="linenos">1320</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1321"><a href="#CenterDetermination.preprocess-1321"><span class="linenos">1321</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1322"><a href="#CenterDetermination.preprocess-1322"><span class="linenos">1322</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1323"><a href="#CenterDetermination.preprocess-1323"><span class="linenos">1323</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1324"><a href="#CenterDetermination.preprocess-1324"><span class="linenos">1324</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1325"><a href="#CenterDetermination.preprocess-1325"><span class="linenos">1325</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1326"><a href="#CenterDetermination.preprocess-1326"><span class="linenos">1326</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-1327"><a href="#CenterDetermination.preprocess-1327"><span class="linenos">1327</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-1328"><a href="#CenterDetermination.preprocess-1328"><span class="linenos">1328</span></a>            
</span><span id="CenterDetermination.preprocess-1329"><a href="#CenterDetermination.preprocess-1329"><span class="linenos">1329</span></a>            <span class="k">return</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Preprocess the input image based on the selected automatic detection 
and refinement methods.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>preInit</strong> (bool, optional, default=0):
Preprocess the original image using initialization methods such as
histogram equalization (heq) or contrast clipping (icut). This
is used to enhance the input image prior to any detection or
correction.</li>
<li><strong>preHough</strong> (bool, optional, default=0):
Perform preprocessing required for Hough transform-based automatic 
detection. This includes edge detection and handling beamstoppers.</li>
<li><strong>preManual, preVar, preSum, preInt</strong> (bool, optional, default=0):
Placeholder flags for future preprocessing needs for manual 
detection and different refinement methods (variance, sum, 
intensity-based). Currently unused.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>edges</strong> (np.ndarray of bool, optional):
Edge map obtained using the Canny edge detector, required for Hough
transform. Only returned if <code>preHough</code> is True.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function performs different preprocessing steps depending on the
detection/refinement strategy selected. It is modular and supports
optional display of intermediate results if <code>self.parent.verbose</code> is True.</p>
</div>


                            </div>
                            <div id="CenterDetermination.sobel_filt" class="classattr">
                                        <input id="CenterDetermination.sobel_filt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sobel_filt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">disp</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.sobel_filt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.sobel_filt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.sobel_filt-1332"><a href="#CenterDetermination.sobel_filt-1332"><span class="linenos">1332</span></a>    <span class="k">def</span> <span class="nf">sobel_filt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>   
</span><span id="CenterDetermination.sobel_filt-1333"><a href="#CenterDetermination.sobel_filt-1333"><span class="linenos">1333</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.sobel_filt-1334"><a href="#CenterDetermination.sobel_filt-1334"><span class="linenos">1334</span></a><span class="sd">        The Sobel filter, which is a simple 3×3 kernel convolved with the image </span>
</span><span id="CenterDetermination.sobel_filt-1335"><a href="#CenterDetermination.sobel_filt-1335"><span class="linenos">1335</span></a><span class="sd">        which approximates the gradient of intensity in a certain direction. </span>
</span><span id="CenterDetermination.sobel_filt-1336"><a href="#CenterDetermination.sobel_filt-1336"><span class="linenos">1336</span></a><span class="sd">        Since the Sobel filter is a simple matrix, it can be applied across </span>
</span><span id="CenterDetermination.sobel_filt-1337"><a href="#CenterDetermination.sobel_filt-1337"><span class="linenos">1337</span></a><span class="sd">        datasets without concern for effects caused by changing user defined </span>
</span><span id="CenterDetermination.sobel_filt-1338"><a href="#CenterDetermination.sobel_filt-1338"><span class="linenos">1338</span></a><span class="sd">        thresholds, and is much faster and impartial than an iterative method</span>
</span><span id="CenterDetermination.sobel_filt-1339"><a href="#CenterDetermination.sobel_filt-1339"><span class="linenos">1339</span></a>
</span><span id="CenterDetermination.sobel_filt-1340"><a href="#CenterDetermination.sobel_filt-1340"><span class="linenos">1340</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.sobel_filt-1341"><a href="#CenterDetermination.sobel_filt-1341"><span class="linenos">1341</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.sobel_filt-1342"><a href="#CenterDetermination.sobel_filt-1342"><span class="linenos">1342</span></a><span class="sd">        image : TYPE</span>
</span><span id="CenterDetermination.sobel_filt-1343"><a href="#CenterDetermination.sobel_filt-1343"><span class="linenos">1343</span></a><span class="sd">            DESCRIPTION.</span>
</span><span id="CenterDetermination.sobel_filt-1344"><a href="#CenterDetermination.sobel_filt-1344"><span class="linenos">1344</span></a><span class="sd">        disp : TYPE, optional</span>
</span><span id="CenterDetermination.sobel_filt-1345"><a href="#CenterDetermination.sobel_filt-1345"><span class="linenos">1345</span></a><span class="sd">            DESCRIPTION. The default is False.</span>
</span><span id="CenterDetermination.sobel_filt-1346"><a href="#CenterDetermination.sobel_filt-1346"><span class="linenos">1346</span></a>
</span><span id="CenterDetermination.sobel_filt-1347"><a href="#CenterDetermination.sobel_filt-1347"><span class="linenos">1347</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.sobel_filt-1348"><a href="#CenterDetermination.sobel_filt-1348"><span class="linenos">1348</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.sobel_filt-1349"><a href="#CenterDetermination.sobel_filt-1349"><span class="linenos">1349</span></a><span class="sd">        sobel_magnitude : TYPE</span>
</span><span id="CenterDetermination.sobel_filt-1350"><a href="#CenterDetermination.sobel_filt-1350"><span class="linenos">1350</span></a><span class="sd">            DESCRIPTION.</span>
</span><span id="CenterDetermination.sobel_filt-1351"><a href="#CenterDetermination.sobel_filt-1351"><span class="linenos">1351</span></a>
</span><span id="CenterDetermination.sobel_filt-1352"><a href="#CenterDetermination.sobel_filt-1352"><span class="linenos">1352</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.sobel_filt-1353"><a href="#CenterDetermination.sobel_filt-1353"><span class="linenos">1353</span></a>        <span class="c1"># Apply Sobel filter</span>
</span><span id="CenterDetermination.sobel_filt-1354"><a href="#CenterDetermination.sobel_filt-1354"><span class="linenos">1354</span></a>        <span class="n">sobel_x</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination.sobel_filt-1355"><a href="#CenterDetermination.sobel_filt-1355"><span class="linenos">1355</span></a>                            <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> 
</span><span id="CenterDetermination.sobel_filt-1356"><a href="#CenterDetermination.sobel_filt-1356"><span class="linenos">1356</span></a>                            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
</span><span id="CenterDetermination.sobel_filt-1357"><a href="#CenterDetermination.sobel_filt-1357"><span class="linenos">1357</span></a>                            <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Horizontal edges</span>
</span><span id="CenterDetermination.sobel_filt-1358"><a href="#CenterDetermination.sobel_filt-1358"><span class="linenos">1358</span></a>        <span class="n">sobel_y</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination.sobel_filt-1359"><a href="#CenterDetermination.sobel_filt-1359"><span class="linenos">1359</span></a>                            <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> 
</span><span id="CenterDetermination.sobel_filt-1360"><a href="#CenterDetermination.sobel_filt-1360"><span class="linenos">1360</span></a>                            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="CenterDetermination.sobel_filt-1361"><a href="#CenterDetermination.sobel_filt-1361"><span class="linenos">1361</span></a>                            <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Vertical edges</span>
</span><span id="CenterDetermination.sobel_filt-1362"><a href="#CenterDetermination.sobel_filt-1362"><span class="linenos">1362</span></a>        
</span><span id="CenterDetermination.sobel_filt-1363"><a href="#CenterDetermination.sobel_filt-1363"><span class="linenos">1363</span></a>        <span class="c1"># # Take absolute values to remove negatives</span>
</span><span id="CenterDetermination.sobel_filt-1364"><a href="#CenterDetermination.sobel_filt-1364"><span class="linenos">1364</span></a>        <span class="c1"># sobel_x = np.abs(sobel_x)</span>
</span><span id="CenterDetermination.sobel_filt-1365"><a href="#CenterDetermination.sobel_filt-1365"><span class="linenos">1365</span></a>        <span class="c1"># sobel_y = np.abs(sobel_y)</span>
</span><span id="CenterDetermination.sobel_filt-1366"><a href="#CenterDetermination.sobel_filt-1366"><span class="linenos">1366</span></a>
</span><span id="CenterDetermination.sobel_filt-1367"><a href="#CenterDetermination.sobel_filt-1367"><span class="linenos">1367</span></a>        
</span><span id="CenterDetermination.sobel_filt-1368"><a href="#CenterDetermination.sobel_filt-1368"><span class="linenos">1368</span></a>        <span class="c1"># Compute gradient magnitude</span>
</span><span id="CenterDetermination.sobel_filt-1369"><a href="#CenterDetermination.sobel_filt-1369"><span class="linenos">1369</span></a>        <span class="n">sobel_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sobel_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sobel_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.sobel_filt-1370"><a href="#CenterDetermination.sobel_filt-1370"><span class="linenos">1370</span></a>        
</span><span id="CenterDetermination.sobel_filt-1371"><a href="#CenterDetermination.sobel_filt-1371"><span class="linenos">1371</span></a>        <span class="c1"># Normalize</span>
</span><span id="CenterDetermination.sobel_filt-1372"><a href="#CenterDetermination.sobel_filt-1372"><span class="linenos">1372</span></a>        <span class="n">sobel_magnitude</span> <span class="o">=</span> \
</span><span id="CenterDetermination.sobel_filt-1373"><a href="#CenterDetermination.sobel_filt-1373"><span class="linenos">1373</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">sobel_magnitude</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sobel_magnitude</span><span class="p">))</span>  
</span><span id="CenterDetermination.sobel_filt-1374"><a href="#CenterDetermination.sobel_filt-1374"><span class="linenos">1374</span></a>        
</span><span id="CenterDetermination.sobel_filt-1375"><a href="#CenterDetermination.sobel_filt-1375"><span class="linenos">1375</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination.sobel_filt-1376"><a href="#CenterDetermination.sobel_filt-1376"><span class="linenos">1376</span></a>            <span class="c1"># Display results</span>
</span><span id="CenterDetermination.sobel_filt-1377"><a href="#CenterDetermination.sobel_filt-1377"><span class="linenos">1377</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="CenterDetermination.sobel_filt-1378"><a href="#CenterDetermination.sobel_filt-1378"><span class="linenos">1378</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span><span id="CenterDetermination.sobel_filt-1379"><a href="#CenterDetermination.sobel_filt-1379"><span class="linenos">1379</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_x</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span> 
</span><span id="CenterDetermination.sobel_filt-1380"><a href="#CenterDetermination.sobel_filt-1380"><span class="linenos">1380</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sobel X&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.sobel_filt-1381"><a href="#CenterDetermination.sobel_filt-1381"><span class="linenos">1381</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="CenterDetermination.sobel_filt-1382"><a href="#CenterDetermination.sobel_filt-1382"><span class="linenos">1382</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_y</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span>
</span><span id="CenterDetermination.sobel_filt-1383"><a href="#CenterDetermination.sobel_filt-1383"><span class="linenos">1383</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sobel Y&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.sobel_filt-1384"><a href="#CenterDetermination.sobel_filt-1384"><span class="linenos">1384</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
</span><span id="CenterDetermination.sobel_filt-1385"><a href="#CenterDetermination.sobel_filt-1385"><span class="linenos">1385</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_magnitude</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">),</span> 
</span><span id="CenterDetermination.sobel_filt-1386"><a href="#CenterDetermination.sobel_filt-1386"><span class="linenos">1386</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gradient Magnitude&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.sobel_filt-1387"><a href="#CenterDetermination.sobel_filt-1387"><span class="linenos">1387</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.sobel_filt-1388"><a href="#CenterDetermination.sobel_filt-1388"><span class="linenos">1388</span></a>        
</span><span id="CenterDetermination.sobel_filt-1389"><a href="#CenterDetermination.sobel_filt-1389"><span class="linenos">1389</span></a>        <span class="k">return</span> <span class="n">sobel_magnitude</span>
</span></pre></div>


            <div class="docstring"><p>The Sobel filter, which is a simple 3×3 kernel convolved with the image 
which approximates the gradient of intensity in a certain direction. 
Since the Sobel filter is a simple matrix, it can be applied across 
datasets without concern for effects caused by changing user defined 
thresholds, and is much faster and impartial than an iterative method</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>image</strong> (TYPE):
DESCRIPTION.</li>
<li><strong>disp</strong> (TYPE, optional):
DESCRIPTION. The default is False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>sobel_magnitude</strong> (TYPE):
DESCRIPTION.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_phase" class="classattr">
                                        <input id="CenterDetermination.detection_phase-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_phase</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">sobel</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">disp</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">masking</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_phase-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_phase"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_phase-1392"><a href="#CenterDetermination.detection_phase-1392"><span class="linenos">1392</span></a>    <span class="k">def</span> <span class="nf">detection_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_phase-1393"><a href="#CenterDetermination.detection_phase-1393"><span class="linenos">1393</span></a>                        <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">masking</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_phase-1394"><a href="#CenterDetermination.detection_phase-1394"><span class="linenos">1394</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_phase-1395"><a href="#CenterDetermination.detection_phase-1395"><span class="linenos">1395</span></a><span class="sd">        Detects the center of symmetry in a diffraction image using a </span>
</span><span id="CenterDetermination.detection_phase-1396"><a href="#CenterDetermination.detection_phase-1396"><span class="linenos">1396</span></a><span class="sd">        combination of weighted intensity averaging and phase cross-correlation.</span>
</span><span id="CenterDetermination.detection_phase-1397"><a href="#CenterDetermination.detection_phase-1397"><span class="linenos">1397</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_phase-1398"><a href="#CenterDetermination.detection_phase-1398"><span class="linenos">1398</span></a><span class="sd">        This method performs the following steps:</span>
</span><span id="CenterDetermination.detection_phase-1399"><a href="#CenterDetermination.detection_phase-1399"><span class="linenos">1399</span></a><span class="sd">            1. Estimates an initial center using a weighted average of pixel </span>
</span><span id="CenterDetermination.detection_phase-1400"><a href="#CenterDetermination.detection_phase-1400"><span class="linenos">1400</span></a><span class="sd">               intensities.</span>
</span><span id="CenterDetermination.detection_phase-1401"><a href="#CenterDetermination.detection_phase-1401"><span class="linenos">1401</span></a><span class="sd">            2. Crops the image to focus on its central region.</span>
</span><span id="CenterDetermination.detection_phase-1402"><a href="#CenterDetermination.detection_phase-1402"><span class="linenos">1402</span></a><span class="sd">            3. Optionally normalizes the background to mitigate experimental </span>
</span><span id="CenterDetermination.detection_phase-1403"><a href="#CenterDetermination.detection_phase-1403"><span class="linenos">1403</span></a><span class="sd">               artifacts.</span>
</span><span id="CenterDetermination.detection_phase-1404"><a href="#CenterDetermination.detection_phase-1404"><span class="linenos">1404</span></a><span class="sd">            4. Computes a refined center via inversion symmetry and phase </span>
</span><span id="CenterDetermination.detection_phase-1405"><a href="#CenterDetermination.detection_phase-1405"><span class="linenos">1405</span></a><span class="sd">               cross-correlation.</span>
</span><span id="CenterDetermination.detection_phase-1406"><a href="#CenterDetermination.detection_phase-1406"><span class="linenos">1406</span></a><span class="sd">            5. Returns the final refined center coordinates.</span>
</span><span id="CenterDetermination.detection_phase-1407"><a href="#CenterDetermination.detection_phase-1407"><span class="linenos">1407</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_phase-1408"><a href="#CenterDetermination.detection_phase-1408"><span class="linenos">1408</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_phase-1409"><a href="#CenterDetermination.detection_phase-1409"><span class="linenos">1409</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_phase-1410"><a href="#CenterDetermination.detection_phase-1410"><span class="linenos">1410</span></a><span class="sd">        normalize_bg : bool, optional, default=True</span>
</span><span id="CenterDetermination.detection_phase-1411"><a href="#CenterDetermination.detection_phase-1411"><span class="linenos">1411</span></a><span class="sd">            If True, normalize background intensity to reduce artifacts.</span>
</span><span id="CenterDetermination.detection_phase-1412"><a href="#CenterDetermination.detection_phase-1412"><span class="linenos">1412</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_phase-1413"><a href="#CenterDetermination.detection_phase-1413"><span class="linenos">1413</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="CenterDetermination.detection_phase-1414"><a href="#CenterDetermination.detection_phase-1414"><span class="linenos">1414</span></a><span class="sd">            If True, applies Sobel filtering (currently unused if not implemented)</span>
</span><span id="CenterDetermination.detection_phase-1415"><a href="#CenterDetermination.detection_phase-1415"><span class="linenos">1415</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_phase-1416"><a href="#CenterDetermination.detection_phase-1416"><span class="linenos">1416</span></a><span class="sd">        disp : bool, optional, default=False</span>
</span><span id="CenterDetermination.detection_phase-1417"><a href="#CenterDetermination.detection_phase-1417"><span class="linenos">1417</span></a><span class="sd">            If True, displays intermediate processing results. </span>
</span><span id="CenterDetermination.detection_phase-1418"><a href="#CenterDetermination.detection_phase-1418"><span class="linenos">1418</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_phase-1419"><a href="#CenterDetermination.detection_phase-1419"><span class="linenos">1419</span></a><span class="sd">        masking : bool, optional, default=True</span>
</span><span id="CenterDetermination.detection_phase-1420"><a href="#CenterDetermination.detection_phase-1420"><span class="linenos">1420</span></a><span class="sd">            If True, applies masking to exclude unwanted regions from analysis</span>
</span><span id="CenterDetermination.detection_phase-1421"><a href="#CenterDetermination.detection_phase-1421"><span class="linenos">1421</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_phase-1422"><a href="#CenterDetermination.detection_phase-1422"><span class="linenos">1422</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_phase-1423"><a href="#CenterDetermination.detection_phase-1423"><span class="linenos">1423</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_phase-1424"><a href="#CenterDetermination.detection_phase-1424"><span class="linenos">1424</span></a><span class="sd">        r_final : float</span>
</span><span id="CenterDetermination.detection_phase-1425"><a href="#CenterDetermination.detection_phase-1425"><span class="linenos">1425</span></a><span class="sd">            Estimated row-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination.detection_phase-1426"><a href="#CenterDetermination.detection_phase-1426"><span class="linenos">1426</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_phase-1427"><a href="#CenterDetermination.detection_phase-1427"><span class="linenos">1427</span></a><span class="sd">        c_final : float</span>
</span><span id="CenterDetermination.detection_phase-1428"><a href="#CenterDetermination.detection_phase-1428"><span class="linenos">1428</span></a><span class="sd">            Estimated column-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination.detection_phase-1429"><a href="#CenterDetermination.detection_phase-1429"><span class="linenos">1429</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_phase-1430"><a href="#CenterDetermination.detection_phase-1430"><span class="linenos">1430</span></a><span class="sd">        None : NoneType</span>
</span><span id="CenterDetermination.detection_phase-1431"><a href="#CenterDetermination.detection_phase-1431"><span class="linenos">1431</span></a><span class="sd">            Placeholder for future functionality (e.g., radius estimation).</span>
</span><span id="CenterDetermination.detection_phase-1432"><a href="#CenterDetermination.detection_phase-1432"><span class="linenos">1432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_phase-1433"><a href="#CenterDetermination.detection_phase-1433"><span class="linenos">1433</span></a>        <span class="c1"># (1) Get image  ------------------------------------------------------</span>
</span><span id="CenterDetermination.detection_phase-1434"><a href="#CenterDetermination.detection_phase-1434"><span class="linenos">1434</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1435"><a href="#CenterDetermination.detection_phase-1435"><span class="linenos">1435</span></a>        
</span><span id="CenterDetermination.detection_phase-1436"><a href="#CenterDetermination.detection_phase-1436"><span class="linenos">1436</span></a>        <span class="c1"># if Sobel==True, perform Sobel filtration</span>
</span><span id="CenterDetermination.detection_phase-1437"><a href="#CenterDetermination.detection_phase-1437"><span class="linenos">1437</span></a>        <span class="c1"># https://doi.org/10.1016/j.ultramic.2016.12.021</span>
</span><span id="CenterDetermination.detection_phase-1438"><a href="#CenterDetermination.detection_phase-1438"><span class="linenos">1438</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_phase-1439"><a href="#CenterDetermination.detection_phase-1439"><span class="linenos">1439</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">disp</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1440"><a href="#CenterDetermination.detection_phase-1440"><span class="linenos">1440</span></a>        
</span><span id="CenterDetermination.detection_phase-1441"><a href="#CenterDetermination.detection_phase-1441"><span class="linenos">1441</span></a>        
</span><span id="CenterDetermination.detection_phase-1442"><a href="#CenterDetermination.detection_phase-1442"><span class="linenos">1442</span></a>        <span class="c1"># shift the pixel values (smallest value is zero -&gt; non-negative image)</span>
</span><span id="CenterDetermination.detection_phase-1443"><a href="#CenterDetermination.detection_phase-1443"><span class="linenos">1443</span></a>        <span class="n">image</span> <span class="o">-=</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_phase-1444"><a href="#CenterDetermination.detection_phase-1444"><span class="linenos">1444</span></a>
</span><span id="CenterDetermination.detection_phase-1445"><a href="#CenterDetermination.detection_phase-1445"><span class="linenos">1445</span></a>        <span class="c1"># (2) Prepare mask and compute weighted center ------------------------</span>
</span><span id="CenterDetermination.detection_phase-1446"><a href="#CenterDetermination.detection_phase-1446"><span class="linenos">1446</span></a>        <span class="k">if</span> <span class="n">masking</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_phase-1447"><a href="#CenterDetermination.detection_phase-1447"><span class="linenos">1447</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_masking</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_phase-1448"><a href="#CenterDetermination.detection_phase-1448"><span class="linenos">1448</span></a>            <span class="c1"># print(&quot;masked&quot;)</span>
</span><span id="CenterDetermination.detection_phase-1449"><a href="#CenterDetermination.detection_phase-1449"><span class="linenos">1449</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># binary mask</span>
</span><span id="CenterDetermination.detection_phase-1450"><a href="#CenterDetermination.detection_phase-1450"><span class="linenos">1450</span></a>        
</span><span id="CenterDetermination.detection_phase-1451"><a href="#CenterDetermination.detection_phase-1451"><span class="linenos">1451</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">image</span>                        <span class="c1"># </span>
</span><span id="CenterDetermination.detection_phase-1452"><a href="#CenterDetermination.detection_phase-1452"><span class="linenos">1452</span></a>        
</span><span id="CenterDetermination.detection_phase-1453"><a href="#CenterDetermination.detection_phase-1453"><span class="linenos">1453</span></a>        <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>       <span class="c1"># matrices of row/col indices</span>
</span><span id="CenterDetermination.detection_phase-1454"><a href="#CenterDetermination.detection_phase-1454"><span class="linenos">1454</span></a>
</span><span id="CenterDetermination.detection_phase-1455"><a href="#CenterDetermination.detection_phase-1455"><span class="linenos">1455</span></a>        <span class="c1"># Weighted center of mass (brighter pixels contribute more)</span>
</span><span id="CenterDetermination.detection_phase-1456"><a href="#CenterDetermination.detection_phase-1456"><span class="linenos">1456</span></a>        <span class="c1"># This gives an initial estimate of the center (r_, c_).</span>
</span><span id="CenterDetermination.detection_phase-1457"><a href="#CenterDetermination.detection_phase-1457"><span class="linenos">1457</span></a>        <span class="n">r_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
</span><span id="CenterDetermination.detection_phase-1458"><a href="#CenterDetermination.detection_phase-1458"><span class="linenos">1458</span></a>        <span class="n">c_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
</span><span id="CenterDetermination.detection_phase-1459"><a href="#CenterDetermination.detection_phase-1459"><span class="linenos">1459</span></a>
</span><span id="CenterDetermination.detection_phase-1460"><a href="#CenterDetermination.detection_phase-1460"><span class="linenos">1460</span></a>        <span class="c1"># (3) Crop the image around the estimated center ----------------------</span>
</span><span id="CenterDetermination.detection_phase-1461"><a href="#CenterDetermination.detection_phase-1461"><span class="linenos">1461</span></a>        <span class="c1"># Some diffraction patterns are not centered, and so there&#39;s a lot of </span>
</span><span id="CenterDetermination.detection_phase-1462"><a href="#CenterDetermination.detection_phase-1462"><span class="linenos">1462</span></a>        <span class="c1"># image area that cannot be used for registration.</span>
</span><span id="CenterDetermination.detection_phase-1463"><a href="#CenterDetermination.detection_phase-1463"><span class="linenos">1463</span></a>        <span class="c1"># Radial inversion becomes simple inversion of dimensions</span>
</span><span id="CenterDetermination.detection_phase-1464"><a href="#CenterDetermination.detection_phase-1464"><span class="linenos">1464</span></a>        <span class="n">side_length</span> <span class="o">=</span> \
</span><span id="CenterDetermination.detection_phase-1465"><a href="#CenterDetermination.detection_phase-1465"><span class="linenos">1465</span></a>            <span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">r_</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">r_</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">c_</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">c_</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
</span><span id="CenterDetermination.detection_phase-1466"><a href="#CenterDetermination.detection_phase-1466"><span class="linenos">1466</span></a>        <span class="n">rs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">r_</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">r_</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1467"><a href="#CenterDetermination.detection_phase-1467"><span class="linenos">1467</span></a>        <span class="n">cs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">c_</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">c_</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1468"><a href="#CenterDetermination.detection_phase-1468"><span class="linenos">1468</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">rs</span><span class="p">,</span> <span class="n">cs</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_phase-1469"><a href="#CenterDetermination.detection_phase-1469"><span class="linenos">1469</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">rs</span><span class="p">,</span> <span class="n">cs</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_phase-1470"><a href="#CenterDetermination.detection_phase-1470"><span class="linenos">1470</span></a>    
</span><span id="CenterDetermination.detection_phase-1471"><a href="#CenterDetermination.detection_phase-1471"><span class="linenos">1471</span></a>        <span class="c1"># (4) Normalize background intensity (optional) -----------------------</span>
</span><span id="CenterDetermination.detection_phase-1472"><a href="#CenterDetermination.detection_phase-1472"><span class="linenos">1472</span></a>        <span class="c1"># This step removes intensity variations due to experimental artifacts, </span>
</span><span id="CenterDetermination.detection_phase-1473"><a href="#CenterDetermination.detection_phase-1473"><span class="linenos">1473</span></a>        <span class="c1"># such as uneven illumination.</span>
</span><span id="CenterDetermination.detection_phase-1474"><a href="#CenterDetermination.detection_phase-1474"><span class="linenos">1474</span></a>        <span class="k">if</span> <span class="n">normalize_bg</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_phase-1475"><a href="#CenterDetermination.detection_phase-1475"><span class="linenos">1475</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="CenterDetermination.detection_phase-1476"><a href="#CenterDetermination.detection_phase-1476"><span class="linenos">1476</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1477"><a href="#CenterDetermination.detection_phase-1477"><span class="linenos">1477</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># float64 before division</span>
</span><span id="CenterDetermination.detection_phase-1478"><a href="#CenterDetermination.detection_phase-1478"><span class="linenos">1478</span></a>                <span class="n">image</span> <span class="o">/=</span> <span class="n">gaussian_filter</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_phase-1479"><a href="#CenterDetermination.detection_phase-1479"><span class="linenos">1479</span></a>                    <span class="nb">input</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1480"><a href="#CenterDetermination.detection_phase-1480"><span class="linenos">1480</span></a>        
</span><span id="CenterDetermination.detection_phase-1481"><a href="#CenterDetermination.detection_phase-1481"><span class="linenos">1481</span></a>        <span class="c1"># Replace NaN values with 0s</span>
</span><span id="CenterDetermination.detection_phase-1482"><a href="#CenterDetermination.detection_phase-1482"><span class="linenos">1482</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1483"><a href="#CenterDetermination.detection_phase-1483"><span class="linenos">1483</span></a>
</span><span id="CenterDetermination.detection_phase-1484"><a href="#CenterDetermination.detection_phase-1484"><span class="linenos">1484</span></a>
</span><span id="CenterDetermination.detection_phase-1485"><a href="#CenterDetermination.detection_phase-1485"><span class="linenos">1485</span></a>        <span class="c1"># (5) Compute inversion symmetry using Fourier methods ----------------</span>
</span><span id="CenterDetermination.detection_phase-1486"><a href="#CenterDetermination.detection_phase-1486"><span class="linenos">1486</span></a>        <span class="c1"># an inverted copy of the image (im_i) and mask (mask_i), </span>
</span><span id="CenterDetermination.detection_phase-1487"><a href="#CenterDetermination.detection_phase-1487"><span class="linenos">1487</span></a>        <span class="c1"># flipping both horizontally and vertically ::-1</span>
</span><span id="CenterDetermination.detection_phase-1488"><a href="#CenterDetermination.detection_phase-1488"><span class="linenos">1488</span></a>        <span class="n">im_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_phase-1489"><a href="#CenterDetermination.detection_phase-1489"><span class="linenos">1489</span></a>        <span class="n">mask_i</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_phase-1490"><a href="#CenterDetermination.detection_phase-1490"><span class="linenos">1490</span></a>
</span><span id="CenterDetermination.detection_phase-1491"><a href="#CenterDetermination.detection_phase-1491"><span class="linenos">1491</span></a>        <span class="c1"># downsampling to speed up processing (for too large images)</span>
</span><span id="CenterDetermination.detection_phase-1492"><a href="#CenterDetermination.detection_phase-1492"><span class="linenos">1492</span></a>        <span class="n">downsampling</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.detection_phase-1493"><a href="#CenterDetermination.detection_phase-1493"><span class="linenos">1493</span></a>        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_phase-1494"><a href="#CenterDetermination.detection_phase-1494"><span class="linenos">1494</span></a>            <span class="n">downsampling</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_phase-1495"><a href="#CenterDetermination.detection_phase-1495"><span class="linenos">1495</span></a>    
</span><span id="CenterDetermination.detection_phase-1496"><a href="#CenterDetermination.detection_phase-1496"><span class="linenos">1496</span></a>        <span class="c1"># phase cross-correlation finds the best alignment between the image</span>
</span><span id="CenterDetermination.detection_phase-1497"><a href="#CenterDetermination.detection_phase-1497"><span class="linenos">1497</span></a>        <span class="c1"># and its inverted copy</span>
</span><span id="CenterDetermination.detection_phase-1498"><a href="#CenterDetermination.detection_phase-1498"><span class="linenos">1498</span></a>        <span class="c1"># the shift tells us how much the center is offset from perfect </span>
</span><span id="CenterDetermination.detection_phase-1499"><a href="#CenterDetermination.detection_phase-1499"><span class="linenos">1499</span></a>        <span class="c1"># inversion symmetry.</span>
</span><span id="CenterDetermination.detection_phase-1500"><a href="#CenterDetermination.detection_phase-1500"><span class="linenos">1500</span></a>        <span class="n">shift</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_fft</span><span class="p">(</span><span class="n">phase_cross_correlation</span><span class="p">)(</span>
</span><span id="CenterDetermination.detection_phase-1501"><a href="#CenterDetermination.detection_phase-1501"><span class="linenos">1501</span></a>            <span class="n">reference_image</span><span class="o">=</span><span class="n">image</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination.detection_phase-1502"><a href="#CenterDetermination.detection_phase-1502"><span class="linenos">1502</span></a>            <span class="n">moving_image</span><span class="o">=</span><span class="n">im_i</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination.detection_phase-1503"><a href="#CenterDetermination.detection_phase-1503"><span class="linenos">1503</span></a>            <span class="n">reference_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination.detection_phase-1504"><a href="#CenterDetermination.detection_phase-1504"><span class="linenos">1504</span></a>            <span class="n">moving_mask</span><span class="o">=</span><span class="n">mask_i</span><span class="p">[::</span><span class="n">downsampling</span><span class="p">,</span> <span class="p">::</span><span class="n">downsampling</span><span class="p">],</span>
</span><span id="CenterDetermination.detection_phase-1505"><a href="#CenterDetermination.detection_phase-1505"><span class="linenos">1505</span></a>        <span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1506"><a href="#CenterDetermination.detection_phase-1506"><span class="linenos">1506</span></a>        
</span><span id="CenterDetermination.detection_phase-1507"><a href="#CenterDetermination.detection_phase-1507"><span class="linenos">1507</span></a>        <span class="c1"># The computed shift is rescaled to match the original image resolution.</span>
</span><span id="CenterDetermination.detection_phase-1508"><a href="#CenterDetermination.detection_phase-1508"><span class="linenos">1508</span></a>        <span class="n">correction</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="n">downsampling</span>
</span><span id="CenterDetermination.detection_phase-1509"><a href="#CenterDetermination.detection_phase-1509"><span class="linenos">1509</span></a>
</span><span id="CenterDetermination.detection_phase-1510"><a href="#CenterDetermination.detection_phase-1510"><span class="linenos">1510</span></a>
</span><span id="CenterDetermination.detection_phase-1511"><a href="#CenterDetermination.detection_phase-1511"><span class="linenos">1511</span></a>        <span class="c1"># (6) User information (if required) ----------------------------------</span>
</span><span id="CenterDetermination.detection_phase-1512"><a href="#CenterDetermination.detection_phase-1512"><span class="linenos">1512</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_phase-1513"><a href="#CenterDetermination.detection_phase-1513"><span class="linenos">1513</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="CenterDetermination.detection_phase-1514"><a href="#CenterDetermination.detection_phase-1514"><span class="linenos">1514</span></a>                <span class="s2">&quot;Center Determination (PhaseCorrCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.detection_phase-1515"><a href="#CenterDetermination.detection_phase-1515"><span class="linenos">1515</span></a>        
</span><span id="CenterDetermination.detection_phase-1516"><a href="#CenterDetermination.detection_phase-1516"><span class="linenos">1516</span></a>        <span class="c1"># Ensure correction is a tuple or list before extracting elements</span>
</span><span id="CenterDetermination.detection_phase-1517"><a href="#CenterDetermination.detection_phase-1517"><span class="linenos">1517</span></a>        <span class="n">correction_r</span><span class="p">,</span> <span class="n">correction_c</span> <span class="o">=</span> <span class="n">correction</span> \
</span><span id="CenterDetermination.detection_phase-1518"><a href="#CenterDetermination.detection_phase-1518"><span class="linenos">1518</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correction</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> \
</span><span id="CenterDetermination.detection_phase-1519"><a href="#CenterDetermination.detection_phase-1519"><span class="linenos">1519</span></a>                <span class="k">else</span> <span class="p">(</span><span class="n">correction</span><span class="p">,</span> <span class="n">correction</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_phase-1520"><a href="#CenterDetermination.detection_phase-1520"><span class="linenos">1520</span></a>        
</span><span id="CenterDetermination.detection_phase-1521"><a href="#CenterDetermination.detection_phase-1521"><span class="linenos">1521</span></a>        <span class="n">r_final</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">+</span> <span class="n">correction_r</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_phase-1522"><a href="#CenterDetermination.detection_phase-1522"><span class="linenos">1522</span></a>        <span class="n">c_final</span> <span class="o">=</span> <span class="n">c_</span> <span class="o">+</span> <span class="n">correction_c</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_phase-1523"><a href="#CenterDetermination.detection_phase-1523"><span class="linenos">1523</span></a>                
</span><span id="CenterDetermination.detection_phase-1524"><a href="#CenterDetermination.detection_phase-1524"><span class="linenos">1524</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">r_final</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c_final</span><span class="p">),</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Detects the center of symmetry in a diffraction image using a 
combination of weighted intensity averaging and phase cross-correlation.</p>

<p>This method performs the following steps:
    1. Estimates an initial center using a weighted average of pixel 
       intensities.
    2. Crops the image to focus on its central region.
    3. Optionally normalizes the background to mitigate experimental 
       artifacts.
    4. Computes a refined center via inversion symmetry and phase 
       cross-correlation.
    5. Returns the final refined center coordinates.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>normalize_bg</strong> (bool, optional, default=True):
If True, normalize background intensity to reduce artifacts.</li>
<li><strong>sobel</strong> (bool, optional, default=False):
If True, applies Sobel filtering (currently unused if not implemented)</li>
<li><strong>disp</strong> (bool, optional, default=False):
If True, displays intermediate processing results.</li>
<li><strong>masking</strong> (bool, optional, default=True):
If True, applies masking to exclude unwanted regions from analysis</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>r_final</strong> (float):
Estimated row-coordinate of the image center after refinement.</li>
<li><strong>c_final</strong> (float):
Estimated column-coordinate of the image center after refinement.</li>
<li><strong>None</strong> (NoneType):
Placeholder for future functionality (e.g., radius estimation).</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_crosscorr" class="classattr">
                                        <input id="CenterDetermination.detection_crosscorr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_crosscorr</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">sobel</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">disp</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_crosscorr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_crosscorr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_crosscorr-1527"><a href="#CenterDetermination.detection_crosscorr-1527"><span class="linenos">1527</span></a>    <span class="k">def</span> <span class="nf">detection_crosscorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_crosscorr-1528"><a href="#CenterDetermination.detection_crosscorr-1528"><span class="linenos">1528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_crosscorr-1529"><a href="#CenterDetermination.detection_crosscorr-1529"><span class="linenos">1529</span></a><span class="sd">        Detects the center of symmetry in a diffraction image using a </span>
</span><span id="CenterDetermination.detection_crosscorr-1530"><a href="#CenterDetermination.detection_crosscorr-1530"><span class="linenos">1530</span></a><span class="sd">        combination of weighted intensity averaging and cross-correlation.</span>
</span><span id="CenterDetermination.detection_crosscorr-1531"><a href="#CenterDetermination.detection_crosscorr-1531"><span class="linenos">1531</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_crosscorr-1532"><a href="#CenterDetermination.detection_crosscorr-1532"><span class="linenos">1532</span></a><span class="sd">        This method performs the following steps:</span>
</span><span id="CenterDetermination.detection_crosscorr-1533"><a href="#CenterDetermination.detection_crosscorr-1533"><span class="linenos">1533</span></a><span class="sd">            1. Estimates an initial center using the weighted average of pixel</span>
</span><span id="CenterDetermination.detection_crosscorr-1534"><a href="#CenterDetermination.detection_crosscorr-1534"><span class="linenos">1534</span></a><span class="sd">               intensities.</span>
</span><span id="CenterDetermination.detection_crosscorr-1535"><a href="#CenterDetermination.detection_crosscorr-1535"><span class="linenos">1535</span></a><span class="sd">            2. Crops the image to focus on its central region.</span>
</span><span id="CenterDetermination.detection_crosscorr-1536"><a href="#CenterDetermination.detection_crosscorr-1536"><span class="linenos">1536</span></a><span class="sd">            3. Optionally normalizes the background to reduce experimental</span>
</span><span id="CenterDetermination.detection_crosscorr-1537"><a href="#CenterDetermination.detection_crosscorr-1537"><span class="linenos">1537</span></a><span class="sd">               artifacts.</span>
</span><span id="CenterDetermination.detection_crosscorr-1538"><a href="#CenterDetermination.detection_crosscorr-1538"><span class="linenos">1538</span></a><span class="sd">            4. Computes a refined center by analyzing inversion symmetry </span>
</span><span id="CenterDetermination.detection_crosscorr-1539"><a href="#CenterDetermination.detection_crosscorr-1539"><span class="linenos">1539</span></a><span class="sd">               using cross-correlation.</span>
</span><span id="CenterDetermination.detection_crosscorr-1540"><a href="#CenterDetermination.detection_crosscorr-1540"><span class="linenos">1540</span></a><span class="sd">            5. Returns the final corrected center coordinates.</span>
</span><span id="CenterDetermination.detection_crosscorr-1541"><a href="#CenterDetermination.detection_crosscorr-1541"><span class="linenos">1541</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_crosscorr-1542"><a href="#CenterDetermination.detection_crosscorr-1542"><span class="linenos">1542</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_crosscorr-1543"><a href="#CenterDetermination.detection_crosscorr-1543"><span class="linenos">1543</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_crosscorr-1544"><a href="#CenterDetermination.detection_crosscorr-1544"><span class="linenos">1544</span></a><span class="sd">        normalize_bg : bool, optional, default=True</span>
</span><span id="CenterDetermination.detection_crosscorr-1545"><a href="#CenterDetermination.detection_crosscorr-1545"><span class="linenos">1545</span></a><span class="sd">            If True, normalizes the background intensity to reduce illumination </span>
</span><span id="CenterDetermination.detection_crosscorr-1546"><a href="#CenterDetermination.detection_crosscorr-1546"><span class="linenos">1546</span></a><span class="sd">            artifacts. </span>
</span><span id="CenterDetermination.detection_crosscorr-1547"><a href="#CenterDetermination.detection_crosscorr-1547"><span class="linenos">1547</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_crosscorr-1548"><a href="#CenterDetermination.detection_crosscorr-1548"><span class="linenos">1548</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="CenterDetermination.detection_crosscorr-1549"><a href="#CenterDetermination.detection_crosscorr-1549"><span class="linenos">1549</span></a><span class="sd">            If True, applies Sobel filtering to enhance edges prior to processing. </span>
</span><span id="CenterDetermination.detection_crosscorr-1550"><a href="#CenterDetermination.detection_crosscorr-1550"><span class="linenos">1550</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_crosscorr-1551"><a href="#CenterDetermination.detection_crosscorr-1551"><span class="linenos">1551</span></a><span class="sd">        disp : bool, optional, default=False</span>
</span><span id="CenterDetermination.detection_crosscorr-1552"><a href="#CenterDetermination.detection_crosscorr-1552"><span class="linenos">1552</span></a><span class="sd">            If True, displays intermediate processing results.</span>
</span><span id="CenterDetermination.detection_crosscorr-1553"><a href="#CenterDetermination.detection_crosscorr-1553"><span class="linenos">1553</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_crosscorr-1554"><a href="#CenterDetermination.detection_crosscorr-1554"><span class="linenos">1554</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_crosscorr-1555"><a href="#CenterDetermination.detection_crosscorr-1555"><span class="linenos">1555</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_crosscorr-1556"><a href="#CenterDetermination.detection_crosscorr-1556"><span class="linenos">1556</span></a><span class="sd">        r_final : float</span>
</span><span id="CenterDetermination.detection_crosscorr-1557"><a href="#CenterDetermination.detection_crosscorr-1557"><span class="linenos">1557</span></a><span class="sd">            Estimated row-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination.detection_crosscorr-1558"><a href="#CenterDetermination.detection_crosscorr-1558"><span class="linenos">1558</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_crosscorr-1559"><a href="#CenterDetermination.detection_crosscorr-1559"><span class="linenos">1559</span></a><span class="sd">        c_final : float</span>
</span><span id="CenterDetermination.detection_crosscorr-1560"><a href="#CenterDetermination.detection_crosscorr-1560"><span class="linenos">1560</span></a><span class="sd">            Estimated column-coordinate of the image center after refinement.</span>
</span><span id="CenterDetermination.detection_crosscorr-1561"><a href="#CenterDetermination.detection_crosscorr-1561"><span class="linenos">1561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_crosscorr-1562"><a href="#CenterDetermination.detection_crosscorr-1562"><span class="linenos">1562</span></a>       
</span><span id="CenterDetermination.detection_crosscorr-1563"><a href="#CenterDetermination.detection_crosscorr-1563"><span class="linenos">1563</span></a>        <span class="c1"># (1) Get image -------------------------------------------------------</span>
</span><span id="CenterDetermination.detection_crosscorr-1564"><a href="#CenterDetermination.detection_crosscorr-1564"><span class="linenos">1564</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1565"><a href="#CenterDetermination.detection_crosscorr-1565"><span class="linenos">1565</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1566"><a href="#CenterDetermination.detection_crosscorr-1566"><span class="linenos">1566</span></a>        <span class="c1"># Apply Sobel filter if requested</span>
</span><span id="CenterDetermination.detection_crosscorr-1567"><a href="#CenterDetermination.detection_crosscorr-1567"><span class="linenos">1567</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_crosscorr-1568"><a href="#CenterDetermination.detection_crosscorr-1568"><span class="linenos">1568</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1569"><a href="#CenterDetermination.detection_crosscorr-1569"><span class="linenos">1569</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1570"><a href="#CenterDetermination.detection_crosscorr-1570"><span class="linenos">1570</span></a>        <span class="c1"># Shift pixel values to ensure non-negative image</span>
</span><span id="CenterDetermination.detection_crosscorr-1571"><a href="#CenterDetermination.detection_crosscorr-1571"><span class="linenos">1571</span></a>        <span class="n">image</span> <span class="o">-=</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1572"><a href="#CenterDetermination.detection_crosscorr-1572"><span class="linenos">1572</span></a>     
</span><span id="CenterDetermination.detection_crosscorr-1573"><a href="#CenterDetermination.detection_crosscorr-1573"><span class="linenos">1573</span></a>    
</span><span id="CenterDetermination.detection_crosscorr-1574"><a href="#CenterDetermination.detection_crosscorr-1574"><span class="linenos">1574</span></a>        <span class="c1"># (2) Normalize background intensity (optional) -----------------------</span>
</span><span id="CenterDetermination.detection_crosscorr-1575"><a href="#CenterDetermination.detection_crosscorr-1575"><span class="linenos">1575</span></a>        <span class="k">if</span> <span class="n">normalize_bg</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_crosscorr-1576"><a href="#CenterDetermination.detection_crosscorr-1576"><span class="linenos">1576</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="CenterDetermination.detection_crosscorr-1577"><a href="#CenterDetermination.detection_crosscorr-1577"><span class="linenos">1577</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1578"><a href="#CenterDetermination.detection_crosscorr-1578"><span class="linenos">1578</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_crosscorr-1579"><a href="#CenterDetermination.detection_crosscorr-1579"><span class="linenos">1579</span></a>                <span class="n">image</span> <span class="o">/=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_crosscorr-1580"><a href="#CenterDetermination.detection_crosscorr-1580"><span class="linenos">1580</span></a>                                         <span class="n">sigma</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_crosscorr-1581"><a href="#CenterDetermination.detection_crosscorr-1581"><span class="linenos">1581</span></a>                                         <span class="n">truncate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1582"><a href="#CenterDetermination.detection_crosscorr-1582"><span class="linenos">1582</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1583"><a href="#CenterDetermination.detection_crosscorr-1583"><span class="linenos">1583</span></a>        <span class="c1"># Replace NaN values with 0s</span>
</span><span id="CenterDetermination.detection_crosscorr-1584"><a href="#CenterDetermination.detection_crosscorr-1584"><span class="linenos">1584</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1585"><a href="#CenterDetermination.detection_crosscorr-1585"><span class="linenos">1585</span></a>    
</span><span id="CenterDetermination.detection_crosscorr-1586"><a href="#CenterDetermination.detection_crosscorr-1586"><span class="linenos">1586</span></a>        <span class="c1"># (3) Compute inversion symmetry using cross-correlation --------------</span>
</span><span id="CenterDetermination.detection_crosscorr-1587"><a href="#CenterDetermination.detection_crosscorr-1587"><span class="linenos">1587</span></a>        <span class="c1"># Dynamically set the margin to a reasonable fraction of the image size</span>
</span><span id="CenterDetermination.detection_crosscorr-1588"><a href="#CenterDetermination.detection_crosscorr-1588"><span class="linenos">1588</span></a>        <span class="n">margin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="CenterDetermination.detection_crosscorr-1589"><a href="#CenterDetermination.detection_crosscorr-1589"><span class="linenos">1589</span></a>        <span class="n">im_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">]</span>  <span class="c1"># Crop slightly</span>
</span><span id="CenterDetermination.detection_crosscorr-1590"><a href="#CenterDetermination.detection_crosscorr-1590"><span class="linenos">1590</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1591"><a href="#CenterDetermination.detection_crosscorr-1591"><span class="linenos">1591</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">im_i</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Inverted image for symmetry comparison</span>
</span><span id="CenterDetermination.detection_crosscorr-1592"><a href="#CenterDetermination.detection_crosscorr-1592"><span class="linenos">1592</span></a>    
</span><span id="CenterDetermination.detection_crosscorr-1593"><a href="#CenterDetermination.detection_crosscorr-1593"><span class="linenos">1593</span></a>        <span class="c1"># Compute cross-correlation using OpenCV template matching</span>
</span><span id="CenterDetermination.detection_crosscorr-1594"><a href="#CenterDetermination.detection_crosscorr-1594"><span class="linenos">1594</span></a>        <span class="c1"># it finds areas in an image that best match a given template. </span>
</span><span id="CenterDetermination.detection_crosscorr-1595"><a href="#CenterDetermination.detection_crosscorr-1595"><span class="linenos">1595</span></a>        <span class="c1"># it compares the original image with its inverted version to measure </span>
</span><span id="CenterDetermination.detection_crosscorr-1596"><a href="#CenterDetermination.detection_crosscorr-1596"><span class="linenos">1596</span></a>        <span class="c1"># inversion symmetry</span>
</span><span id="CenterDetermination.detection_crosscorr-1597"><a href="#CenterDetermination.detection_crosscorr-1597"><span class="linenos">1597</span></a>        <span class="c1"># im_i (template) slides over image in a pixel-by-pixel manner.</span>
</span><span id="CenterDetermination.detection_crosscorr-1598"><a href="#CenterDetermination.detection_crosscorr-1598"><span class="linenos">1598</span></a>        <span class="c1"># at each position, it computes the cross-correlation between </span>
</span><span id="CenterDetermination.detection_crosscorr-1599"><a href="#CenterDetermination.detection_crosscorr-1599"><span class="linenos">1599</span></a>        <span class="c1"># overlapping pixels.</span>
</span><span id="CenterDetermination.detection_crosscorr-1600"><a href="#CenterDetermination.detection_crosscorr-1600"><span class="linenos">1600</span></a>        <span class="c1"># result is a 2D matrix, where each value represents the correlation </span>
</span><span id="CenterDetermination.detection_crosscorr-1601"><a href="#CenterDetermination.detection_crosscorr-1601"><span class="linenos">1601</span></a>        <span class="c1"># score at a particular location. Higher values indicate</span>
</span><span id="CenterDetermination.detection_crosscorr-1602"><a href="#CenterDetermination.detection_crosscorr-1602"><span class="linenos">1602</span></a>        <span class="c1"># better symmetry at that position.</span>
</span><span id="CenterDetermination.detection_crosscorr-1603"><a href="#CenterDetermination.detection_crosscorr-1603"><span class="linenos">1603</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1604"><a href="#CenterDetermination.detection_crosscorr-1604"><span class="linenos">1604</span></a>        <span class="c1"># Ensure template is smaller than image</span>
</span><span id="CenterDetermination.detection_crosscorr-1605"><a href="#CenterDetermination.detection_crosscorr-1605"><span class="linenos">1605</span></a>        <span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
</span><span id="CenterDetermination.detection_crosscorr-1606"><a href="#CenterDetermination.detection_crosscorr-1606"><span class="linenos">1606</span></a>            <span class="ow">and</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
</span><span id="CenterDetermination.detection_crosscorr-1607"><a href="#CenterDetermination.detection_crosscorr-1607"><span class="linenos">1607</span></a>            <span class="s2">&quot;Template is larger than the image&quot;</span>
</span><span id="CenterDetermination.detection_crosscorr-1608"><a href="#CenterDetermination.detection_crosscorr-1608"><span class="linenos">1608</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1609"><a href="#CenterDetermination.detection_crosscorr-1609"><span class="linenos">1609</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
</span><span id="CenterDetermination.detection_crosscorr-1610"><a href="#CenterDetermination.detection_crosscorr-1610"><span class="linenos">1610</span></a>                                   <span class="n">template</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
</span><span id="CenterDetermination.detection_crosscorr-1611"><a href="#CenterDetermination.detection_crosscorr-1611"><span class="linenos">1611</span></a>                                   <span class="n">method</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCORR_NORMED</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1612"><a href="#CenterDetermination.detection_crosscorr-1612"><span class="linenos">1612</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1613"><a href="#CenterDetermination.detection_crosscorr-1613"><span class="linenos">1613</span></a>        <span class="c1"># Get the location of the best match in `result`</span>
</span><span id="CenterDetermination.detection_crosscorr-1614"><a href="#CenterDetermination.detection_crosscorr-1614"><span class="linenos">1614</span></a>        <span class="n">max_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_crosscorr-1615"><a href="#CenterDetermination.detection_crosscorr-1615"><span class="linenos">1615</span></a>        <span class="n">correction_r</span><span class="p">,</span> <span class="n">correction_c</span> <span class="o">=</span> <span class="n">max_location</span>  
</span><span id="CenterDetermination.detection_crosscorr-1616"><a href="#CenterDetermination.detection_crosscorr-1616"><span class="linenos">1616</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1617"><a href="#CenterDetermination.detection_crosscorr-1617"><span class="linenos">1617</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span> 
</span><span id="CenterDetermination.detection_crosscorr-1618"><a href="#CenterDetermination.detection_crosscorr-1618"><span class="linenos">1618</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1619"><a href="#CenterDetermination.detection_crosscorr-1619"><span class="linenos">1619</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1620"><a href="#CenterDetermination.detection_crosscorr-1620"><span class="linenos">1620</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation matrix&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1621"><a href="#CenterDetermination.detection_crosscorr-1621"><span class="linenos">1621</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1622"><a href="#CenterDetermination.detection_crosscorr-1622"><span class="linenos">1622</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1623"><a href="#CenterDetermination.detection_crosscorr-1623"><span class="linenos">1623</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1624"><a href="#CenterDetermination.detection_crosscorr-1624"><span class="linenos">1624</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1625"><a href="#CenterDetermination.detection_crosscorr-1625"><span class="linenos">1625</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1626"><a href="#CenterDetermination.detection_crosscorr-1626"><span class="linenos">1626</span></a>        <span class="c1"># Adjust to original image coordinates (account for template cropping)</span>
</span><span id="CenterDetermination.detection_crosscorr-1627"><a href="#CenterDetermination.detection_crosscorr-1627"><span class="linenos">1627</span></a>        <span class="n">corrected_r</span> <span class="o">=</span> <span class="n">correction_r</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_crosscorr-1628"><a href="#CenterDetermination.detection_crosscorr-1628"><span class="linenos">1628</span></a>        <span class="n">corrected_c</span> <span class="o">=</span> <span class="n">correction_c</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_crosscorr-1629"><a href="#CenterDetermination.detection_crosscorr-1629"><span class="linenos">1629</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1630"><a href="#CenterDetermination.detection_crosscorr-1630"><span class="linenos">1630</span></a>        <span class="c1"># (4) Visualization ---------------------------------------------------</span>
</span><span id="CenterDetermination.detection_crosscorr-1631"><a href="#CenterDetermination.detection_crosscorr-1631"><span class="linenos">1631</span></a>        <span class="c1"># Plot with correct alignment</span>
</span><span id="CenterDetermination.detection_crosscorr-1632"><a href="#CenterDetermination.detection_crosscorr-1632"><span class="linenos">1632</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_crosscorr-1633"><a href="#CenterDetermination.detection_crosscorr-1633"><span class="linenos">1633</span></a>            
</span><span id="CenterDetermination.detection_crosscorr-1634"><a href="#CenterDetermination.detection_crosscorr-1634"><span class="linenos">1634</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1635"><a href="#CenterDetermination.detection_crosscorr-1635"><span class="linenos">1635</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_crosscorr-1636"><a href="#CenterDetermination.detection_crosscorr-1636"><span class="linenos">1636</span></a>                <span class="n">orig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_crosscorr-1637"><a href="#CenterDetermination.detection_crosscorr-1637"><span class="linenos">1637</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1638"><a href="#CenterDetermination.detection_crosscorr-1638"><span class="linenos">1638</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1639"><a href="#CenterDetermination.detection_crosscorr-1639"><span class="linenos">1639</span></a>            
</span><span id="CenterDetermination.detection_crosscorr-1640"><a href="#CenterDetermination.detection_crosscorr-1640"><span class="linenos">1640</span></a>            <span class="c1"># Assuming fft_im_i is your Fourier transform image</span>
</span><span id="CenterDetermination.detection_crosscorr-1641"><a href="#CenterDetermination.detection_crosscorr-1641"><span class="linenos">1641</span></a>            <span class="n">center_size</span> <span class="o">=</span> <span class="mi">513</span>
</span><span id="CenterDetermination.detection_crosscorr-1642"><a href="#CenterDetermination.detection_crosscorr-1642"><span class="linenos">1642</span></a>            <span class="n">center_x</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_crosscorr-1643"><a href="#CenterDetermination.detection_crosscorr-1643"><span class="linenos">1643</span></a>            <span class="n">center_y</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_crosscorr-1644"><a href="#CenterDetermination.detection_crosscorr-1644"><span class="linenos">1644</span></a>
</span><span id="CenterDetermination.detection_crosscorr-1645"><a href="#CenterDetermination.detection_crosscorr-1645"><span class="linenos">1645</span></a>            <span class="c1"># Crop the central part of the spectrum</span>
</span><span id="CenterDetermination.detection_crosscorr-1646"><a href="#CenterDetermination.detection_crosscorr-1646"><span class="linenos">1646</span></a>            <span class="n">orig</span> <span class="o">=</span> <span class="n">orig</span><span class="p">[</span>
</span><span id="CenterDetermination.detection_crosscorr-1647"><a href="#CenterDetermination.detection_crosscorr-1647"><span class="linenos">1647</span></a>                <span class="n">center_y</span> <span class="o">-</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">center_y</span> <span class="o">+</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_crosscorr-1648"><a href="#CenterDetermination.detection_crosscorr-1648"><span class="linenos">1648</span></a>                <span class="n">center_x</span> <span class="o">-</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">center_x</span> <span class="o">+</span> <span class="n">center_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_crosscorr-1649"><a href="#CenterDetermination.detection_crosscorr-1649"><span class="linenos">1649</span></a>            
</span><span id="CenterDetermination.detection_crosscorr-1650"><a href="#CenterDetermination.detection_crosscorr-1650"><span class="linenos">1650</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1651"><a href="#CenterDetermination.detection_crosscorr-1651"><span class="linenos">1651</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">corrected_c</span><span class="o">-</span><span class="n">center_x</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">corrected_r</span><span class="o">-</span><span class="n">center_y</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_crosscorr-1652"><a href="#CenterDetermination.detection_crosscorr-1652"><span class="linenos">1652</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_crosscorr-1653"><a href="#CenterDetermination.detection_crosscorr-1653"><span class="linenos">1653</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1654"><a href="#CenterDetermination.detection_crosscorr-1654"><span class="linenos">1654</span></a>            <span class="n">my_title</span> <span class="o">=</span>  <span class="s2">&quot;Location of the highest correlation coefficient&quot;</span>
</span><span id="CenterDetermination.detection_crosscorr-1655"><a href="#CenterDetermination.detection_crosscorr-1655"><span class="linenos">1655</span></a>            <span class="n">my_title</span> <span class="o">+=</span> <span class="s2">&quot;in the original image.&quot;</span>
</span><span id="CenterDetermination.detection_crosscorr-1656"><a href="#CenterDetermination.detection_crosscorr-1656"><span class="linenos">1656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_title</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1657"><a href="#CenterDetermination.detection_crosscorr-1657"><span class="linenos">1657</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_crosscorr-1658"><a href="#CenterDetermination.detection_crosscorr-1658"><span class="linenos">1658</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1659"><a href="#CenterDetermination.detection_crosscorr-1659"><span class="linenos">1659</span></a>            
</span><span id="CenterDetermination.detection_crosscorr-1660"><a href="#CenterDetermination.detection_crosscorr-1660"><span class="linenos">1660</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_crosscorr-1661"><a href="#CenterDetermination.detection_crosscorr-1661"><span class="linenos">1661</span></a>        
</span><span id="CenterDetermination.detection_crosscorr-1662"><a href="#CenterDetermination.detection_crosscorr-1662"><span class="linenos">1662</span></a>        <span class="c1"># (5) User information (if required) ----------------------------------</span>
</span><span id="CenterDetermination.detection_crosscorr-1663"><a href="#CenterDetermination.detection_crosscorr-1663"><span class="linenos">1663</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_crosscorr-1664"><a href="#CenterDetermination.detection_crosscorr-1664"><span class="linenos">1664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="CenterDetermination.detection_crosscorr-1665"><a href="#CenterDetermination.detection_crosscorr-1665"><span class="linenos">1665</span></a>                <span class="s2">&quot;Center Determination (CrossCorrCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.detection_crosscorr-1666"><a href="#CenterDetermination.detection_crosscorr-1666"><span class="linenos">1666</span></a>
</span><span id="CenterDetermination.detection_crosscorr-1667"><a href="#CenterDetermination.detection_crosscorr-1667"><span class="linenos">1667</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">corrected_r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">corrected_c</span><span class="p">),</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Detects the center of symmetry in a diffraction image using a 
combination of weighted intensity averaging and cross-correlation.</p>

<p>This method performs the following steps:
    1. Estimates an initial center using the weighted average of pixel
       intensities.
    2. Crops the image to focus on its central region.
    3. Optionally normalizes the background to reduce experimental
       artifacts.
    4. Computes a refined center by analyzing inversion symmetry 
       using cross-correlation.
    5. Returns the final corrected center coordinates.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>normalize_bg</strong> (bool, optional, default=True):
If True, normalizes the background intensity to reduce illumination 
artifacts.</li>
<li><strong>sobel</strong> (bool, optional, default=False):
If True, applies Sobel filtering to enhance edges prior to processing.</li>
<li><strong>disp</strong> (bool, optional, default=False):
If True, displays intermediate processing results.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>r_final</strong> (float):
Estimated row-coordinate of the image center after refinement.</li>
<li><strong>c_final</strong> (float):
Estimated column-coordinate of the image center after refinement.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_intensity" class="classattr">
                                        <input id="CenterDetermination.detection_intensity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_intensity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csquare</span>, </span><span class="param"><span class="n">cintensity</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">sobel</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_intensity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_intensity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_intensity-1670"><a href="#CenterDetermination.detection_intensity-1670"><span class="linenos">1670</span></a>    <span class="k">def</span> <span class="nf">detection_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_intensity-1671"><a href="#CenterDetermination.detection_intensity-1671"><span class="linenos">1671</span></a>                            <span class="n">csquare</span><span class="p">,</span> <span class="n">cintensity</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_intensity-1672"><a href="#CenterDetermination.detection_intensity-1672"><span class="linenos">1672</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination.detection_intensity-1673"><a href="#CenterDetermination.detection_intensity-1673"><span class="linenos">1673</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="CenterDetermination.detection_intensity-1674"><a href="#CenterDetermination.detection_intensity-1674"><span class="linenos">1674</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_intensity-1675"><a href="#CenterDetermination.detection_intensity-1675"><span class="linenos">1675</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_intensity-1676"><a href="#CenterDetermination.detection_intensity-1676"><span class="linenos">1676</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_intensity-1677"><a href="#CenterDetermination.detection_intensity-1677"><span class="linenos">1677</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="CenterDetermination.detection_intensity-1678"><a href="#CenterDetermination.detection_intensity-1678"><span class="linenos">1678</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="CenterDetermination.detection_intensity-1679"><a href="#CenterDetermination.detection_intensity-1679"><span class="linenos">1679</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_intensity-1680"><a href="#CenterDetermination.detection_intensity-1680"><span class="linenos">1680</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="CenterDetermination.detection_intensity-1681"><a href="#CenterDetermination.detection_intensity-1681"><span class="linenos">1681</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="CenterDetermination.detection_intensity-1682"><a href="#CenterDetermination.detection_intensity-1682"><span class="linenos">1682</span></a><span class="sd">            The intensity center will be searched only within the central</span>
</span><span id="CenterDetermination.detection_intensity-1683"><a href="#CenterDetermination.detection_intensity-1683"><span class="linenos">1683</span></a><span class="sd">            square.</span>
</span><span id="CenterDetermination.detection_intensity-1684"><a href="#CenterDetermination.detection_intensity-1684"><span class="linenos">1684</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="CenterDetermination.detection_intensity-1685"><a href="#CenterDetermination.detection_intensity-1685"><span class="linenos">1685</span></a><span class="sd">            to minimize the effect of possible intensity assymetry</span>
</span><span id="CenterDetermination.detection_intensity-1686"><a href="#CenterDetermination.detection_intensity-1686"><span class="linenos">1686</span></a><span class="sd">            around the center. </span>
</span><span id="CenterDetermination.detection_intensity-1687"><a href="#CenterDetermination.detection_intensity-1687"><span class="linenos">1687</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_intensity-1688"><a href="#CenterDetermination.detection_intensity-1688"><span class="linenos">1688</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="CenterDetermination.detection_intensity-1689"><a href="#CenterDetermination.detection_intensity-1689"><span class="linenos">1689</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="CenterDetermination.detection_intensity-1690"><a href="#CenterDetermination.detection_intensity-1690"><span class="linenos">1690</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="CenterDetermination.detection_intensity-1691"><a href="#CenterDetermination.detection_intensity-1691"><span class="linenos">1691</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="CenterDetermination.detection_intensity-1692"><a href="#CenterDetermination.detection_intensity-1692"><span class="linenos">1692</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_intensity-1693"><a href="#CenterDetermination.detection_intensity-1693"><span class="linenos">1693</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_intensity-1694"><a href="#CenterDetermination.detection_intensity-1694"><span class="linenos">1694</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_intensity-1695"><a href="#CenterDetermination.detection_intensity-1695"><span class="linenos">1695</span></a><span class="sd">        xc, yc : float,float</span>
</span><span id="CenterDetermination.detection_intensity-1696"><a href="#CenterDetermination.detection_intensity-1696"><span class="linenos">1696</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="CenterDetermination.detection_intensity-1697"><a href="#CenterDetermination.detection_intensity-1697"><span class="linenos">1697</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.</span>
</span><span id="CenterDetermination.detection_intensity-1698"><a href="#CenterDetermination.detection_intensity-1698"><span class="linenos">1698</span></a><span class="sd">        &#39;&#39;&#39;</span>  
</span><span id="CenterDetermination.detection_intensity-1699"><a href="#CenterDetermination.detection_intensity-1699"><span class="linenos">1699</span></a>        
</span><span id="CenterDetermination.detection_intensity-1700"><a href="#CenterDetermination.detection_intensity-1700"><span class="linenos">1700</span></a>        <span class="c1"># (1) Get image/array size --------------------------------------------</span>
</span><span id="CenterDetermination.detection_intensity-1701"><a href="#CenterDetermination.detection_intensity-1701"><span class="linenos">1701</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1702"><a href="#CenterDetermination.detection_intensity-1702"><span class="linenos">1702</span></a>        
</span><span id="CenterDetermination.detection_intensity-1703"><a href="#CenterDetermination.detection_intensity-1703"><span class="linenos">1703</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_intensity-1704"><a href="#CenterDetermination.detection_intensity-1704"><span class="linenos">1704</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1705"><a href="#CenterDetermination.detection_intensity-1705"><span class="linenos">1705</span></a>             
</span><span id="CenterDetermination.detection_intensity-1706"><a href="#CenterDetermination.detection_intensity-1706"><span class="linenos">1706</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1707"><a href="#CenterDetermination.detection_intensity-1707"><span class="linenos">1707</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterDetermination.detection_intensity-1708"><a href="#CenterDetermination.detection_intensity-1708"><span class="linenos">1708</span></a>        
</span><span id="CenterDetermination.detection_intensity-1709"><a href="#CenterDetermination.detection_intensity-1709"><span class="linenos">1709</span></a>        <span class="c1"># (2) Calculate borders around the central square ---------------------</span>
</span><span id="CenterDetermination.detection_intensity-1710"><a href="#CenterDetermination.detection_intensity-1710"><span class="linenos">1710</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_intensity-1711"><a href="#CenterDetermination.detection_intensity-1711"><span class="linenos">1711</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_intensity-1712"><a href="#CenterDetermination.detection_intensity-1712"><span class="linenos">1712</span></a>        
</span><span id="CenterDetermination.detection_intensity-1713"><a href="#CenterDetermination.detection_intensity-1713"><span class="linenos">1713</span></a>        <span class="c1"># (3) Create the central square, --------------------------------------</span>
</span><span id="CenterDetermination.detection_intensity-1714"><a href="#CenterDetermination.detection_intensity-1714"><span class="linenos">1714</span></a>        <span class="c1"># from which the intensity center will be detected</span>
</span><span id="CenterDetermination.detection_intensity-1715"><a href="#CenterDetermination.detection_intensity-1715"><span class="linenos">1715</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_intensity-1716"><a href="#CenterDetermination.detection_intensity-1716"><span class="linenos">1716</span></a>        
</span><span id="CenterDetermination.detection_intensity-1717"><a href="#CenterDetermination.detection_intensity-1717"><span class="linenos">1717</span></a>        <span class="c1"># (4) In the central square, ------------------------------------------</span>
</span><span id="CenterDetermination.detection_intensity-1718"><a href="#CenterDetermination.detection_intensity-1718"><span class="linenos">1718</span></a>        <span class="c1"># set all values below cintenstity to zero</span>
</span><span id="CenterDetermination.detection_intensity-1719"><a href="#CenterDetermination.detection_intensity-1719"><span class="linenos">1719</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1720"><a href="#CenterDetermination.detection_intensity-1720"><span class="linenos">1720</span></a>        
</span><span id="CenterDetermination.detection_intensity-1721"><a href="#CenterDetermination.detection_intensity-1721"><span class="linenos">1721</span></a>        <span class="c1"># (5) Determine the intensity center from image moments ---------------</span>
</span><span id="CenterDetermination.detection_intensity-1722"><a href="#CenterDetermination.detection_intensity-1722"><span class="linenos">1722</span></a>        <span class="c1"># see image moments in...</span>
</span><span id="CenterDetermination.detection_intensity-1723"><a href="#CenterDetermination.detection_intensity-1723"><span class="linenos">1723</span></a>        <span class="c1"># skimage: https://scikit-image.org/docs/dev/api/skimage.measure.html</span>
</span><span id="CenterDetermination.detection_intensity-1724"><a href="#CenterDetermination.detection_intensity-1724"><span class="linenos">1724</span></a>        <span class="c1"># wikipedia: https://en.wikipedia.org/wiki/Image_moment -&gt; Centroid</span>
</span><span id="CenterDetermination.detection_intensity-1725"><a href="#CenterDetermination.detection_intensity-1725"><span class="linenos">1725</span></a>        <span class="c1"># ---</span>
</span><span id="CenterDetermination.detection_intensity-1726"><a href="#CenterDetermination.detection_intensity-1726"><span class="linenos">1726</span></a>        <span class="c1"># (a) Calculate 1st central moments of the image</span>
</span><span id="CenterDetermination.detection_intensity-1727"><a href="#CenterDetermination.detection_intensity-1727"><span class="linenos">1727</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1728"><a href="#CenterDetermination.detection_intensity-1728"><span class="linenos">1728</span></a>        <span class="c1"># (b) Calculate the intensity center = centroid according to www-help</span>
</span><span id="CenterDetermination.detection_intensity-1729"><a href="#CenterDetermination.detection_intensity-1729"><span class="linenos">1729</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination.detection_intensity-1730"><a href="#CenterDetermination.detection_intensity-1730"><span class="linenos">1730</span></a>        <span class="c1"># (c) We have centroid of the central square</span>
</span><span id="CenterDetermination.detection_intensity-1731"><a href="#CenterDetermination.detection_intensity-1731"><span class="linenos">1731</span></a>        <span class="c1"># but we have to recalculate it to the whole image</span>
</span><span id="CenterDetermination.detection_intensity-1732"><a href="#CenterDetermination.detection_intensity-1732"><span class="linenos">1732</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">xborder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">yborder</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1733"><a href="#CenterDetermination.detection_intensity-1733"><span class="linenos">1733</span></a>        <span class="c1"># (d) Radius of a diffraction ring </span>
</span><span id="CenterDetermination.detection_intensity-1734"><a href="#CenterDetermination.detection_intensity-1734"><span class="linenos">1734</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_intensity-1735"><a href="#CenterDetermination.detection_intensity-1735"><span class="linenos">1735</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rtype</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_intensity-1736"><a href="#CenterDetermination.detection_intensity-1736"><span class="linenos">1736</span></a>            <span class="n">image</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_intensity-1737"><a href="#CenterDetermination.detection_intensity-1737"><span class="linenos">1737</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_intensity-1738"><a href="#CenterDetermination.detection_intensity-1738"><span class="linenos">1738</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_intensity-1739"><a href="#CenterDetermination.detection_intensity-1739"><span class="linenos">1739</span></a>            <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1740"><a href="#CenterDetermination.detection_intensity-1740"><span class="linenos">1740</span></a>        
</span><span id="CenterDetermination.detection_intensity-1741"><a href="#CenterDetermination.detection_intensity-1741"><span class="linenos">1741</span></a>        <span class="c1"># (6) User information (if required) ----------------------------------</span>
</span><span id="CenterDetermination.detection_intensity-1742"><a href="#CenterDetermination.detection_intensity-1742"><span class="linenos">1742</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_intensity-1743"><a href="#CenterDetermination.detection_intensity-1743"><span class="linenos">1743</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span>\
</span><span id="CenterDetermination.detection_intensity-1744"><a href="#CenterDetermination.detection_intensity-1744"><span class="linenos">1744</span></a>                <span class="s2">&quot;Center Determination (IntensityCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.detection_intensity-1745"><a href="#CenterDetermination.detection_intensity-1745"><span class="linenos">1745</span></a>
</span><span id="CenterDetermination.detection_intensity-1746"><a href="#CenterDetermination.detection_intensity-1746"><span class="linenos">1746</span></a>        <span class="c1"># (7) Plot results (if required) --------------------------------------</span>
</span><span id="CenterDetermination.detection_intensity-1747"><a href="#CenterDetermination.detection_intensity-1747"><span class="linenos">1747</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_intensity-1748"><a href="#CenterDetermination.detection_intensity-1748"><span class="linenos">1748</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_intensity-1749"><a href="#CenterDetermination.detection_intensity-1749"><span class="linenos">1749</span></a>                
</span><span id="CenterDetermination.detection_intensity-1750"><a href="#CenterDetermination.detection_intensity-1750"><span class="linenos">1750</span></a>        <span class="c1"># (8) Return the results: ---------------------------------------------</span>
</span><span id="CenterDetermination.detection_intensity-1751"><a href="#CenterDetermination.detection_intensity-1751"><span class="linenos">1751</span></a>        <span class="c1">#  a) XY-coordinates of the center</span>
</span><span id="CenterDetermination.detection_intensity-1752"><a href="#CenterDetermination.detection_intensity-1752"><span class="linenos">1752</span></a>        <span class="c1">#  b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination.detection_intensity-1753"><a href="#CenterDetermination.detection_intensity-1753"><span class="linenos">1753</span></a>        <span class="c1">#     from which the center was determined</span>
</span><span id="CenterDetermination.detection_intensity-1754"><a href="#CenterDetermination.detection_intensity-1754"><span class="linenos">1754</span></a>
</span><span id="CenterDetermination.detection_intensity-1755"><a href="#CenterDetermination.detection_intensity-1755"><span class="linenos">1755</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find center of intensity/mass of an array.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>arr</strong> (2D-numpy array):
The array, whose intensity center will be determined.</li>
<li><strong>csquare</strong> (int, optional, default is 20):
The size/edge of the square in the (geometrical) center.
The intensity center will be searched only within the central
square.
Reasons: To avoid other spots/diffractions and
to minimize the effect of possible intensity assymetry
around the center.</li>
<li><strong>cintensity</strong> (float, optional, default is 0.8):
The intensity fraction.
When searching the intensity center, we will consider only
pixels with intensity &gt; max.intensity.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xc, yc</strong> (float,float):
XY-coordinates of the intensity/mass center of the array.
Round XY-coordinates if you use them for image/array calculations.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_Hough" class="classattr">
                                        <input id="CenterDetermination.detection_Hough-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_Hough</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">sobel</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_Hough-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_Hough"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_Hough-1758"><a href="#CenterDetermination.detection_Hough-1758"><span class="linenos">1758</span></a>    <span class="k">def</span> <span class="nf">detection_Hough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1759"><a href="#CenterDetermination.detection_Hough-1759"><span class="linenos">1759</span></a>                        <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sobel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_Hough-1760"><a href="#CenterDetermination.detection_Hough-1760"><span class="linenos">1760</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;        </span>
</span><span id="CenterDetermination.detection_Hough-1761"><a href="#CenterDetermination.detection_Hough-1761"><span class="linenos">1761</span></a><span class="sd">        Perform Hough transform to detect the center of diffraction patterns </span>
</span><span id="CenterDetermination.detection_Hough-1762"><a href="#CenterDetermination.detection_Hough-1762"><span class="linenos">1762</span></a><span class="sd">        with optional real-time visualization and a final image showing all </span>
</span><span id="CenterDetermination.detection_Hough-1763"><a href="#CenterDetermination.detection_Hough-1763"><span class="linenos">1763</span></a><span class="sd">        detected circles.</span>
</span><span id="CenterDetermination.detection_Hough-1764"><a href="#CenterDetermination.detection_Hough-1764"><span class="linenos">1764</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_Hough-1765"><a href="#CenterDetermination.detection_Hough-1765"><span class="linenos">1765</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_Hough-1766"><a href="#CenterDetermination.detection_Hough-1766"><span class="linenos">1766</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_Hough-1767"><a href="#CenterDetermination.detection_Hough-1767"><span class="linenos">1767</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination.detection_Hough-1768"><a href="#CenterDetermination.detection_Hough-1768"><span class="linenos">1768</span></a><span class="sd">            If 1, shows the final detected circle.</span>
</span><span id="CenterDetermination.detection_Hough-1769"><a href="#CenterDetermination.detection_Hough-1769"><span class="linenos">1769</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_Hough-1770"><a href="#CenterDetermination.detection_Hough-1770"><span class="linenos">1770</span></a><span class="sd">        sobel : bool, optional, default=False</span>
</span><span id="CenterDetermination.detection_Hough-1771"><a href="#CenterDetermination.detection_Hough-1771"><span class="linenos">1771</span></a><span class="sd">            If True, applies Sobel filtering to enhance edges prior to processing. </span>
</span><span id="CenterDetermination.detection_Hough-1772"><a href="#CenterDetermination.detection_Hough-1772"><span class="linenos">1772</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_Hough-1773"><a href="#CenterDetermination.detection_Hough-1773"><span class="linenos">1773</span></a><span class="sd">        sobel            </span>
</span><span id="CenterDetermination.detection_Hough-1774"><a href="#CenterDetermination.detection_Hough-1774"><span class="linenos">1774</span></a><span class="sd">        live_plot : bool, optional, default=False</span>
</span><span id="CenterDetermination.detection_Hough-1775"><a href="#CenterDetermination.detection_Hough-1775"><span class="linenos">1775</span></a><span class="sd">            If True, animates the circle detection process and shows all </span>
</span><span id="CenterDetermination.detection_Hough-1776"><a href="#CenterDetermination.detection_Hough-1776"><span class="linenos">1776</span></a><span class="sd">            detected circles.</span>
</span><span id="CenterDetermination.detection_Hough-1777"><a href="#CenterDetermination.detection_Hough-1777"><span class="linenos">1777</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.detection_Hough-1778"><a href="#CenterDetermination.detection_Hough-1778"><span class="linenos">1778</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_Hough-1779"><a href="#CenterDetermination.detection_Hough-1779"><span class="linenos">1779</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_Hough-1780"><a href="#CenterDetermination.detection_Hough-1780"><span class="linenos">1780</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination.detection_Hough-1781"><a href="#CenterDetermination.detection_Hough-1781"><span class="linenos">1781</span></a><span class="sd">            x-coordinate of the detected center.</span>
</span><span id="CenterDetermination.detection_Hough-1782"><a href="#CenterDetermination.detection_Hough-1782"><span class="linenos">1782</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_Hough-1783"><a href="#CenterDetermination.detection_Hough-1783"><span class="linenos">1783</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination.detection_Hough-1784"><a href="#CenterDetermination.detection_Hough-1784"><span class="linenos">1784</span></a><span class="sd">            y-coordinate of the detected center.</span>
</span><span id="CenterDetermination.detection_Hough-1785"><a href="#CenterDetermination.detection_Hough-1785"><span class="linenos">1785</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_Hough-1786"><a href="#CenterDetermination.detection_Hough-1786"><span class="linenos">1786</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination.detection_Hough-1787"><a href="#CenterDetermination.detection_Hough-1787"><span class="linenos">1787</span></a><span class="sd">            Radius of the detected circle.</span>
</span><span id="CenterDetermination.detection_Hough-1788"><a href="#CenterDetermination.detection_Hough-1788"><span class="linenos">1788</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination.detection_Hough-1789"><a href="#CenterDetermination.detection_Hough-1789"><span class="linenos">1789</span></a>        
</span><span id="CenterDetermination.detection_Hough-1790"><a href="#CenterDetermination.detection_Hough-1790"><span class="linenos">1790</span></a>        <span class="c1">## (0) Image preprocessing --------------------------------------------</span>
</span><span id="CenterDetermination.detection_Hough-1791"><a href="#CenterDetermination.detection_Hough-1791"><span class="linenos">1791</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1792"><a href="#CenterDetermination.detection_Hough-1792"><span class="linenos">1792</span></a>                    
</span><span id="CenterDetermination.detection_Hough-1793"><a href="#CenterDetermination.detection_Hough-1793"><span class="linenos">1793</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1794"><a href="#CenterDetermination.detection_Hough-1794"><span class="linenos">1794</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1795"><a href="#CenterDetermination.detection_Hough-1795"><span class="linenos">1795</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  
</span><span id="CenterDetermination.detection_Hough-1796"><a href="#CenterDetermination.detection_Hough-1796"><span class="linenos">1796</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">skf</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1797"><a href="#CenterDetermination.detection_Hough-1797"><span class="linenos">1797</span></a>                              <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1798"><a href="#CenterDetermination.detection_Hough-1798"><span class="linenos">1798</span></a>                              <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1799"><a href="#CenterDetermination.detection_Hough-1799"><span class="linenos">1799</span></a>                              <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1800"><a href="#CenterDetermination.detection_Hough-1800"><span class="linenos">1800</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1801"><a href="#CenterDetermination.detection_Hough-1801"><span class="linenos">1801</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1802"><a href="#CenterDetermination.detection_Hough-1802"><span class="linenos">1802</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  
</span><span id="CenterDetermination.detection_Hough-1803"><a href="#CenterDetermination.detection_Hough-1803"><span class="linenos">1803</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">skf</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1804"><a href="#CenterDetermination.detection_Hough-1804"><span class="linenos">1804</span></a>                              <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1805"><a href="#CenterDetermination.detection_Hough-1805"><span class="linenos">1805</span></a>                              <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1806"><a href="#CenterDetermination.detection_Hough-1806"><span class="linenos">1806</span></a>                              <span class="n">high_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1807"><a href="#CenterDetermination.detection_Hough-1807"><span class="linenos">1807</span></a>        <span class="k">if</span> <span class="n">sobel</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1808"><a href="#CenterDetermination.detection_Hough-1808"><span class="linenos">1808</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobel_filt</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1809"><a href="#CenterDetermination.detection_Hough-1809"><span class="linenos">1809</span></a>
</span><span id="CenterDetermination.detection_Hough-1810"><a href="#CenterDetermination.detection_Hough-1810"><span class="linenos">1810</span></a>        <span class="c1">## (1) Define the radii range for concentric circles ------------------</span>
</span><span id="CenterDetermination.detection_Hough-1811"><a href="#CenterDetermination.detection_Hough-1811"><span class="linenos">1811</span></a>        <span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">radius_step</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">10</span>
</span><span id="CenterDetermination.detection_Hough-1812"><a href="#CenterDetermination.detection_Hough-1812"><span class="linenos">1812</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span> <span class="o">+</span> <span class="n">radius_step</span><span class="p">,</span> <span class="n">radius_step</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1813"><a href="#CenterDetermination.detection_Hough-1813"><span class="linenos">1813</span></a>    
</span><span id="CenterDetermination.detection_Hough-1814"><a href="#CenterDetermination.detection_Hough-1814"><span class="linenos">1814</span></a>        <span class="c1"># Store detected circles</span>
</span><span id="CenterDetermination.detection_Hough-1815"><a href="#CenterDetermination.detection_Hough-1815"><span class="linenos">1815</span></a>        <span class="n">detected_circles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterDetermination.detection_Hough-1816"><a href="#CenterDetermination.detection_Hough-1816"><span class="linenos">1816</span></a>    
</span><span id="CenterDetermination.detection_Hough-1817"><a href="#CenterDetermination.detection_Hough-1817"><span class="linenos">1817</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1818"><a href="#CenterDetermination.detection_Hough-1818"><span class="linenos">1818</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1819"><a href="#CenterDetermination.detection_Hough-1819"><span class="linenos">1819</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1820"><a href="#CenterDetermination.detection_Hough-1820"><span class="linenos">1820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1821"><a href="#CenterDetermination.detection_Hough-1821"><span class="linenos">1821</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1822"><a href="#CenterDetermination.detection_Hough-1822"><span class="linenos">1822</span></a>                
</span><span id="CenterDetermination.detection_Hough-1823"><a href="#CenterDetermination.detection_Hough-1823"><span class="linenos">1823</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_Hough-1824"><a href="#CenterDetermination.detection_Hough-1824"><span class="linenos">1824</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1825"><a href="#CenterDetermination.detection_Hough-1825"><span class="linenos">1825</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1826"><a href="#CenterDetermination.detection_Hough-1826"><span class="linenos">1826</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Live Hough Circle Detection&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1827"><a href="#CenterDetermination.detection_Hough-1827"><span class="linenos">1827</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>  <span class="c1"># Turn on interactive mode</span>
</span><span id="CenterDetermination.detection_Hough-1828"><a href="#CenterDetermination.detection_Hough-1828"><span class="linenos">1828</span></a>    
</span><span id="CenterDetermination.detection_Hough-1829"><a href="#CenterDetermination.detection_Hough-1829"><span class="linenos">1829</span></a>        <span class="c1">## (2) Process each radius one at a time ------------------------------</span>
</span><span id="CenterDetermination.detection_Hough-1830"><a href="#CenterDetermination.detection_Hough-1830"><span class="linenos">1830</span></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1831"><a href="#CenterDetermination.detection_Hough-1831"><span class="linenos">1831</span></a>            <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">]))</span>
</span><span id="CenterDetermination.detection_Hough-1832"><a href="#CenterDetermination.detection_Hough-1832"><span class="linenos">1832</span></a>            <span class="n">accums</span><span class="p">,</span> <span class="n">x_peaks</span><span class="p">,</span> <span class="n">y_peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1833"><a href="#CenterDetermination.detection_Hough-1833"><span class="linenos">1833</span></a>                                                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">]),</span> 
</span><span id="CenterDetermination.detection_Hough-1834"><a href="#CenterDetermination.detection_Hough-1834"><span class="linenos">1834</span></a>                                                             <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1835"><a href="#CenterDetermination.detection_Hough-1835"><span class="linenos">1835</span></a>    
</span><span id="CenterDetermination.detection_Hough-1836"><a href="#CenterDetermination.detection_Hough-1836"><span class="linenos">1836</span></a>            <span class="c1"># Store circle if detected</span>
</span><span id="CenterDetermination.detection_Hough-1837"><a href="#CenterDetermination.detection_Hough-1837"><span class="linenos">1837</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1838"><a href="#CenterDetermination.detection_Hough-1838"><span class="linenos">1838</span></a>                <span class="n">detected_circles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">))</span>
</span><span id="CenterDetermination.detection_Hough-1839"><a href="#CenterDetermination.detection_Hough-1839"><span class="linenos">1839</span></a>    
</span><span id="CenterDetermination.detection_Hough-1840"><a href="#CenterDetermination.detection_Hough-1840"><span class="linenos">1840</span></a>            <span class="c1"># Live animation (if enabled)</span>
</span><span id="CenterDetermination.detection_Hough-1841"><a href="#CenterDetermination.detection_Hough-1841"><span class="linenos">1841</span></a>            <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1842"><a href="#CenterDetermination.detection_Hough-1842"><span class="linenos">1842</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_Hough-1843"><a href="#CenterDetermination.detection_Hough-1843"><span class="linenos">1843</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1844"><a href="#CenterDetermination.detection_Hough-1844"><span class="linenos">1844</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detecting Circles: Radius </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1845"><a href="#CenterDetermination.detection_Hough-1845"><span class="linenos">1845</span></a>                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">detected_circles</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1846"><a href="#CenterDetermination.detection_Hough-1846"><span class="linenos">1846</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1847"><a href="#CenterDetermination.detection_Hough-1847"><span class="linenos">1847</span></a>                    <span class="n">circ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rad</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1848"><a href="#CenterDetermination.detection_Hough-1848"><span class="linenos">1848</span></a>                                      <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1849"><a href="#CenterDetermination.detection_Hough-1849"><span class="linenos">1849</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1850"><a href="#CenterDetermination.detection_Hough-1850"><span class="linenos">1850</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1851"><a href="#CenterDetermination.detection_Hough-1851"><span class="linenos">1851</span></a>    
</span><span id="CenterDetermination.detection_Hough-1852"><a href="#CenterDetermination.detection_Hough-1852"><span class="linenos">1852</span></a>        <span class="c1">## (3) Final detected circle ------------------------------------------</span>
</span><span id="CenterDetermination.detection_Hough-1853"><a href="#CenterDetermination.detection_Hough-1853"><span class="linenos">1853</span></a>        <span class="n">accums</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_Hough-1854"><a href="#CenterDetermination.detection_Hough-1854"><span class="linenos">1854</span></a>            <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">radii</span><span class="p">),</span>
</span><span id="CenterDetermination.detection_Hough-1855"><a href="#CenterDetermination.detection_Hough-1855"><span class="linenos">1855</span></a>            <span class="n">radii</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_Hough-1856"><a href="#CenterDetermination.detection_Hough-1856"><span class="linenos">1856</span></a>            <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">5</span>
</span><span id="CenterDetermination.detection_Hough-1857"><a href="#CenterDetermination.detection_Hough-1857"><span class="linenos">1857</span></a>        <span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1858"><a href="#CenterDetermination.detection_Hough-1858"><span class="linenos">1858</span></a>        
</span><span id="CenterDetermination.detection_Hough-1859"><a href="#CenterDetermination.detection_Hough-1859"><span class="linenos">1859</span></a>        
</span><span id="CenterDetermination.detection_Hough-1860"><a href="#CenterDetermination.detection_Hough-1860"><span class="linenos">1860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> \
</span><span id="CenterDetermination.detection_Hough-1861"><a href="#CenterDetermination.detection_Hough-1861"><span class="linenos">1861</span></a>            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination.detection_Hough-1862"><a href="#CenterDetermination.detection_Hough-1862"><span class="linenos">1862</span></a>    
</span><span id="CenterDetermination.detection_Hough-1863"><a href="#CenterDetermination.detection_Hough-1863"><span class="linenos">1863</span></a>        <span class="c1">## (4) User information -----------------------------------------------</span>
</span><span id="CenterDetermination.detection_Hough-1864"><a href="#CenterDetermination.detection_Hough-1864"><span class="linenos">1864</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_Hough-1865"><a href="#CenterDetermination.detection_Hough-1865"><span class="linenos">1865</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> \
</span><span id="CenterDetermination.detection_Hough-1866"><a href="#CenterDetermination.detection_Hough-1866"><span class="linenos">1866</span></a>                <span class="s2">&quot;Center Determination (HoughTransform) : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span>\
</span><span id="CenterDetermination.detection_Hough-1867"><a href="#CenterDetermination.detection_Hough-1867"><span class="linenos">1867</span></a>                    <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1868"><a href="#CenterDetermination.detection_Hough-1868"><span class="linenos">1868</span></a>    
</span><span id="CenterDetermination.detection_Hough-1869"><a href="#CenterDetermination.detection_Hough-1869"><span class="linenos">1869</span></a>        <span class="c1">## (5) Final plot with all detected circles (if enabled) --------------</span>
</span><span id="CenterDetermination.detection_Hough-1870"><a href="#CenterDetermination.detection_Hough-1870"><span class="linenos">1870</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1871"><a href="#CenterDetermination.detection_Hough-1871"><span class="linenos">1871</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>  <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination.detection_Hough-1872"><a href="#CenterDetermination.detection_Hough-1872"><span class="linenos">1872</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1873"><a href="#CenterDetermination.detection_Hough-1873"><span class="linenos">1873</span></a>        
</span><span id="CenterDetermination.detection_Hough-1874"><a href="#CenterDetermination.detection_Hough-1874"><span class="linenos">1874</span></a>        
</span><span id="CenterDetermination.detection_Hough-1875"><a href="#CenterDetermination.detection_Hough-1875"><span class="linenos">1875</span></a>            <span class="n">fig_final</span><span class="p">,</span> <span class="n">ax_final</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_Hough-1876"><a href="#CenterDetermination.detection_Hough-1876"><span class="linenos">1876</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1877"><a href="#CenterDetermination.detection_Hough-1877"><span class="linenos">1877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hough Transform Preliminary Detection&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1878"><a href="#CenterDetermination.detection_Hough-1878"><span class="linenos">1878</span></a>        
</span><span id="CenterDetermination.detection_Hough-1879"><a href="#CenterDetermination.detection_Hough-1879"><span class="linenos">1879</span></a>            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">detected_circles</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1880"><a href="#CenterDetermination.detection_Hough-1880"><span class="linenos">1880</span></a>                <span class="n">circ</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rad</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1881"><a href="#CenterDetermination.detection_Hough-1881"><span class="linenos">1881</span></a>                                  <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1882"><a href="#CenterDetermination.detection_Hough-1882"><span class="linenos">1882</span></a>                <span class="n">ax_final</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1883"><a href="#CenterDetermination.detection_Hough-1883"><span class="linenos">1883</span></a>        
</span><span id="CenterDetermination.detection_Hough-1884"><a href="#CenterDetermination.detection_Hough-1884"><span class="linenos">1884</span></a>            <span class="c1"># Highlight the final detected circle (red)</span>
</span><span id="CenterDetermination.detection_Hough-1885"><a href="#CenterDetermination.detection_Hough-1885"><span class="linenos">1885</span></a>            <span class="n">circ_final</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1886"><a href="#CenterDetermination.detection_Hough-1886"><span class="linenos">1886</span></a>                                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1887"><a href="#CenterDetermination.detection_Hough-1887"><span class="linenos">1887</span></a>                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Selected Circle&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1888"><a href="#CenterDetermination.detection_Hough-1888"><span class="linenos">1888</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1889"><a href="#CenterDetermination.detection_Hough-1889"><span class="linenos">1889</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ_final</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1890"><a href="#CenterDetermination.detection_Hough-1890"><span class="linenos">1890</span></a>        
</span><span id="CenterDetermination.detection_Hough-1891"><a href="#CenterDetermination.detection_Hough-1891"><span class="linenos">1891</span></a>            <span class="c1"># Create a single blue circle just for the legend</span>
</span><span id="CenterDetermination.detection_Hough-1892"><a href="#CenterDetermination.detection_Hough-1892"><span class="linenos">1892</span></a>            <span class="n">legend_blue</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterDetermination.detection_Hough-1893"><a href="#CenterDetermination.detection_Hough-1893"><span class="linenos">1893</span></a>                                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1894"><a href="#CenterDetermination.detection_Hough-1894"><span class="linenos">1894</span></a>                                     <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1895"><a href="#CenterDetermination.detection_Hough-1895"><span class="linenos">1895</span></a>                                     <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1896"><a href="#CenterDetermination.detection_Hough-1896"><span class="linenos">1896</span></a>                                     <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Searching Space&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1897"><a href="#CenterDetermination.detection_Hough-1897"><span class="linenos">1897</span></a>        
</span><span id="CenterDetermination.detection_Hough-1898"><a href="#CenterDetermination.detection_Hough-1898"><span class="linenos">1898</span></a>            <span class="c1"># Add the legend</span>
</span><span id="CenterDetermination.detection_Hough-1899"><a href="#CenterDetermination.detection_Hough-1899"><span class="linenos">1899</span></a>            <span class="n">ax_final</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">legend_blue</span><span class="p">,</span> <span class="n">circ_final</span><span class="p">])</span>
</span><span id="CenterDetermination.detection_Hough-1900"><a href="#CenterDetermination.detection_Hough-1900"><span class="linenos">1900</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1901"><a href="#CenterDetermination.detection_Hough-1901"><span class="linenos">1901</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_Hough-1902"><a href="#CenterDetermination.detection_Hough-1902"><span class="linenos">1902</span></a>
</span><span id="CenterDetermination.detection_Hough-1903"><a href="#CenterDetermination.detection_Hough-1903"><span class="linenos">1903</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_Hough-1904"><a href="#CenterDetermination.detection_Hough-1904"><span class="linenos">1904</span></a>    
</span><span id="CenterDetermination.detection_Hough-1905"><a href="#CenterDetermination.detection_Hough-1905"><span class="linenos">1905</span></a>        <span class="c1"># Close live plot (to avoid non-closed windows in Jupyter)</span>
</span><span id="CenterDetermination.detection_Hough-1906"><a href="#CenterDetermination.detection_Hough-1906"><span class="linenos">1906</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1907"><a href="#CenterDetermination.detection_Hough-1907"><span class="linenos">1907</span></a>        
</span><span id="CenterDetermination.detection_Hough-1908"><a href="#CenterDetermination.detection_Hough-1908"><span class="linenos">1908</span></a>        <span class="c1">## (6) Final detected circle visualization (if requested) --------------</span>
</span><span id="CenterDetermination.detection_Hough-1909"><a href="#CenterDetermination.detection_Hough-1909"><span class="linenos">1909</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1910"><a href="#CenterDetermination.detection_Hough-1910"><span class="linenos">1910</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1911"><a href="#CenterDetermination.detection_Hough-1911"><span class="linenos">1911</span></a>    
</span><span id="CenterDetermination.detection_Hough-1912"><a href="#CenterDetermination.detection_Hough-1912"><span class="linenos">1912</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
</span></pre></div>


            <div class="docstring"><p>Perform Hough transform to detect the center of diffraction patterns 
with optional real-time visualization and a final image showing all 
detected circles.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>plot_results</strong> (int, binary):
If 1, shows the final detected circle.</li>
<li><strong>sobel</strong> (bool, optional, default=False):
If True, applies Sobel filtering to enhance edges prior to processing.</li>
<li><strong>sobel</strong></li>
<li><strong>live_plot</strong> (bool, optional, default=False):
If True, animates the circle detection process and shows all 
detected circles.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>self.x</strong> (float64):
x-coordinate of the detected center.</li>
<li><strong>self.y</strong> (float64):
y-coordinate of the detected center.</li>
<li><strong>self.r</strong> (float64):
Radius of the detected circle.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_curvefit" class="classattr">
                                        <input id="CenterDetermination.detection_curvefit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_curvefit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_curvefit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_curvefit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_curvefit-1915"><a href="#CenterDetermination.detection_curvefit-1915"><span class="linenos">1915</span></a>    <span class="k">def</span> <span class="nf">detection_curvefit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_curvefit-1916"><a href="#CenterDetermination.detection_curvefit-1916"><span class="linenos">1916</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_curvefit-1917"><a href="#CenterDetermination.detection_curvefit-1917"><span class="linenos">1917</span></a><span class="sd">        Detects the center of a diffraction pattern by fitting a 2D pseudo-Voigt </span>
</span><span id="CenterDetermination.detection_curvefit-1918"><a href="#CenterDetermination.detection_curvefit-1918"><span class="linenos">1918</span></a><span class="sd">        function to the central region of the image.</span>
</span><span id="CenterDetermination.detection_curvefit-1919"><a href="#CenterDetermination.detection_curvefit-1919"><span class="linenos">1919</span></a><span class="sd">     </span>
</span><span id="CenterDetermination.detection_curvefit-1920"><a href="#CenterDetermination.detection_curvefit-1920"><span class="linenos">1920</span></a><span class="sd">        This method:</span>
</span><span id="CenterDetermination.detection_curvefit-1921"><a href="#CenterDetermination.detection_curvefit-1921"><span class="linenos">1921</span></a><span class="sd">            - Crops a square region around the image center.</span>
</span><span id="CenterDetermination.detection_curvefit-1922"><a href="#CenterDetermination.detection_curvefit-1922"><span class="linenos">1922</span></a><span class="sd">            - Fits a 2D pseudo-Voigt peak to the cropped region.</span>
</span><span id="CenterDetermination.detection_curvefit-1923"><a href="#CenterDetermination.detection_curvefit-1923"><span class="linenos">1923</span></a><span class="sd">            - Returns the refined center coordinates in the original image space.</span>
</span><span id="CenterDetermination.detection_curvefit-1924"><a href="#CenterDetermination.detection_curvefit-1924"><span class="linenos">1924</span></a><span class="sd">            - Optionally visualizes the result.</span>
</span><span id="CenterDetermination.detection_curvefit-1925"><a href="#CenterDetermination.detection_curvefit-1925"><span class="linenos">1925</span></a><span class="sd">            - Falls back to the crop center if fitting fails.</span>
</span><span id="CenterDetermination.detection_curvefit-1926"><a href="#CenterDetermination.detection_curvefit-1926"><span class="linenos">1926</span></a><span class="sd">     </span>
</span><span id="CenterDetermination.detection_curvefit-1927"><a href="#CenterDetermination.detection_curvefit-1927"><span class="linenos">1927</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_curvefit-1928"><a href="#CenterDetermination.detection_curvefit-1928"><span class="linenos">1928</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_curvefit-1929"><a href="#CenterDetermination.detection_curvefit-1929"><span class="linenos">1929</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="CenterDetermination.detection_curvefit-1930"><a href="#CenterDetermination.detection_curvefit-1930"><span class="linenos">1930</span></a><span class="sd">            If True, displays the fitted center location on the image. </span>
</span><span id="CenterDetermination.detection_curvefit-1931"><a href="#CenterDetermination.detection_curvefit-1931"><span class="linenos">1931</span></a><span class="sd">     </span>
</span><span id="CenterDetermination.detection_curvefit-1932"><a href="#CenterDetermination.detection_curvefit-1932"><span class="linenos">1932</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_curvefit-1933"><a href="#CenterDetermination.detection_curvefit-1933"><span class="linenos">1933</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_curvefit-1934"><a href="#CenterDetermination.detection_curvefit-1934"><span class="linenos">1934</span></a><span class="sd">        x : float</span>
</span><span id="CenterDetermination.detection_curvefit-1935"><a href="#CenterDetermination.detection_curvefit-1935"><span class="linenos">1935</span></a><span class="sd">            Refined x-coordinate of the center (column index).</span>
</span><span id="CenterDetermination.detection_curvefit-1936"><a href="#CenterDetermination.detection_curvefit-1936"><span class="linenos">1936</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_curvefit-1937"><a href="#CenterDetermination.detection_curvefit-1937"><span class="linenos">1937</span></a><span class="sd">        y : float</span>
</span><span id="CenterDetermination.detection_curvefit-1938"><a href="#CenterDetermination.detection_curvefit-1938"><span class="linenos">1938</span></a><span class="sd">            Refined y-coordinate of the center (row index).</span>
</span><span id="CenterDetermination.detection_curvefit-1939"><a href="#CenterDetermination.detection_curvefit-1939"><span class="linenos">1939</span></a>
</span><span id="CenterDetermination.detection_curvefit-1940"><a href="#CenterDetermination.detection_curvefit-1940"><span class="linenos">1940</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_curvefit-1941"><a href="#CenterDetermination.detection_curvefit-1941"><span class="linenos">1941</span></a>    
</span><span id="CenterDetermination.detection_curvefit-1942"><a href="#CenterDetermination.detection_curvefit-1942"><span class="linenos">1942</span></a>        <span class="k">def</span> <span class="nf">pseudo_voigt_2d</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_curvefit-1943"><a href="#CenterDetermination.detection_curvefit-1943"><span class="linenos">1943</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_curvefit-1944"><a href="#CenterDetermination.detection_curvefit-1944"><span class="linenos">1944</span></a><span class="sd">            Computes a 2D pseudo-Voigt function, which is a linear combination </span>
</span><span id="CenterDetermination.detection_curvefit-1945"><a href="#CenterDetermination.detection_curvefit-1945"><span class="linenos">1945</span></a><span class="sd">            of a Gaussian and a Lorentzian function.</span>
</span><span id="CenterDetermination.detection_curvefit-1946"><a href="#CenterDetermination.detection_curvefit-1946"><span class="linenos">1946</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_curvefit-1947"><a href="#CenterDetermination.detection_curvefit-1947"><span class="linenos">1947</span></a><span class="sd">            Parameters</span>
</span><span id="CenterDetermination.detection_curvefit-1948"><a href="#CenterDetermination.detection_curvefit-1948"><span class="linenos">1948</span></a><span class="sd">            ----------</span>
</span><span id="CenterDetermination.detection_curvefit-1949"><a href="#CenterDetermination.detection_curvefit-1949"><span class="linenos">1949</span></a><span class="sd">            xy : tuple of numpy.ndarray</span>
</span><span id="CenterDetermination.detection_curvefit-1950"><a href="#CenterDetermination.detection_curvefit-1950"><span class="linenos">1950</span></a><span class="sd">                A tuple (x, y) containing coordinate meshgrids.</span>
</span><span id="CenterDetermination.detection_curvefit-1951"><a href="#CenterDetermination.detection_curvefit-1951"><span class="linenos">1951</span></a><span class="sd">                </span>
</span><span id="CenterDetermination.detection_curvefit-1952"><a href="#CenterDetermination.detection_curvefit-1952"><span class="linenos">1952</span></a><span class="sd">            amp : float</span>
</span><span id="CenterDetermination.detection_curvefit-1953"><a href="#CenterDetermination.detection_curvefit-1953"><span class="linenos">1953</span></a><span class="sd">                Amplitude of the peak.</span>
</span><span id="CenterDetermination.detection_curvefit-1954"><a href="#CenterDetermination.detection_curvefit-1954"><span class="linenos">1954</span></a><span class="sd">                </span>
</span><span id="CenterDetermination.detection_curvefit-1955"><a href="#CenterDetermination.detection_curvefit-1955"><span class="linenos">1955</span></a><span class="sd">            x0, y0 : float</span>
</span><span id="CenterDetermination.detection_curvefit-1956"><a href="#CenterDetermination.detection_curvefit-1956"><span class="linenos">1956</span></a><span class="sd">                Coordinates of the center of the peak.</span>
</span><span id="CenterDetermination.detection_curvefit-1957"><a href="#CenterDetermination.detection_curvefit-1957"><span class="linenos">1957</span></a><span class="sd">                </span>
</span><span id="CenterDetermination.detection_curvefit-1958"><a href="#CenterDetermination.detection_curvefit-1958"><span class="linenos">1958</span></a><span class="sd">            sigma_x, sigma_y : float</span>
</span><span id="CenterDetermination.detection_curvefit-1959"><a href="#CenterDetermination.detection_curvefit-1959"><span class="linenos">1959</span></a><span class="sd">                Width (standard deviation) of the peak along the x and y axes.</span>
</span><span id="CenterDetermination.detection_curvefit-1960"><a href="#CenterDetermination.detection_curvefit-1960"><span class="linenos">1960</span></a><span class="sd">                </span>
</span><span id="CenterDetermination.detection_curvefit-1961"><a href="#CenterDetermination.detection_curvefit-1961"><span class="linenos">1961</span></a><span class="sd">            eta : float</span>
</span><span id="CenterDetermination.detection_curvefit-1962"><a href="#CenterDetermination.detection_curvefit-1962"><span class="linenos">1962</span></a><span class="sd">                Mixing parameter (0 = pure Gaussian, 1 = pure Lorentzian).</span>
</span><span id="CenterDetermination.detection_curvefit-1963"><a href="#CenterDetermination.detection_curvefit-1963"><span class="linenos">1963</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_curvefit-1964"><a href="#CenterDetermination.detection_curvefit-1964"><span class="linenos">1964</span></a><span class="sd">            Returns</span>
</span><span id="CenterDetermination.detection_curvefit-1965"><a href="#CenterDetermination.detection_curvefit-1965"><span class="linenos">1965</span></a><span class="sd">            -------</span>
</span><span id="CenterDetermination.detection_curvefit-1966"><a href="#CenterDetermination.detection_curvefit-1966"><span class="linenos">1966</span></a><span class="sd">            numpy.ndarray</span>
</span><span id="CenterDetermination.detection_curvefit-1967"><a href="#CenterDetermination.detection_curvefit-1967"><span class="linenos">1967</span></a><span class="sd">                Flattened 1D array of function values evaluated at the input </span>
</span><span id="CenterDetermination.detection_curvefit-1968"><a href="#CenterDetermination.detection_curvefit-1968"><span class="linenos">1968</span></a><span class="sd">                coordinates.</span>
</span><span id="CenterDetermination.detection_curvefit-1969"><a href="#CenterDetermination.detection_curvefit-1969"><span class="linenos">1969</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_curvefit-1970"><a href="#CenterDetermination.detection_curvefit-1970"><span class="linenos">1970</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
</span><span id="CenterDetermination.detection_curvefit-1971"><a href="#CenterDetermination.detection_curvefit-1971"><span class="linenos">1971</span></a>            <span class="n">r_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_x</span>
</span><span id="CenterDetermination.detection_curvefit-1972"><a href="#CenterDetermination.detection_curvefit-1972"><span class="linenos">1972</span></a>            <span class="n">r_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_y</span>
</span><span id="CenterDetermination.detection_curvefit-1973"><a href="#CenterDetermination.detection_curvefit-1973"><span class="linenos">1973</span></a>    
</span><span id="CenterDetermination.detection_curvefit-1974"><a href="#CenterDetermination.detection_curvefit-1974"><span class="linenos">1974</span></a>            <span class="n">gaussian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-1975"><a href="#CenterDetermination.detection_curvefit-1975"><span class="linenos">1975</span></a>            <span class="n">lorentzian</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-1976"><a href="#CenterDetermination.detection_curvefit-1976"><span class="linenos">1976</span></a>    
</span><span id="CenterDetermination.detection_curvefit-1977"><a href="#CenterDetermination.detection_curvefit-1977"><span class="linenos">1977</span></a>            <span class="k">return</span> <span class="n">amp</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">gaussian</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">lorentzian</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-1978"><a href="#CenterDetermination.detection_curvefit-1978"><span class="linenos">1978</span></a>        
</span><span id="CenterDetermination.detection_curvefit-1979"><a href="#CenterDetermination.detection_curvefit-1979"><span class="linenos">1979</span></a>        <span class="c1"># Define crop size around the center of the image</span>
</span><span id="CenterDetermination.detection_curvefit-1980"><a href="#CenterDetermination.detection_curvefit-1980"><span class="linenos">1980</span></a>        <span class="n">crop_size</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterDetermination.detection_curvefit-1981"><a href="#CenterDetermination.detection_curvefit-1981"><span class="linenos">1981</span></a>        
</span><span id="CenterDetermination.detection_curvefit-1982"><a href="#CenterDetermination.detection_curvefit-1982"><span class="linenos">1982</span></a>        <span class="c1"># Make a copy of the image to avoid modifying the original</span>
</span><span id="CenterDetermination.detection_curvefit-1983"><a href="#CenterDetermination.detection_curvefit-1983"><span class="linenos">1983</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-1984"><a href="#CenterDetermination.detection_curvefit-1984"><span class="linenos">1984</span></a>        
</span><span id="CenterDetermination.detection_curvefit-1985"><a href="#CenterDetermination.detection_curvefit-1985"><span class="linenos">1985</span></a>        <span class="c1"># Get the image dimensions</span>
</span><span id="CenterDetermination.detection_curvefit-1986"><a href="#CenterDetermination.detection_curvefit-1986"><span class="linenos">1986</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterDetermination.detection_curvefit-1987"><a href="#CenterDetermination.detection_curvefit-1987"><span class="linenos">1987</span></a>        
</span><span id="CenterDetermination.detection_curvefit-1988"><a href="#CenterDetermination.detection_curvefit-1988"><span class="linenos">1988</span></a>        <span class="c1"># Estimate the center of the image</span>
</span><span id="CenterDetermination.detection_curvefit-1989"><a href="#CenterDetermination.detection_curvefit-1989"><span class="linenos">1989</span></a>        <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">=</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_curvefit-1990"><a href="#CenterDetermination.detection_curvefit-1990"><span class="linenos">1990</span></a>    
</span><span id="CenterDetermination.detection_curvefit-1991"><a href="#CenterDetermination.detection_curvefit-1991"><span class="linenos">1991</span></a>        <span class="c1"># Calculate the bounds of the cropped square region</span>
</span><span id="CenterDetermination.detection_curvefit-1992"><a href="#CenterDetermination.detection_curvefit-1992"><span class="linenos">1992</span></a>        <span class="n">half_crop</span> <span class="o">=</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_curvefit-1993"><a href="#CenterDetermination.detection_curvefit-1993"><span class="linenos">1993</span></a>        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_center</span> <span class="o">-</span> <span class="n">half_crop</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">half_crop</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-1994"><a href="#CenterDetermination.detection_curvefit-1994"><span class="linenos">1994</span></a>        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">-</span> <span class="n">half_crop</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">+</span> <span class="n">half_crop</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-1995"><a href="#CenterDetermination.detection_curvefit-1995"><span class="linenos">1995</span></a>    
</span><span id="CenterDetermination.detection_curvefit-1996"><a href="#CenterDetermination.detection_curvefit-1996"><span class="linenos">1996</span></a>        <span class="c1"># Crop the image around the center for curve fitting</span>
</span><span id="CenterDetermination.detection_curvefit-1997"><a href="#CenterDetermination.detection_curvefit-1997"><span class="linenos">1997</span></a>        <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_curvefit-1998"><a href="#CenterDetermination.detection_curvefit-1998"><span class="linenos">1998</span></a>    
</span><span id="CenterDetermination.detection_curvefit-1999"><a href="#CenterDetermination.detection_curvefit-1999"><span class="linenos">1999</span></a>        <span class="c1"># Create a meshgrid of x and y coordinates for the cropped region</span>
</span><span id="CenterDetermination.detection_curvefit-2000"><a href="#CenterDetermination.detection_curvefit-2000"><span class="linenos">2000</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="CenterDetermination.detection_curvefit-2001"><a href="#CenterDetermination.detection_curvefit-2001"><span class="linenos">2001</span></a>                           <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="CenterDetermination.detection_curvefit-2002"><a href="#CenterDetermination.detection_curvefit-2002"><span class="linenos">2002</span></a>        
</span><span id="CenterDetermination.detection_curvefit-2003"><a href="#CenterDetermination.detection_curvefit-2003"><span class="linenos">2003</span></a>        <span class="c1"># Flatten the meshgrid coordinates and image for use with curve fitting</span>
</span><span id="CenterDetermination.detection_curvefit-2004"><a href="#CenterDetermination.detection_curvefit-2004"><span class="linenos">2004</span></a>        <span class="n">x_flat</span><span class="p">,</span> <span class="n">y_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_curvefit-2005"><a href="#CenterDetermination.detection_curvefit-2005"><span class="linenos">2005</span></a>        <span class="n">image_flat</span> <span class="o">=</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_curvefit-2006"><a href="#CenterDetermination.detection_curvefit-2006"><span class="linenos">2006</span></a>
</span><span id="CenterDetermination.detection_curvefit-2007"><a href="#CenterDetermination.detection_curvefit-2007"><span class="linenos">2007</span></a>        <span class="c1"># Set initial parameter guesses for curve fitting:</span>
</span><span id="CenterDetermination.detection_curvefit-2008"><a href="#CenterDetermination.detection_curvefit-2008"><span class="linenos">2008</span></a>        <span class="c1"># [amplitude, x0, y0, sigma_x, sigma_y, eta]    </span>
</span><span id="CenterDetermination.detection_curvefit-2009"><a href="#CenterDetermination.detection_curvefit-2009"><span class="linenos">2009</span></a>        <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CenterDetermination.detection_curvefit-2010"><a href="#CenterDetermination.detection_curvefit-2010"><span class="linenos">2010</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">),</span>
</span><span id="CenterDetermination.detection_curvefit-2011"><a href="#CenterDetermination.detection_curvefit-2011"><span class="linenos">2011</span></a>            <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_curvefit-2012"><a href="#CenterDetermination.detection_curvefit-2012"><span class="linenos">2012</span></a>            <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_curvefit-2013"><a href="#CenterDetermination.detection_curvefit-2013"><span class="linenos">2013</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="CenterDetermination.detection_curvefit-2014"><a href="#CenterDetermination.detection_curvefit-2014"><span class="linenos">2014</span></a>            <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span>
</span><span id="CenterDetermination.detection_curvefit-2015"><a href="#CenterDetermination.detection_curvefit-2015"><span class="linenos">2015</span></a>            <span class="mf">0.5</span>
</span><span id="CenterDetermination.detection_curvefit-2016"><a href="#CenterDetermination.detection_curvefit-2016"><span class="linenos">2016</span></a>        <span class="p">]</span>
</span><span id="CenterDetermination.detection_curvefit-2017"><a href="#CenterDetermination.detection_curvefit-2017"><span class="linenos">2017</span></a>        
</span><span id="CenterDetermination.detection_curvefit-2018"><a href="#CenterDetermination.detection_curvefit-2018"><span class="linenos">2018</span></a>        <span class="c1"># Define bounds for each parameter during optimization</span>
</span><span id="CenterDetermination.detection_curvefit-2019"><a href="#CenterDetermination.detection_curvefit-2019"><span class="linenos">2019</span></a>        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination.detection_curvefit-2020"><a href="#CenterDetermination.detection_curvefit-2020"><span class="linenos">2020</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="CenterDetermination.detection_curvefit-2021"><a href="#CenterDetermination.detection_curvefit-2021"><span class="linenos">2021</span></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_curvefit-2022"><a href="#CenterDetermination.detection_curvefit-2022"><span class="linenos">2022</span></a>        <span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-2023"><a href="#CenterDetermination.detection_curvefit-2023"><span class="linenos">2023</span></a>    
</span><span id="CenterDetermination.detection_curvefit-2024"><a href="#CenterDetermination.detection_curvefit-2024"><span class="linenos">2024</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_curvefit-2025"><a href="#CenterDetermination.detection_curvefit-2025"><span class="linenos">2025</span></a>            <span class="c1"># Fit the pseudo-Voigt function to the cropped image</span>
</span><span id="CenterDetermination.detection_curvefit-2026"><a href="#CenterDetermination.detection_curvefit-2026"><span class="linenos">2026</span></a>            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_curvefit-2027"><a href="#CenterDetermination.detection_curvefit-2027"><span class="linenos">2027</span></a>                <span class="n">pseudo_voigt_2d</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_curvefit-2028"><a href="#CenterDetermination.detection_curvefit-2028"><span class="linenos">2028</span></a>                <span class="p">(</span><span class="n">x_flat</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">),</span>
</span><span id="CenterDetermination.detection_curvefit-2029"><a href="#CenterDetermination.detection_curvefit-2029"><span class="linenos">2029</span></a>                <span class="n">image_flat</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_curvefit-2030"><a href="#CenterDetermination.detection_curvefit-2030"><span class="linenos">2030</span></a>                <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_curvefit-2031"><a href="#CenterDetermination.detection_curvefit-2031"><span class="linenos">2031</span></a>                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_curvefit-2032"><a href="#CenterDetermination.detection_curvefit-2032"><span class="linenos">2032</span></a>                <span class="n">max_nfev</span><span class="o">=</span><span class="mi">2000</span>  <span class="c1"># increase if needed</span>
</span><span id="CenterDetermination.detection_curvefit-2033"><a href="#CenterDetermination.detection_curvefit-2033"><span class="linenos">2033</span></a>            <span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-2034"><a href="#CenterDetermination.detection_curvefit-2034"><span class="linenos">2034</span></a>            
</span><span id="CenterDetermination.detection_curvefit-2035"><a href="#CenterDetermination.detection_curvefit-2035"><span class="linenos">2035</span></a>            <span class="c1"># Extract refined x and y center coordinates from fit</span>
</span><span id="CenterDetermination.detection_curvefit-2036"><a href="#CenterDetermination.detection_curvefit-2036"><span class="linenos">2036</span></a>            <span class="n">x_refined</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_curvefit-2037"><a href="#CenterDetermination.detection_curvefit-2037"><span class="linenos">2037</span></a>            <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterDetermination.detection_curvefit-2038"><a href="#CenterDetermination.detection_curvefit-2038"><span class="linenos">2038</span></a>    
</span><span id="CenterDetermination.detection_curvefit-2039"><a href="#CenterDetermination.detection_curvefit-2039"><span class="linenos">2039</span></a>        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_curvefit-2040"><a href="#CenterDetermination.detection_curvefit-2040"><span class="linenos">2040</span></a>            <span class="c1"># If fitting fails, fall back to geometric center </span>
</span><span id="CenterDetermination.detection_curvefit-2041"><a href="#CenterDetermination.detection_curvefit-2041"><span class="linenos">2041</span></a>            <span class="n">x_refined</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">=</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">crop_size</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_curvefit-2042"><a href="#CenterDetermination.detection_curvefit-2042"><span class="linenos">2042</span></a>            <span class="n">used_fallback</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.detection_curvefit-2043"><a href="#CenterDetermination.detection_curvefit-2043"><span class="linenos">2043</span></a>            
</span><span id="CenterDetermination.detection_curvefit-2044"><a href="#CenterDetermination.detection_curvefit-2044"><span class="linenos">2044</span></a>        <span class="c1"># Add the offset of the cropped region to get coordinates in full image</span>
</span><span id="CenterDetermination.detection_curvefit-2045"><a href="#CenterDetermination.detection_curvefit-2045"><span class="linenos">2045</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">x_refined</span> <span class="o">+</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_refined</span> <span class="o">+</span> <span class="n">y_min</span>
</span><span id="CenterDetermination.detection_curvefit-2046"><a href="#CenterDetermination.detection_curvefit-2046"><span class="linenos">2046</span></a>        
</span><span id="CenterDetermination.detection_curvefit-2047"><a href="#CenterDetermination.detection_curvefit-2047"><span class="linenos">2047</span></a>        <span class="c1"># Print the result if verbose are enabled</span>
</span><span id="CenterDetermination.detection_curvefit-2048"><a href="#CenterDetermination.detection_curvefit-2048"><span class="linenos">2048</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_curvefit-2049"><a href="#CenterDetermination.detection_curvefit-2049"><span class="linenos">2049</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination.detection_curvefit-2050"><a href="#CenterDetermination.detection_curvefit-2050"><span class="linenos">2050</span></a>                <span class="sa">f</span><span class="s2">&quot;Center Determination (CurveFitting) :   (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.detection_curvefit-2051"><a href="#CenterDetermination.detection_curvefit-2051"><span class="linenos">2051</span></a>                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; [fallback]&quot;</span> <span class="k">if</span> <span class="n">used_fallback</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-2052"><a href="#CenterDetermination.detection_curvefit-2052"><span class="linenos">2052</span></a>            <span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-2053"><a href="#CenterDetermination.detection_curvefit-2053"><span class="linenos">2053</span></a>            
</span><span id="CenterDetermination.detection_curvefit-2054"><a href="#CenterDetermination.detection_curvefit-2054"><span class="linenos">2054</span></a>        <span class="c1"># Optionally show the result visually</span>
</span><span id="CenterDetermination.detection_curvefit-2055"><a href="#CenterDetermination.detection_curvefit-2055"><span class="linenos">2055</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_curvefit-2056"><a href="#CenterDetermination.detection_curvefit-2056"><span class="linenos">2056</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_curvefit-2057"><a href="#CenterDetermination.detection_curvefit-2057"><span class="linenos">2057</span></a>    
</span><span id="CenterDetermination.detection_curvefit-2058"><a href="#CenterDetermination.detection_curvefit-2058"><span class="linenos">2058</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Detects the center of a diffraction pattern by fitting a 2D pseudo-Voigt 
function to the central region of the image.</p>

<p>This method:
    - Crops a square region around the image center.
    - Fits a 2D pseudo-Voigt peak to the cropped region.
    - Returns the refined center coordinates in the original image space.
    - Optionally visualizes the result.
    - Falls back to the crop center if fitting fails.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>plot_results</strong> (bool, optional, default=False):
If True, displays the fitted center location on the image.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>x</strong> (float):
Refined x-coordinate of the center (column index).</li>
<li><strong>y</strong> (float):
Refined y-coordinate of the center (row index).</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_3points" class="classattr">
                                        <input id="CenterDetermination.detection_3points-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_3points</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_3points-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_3points"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_3points-2061"><a href="#CenterDetermination.detection_3points-2061"><span class="linenos">2061</span></a>    <span class="k">def</span> <span class="nf">detection_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_3points-2062"><a href="#CenterDetermination.detection_3points-2062"><span class="linenos">2062</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination.detection_3points-2063"><a href="#CenterDetermination.detection_3points-2063"><span class="linenos">2063</span></a><span class="sd">        Semi-automated detection of the diffraction pattern center using manual </span>
</span><span id="CenterDetermination.detection_3points-2064"><a href="#CenterDetermination.detection_3points-2064"><span class="linenos">2064</span></a><span class="sd">        selection of 3 points.</span>
</span><span id="CenterDetermination.detection_3points-2065"><a href="#CenterDetermination.detection_3points-2065"><span class="linenos">2065</span></a>
</span><span id="CenterDetermination.detection_3points-2066"><a href="#CenterDetermination.detection_3points-2066"><span class="linenos">2066</span></a><span class="sd">        This method allows the user to manually select 3 points along a visible </span>
</span><span id="CenterDetermination.detection_3points-2067"><a href="#CenterDetermination.detection_3points-2067"><span class="linenos">2067</span></a><span class="sd">        diffraction ring in the image to define a circle. Once selected, </span>
</span><span id="CenterDetermination.detection_3points-2068"><a href="#CenterDetermination.detection_3points-2068"><span class="linenos">2068</span></a><span class="sd">        the center and radius of the circle are automatically computed. After </span>
</span><span id="CenterDetermination.detection_3points-2069"><a href="#CenterDetermination.detection_3points-2069"><span class="linenos">2069</span></a><span class="sd">        that, the user can manually adjust the center position using</span>
</span><span id="CenterDetermination.detection_3points-2070"><a href="#CenterDetermination.detection_3points-2070"><span class="linenos">2070</span></a><span class="sd">        an interactive interface.</span>
</span><span id="CenterDetermination.detection_3points-2071"><a href="#CenterDetermination.detection_3points-2071"><span class="linenos">2071</span></a>
</span><span id="CenterDetermination.detection_3points-2072"><a href="#CenterDetermination.detection_3points-2072"><span class="linenos">2072</span></a><span class="sd">        User Controls (during point selection)</span>
</span><span id="CenterDetermination.detection_3points-2073"><a href="#CenterDetermination.detection_3points-2073"><span class="linenos">2073</span></a><span class="sd">        --------------------------------------</span>
</span><span id="CenterDetermination.detection_3points-2074"><a href="#CenterDetermination.detection_3points-2074"><span class="linenos">2074</span></a><span class="sd">        - **&#39;1&#39;**: Add a point at the current mouse cursor position </span>
</span><span id="CenterDetermination.detection_3points-2075"><a href="#CenterDetermination.detection_3points-2075"><span class="linenos">2075</span></a><span class="sd">                         (max 3 points).</span>
</span><span id="CenterDetermination.detection_3points-2076"><a href="#CenterDetermination.detection_3points-2076"><span class="linenos">2076</span></a><span class="sd">        - **&#39;2&#39;**: Delete the most recently added point.</span>
</span><span id="CenterDetermination.detection_3points-2077"><a href="#CenterDetermination.detection_3points-2077"><span class="linenos">2077</span></a><span class="sd">        - **&#39;3&#39;**: Delete the point closest to the mouse cursor.</span>
</span><span id="CenterDetermination.detection_3points-2078"><a href="#CenterDetermination.detection_3points-2078"><span class="linenos">2078</span></a><span class="sd">        - **&#39;d&#39;**: When 3 points are selected (DONE), proceed </span>
</span><span id="CenterDetermination.detection_3points-2079"><a href="#CenterDetermination.detection_3points-2079"><span class="linenos">2079</span></a><span class="sd">        - **Close**    : Terminate the process without detecting a center.</span>
</span><span id="CenterDetermination.detection_3points-2080"><a href="#CenterDetermination.detection_3points-2080"><span class="linenos">2080</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_3points-2081"><a href="#CenterDetermination.detection_3points-2081"><span class="linenos">2081</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_3points-2082"><a href="#CenterDetermination.detection_3points-2082"><span class="linenos">2082</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_3points-2083"><a href="#CenterDetermination.detection_3points-2083"><span class="linenos">2083</span></a><span class="sd">        plot_results : int, binary, default=0</span>
</span><span id="CenterDetermination.detection_3points-2084"><a href="#CenterDetermination.detection_3points-2084"><span class="linenos">2084</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="CenterDetermination.detection_3points-2085"><a href="#CenterDetermination.detection_3points-2085"><span class="linenos">2085</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_3points-2086"><a href="#CenterDetermination.detection_3points-2086"><span class="linenos">2086</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_3points-2087"><a href="#CenterDetermination.detection_3points-2087"><span class="linenos">2087</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_3points-2088"><a href="#CenterDetermination.detection_3points-2088"><span class="linenos">2088</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination.detection_3points-2089"><a href="#CenterDetermination.detection_3points-2089"><span class="linenos">2089</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination.detection_3points-2090"><a href="#CenterDetermination.detection_3points-2090"><span class="linenos">2090</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_3points-2091"><a href="#CenterDetermination.detection_3points-2091"><span class="linenos">2091</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination.detection_3points-2092"><a href="#CenterDetermination.detection_3points-2092"><span class="linenos">2092</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination.detection_3points-2093"><a href="#CenterDetermination.detection_3points-2093"><span class="linenos">2093</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_3points-2094"><a href="#CenterDetermination.detection_3points-2094"><span class="linenos">2094</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination.detection_3points-2095"><a href="#CenterDetermination.detection_3points-2095"><span class="linenos">2095</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination.detection_3points-2096"><a href="#CenterDetermination.detection_3points-2096"><span class="linenos">2096</span></a><span class="sd">            (if available, othervise returns None)</span>
</span><span id="CenterDetermination.detection_3points-2097"><a href="#CenterDetermination.detection_3points-2097"><span class="linenos">2097</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination.detection_3points-2098"><a href="#CenterDetermination.detection_3points-2098"><span class="linenos">2098</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination.detection_3points-2099"><a href="#CenterDetermination.detection_3points-2099"><span class="linenos">2099</span></a>        <span class="c1"># (0) Load and prepare image ------------------------------------------</span>
</span><span id="CenterDetermination.detection_3points-2100"><a href="#CenterDetermination.detection_3points-2100"><span class="linenos">2100</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span>
</span><span id="CenterDetermination.detection_3points-2101"><a href="#CenterDetermination.detection_3points-2101"><span class="linenos">2101</span></a>        
</span><span id="CenterDetermination.detection_3points-2102"><a href="#CenterDetermination.detection_3points-2102"><span class="linenos">2102</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterDetermination.detection_3points-2103"><a href="#CenterDetermination.detection_3points-2103"><span class="linenos">2103</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2104"><a href="#CenterDetermination.detection_3points-2104"><span class="linenos">2104</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2105"><a href="#CenterDetermination.detection_3points-2105"><span class="linenos">2105</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2106"><a href="#CenterDetermination.detection_3points-2106"><span class="linenos">2106</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2107"><a href="#CenterDetermination.detection_3points-2107"><span class="linenos">2107</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2108"><a href="#CenterDetermination.detection_3points-2108"><span class="linenos">2108</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2109"><a href="#CenterDetermination.detection_3points-2109"><span class="linenos">2109</span></a>            
</span><span id="CenterDetermination.detection_3points-2110"><a href="#CenterDetermination.detection_3points-2110"><span class="linenos">2110</span></a>        <span class="c1"># (2) Create a figure and display the image ---------------------------</span>
</span><span id="CenterDetermination.detection_3points-2111"><a href="#CenterDetermination.detection_3points-2111"><span class="linenos">2111</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> 
</span><span id="CenterDetermination.detection_3points-2112"><a href="#CenterDetermination.detection_3points-2112"><span class="linenos">2112</span></a>        
</span><span id="CenterDetermination.detection_3points-2113"><a href="#CenterDetermination.detection_3points-2113"><span class="linenos">2113</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination.detection_3points-2114"><a href="#CenterDetermination.detection_3points-2114"><span class="linenos">2114</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2115"><a href="#CenterDetermination.detection_3points-2115"><span class="linenos">2115</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2116"><a href="#CenterDetermination.detection_3points-2116"><span class="linenos">2116</span></a> 
</span><span id="CenterDetermination.detection_3points-2117"><a href="#CenterDetermination.detection_3points-2117"><span class="linenos">2117</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Select 3 points defining one of diffraction circles&quot;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2118"><a href="#CenterDetermination.detection_3points-2118"><span class="linenos">2118</span></a>                  <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2119"><a href="#CenterDetermination.detection_3points-2119"><span class="linenos">2119</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2120"><a href="#CenterDetermination.detection_3points-2120"><span class="linenos">2120</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2121"><a href="#CenterDetermination.detection_3points-2121"><span class="linenos">2121</span></a>
</span><span id="CenterDetermination.detection_3points-2122"><a href="#CenterDetermination.detection_3points-2122"><span class="linenos">2122</span></a>        <span class="c1"># (3) User information ------------------------------------------------</span>
</span><span id="CenterDetermination.detection_3points-2123"><a href="#CenterDetermination.detection_3points-2123"><span class="linenos">2123</span></a>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-2124"><a href="#CenterDetermination.detection_3points-2124"><span class="linenos">2124</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_3points-2125"><a href="#CenterDetermination.detection_3points-2125"><span class="linenos">2125</span></a><span class="sd">            CenterDetermination :: ThreePoints (semi-automated method)</span>
</span><span id="CenterDetermination.detection_3points-2126"><a href="#CenterDetermination.detection_3points-2126"><span class="linenos">2126</span></a><span class="sd">            Select 3 points to define a diffraction circle using keys:</span>
</span><span id="CenterDetermination.detection_3points-2127"><a href="#CenterDetermination.detection_3points-2127"><span class="linenos">2127</span></a><span class="sd">              - &#39;1&#39; : define a point at current cursor position</span>
</span><span id="CenterDetermination.detection_3points-2128"><a href="#CenterDetermination.detection_3points-2128"><span class="linenos">2128</span></a><span class="sd">              - &#39;2&#39; : delete the last point</span>
</span><span id="CenterDetermination.detection_3points-2129"><a href="#CenterDetermination.detection_3points-2129"><span class="linenos">2129</span></a><span class="sd">              - &#39;3&#39; : delete the point closest to the cursor</span>
</span><span id="CenterDetermination.detection_3points-2130"><a href="#CenterDetermination.detection_3points-2130"><span class="linenos">2130</span></a><span class="sd">              - &#39;d&#39; : done = finished = go to the next step</span>
</span><span id="CenterDetermination.detection_3points-2131"><a href="#CenterDetermination.detection_3points-2131"><span class="linenos">2131</span></a><span class="sd">            Close the figure to terminate. No center will be detected.</span>
</span><span id="CenterDetermination.detection_3points-2132"><a href="#CenterDetermination.detection_3points-2132"><span class="linenos">2132</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2133"><a href="#CenterDetermination.detection_3points-2133"><span class="linenos">2133</span></a>
</span><span id="CenterDetermination.detection_3points-2134"><a href="#CenterDetermination.detection_3points-2134"><span class="linenos">2134</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_3points-2135"><a href="#CenterDetermination.detection_3points-2135"><span class="linenos">2135</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2136"><a href="#CenterDetermination.detection_3points-2136"><span class="linenos">2136</span></a>       
</span><span id="CenterDetermination.detection_3points-2137"><a href="#CenterDetermination.detection_3points-2137"><span class="linenos">2137</span></a>        <span class="c1"># (4) Enable interactive mode -----------------------------------------</span>
</span><span id="CenterDetermination.detection_3points-2138"><a href="#CenterDetermination.detection_3points-2138"><span class="linenos">2138</span></a>        <span class="c1"># (figure is updated after every plotting command</span>
</span><span id="CenterDetermination.detection_3points-2139"><a href="#CenterDetermination.detection_3points-2139"><span class="linenos">2139</span></a>        <span class="c1"># (so that calling figure.show() is not necessary</span>
</span><span id="CenterDetermination.detection_3points-2140"><a href="#CenterDetermination.detection_3points-2140"><span class="linenos">2140</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2141"><a href="#CenterDetermination.detection_3points-2141"><span class="linenos">2141</span></a> 
</span><span id="CenterDetermination.detection_3points-2142"><a href="#CenterDetermination.detection_3points-2142"><span class="linenos">2142</span></a>        <span class="c1"># (5) Initialization</span>
</span><span id="CenterDetermination.detection_3points-2143"><a href="#CenterDetermination.detection_3points-2143"><span class="linenos">2143</span></a>        <span class="c1"># Initialize the list of coordinates</span>
</span><span id="CenterDetermination.detection_3points-2144"><a href="#CenterDetermination.detection_3points-2144"><span class="linenos">2144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span> 
</span><span id="CenterDetermination.detection_3points-2145"><a href="#CenterDetermination.detection_3points-2145"><span class="linenos">2145</span></a>        
</span><span id="CenterDetermination.detection_3points-2146"><a href="#CenterDetermination.detection_3points-2146"><span class="linenos">2146</span></a>        <span class="c1"># Initialize all flags and counters</span>
</span><span id="CenterDetermination.detection_3points-2147"><a href="#CenterDetermination.detection_3points-2147"><span class="linenos">2147</span></a>        <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># press &#39;d&#39; event</span>
</span><span id="CenterDetermination.detection_3points-2148"><a href="#CenterDetermination.detection_3points-2148"><span class="linenos">2148</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># close window event</span>
</span><span id="CenterDetermination.detection_3points-2149"><a href="#CenterDetermination.detection_3points-2149"><span class="linenos">2149</span></a>        <span class="n">point_counter</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># number of selected points</span>
</span><span id="CenterDetermination.detection_3points-2150"><a href="#CenterDetermination.detection_3points-2150"><span class="linenos">2150</span></a>        
</span><span id="CenterDetermination.detection_3points-2151"><a href="#CenterDetermination.detection_3points-2151"><span class="linenos">2151</span></a>        <span class="c1"># (6) Define the event handler for figure close event -----------------</span>
</span><span id="CenterDetermination.detection_3points-2152"><a href="#CenterDetermination.detection_3points-2152"><span class="linenos">2152</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_3points-2153"><a href="#CenterDetermination.detection_3points-2153"><span class="linenos">2153</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.detection_3points-2154"><a href="#CenterDetermination.detection_3points-2154"><span class="linenos">2154</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.detection_3points-2155"><a href="#CenterDetermination.detection_3points-2155"><span class="linenos">2155</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2156"><a href="#CenterDetermination.detection_3points-2156"><span class="linenos">2156</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execution terminated.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2157"><a href="#CenterDetermination.detection_3points-2157"><span class="linenos">2157</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2158"><a href="#CenterDetermination.detection_3points-2158"><span class="linenos">2158</span></a>
</span><span id="CenterDetermination.detection_3points-2159"><a href="#CenterDetermination.detection_3points-2159"><span class="linenos">2159</span></a> 
</span><span id="CenterDetermination.detection_3points-2160"><a href="#CenterDetermination.detection_3points-2160"><span class="linenos">2160</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination.detection_3points-2161"><a href="#CenterDetermination.detection_3points-2161"><span class="linenos">2161</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2162"><a href="#CenterDetermination.detection_3points-2162"><span class="linenos">2162</span></a>        
</span><span id="CenterDetermination.detection_3points-2163"><a href="#CenterDetermination.detection_3points-2163"><span class="linenos">2163</span></a>        
</span><span id="CenterDetermination.detection_3points-2164"><a href="#CenterDetermination.detection_3points-2164"><span class="linenos">2164</span></a>        <span class="c1"># (7) Define the callback function for key press events ---------------</span>
</span><span id="CenterDetermination.detection_3points-2165"><a href="#CenterDetermination.detection_3points-2165"><span class="linenos">2165</span></a>        <span class="k">def</span> <span class="nf">onkeypress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_3points-2166"><a href="#CenterDetermination.detection_3points-2166"><span class="linenos">2166</span></a>            <span class="c1"># nonlocal to modify the flag variable in the outer scope</span>
</span><span id="CenterDetermination.detection_3points-2167"><a href="#CenterDetermination.detection_3points-2167"><span class="linenos">2167</span></a>            <span class="k">nonlocal</span> <span class="n">calculate_circle_flag</span><span class="p">,</span> <span class="n">point_counter</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.detection_3points-2168"><a href="#CenterDetermination.detection_3points-2168"><span class="linenos">2168</span></a>            
</span><span id="CenterDetermination.detection_3points-2169"><a href="#CenterDetermination.detection_3points-2169"><span class="linenos">2169</span></a>            <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination.detection_3points-2170"><a href="#CenterDetermination.detection_3points-2170"><span class="linenos">2170</span></a>            <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2171"><a href="#CenterDetermination.detection_3points-2171"><span class="linenos">2171</span></a>            <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2172"><a href="#CenterDetermination.detection_3points-2172"><span class="linenos">2172</span></a> 
</span><span id="CenterDetermination.detection_3points-2173"><a href="#CenterDetermination.detection_3points-2173"><span class="linenos">2173</span></a>            <span class="c1">## Delete points -- the closest to the cursor</span>
</span><span id="CenterDetermination.detection_3points-2174"><a href="#CenterDetermination.detection_3points-2174"><span class="linenos">2174</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2175"><a href="#CenterDetermination.detection_3points-2175"><span class="linenos">2175</span></a>                <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.detection_3points-2176"><a href="#CenterDetermination.detection_3points-2176"><span class="linenos">2176</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2177"><a href="#CenterDetermination.detection_3points-2177"><span class="linenos">2177</span></a>                    <span class="n">pointer_x</span><span class="p">,</span> <span class="n">pointer_y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
</span><span id="CenterDetermination.detection_3points-2178"><a href="#CenterDetermination.detection_3points-2178"><span class="linenos">2178</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CenterDetermination.detection_3points-2179"><a href="#CenterDetermination.detection_3points-2179"><span class="linenos">2179</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">pointer_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">pointer_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2180"><a href="#CenterDetermination.detection_3points-2180"><span class="linenos">2180</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-2181"><a href="#CenterDetermination.detection_3points-2181"><span class="linenos">2181</span></a>                    <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2182"><a href="#CenterDetermination.detection_3points-2182"><span class="linenos">2182</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">closest_index</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-2183"><a href="#CenterDetermination.detection_3points-2183"><span class="linenos">2183</span></a>    
</span><span id="CenterDetermination.detection_3points-2184"><a href="#CenterDetermination.detection_3points-2184"><span class="linenos">2184</span></a>                    <span class="c1">## Redraw the image without the deleted point</span>
</span><span id="CenterDetermination.detection_3points-2185"><a href="#CenterDetermination.detection_3points-2185"><span class="linenos">2185</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2186"><a href="#CenterDetermination.detection_3points-2186"><span class="linenos">2186</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-2187"><a href="#CenterDetermination.detection_3points-2187"><span class="linenos">2187</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2188"><a href="#CenterDetermination.detection_3points-2188"><span class="linenos">2188</span></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2189"><a href="#CenterDetermination.detection_3points-2189"><span class="linenos">2189</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2190"><a href="#CenterDetermination.detection_3points-2190"><span class="linenos">2190</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2191"><a href="#CenterDetermination.detection_3points-2191"><span class="linenos">2191</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2192"><a href="#CenterDetermination.detection_3points-2192"><span class="linenos">2192</span></a>
</span><span id="CenterDetermination.detection_3points-2193"><a href="#CenterDetermination.detection_3points-2193"><span class="linenos">2193</span></a>                    <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-2194"><a href="#CenterDetermination.detection_3points-2194"><span class="linenos">2194</span></a>                        <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination.detection_3points-2195"><a href="#CenterDetermination.detection_3points-2195"><span class="linenos">2195</span></a>                        <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2196"><a href="#CenterDetermination.detection_3points-2196"><span class="linenos">2196</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2197"><a href="#CenterDetermination.detection_3points-2197"><span class="linenos">2197</span></a>                    
</span><span id="CenterDetermination.detection_3points-2198"><a href="#CenterDetermination.detection_3points-2198"><span class="linenos">2198</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-2199"><a href="#CenterDetermination.detection_3points-2199"><span class="linenos">2199</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2200"><a href="#CenterDetermination.detection_3points-2200"><span class="linenos">2200</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2201"><a href="#CenterDetermination.detection_3points-2201"><span class="linenos">2201</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2202"><a href="#CenterDetermination.detection_3points-2202"><span class="linenos">2202</span></a>                    
</span><span id="CenterDetermination.detection_3points-2203"><a href="#CenterDetermination.detection_3points-2203"><span class="linenos">2203</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2204"><a href="#CenterDetermination.detection_3points-2204"><span class="linenos">2204</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2205"><a href="#CenterDetermination.detection_3points-2205"><span class="linenos">2205</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2206"><a href="#CenterDetermination.detection_3points-2206"><span class="linenos">2206</span></a>    
</span><span id="CenterDetermination.detection_3points-2207"><a href="#CenterDetermination.detection_3points-2207"><span class="linenos">2207</span></a>            <span class="c1"># Delete recent point (last added) -- independent on the cursor</span>
</span><span id="CenterDetermination.detection_3points-2208"><a href="#CenterDetermination.detection_3points-2208"><span class="linenos">2208</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2209"><a href="#CenterDetermination.detection_3points-2209"><span class="linenos">2209</span></a>                <span class="c1"># Check if there are points to delete</span>
</span><span id="CenterDetermination.detection_3points-2210"><a href="#CenterDetermination.detection_3points-2210"><span class="linenos">2210</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span><span id="CenterDetermination.detection_3points-2211"><a href="#CenterDetermination.detection_3points-2211"><span class="linenos">2211</span></a>                    <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.detection_3points-2212"><a href="#CenterDetermination.detection_3points-2212"><span class="linenos">2212</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2213"><a href="#CenterDetermination.detection_3points-2213"><span class="linenos">2213</span></a>                        <span class="c1"># Delete the last point in the list</span>
</span><span id="CenterDetermination.detection_3points-2214"><a href="#CenterDetermination.detection_3points-2214"><span class="linenos">2214</span></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-2215"><a href="#CenterDetermination.detection_3points-2215"><span class="linenos">2215</span></a>    
</span><span id="CenterDetermination.detection_3points-2216"><a href="#CenterDetermination.detection_3points-2216"><span class="linenos">2216</span></a>                        <span class="c1"># Redraw the image without the deleted point</span>
</span><span id="CenterDetermination.detection_3points-2217"><a href="#CenterDetermination.detection_3points-2217"><span class="linenos">2217</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2218"><a href="#CenterDetermination.detection_3points-2218"><span class="linenos">2218</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-2219"><a href="#CenterDetermination.detection_3points-2219"><span class="linenos">2219</span></a>                                  <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2220"><a href="#CenterDetermination.detection_3points-2220"><span class="linenos">2220</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2221"><a href="#CenterDetermination.detection_3points-2221"><span class="linenos">2221</span></a>                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-2222"><a href="#CenterDetermination.detection_3points-2222"><span class="linenos">2222</span></a>                                       <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2223"><a href="#CenterDetermination.detection_3points-2223"><span class="linenos">2223</span></a>                                       <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2224"><a href="#CenterDetermination.detection_3points-2224"><span class="linenos">2224</span></a>
</span><span id="CenterDetermination.detection_3points-2225"><a href="#CenterDetermination.detection_3points-2225"><span class="linenos">2225</span></a>                        <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-2226"><a href="#CenterDetermination.detection_3points-2226"><span class="linenos">2226</span></a>                            <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination.detection_3points-2227"><a href="#CenterDetermination.detection_3points-2227"><span class="linenos">2227</span></a>                            <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2228"><a href="#CenterDetermination.detection_3points-2228"><span class="linenos">2228</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2229"><a href="#CenterDetermination.detection_3points-2229"><span class="linenos">2229</span></a>                        
</span><span id="CenterDetermination.detection_3points-2230"><a href="#CenterDetermination.detection_3points-2230"><span class="linenos">2230</span></a>                        <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-2231"><a href="#CenterDetermination.detection_3points-2231"><span class="linenos">2231</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2232"><a href="#CenterDetermination.detection_3points-2232"><span class="linenos">2232</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2233"><a href="#CenterDetermination.detection_3points-2233"><span class="linenos">2233</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2234"><a href="#CenterDetermination.detection_3points-2234"><span class="linenos">2234</span></a>
</span><span id="CenterDetermination.detection_3points-2235"><a href="#CenterDetermination.detection_3points-2235"><span class="linenos">2235</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2236"><a href="#CenterDetermination.detection_3points-2236"><span class="linenos">2236</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2237"><a href="#CenterDetermination.detection_3points-2237"><span class="linenos">2237</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2238"><a href="#CenterDetermination.detection_3points-2238"><span class="linenos">2238</span></a>                    
</span><span id="CenterDetermination.detection_3points-2239"><a href="#CenterDetermination.detection_3points-2239"><span class="linenos">2239</span></a>            <span class="c1">## Select points </span>
</span><span id="CenterDetermination.detection_3points-2240"><a href="#CenterDetermination.detection_3points-2240"><span class="linenos">2240</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2241"><a href="#CenterDetermination.detection_3points-2241"><span class="linenos">2241</span></a>                <span class="c1"># Only allow selecting up to three points</span>
</span><span id="CenterDetermination.detection_3points-2242"><a href="#CenterDetermination.detection_3points-2242"><span class="linenos">2242</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  
</span><span id="CenterDetermination.detection_3points-2243"><a href="#CenterDetermination.detection_3points-2243"><span class="linenos">2243</span></a>                    <span class="c1"># Save the coordinates of the clicked point</span>
</span><span id="CenterDetermination.detection_3points-2244"><a href="#CenterDetermination.detection_3points-2244"><span class="linenos">2244</span></a>                    <span class="n">new_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2245"><a href="#CenterDetermination.detection_3points-2245"><span class="linenos">2245</span></a>                    
</span><span id="CenterDetermination.detection_3points-2246"><a href="#CenterDetermination.detection_3points-2246"><span class="linenos">2246</span></a>                    <span class="k">if</span> <span class="n">new_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2247"><a href="#CenterDetermination.detection_3points-2247"><span class="linenos">2247</span></a>                        <span class="c1"># Do not allow multiple selection of one point</span>
</span><span id="CenterDetermination.detection_3points-2248"><a href="#CenterDetermination.detection_3points-2248"><span class="linenos">2248</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The selected point already exists.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2249"><a href="#CenterDetermination.detection_3points-2249"><span class="linenos">2249</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2250"><a href="#CenterDetermination.detection_3points-2250"><span class="linenos">2250</span></a>                        <span class="c1"># Add selected point</span>
</span><span id="CenterDetermination.detection_3points-2251"><a href="#CenterDetermination.detection_3points-2251"><span class="linenos">2251</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2252"><a href="#CenterDetermination.detection_3points-2252"><span class="linenos">2252</span></a>    
</span><span id="CenterDetermination.detection_3points-2253"><a href="#CenterDetermination.detection_3points-2253"><span class="linenos">2253</span></a>                        <span class="c1"># Visualize the selected point on the image</span>
</span><span id="CenterDetermination.detection_3points-2254"><a href="#CenterDetermination.detection_3points-2254"><span class="linenos">2254</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2255"><a href="#CenterDetermination.detection_3points-2255"><span class="linenos">2255</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-2256"><a href="#CenterDetermination.detection_3points-2256"><span class="linenos">2256</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2257"><a href="#CenterDetermination.detection_3points-2257"><span class="linenos">2257</span></a>
</span><span id="CenterDetermination.detection_3points-2258"><a href="#CenterDetermination.detection_3points-2258"><span class="linenos">2258</span></a>                        <span class="c1"># Restore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-2259"><a href="#CenterDetermination.detection_3points-2259"><span class="linenos">2259</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2260"><a href="#CenterDetermination.detection_3points-2260"><span class="linenos">2260</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2261"><a href="#CenterDetermination.detection_3points-2261"><span class="linenos">2261</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2262"><a href="#CenterDetermination.detection_3points-2262"><span class="linenos">2262</span></a>
</span><span id="CenterDetermination.detection_3points-2263"><a href="#CenterDetermination.detection_3points-2263"><span class="linenos">2263</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2264"><a href="#CenterDetermination.detection_3points-2264"><span class="linenos">2264</span></a>    
</span><span id="CenterDetermination.detection_3points-2265"><a href="#CenterDetermination.detection_3points-2265"><span class="linenos">2265</span></a>                        <span class="n">point_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.detection_3points-2266"><a href="#CenterDetermination.detection_3points-2266"><span class="linenos">2266</span></a>
</span><span id="CenterDetermination.detection_3points-2267"><a href="#CenterDetermination.detection_3points-2267"><span class="linenos">2267</span></a>    
</span><span id="CenterDetermination.detection_3points-2268"><a href="#CenterDetermination.detection_3points-2268"><span class="linenos">2268</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2269"><a href="#CenterDetermination.detection_3points-2269"><span class="linenos">2269</span></a>                    <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination.detection_3points-2270"><a href="#CenterDetermination.detection_3points-2270"><span class="linenos">2270</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2271"><a href="#CenterDetermination.detection_3points-2271"><span class="linenos">2271</span></a>    
</span><span id="CenterDetermination.detection_3points-2272"><a href="#CenterDetermination.detection_3points-2272"><span class="linenos">2272</span></a>
</span><span id="CenterDetermination.detection_3points-2273"><a href="#CenterDetermination.detection_3points-2273"><span class="linenos">2273</span></a>    
</span><span id="CenterDetermination.detection_3points-2274"><a href="#CenterDetermination.detection_3points-2274"><span class="linenos">2274</span></a>            <span class="c1"># (8) Calculate circle or terminate -------------------------------</span>
</span><span id="CenterDetermination.detection_3points-2275"><a href="#CenterDetermination.detection_3points-2275"><span class="linenos">2275</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2276"><a href="#CenterDetermination.detection_3points-2276"><span class="linenos">2276</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2277"><a href="#CenterDetermination.detection_3points-2277"><span class="linenos">2277</span></a>                    <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.detection_3points-2278"><a href="#CenterDetermination.detection_3points-2278"><span class="linenos">2278</span></a> 
</span><span id="CenterDetermination.detection_3points-2279"><a href="#CenterDetermination.detection_3points-2279"><span class="linenos">2279</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2280"><a href="#CenterDetermination.detection_3points-2280"><span class="linenos">2280</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select exactly 3 points to calculate the circle.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2281"><a href="#CenterDetermination.detection_3points-2281"><span class="linenos">2281</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2282"><a href="#CenterDetermination.detection_3points-2282"><span class="linenos">2282</span></a>    
</span><span id="CenterDetermination.detection_3points-2283"><a href="#CenterDetermination.detection_3points-2283"><span class="linenos">2283</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination.detection_3points-2284"><a href="#CenterDetermination.detection_3points-2284"><span class="linenos">2284</span></a>        <span class="n">cid0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2285"><a href="#CenterDetermination.detection_3points-2285"><span class="linenos">2285</span></a>
</span><span id="CenterDetermination.detection_3points-2286"><a href="#CenterDetermination.detection_3points-2286"><span class="linenos">2286</span></a>        <span class="c1"># Show the plot </span>
</span><span id="CenterDetermination.detection_3points-2287"><a href="#CenterDetermination.detection_3points-2287"><span class="linenos">2287</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2288"><a href="#CenterDetermination.detection_3points-2288"><span class="linenos">2288</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2289"><a href="#CenterDetermination.detection_3points-2289"><span class="linenos">2289</span></a>
</span><span id="CenterDetermination.detection_3points-2290"><a href="#CenterDetermination.detection_3points-2290"><span class="linenos">2290</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2291"><a href="#CenterDetermination.detection_3points-2291"><span class="linenos">2291</span></a>      
</span><span id="CenterDetermination.detection_3points-2292"><a href="#CenterDetermination.detection_3points-2292"><span class="linenos">2292</span></a>        <span class="c1"># Wait for &#39;d&#39; key event or close the figure if no points are selected</span>
</span><span id="CenterDetermination.detection_3points-2293"><a href="#CenterDetermination.detection_3points-2293"><span class="linenos">2293</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">calculate_circle_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2294"><a href="#CenterDetermination.detection_3points-2294"><span class="linenos">2294</span></a> 
</span><span id="CenterDetermination.detection_3points-2295"><a href="#CenterDetermination.detection_3points-2295"><span class="linenos">2295</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2296"><a href="#CenterDetermination.detection_3points-2296"><span class="linenos">2296</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2297"><a href="#CenterDetermination.detection_3points-2297"><span class="linenos">2297</span></a>                <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination.detection_3points-2298"><a href="#CenterDetermination.detection_3points-2298"><span class="linenos">2298</span></a>                <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2299"><a href="#CenterDetermination.detection_3points-2299"><span class="linenos">2299</span></a>                <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2300"><a href="#CenterDetermination.detection_3points-2300"><span class="linenos">2300</span></a> 
</span><span id="CenterDetermination.detection_3points-2301"><a href="#CenterDetermination.detection_3points-2301"><span class="linenos">2301</span></a>                <span class="c1"># Plot detected diffraction pattern</span>
</span><span id="CenterDetermination.detection_3points-2302"><a href="#CenterDetermination.detection_3points-2302"><span class="linenos">2302</span></a>                <span class="k">if</span> <span class="n">calculate_circle_flag</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2303"><a href="#CenterDetermination.detection_3points-2303"><span class="linenos">2303</span></a> 
</span><span id="CenterDetermination.detection_3points-2304"><a href="#CenterDetermination.detection_3points-2304"><span class="linenos">2304</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_circle</span><span class="p">(</span><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2305"><a href="#CenterDetermination.detection_3points-2305"><span class="linenos">2305</span></a>                    
</span><span id="CenterDetermination.detection_3points-2306"><a href="#CenterDetermination.detection_3points-2306"><span class="linenos">2306</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2307"><a href="#CenterDetermination.detection_3points-2307"><span class="linenos">2307</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-2308"><a href="#CenterDetermination.detection_3points-2308"><span class="linenos">2308</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2309"><a href="#CenterDetermination.detection_3points-2309"><span class="linenos">2309</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-2310"><a href="#CenterDetermination.detection_3points-2310"><span class="linenos">2310</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2311"><a href="#CenterDetermination.detection_3points-2311"><span class="linenos">2311</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2312"><a href="#CenterDetermination.detection_3points-2312"><span class="linenos">2312</span></a>                 
</span><span id="CenterDetermination.detection_3points-2313"><a href="#CenterDetermination.detection_3points-2313"><span class="linenos">2313</span></a>                    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-2314"><a href="#CenterDetermination.detection_3points-2314"><span class="linenos">2314</span></a>                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2315"><a href="#CenterDetermination.detection_3points-2315"><span class="linenos">2315</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2316"><a href="#CenterDetermination.detection_3points-2316"><span class="linenos">2316</span></a>        
</span><span id="CenterDetermination.detection_3points-2317"><a href="#CenterDetermination.detection_3points-2317"><span class="linenos">2317</span></a>                    <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination.detection_3points-2318"><a href="#CenterDetermination.detection_3points-2318"><span class="linenos">2318</span></a>                    <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2319"><a href="#CenterDetermination.detection_3points-2319"><span class="linenos">2319</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the position of the center using keys.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2320"><a href="#CenterDetermination.detection_3points-2320"><span class="linenos">2320</span></a>        
</span><span id="CenterDetermination.detection_3points-2321"><a href="#CenterDetermination.detection_3points-2321"><span class="linenos">2321</span></a>                    <span class="c1"># Display the image</span>
</span><span id="CenterDetermination.detection_3points-2322"><a href="#CenterDetermination.detection_3points-2322"><span class="linenos">2322</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2323"><a href="#CenterDetermination.detection_3points-2323"><span class="linenos">2323</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2324"><a href="#CenterDetermination.detection_3points-2324"><span class="linenos">2324</span></a>
</span><span id="CenterDetermination.detection_3points-2325"><a href="#CenterDetermination.detection_3points-2325"><span class="linenos">2325</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2326"><a href="#CenterDetermination.detection_3points-2326"><span class="linenos">2326</span></a>
</span><span id="CenterDetermination.detection_3points-2327"><a href="#CenterDetermination.detection_3points-2327"><span class="linenos">2327</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2328"><a href="#CenterDetermination.detection_3points-2328"><span class="linenos">2328</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution manually interrupted by user.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2329"><a href="#CenterDetermination.detection_3points-2329"><span class="linenos">2329</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination.detection_3points-2330"><a href="#CenterDetermination.detection_3points-2330"><span class="linenos">2330</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-2331"><a href="#CenterDetermination.detection_3points-2331"><span class="linenos">2331</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ValueError:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2332"><a href="#CenterDetermination.detection_3points-2332"><span class="linenos">2332</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination.detection_3points-2333"><a href="#CenterDetermination.detection_3points-2333"><span class="linenos">2333</span></a>           
</span><span id="CenterDetermination.detection_3points-2334"><a href="#CenterDetermination.detection_3points-2334"><span class="linenos">2334</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination.detection_3points-2335"><a href="#CenterDetermination.detection_3points-2335"><span class="linenos">2335</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination.detection_3points-2336"><a href="#CenterDetermination.detection_3points-2336"><span class="linenos">2336</span></a>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points selected. Returned None values.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2337"><a href="#CenterDetermination.detection_3points-2337"><span class="linenos">2337</span></a>             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-2338"><a href="#CenterDetermination.detection_3points-2338"><span class="linenos">2338</span></a>             <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.detection_3points-2339"><a href="#CenterDetermination.detection_3points-2339"><span class="linenos">2339</span></a>        
</span><span id="CenterDetermination.detection_3points-2340"><a href="#CenterDetermination.detection_3points-2340"><span class="linenos">2340</span></a>        <span class="c1"># Disconnect key press events</span>
</span><span id="CenterDetermination.detection_3points-2341"><a href="#CenterDetermination.detection_3points-2341"><span class="linenos">2341</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">cid0</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_3points-2342"><a href="#CenterDetermination.detection_3points-2342"><span class="linenos">2342</span></a>        
</span><span id="CenterDetermination.detection_3points-2343"><a href="#CenterDetermination.detection_3points-2343"><span class="linenos">2343</span></a>        <span class="c1"># local variables save</span>
</span><span id="CenterDetermination.detection_3points-2344"><a href="#CenterDetermination.detection_3points-2344"><span class="linenos">2344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
</span><span id="CenterDetermination.detection_3points-2345"><a href="#CenterDetermination.detection_3points-2345"><span class="linenos">2345</span></a>        
</span><span id="CenterDetermination.detection_3points-2346"><a href="#CenterDetermination.detection_3points-2346"><span class="linenos">2346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-2347"><a href="#CenterDetermination.detection_3points-2347"><span class="linenos">2347</span></a>        <span class="c1"># Manually adjust the calculated center coordinates</span>
</span><span id="CenterDetermination.detection_3points-2348"><a href="#CenterDetermination.detection_3points-2348"><span class="linenos">2348</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjustment_3points</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-2349"><a href="#CenterDetermination.detection_3points-2349"><span class="linenos">2349</span></a>
</span><span id="CenterDetermination.detection_3points-2350"><a href="#CenterDetermination.detection_3points-2350"><span class="linenos">2350</span></a>        <span class="c1"># Return the results:</span>
</span><span id="CenterDetermination.detection_3points-2351"><a href="#CenterDetermination.detection_3points-2351"><span class="linenos">2351</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="CenterDetermination.detection_3points-2352"><a href="#CenterDetermination.detection_3points-2352"><span class="linenos">2352</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination.detection_3points-2353"><a href="#CenterDetermination.detection_3points-2353"><span class="linenos">2353</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="CenterDetermination.detection_3points-2354"><a href="#CenterDetermination.detection_3points-2354"><span class="linenos">2354</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Semi-automated detection of the diffraction pattern center using manual 
selection of 3 points.</p>

<p>This method allows the user to manually select 3 points along a visible 
diffraction ring in the image to define a circle. Once selected, 
the center and radius of the circle are automatically computed. After 
that, the user can manually adjust the center position using
an interactive interface.</p>

<h2 id="user-controls-during-point-selection">User Controls (during point selection)</h2>

<ul>
<li><strong>'1'</strong>: Add a point at the current mouse cursor position 
(max 3 points).</li>
<li><strong>'2'</strong>: Delete the most recently added point.</li>
<li><strong>'3'</strong>: Delete the point closest to the mouse cursor.</li>
<li><strong>'d'</strong>: When 3 points are selected (DONE), proceed </li>
<li><strong>Close</strong>    : Terminate the process without detecting a center.</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>plot_results</strong> (int, binary, default=0):
Plot the pattern determined by pixels selected by the user.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>self.x</strong> (float64):
x-coordinate of the detected center</li>
<li><strong>self.y</strong> (float64):
y-coordinate of the detected center</li>
<li><strong>self.r</strong> (float64):
radius of the detected center
(if available, othervise returns None)</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.adjustment_3points" class="classattr">
                                        <input id="CenterDetermination.adjustment_3points-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">adjustment_3points</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fig</span>, </span><span class="param"><span class="n">circle</span>, </span><span class="param"><span class="n">center</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">) -> <span class="nb">tuple</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.adjustment_3points-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.adjustment_3points"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.adjustment_3points-2357"><a href="#CenterDetermination.adjustment_3points-2357"><span class="linenos">2357</span></a>    <span class="k">def</span> <span class="nf">adjustment_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2358"><a href="#CenterDetermination.adjustment_3points-2358"><span class="linenos">2358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.adjustment_3points-2359"><a href="#CenterDetermination.adjustment_3points-2359"><span class="linenos">2359</span></a><span class="sd">        Manual/interactive refinement of the diffraction pattern center</span>
</span><span id="CenterDetermination.adjustment_3points-2360"><a href="#CenterDetermination.adjustment_3points-2360"><span class="linenos">2360</span></a><span class="sd">        after initial detection via 3 points.</span>
</span><span id="CenterDetermination.adjustment_3points-2361"><a href="#CenterDetermination.adjustment_3points-2361"><span class="linenos">2361</span></a>
</span><span id="CenterDetermination.adjustment_3points-2362"><a href="#CenterDetermination.adjustment_3points-2362"><span class="linenos">2362</span></a><span class="sd">        User Controls (during point selection)</span>
</span><span id="CenterDetermination.adjustment_3points-2363"><a href="#CenterDetermination.adjustment_3points-2363"><span class="linenos">2363</span></a><span class="sd">        --------------------------------------</span>
</span><span id="CenterDetermination.adjustment_3points-2364"><a href="#CenterDetermination.adjustment_3points-2364"><span class="linenos">2364</span></a><span class="sd">        This method allows the user to fine-tune the estimated</span>
</span><span id="CenterDetermination.adjustment_3points-2365"><a href="#CenterDetermination.adjustment_3points-2365"><span class="linenos">2365</span></a><span class="sd">        center and radius of a diffraction ring,</span>
</span><span id="CenterDetermination.adjustment_3points-2366"><a href="#CenterDetermination.adjustment_3points-2366"><span class="linenos">2366</span></a><span class="sd">        (which was determined manually by selecting 3 points)</span>
</span><span id="CenterDetermination.adjustment_3points-2367"><a href="#CenterDetermination.adjustment_3points-2367"><span class="linenos">2367</span></a><span class="sd">        by means of the following interactive keyboard controls:</span>
</span><span id="CenterDetermination.adjustment_3points-2368"><a href="#CenterDetermination.adjustment_3points-2368"><span class="linenos">2368</span></a>
</span><span id="CenterDetermination.adjustment_3points-2369"><a href="#CenterDetermination.adjustment_3points-2369"><span class="linenos">2369</span></a><span class="sd">        - Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</span>
</span><span id="CenterDetermination.adjustment_3points-2370"><a href="#CenterDetermination.adjustment_3points-2370"><span class="linenos">2370</span></a><span class="sd">        - **&#39;+&#39;** : Increase the radius</span>
</span><span id="CenterDetermination.adjustment_3points-2371"><a href="#CenterDetermination.adjustment_3points-2371"><span class="linenos">2371</span></a><span class="sd">        - **&#39;-&#39;** : Decrease the radius</span>
</span><span id="CenterDetermination.adjustment_3points-2372"><a href="#CenterDetermination.adjustment_3points-2372"><span class="linenos">2372</span></a><span class="sd">        - **&#39;b&#39;** : Increase step size (×5)</span>
</span><span id="CenterDetermination.adjustment_3points-2373"><a href="#CenterDetermination.adjustment_3points-2373"><span class="linenos">2373</span></a><span class="sd">        - **&#39;l&#39;** : Decrease step size (/5, with minimum step size 0.5)</span>
</span><span id="CenterDetermination.adjustment_3points-2374"><a href="#CenterDetermination.adjustment_3points-2374"><span class="linenos">2374</span></a><span class="sd">        - **&#39;d&#39;**: Done — finalize the center and radius</span>
</span><span id="CenterDetermination.adjustment_3points-2375"><a href="#CenterDetermination.adjustment_3points-2375"><span class="linenos">2375</span></a><span class="sd">        - Closing the figure: Cancels refinement and returns the original input </span>
</span><span id="CenterDetermination.adjustment_3points-2376"><a href="#CenterDetermination.adjustment_3points-2376"><span class="linenos">2376</span></a><span class="sd">          center and radius</span>
</span><span id="CenterDetermination.adjustment_3points-2377"><a href="#CenterDetermination.adjustment_3points-2377"><span class="linenos">2377</span></a>
</span><span id="CenterDetermination.adjustment_3points-2378"><a href="#CenterDetermination.adjustment_3points-2378"><span class="linenos">2378</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.adjustment_3points-2379"><a href="#CenterDetermination.adjustment_3points-2379"><span class="linenos">2379</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.adjustment_3points-2380"><a href="#CenterDetermination.adjustment_3points-2380"><span class="linenos">2380</span></a><span class="sd">        fig : matplotlib.figure.Figure</span>
</span><span id="CenterDetermination.adjustment_3points-2381"><a href="#CenterDetermination.adjustment_3points-2381"><span class="linenos">2381</span></a><span class="sd">            The figure window used for interactive refinement.</span>
</span><span id="CenterDetermination.adjustment_3points-2382"><a href="#CenterDetermination.adjustment_3points-2382"><span class="linenos">2382</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.adjustment_3points-2383"><a href="#CenterDetermination.adjustment_3points-2383"><span class="linenos">2383</span></a><span class="sd">        circle : matplotlib.patches.Circle</span>
</span><span id="CenterDetermination.adjustment_3points-2384"><a href="#CenterDetermination.adjustment_3points-2384"><span class="linenos">2384</span></a><span class="sd">            The circle object initially defined from 3 selected points.</span>
</span><span id="CenterDetermination.adjustment_3points-2385"><a href="#CenterDetermination.adjustment_3points-2385"><span class="linenos">2385</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.adjustment_3points-2386"><a href="#CenterDetermination.adjustment_3points-2386"><span class="linenos">2386</span></a><span class="sd">        center : tuple</span>
</span><span id="CenterDetermination.adjustment_3points-2387"><a href="#CenterDetermination.adjustment_3points-2387"><span class="linenos">2387</span></a><span class="sd">            The initial (x, y) center coordinates estimated from the selected </span>
</span><span id="CenterDetermination.adjustment_3points-2388"><a href="#CenterDetermination.adjustment_3points-2388"><span class="linenos">2388</span></a><span class="sd">            points.</span>
</span><span id="CenterDetermination.adjustment_3points-2389"><a href="#CenterDetermination.adjustment_3points-2389"><span class="linenos">2389</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.adjustment_3points-2390"><a href="#CenterDetermination.adjustment_3points-2390"><span class="linenos">2390</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="CenterDetermination.adjustment_3points-2391"><a href="#CenterDetermination.adjustment_3points-2391"><span class="linenos">2391</span></a><span class="sd">            If True, the results of the adjustment are visualized.</span>
</span><span id="CenterDetermination.adjustment_3points-2392"><a href="#CenterDetermination.adjustment_3points-2392"><span class="linenos">2392</span></a>
</span><span id="CenterDetermination.adjustment_3points-2393"><a href="#CenterDetermination.adjustment_3points-2393"><span class="linenos">2393</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.adjustment_3points-2394"><a href="#CenterDetermination.adjustment_3points-2394"><span class="linenos">2394</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.adjustment_3points-2395"><a href="#CenterDetermination.adjustment_3points-2395"><span class="linenos">2395</span></a><span class="sd">        xy[0] : float</span>
</span><span id="CenterDetermination.adjustment_3points-2396"><a href="#CenterDetermination.adjustment_3points-2396"><span class="linenos">2396</span></a><span class="sd">            x-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterDetermination.adjustment_3points-2397"><a href="#CenterDetermination.adjustment_3points-2397"><span class="linenos">2397</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.adjustment_3points-2398"><a href="#CenterDetermination.adjustment_3points-2398"><span class="linenos">2398</span></a><span class="sd">        xy[1] : float</span>
</span><span id="CenterDetermination.adjustment_3points-2399"><a href="#CenterDetermination.adjustment_3points-2399"><span class="linenos">2399</span></a><span class="sd">            y-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterDetermination.adjustment_3points-2400"><a href="#CenterDetermination.adjustment_3points-2400"><span class="linenos">2400</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.adjustment_3points-2401"><a href="#CenterDetermination.adjustment_3points-2401"><span class="linenos">2401</span></a><span class="sd">        r : float</span>
</span><span id="CenterDetermination.adjustment_3points-2402"><a href="#CenterDetermination.adjustment_3points-2402"><span class="linenos">2402</span></a><span class="sd">            Adjusted radius of the diffraction ring.</span>
</span><span id="CenterDetermination.adjustment_3points-2403"><a href="#CenterDetermination.adjustment_3points-2403"><span class="linenos">2403</span></a>
</span><span id="CenterDetermination.adjustment_3points-2404"><a href="#CenterDetermination.adjustment_3points-2404"><span class="linenos">2404</span></a><span class="sd">        Notes</span>
</span><span id="CenterDetermination.adjustment_3points-2405"><a href="#CenterDetermination.adjustment_3points-2405"><span class="linenos">2405</span></a><span class="sd">        -----</span>
</span><span id="CenterDetermination.adjustment_3points-2406"><a href="#CenterDetermination.adjustment_3points-2406"><span class="linenos">2406</span></a><span class="sd">        - Interactive adjustments are visualized in real time.</span>
</span><span id="CenterDetermination.adjustment_3points-2407"><a href="#CenterDetermination.adjustment_3points-2407"><span class="linenos">2407</span></a><span class="sd">        - Intensity sum at the current center/radius is printed if print_sums</span>
</span><span id="CenterDetermination.adjustment_3points-2408"><a href="#CenterDetermination.adjustment_3points-2408"><span class="linenos">2408</span></a><span class="sd">          is True.</span>
</span><span id="CenterDetermination.adjustment_3points-2409"><a href="#CenterDetermination.adjustment_3points-2409"><span class="linenos">2409</span></a><span class="sd">        - Arrow key defaults in Matplotlib (e.g., navigation) are temporarily </span>
</span><span id="CenterDetermination.adjustment_3points-2410"><a href="#CenterDetermination.adjustment_3points-2410"><span class="linenos">2410</span></a><span class="sd">          disabled to allow movement control.</span>
</span><span id="CenterDetermination.adjustment_3points-2411"><a href="#CenterDetermination.adjustment_3points-2411"><span class="linenos">2411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.adjustment_3points-2412"><a href="#CenterDetermination.adjustment_3points-2412"><span class="linenos">2412</span></a>                    
</span><span id="CenterDetermination.adjustment_3points-2413"><a href="#CenterDetermination.adjustment_3points-2413"><span class="linenos">2413</span></a>        <span class="c1"># Remove default left / right arrow key press events</span>
</span><span id="CenterDetermination.adjustment_3points-2414"><a href="#CenterDetermination.adjustment_3points-2414"><span class="linenos">2414</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2415"><a href="#CenterDetermination.adjustment_3points-2415"><span class="linenos">2415</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2416"><a href="#CenterDetermination.adjustment_3points-2416"><span class="linenos">2416</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2417"><a href="#CenterDetermination.adjustment_3points-2417"><span class="linenos">2417</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterDetermination.adjustment_3points-2418"><a href="#CenterDetermination.adjustment_3points-2418"><span class="linenos">2418</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination.adjustment_3points-2419"><a href="#CenterDetermination.adjustment_3points-2419"><span class="linenos">2419</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.adjustment_3points-2420"><a href="#CenterDetermination.adjustment_3points-2420"><span class="linenos">2420</span></a><span class="sd">            CenterDetermination :: ThreePoints (interactive adjustment)</span>
</span><span id="CenterDetermination.adjustment_3points-2421"><a href="#CenterDetermination.adjustment_3points-2421"><span class="linenos">2421</span></a><span class="sd">            Use these keys:</span>
</span><span id="CenterDetermination.adjustment_3points-2422"><a href="#CenterDetermination.adjustment_3points-2422"><span class="linenos">2422</span></a><span class="sd">              - &#39;←&#39; : move left</span>
</span><span id="CenterDetermination.adjustment_3points-2423"><a href="#CenterDetermination.adjustment_3points-2423"><span class="linenos">2423</span></a><span class="sd">              - &#39;→&#39; : move right</span>
</span><span id="CenterDetermination.adjustment_3points-2424"><a href="#CenterDetermination.adjustment_3points-2424"><span class="linenos">2424</span></a><span class="sd">              - &#39;↑&#39; : move up</span>
</span><span id="CenterDetermination.adjustment_3points-2425"><a href="#CenterDetermination.adjustment_3points-2425"><span class="linenos">2425</span></a><span class="sd">              - &#39;↓&#39; : move down</span>
</span><span id="CenterDetermination.adjustment_3points-2426"><a href="#CenterDetermination.adjustment_3points-2426"><span class="linenos">2426</span></a><span class="sd">              - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterDetermination.adjustment_3points-2427"><a href="#CenterDetermination.adjustment_3points-2427"><span class="linenos">2427</span></a><span class="sd">              - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterDetermination.adjustment_3points-2428"><a href="#CenterDetermination.adjustment_3points-2428"><span class="linenos">2428</span></a><span class="sd">              - &#39;b&#39; : increase step size</span>
</span><span id="CenterDetermination.adjustment_3points-2429"><a href="#CenterDetermination.adjustment_3points-2429"><span class="linenos">2429</span></a><span class="sd">              - &#39;l&#39; : decrease step size</span>
</span><span id="CenterDetermination.adjustment_3points-2430"><a href="#CenterDetermination.adjustment_3points-2430"><span class="linenos">2430</span></a><span class="sd">              - &#39;d&#39; : refinement done</span>
</span><span id="CenterDetermination.adjustment_3points-2431"><a href="#CenterDetermination.adjustment_3points-2431"><span class="linenos">2431</span></a><span class="sd">                  </span>
</span><span id="CenterDetermination.adjustment_3points-2432"><a href="#CenterDetermination.adjustment_3points-2432"><span class="linenos">2432</span></a><span class="sd">            DISCLAIMER: For the purpose of the center position adjustment, </span>
</span><span id="CenterDetermination.adjustment_3points-2433"><a href="#CenterDetermination.adjustment_3points-2433"><span class="linenos">2433</span></a><span class="sd">                        the default shortcuts for arrows were removed.</span>
</span><span id="CenterDetermination.adjustment_3points-2434"><a href="#CenterDetermination.adjustment_3points-2434"><span class="linenos">2434</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2435"><a href="#CenterDetermination.adjustment_3points-2435"><span class="linenos">2435</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2436"><a href="#CenterDetermination.adjustment_3points-2436"><span class="linenos">2436</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2437"><a href="#CenterDetermination.adjustment_3points-2437"><span class="linenos">2437</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2438"><a href="#CenterDetermination.adjustment_3points-2438"><span class="linenos">2438</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2439"><a href="#CenterDetermination.adjustment_3points-2439"><span class="linenos">2439</span></a>            
</span><span id="CenterDetermination.adjustment_3points-2440"><a href="#CenterDetermination.adjustment_3points-2440"><span class="linenos">2440</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="CenterDetermination.adjustment_3points-2441"><a href="#CenterDetermination.adjustment_3points-2441"><span class="linenos">2441</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination.adjustment_3points-2442"><a href="#CenterDetermination.adjustment_3points-2442"><span class="linenos">2442</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination.adjustment_3points-2443"><a href="#CenterDetermination.adjustment_3points-2443"><span class="linenos">2443</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2444"><a href="#CenterDetermination.adjustment_3points-2444"><span class="linenos">2444</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterDetermination.adjustment_3points-2445"><a href="#CenterDetermination.adjustment_3points-2445"><span class="linenos">2445</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2446"><a href="#CenterDetermination.adjustment_3points-2446"><span class="linenos">2446</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2447"><a href="#CenterDetermination.adjustment_3points-2447"><span class="linenos">2447</span></a>
</span><span id="CenterDetermination.adjustment_3points-2448"><a href="#CenterDetermination.adjustment_3points-2448"><span class="linenos">2448</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-2449"><a href="#CenterDetermination.adjustment_3points-2449"><span class="linenos">2449</span></a>          
</span><span id="CenterDetermination.adjustment_3points-2450"><a href="#CenterDetermination.adjustment_3points-2450"><span class="linenos">2450</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterDetermination.adjustment_3points-2451"><a href="#CenterDetermination.adjustment_3points-2451"><span class="linenos">2451</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.adjustment_3points-2452"><a href="#CenterDetermination.adjustment_3points-2452"><span class="linenos">2452</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.adjustment_3points-2453"><a href="#CenterDetermination.adjustment_3points-2453"><span class="linenos">2453</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.adjustment_3points-2454"><a href="#CenterDetermination.adjustment_3points-2454"><span class="linenos">2454</span></a>
</span><span id="CenterDetermination.adjustment_3points-2455"><a href="#CenterDetermination.adjustment_3points-2455"><span class="linenos">2455</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination.adjustment_3points-2456"><a href="#CenterDetermination.adjustment_3points-2456"><span class="linenos">2456</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2457"><a href="#CenterDetermination.adjustment_3points-2457"><span class="linenos">2457</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2458"><a href="#CenterDetermination.adjustment_3points-2458"><span class="linenos">2458</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="CenterDetermination.adjustment_3points-2459"><a href="#CenterDetermination.adjustment_3points-2459"><span class="linenos">2459</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.adjustment_3points-2460"><a href="#CenterDetermination.adjustment_3points-2460"><span class="linenos">2460</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterDetermination.adjustment_3points-2461"><a href="#CenterDetermination.adjustment_3points-2461"><span class="linenos">2461</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.adjustment_3points-2462"><a href="#CenterDetermination.adjustment_3points-2462"><span class="linenos">2462</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2463"><a href="#CenterDetermination.adjustment_3points-2463"><span class="linenos">2463</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterDetermination.adjustment_3points-2464"><a href="#CenterDetermination.adjustment_3points-2464"><span class="linenos">2464</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterDetermination.adjustment_3points-2465"><a href="#CenterDetermination.adjustment_3points-2465"><span class="linenos">2465</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterDetermination.adjustment_3points-2466"><a href="#CenterDetermination.adjustment_3points-2466"><span class="linenos">2466</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterDetermination.adjustment_3points-2467"><a href="#CenterDetermination.adjustment_3points-2467"><span class="linenos">2467</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterDetermination.adjustment_3points-2468"><a href="#CenterDetermination.adjustment_3points-2468"><span class="linenos">2468</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterDetermination.adjustment_3points-2469"><a href="#CenterDetermination.adjustment_3points-2469"><span class="linenos">2469</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterDetermination.adjustment_3points-2470"><a href="#CenterDetermination.adjustment_3points-2470"><span class="linenos">2470</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterDetermination.adjustment_3points-2471"><a href="#CenterDetermination.adjustment_3points-2471"><span class="linenos">2471</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterDetermination.adjustment_3points-2472"><a href="#CenterDetermination.adjustment_3points-2472"><span class="linenos">2472</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2473"><a href="#CenterDetermination.adjustment_3points-2473"><span class="linenos">2473</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterDetermination.adjustment_3points-2474"><a href="#CenterDetermination.adjustment_3points-2474"><span class="linenos">2474</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterDetermination.adjustment_3points-2475"><a href="#CenterDetermination.adjustment_3points-2475"><span class="linenos">2475</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterDetermination.adjustment_3points-2476"><a href="#CenterDetermination.adjustment_3points-2476"><span class="linenos">2476</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2477"><a href="#CenterDetermination.adjustment_3points-2477"><span class="linenos">2477</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterDetermination.adjustment_3points-2478"><a href="#CenterDetermination.adjustment_3points-2478"><span class="linenos">2478</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2479"><a href="#CenterDetermination.adjustment_3points-2479"><span class="linenos">2479</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-2480"><a href="#CenterDetermination.adjustment_3points-2480"><span class="linenos">2480</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2481"><a href="#CenterDetermination.adjustment_3points-2481"><span class="linenos">2481</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-2482"><a href="#CenterDetermination.adjustment_3points-2482"><span class="linenos">2482</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2483"><a href="#CenterDetermination.adjustment_3points-2483"><span class="linenos">2483</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-2484"><a href="#CenterDetermination.adjustment_3points-2484"><span class="linenos">2484</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2485"><a href="#CenterDetermination.adjustment_3points-2485"><span class="linenos">2485</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-2486"><a href="#CenterDetermination.adjustment_3points-2486"><span class="linenos">2486</span></a>                    
</span><span id="CenterDetermination.adjustment_3points-2487"><a href="#CenterDetermination.adjustment_3points-2487"><span class="linenos">2487</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterDetermination.adjustment_3points-2488"><a href="#CenterDetermination.adjustment_3points-2488"><span class="linenos">2488</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2489"><a href="#CenterDetermination.adjustment_3points-2489"><span class="linenos">2489</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.adjustment_3points-2490"><a href="#CenterDetermination.adjustment_3points-2490"><span class="linenos">2490</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2491"><a href="#CenterDetermination.adjustment_3points-2491"><span class="linenos">2491</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2492"><a href="#CenterDetermination.adjustment_3points-2492"><span class="linenos">2492</span></a>            
</span><span id="CenterDetermination.adjustment_3points-2493"><a href="#CenterDetermination.adjustment_3points-2493"><span class="linenos">2493</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterDetermination.adjustment_3points-2494"><a href="#CenterDetermination.adjustment_3points-2494"><span class="linenos">2494</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2495"><a href="#CenterDetermination.adjustment_3points-2495"><span class="linenos">2495</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.adjustment_3points-2496"><a href="#CenterDetermination.adjustment_3points-2496"><span class="linenos">2496</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2497"><a href="#CenterDetermination.adjustment_3points-2497"><span class="linenos">2497</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterDetermination.adjustment_3points-2498"><a href="#CenterDetermination.adjustment_3points-2498"><span class="linenos">2498</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2499"><a href="#CenterDetermination.adjustment_3points-2499"><span class="linenos">2499</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterDetermination.adjustment_3points-2500"><a href="#CenterDetermination.adjustment_3points-2500"><span class="linenos">2500</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2501"><a href="#CenterDetermination.adjustment_3points-2501"><span class="linenos">2501</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2502"><a href="#CenterDetermination.adjustment_3points-2502"><span class="linenos">2502</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterDetermination.adjustment_3points-2503"><a href="#CenterDetermination.adjustment_3points-2503"><span class="linenos">2503</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2504"><a href="#CenterDetermination.adjustment_3points-2504"><span class="linenos">2504</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterDetermination.adjustment_3points-2505"><a href="#CenterDetermination.adjustment_3points-2505"><span class="linenos">2505</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2506"><a href="#CenterDetermination.adjustment_3points-2506"><span class="linenos">2506</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterDetermination.adjustment_3points-2507"><a href="#CenterDetermination.adjustment_3points-2507"><span class="linenos">2507</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterDetermination.adjustment_3points-2508"><a href="#CenterDetermination.adjustment_3points-2508"><span class="linenos">2508</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterDetermination.adjustment_3points-2509"><a href="#CenterDetermination.adjustment_3points-2509"><span class="linenos">2509</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterDetermination.adjustment_3points-2510"><a href="#CenterDetermination.adjustment_3points-2510"><span class="linenos">2510</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2511"><a href="#CenterDetermination.adjustment_3points-2511"><span class="linenos">2511</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2512"><a href="#CenterDetermination.adjustment_3points-2512"><span class="linenos">2512</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2513"><a href="#CenterDetermination.adjustment_3points-2513"><span class="linenos">2513</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterDetermination.adjustment_3points-2514"><a href="#CenterDetermination.adjustment_3points-2514"><span class="linenos">2514</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-2515"><a href="#CenterDetermination.adjustment_3points-2515"><span class="linenos">2515</span></a>
</span><span id="CenterDetermination.adjustment_3points-2516"><a href="#CenterDetermination.adjustment_3points-2516"><span class="linenos">2516</span></a>                
</span><span id="CenterDetermination.adjustment_3points-2517"><a href="#CenterDetermination.adjustment_3points-2517"><span class="linenos">2517</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterDetermination.adjustment_3points-2518"><a href="#CenterDetermination.adjustment_3points-2518"><span class="linenos">2518</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2519"><a href="#CenterDetermination.adjustment_3points-2519"><span class="linenos">2519</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2520"><a href="#CenterDetermination.adjustment_3points-2520"><span class="linenos">2520</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination.adjustment_3points-2521"><a href="#CenterDetermination.adjustment_3points-2521"><span class="linenos">2521</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2522"><a href="#CenterDetermination.adjustment_3points-2522"><span class="linenos">2522</span></a>
</span><span id="CenterDetermination.adjustment_3points-2523"><a href="#CenterDetermination.adjustment_3points-2523"><span class="linenos">2523</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterDetermination.adjustment_3points-2524"><a href="#CenterDetermination.adjustment_3points-2524"><span class="linenos">2524</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterDetermination.adjustment_3points-2525"><a href="#CenterDetermination.adjustment_3points-2525"><span class="linenos">2525</span></a>               
</span><span id="CenterDetermination.adjustment_3points-2526"><a href="#CenterDetermination.adjustment_3points-2526"><span class="linenos">2526</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterDetermination.adjustment_3points-2527"><a href="#CenterDetermination.adjustment_3points-2527"><span class="linenos">2527</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2528"><a href="#CenterDetermination.adjustment_3points-2528"><span class="linenos">2528</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2529"><a href="#CenterDetermination.adjustment_3points-2529"><span class="linenos">2529</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2530"><a href="#CenterDetermination.adjustment_3points-2530"><span class="linenos">2530</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-2531"><a href="#CenterDetermination.adjustment_3points-2531"><span class="linenos">2531</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterDetermination.adjustment_3points-2532"><a href="#CenterDetermination.adjustment_3points-2532"><span class="linenos">2532</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.adjustment_3points-2533"><a href="#CenterDetermination.adjustment_3points-2533"><span class="linenos">2533</span></a>                
</span><span id="CenterDetermination.adjustment_3points-2534"><a href="#CenterDetermination.adjustment_3points-2534"><span class="linenos">2534</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination.adjustment_3points-2535"><a href="#CenterDetermination.adjustment_3points-2535"><span class="linenos">2535</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-2536"><a href="#CenterDetermination.adjustment_3points-2536"><span class="linenos">2536</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2537"><a href="#CenterDetermination.adjustment_3points-2537"><span class="linenos">2537</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterDetermination.adjustment_3points-2538"><a href="#CenterDetermination.adjustment_3points-2538"><span class="linenos">2538</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-2539"><a href="#CenterDetermination.adjustment_3points-2539"><span class="linenos">2539</span></a>
</span><span id="CenterDetermination.adjustment_3points-2540"><a href="#CenterDetermination.adjustment_3points-2540"><span class="linenos">2540</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-2541"><a href="#CenterDetermination.adjustment_3points-2541"><span class="linenos">2541</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2542"><a href="#CenterDetermination.adjustment_3points-2542"><span class="linenos">2542</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination.adjustment_3points-2543"><a href="#CenterDetermination.adjustment_3points-2543"><span class="linenos">2543</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination.adjustment_3points-2544"><a href="#CenterDetermination.adjustment_3points-2544"><span class="linenos">2544</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterDetermination.adjustment_3points-2545"><a href="#CenterDetermination.adjustment_3points-2545"><span class="linenos">2545</span></a>
</span><span id="CenterDetermination.adjustment_3points-2546"><a href="#CenterDetermination.adjustment_3points-2546"><span class="linenos">2546</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination.adjustment_3points-2547"><a href="#CenterDetermination.adjustment_3points-2547"><span class="linenos">2547</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination.adjustment_3points-2548"><a href="#CenterDetermination.adjustment_3points-2548"><span class="linenos">2548</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (ThreePoints)    : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.adjustment_3points-2549"><a href="#CenterDetermination.adjustment_3points-2549"><span class="linenos">2549</span></a>        
</span><span id="CenterDetermination.adjustment_3points-2550"><a href="#CenterDetermination.adjustment_3points-2550"><span class="linenos">2550</span></a>    
</span><span id="CenterDetermination.adjustment_3points-2551"><a href="#CenterDetermination.adjustment_3points-2551"><span class="linenos">2551</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>
</span></pre></div>


            <div class="docstring"><p>Manual/interactive refinement of the diffraction pattern center
after initial detection via 3 points.</p>

<h2 id="user-controls-during-point-selection">User Controls (during point selection)</h2>

<p>This method allows the user to fine-tune the estimated
center and radius of a diffraction ring,
(which was determined manually by selecting 3 points)
by means of the following interactive keyboard controls:</p>

<ul>
<li>Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</li>
<li><strong>'+'</strong> : Increase the radius</li>
<li><strong>'-'</strong> : Decrease the radius</li>
<li><strong>'b'</strong> : Increase step size (×5)</li>
<li><strong>'l'</strong> : Decrease step size (/5, with minimum step size 0.5)</li>
<li><strong>'d'</strong>: Done — finalize the center and radius</li>
<li>Closing the figure: Cancels refinement and returns the original input 
center and radius</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fig</strong> (matplotlib.figure.Figure):
The figure window used for interactive refinement.</li>
<li><strong>circle</strong> (matplotlib.patches.Circle):
The circle object initially defined from 3 selected points.</li>
<li><strong>center</strong> (tuple):
The initial (x, y) center coordinates estimated from the selected 
points.</li>
<li><strong>plot_results</strong> (bool, optional, default=False):
If True, the results of the adjustment are visualized.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xy[0]</strong> (float):
x-coordinate of the adjusted center of the diffraction pattern.</li>
<li><strong>xy[1]</strong> (float):
y-coordinate of the adjusted center of the diffraction pattern.</li>
<li><strong>r</strong> (float):
Adjusted radius of the diffraction ring.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>Interactive adjustments are visualized in real time.</li>
<li>Intensity sum at the current center/radius is printed if print_sums
is True.</li>
<li>Arrow key defaults in Matplotlib (e.g., navigation) are temporarily 
disabled to allow movement control.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.calculate_circle" class="classattr">
                                        <input id="CenterDetermination.calculate_circle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_circle</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">plot_results</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.calculate_circle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.calculate_circle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.calculate_circle-2554"><a href="#CenterDetermination.calculate_circle-2554"><span class="linenos">2554</span></a>    <span class="k">def</span> <span class="nf">calculate_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span>
</span><span id="CenterDetermination.calculate_circle-2555"><a href="#CenterDetermination.calculate_circle-2555"><span class="linenos">2555</span></a>            <span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">]:</span>
</span><span id="CenterDetermination.calculate_circle-2556"><a href="#CenterDetermination.calculate_circle-2556"><span class="linenos">2556</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.calculate_circle-2557"><a href="#CenterDetermination.calculate_circle-2557"><span class="linenos">2557</span></a><span class="sd">        Calculate the center and radius of a circle defined by 3 manually </span>
</span><span id="CenterDetermination.calculate_circle-2558"><a href="#CenterDetermination.calculate_circle-2558"><span class="linenos">2558</span></a><span class="sd">        selected points.</span>
</span><span id="CenterDetermination.calculate_circle-2559"><a href="#CenterDetermination.calculate_circle-2559"><span class="linenos">2559</span></a>
</span><span id="CenterDetermination.calculate_circle-2560"><a href="#CenterDetermination.calculate_circle-2560"><span class="linenos">2560</span></a><span class="sd">        Given three user-defined points (typically on a diffraction ring), this </span>
</span><span id="CenterDetermination.calculate_circle-2561"><a href="#CenterDetermination.calculate_circle-2561"><span class="linenos">2561</span></a><span class="sd">        method computes the center and radius of the circle that passes through </span>
</span><span id="CenterDetermination.calculate_circle-2562"><a href="#CenterDetermination.calculate_circle-2562"><span class="linenos">2562</span></a><span class="sd">        them. Optionally, it visualizes the result including the circle, center, </span>
</span><span id="CenterDetermination.calculate_circle-2563"><a href="#CenterDetermination.calculate_circle-2563"><span class="linenos">2563</span></a><span class="sd">        and selected points overlaid on the image.</span>
</span><span id="CenterDetermination.calculate_circle-2564"><a href="#CenterDetermination.calculate_circle-2564"><span class="linenos">2564</span></a>
</span><span id="CenterDetermination.calculate_circle-2565"><a href="#CenterDetermination.calculate_circle-2565"><span class="linenos">2565</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.calculate_circle-2566"><a href="#CenterDetermination.calculate_circle-2566"><span class="linenos">2566</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.calculate_circle-2567"><a href="#CenterDetermination.calculate_circle-2567"><span class="linenos">2567</span></a><span class="sd">        plot_results : int (binary: 0 or 1)</span>
</span><span id="CenterDetermination.calculate_circle-2568"><a href="#CenterDetermination.calculate_circle-2568"><span class="linenos">2568</span></a><span class="sd">            If 1, displays the image with the fitted circle and center.</span>
</span><span id="CenterDetermination.calculate_circle-2569"><a href="#CenterDetermination.calculate_circle-2569"><span class="linenos">2569</span></a><span class="sd">            If 0, skips visualization.</span>
</span><span id="CenterDetermination.calculate_circle-2570"><a href="#CenterDetermination.calculate_circle-2570"><span class="linenos">2570</span></a>
</span><span id="CenterDetermination.calculate_circle-2571"><a href="#CenterDetermination.calculate_circle-2571"><span class="linenos">2571</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.calculate_circle-2572"><a href="#CenterDetermination.calculate_circle-2572"><span class="linenos">2572</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.calculate_circle-2573"><a href="#CenterDetermination.calculate_circle-2573"><span class="linenos">2573</span></a><span class="sd">        self.x : float</span>
</span><span id="CenterDetermination.calculate_circle-2574"><a href="#CenterDetermination.calculate_circle-2574"><span class="linenos">2574</span></a><span class="sd">            x-coordinate of the detected circle center.</span>
</span><span id="CenterDetermination.calculate_circle-2575"><a href="#CenterDetermination.calculate_circle-2575"><span class="linenos">2575</span></a>
</span><span id="CenterDetermination.calculate_circle-2576"><a href="#CenterDetermination.calculate_circle-2576"><span class="linenos">2576</span></a><span class="sd">        self.y : float</span>
</span><span id="CenterDetermination.calculate_circle-2577"><a href="#CenterDetermination.calculate_circle-2577"><span class="linenos">2577</span></a><span class="sd">            y-coordinate of the detected circle center.</span>
</span><span id="CenterDetermination.calculate_circle-2578"><a href="#CenterDetermination.calculate_circle-2578"><span class="linenos">2578</span></a>
</span><span id="CenterDetermination.calculate_circle-2579"><a href="#CenterDetermination.calculate_circle-2579"><span class="linenos">2579</span></a><span class="sd">        self.r : float</span>
</span><span id="CenterDetermination.calculate_circle-2580"><a href="#CenterDetermination.calculate_circle-2580"><span class="linenos">2580</span></a><span class="sd">            Radius of the detected circle.</span>
</span><span id="CenterDetermination.calculate_circle-2581"><a href="#CenterDetermination.calculate_circle-2581"><span class="linenos">2581</span></a>
</span><span id="CenterDetermination.calculate_circle-2582"><a href="#CenterDetermination.calculate_circle-2582"><span class="linenos">2582</span></a><span class="sd">        self.center : tuple[float, float]</span>
</span><span id="CenterDetermination.calculate_circle-2583"><a href="#CenterDetermination.calculate_circle-2583"><span class="linenos">2583</span></a><span class="sd">            The (x, y) coordinates of the circle center.</span>
</span><span id="CenterDetermination.calculate_circle-2584"><a href="#CenterDetermination.calculate_circle-2584"><span class="linenos">2584</span></a>
</span><span id="CenterDetermination.calculate_circle-2585"><a href="#CenterDetermination.calculate_circle-2585"><span class="linenos">2585</span></a><span class="sd">        self.circle : matplotlib.patches.Circle</span>
</span><span id="CenterDetermination.calculate_circle-2586"><a href="#CenterDetermination.calculate_circle-2586"><span class="linenos">2586</span></a><span class="sd">            A matplotlib Circle object that can be reused for future plotting.</span>
</span><span id="CenterDetermination.calculate_circle-2587"><a href="#CenterDetermination.calculate_circle-2587"><span class="linenos">2587</span></a>
</span><span id="CenterDetermination.calculate_circle-2588"><a href="#CenterDetermination.calculate_circle-2588"><span class="linenos">2588</span></a><span class="sd">        Notes</span>
</span><span id="CenterDetermination.calculate_circle-2589"><a href="#CenterDetermination.calculate_circle-2589"><span class="linenos">2589</span></a><span class="sd">        -----</span>
</span><span id="CenterDetermination.calculate_circle-2590"><a href="#CenterDetermination.calculate_circle-2590"><span class="linenos">2590</span></a><span class="sd">        - The method uses a geometric approach to calculate the circumcenter</span>
</span><span id="CenterDetermination.calculate_circle-2591"><a href="#CenterDetermination.calculate_circle-2591"><span class="linenos">2591</span></a><span class="sd">          and circumradius.</span>
</span><span id="CenterDetermination.calculate_circle-2592"><a href="#CenterDetermination.calculate_circle-2592"><span class="linenos">2592</span></a><span class="sd">        - For best visual results, ensure the selected points are well spaced </span>
</span><span id="CenterDetermination.calculate_circle-2593"><a href="#CenterDetermination.calculate_circle-2593"><span class="linenos">2593</span></a><span class="sd">          and belong to the same circular ring.</span>
</span><span id="CenterDetermination.calculate_circle-2594"><a href="#CenterDetermination.calculate_circle-2594"><span class="linenos">2594</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.calculate_circle-2595"><a href="#CenterDetermination.calculate_circle-2595"><span class="linenos">2595</span></a>        <span class="c1"># Extract the coordinates of the points        </span>
</span><span id="CenterDetermination.calculate_circle-2596"><a href="#CenterDetermination.calculate_circle-2596"><span class="linenos">2596</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination.calculate_circle-2597"><a href="#CenterDetermination.calculate_circle-2597"><span class="linenos">2597</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination.calculate_circle-2598"><a href="#CenterDetermination.calculate_circle-2598"><span class="linenos">2598</span></a>        
</span><span id="CenterDetermination.calculate_circle-2599"><a href="#CenterDetermination.calculate_circle-2599"><span class="linenos">2599</span></a>        <span class="c1"># Compute the radius and center coordinates of the circle</span>
</span><span id="CenterDetermination.calculate_circle-2600"><a href="#CenterDetermination.calculate_circle-2600"><span class="linenos">2600</span></a>            <span class="c1"># a: the squared length of the side between the second </span>
</span><span id="CenterDetermination.calculate_circle-2601"><a href="#CenterDetermination.calculate_circle-2601"><span class="linenos">2601</span></a>            <span class="c1">#    and third points (x[1], y[1]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination.calculate_circle-2602"><a href="#CenterDetermination.calculate_circle-2602"><span class="linenos">2602</span></a>            <span class="c1"># b: the squared length of the side between the first </span>
</span><span id="CenterDetermination.calculate_circle-2603"><a href="#CenterDetermination.calculate_circle-2603"><span class="linenos">2603</span></a>            <span class="c1">#    and third points (x[0], y[0]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination.calculate_circle-2604"><a href="#CenterDetermination.calculate_circle-2604"><span class="linenos">2604</span></a>            <span class="c1"># c: the squared length of the side between the first </span>
</span><span id="CenterDetermination.calculate_circle-2605"><a href="#CenterDetermination.calculate_circle-2605"><span class="linenos">2605</span></a>            <span class="c1">#    and second points (x[0], y[0]) and (x[1], y[1]).</span>
</span><span id="CenterDetermination.calculate_circle-2606"><a href="#CenterDetermination.calculate_circle-2606"><span class="linenos">2606</span></a>            <span class="c1"># s: the twice the signed area of the triangle formed by 3 points</span>
</span><span id="CenterDetermination.calculate_circle-2607"><a href="#CenterDetermination.calculate_circle-2607"><span class="linenos">2607</span></a>            
</span><span id="CenterDetermination.calculate_circle-2608"><a href="#CenterDetermination.calculate_circle-2608"><span class="linenos">2608</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination.calculate_circle-2609"><a href="#CenterDetermination.calculate_circle-2609"><span class="linenos">2609</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination.calculate_circle-2610"><a href="#CenterDetermination.calculate_circle-2610"><span class="linenos">2610</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination.calculate_circle-2611"><a href="#CenterDetermination.calculate_circle-2611"><span class="linenos">2611</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> 
</span><span id="CenterDetermination.calculate_circle-2612"><a href="#CenterDetermination.calculate_circle-2612"><span class="linenos">2612</span></a>        
</span><span id="CenterDetermination.calculate_circle-2613"><a href="#CenterDetermination.calculate_circle-2613"><span class="linenos">2613</span></a>        <span class="c1"># coordinates of the center</span>
</span><span id="CenterDetermination.calculate_circle-2614"><a href="#CenterDetermination.calculate_circle-2614"><span class="linenos">2614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span>
</span><span id="CenterDetermination.calculate_circle-2615"><a href="#CenterDetermination.calculate_circle-2615"><span class="linenos">2615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span> 
</span><span id="CenterDetermination.calculate_circle-2616"><a href="#CenterDetermination.calculate_circle-2616"><span class="linenos">2616</span></a>        
</span><span id="CenterDetermination.calculate_circle-2617"><a href="#CenterDetermination.calculate_circle-2617"><span class="linenos">2617</span></a>        <span class="c1"># radius</span>
</span><span id="CenterDetermination.calculate_circle-2618"><a href="#CenterDetermination.calculate_circle-2618"><span class="linenos">2618</span></a>        <span class="n">ar</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination.calculate_circle-2619"><a href="#CenterDetermination.calculate_circle-2619"><span class="linenos">2619</span></a>        <span class="n">br</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination.calculate_circle-2620"><a href="#CenterDetermination.calculate_circle-2620"><span class="linenos">2620</span></a>        <span class="n">cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="mf">0.5</span> 
</span><span id="CenterDetermination.calculate_circle-2621"><a href="#CenterDetermination.calculate_circle-2621"><span class="linenos">2621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">ar</span><span class="o">*</span><span class="n">br</span><span class="o">*</span><span class="n">cr</span><span class="o">/</span><span class="p">((</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">-</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">-</span><span class="n">cr</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination.calculate_circle-2622"><a href="#CenterDetermination.calculate_circle-2622"><span class="linenos">2622</span></a>        
</span><span id="CenterDetermination.calculate_circle-2623"><a href="#CenterDetermination.calculate_circle-2623"><span class="linenos">2623</span></a>        <span class="c1"># # Print results</span>
</span><span id="CenterDetermination.calculate_circle-2624"><a href="#CenterDetermination.calculate_circle-2624"><span class="linenos">2624</span></a>        <span class="c1"># if self.parent.verbose:</span>
</span><span id="CenterDetermination.calculate_circle-2625"><a href="#CenterDetermination.calculate_circle-2625"><span class="linenos">2625</span></a>        <span class="c1">#     print(&quot;CenterEstimator :: manual center detection&quot;)</span>
</span><span id="CenterDetermination.calculate_circle-2626"><a href="#CenterDetermination.calculate_circle-2626"><span class="linenos">2626</span></a>        <span class="c1">#     print(f&quot;Center coordinates: {self.x:.2f} {self.y:.2f}&quot;)</span>
</span><span id="CenterDetermination.calculate_circle-2627"><a href="#CenterDetermination.calculate_circle-2627"><span class="linenos">2627</span></a>                    
</span><span id="CenterDetermination.calculate_circle-2628"><a href="#CenterDetermination.calculate_circle-2628"><span class="linenos">2628</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.calculate_circle-2629"><a href="#CenterDetermination.calculate_circle-2629"><span class="linenos">2629</span></a>            <span class="c1"># Create and manage the figure</span>
</span><span id="CenterDetermination.calculate_circle-2630"><a href="#CenterDetermination.calculate_circle-2630"><span class="linenos">2630</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-2631"><a href="#CenterDetermination.calculate_circle-2631"><span class="linenos">2631</span></a>            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-2632"><a href="#CenterDetermination.calculate_circle-2632"><span class="linenos">2632</span></a>            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-2633"><a href="#CenterDetermination.calculate_circle-2633"><span class="linenos">2633</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.calculate_circle-2634"><a href="#CenterDetermination.calculate_circle-2634"><span class="linenos">2634</span></a>                      <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2635"><a href="#CenterDetermination.calculate_circle-2635"><span class="linenos">2635</span></a>            
</span><span id="CenterDetermination.calculate_circle-2636"><a href="#CenterDetermination.calculate_circle-2636"><span class="linenos">2636</span></a>            <span class="c1"># Plot center and points</span>
</span><span id="CenterDetermination.calculate_circle-2637"><a href="#CenterDetermination.calculate_circle-2637"><span class="linenos">2637</span></a>            <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2638"><a href="#CenterDetermination.calculate_circle-2638"><span class="linenos">2638</span></a>                     <span class="s1">&#39;rx&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2639"><a href="#CenterDetermination.calculate_circle-2639"><span class="linenos">2639</span></a>                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2640"><a href="#CenterDetermination.calculate_circle-2640"><span class="linenos">2640</span></a>                     <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2641"><a href="#CenterDetermination.calculate_circle-2641"><span class="linenos">2641</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2642"><a href="#CenterDetermination.calculate_circle-2642"><span class="linenos">2642</span></a>                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2643"><a href="#CenterDetermination.calculate_circle-2643"><span class="linenos">2643</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2644"><a href="#CenterDetermination.calculate_circle-2644"><span class="linenos">2644</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Circle points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2645"><a href="#CenterDetermination.calculate_circle-2645"><span class="linenos">2645</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Circle found using 3 manually detected points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2646"><a href="#CenterDetermination.calculate_circle-2646"><span class="linenos">2646</span></a>            
</span><span id="CenterDetermination.calculate_circle-2647"><a href="#CenterDetermination.calculate_circle-2647"><span class="linenos">2647</span></a>            <span class="c1"># Circle visualization</span>
</span><span id="CenterDetermination.calculate_circle-2648"><a href="#CenterDetermination.calculate_circle-2648"><span class="linenos">2648</span></a>            <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterDetermination.calculate_circle-2649"><a href="#CenterDetermination.calculate_circle-2649"><span class="linenos">2649</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2650"><a href="#CenterDetermination.calculate_circle-2650"><span class="linenos">2650</span></a>                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2651"><a href="#CenterDetermination.calculate_circle-2651"><span class="linenos">2651</span></a>                                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="CenterDetermination.calculate_circle-2652"><a href="#CenterDetermination.calculate_circle-2652"><span class="linenos">2652</span></a>                                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2653"><a href="#CenterDetermination.calculate_circle-2653"><span class="linenos">2653</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2654"><a href="#CenterDetermination.calculate_circle-2654"><span class="linenos">2654</span></a>            
</span><span id="CenterDetermination.calculate_circle-2655"><a href="#CenterDetermination.calculate_circle-2655"><span class="linenos">2655</span></a>            <span class="c1"># Set the aspect ratio to equal to have a circular shape</span>
</span><span id="CenterDetermination.calculate_circle-2656"><a href="#CenterDetermination.calculate_circle-2656"><span class="linenos">2656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2657"><a href="#CenterDetermination.calculate_circle-2657"><span class="linenos">2657</span></a>            
</span><span id="CenterDetermination.calculate_circle-2658"><a href="#CenterDetermination.calculate_circle-2658"><span class="linenos">2658</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2659"><a href="#CenterDetermination.calculate_circle-2659"><span class="linenos">2659</span></a>                       <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2660"><a href="#CenterDetermination.calculate_circle-2660"><span class="linenos">2660</span></a>                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> 
</span><span id="CenterDetermination.calculate_circle-2661"><a href="#CenterDetermination.calculate_circle-2661"><span class="linenos">2661</span></a>                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-2662"><a href="#CenterDetermination.calculate_circle-2662"><span class="linenos">2662</span></a>                       <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2663"><a href="#CenterDetermination.calculate_circle-2663"><span class="linenos">2663</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2664"><a href="#CenterDetermination.calculate_circle-2664"><span class="linenos">2664</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-2665"><a href="#CenterDetermination.calculate_circle-2665"><span class="linenos">2665</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2666"><a href="#CenterDetermination.calculate_circle-2666"><span class="linenos">2666</span></a>
</span><span id="CenterDetermination.calculate_circle-2667"><a href="#CenterDetermination.calculate_circle-2667"><span class="linenos">2667</span></a>        
</span><span id="CenterDetermination.calculate_circle-2668"><a href="#CenterDetermination.calculate_circle-2668"><span class="linenos">2668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2669"><a href="#CenterDetermination.calculate_circle-2669"><span class="linenos">2669</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-2670"><a href="#CenterDetermination.calculate_circle-2670"><span class="linenos">2670</span></a>        
</span><span id="CenterDetermination.calculate_circle-2671"><a href="#CenterDetermination.calculate_circle-2671"><span class="linenos">2671</span></a>
</span><span id="CenterDetermination.calculate_circle-2672"><a href="#CenterDetermination.calculate_circle-2672"><span class="linenos">2672</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the center and radius of a circle defined by 3 manually 
selected points.</p>

<p>Given three user-defined points (typically on a diffraction ring), this 
method computes the center and radius of the circle that passes through 
them. Optionally, it visualizes the result including the circle, center, 
and selected points overlaid on the image.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>plot_results : int (binary</strong> (0 or 1)):
If 1, displays the image with the fitted circle and center.
If 0, skips visualization.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>self.x</strong> (float):
x-coordinate of the detected circle center.</li>
<li><strong>self.y</strong> (float):
y-coordinate of the detected circle center.</li>
<li><strong>self.r</strong> (float):
Radius of the detected circle.</li>
<li><strong>self.center</strong> (tuple[float, float]):
The (x, y) coordinates of the circle center.</li>
<li><strong>self.circle</strong> (matplotlib.patches.Circle):
A matplotlib Circle object that can be reused for future plotting.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The method uses a geometric approach to calculate the circumcenter
and circumradius.</li>
<li>For best visual results, ensure the selected points are well spaced 
and belong to the same circular ring.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.get_radius" class="classattr">
                                        <input id="CenterDetermination.get_radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_radius</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">rtype</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">im</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">x</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">y</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">disp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.get_radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.get_radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.get_radius-2675"><a href="#CenterDetermination.get_radius-2675"><span class="linenos">2675</span></a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span>
</span><span id="CenterDetermination.get_radius-2676"><a href="#CenterDetermination.get_radius-2676"><span class="linenos">2676</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">rtype</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">disp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2677"><a href="#CenterDetermination.get_radius-2677"><span class="linenos">2677</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-2678"><a href="#CenterDetermination.get_radius-2678"><span class="linenos">2678</span></a><span class="sd">        Calculate the radius of a circle based on intensity profiles along </span>
</span><span id="CenterDetermination.get_radius-2679"><a href="#CenterDetermination.get_radius-2679"><span class="linenos">2679</span></a><span class="sd">        horizontal and vertical axes.</span>
</span><span id="CenterDetermination.get_radius-2680"><a href="#CenterDetermination.get_radius-2680"><span class="linenos">2680</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.get_radius-2681"><a href="#CenterDetermination.get_radius-2681"><span class="linenos">2681</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.get_radius-2682"><a href="#CenterDetermination.get_radius-2682"><span class="linenos">2682</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.get_radius-2683"><a href="#CenterDetermination.get_radius-2683"><span class="linenos">2683</span></a><span class="sd">        rtype : integer</span>
</span><span id="CenterDetermination.get_radius-2684"><a href="#CenterDetermination.get_radius-2684"><span class="linenos">2684</span></a><span class="sd">            Method for radius calculation. Default is 0.</span>
</span><span id="CenterDetermination.get_radius-2685"><a href="#CenterDetermination.get_radius-2685"><span class="linenos">2685</span></a><span class="sd">            - rtype=0 : peaks matching method</span>
</span><span id="CenterDetermination.get_radius-2686"><a href="#CenterDetermination.get_radius-2686"><span class="linenos">2686</span></a><span class="sd">            - rtype=1 : radial distribution method</span>
</span><span id="CenterDetermination.get_radius-2687"><a href="#CenterDetermination.get_radius-2687"><span class="linenos">2687</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.get_radius-2688"><a href="#CenterDetermination.get_radius-2688"><span class="linenos">2688</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="CenterDetermination.get_radius-2689"><a href="#CenterDetermination.get_radius-2689"><span class="linenos">2689</span></a><span class="sd">            The 2D image array containing the circle. </span>
</span><span id="CenterDetermination.get_radius-2690"><a href="#CenterDetermination.get_radius-2690"><span class="linenos">2690</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.get_radius-2691"><a href="#CenterDetermination.get_radius-2691"><span class="linenos">2691</span></a><span class="sd">        x : float</span>
</span><span id="CenterDetermination.get_radius-2692"><a href="#CenterDetermination.get_radius-2692"><span class="linenos">2692</span></a><span class="sd">            The x-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination.get_radius-2693"><a href="#CenterDetermination.get_radius-2693"><span class="linenos">2693</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.get_radius-2694"><a href="#CenterDetermination.get_radius-2694"><span class="linenos">2694</span></a><span class="sd">        y : float</span>
</span><span id="CenterDetermination.get_radius-2695"><a href="#CenterDetermination.get_radius-2695"><span class="linenos">2695</span></a><span class="sd">            The y-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination.get_radius-2696"><a href="#CenterDetermination.get_radius-2696"><span class="linenos">2696</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.get_radius-2697"><a href="#CenterDetermination.get_radius-2697"><span class="linenos">2697</span></a><span class="sd">        disp : bool, optional</span>
</span><span id="CenterDetermination.get_radius-2698"><a href="#CenterDetermination.get_radius-2698"><span class="linenos">2698</span></a><span class="sd">            If True, visualizes the detected intensity profiles and peaks </span>
</span><span id="CenterDetermination.get_radius-2699"><a href="#CenterDetermination.get_radius-2699"><span class="linenos">2699</span></a><span class="sd">            (default is False).</span>
</span><span id="CenterDetermination.get_radius-2700"><a href="#CenterDetermination.get_radius-2700"><span class="linenos">2700</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.get_radius-2701"><a href="#CenterDetermination.get_radius-2701"><span class="linenos">2701</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.get_radius-2702"><a href="#CenterDetermination.get_radius-2702"><span class="linenos">2702</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.get_radius-2703"><a href="#CenterDetermination.get_radius-2703"><span class="linenos">2703</span></a><span class="sd">        float</span>
</span><span id="CenterDetermination.get_radius-2704"><a href="#CenterDetermination.get_radius-2704"><span class="linenos">2704</span></a><span class="sd">            The estimated radius of the circle. Defaults to 100 if no valid </span>
</span><span id="CenterDetermination.get_radius-2705"><a href="#CenterDetermination.get_radius-2705"><span class="linenos">2705</span></a><span class="sd">            radius is detected.</span>
</span><span id="CenterDetermination.get_radius-2706"><a href="#CenterDetermination.get_radius-2706"><span class="linenos">2706</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-2707"><a href="#CenterDetermination.get_radius-2707"><span class="linenos">2707</span></a>        <span class="c1"># Helper function -----------------------------------------------------</span>
</span><span id="CenterDetermination.get_radius-2708"><a href="#CenterDetermination.get_radius-2708"><span class="linenos">2708</span></a>        <span class="k">def</span> <span class="nf">match_peaks</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span><span id="CenterDetermination.get_radius-2709"><a href="#CenterDetermination.get_radius-2709"><span class="linenos">2709</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-2710"><a href="#CenterDetermination.get_radius-2710"><span class="linenos">2710</span></a><span class="sd">            Find the most similar values across the left and right halves of </span>
</span><span id="CenterDetermination.get_radius-2711"><a href="#CenterDetermination.get_radius-2711"><span class="linenos">2711</span></a><span class="sd">            an array, excluding the global maximum.</span>
</span><span id="CenterDetermination.get_radius-2712"><a href="#CenterDetermination.get_radius-2712"><span class="linenos">2712</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.get_radius-2713"><a href="#CenterDetermination.get_radius-2713"><span class="linenos">2713</span></a><span class="sd">            This function is typically used for analyzing symmetric patterns </span>
</span><span id="CenterDetermination.get_radius-2714"><a href="#CenterDetermination.get_radius-2714"><span class="linenos">2714</span></a><span class="sd">            such as diffraction profiles or intensity histograms. It identifies </span>
</span><span id="CenterDetermination.get_radius-2715"><a href="#CenterDetermination.get_radius-2715"><span class="linenos">2715</span></a><span class="sd">            the most similar pair of peaks on either side of the central maximum, </span>
</span><span id="CenterDetermination.get_radius-2716"><a href="#CenterDetermination.get_radius-2716"><span class="linenos">2716</span></a><span class="sd">            which is excluded from the comparison.</span>
</span><span id="CenterDetermination.get_radius-2717"><a href="#CenterDetermination.get_radius-2717"><span class="linenos">2717</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.get_radius-2718"><a href="#CenterDetermination.get_radius-2718"><span class="linenos">2718</span></a><span class="sd">            Special case:</span>
</span><span id="CenterDetermination.get_radius-2719"><a href="#CenterDetermination.get_radius-2719"><span class="linenos">2719</span></a><span class="sd">            - If the array contains exactly two elements, it assumes they form </span>
</span><span id="CenterDetermination.get_radius-2720"><a href="#CenterDetermination.get_radius-2720"><span class="linenos">2720</span></a><span class="sd">              the best pair and returns their indices directly.</span>
</span><span id="CenterDetermination.get_radius-2721"><a href="#CenterDetermination.get_radius-2721"><span class="linenos">2721</span></a><span class="sd">            - If one half is empty after removing the central peak,</span>
</span><span id="CenterDetermination.get_radius-2722"><a href="#CenterDetermination.get_radius-2722"><span class="linenos">2722</span></a><span class="sd">              it returns (None, None).</span>
</span><span id="CenterDetermination.get_radius-2723"><a href="#CenterDetermination.get_radius-2723"><span class="linenos">2723</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.get_radius-2724"><a href="#CenterDetermination.get_radius-2724"><span class="linenos">2724</span></a><span class="sd">            Parameters</span>
</span><span id="CenterDetermination.get_radius-2725"><a href="#CenterDetermination.get_radius-2725"><span class="linenos">2725</span></a><span class="sd">            ----------</span>
</span><span id="CenterDetermination.get_radius-2726"><a href="#CenterDetermination.get_radius-2726"><span class="linenos">2726</span></a><span class="sd">            arr : np.ndarray or list of float</span>
</span><span id="CenterDetermination.get_radius-2727"><a href="#CenterDetermination.get_radius-2727"><span class="linenos">2727</span></a><span class="sd">                1D array of values (intensity profile) where symmetric peak</span>
</span><span id="CenterDetermination.get_radius-2728"><a href="#CenterDetermination.get_radius-2728"><span class="linenos">2728</span></a><span class="sd">                positions are to be matched.</span>
</span><span id="CenterDetermination.get_radius-2729"><a href="#CenterDetermination.get_radius-2729"><span class="linenos">2729</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.get_radius-2730"><a href="#CenterDetermination.get_radius-2730"><span class="linenos">2730</span></a><span class="sd">            Returns</span>
</span><span id="CenterDetermination.get_radius-2731"><a href="#CenterDetermination.get_radius-2731"><span class="linenos">2731</span></a><span class="sd">            -------</span>
</span><span id="CenterDetermination.get_radius-2732"><a href="#CenterDetermination.get_radius-2732"><span class="linenos">2732</span></a><span class="sd">            best_pair : tuple[int or None, int or None]</span>
</span><span id="CenterDetermination.get_radius-2733"><a href="#CenterDetermination.get_radius-2733"><span class="linenos">2733</span></a><span class="sd">                Indices of the two most similar values, one from each half of </span>
</span><span id="CenterDetermination.get_radius-2734"><a href="#CenterDetermination.get_radius-2734"><span class="linenos">2734</span></a><span class="sd">                the array. Returns (None, None) if no valid pair is found.</span>
</span><span id="CenterDetermination.get_radius-2735"><a href="#CenterDetermination.get_radius-2735"><span class="linenos">2735</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.get_radius-2736"><a href="#CenterDetermination.get_radius-2736"><span class="linenos">2736</span></a><span class="sd">            Notes</span>
</span><span id="CenterDetermination.get_radius-2737"><a href="#CenterDetermination.get_radius-2737"><span class="linenos">2737</span></a><span class="sd">            -----</span>
</span><span id="CenterDetermination.get_radius-2738"><a href="#CenterDetermination.get_radius-2738"><span class="linenos">2738</span></a><span class="sd">            - The function assumes the most prominent peak (maximum value) lies </span>
</span><span id="CenterDetermination.get_radius-2739"><a href="#CenterDetermination.get_radius-2739"><span class="linenos">2739</span></a><span class="sd">              at or near the center and represents the central feature.</span>
</span><span id="CenterDetermination.get_radius-2740"><a href="#CenterDetermination.get_radius-2740"><span class="linenos">2740</span></a><span class="sd">            - The left and right halves are compared pairwise, and the closest </span>
</span><span id="CenterDetermination.get_radius-2741"><a href="#CenterDetermination.get_radius-2741"><span class="linenos">2741</span></a><span class="sd">              match in absolute value difference is returned.</span>
</span><span id="CenterDetermination.get_radius-2742"><a href="#CenterDetermination.get_radius-2742"><span class="linenos">2742</span></a><span class="sd">            - This is useful for refining radial symmetry or finding symmetric </span>
</span><span id="CenterDetermination.get_radius-2743"><a href="#CenterDetermination.get_radius-2743"><span class="linenos">2743</span></a><span class="sd">              ring peaks.</span>
</span><span id="CenterDetermination.get_radius-2744"><a href="#CenterDetermination.get_radius-2744"><span class="linenos">2744</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-2745"><a href="#CenterDetermination.get_radius-2745"><span class="linenos">2745</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not enough values to compare</span>
</span><span id="CenterDetermination.get_radius-2746"><a href="#CenterDetermination.get_radius-2746"><span class="linenos">2746</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2747"><a href="#CenterDetermination.get_radius-2747"><span class="linenos">2747</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough values to find similar pairs.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2748"><a href="#CenterDetermination.get_radius-2748"><span class="linenos">2748</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2749"><a href="#CenterDetermination.get_radius-2749"><span class="linenos">2749</span></a>    
</span><span id="CenterDetermination.get_radius-2750"><a href="#CenterDetermination.get_radius-2750"><span class="linenos">2750</span></a>            <span class="c1"># Special case: if there are exactly 2 peaks, return them</span>
</span><span id="CenterDetermination.get_radius-2751"><a href="#CenterDetermination.get_radius-2751"><span class="linenos">2751</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2752"><a href="#CenterDetermination.get_radius-2752"><span class="linenos">2752</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2753"><a href="#CenterDetermination.get_radius-2753"><span class="linenos">2753</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exactly two peaks detected. Returning them as the best pair.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2754"><a href="#CenterDetermination.get_radius-2754"><span class="linenos">2754</span></a>                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span id="CenterDetermination.get_radius-2755"><a href="#CenterDetermination.get_radius-2755"><span class="linenos">2755</span></a>    
</span><span id="CenterDetermination.get_radius-2756"><a href="#CenterDetermination.get_radius-2756"><span class="linenos">2756</span></a>            <span class="c1"># Find the index of the highest value</span>
</span><span id="CenterDetermination.get_radius-2757"><a href="#CenterDetermination.get_radius-2757"><span class="linenos">2757</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2758"><a href="#CenterDetermination.get_radius-2758"><span class="linenos">2758</span></a>    
</span><span id="CenterDetermination.get_radius-2759"><a href="#CenterDetermination.get_radius-2759"><span class="linenos">2759</span></a>            <span class="c1"># Split into left and right halves, excluding the highest value</span>
</span><span id="CenterDetermination.get_radius-2760"><a href="#CenterDetermination.get_radius-2760"><span class="linenos">2760</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-2761"><a href="#CenterDetermination.get_radius-2761"><span class="linenos">2761</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="CenterDetermination.get_radius-2762"><a href="#CenterDetermination.get_radius-2762"><span class="linenos">2762</span></a>            <span class="n">left_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2763"><a href="#CenterDetermination.get_radius-2763"><span class="linenos">2763</span></a>            <span class="n">right_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
</span><span id="CenterDetermination.get_radius-2764"><a href="#CenterDetermination.get_radius-2764"><span class="linenos">2764</span></a>    
</span><span id="CenterDetermination.get_radius-2765"><a href="#CenterDetermination.get_radius-2765"><span class="linenos">2765</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check for empty halves</span>
</span><span id="CenterDetermination.get_radius-2766"><a href="#CenterDetermination.get_radius-2766"><span class="linenos">2766</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2767"><a href="#CenterDetermination.get_radius-2767"><span class="linenos">2767</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One of the halves is empty.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2768"><a href="#CenterDetermination.get_radius-2768"><span class="linenos">2768</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2769"><a href="#CenterDetermination.get_radius-2769"><span class="linenos">2769</span></a>    
</span><span id="CenterDetermination.get_radius-2770"><a href="#CenterDetermination.get_radius-2770"><span class="linenos">2770</span></a>            <span class="c1"># Initialize variables for tracking the smallest difference</span>
</span><span id="CenterDetermination.get_radius-2771"><a href="#CenterDetermination.get_radius-2771"><span class="linenos">2771</span></a>            <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="CenterDetermination.get_radius-2772"><a href="#CenterDetermination.get_radius-2772"><span class="linenos">2772</span></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2773"><a href="#CenterDetermination.get_radius-2773"><span class="linenos">2773</span></a>    
</span><span id="CenterDetermination.get_radius-2774"><a href="#CenterDetermination.get_radius-2774"><span class="linenos">2774</span></a>            <span class="c1"># Compare each value in the left with every value in the right</span>
</span><span id="CenterDetermination.get_radius-2775"><a href="#CenterDetermination.get_radius-2775"><span class="linenos">2775</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
</span><span id="CenterDetermination.get_radius-2776"><a href="#CenterDetermination.get_radius-2776"><span class="linenos">2776</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
</span><span id="CenterDetermination.get_radius-2777"><a href="#CenterDetermination.get_radius-2777"><span class="linenos">2777</span></a>                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l_val</span> <span class="o">-</span> <span class="n">r_val</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2778"><a href="#CenterDetermination.get_radius-2778"><span class="linenos">2778</span></a>                    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">smallest_diff</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2779"><a href="#CenterDetermination.get_radius-2779"><span class="linenos">2779</span></a>                        <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">diff</span>
</span><span id="CenterDetermination.get_radius-2780"><a href="#CenterDetermination.get_radius-2780"><span class="linenos">2780</span></a>                        <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_indices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="CenterDetermination.get_radius-2781"><a href="#CenterDetermination.get_radius-2781"><span class="linenos">2781</span></a>    
</span><span id="CenterDetermination.get_radius-2782"><a href="#CenterDetermination.get_radius-2782"><span class="linenos">2782</span></a>            <span class="k">return</span> <span class="n">best_pair</span>
</span><span id="CenterDetermination.get_radius-2783"><a href="#CenterDetermination.get_radius-2783"><span class="linenos">2783</span></a>        
</span><span id="CenterDetermination.get_radius-2784"><a href="#CenterDetermination.get_radius-2784"><span class="linenos">2784</span></a>        <span class="c1"># Peak matching method ------------------------------------------------</span>
</span><span id="CenterDetermination.get_radius-2785"><a href="#CenterDetermination.get_radius-2785"><span class="linenos">2785</span></a>        <span class="k">if</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2786"><a href="#CenterDetermination.get_radius-2786"><span class="linenos">2786</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2787"><a href="#CenterDetermination.get_radius-2787"><span class="linenos">2787</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2788"><a href="#CenterDetermination.get_radius-2788"><span class="linenos">2788</span></a>        
</span><span id="CenterDetermination.get_radius-2789"><a href="#CenterDetermination.get_radius-2789"><span class="linenos">2789</span></a>            <span class="n">x_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="CenterDetermination.get_radius-2790"><a href="#CenterDetermination.get_radius-2790"><span class="linenos">2790</span></a>            <span class="n">y_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</span><span id="CenterDetermination.get_radius-2791"><a href="#CenterDetermination.get_radius-2791"><span class="linenos">2791</span></a>        
</span><span id="CenterDetermination.get_radius-2792"><a href="#CenterDetermination.get_radius-2792"><span class="linenos">2792</span></a>            <span class="c1"># Define threshold for peak detection</span>
</span><span id="CenterDetermination.get_radius-2793"><a href="#CenterDetermination.get_radius-2793"><span class="linenos">2793</span></a>            <span class="n">x_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2794"><a href="#CenterDetermination.get_radius-2794"><span class="linenos">2794</span></a>            <span class="n">y_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_line</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2795"><a href="#CenterDetermination.get_radius-2795"><span class="linenos">2795</span></a>        
</span><span id="CenterDetermination.get_radius-2796"><a href="#CenterDetermination.get_radius-2796"><span class="linenos">2796</span></a>            <span class="c1"># Find peaks with dynamic height thresholds</span>
</span><span id="CenterDetermination.get_radius-2797"><a href="#CenterDetermination.get_radius-2797"><span class="linenos">2797</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2798"><a href="#CenterDetermination.get_radius-2798"><span class="linenos">2798</span></a>                                        <span class="n">height</span><span class="o">=</span><span class="n">x_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2799"><a href="#CenterDetermination.get_radius-2799"><span class="linenos">2799</span></a>                                        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2800"><a href="#CenterDetermination.get_radius-2800"><span class="linenos">2800</span></a>                                        <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2801"><a href="#CenterDetermination.get_radius-2801"><span class="linenos">2801</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span> <span class="o">=</span> <span class="n">x_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-2802"><a href="#CenterDetermination.get_radius-2802"><span class="linenos">2802</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2803"><a href="#CenterDetermination.get_radius-2803"><span class="linenos">2803</span></a>                                        <span class="n">height</span><span class="o">=</span><span class="n">y_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2804"><a href="#CenterDetermination.get_radius-2804"><span class="linenos">2804</span></a>                                        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2805"><a href="#CenterDetermination.get_radius-2805"><span class="linenos">2805</span></a>                                        <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2806"><a href="#CenterDetermination.get_radius-2806"><span class="linenos">2806</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="n">y_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-2807"><a href="#CenterDetermination.get_radius-2807"><span class="linenos">2807</span></a>        
</span><span id="CenterDetermination.get_radius-2808"><a href="#CenterDetermination.get_radius-2808"><span class="linenos">2808</span></a>            <span class="c1"># Define half the length of the image</span>
</span><span id="CenterDetermination.get_radius-2809"><a href="#CenterDetermination.get_radius-2809"><span class="linenos">2809</span></a>            <span class="n">half_length_x</span> <span class="o">=</span> <span class="n">x_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-2810"><a href="#CenterDetermination.get_radius-2810"><span class="linenos">2810</span></a>            <span class="n">half_length_y</span> <span class="o">=</span> <span class="n">y_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-2811"><a href="#CenterDetermination.get_radius-2811"><span class="linenos">2811</span></a>        
</span><span id="CenterDetermination.get_radius-2812"><a href="#CenterDetermination.get_radius-2812"><span class="linenos">2812</span></a>            <span class="c1"># Check the additional condition for xpeaks</span>
</span><span id="CenterDetermination.get_radius-2813"><a href="#CenterDetermination.get_radius-2813"><span class="linenos">2813</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination.get_radius-2814"><a href="#CenterDetermination.get_radius-2814"><span class="linenos">2814</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination.get_radius-2815"><a href="#CenterDetermination.get_radius-2815"><span class="linenos">2815</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span><span class="p">)):</span>
</span><span id="CenterDetermination.get_radius-2816"><a href="#CenterDetermination.get_radius-2816"><span class="linenos">2816</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2817"><a href="#CenterDetermination.get_radius-2817"><span class="linenos">2817</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xpeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2818"><a href="#CenterDetermination.get_radius-2818"><span class="linenos">2818</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2819"><a href="#CenterDetermination.get_radius-2819"><span class="linenos">2819</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2820"><a href="#CenterDetermination.get_radius-2820"><span class="linenos">2820</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2821"><a href="#CenterDetermination.get_radius-2821"><span class="linenos">2821</span></a>        
</span><span id="CenterDetermination.get_radius-2822"><a href="#CenterDetermination.get_radius-2822"><span class="linenos">2822</span></a>            <span class="c1"># Check the additional condition for ypeaks</span>
</span><span id="CenterDetermination.get_radius-2823"><a href="#CenterDetermination.get_radius-2823"><span class="linenos">2823</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination.get_radius-2824"><a href="#CenterDetermination.get_radius-2824"><span class="linenos">2824</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination.get_radius-2825"><a href="#CenterDetermination.get_radius-2825"><span class="linenos">2825</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span><span class="p">)):</span>
</span><span id="CenterDetermination.get_radius-2826"><a href="#CenterDetermination.get_radius-2826"><span class="linenos">2826</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2827"><a href="#CenterDetermination.get_radius-2827"><span class="linenos">2827</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ypeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2828"><a href="#CenterDetermination.get_radius-2828"><span class="linenos">2828</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2829"><a href="#CenterDetermination.get_radius-2829"><span class="linenos">2829</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2830"><a href="#CenterDetermination.get_radius-2830"><span class="linenos">2830</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2831"><a href="#CenterDetermination.get_radius-2831"><span class="linenos">2831</span></a>        
</span><span id="CenterDetermination.get_radius-2832"><a href="#CenterDetermination.get_radius-2832"><span class="linenos">2832</span></a>            <span class="c1"># Determine radius based on available pairs</span>
</span><span id="CenterDetermination.get_radius-2833"><a href="#CenterDetermination.get_radius-2833"><span class="linenos">2833</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2834"><a href="#CenterDetermination.get_radius-2834"><span class="linenos">2834</span></a>                <span class="n">rx_x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2835"><a href="#CenterDetermination.get_radius-2835"><span class="linenos">2835</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2836"><a href="#CenterDetermination.get_radius-2836"><span class="linenos">2836</span></a>                <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-2837"><a href="#CenterDetermination.get_radius-2837"><span class="linenos">2837</span></a>                <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-2838"><a href="#CenterDetermination.get_radius-2838"><span class="linenos">2838</span></a>                <span class="n">rx_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-2839"><a href="#CenterDetermination.get_radius-2839"><span class="linenos">2839</span></a>        
</span><span id="CenterDetermination.get_radius-2840"><a href="#CenterDetermination.get_radius-2840"><span class="linenos">2840</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2841"><a href="#CenterDetermination.get_radius-2841"><span class="linenos">2841</span></a>                <span class="n">rx_y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-2842"><a href="#CenterDetermination.get_radius-2842"><span class="linenos">2842</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2843"><a href="#CenterDetermination.get_radius-2843"><span class="linenos">2843</span></a>                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-2844"><a href="#CenterDetermination.get_radius-2844"><span class="linenos">2844</span></a>                <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-2845"><a href="#CenterDetermination.get_radius-2845"><span class="linenos">2845</span></a>                <span class="n">rx_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-2846"><a href="#CenterDetermination.get_radius-2846"><span class="linenos">2846</span></a>        
</span><span id="CenterDetermination.get_radius-2847"><a href="#CenterDetermination.get_radius-2847"><span class="linenos">2847</span></a>            <span class="k">if</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2848"><a href="#CenterDetermination.get_radius-2848"><span class="linenos">2848</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">rx_x</span><span class="p">,</span> <span class="n">rx_y</span><span class="p">])</span>
</span><span id="CenterDetermination.get_radius-2849"><a href="#CenterDetermination.get_radius-2849"><span class="linenos">2849</span></a>            <span class="k">elif</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2850"><a href="#CenterDetermination.get_radius-2850"><span class="linenos">2850</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_x</span>
</span><span id="CenterDetermination.get_radius-2851"><a href="#CenterDetermination.get_radius-2851"><span class="linenos">2851</span></a>            <span class="k">elif</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2852"><a href="#CenterDetermination.get_radius-2852"><span class="linenos">2852</span></a>                <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_y</span>
</span><span id="CenterDetermination.get_radius-2853"><a href="#CenterDetermination.get_radius-2853"><span class="linenos">2853</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2854"><a href="#CenterDetermination.get_radius-2854"><span class="linenos">2854</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2855"><a href="#CenterDetermination.get_radius-2855"><span class="linenos">2855</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pairs detected for radius calculation.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2856"><a href="#CenterDetermination.get_radius-2856"><span class="linenos">2856</span></a>                <span class="k">return</span> <span class="mi">100</span>  <span class="c1"># Default radius or error handling</span>
</span><span id="CenterDetermination.get_radius-2857"><a href="#CenterDetermination.get_radius-2857"><span class="linenos">2857</span></a>        
</span><span id="CenterDetermination.get_radius-2858"><a href="#CenterDetermination.get_radius-2858"><span class="linenos">2858</span></a>            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2859"><a href="#CenterDetermination.get_radius-2859"><span class="linenos">2859</span></a>                <span class="c1"># Plot xline with peaks</span>
</span><span id="CenterDetermination.get_radius-2860"><a href="#CenterDetermination.get_radius-2860"><span class="linenos">2860</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="CenterDetermination.get_radius-2861"><a href="#CenterDetermination.get_radius-2861"><span class="linenos">2861</span></a>        
</span><span id="CenterDetermination.get_radius-2862"><a href="#CenterDetermination.get_radius-2862"><span class="linenos">2862</span></a>                <span class="c1"># Plot for xline</span>
</span><span id="CenterDetermination.get_radius-2863"><a href="#CenterDetermination.get_radius-2863"><span class="linenos">2863</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2864"><a href="#CenterDetermination.get_radius-2864"><span class="linenos">2864</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2865"><a href="#CenterDetermination.get_radius-2865"><span class="linenos">2865</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2866"><a href="#CenterDetermination.get_radius-2866"><span class="linenos">2866</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2867"><a href="#CenterDetermination.get_radius-2867"><span class="linenos">2867</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2868"><a href="#CenterDetermination.get_radius-2868"><span class="linenos">2868</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2869"><a href="#CenterDetermination.get_radius-2869"><span class="linenos">2869</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-2870"><a href="#CenterDetermination.get_radius-2870"><span class="linenos">2870</span></a>        
</span><span id="CenterDetermination.get_radius-2871"><a href="#CenterDetermination.get_radius-2871"><span class="linenos">2871</span></a>                <span class="c1"># Plot for yline</span>
</span><span id="CenterDetermination.get_radius-2872"><a href="#CenterDetermination.get_radius-2872"><span class="linenos">2872</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2873"><a href="#CenterDetermination.get_radius-2873"><span class="linenos">2873</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2874"><a href="#CenterDetermination.get_radius-2874"><span class="linenos">2874</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>  
</span><span id="CenterDetermination.get_radius-2875"><a href="#CenterDetermination.get_radius-2875"><span class="linenos">2875</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2876"><a href="#CenterDetermination.get_radius-2876"><span class="linenos">2876</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2877"><a href="#CenterDetermination.get_radius-2877"><span class="linenos">2877</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2878"><a href="#CenterDetermination.get_radius-2878"><span class="linenos">2878</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-2879"><a href="#CenterDetermination.get_radius-2879"><span class="linenos">2879</span></a>        
</span><span id="CenterDetermination.get_radius-2880"><a href="#CenterDetermination.get_radius-2880"><span class="linenos">2880</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-2881"><a href="#CenterDetermination.get_radius-2881"><span class="linenos">2881</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-2882"><a href="#CenterDetermination.get_radius-2882"><span class="linenos">2882</span></a>        
</span><span id="CenterDetermination.get_radius-2883"><a href="#CenterDetermination.get_radius-2883"><span class="linenos">2883</span></a>        <span class="c1"># Radial distribution method ------------------------------------------</span>
</span><span id="CenterDetermination.get_radius-2884"><a href="#CenterDetermination.get_radius-2884"><span class="linenos">2884</span></a>        <span class="k">elif</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2885"><a href="#CenterDetermination.get_radius-2885"><span class="linenos">2885</span></a>            <span class="n">profile</span> <span class="o">=</span> <span class="n">ediff</span><span class="o">.</span><span class="n">radial</span><span class="o">.</span><span class="n">calc_radial_distribution</span><span class="p">(</span>
</span><span id="CenterDetermination.get_radius-2886"><a href="#CenterDetermination.get_radius-2886"><span class="linenos">2886</span></a>                <span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2887"><a href="#CenterDetermination.get_radius-2887"><span class="linenos">2887</span></a>                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2888"><a href="#CenterDetermination.get_radius-2888"><span class="linenos">2888</span></a>                <span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2889"><a href="#CenterDetermination.get_radius-2889"><span class="linenos">2889</span></a>            <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">profile</span>
</span><span id="CenterDetermination.get_radius-2890"><a href="#CenterDetermination.get_radius-2890"><span class="linenos">2890</span></a>            <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">50</span><span class="p">:])</span> <span class="o">+</span> <span class="mi">50</span>
</span><span id="CenterDetermination.get_radius-2891"><a href="#CenterDetermination.get_radius-2891"><span class="linenos">2891</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-2892"><a href="#CenterDetermination.get_radius-2892"><span class="linenos">2892</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-2893"><a href="#CenterDetermination.get_radius-2893"><span class="linenos">2893</span></a>    
</span><span id="CenterDetermination.get_radius-2894"><a href="#CenterDetermination.get_radius-2894"><span class="linenos">2894</span></a>            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-2895"><a href="#CenterDetermination.get_radius-2895"><span class="linenos">2895</span></a>                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="CenterDetermination.get_radius-2896"><a href="#CenterDetermination.get_radius-2896"><span class="linenos">2896</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2897"><a href="#CenterDetermination.get_radius-2897"><span class="linenos">2897</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="CenterDetermination.get_radius-2898"><a href="#CenterDetermination.get_radius-2898"><span class="linenos">2898</span></a>                    <span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterDetermination.get_radius-2899"><a href="#CenterDetermination.get_radius-2899"><span class="linenos">2899</span></a>                        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">rx</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2900"><a href="#CenterDetermination.get_radius-2900"><span class="linenos">2900</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2901"><a href="#CenterDetermination.get_radius-2901"><span class="linenos">2901</span></a>                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2902"><a href="#CenterDetermination.get_radius-2902"><span class="linenos">2902</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="CenterDetermination.get_radius-2903"><a href="#CenterDetermination.get_radius-2903"><span class="linenos">2903</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2904"><a href="#CenterDetermination.get_radius-2904"><span class="linenos">2904</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Initial Estimate&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2905"><a href="#CenterDetermination.get_radius-2905"><span class="linenos">2905</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2906"><a href="#CenterDetermination.get_radius-2906"><span class="linenos">2906</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2907"><a href="#CenterDetermination.get_radius-2907"><span class="linenos">2907</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_val</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2908"><a href="#CenterDetermination.get_radius-2908"><span class="linenos">2908</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2909"><a href="#CenterDetermination.get_radius-2909"><span class="linenos">2909</span></a>                               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2910"><a href="#CenterDetermination.get_radius-2910"><span class="linenos">2910</span></a>                               <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-2911"><a href="#CenterDetermination.get_radius-2911"><span class="linenos">2911</span></a>                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Radius&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2912"><a href="#CenterDetermination.get_radius-2912"><span class="linenos">2912</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Radial Profile&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-2913"><a href="#CenterDetermination.get_radius-2913"><span class="linenos">2913</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-2914"><a href="#CenterDetermination.get_radius-2914"><span class="linenos">2914</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-2915"><a href="#CenterDetermination.get_radius-2915"><span class="linenos">2915</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-2916"><a href="#CenterDetermination.get_radius-2916"><span class="linenos">2916</span></a>        
</span><span id="CenterDetermination.get_radius-2917"><a href="#CenterDetermination.get_radius-2917"><span class="linenos">2917</span></a>        <span class="c1"># Return found radius</span>
</span><span id="CenterDetermination.get_radius-2918"><a href="#CenterDetermination.get_radius-2918"><span class="linenos">2918</span></a>        <span class="k">return</span> <span class="n">rx</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the radius of a circle based on intensity profiles along 
horizontal and vertical axes.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>rtype</strong> (integer):
Method for radius calculation. Default is 0.
<ul>
<li>rtype=0 : peaks matching method</li>
<li>rtype=1 : radial distribution method</li>
</ul></li>
<li><strong>im</strong> (np.ndarray):
The 2D image array containing the circle.</li>
<li><strong>x</strong> (float):
The x-coordinate of the circle's center.</li>
<li><strong>y</strong> (float):
The y-coordinate of the circle's center.</li>
<li><strong>disp</strong> (bool, optional):
If True, visualizes the detected intensity profiles and peaks 
(default is False).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: The estimated radius of the circle. Defaults to 100 if no valid 
radius is detected.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.backend_fft" class="classattr">
                                        <input id="CenterDetermination.backend_fft-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">backend_fft</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.backend_fft-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.backend_fft"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.backend_fft-2921"><a href="#CenterDetermination.backend_fft-2921"><span class="linenos">2921</span></a>    <span class="k">def</span> <span class="nf">backend_fft</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="CenterDetermination.backend_fft-2922"><a href="#CenterDetermination.backend_fft-2922"><span class="linenos">2922</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.backend_fft-2923"><a href="#CenterDetermination.backend_fft-2923"><span class="linenos">2923</span></a><span class="sd">        Decorator to enforce the use of PocketFFTBackend when utilizing the </span>
</span><span id="CenterDetermination.backend_fft-2924"><a href="#CenterDetermination.backend_fft-2924"><span class="linenos">2924</span></a><span class="sd">        `scipy.fft` module. This ensures that all FFT computations leverage </span>
</span><span id="CenterDetermination.backend_fft-2925"><a href="#CenterDetermination.backend_fft-2925"><span class="linenos">2925</span></a><span class="sd">        the optimized PocketFFT implementation, improving performance, </span>
</span><span id="CenterDetermination.backend_fft-2926"><a href="#CenterDetermination.backend_fft-2926"><span class="linenos">2926</span></a><span class="sd">        particularly for multi-threaded execution.</span>
</span><span id="CenterDetermination.backend_fft-2927"><a href="#CenterDetermination.backend_fft-2927"><span class="linenos">2927</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.backend_fft-2928"><a href="#CenterDetermination.backend_fft-2928"><span class="linenos">2928</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.backend_fft-2929"><a href="#CenterDetermination.backend_fft-2929"><span class="linenos">2929</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.backend_fft-2930"><a href="#CenterDetermination.backend_fft-2930"><span class="linenos">2930</span></a><span class="sd">        f : callable</span>
</span><span id="CenterDetermination.backend_fft-2931"><a href="#CenterDetermination.backend_fft-2931"><span class="linenos">2931</span></a><span class="sd">            The function to be wrapped, ensuring it executes within the </span>
</span><span id="CenterDetermination.backend_fft-2932"><a href="#CenterDetermination.backend_fft-2932"><span class="linenos">2932</span></a><span class="sd">            PocketFFTBackend context.</span>
</span><span id="CenterDetermination.backend_fft-2933"><a href="#CenterDetermination.backend_fft-2933"><span class="linenos">2933</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.backend_fft-2934"><a href="#CenterDetermination.backend_fft-2934"><span class="linenos">2934</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.backend_fft-2935"><a href="#CenterDetermination.backend_fft-2935"><span class="linenos">2935</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.backend_fft-2936"><a href="#CenterDetermination.backend_fft-2936"><span class="linenos">2936</span></a><span class="sd">        callable</span>
</span><span id="CenterDetermination.backend_fft-2937"><a href="#CenterDetermination.backend_fft-2937"><span class="linenos">2937</span></a><span class="sd">            A wrapped function that forces the use of PocketFFTBackend.</span>
</span><span id="CenterDetermination.backend_fft-2938"><a href="#CenterDetermination.backend_fft-2938"><span class="linenos">2938</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.backend_fft-2939"><a href="#CenterDetermination.backend_fft-2939"><span class="linenos">2939</span></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="CenterDetermination.backend_fft-2940"><a href="#CenterDetermination.backend_fft-2940"><span class="linenos">2940</span></a>        <span class="k">def</span> <span class="nf">newf</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="CenterDetermination.backend_fft-2941"><a href="#CenterDetermination.backend_fft-2941"><span class="linenos">2941</span></a>            <span class="k">with</span> <span class="n">set_backend</span><span class="p">(</span><span class="n">PocketFFTBackend</span><span class="p">):</span>
</span><span id="CenterDetermination.backend_fft-2942"><a href="#CenterDetermination.backend_fft-2942"><span class="linenos">2942</span></a>                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="CenterDetermination.backend_fft-2943"><a href="#CenterDetermination.backend_fft-2943"><span class="linenos">2943</span></a>        <span class="k">return</span> <span class="n">newf</span>
</span></pre></div>


            <div class="docstring"><p>Decorator to enforce the use of PocketFFTBackend when utilizing the 
<code>scipy.fft</code> module. This ensures that all FFT computations leverage 
the optimized PocketFFT implementation, improving performance, 
particularly for multi-threaded execution.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>f</strong> (callable):
The function to be wrapped, ensuring it executes within the 
PocketFFTBackend context.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>callable</strong>: A wrapped function that forces the use of PocketFFTBackend.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.calc_fft" class="classattr">
                                        <input id="CenterDetermination.calc_fft-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-backend_fft">@backend_fft</div>

        <span class="def">def</span>
        <span class="name">calc_fft</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fft_function</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.calc_fft-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.calc_fft"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.calc_fft-2945"><a href="#CenterDetermination.calc_fft-2945"><span class="linenos">2945</span></a>    <span class="nd">@backend_fft</span>
</span><span id="CenterDetermination.calc_fft-2946"><a href="#CenterDetermination.calc_fft-2946"><span class="linenos">2946</span></a>    <span class="k">def</span> <span class="nf">calc_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fft_function</span><span class="p">):</span>
</span><span id="CenterDetermination.calc_fft-2947"><a href="#CenterDetermination.calc_fft-2947"><span class="linenos">2947</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.calc_fft-2948"><a href="#CenterDetermination.calc_fft-2948"><span class="linenos">2948</span></a><span class="sd">        Computes the Fast Fourier Transform (FFT) using the specified function.</span>
</span><span id="CenterDetermination.calc_fft-2949"><a href="#CenterDetermination.calc_fft-2949"><span class="linenos">2949</span></a>
</span><span id="CenterDetermination.calc_fft-2950"><a href="#CenterDetermination.calc_fft-2950"><span class="linenos">2950</span></a><span class="sd">        This method ensures that the FFT operation is executed using </span>
</span><span id="CenterDetermination.calc_fft-2951"><a href="#CenterDetermination.calc_fft-2951"><span class="linenos">2951</span></a><span class="sd">        the PocketFFTBackend, applying optimized settings for improved efficiency.</span>
</span><span id="CenterDetermination.calc_fft-2952"><a href="#CenterDetermination.calc_fft-2952"><span class="linenos">2952</span></a>
</span><span id="CenterDetermination.calc_fft-2953"><a href="#CenterDetermination.calc_fft-2953"><span class="linenos">2953</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.calc_fft-2954"><a href="#CenterDetermination.calc_fft-2954"><span class="linenos">2954</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.calc_fft-2955"><a href="#CenterDetermination.calc_fft-2955"><span class="linenos">2955</span></a><span class="sd">        fft_function : callable</span>
</span><span id="CenterDetermination.calc_fft-2956"><a href="#CenterDetermination.calc_fft-2956"><span class="linenos">2956</span></a><span class="sd">            The FFT function to be applied to the data.</span>
</span><span id="CenterDetermination.calc_fft-2957"><a href="#CenterDetermination.calc_fft-2957"><span class="linenos">2957</span></a>
</span><span id="CenterDetermination.calc_fft-2958"><a href="#CenterDetermination.calc_fft-2958"><span class="linenos">2958</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.calc_fft-2959"><a href="#CenterDetermination.calc_fft-2959"><span class="linenos">2959</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.calc_fft-2960"><a href="#CenterDetermination.calc_fft-2960"><span class="linenos">2960</span></a><span class="sd">        object</span>
</span><span id="CenterDetermination.calc_fft-2961"><a href="#CenterDetermination.calc_fft-2961"><span class="linenos">2961</span></a><span class="sd">            The result of the FFT computation.</span>
</span><span id="CenterDetermination.calc_fft-2962"><a href="#CenterDetermination.calc_fft-2962"><span class="linenos">2962</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.calc_fft-2963"><a href="#CenterDetermination.calc_fft-2963"><span class="linenos">2963</span></a>        <span class="k">return</span> <span class="n">fft_function</span>
</span></pre></div>


            <div class="docstring"><p>Computes the Fast Fourier Transform (FFT) using the specified function.</p>

<p>This method ensures that the FFT operation is executed using 
the PocketFFTBackend, applying optimized settings for improved efficiency.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fft_function</strong> (callable):
The FFT function to be applied to the data.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>object</strong>: The result of the FFT computation.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.auto_masking" class="classattr">
                                        <input id="CenterDetermination.auto_masking-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">auto_masking</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">im</span>, </span><span class="param"><span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span>, </span><span class="param"><span class="n">show_mask</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.auto_masking-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.auto_masking"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.auto_masking-2966"><a href="#CenterDetermination.auto_masking-2966"><span class="linenos">2966</span></a>    <span class="k">def</span> <span class="nf">auto_masking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">show_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination.auto_masking-2967"><a href="#CenterDetermination.auto_masking-2967"><span class="linenos">2967</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.auto_masking-2968"><a href="#CenterDetermination.auto_masking-2968"><span class="linenos">2968</span></a><span class="sd">        Automatically generates a binary mask for an image based on intensity </span>
</span><span id="CenterDetermination.auto_masking-2969"><a href="#CenterDetermination.auto_masking-2969"><span class="linenos">2969</span></a><span class="sd">        thresholding.</span>
</span><span id="CenterDetermination.auto_masking-2970"><a href="#CenterDetermination.auto_masking-2970"><span class="linenos">2970</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.auto_masking-2971"><a href="#CenterDetermination.auto_masking-2971"><span class="linenos">2971</span></a><span class="sd">        This function determines a lower intensity limit by taking a fraction </span>
</span><span id="CenterDetermination.auto_masking-2972"><a href="#CenterDetermination.auto_masking-2972"><span class="linenos">2972</span></a><span class="sd">        (threshold) of the median of the highest intensity values in the image. </span>
</span><span id="CenterDetermination.auto_masking-2973"><a href="#CenterDetermination.auto_masking-2973"><span class="linenos">2973</span></a><span class="sd">        This helps filter out noise while preserving meaningful features, </span>
</span><span id="CenterDetermination.auto_masking-2974"><a href="#CenterDetermination.auto_masking-2974"><span class="linenos">2974</span></a><span class="sd">        avoiding the influence of hot spots.</span>
</span><span id="CenterDetermination.auto_masking-2975"><a href="#CenterDetermination.auto_masking-2975"><span class="linenos">2975</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.auto_masking-2976"><a href="#CenterDetermination.auto_masking-2976"><span class="linenos">2976</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.auto_masking-2977"><a href="#CenterDetermination.auto_masking-2977"><span class="linenos">2977</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.auto_masking-2978"><a href="#CenterDetermination.auto_masking-2978"><span class="linenos">2978</span></a><span class="sd">        im : ndarray</span>
</span><span id="CenterDetermination.auto_masking-2979"><a href="#CenterDetermination.auto_masking-2979"><span class="linenos">2979</span></a><span class="sd">            Input grayscale image as a 2D NumPy array.</span>
</span><span id="CenterDetermination.auto_masking-2980"><a href="#CenterDetermination.auto_masking-2980"><span class="linenos">2980</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.auto_masking-2981"><a href="#CenterDetermination.auto_masking-2981"><span class="linenos">2981</span></a><span class="sd">        threshold : float, optional</span>
</span><span id="CenterDetermination.auto_masking-2982"><a href="#CenterDetermination.auto_masking-2982"><span class="linenos">2982</span></a><span class="sd">            A fraction (default is 0.1) of the median of the highest intensity </span>
</span><span id="CenterDetermination.auto_masking-2983"><a href="#CenterDetermination.auto_masking-2983"><span class="linenos">2983</span></a><span class="sd">            values. Pixels with intensity above this computed limit will be </span>
</span><span id="CenterDetermination.auto_masking-2984"><a href="#CenterDetermination.auto_masking-2984"><span class="linenos">2984</span></a><span class="sd">            included in the mask.</span>
</span><span id="CenterDetermination.auto_masking-2985"><a href="#CenterDetermination.auto_masking-2985"><span class="linenos">2985</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.auto_masking-2986"><a href="#CenterDetermination.auto_masking-2986"><span class="linenos">2986</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.auto_masking-2987"><a href="#CenterDetermination.auto_masking-2987"><span class="linenos">2987</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.auto_masking-2988"><a href="#CenterDetermination.auto_masking-2988"><span class="linenos">2988</span></a><span class="sd">        mask : ndarray</span>
</span><span id="CenterDetermination.auto_masking-2989"><a href="#CenterDetermination.auto_masking-2989"><span class="linenos">2989</span></a><span class="sd">            A boolean mask (same shape as `im`), where `True` indicates pixels </span>
</span><span id="CenterDetermination.auto_masking-2990"><a href="#CenterDetermination.auto_masking-2990"><span class="linenos">2990</span></a><span class="sd">            above the threshold and `False` represents background or noise.</span>
</span><span id="CenterDetermination.auto_masking-2991"><a href="#CenterDetermination.auto_masking-2991"><span class="linenos">2991</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.auto_masking-2992"><a href="#CenterDetermination.auto_masking-2992"><span class="linenos">2992</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.auto_masking-2993"><a href="#CenterDetermination.auto_masking-2993"><span class="linenos">2993</span></a>        <span class="c1"># Find the median of the highest intensity value of the image to avoid </span>
</span><span id="CenterDetermination.auto_masking-2994"><a href="#CenterDetermination.auto_masking-2994"><span class="linenos">2994</span></a>        <span class="c1"># hot spots (More stable than median scaling)</span>
</span><span id="CenterDetermination.auto_masking-2995"><a href="#CenterDetermination.auto_masking-2995"><span class="linenos">2995</span></a>        <span class="n">lower_limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> 
</span><span id="CenterDetermination.auto_masking-2996"><a href="#CenterDetermination.auto_masking-2996"><span class="linenos">2996</span></a>        
</span><span id="CenterDetermination.auto_masking-2997"><a href="#CenterDetermination.auto_masking-2997"><span class="linenos">2997</span></a>        <span class="c1"># Generate a mask</span>
</span><span id="CenterDetermination.auto_masking-2998"><a href="#CenterDetermination.auto_masking-2998"><span class="linenos">2998</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">im</span> <span class="o">&gt;</span> <span class="n">lower_limit</span>
</span><span id="CenterDetermination.auto_masking-2999"><a href="#CenterDetermination.auto_masking-2999"><span class="linenos">2999</span></a>        
</span><span id="CenterDetermination.auto_masking-3000"><a href="#CenterDetermination.auto_masking-3000"><span class="linenos">3000</span></a>        <span class="k">if</span> <span class="n">show_mask</span><span class="p">:</span>
</span><span id="CenterDetermination.auto_masking-3001"><a href="#CenterDetermination.auto_masking-3001"><span class="linenos">3001</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="CenterDetermination.auto_masking-3002"><a href="#CenterDetermination.auto_masking-3002"><span class="linenos">3002</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="CenterDetermination.auto_masking-3003"><a href="#CenterDetermination.auto_masking-3003"><span class="linenos">3003</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Beam Stopper Masking&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.auto_masking-3004"><a href="#CenterDetermination.auto_masking-3004"><span class="linenos">3004</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.auto_masking-3005"><a href="#CenterDetermination.auto_masking-3005"><span class="linenos">3005</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.auto_masking-3006"><a href="#CenterDetermination.auto_masking-3006"><span class="linenos">3006</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.auto_masking-3007"><a href="#CenterDetermination.auto_masking-3007"><span class="linenos">3007</span></a>        
</span><span id="CenterDetermination.auto_masking-3008"><a href="#CenterDetermination.auto_masking-3008"><span class="linenos">3008</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Automatically generates a binary mask for an image based on intensity 
thresholding.</p>

<p>This function determines a lower intensity limit by taking a fraction 
(threshold) of the median of the highest intensity values in the image. 
This helps filter out noise while preserving meaningful features, 
avoiding the influence of hot spots.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>im</strong> (ndarray):
Input grayscale image as a 2D NumPy array.</li>
<li><strong>threshold</strong> (float, optional):
A fraction (default is 0.1) of the median of the highest intensity 
values. Pixels with intensity above this computed limit will be 
included in the mask.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>mask</strong> (ndarray):
A boolean mask (same shape as <code>im</code>), where <code>True</code> indicates pixels 
above the threshold and <code>False</code> represents background or noise.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.visualize_center" class="classattr">
                                        <input id="CenterDetermination.visualize_center-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_center</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">y</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">r</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">rd</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.visualize_center-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.visualize_center"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.visualize_center-3011"><a href="#CenterDetermination.visualize_center-3011"><span class="linenos">3011</span></a>    <span class="k">def</span> <span class="nf">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-3012"><a href="#CenterDetermination.visualize_center-3012"><span class="linenos">3012</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination.visualize_center-3013"><a href="#CenterDetermination.visualize_center-3013"><span class="linenos">3013</span></a><span class="sd">        Visualize detected diffraction patterns and mark the center.</span>
</span><span id="CenterDetermination.visualize_center-3014"><a href="#CenterDetermination.visualize_center-3014"><span class="linenos">3014</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.visualize_center-3015"><a href="#CenterDetermination.visualize_center-3015"><span class="linenos">3015</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.visualize_center-3016"><a href="#CenterDetermination.visualize_center-3016"><span class="linenos">3016</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.visualize_center-3017"><a href="#CenterDetermination.visualize_center-3017"><span class="linenos">3017</span></a><span class="sd">        tit : string</span>
</span><span id="CenterDetermination.visualize_center-3018"><a href="#CenterDetermination.visualize_center-3018"><span class="linenos">3018</span></a><span class="sd">            name of the method used for circle detection</span>
</span><span id="CenterDetermination.visualize_center-3019"><a href="#CenterDetermination.visualize_center-3019"><span class="linenos">3019</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.visualize_center-3020"><a href="#CenterDetermination.visualize_center-3020"><span class="linenos">3020</span></a><span class="sd">        x : float64</span>
</span><span id="CenterDetermination.visualize_center-3021"><a href="#CenterDetermination.visualize_center-3021"><span class="linenos">3021</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination.visualize_center-3022"><a href="#CenterDetermination.visualize_center-3022"><span class="linenos">3022</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.visualize_center-3023"><a href="#CenterDetermination.visualize_center-3023"><span class="linenos">3023</span></a><span class="sd">        y : float64</span>
</span><span id="CenterDetermination.visualize_center-3024"><a href="#CenterDetermination.visualize_center-3024"><span class="linenos">3024</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination.visualize_center-3025"><a href="#CenterDetermination.visualize_center-3025"><span class="linenos">3025</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.visualize_center-3026"><a href="#CenterDetermination.visualize_center-3026"><span class="linenos">3026</span></a><span class="sd">        r : float64</span>
</span><span id="CenterDetermination.visualize_center-3027"><a href="#CenterDetermination.visualize_center-3027"><span class="linenos">3027</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination.visualize_center-3028"><a href="#CenterDetermination.visualize_center-3028"><span class="linenos">3028</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.visualize_center-3029"><a href="#CenterDetermination.visualize_center-3029"><span class="linenos">3029</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.visualize_center-3030"><a href="#CenterDetermination.visualize_center-3030"><span class="linenos">3030</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.visualize_center-3031"><a href="#CenterDetermination.visualize_center-3031"><span class="linenos">3031</span></a><span class="sd">        None.</span>
</span><span id="CenterDetermination.visualize_center-3032"><a href="#CenterDetermination.visualize_center-3032"><span class="linenos">3032</span></a><span class="sd">                            </span>
</span><span id="CenterDetermination.visualize_center-3033"><a href="#CenterDetermination.visualize_center-3033"><span class="linenos">3033</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination.visualize_center-3034"><a href="#CenterDetermination.visualize_center-3034"><span class="linenos">3034</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterDetermination.visualize_center-3035"><a href="#CenterDetermination.visualize_center-3035"><span class="linenos">3035</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3036"><a href="#CenterDetermination.visualize_center-3036"><span class="linenos">3036</span></a>    
</span><span id="CenterDetermination.visualize_center-3037"><a href="#CenterDetermination.visualize_center-3037"><span class="linenos">3037</span></a>        <span class="k">if</span> <span class="n">rd</span><span class="o">==</span><span class="s2">&quot;d&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-3038"><a href="#CenterDetermination.visualize_center-3038"><span class="linenos">3038</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Detected center position&quot;</span>
</span><span id="CenterDetermination.visualize_center-3039"><a href="#CenterDetermination.visualize_center-3039"><span class="linenos">3039</span></a>        <span class="k">elif</span> <span class="n">rd</span><span class="o">==</span><span class="s2">&quot;r&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-3040"><a href="#CenterDetermination.visualize_center-3040"><span class="linenos">3040</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Refined center position&quot;</span>
</span><span id="CenterDetermination.visualize_center-3041"><a href="#CenterDetermination.visualize_center-3041"><span class="linenos">3041</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterDetermination.visualize_center-3042"><a href="#CenterDetermination.visualize_center-3042"><span class="linenos">3042</span></a>            <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;Center position&quot;</span>
</span><span id="CenterDetermination.visualize_center-3043"><a href="#CenterDetermination.visualize_center-3043"><span class="linenos">3043</span></a>            
</span><span id="CenterDetermination.visualize_center-3044"><a href="#CenterDetermination.visualize_center-3044"><span class="linenos">3044</span></a>            
</span><span id="CenterDetermination.visualize_center-3045"><a href="#CenterDetermination.visualize_center-3045"><span class="linenos">3045</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-3046"><a href="#CenterDetermination.visualize_center-3046"><span class="linenos">3046</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3047"><a href="#CenterDetermination.visualize_center-3047"><span class="linenos">3047</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-3048"><a href="#CenterDetermination.visualize_center-3048"><span class="linenos">3048</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3049"><a href="#CenterDetermination.visualize_center-3049"><span class="linenos">3049</span></a>            
</span><span id="CenterDetermination.visualize_center-3050"><a href="#CenterDetermination.visualize_center-3050"><span class="linenos">3050</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterDetermination.visualize_center-3051"><a href="#CenterDetermination.visualize_center-3051"><span class="linenos">3051</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination.visualize_center-3052"><a href="#CenterDetermination.visualize_center-3052"><span class="linenos">3052</span></a>        
</span><span id="CenterDetermination.visualize_center-3053"><a href="#CenterDetermination.visualize_center-3053"><span class="linenos">3053</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination.visualize_center-3054"><a href="#CenterDetermination.visualize_center-3054"><span class="linenos">3054</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3055"><a href="#CenterDetermination.visualize_center-3055"><span class="linenos">3055</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3056"><a href="#CenterDetermination.visualize_center-3056"><span class="linenos">3056</span></a> 
</span><span id="CenterDetermination.visualize_center-3057"><a href="#CenterDetermination.visualize_center-3057"><span class="linenos">3057</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">tit</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3058"><a href="#CenterDetermination.visualize_center-3058"><span class="linenos">3058</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3059"><a href="#CenterDetermination.visualize_center-3059"><span class="linenos">3059</span></a>
</span><span id="CenterDetermination.visualize_center-3060"><a href="#CenterDetermination.visualize_center-3060"><span class="linenos">3060</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination.visualize_center-3061"><a href="#CenterDetermination.visualize_center-3061"><span class="linenos">3061</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination.visualize_center-3062"><a href="#CenterDetermination.visualize_center-3062"><span class="linenos">3062</span></a>                <span class="n">label</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;center:  [</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span>
</span><span id="CenterDetermination.visualize_center-3063"><a href="#CenterDetermination.visualize_center-3063"><span class="linenos">3063</span></a>                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3064"><a href="#CenterDetermination.visualize_center-3064"><span class="linenos">3064</span></a>
</span><span id="CenterDetermination.visualize_center-3065"><a href="#CenterDetermination.visualize_center-3065"><span class="linenos">3065</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3066"><a href="#CenterDetermination.visualize_center-3066"><span class="linenos">3066</span></a>        
</span><span id="CenterDetermination.visualize_center-3067"><a href="#CenterDetermination.visualize_center-3067"><span class="linenos">3067</span></a>        <span class="c1"># Display the image</span>
</span><span id="CenterDetermination.visualize_center-3068"><a href="#CenterDetermination.visualize_center-3068"><span class="linenos">3068</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3069"><a href="#CenterDetermination.visualize_center-3069"><span class="linenos">3069</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-3070"><a href="#CenterDetermination.visualize_center-3070"><span class="linenos">3070</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.visualize_center-3071"><a href="#CenterDetermination.visualize_center-3071"><span class="linenos">3071</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize detected diffraction patterns and mark the center.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>tit</strong> (string):
name of the method used for circle detection</li>
<li><strong>x</strong> (float64):
x-coordinate of the detected center</li>
<li><strong>y</strong> (float64):
y-coordinate of the detected center</li>
<li><strong>r</strong> (float64):
radius of the detected center</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                            </div>
                </section>
                <section id="CenterRefinement">
                            <input id="CenterRefinement-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CenterRefinement</span>:

                <label class="view-source-button" for="CenterRefinement-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement-3075"><a href="#CenterRefinement-3075"><span class="linenos">3075</span></a><span class="k">class</span> <span class="nc">CenterRefinement</span><span class="p">:</span>
</span><span id="CenterRefinement-3076"><a href="#CenterRefinement-3076"><span class="linenos">3076</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterRefinement-3077"><a href="#CenterRefinement-3077"><span class="linenos">3077</span></a><span class="sd">    CenterRefinement - Final refinement of the center of a diffraction pattern.</span>
</span><span id="CenterRefinement-3078"><a href="#CenterRefinement-3078"><span class="linenos">3078</span></a>
</span><span id="CenterRefinement-3079"><a href="#CenterRefinement-3079"><span class="linenos">3079</span></a><span class="sd">    This class performs refinement of the detected center coordinates in a 2D</span>
</span><span id="CenterRefinement-3080"><a href="#CenterRefinement-3080"><span class="linenos">3080</span></a><span class="sd">    diffraction pattern. It supports multiple refinement methods, both manual</span>
</span><span id="CenterRefinement-3081"><a href="#CenterRefinement-3081"><span class="linenos">3081</span></a><span class="sd">    and automatic, and optionally saves the refined center to a file.</span>
</span><span id="CenterRefinement-3082"><a href="#CenterRefinement-3082"><span class="linenos">3082</span></a>
</span><span id="CenterRefinement-3083"><a href="#CenterRefinement-3083"><span class="linenos">3083</span></a>
</span><span id="CenterRefinement-3084"><a href="#CenterRefinement-3084"><span class="linenos">3084</span></a><span class="sd">    Parameters</span>
</span><span id="CenterRefinement-3085"><a href="#CenterRefinement-3085"><span class="linenos">3085</span></a><span class="sd">    ----------</span>
</span><span id="CenterRefinement-3086"><a href="#CenterRefinement-3086"><span class="linenos">3086</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="CenterRefinement-3087"><a href="#CenterRefinement-3087"><span class="linenos">3087</span></a><span class="sd">        Reference to the parent CenterLocator object. Used to access shared</span>
</span><span id="CenterRefinement-3088"><a href="#CenterRefinement-3088"><span class="linenos">3088</span></a><span class="sd">        attributes like initial center estimates and configuration flags.</span>
</span><span id="CenterRefinement-3089"><a href="#CenterRefinement-3089"><span class="linenos">3089</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-3090"><a href="#CenterRefinement-3090"><span class="linenos">3090</span></a><span class="sd">    input_image : str, Path, or numpy.ndarray</span>
</span><span id="CenterRefinement-3091"><a href="#CenterRefinement-3091"><span class="linenos">3091</span></a><span class="sd">        The diffraction pattern image, either as a file path or a 2D NumPy array.</span>
</span><span id="CenterRefinement-3092"><a href="#CenterRefinement-3092"><span class="linenos">3092</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3093"><a href="#CenterRefinement-3093"><span class="linenos">3093</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-3094"><a href="#CenterRefinement-3094"><span class="linenos">3094</span></a><span class="sd">    refinement : str or None, optional, default=None</span>
</span><span id="CenterRefinement-3095"><a href="#CenterRefinement-3095"><span class="linenos">3095</span></a><span class="sd">        The refinement method to apply. Options include:</span>
</span><span id="CenterRefinement-3096"><a href="#CenterRefinement-3096"><span class="linenos">3096</span></a><span class="sd">        - &#39;manual&#39;: Manual adjustment via user interaction on the selected ring.</span>
</span><span id="CenterRefinement-3097"><a href="#CenterRefinement-3097"><span class="linenos">3097</span></a><span class="sd">        - &#39;sum&#39;   : Automatic refinement by maximizing the intensity sum </span>
</span><span id="CenterRefinement-3098"><a href="#CenterRefinement-3098"><span class="linenos">3098</span></a><span class="sd">        - &#39;var&#39;   : Automatic refinement by minimizing the intensity variance</span>
</span><span id="CenterRefinement-3099"><a href="#CenterRefinement-3099"><span class="linenos">3099</span></a><span class="sd">        If None, no refinement is applied.</span>
</span><span id="CenterRefinement-3100"><a href="#CenterRefinement-3100"><span class="linenos">3100</span></a><span class="sd">          </span>
</span><span id="CenterRefinement-3101"><a href="#CenterRefinement-3101"><span class="linenos">3101</span></a><span class="sd">    out_file : str, optional</span>
</span><span id="CenterRefinement-3102"><a href="#CenterRefinement-3102"><span class="linenos">3102</span></a><span class="sd">        Path to a text file where the refined center coordinates will be saved.</span>
</span><span id="CenterRefinement-3103"><a href="#CenterRefinement-3103"><span class="linenos">3103</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3104"><a href="#CenterRefinement-3104"><span class="linenos">3104</span></a><span class="sd">    heq : bool, optional, default=False</span>
</span><span id="CenterRefinement-3105"><a href="#CenterRefinement-3105"><span class="linenos">3105</span></a><span class="sd">        Whether to apply histogram equalization to the input image before</span>
</span><span id="CenterRefinement-3106"><a href="#CenterRefinement-3106"><span class="linenos">3106</span></a><span class="sd">        processing.</span>
</span><span id="CenterRefinement-3107"><a href="#CenterRefinement-3107"><span class="linenos">3107</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3108"><a href="#CenterRefinement-3108"><span class="linenos">3108</span></a><span class="sd">    icut : float, optional, default=None</span>
</span><span id="CenterRefinement-3109"><a href="#CenterRefinement-3109"><span class="linenos">3109</span></a><span class="sd">        Cut-off intensity level for processing the image</span>
</span><span id="CenterRefinement-3110"><a href="#CenterRefinement-3110"><span class="linenos">3110</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-3111"><a href="#CenterRefinement-3111"><span class="linenos">3111</span></a><span class="sd">    cmap : str, optional, default=&#39;gray&#39;</span>
</span><span id="CenterRefinement-3112"><a href="#CenterRefinement-3112"><span class="linenos">3112</span></a><span class="sd">        Colormap to be used when displaying the image for manual refinement.</span>
</span><span id="CenterRefinement-3113"><a href="#CenterRefinement-3113"><span class="linenos">3113</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3114"><a href="#CenterRefinement-3114"><span class="linenos">3114</span></a><span class="sd">    verbose : bool, optional, default=False</span>
</span><span id="CenterRefinement-3115"><a href="#CenterRefinement-3115"><span class="linenos">3115</span></a><span class="sd">        Flag to enable or disable informational verbose during processing. </span>
</span><span id="CenterRefinement-3116"><a href="#CenterRefinement-3116"><span class="linenos">3116</span></a>
</span><span id="CenterRefinement-3117"><a href="#CenterRefinement-3117"><span class="linenos">3117</span></a><span class="sd">    print_sums : bool, optional, default=False</span>
</span><span id="CenterRefinement-3118"><a href="#CenterRefinement-3118"><span class="linenos">3118</span></a><span class="sd">        If True, prints the sum of intensity values for the refined circle </span>
</span><span id="CenterRefinement-3119"><a href="#CenterRefinement-3119"><span class="linenos">3119</span></a><span class="sd">        after each adjustment, relevant only for manual refinement methods.</span>
</span><span id="CenterRefinement-3120"><a href="#CenterRefinement-3120"><span class="linenos">3120</span></a>
</span><span id="CenterRefinement-3121"><a href="#CenterRefinement-3121"><span class="linenos">3121</span></a><span class="sd">    Returns</span>
</span><span id="CenterRefinement-3122"><a href="#CenterRefinement-3122"><span class="linenos">3122</span></a><span class="sd">    -------</span>
</span><span id="CenterRefinement-3123"><a href="#CenterRefinement-3123"><span class="linenos">3123</span></a><span class="sd">    None</span>
</span><span id="CenterRefinement-3124"><a href="#CenterRefinement-3124"><span class="linenos">3124</span></a>
</span><span id="CenterRefinement-3125"><a href="#CenterRefinement-3125"><span class="linenos">3125</span></a><span class="sd">    Notes</span>
</span><span id="CenterRefinement-3126"><a href="#CenterRefinement-3126"><span class="linenos">3126</span></a><span class="sd">    -----</span>
</span><span id="CenterRefinement-3127"><a href="#CenterRefinement-3127"><span class="linenos">3127</span></a><span class="sd">    - If an unsupported refinement method is provided, the program exits with</span>
</span><span id="CenterRefinement-3128"><a href="#CenterRefinement-3128"><span class="linenos">3128</span></a><span class="sd">      an error.</span>
</span><span id="CenterRefinement-3129"><a href="#CenterRefinement-3129"><span class="linenos">3129</span></a><span class="sd">    - The coordinates `xx`, `yy`, and radius `rr` can be accessed after</span>
</span><span id="CenterRefinement-3130"><a href="#CenterRefinement-3130"><span class="linenos">3130</span></a><span class="sd">      initialization for further analysis or saving.</span>
</span><span id="CenterRefinement-3131"><a href="#CenterRefinement-3131"><span class="linenos">3131</span></a><span class="sd">    - The refinement strategy relies on initial estimates provided by the parent </span>
</span><span id="CenterRefinement-3132"><a href="#CenterRefinement-3132"><span class="linenos">3132</span></a><span class="sd">      object.</span>
</span><span id="CenterRefinement-3133"><a href="#CenterRefinement-3133"><span class="linenos">3133</span></a><span class="sd">    - Manual refinement supports click-based center adjustments guided by visual </span>
</span><span id="CenterRefinement-3134"><a href="#CenterRefinement-3134"><span class="linenos">3134</span></a><span class="sd">      feedback.</span>
</span><span id="CenterRefinement-3135"><a href="#CenterRefinement-3135"><span class="linenos">3135</span></a><span class="sd">    - Sum/variance refinement automatically searches for the most likely center</span>
</span><span id="CenterRefinement-3136"><a href="#CenterRefinement-3136"><span class="linenos">3136</span></a><span class="sd">      by evaluating ring statistics.</span>
</span><span id="CenterRefinement-3137"><a href="#CenterRefinement-3137"><span class="linenos">3137</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="CenterRefinement-3138"><a href="#CenterRefinement-3138"><span class="linenos">3138</span></a>    
</span><span id="CenterRefinement-3139"><a href="#CenterRefinement-3139"><span class="linenos">3139</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="CenterRefinement-3140"><a href="#CenterRefinement-3140"><span class="linenos">3140</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3141"><a href="#CenterRefinement-3141"><span class="linenos">3141</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-3142"><a href="#CenterRefinement-3142"><span class="linenos">3142</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-3143"><a href="#CenterRefinement-3143"><span class="linenos">3143</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-3144"><a href="#CenterRefinement-3144"><span class="linenos">3144</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterRefinement-3145"><a href="#CenterRefinement-3145"><span class="linenos">3145</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-3146"><a href="#CenterRefinement-3146"><span class="linenos">3146</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="CenterRefinement-3147"><a href="#CenterRefinement-3147"><span class="linenos">3147</span></a>                 <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CenterRefinement-3148"><a href="#CenterRefinement-3148"><span class="linenos">3148</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="CenterRefinement-3149"><a href="#CenterRefinement-3149"><span class="linenos">3149</span></a>        
</span><span id="CenterRefinement-3150"><a href="#CenterRefinement-3150"><span class="linenos">3150</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterRefinement-3151"><a href="#CenterRefinement-3151"><span class="linenos">3151</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="CenterRefinement-3152"><a href="#CenterRefinement-3152"><span class="linenos">3152</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="CenterRefinement-3153"><a href="#CenterRefinement-3153"><span class="linenos">3153</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterRefinement-3154"><a href="#CenterRefinement-3154"><span class="linenos">3154</span></a>        
</span><span id="CenterRefinement-3155"><a href="#CenterRefinement-3155"><span class="linenos">3155</span></a>        <span class="c1">## (0) Initialize input attributes ------------------------------------</span>
</span><span id="CenterRefinement-3156"><a href="#CenterRefinement-3156"><span class="linenos">3156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="CenterRefinement-3157"><a href="#CenterRefinement-3157"><span class="linenos">3157</span></a>        
</span><span id="CenterRefinement-3158"><a href="#CenterRefinement-3158"><span class="linenos">3158</span></a>        <span class="c1">## (1) Initialize new attributes --------------------------------------</span>
</span><span id="CenterRefinement-3159"><a href="#CenterRefinement-3159"><span class="linenos">3159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="CenterRefinement-3160"><a href="#CenterRefinement-3160"><span class="linenos">3160</span></a>        
</span><span id="CenterRefinement-3161"><a href="#CenterRefinement-3161"><span class="linenos">3161</span></a>        <span class="c1">## (2) Run functions --------------------------------------------------</span>
</span><span id="CenterRefinement-3162"><a href="#CenterRefinement-3162"><span class="linenos">3162</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterRefinement-3163"><a href="#CenterRefinement-3163"><span class="linenos">3163</span></a>            <span class="c1"># Flag for later</span>
</span><span id="CenterRefinement-3164"><a href="#CenterRefinement-3164"><span class="linenos">3164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterRefinement-3165"><a href="#CenterRefinement-3165"><span class="linenos">3165</span></a>            <span class="n">par_short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">center1</span>
</span><span id="CenterRefinement-3166"><a href="#CenterRefinement-3166"><span class="linenos">3166</span></a>        
</span><span id="CenterRefinement-3167"><a href="#CenterRefinement-3167"><span class="linenos">3167</span></a>            <span class="k">if</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterRefinement-3168"><a href="#CenterRefinement-3168"><span class="linenos">3168</span></a>                <span class="c1"># Manual refinement method</span>
</span><span id="CenterRefinement-3169"><a href="#CenterRefinement-3169"><span class="linenos">3169</span></a>                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3170"><a href="#CenterRefinement-3170"><span class="linenos">3170</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> \
</span><span id="CenterRefinement-3171"><a href="#CenterRefinement-3171"><span class="linenos">3171</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterRefinement-3172"><a href="#CenterRefinement-3172"><span class="linenos">3172</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> \
</span><span id="CenterRefinement-3173"><a href="#CenterRefinement-3173"><span class="linenos">3173</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterRefinement-3174"><a href="#CenterRefinement-3174"><span class="linenos">3174</span></a>                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-3175"><a href="#CenterRefinement-3175"><span class="linenos">3175</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement-3176"><a href="#CenterRefinement-3176"><span class="linenos">3176</span></a>                            <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-3177"><a href="#CenterRefinement-3177"><span class="linenos">3177</span></a>                <span class="k">elif</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3178"><a href="#CenterRefinement-3178"><span class="linenos">3178</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="CenterRefinement-3179"><a href="#CenterRefinement-3179"><span class="linenos">3179</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-3180"><a href="#CenterRefinement-3180"><span class="linenos">3180</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement-3181"><a href="#CenterRefinement-3181"><span class="linenos">3181</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="CenterRefinement-3182"><a href="#CenterRefinement-3182"><span class="linenos">3182</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-3183"><a href="#CenterRefinement-3183"><span class="linenos">3183</span></a>        
</span><span id="CenterRefinement-3184"><a href="#CenterRefinement-3184"><span class="linenos">3184</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="CenterRefinement-3185"><a href="#CenterRefinement-3185"><span class="linenos">3185</span></a>                <span class="c1"># Intensity variance refinement</span>
</span><span id="CenterRefinement-3186"><a href="#CenterRefinement-3186"><span class="linenos">3186</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_var</span><span class="p">(</span>
</span><span id="CenterRefinement-3187"><a href="#CenterRefinement-3187"><span class="linenos">3187</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-3188"><a href="#CenterRefinement-3188"><span class="linenos">3188</span></a>        
</span><span id="CenterRefinement-3189"><a href="#CenterRefinement-3189"><span class="linenos">3189</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
</span><span id="CenterRefinement-3190"><a href="#CenterRefinement-3190"><span class="linenos">3190</span></a>                <span class="c1"># Intensity sum refinement</span>
</span><span id="CenterRefinement-3191"><a href="#CenterRefinement-3191"><span class="linenos">3191</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_sum</span><span class="p">(</span>
</span><span id="CenterRefinement-3192"><a href="#CenterRefinement-3192"><span class="linenos">3192</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="CenterRefinement-3193"><a href="#CenterRefinement-3193"><span class="linenos">3193</span></a>                    <span class="n">live_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">live_plot</span><span class="p">)</span>
</span><span id="CenterRefinement-3194"><a href="#CenterRefinement-3194"><span class="linenos">3194</span></a>            
</span><span id="CenterRefinement-3195"><a href="#CenterRefinement-3195"><span class="linenos">3195</span></a>
</span><span id="CenterRefinement-3196"><a href="#CenterRefinement-3196"><span class="linenos">3196</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement-3197"><a href="#CenterRefinement-3197"><span class="linenos">3197</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected refinement method is not supported.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3198"><a href="#CenterRefinement-3198"><span class="linenos">3198</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterRefinement-3199"><a href="#CenterRefinement-3199"><span class="linenos">3199</span></a>       
</span><span id="CenterRefinement-3200"><a href="#CenterRefinement-3200"><span class="linenos">3200</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>          
</span><span id="CenterRefinement-3201"><a href="#CenterRefinement-3201"><span class="linenos">3201</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterRefinement-3202"><a href="#CenterRefinement-3202"><span class="linenos">3202</span></a>            <span class="c1"># Flag for later</span>
</span><span id="CenterRefinement-3203"><a href="#CenterRefinement-3203"><span class="linenos">3203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="CenterRefinement-3204"><a href="#CenterRefinement-3204"><span class="linenos">3204</span></a>            
</span><span id="CenterRefinement-3205"><a href="#CenterRefinement-3205"><span class="linenos">3205</span></a>           
</span><span id="CenterRefinement-3206"><a href="#CenterRefinement-3206"><span class="linenos">3206</span></a>    <span class="k">def</span> <span class="nf">ref_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterRefinement-3207"><a href="#CenterRefinement-3207"><span class="linenos">3207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3208"><a href="#CenterRefinement-3208"><span class="linenos">3208</span></a><span class="sd">        Manual/interactive refinement of the diffraction pattern center.</span>
</span><span id="CenterRefinement-3209"><a href="#CenterRefinement-3209"><span class="linenos">3209</span></a><span class="sd">      </span>
</span><span id="CenterRefinement-3210"><a href="#CenterRefinement-3210"><span class="linenos">3210</span></a><span class="sd">        This method allows the user to fine-tune the estimated center</span>
</span><span id="CenterRefinement-3211"><a href="#CenterRefinement-3211"><span class="linenos">3211</span></a><span class="sd">        and radius of a diffraction ring through interactive keyboard controls.</span>
</span><span id="CenterRefinement-3212"><a href="#CenterRefinement-3212"><span class="linenos">3212</span></a><span class="sd">      </span>
</span><span id="CenterRefinement-3213"><a href="#CenterRefinement-3213"><span class="linenos">3213</span></a><span class="sd">        An new window is opened and the user can adjust the position</span>
</span><span id="CenterRefinement-3214"><a href="#CenterRefinement-3214"><span class="linenos">3214</span></a><span class="sd">        of the diffraction ring using the following keys (keyboard controls):</span>
</span><span id="CenterRefinement-3215"><a href="#CenterRefinement-3215"><span class="linenos">3215</span></a><span class="sd">        - Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</span>
</span><span id="CenterRefinement-3216"><a href="#CenterRefinement-3216"><span class="linenos">3216</span></a><span class="sd">        - &#39;+&#39; : Increase the radius</span>
</span><span id="CenterRefinement-3217"><a href="#CenterRefinement-3217"><span class="linenos">3217</span></a><span class="sd">        - &#39;-&#39; : Decrease the radius</span>
</span><span id="CenterRefinement-3218"><a href="#CenterRefinement-3218"><span class="linenos">3218</span></a><span class="sd">        - &#39;b&#39; : Increase step size (×5)</span>
</span><span id="CenterRefinement-3219"><a href="#CenterRefinement-3219"><span class="linenos">3219</span></a><span class="sd">        - &#39;l&#39; : Decrease step size (/5, with minimum step size 0.5)</span>
</span><span id="CenterRefinement-3220"><a href="#CenterRefinement-3220"><span class="linenos">3220</span></a><span class="sd">        - &#39;d&#39; : Done — finalize the center and radius</span>
</span><span id="CenterRefinement-3221"><a href="#CenterRefinement-3221"><span class="linenos">3221</span></a><span class="sd">        - Closing the figure: Cancels refinement and returns the original input </span>
</span><span id="CenterRefinement-3222"><a href="#CenterRefinement-3222"><span class="linenos">3222</span></a><span class="sd">          center and radius</span>
</span><span id="CenterRefinement-3223"><a href="#CenterRefinement-3223"><span class="linenos">3223</span></a><span class="sd">      </span>
</span><span id="CenterRefinement-3224"><a href="#CenterRefinement-3224"><span class="linenos">3224</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement-3225"><a href="#CenterRefinement-3225"><span class="linenos">3225</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement-3226"><a href="#CenterRefinement-3226"><span class="linenos">3226</span></a><span class="sd">        fig : matplotlib.figure.Figure</span>
</span><span id="CenterRefinement-3227"><a href="#CenterRefinement-3227"><span class="linenos">3227</span></a><span class="sd">            The figure window used for interactive refinement.</span>
</span><span id="CenterRefinement-3228"><a href="#CenterRefinement-3228"><span class="linenos">3228</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3229"><a href="#CenterRefinement-3229"><span class="linenos">3229</span></a><span class="sd">        circle : matplotlib.patches.Circle</span>
</span><span id="CenterRefinement-3230"><a href="#CenterRefinement-3230"><span class="linenos">3230</span></a><span class="sd">            The circle object known from</span>
</span><span id="CenterRefinement-3231"><a href="#CenterRefinement-3231"><span class="linenos">3231</span></a><span class="sd">            the previous step = from the center determination.</span>
</span><span id="CenterRefinement-3232"><a href="#CenterRefinement-3232"><span class="linenos">3232</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3233"><a href="#CenterRefinement-3233"><span class="linenos">3233</span></a><span class="sd">        center : tuple</span>
</span><span id="CenterRefinement-3234"><a href="#CenterRefinement-3234"><span class="linenos">3234</span></a><span class="sd">            The initial (x, y) center coordinates from</span>
</span><span id="CenterRefinement-3235"><a href="#CenterRefinement-3235"><span class="linenos">3235</span></a><span class="sd">            the previous step = from the center determination.</span>
</span><span id="CenterRefinement-3236"><a href="#CenterRefinement-3236"><span class="linenos">3236</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3237"><a href="#CenterRefinement-3237"><span class="linenos">3237</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="CenterRefinement-3238"><a href="#CenterRefinement-3238"><span class="linenos">3238</span></a><span class="sd">            If True, the results of the adjustment are visualized.</span>
</span><span id="CenterRefinement-3239"><a href="#CenterRefinement-3239"><span class="linenos">3239</span></a><span class="sd">      </span>
</span><span id="CenterRefinement-3240"><a href="#CenterRefinement-3240"><span class="linenos">3240</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement-3241"><a href="#CenterRefinement-3241"><span class="linenos">3241</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement-3242"><a href="#CenterRefinement-3242"><span class="linenos">3242</span></a><span class="sd">        xy[0] : float</span>
</span><span id="CenterRefinement-3243"><a href="#CenterRefinement-3243"><span class="linenos">3243</span></a><span class="sd">            x-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterRefinement-3244"><a href="#CenterRefinement-3244"><span class="linenos">3244</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3245"><a href="#CenterRefinement-3245"><span class="linenos">3245</span></a><span class="sd">        xy[1] : float</span>
</span><span id="CenterRefinement-3246"><a href="#CenterRefinement-3246"><span class="linenos">3246</span></a><span class="sd">            y-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterRefinement-3247"><a href="#CenterRefinement-3247"><span class="linenos">3247</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3248"><a href="#CenterRefinement-3248"><span class="linenos">3248</span></a><span class="sd">        r : float</span>
</span><span id="CenterRefinement-3249"><a href="#CenterRefinement-3249"><span class="linenos">3249</span></a><span class="sd">            Adjusted radius of the diffraction ring.</span>
</span><span id="CenterRefinement-3250"><a href="#CenterRefinement-3250"><span class="linenos">3250</span></a><span class="sd">      </span>
</span><span id="CenterRefinement-3251"><a href="#CenterRefinement-3251"><span class="linenos">3251</span></a><span class="sd">        Notes</span>
</span><span id="CenterRefinement-3252"><a href="#CenterRefinement-3252"><span class="linenos">3252</span></a><span class="sd">        -----</span>
</span><span id="CenterRefinement-3253"><a href="#CenterRefinement-3253"><span class="linenos">3253</span></a><span class="sd">        - Interactive adjustments are visualized in real time.</span>
</span><span id="CenterRefinement-3254"><a href="#CenterRefinement-3254"><span class="linenos">3254</span></a><span class="sd">        - Intensity sum at the current center/radius is printed</span>
</span><span id="CenterRefinement-3255"><a href="#CenterRefinement-3255"><span class="linenos">3255</span></a><span class="sd">          if *print_sums* argument is True.</span>
</span><span id="CenterRefinement-3256"><a href="#CenterRefinement-3256"><span class="linenos">3256</span></a><span class="sd">        - Arrow key defaults in Matplotlib (e.g., navigation)</span>
</span><span id="CenterRefinement-3257"><a href="#CenterRefinement-3257"><span class="linenos">3257</span></a><span class="sd">          are temporarily disabled to allow movement control.</span>
</span><span id="CenterRefinement-3258"><a href="#CenterRefinement-3258"><span class="linenos">3258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3259"><a href="#CenterRefinement-3259"><span class="linenos">3259</span></a>             
</span><span id="CenterRefinement-3260"><a href="#CenterRefinement-3260"><span class="linenos">3260</span></a>        <span class="c1"># (0) Load original image ---------------------------------------------</span>
</span><span id="CenterRefinement-3261"><a href="#CenterRefinement-3261"><span class="linenos">3261</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterRefinement-3262"><a href="#CenterRefinement-3262"><span class="linenos">3262</span></a>
</span><span id="CenterRefinement-3263"><a href="#CenterRefinement-3263"><span class="linenos">3263</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterRefinement-3264"><a href="#CenterRefinement-3264"><span class="linenos">3264</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterRefinement-3265"><a href="#CenterRefinement-3265"><span class="linenos">3265</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterRefinement-3266"><a href="#CenterRefinement-3266"><span class="linenos">3266</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3267"><a href="#CenterRefinement-3267"><span class="linenos">3267</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement-3268"><a href="#CenterRefinement-3268"><span class="linenos">3268</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement-3269"><a href="#CenterRefinement-3269"><span class="linenos">3269</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterRefinement-3270"><a href="#CenterRefinement-3270"><span class="linenos">3270</span></a>            
</span><span id="CenterRefinement-3271"><a href="#CenterRefinement-3271"><span class="linenos">3271</span></a>        <span class="c1"># (1) Initialize variables and flags ----------------------------------</span>
</span><span id="CenterRefinement-3272"><a href="#CenterRefinement-3272"><span class="linenos">3272</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement-3273"><a href="#CenterRefinement-3273"><span class="linenos">3273</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3274"><a href="#CenterRefinement-3274"><span class="linenos">3274</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterRefinement-3275"><a href="#CenterRefinement-3275"><span class="linenos">3275</span></a>
</span><span id="CenterRefinement-3276"><a href="#CenterRefinement-3276"><span class="linenos">3276</span></a>        <span class="c1"># (2) User information ------------------------------------------------</span>
</span><span id="CenterRefinement-3277"><a href="#CenterRefinement-3277"><span class="linenos">3277</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement-3278"><a href="#CenterRefinement-3278"><span class="linenos">3278</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3279"><a href="#CenterRefinement-3279"><span class="linenos">3279</span></a><span class="s2">            </span>
</span><span id="CenterRefinement-3280"><a href="#CenterRefinement-3280"><span class="linenos">3280</span></a><span class="s2">            Interactive refinement. Use these keys:</span>
</span><span id="CenterRefinement-3281"><a href="#CenterRefinement-3281"><span class="linenos">3281</span></a><span class="s2">                  - &#39;←&#39; : move left</span>
</span><span id="CenterRefinement-3282"><a href="#CenterRefinement-3282"><span class="linenos">3282</span></a><span class="s2">                  - &#39;→&#39; : move right</span>
</span><span id="CenterRefinement-3283"><a href="#CenterRefinement-3283"><span class="linenos">3283</span></a><span class="s2">                  - &#39;↑&#39; : move up</span>
</span><span id="CenterRefinement-3284"><a href="#CenterRefinement-3284"><span class="linenos">3284</span></a><span class="s2">                  - &#39;↓&#39; : move down</span>
</span><span id="CenterRefinement-3285"><a href="#CenterRefinement-3285"><span class="linenos">3285</span></a><span class="s2">                  - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterRefinement-3286"><a href="#CenterRefinement-3286"><span class="linenos">3286</span></a><span class="s2">                  - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterRefinement-3287"><a href="#CenterRefinement-3287"><span class="linenos">3287</span></a><span class="s2">                  - &#39;b&#39; : increase step size</span>
</span><span id="CenterRefinement-3288"><a href="#CenterRefinement-3288"><span class="linenos">3288</span></a><span class="s2">                  - &#39;l&#39; : decrease step size</span>
</span><span id="CenterRefinement-3289"><a href="#CenterRefinement-3289"><span class="linenos">3289</span></a><span class="s2">                  - &#39;d&#39; : refinement done</span>
</span><span id="CenterRefinement-3290"><a href="#CenterRefinement-3290"><span class="linenos">3290</span></a><span class="s2">                  </span>
</span><span id="CenterRefinement-3291"><a href="#CenterRefinement-3291"><span class="linenos">3291</span></a><span class="s2">            DISCLAIMER: For the purpose of the center shift, the default</span>
</span><span id="CenterRefinement-3292"><a href="#CenterRefinement-3292"><span class="linenos">3292</span></a><span class="s2">            shortcuts for left and right arrows were removed.</span>
</span><span id="CenterRefinement-3293"><a href="#CenterRefinement-3293"><span class="linenos">3293</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3294"><a href="#CenterRefinement-3294"><span class="linenos">3294</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterRefinement-3295"><a href="#CenterRefinement-3295"><span class="linenos">3295</span></a>        
</span><span id="CenterRefinement-3296"><a href="#CenterRefinement-3296"><span class="linenos">3296</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement-3297"><a href="#CenterRefinement-3297"><span class="linenos">3297</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3298"><a href="#CenterRefinement-3298"><span class="linenos">3298</span></a>            
</span><span id="CenterRefinement-3299"><a href="#CenterRefinement-3299"><span class="linenos">3299</span></a>        <span class="c1"># (3) Create a figure and display the image ---------------------------</span>
</span><span id="CenterRefinement-3300"><a href="#CenterRefinement-3300"><span class="linenos">3300</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="CenterRefinement-3301"><a href="#CenterRefinement-3301"><span class="linenos">3301</span></a>        
</span><span id="CenterRefinement-3302"><a href="#CenterRefinement-3302"><span class="linenos">3302</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterRefinement-3303"><a href="#CenterRefinement-3303"><span class="linenos">3303</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-3304"><a href="#CenterRefinement-3304"><span class="linenos">3304</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-3305"><a href="#CenterRefinement-3305"><span class="linenos">3305</span></a>        
</span><span id="CenterRefinement-3306"><a href="#CenterRefinement-3306"><span class="linenos">3306</span></a>        <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterRefinement-3307"><a href="#CenterRefinement-3307"><span class="linenos">3307</span></a>            <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">pr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement-3308"><a href="#CenterRefinement-3308"><span class="linenos">3308</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterRefinement-3309"><a href="#CenterRefinement-3309"><span class="linenos">3309</span></a>
</span><span id="CenterRefinement-3310"><a href="#CenterRefinement-3310"><span class="linenos">3310</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterRefinement-3311"><a href="#CenterRefinement-3311"><span class="linenos">3311</span></a>        <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterRefinement-3312"><a href="#CenterRefinement-3312"><span class="linenos">3312</span></a>                    
</span><span id="CenterRefinement-3313"><a href="#CenterRefinement-3313"><span class="linenos">3313</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the center position.&#39;</span><span class="p">,</span> 
</span><span id="CenterRefinement-3314"><a href="#CenterRefinement-3314"><span class="linenos">3314</span></a>                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement-3315"><a href="#CenterRefinement-3315"><span class="linenos">3315</span></a>
</span><span id="CenterRefinement-3316"><a href="#CenterRefinement-3316"><span class="linenos">3316</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3317"><a href="#CenterRefinement-3317"><span class="linenos">3317</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-3318"><a href="#CenterRefinement-3318"><span class="linenos">3318</span></a>        
</span><span id="CenterRefinement-3319"><a href="#CenterRefinement-3319"><span class="linenos">3319</span></a>        <span class="c1"># (4) Enable interactive mode -----------------------------------------</span>
</span><span id="CenterRefinement-3320"><a href="#CenterRefinement-3320"><span class="linenos">3320</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterRefinement-3321"><a href="#CenterRefinement-3321"><span class="linenos">3321</span></a>        
</span><span id="CenterRefinement-3322"><a href="#CenterRefinement-3322"><span class="linenos">3322</span></a>
</span><span id="CenterRefinement-3323"><a href="#CenterRefinement-3323"><span class="linenos">3323</span></a>        <span class="c1"># (5) Display the image -----------------------------------------------</span>
</span><span id="CenterRefinement-3324"><a href="#CenterRefinement-3324"><span class="linenos">3324</span></a>        <span class="c1"># fig.set_size_inches(self.fig_width, self.fig_height)</span>
</span><span id="CenterRefinement-3325"><a href="#CenterRefinement-3325"><span class="linenos">3325</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement-3326"><a href="#CenterRefinement-3326"><span class="linenos">3326</span></a>        
</span><span id="CenterRefinement-3327"><a href="#CenterRefinement-3327"><span class="linenos">3327</span></a>        <span class="c1"># (6) Define the event handler for figure close event -----------------</span>
</span><span id="CenterRefinement-3328"><a href="#CenterRefinement-3328"><span class="linenos">3328</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement-3329"><a href="#CenterRefinement-3329"><span class="linenos">3329</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement-3330"><a href="#CenterRefinement-3330"><span class="linenos">3330</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement-3331"><a href="#CenterRefinement-3331"><span class="linenos">3331</span></a> 
</span><span id="CenterRefinement-3332"><a href="#CenterRefinement-3332"><span class="linenos">3332</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterRefinement-3333"><a href="#CenterRefinement-3333"><span class="linenos">3333</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterRefinement-3334"><a href="#CenterRefinement-3334"><span class="linenos">3334</span></a>
</span><span id="CenterRefinement-3335"><a href="#CenterRefinement-3335"><span class="linenos">3335</span></a>        <span class="c1"># (7) Define the callback function for key press events ---------------</span>
</span><span id="CenterRefinement-3336"><a href="#CenterRefinement-3336"><span class="linenos">3336</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement-3337"><a href="#CenterRefinement-3337"><span class="linenos">3337</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterRefinement-3338"><a href="#CenterRefinement-3338"><span class="linenos">3338</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement-3339"><a href="#CenterRefinement-3339"><span class="linenos">3339</span></a>        
</span><span id="CenterRefinement-3340"><a href="#CenterRefinement-3340"><span class="linenos">3340</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterRefinement-3341"><a href="#CenterRefinement-3341"><span class="linenos">3341</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterRefinement-3342"><a href="#CenterRefinement-3342"><span class="linenos">3342</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterRefinement-3343"><a href="#CenterRefinement-3343"><span class="linenos">3343</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterRefinement-3344"><a href="#CenterRefinement-3344"><span class="linenos">3344</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterRefinement-3345"><a href="#CenterRefinement-3345"><span class="linenos">3345</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterRefinement-3346"><a href="#CenterRefinement-3346"><span class="linenos">3346</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterRefinement-3347"><a href="#CenterRefinement-3347"><span class="linenos">3347</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterRefinement-3348"><a href="#CenterRefinement-3348"><span class="linenos">3348</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterRefinement-3349"><a href="#CenterRefinement-3349"><span class="linenos">3349</span></a>        
</span><span id="CenterRefinement-3350"><a href="#CenterRefinement-3350"><span class="linenos">3350</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterRefinement-3351"><a href="#CenterRefinement-3351"><span class="linenos">3351</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterRefinement-3352"><a href="#CenterRefinement-3352"><span class="linenos">3352</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterRefinement-3353"><a href="#CenterRefinement-3353"><span class="linenos">3353</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement-3354"><a href="#CenterRefinement-3354"><span class="linenos">3354</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterRefinement-3355"><a href="#CenterRefinement-3355"><span class="linenos">3355</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3356"><a href="#CenterRefinement-3356"><span class="linenos">3356</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-3357"><a href="#CenterRefinement-3357"><span class="linenos">3357</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3358"><a href="#CenterRefinement-3358"><span class="linenos">3358</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-3359"><a href="#CenterRefinement-3359"><span class="linenos">3359</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3360"><a href="#CenterRefinement-3360"><span class="linenos">3360</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-3361"><a href="#CenterRefinement-3361"><span class="linenos">3361</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3362"><a href="#CenterRefinement-3362"><span class="linenos">3362</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-3363"><a href="#CenterRefinement-3363"><span class="linenos">3363</span></a>                    
</span><span id="CenterRefinement-3364"><a href="#CenterRefinement-3364"><span class="linenos">3364</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterRefinement-3365"><a href="#CenterRefinement-3365"><span class="linenos">3365</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement-3366"><a href="#CenterRefinement-3366"><span class="linenos">3366</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterRefinement-3367"><a href="#CenterRefinement-3367"><span class="linenos">3367</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-3368"><a href="#CenterRefinement-3368"><span class="linenos">3368</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-3369"><a href="#CenterRefinement-3369"><span class="linenos">3369</span></a>            
</span><span id="CenterRefinement-3370"><a href="#CenterRefinement-3370"><span class="linenos">3370</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterRefinement-3371"><a href="#CenterRefinement-3371"><span class="linenos">3371</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3372"><a href="#CenterRefinement-3372"><span class="linenos">3372</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement-3373"><a href="#CenterRefinement-3373"><span class="linenos">3373</span></a>        
</span><span id="CenterRefinement-3374"><a href="#CenterRefinement-3374"><span class="linenos">3374</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterRefinement-3375"><a href="#CenterRefinement-3375"><span class="linenos">3375</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3376"><a href="#CenterRefinement-3376"><span class="linenos">3376</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterRefinement-3377"><a href="#CenterRefinement-3377"><span class="linenos">3377</span></a>        
</span><span id="CenterRefinement-3378"><a href="#CenterRefinement-3378"><span class="linenos">3378</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-3379"><a href="#CenterRefinement-3379"><span class="linenos">3379</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterRefinement-3380"><a href="#CenterRefinement-3380"><span class="linenos">3380</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterRefinement-3381"><a href="#CenterRefinement-3381"><span class="linenos">3381</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterRefinement-3382"><a href="#CenterRefinement-3382"><span class="linenos">3382</span></a>        
</span><span id="CenterRefinement-3383"><a href="#CenterRefinement-3383"><span class="linenos">3383</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterRefinement-3384"><a href="#CenterRefinement-3384"><span class="linenos">3384</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterRefinement-3385"><a href="#CenterRefinement-3385"><span class="linenos">3385</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterRefinement-3386"><a href="#CenterRefinement-3386"><span class="linenos">3386</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterRefinement-3387"><a href="#CenterRefinement-3387"><span class="linenos">3387</span></a>        
</span><span id="CenterRefinement-3388"><a href="#CenterRefinement-3388"><span class="linenos">3388</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement-3389"><a href="#CenterRefinement-3389"><span class="linenos">3389</span></a>        
</span><span id="CenterRefinement-3390"><a href="#CenterRefinement-3390"><span class="linenos">3390</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterRefinement-3391"><a href="#CenterRefinement-3391"><span class="linenos">3391</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterRefinement-3392"><a href="#CenterRefinement-3392"><span class="linenos">3392</span></a>
</span><span id="CenterRefinement-3393"><a href="#CenterRefinement-3393"><span class="linenos">3393</span></a>            
</span><span id="CenterRefinement-3394"><a href="#CenterRefinement-3394"><span class="linenos">3394</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterRefinement-3395"><a href="#CenterRefinement-3395"><span class="linenos">3395</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterRefinement-3396"><a href="#CenterRefinement-3396"><span class="linenos">3396</span></a>        
</span><span id="CenterRefinement-3397"><a href="#CenterRefinement-3397"><span class="linenos">3397</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterRefinement-3398"><a href="#CenterRefinement-3398"><span class="linenos">3398</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterRefinement-3399"><a href="#CenterRefinement-3399"><span class="linenos">3399</span></a>
</span><span id="CenterRefinement-3400"><a href="#CenterRefinement-3400"><span class="linenos">3400</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterRefinement-3401"><a href="#CenterRefinement-3401"><span class="linenos">3401</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterRefinement-3402"><a href="#CenterRefinement-3402"><span class="linenos">3402</span></a>               
</span><span id="CenterRefinement-3403"><a href="#CenterRefinement-3403"><span class="linenos">3403</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterRefinement-3404"><a href="#CenterRefinement-3404"><span class="linenos">3404</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterRefinement-3405"><a href="#CenterRefinement-3405"><span class="linenos">3405</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterRefinement-3406"><a href="#CenterRefinement-3406"><span class="linenos">3406</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterRefinement-3407"><a href="#CenterRefinement-3407"><span class="linenos">3407</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterRefinement-3408"><a href="#CenterRefinement-3408"><span class="linenos">3408</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterRefinement-3409"><a href="#CenterRefinement-3409"><span class="linenos">3409</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement-3410"><a href="#CenterRefinement-3410"><span class="linenos">3410</span></a>         
</span><span id="CenterRefinement-3411"><a href="#CenterRefinement-3411"><span class="linenos">3411</span></a>        <span class="c1"># (8) Turn off interactive mode ---------------------------------------</span>
</span><span id="CenterRefinement-3412"><a href="#CenterRefinement-3412"><span class="linenos">3412</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterRefinement-3413"><a href="#CenterRefinement-3413"><span class="linenos">3413</span></a>        
</span><span id="CenterRefinement-3414"><a href="#CenterRefinement-3414"><span class="linenos">3414</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterRefinement-3415"><a href="#CenterRefinement-3415"><span class="linenos">3415</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterRefinement-3416"><a href="#CenterRefinement-3416"><span class="linenos">3416</span></a>
</span><span id="CenterRefinement-3417"><a href="#CenterRefinement-3417"><span class="linenos">3417</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement-3418"><a href="#CenterRefinement-3418"><span class="linenos">3418</span></a>        
</span><span id="CenterRefinement-3419"><a href="#CenterRefinement-3419"><span class="linenos">3419</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterRefinement-3420"><a href="#CenterRefinement-3420"><span class="linenos">3420</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterRefinement-3421"><a href="#CenterRefinement-3421"><span class="linenos">3421</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterRefinement-3422"><a href="#CenterRefinement-3422"><span class="linenos">3422</span></a>
</span><span id="CenterRefinement-3423"><a href="#CenterRefinement-3423"><span class="linenos">3423</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterRefinement-3424"><a href="#CenterRefinement-3424"><span class="linenos">3424</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-3425"><a href="#CenterRefinement-3425"><span class="linenos">3425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-3426"><a href="#CenterRefinement-3426"><span class="linenos">3426</span></a>
</span><span id="CenterRefinement-3427"><a href="#CenterRefinement-3427"><span class="linenos">3427</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>    
</span><span id="CenterRefinement-3428"><a href="#CenterRefinement-3428"><span class="linenos">3428</span></a>        
</span><span id="CenterRefinement-3429"><a href="#CenterRefinement-3429"><span class="linenos">3429</span></a>    
</span><span id="CenterRefinement-3430"><a href="#CenterRefinement-3430"><span class="linenos">3430</span></a>    <span class="k">def</span> <span class="nf">ref_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterRefinement-3431"><a href="#CenterRefinement-3431"><span class="linenos">3431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3432"><a href="#CenterRefinement-3432"><span class="linenos">3432</span></a><span class="sd">        Refine the center coordinates (px, py) and radius (pr) of a circular </span>
</span><span id="CenterRefinement-3433"><a href="#CenterRefinement-3433"><span class="linenos">3433</span></a><span class="sd">        diffraction pattern by minimizing the variance of pixel intensities </span>
</span><span id="CenterRefinement-3434"><a href="#CenterRefinement-3434"><span class="linenos">3434</span></a><span class="sd">        along the circle&#39;s border.</span>
</span><span id="CenterRefinement-3435"><a href="#CenterRefinement-3435"><span class="linenos">3435</span></a>
</span><span id="CenterRefinement-3436"><a href="#CenterRefinement-3436"><span class="linenos">3436</span></a><span class="sd">        This method performs iterative local search in the 8-neighbourhood </span>
</span><span id="CenterRefinement-3437"><a href="#CenterRefinement-3437"><span class="linenos">3437</span></a><span class="sd">        around the current center to find a position and radius that minimize </span>
</span><span id="CenterRefinement-3438"><a href="#CenterRefinement-3438"><span class="linenos">3438</span></a><span class="sd">        the intensity variance. The refinement stops when convergence criteria </span>
</span><span id="CenterRefinement-3439"><a href="#CenterRefinement-3439"><span class="linenos">3439</span></a><span class="sd">        are met or after a maximum number of iterations.</span>
</span><span id="CenterRefinement-3440"><a href="#CenterRefinement-3440"><span class="linenos">3440</span></a>
</span><span id="CenterRefinement-3441"><a href="#CenterRefinement-3441"><span class="linenos">3441</span></a><span class="sd">        Neighborhood pattern tested (o = current center, x = candidate center):</span>
</span><span id="CenterRefinement-3442"><a href="#CenterRefinement-3442"><span class="linenos">3442</span></a><span class="sd">            x x x   --&gt; (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)</span>
</span><span id="CenterRefinement-3443"><a href="#CenterRefinement-3443"><span class="linenos">3443</span></a><span class="sd">            x o x   --&gt; (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement-3444"><a href="#CenterRefinement-3444"><span class="linenos">3444</span></a><span class="sd">            x x x   --&gt; (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement-3445"><a href="#CenterRefinement-3445"><span class="linenos">3445</span></a>
</span><span id="CenterRefinement-3446"><a href="#CenterRefinement-3446"><span class="linenos">3446</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement-3447"><a href="#CenterRefinement-3447"><span class="linenos">3447</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement-3448"><a href="#CenterRefinement-3448"><span class="linenos">3448</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement-3449"><a href="#CenterRefinement-3449"><span class="linenos">3449</span></a><span class="sd">            Initial x-coordinate of the detected center.</span>
</span><span id="CenterRefinement-3450"><a href="#CenterRefinement-3450"><span class="linenos">3450</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3451"><a href="#CenterRefinement-3451"><span class="linenos">3451</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement-3452"><a href="#CenterRefinement-3452"><span class="linenos">3452</span></a><span class="sd">            Initial y-coordinate of the detected center.</span>
</span><span id="CenterRefinement-3453"><a href="#CenterRefinement-3453"><span class="linenos">3453</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3454"><a href="#CenterRefinement-3454"><span class="linenos">3454</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement-3455"><a href="#CenterRefinement-3455"><span class="linenos">3455</span></a><span class="sd">            Initial radius of the detected circular pattern.</span>
</span><span id="CenterRefinement-3456"><a href="#CenterRefinement-3456"><span class="linenos">3456</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3457"><a href="#CenterRefinement-3457"><span class="linenos">3457</span></a><span class="sd">        plot_results : int, optional (default=0)</span>
</span><span id="CenterRefinement-3458"><a href="#CenterRefinement-3458"><span class="linenos">3458</span></a><span class="sd">            Whether to plot the refinement result (1 = yes, 0 = no).</span>
</span><span id="CenterRefinement-3459"><a href="#CenterRefinement-3459"><span class="linenos">3459</span></a>
</span><span id="CenterRefinement-3460"><a href="#CenterRefinement-3460"><span class="linenos">3460</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement-3461"><a href="#CenterRefinement-3461"><span class="linenos">3461</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement-3462"><a href="#CenterRefinement-3462"><span class="linenos">3462</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement-3463"><a href="#CenterRefinement-3463"><span class="linenos">3463</span></a><span class="sd">            Refined x-coordinate of the center.</span>
</span><span id="CenterRefinement-3464"><a href="#CenterRefinement-3464"><span class="linenos">3464</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3465"><a href="#CenterRefinement-3465"><span class="linenos">3465</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement-3466"><a href="#CenterRefinement-3466"><span class="linenos">3466</span></a><span class="sd">            Refined y-coordinate of the center.</span>
</span><span id="CenterRefinement-3467"><a href="#CenterRefinement-3467"><span class="linenos">3467</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3468"><a href="#CenterRefinement-3468"><span class="linenos">3468</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement-3469"><a href="#CenterRefinement-3469"><span class="linenos">3469</span></a><span class="sd">            Refined radius of the circular pattern.</span>
</span><span id="CenterRefinement-3470"><a href="#CenterRefinement-3470"><span class="linenos">3470</span></a>
</span><span id="CenterRefinement-3471"><a href="#CenterRefinement-3471"><span class="linenos">3471</span></a><span class="sd">        Notes</span>
</span><span id="CenterRefinement-3472"><a href="#CenterRefinement-3472"><span class="linenos">3472</span></a><span class="sd">        -----</span>
</span><span id="CenterRefinement-3473"><a href="#CenterRefinement-3473"><span class="linenos">3473</span></a><span class="sd">        - The function avoids overfitting to local minima by enforcing </span>
</span><span id="CenterRefinement-3474"><a href="#CenterRefinement-3474"><span class="linenos">3474</span></a><span class="sd">          convergence thresholds and consistency checks.</span>
</span><span id="CenterRefinement-3475"><a href="#CenterRefinement-3475"><span class="linenos">3475</span></a><span class="sd">        - If the refinement worsens the initial variance significantly or </span>
</span><span id="CenterRefinement-3476"><a href="#CenterRefinement-3476"><span class="linenos">3476</span></a><span class="sd">          suggests an invalid coordinate swap, the original input is preserved.</span>
</span><span id="CenterRefinement-3477"><a href="#CenterRefinement-3477"><span class="linenos">3477</span></a><span class="sd">        - Uses `self.parent.intensity_variance()` for evaluating the criterion.</span>
</span><span id="CenterRefinement-3478"><a href="#CenterRefinement-3478"><span class="linenos">3478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3479"><a href="#CenterRefinement-3479"><span class="linenos">3479</span></a>        
</span><span id="CenterRefinement-3480"><a href="#CenterRefinement-3480"><span class="linenos">3480</span></a>        <span class="c1"># Store input for plot</span>
</span><span id="CenterRefinement-3481"><a href="#CenterRefinement-3481"><span class="linenos">3481</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement-3482"><a href="#CenterRefinement-3482"><span class="linenos">3482</span></a>        
</span><span id="CenterRefinement-3483"><a href="#CenterRefinement-3483"><span class="linenos">3483</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterRefinement-3484"><a href="#CenterRefinement-3484"><span class="linenos">3484</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement-3485"><a href="#CenterRefinement-3485"><span class="linenos">3485</span></a>
</span><span id="CenterRefinement-3486"><a href="#CenterRefinement-3486"><span class="linenos">3486</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement-3487"><a href="#CenterRefinement-3487"><span class="linenos">3487</span></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3488"><a href="#CenterRefinement-3488"><span class="linenos">3488</span></a>        <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3489"><a href="#CenterRefinement-3489"><span class="linenos">3489</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement-3490"><a href="#CenterRefinement-3490"><span class="linenos">3490</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3491"><a href="#CenterRefinement-3491"><span class="linenos">3491</span></a>    
</span><span id="CenterRefinement-3492"><a href="#CenterRefinement-3492"><span class="linenos">3492</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement-3493"><a href="#CenterRefinement-3493"><span class="linenos">3493</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement-3494"><a href="#CenterRefinement-3494"><span class="linenos">3494</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement-3495"><a href="#CenterRefinement-3495"><span class="linenos">3495</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">min_intensity_var</span>
</span><span id="CenterRefinement-3496"><a href="#CenterRefinement-3496"><span class="linenos">3496</span></a>        
</span><span id="CenterRefinement-3497"><a href="#CenterRefinement-3497"><span class="linenos">3497</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement-3498"><a href="#CenterRefinement-3498"><span class="linenos">3498</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="CenterRefinement-3499"><a href="#CenterRefinement-3499"><span class="linenos">3499</span></a>        
</span><span id="CenterRefinement-3500"><a href="#CenterRefinement-3500"><span class="linenos">3500</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement-3501"><a href="#CenterRefinement-3501"><span class="linenos">3501</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement-3502"><a href="#CenterRefinement-3502"><span class="linenos">3502</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement-3503"><a href="#CenterRefinement-3503"><span class="linenos">3503</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement-3504"><a href="#CenterRefinement-3504"><span class="linenos">3504</span></a>    
</span><span id="CenterRefinement-3505"><a href="#CenterRefinement-3505"><span class="linenos">3505</span></a>    
</span><span id="CenterRefinement-3506"><a href="#CenterRefinement-3506"><span class="linenos">3506</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement-3507"><a href="#CenterRefinement-3507"><span class="linenos">3507</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement-3508"><a href="#CenterRefinement-3508"><span class="linenos">3508</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="CenterRefinement-3509"><a href="#CenterRefinement-3509"><span class="linenos">3509</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement-3510"><a href="#CenterRefinement-3510"><span class="linenos">3510</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-3511"><a href="#CenterRefinement-3511"><span class="linenos">3511</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement-3512"><a href="#CenterRefinement-3512"><span class="linenos">3512</span></a>        
</span><span id="CenterRefinement-3513"><a href="#CenterRefinement-3513"><span class="linenos">3513</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement-3514"><a href="#CenterRefinement-3514"><span class="linenos">3514</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement-3515"><a href="#CenterRefinement-3515"><span class="linenos">3515</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3516"><a href="#CenterRefinement-3516"><span class="linenos">3516</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-3517"><a href="#CenterRefinement-3517"><span class="linenos">3517</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-3518"><a href="#CenterRefinement-3518"><span class="linenos">3518</span></a>                                      <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement-3519"><a href="#CenterRefinement-3519"><span class="linenos">3519</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement-3520"><a href="#CenterRefinement-3520"><span class="linenos">3520</span></a>            <span class="n">curr_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-3521"><a href="#CenterRefinement-3521"><span class="linenos">3521</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement-3522"><a href="#CenterRefinement-3522"><span class="linenos">3522</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement-3523"><a href="#CenterRefinement-3523"><span class="linenos">3523</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement-3524"><a href="#CenterRefinement-3524"><span class="linenos">3524</span></a>                <span class="n">curr_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="CenterRefinement-3525"><a href="#CenterRefinement-3525"><span class="linenos">3525</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-3526"><a href="#CenterRefinement-3526"><span class="linenos">3526</span></a>            
</span><span id="CenterRefinement-3527"><a href="#CenterRefinement-3527"><span class="linenos">3527</span></a>            <span class="c1"># Find the minimum value coordinates within curr_intensity_var</span>
</span><span id="CenterRefinement-3528"><a href="#CenterRefinement-3528"><span class="linenos">3528</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement-3529"><a href="#CenterRefinement-3529"><span class="linenos">3529</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-3530"><a href="#CenterRefinement-3530"><span class="linenos">3530</span></a>                    
</span><span id="CenterRefinement-3531"><a href="#CenterRefinement-3531"><span class="linenos">3531</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="CenterRefinement-3532"><a href="#CenterRefinement-3532"><span class="linenos">3532</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="CenterRefinement-3533"><a href="#CenterRefinement-3533"><span class="linenos">3533</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement-3534"><a href="#CenterRefinement-3534"><span class="linenos">3534</span></a>            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_intensity_var</span><span class="p">:</span>                           
</span><span id="CenterRefinement-3535"><a href="#CenterRefinement-3535"><span class="linenos">3535</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement-3536"><a href="#CenterRefinement-3536"><span class="linenos">3536</span></a>                
</span><span id="CenterRefinement-3537"><a href="#CenterRefinement-3537"><span class="linenos">3537</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement-3538"><a href="#CenterRefinement-3538"><span class="linenos">3538</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement-3539"><a href="#CenterRefinement-3539"><span class="linenos">3539</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement-3540"><a href="#CenterRefinement-3540"><span class="linenos">3540</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement-3541"><a href="#CenterRefinement-3541"><span class="linenos">3541</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement-3542"><a href="#CenterRefinement-3542"><span class="linenos">3542</span></a>                
</span><span id="CenterRefinement-3543"><a href="#CenterRefinement-3543"><span class="linenos">3543</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement-3544"><a href="#CenterRefinement-3544"><span class="linenos">3544</span></a>            <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3545"><a href="#CenterRefinement-3545"><span class="linenos">3545</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-3546"><a href="#CenterRefinement-3546"><span class="linenos">3546</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-3547"><a href="#CenterRefinement-3547"><span class="linenos">3547</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement-3548"><a href="#CenterRefinement-3548"><span class="linenos">3548</span></a>            
</span><span id="CenterRefinement-3549"><a href="#CenterRefinement-3549"><span class="linenos">3549</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement-3550"><a href="#CenterRefinement-3550"><span class="linenos">3550</span></a>            <span class="c1"># constant. It iterates through different radius adjustments</span>
</span><span id="CenterRefinement-3551"><a href="#CenterRefinement-3551"><span class="linenos">3551</span></a>            <span class="c1"># to find a radius that maximizes the intensity sum of pixels.</span>
</span><span id="CenterRefinement-3552"><a href="#CenterRefinement-3552"><span class="linenos">3552</span></a>            
</span><span id="CenterRefinement-3553"><a href="#CenterRefinement-3553"><span class="linenos">3553</span></a>            <span class="n">radi_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-3554"><a href="#CenterRefinement-3554"><span class="linenos">3554</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-3555"><a href="#CenterRefinement-3555"><span class="linenos">3555</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement-3556"><a href="#CenterRefinement-3556"><span class="linenos">3556</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement-3557"><a href="#CenterRefinement-3557"><span class="linenos">3557</span></a>                <span class="n">radi_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3558"><a href="#CenterRefinement-3558"><span class="linenos">3558</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-3559"><a href="#CenterRefinement-3559"><span class="linenos">3559</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-3560"><a href="#CenterRefinement-3560"><span class="linenos">3560</span></a>                                                             <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-3561"><a href="#CenterRefinement-3561"><span class="linenos">3561</span></a>                
</span><span id="CenterRefinement-3562"><a href="#CenterRefinement-3562"><span class="linenos">3562</span></a>            <span class="c1"># Find the minimum value coordinates within curr_var</span>
</span><span id="CenterRefinement-3563"><a href="#CenterRefinement-3563"><span class="linenos">3563</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement-3564"><a href="#CenterRefinement-3564"><span class="linenos">3564</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-3565"><a href="#CenterRefinement-3565"><span class="linenos">3565</span></a>            
</span><span id="CenterRefinement-3566"><a href="#CenterRefinement-3566"><span class="linenos">3566</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement-3567"><a href="#CenterRefinement-3567"><span class="linenos">3567</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_intensity_var</span><span class="p">:</span>
</span><span id="CenterRefinement-3568"><a href="#CenterRefinement-3568"><span class="linenos">3568</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement-3569"><a href="#CenterRefinement-3569"><span class="linenos">3569</span></a>                
</span><span id="CenterRefinement-3570"><a href="#CenterRefinement-3570"><span class="linenos">3570</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement-3571"><a href="#CenterRefinement-3571"><span class="linenos">3571</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement-3572"><a href="#CenterRefinement-3572"><span class="linenos">3572</span></a>                
</span><span id="CenterRefinement-3573"><a href="#CenterRefinement-3573"><span class="linenos">3573</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement-3574"><a href="#CenterRefinement-3574"><span class="linenos">3574</span></a>
</span><span id="CenterRefinement-3575"><a href="#CenterRefinement-3575"><span class="linenos">3575</span></a>            
</span><span id="CenterRefinement-3576"><a href="#CenterRefinement-3576"><span class="linenos">3576</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement-3577"><a href="#CenterRefinement-3577"><span class="linenos">3577</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_intensity_var</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement-3578"><a href="#CenterRefinement-3578"><span class="linenos">3578</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement-3579"><a href="#CenterRefinement-3579"><span class="linenos">3579</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement-3580"><a href="#CenterRefinement-3580"><span class="linenos">3580</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="CenterRefinement-3581"><a href="#CenterRefinement-3581"><span class="linenos">3581</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement-3582"><a href="#CenterRefinement-3582"><span class="linenos">3582</span></a>        
</span><span id="CenterRefinement-3583"><a href="#CenterRefinement-3583"><span class="linenos">3583</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement-3584"><a href="#CenterRefinement-3584"><span class="linenos">3584</span></a>        <span class="c1">## (1) swapped coordinates</span>
</span><span id="CenterRefinement-3585"><a href="#CenterRefinement-3585"><span class="linenos">3585</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-3586"><a href="#CenterRefinement-3586"><span class="linenos">3586</span></a>            <span class="ow">or</span>  <span class="p">(</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="CenterRefinement-3587"><a href="#CenterRefinement-3587"><span class="linenos">3587</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterRefinement-3588"><a href="#CenterRefinement-3588"><span class="linenos">3588</span></a>        
</span><span id="CenterRefinement-3589"><a href="#CenterRefinement-3589"><span class="linenos">3589</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement-3590"><a href="#CenterRefinement-3590"><span class="linenos">3590</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_intensity_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement-3591"><a href="#CenterRefinement-3591"><span class="linenos">3591</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3592"><a href="#CenterRefinement-3592"><span class="linenos">3592</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement-3593"><a href="#CenterRefinement-3593"><span class="linenos">3593</span></a>    
</span><span id="CenterRefinement-3594"><a href="#CenterRefinement-3594"><span class="linenos">3594</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement-3595"><a href="#CenterRefinement-3595"><span class="linenos">3595</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-3596"><a href="#CenterRefinement-3596"><span class="linenos">3596</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement-3597"><a href="#CenterRefinement-3597"><span class="linenos">3597</span></a>                <span class="s2">&quot;Center Refinement (IntensityVar)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-3598"><a href="#CenterRefinement-3598"><span class="linenos">3598</span></a>                                  
</span><span id="CenterRefinement-3599"><a href="#CenterRefinement-3599"><span class="linenos">3599</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span><span id="CenterRefinement-3600"><a href="#CenterRefinement-3600"><span class="linenos">3600</span></a>    
</span><span id="CenterRefinement-3601"><a href="#CenterRefinement-3601"><span class="linenos">3601</span></a>    
</span><span id="CenterRefinement-3602"><a href="#CenterRefinement-3602"><span class="linenos">3602</span></a>    <span class="k">def</span> <span class="nf">ref_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterRefinement-3603"><a href="#CenterRefinement-3603"><span class="linenos">3603</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3604"><a href="#CenterRefinement-3604"><span class="linenos">3604</span></a><span class="sd">        Refine the center coordinates (px, py) and radius (pr) of a circular </span>
</span><span id="CenterRefinement-3605"><a href="#CenterRefinement-3605"><span class="linenos">3605</span></a><span class="sd">        diffraction pattern by maximizing the summed pixel intensity along </span>
</span><span id="CenterRefinement-3606"><a href="#CenterRefinement-3606"><span class="linenos">3606</span></a><span class="sd">        a circular ring.</span>
</span><span id="CenterRefinement-3607"><a href="#CenterRefinement-3607"><span class="linenos">3607</span></a>
</span><span id="CenterRefinement-3608"><a href="#CenterRefinement-3608"><span class="linenos">3608</span></a><span class="sd">        The method uses an iterative local search strategy based on gradient </span>
</span><span id="CenterRefinement-3609"><a href="#CenterRefinement-3609"><span class="linenos">3609</span></a><span class="sd">        ascent in the 8-neighbourhood around the current center to find </span>
</span><span id="CenterRefinement-3610"><a href="#CenterRefinement-3610"><span class="linenos">3610</span></a><span class="sd">        a position and radius that maximize the intensity sum. The center </span>
</span><span id="CenterRefinement-3611"><a href="#CenterRefinement-3611"><span class="linenos">3611</span></a><span class="sd">        is updated based on the best neighbor until convergence criteria </span>
</span><span id="CenterRefinement-3612"><a href="#CenterRefinement-3612"><span class="linenos">3612</span></a><span class="sd">        or maximum iteration limits are met.</span>
</span><span id="CenterRefinement-3613"><a href="#CenterRefinement-3613"><span class="linenos">3613</span></a>
</span><span id="CenterRefinement-3614"><a href="#CenterRefinement-3614"><span class="linenos">3614</span></a><span class="sd">        Neighborhood pattern tested (o = current center, x = candidate center):</span>
</span><span id="CenterRefinement-3615"><a href="#CenterRefinement-3615"><span class="linenos">3615</span></a><span class="sd">            x x x   --&gt; (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)</span>
</span><span id="CenterRefinement-3616"><a href="#CenterRefinement-3616"><span class="linenos">3616</span></a><span class="sd">            x o x   --&gt; (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement-3617"><a href="#CenterRefinement-3617"><span class="linenos">3617</span></a><span class="sd">            x x x   --&gt; (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement-3618"><a href="#CenterRefinement-3618"><span class="linenos">3618</span></a>
</span><span id="CenterRefinement-3619"><a href="#CenterRefinement-3619"><span class="linenos">3619</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement-3620"><a href="#CenterRefinement-3620"><span class="linenos">3620</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement-3621"><a href="#CenterRefinement-3621"><span class="linenos">3621</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement-3622"><a href="#CenterRefinement-3622"><span class="linenos">3622</span></a><span class="sd">            Initial x-coordinate of the detected center.</span>
</span><span id="CenterRefinement-3623"><a href="#CenterRefinement-3623"><span class="linenos">3623</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3624"><a href="#CenterRefinement-3624"><span class="linenos">3624</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement-3625"><a href="#CenterRefinement-3625"><span class="linenos">3625</span></a><span class="sd">            Initial y-coordinate of the detected center.</span>
</span><span id="CenterRefinement-3626"><a href="#CenterRefinement-3626"><span class="linenos">3626</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3627"><a href="#CenterRefinement-3627"><span class="linenos">3627</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement-3628"><a href="#CenterRefinement-3628"><span class="linenos">3628</span></a><span class="sd">            Initial radius of the detected circular pattern.</span>
</span><span id="CenterRefinement-3629"><a href="#CenterRefinement-3629"><span class="linenos">3629</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3630"><a href="#CenterRefinement-3630"><span class="linenos">3630</span></a><span class="sd">        plot_results : int, optional (default=0)</span>
</span><span id="CenterRefinement-3631"><a href="#CenterRefinement-3631"><span class="linenos">3631</span></a><span class="sd">            If set to 1, plots the final result of the refinement.</span>
</span><span id="CenterRefinement-3632"><a href="#CenterRefinement-3632"><span class="linenos">3632</span></a>
</span><span id="CenterRefinement-3633"><a href="#CenterRefinement-3633"><span class="linenos">3633</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement-3634"><a href="#CenterRefinement-3634"><span class="linenos">3634</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement-3635"><a href="#CenterRefinement-3635"><span class="linenos">3635</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement-3636"><a href="#CenterRefinement-3636"><span class="linenos">3636</span></a><span class="sd">            Refined x-coordinate of the center.</span>
</span><span id="CenterRefinement-3637"><a href="#CenterRefinement-3637"><span class="linenos">3637</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3638"><a href="#CenterRefinement-3638"><span class="linenos">3638</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement-3639"><a href="#CenterRefinement-3639"><span class="linenos">3639</span></a><span class="sd">            Refined y-coordinate of the center.</span>
</span><span id="CenterRefinement-3640"><a href="#CenterRefinement-3640"><span class="linenos">3640</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3641"><a href="#CenterRefinement-3641"><span class="linenos">3641</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement-3642"><a href="#CenterRefinement-3642"><span class="linenos">3642</span></a><span class="sd">            Refined radius of the circular pattern.</span>
</span><span id="CenterRefinement-3643"><a href="#CenterRefinement-3643"><span class="linenos">3643</span></a>
</span><span id="CenterRefinement-3644"><a href="#CenterRefinement-3644"><span class="linenos">3644</span></a><span class="sd">        Notes</span>
</span><span id="CenterRefinement-3645"><a href="#CenterRefinement-3645"><span class="linenos">3645</span></a><span class="sd">        -----</span>
</span><span id="CenterRefinement-3646"><a href="#CenterRefinement-3646"><span class="linenos">3646</span></a><span class="sd">        - Uses `self.parent.intensity_sum()` as the optimization criterion.</span>
</span><span id="CenterRefinement-3647"><a href="#CenterRefinement-3647"><span class="linenos">3647</span></a><span class="sd">        - Alternates between optimizing the center and the radius.</span>
</span><span id="CenterRefinement-3648"><a href="#CenterRefinement-3648"><span class="linenos">3648</span></a><span class="sd">        - Stops after no significant improvement over multiple iterations.</span>
</span><span id="CenterRefinement-3649"><a href="#CenterRefinement-3649"><span class="linenos">3649</span></a><span class="sd">        - If refinement worsens the result, the original values are retained.</span>
</span><span id="CenterRefinement-3650"><a href="#CenterRefinement-3650"><span class="linenos">3650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3651"><a href="#CenterRefinement-3651"><span class="linenos">3651</span></a>        <span class="c1"># Store input for plot via self.visualize_refinement()</span>
</span><span id="CenterRefinement-3652"><a href="#CenterRefinement-3652"><span class="linenos">3652</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement-3653"><a href="#CenterRefinement-3653"><span class="linenos">3653</span></a>    
</span><span id="CenterRefinement-3654"><a href="#CenterRefinement-3654"><span class="linenos">3654</span></a>        <span class="c1"># Image in which the center is refined</span>
</span><span id="CenterRefinement-3655"><a href="#CenterRefinement-3655"><span class="linenos">3655</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement-3656"><a href="#CenterRefinement-3656"><span class="linenos">3656</span></a>    
</span><span id="CenterRefinement-3657"><a href="#CenterRefinement-3657"><span class="linenos">3657</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement-3658"><a href="#CenterRefinement-3658"><span class="linenos">3658</span></a>        <span class="n">init_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3659"><a href="#CenterRefinement-3659"><span class="linenos">3659</span></a>        <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3660"><a href="#CenterRefinement-3660"><span class="linenos">3660</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement-3661"><a href="#CenterRefinement-3661"><span class="linenos">3661</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3662"><a href="#CenterRefinement-3662"><span class="linenos">3662</span></a>        
</span><span id="CenterRefinement-3663"><a href="#CenterRefinement-3663"><span class="linenos">3663</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement-3664"><a href="#CenterRefinement-3664"><span class="linenos">3664</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement-3665"><a href="#CenterRefinement-3665"><span class="linenos">3665</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement-3666"><a href="#CenterRefinement-3666"><span class="linenos">3666</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">max_intensity_sum</span>
</span><span id="CenterRefinement-3667"><a href="#CenterRefinement-3667"><span class="linenos">3667</span></a>        
</span><span id="CenterRefinement-3668"><a href="#CenterRefinement-3668"><span class="linenos">3668</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement-3669"><a href="#CenterRefinement-3669"><span class="linenos">3669</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterRefinement-3670"><a href="#CenterRefinement-3670"><span class="linenos">3670</span></a>        
</span><span id="CenterRefinement-3671"><a href="#CenterRefinement-3671"><span class="linenos">3671</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement-3672"><a href="#CenterRefinement-3672"><span class="linenos">3672</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement-3673"><a href="#CenterRefinement-3673"><span class="linenos">3673</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement-3674"><a href="#CenterRefinement-3674"><span class="linenos">3674</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement-3675"><a href="#CenterRefinement-3675"><span class="linenos">3675</span></a>         
</span><span id="CenterRefinement-3676"><a href="#CenterRefinement-3676"><span class="linenos">3676</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement-3677"><a href="#CenterRefinement-3677"><span class="linenos">3677</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement-3678"><a href="#CenterRefinement-3678"><span class="linenos">3678</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="CenterRefinement-3679"><a href="#CenterRefinement-3679"><span class="linenos">3679</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement-3680"><a href="#CenterRefinement-3680"><span class="linenos">3680</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-3681"><a href="#CenterRefinement-3681"><span class="linenos">3681</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement-3682"><a href="#CenterRefinement-3682"><span class="linenos">3682</span></a>        
</span><span id="CenterRefinement-3683"><a href="#CenterRefinement-3683"><span class="linenos">3683</span></a>        <span class="c1"># Live plot initialization </span>
</span><span id="CenterRefinement-3684"><a href="#CenterRefinement-3684"><span class="linenos">3684</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterRefinement-3685"><a href="#CenterRefinement-3685"><span class="linenos">3685</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterRefinement-3686"><a href="#CenterRefinement-3686"><span class="linenos">3686</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterRefinement-3687"><a href="#CenterRefinement-3687"><span class="linenos">3687</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-3688"><a href="#CenterRefinement-3688"><span class="linenos">3688</span></a>            <span class="n">circ_artist</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="n">best_center</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">,</span> 
</span><span id="CenterRefinement-3689"><a href="#CenterRefinement-3689"><span class="linenos">3689</span></a>                                 <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="CenterRefinement-3690"><a href="#CenterRefinement-3690"><span class="linenos">3690</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ_artist</span><span class="p">)</span>
</span><span id="CenterRefinement-3691"><a href="#CenterRefinement-3691"><span class="linenos">3691</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Refinement Progress&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3692"><a href="#CenterRefinement-3692"><span class="linenos">3692</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3693"><a href="#CenterRefinement-3693"><span class="linenos">3693</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterRefinement-3694"><a href="#CenterRefinement-3694"><span class="linenos">3694</span></a>    
</span><span id="CenterRefinement-3695"><a href="#CenterRefinement-3695"><span class="linenos">3695</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement-3696"><a href="#CenterRefinement-3696"><span class="linenos">3696</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement-3697"><a href="#CenterRefinement-3697"><span class="linenos">3697</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3698"><a href="#CenterRefinement-3698"><span class="linenos">3698</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-3699"><a href="#CenterRefinement-3699"><span class="linenos">3699</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-3700"><a href="#CenterRefinement-3700"><span class="linenos">3700</span></a>                                      <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement-3701"><a href="#CenterRefinement-3701"><span class="linenos">3701</span></a>            
</span><span id="CenterRefinement-3702"><a href="#CenterRefinement-3702"><span class="linenos">3702</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement-3703"><a href="#CenterRefinement-3703"><span class="linenos">3703</span></a>            <span class="n">curr_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-3704"><a href="#CenterRefinement-3704"><span class="linenos">3704</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement-3705"><a href="#CenterRefinement-3705"><span class="linenos">3705</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement-3706"><a href="#CenterRefinement-3706"><span class="linenos">3706</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement-3707"><a href="#CenterRefinement-3707"><span class="linenos">3707</span></a>                <span class="n">curr_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3708"><a href="#CenterRefinement-3708"><span class="linenos">3708</span></a>                                                        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> 
</span><span id="CenterRefinement-3709"><a href="#CenterRefinement-3709"><span class="linenos">3709</span></a>                                                        <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-3710"><a href="#CenterRefinement-3710"><span class="linenos">3710</span></a>            
</span><span id="CenterRefinement-3711"><a href="#CenterRefinement-3711"><span class="linenos">3711</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement-3712"><a href="#CenterRefinement-3712"><span class="linenos">3712</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement-3713"><a href="#CenterRefinement-3713"><span class="linenos">3713</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-3714"><a href="#CenterRefinement-3714"><span class="linenos">3714</span></a>                    
</span><span id="CenterRefinement-3715"><a href="#CenterRefinement-3715"><span class="linenos">3715</span></a>            <span class="c1"># Check for improvement of criterion - in each iteration just once,</span>
</span><span id="CenterRefinement-3716"><a href="#CenterRefinement-3716"><span class="linenos">3716</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center</span>
</span><span id="CenterRefinement-3717"><a href="#CenterRefinement-3717"><span class="linenos">3717</span></a>            <span class="c1"># (in each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement-3718"><a href="#CenterRefinement-3718"><span class="linenos">3718</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>                           
</span><span id="CenterRefinement-3719"><a href="#CenterRefinement-3719"><span class="linenos">3719</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement-3720"><a href="#CenterRefinement-3720"><span class="linenos">3720</span></a>                
</span><span id="CenterRefinement-3721"><a href="#CenterRefinement-3721"><span class="linenos">3721</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement-3722"><a href="#CenterRefinement-3722"><span class="linenos">3722</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement-3723"><a href="#CenterRefinement-3723"><span class="linenos">3723</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement-3724"><a href="#CenterRefinement-3724"><span class="linenos">3724</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement-3725"><a href="#CenterRefinement-3725"><span class="linenos">3725</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement-3726"><a href="#CenterRefinement-3726"><span class="linenos">3726</span></a>    
</span><span id="CenterRefinement-3727"><a href="#CenterRefinement-3727"><span class="linenos">3727</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement-3728"><a href="#CenterRefinement-3728"><span class="linenos">3728</span></a>            <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3729"><a href="#CenterRefinement-3729"><span class="linenos">3729</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-3730"><a href="#CenterRefinement-3730"><span class="linenos">3730</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-3731"><a href="#CenterRefinement-3731"><span class="linenos">3731</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement-3732"><a href="#CenterRefinement-3732"><span class="linenos">3732</span></a>    
</span><span id="CenterRefinement-3733"><a href="#CenterRefinement-3733"><span class="linenos">3733</span></a>        
</span><span id="CenterRefinement-3734"><a href="#CenterRefinement-3734"><span class="linenos">3734</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement-3735"><a href="#CenterRefinement-3735"><span class="linenos">3735</span></a>            <span class="c1"># constant. It iterates through different radius adjustments</span>
</span><span id="CenterRefinement-3736"><a href="#CenterRefinement-3736"><span class="linenos">3736</span></a>            <span class="c1"># to find a radius that maximizes the intensity sum of pixels.</span>
</span><span id="CenterRefinement-3737"><a href="#CenterRefinement-3737"><span class="linenos">3737</span></a>            
</span><span id="CenterRefinement-3738"><a href="#CenterRefinement-3738"><span class="linenos">3738</span></a>            <span class="n">radi_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-3739"><a href="#CenterRefinement-3739"><span class="linenos">3739</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-3740"><a href="#CenterRefinement-3740"><span class="linenos">3740</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement-3741"><a href="#CenterRefinement-3741"><span class="linenos">3741</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement-3742"><a href="#CenterRefinement-3742"><span class="linenos">3742</span></a>                <span class="n">radi_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-3743"><a href="#CenterRefinement-3743"><span class="linenos">3743</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-3744"><a href="#CenterRefinement-3744"><span class="linenos">3744</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-3745"><a href="#CenterRefinement-3745"><span class="linenos">3745</span></a>                                                            <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-3746"><a href="#CenterRefinement-3746"><span class="linenos">3746</span></a>                
</span><span id="CenterRefinement-3747"><a href="#CenterRefinement-3747"><span class="linenos">3747</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement-3748"><a href="#CenterRefinement-3748"><span class="linenos">3748</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement-3749"><a href="#CenterRefinement-3749"><span class="linenos">3749</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-3750"><a href="#CenterRefinement-3750"><span class="linenos">3750</span></a>    
</span><span id="CenterRefinement-3751"><a href="#CenterRefinement-3751"><span class="linenos">3751</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement-3752"><a href="#CenterRefinement-3752"><span class="linenos">3752</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>
</span><span id="CenterRefinement-3753"><a href="#CenterRefinement-3753"><span class="linenos">3753</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement-3754"><a href="#CenterRefinement-3754"><span class="linenos">3754</span></a>                
</span><span id="CenterRefinement-3755"><a href="#CenterRefinement-3755"><span class="linenos">3755</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement-3756"><a href="#CenterRefinement-3756"><span class="linenos">3756</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement-3757"><a href="#CenterRefinement-3757"><span class="linenos">3757</span></a>                
</span><span id="CenterRefinement-3758"><a href="#CenterRefinement-3758"><span class="linenos">3758</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement-3759"><a href="#CenterRefinement-3759"><span class="linenos">3759</span></a>                
</span><span id="CenterRefinement-3760"><a href="#CenterRefinement-3760"><span class="linenos">3760</span></a>            
</span><span id="CenterRefinement-3761"><a href="#CenterRefinement-3761"><span class="linenos">3761</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement-3762"><a href="#CenterRefinement-3762"><span class="linenos">3762</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_intensity_sum</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement-3763"><a href="#CenterRefinement-3763"><span class="linenos">3763</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement-3764"><a href="#CenterRefinement-3764"><span class="linenos">3764</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement-3765"><a href="#CenterRefinement-3765"><span class="linenos">3765</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
</span><span id="CenterRefinement-3766"><a href="#CenterRefinement-3766"><span class="linenos">3766</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement-3767"><a href="#CenterRefinement-3767"><span class="linenos">3767</span></a>                
</span><span id="CenterRefinement-3768"><a href="#CenterRefinement-3768"><span class="linenos">3768</span></a>            <span class="c1"># --- Live plot update ---</span>
</span><span id="CenterRefinement-3769"><a href="#CenterRefinement-3769"><span class="linenos">3769</span></a>            <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterRefinement-3770"><a href="#CenterRefinement-3770"><span class="linenos">3770</span></a>                <span class="n">circ_artist</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">best_center</span>
</span><span id="CenterRefinement-3771"><a href="#CenterRefinement-3771"><span class="linenos">3771</span></a>                <span class="n">circ_artist</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement-3772"><a href="#CenterRefinement-3772"><span class="linenos">3772</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="CenterRefinement-3773"><a href="#CenterRefinement-3773"><span class="linenos">3773</span></a>                    <span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> | Sum=</span><span class="si">{</span><span class="n">max_intensity_sum</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3774"><a href="#CenterRefinement-3774"><span class="linenos">3774</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterRefinement-3775"><a href="#CenterRefinement-3775"><span class="linenos">3775</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
</span><span id="CenterRefinement-3776"><a href="#CenterRefinement-3776"><span class="linenos">3776</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># small delay for visual update</span>
</span><span id="CenterRefinement-3777"><a href="#CenterRefinement-3777"><span class="linenos">3777</span></a>        
</span><span id="CenterRefinement-3778"><a href="#CenterRefinement-3778"><span class="linenos">3778</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement-3779"><a href="#CenterRefinement-3779"><span class="linenos">3779</span></a>        <span class="c1"># ## (1) swapped coordinates</span>
</span><span id="CenterRefinement-3780"><a href="#CenterRefinement-3780"><span class="linenos">3780</span></a>        <span class="c1"># if ((bckup[0] &gt; bckup[1] and not best_center[0] &gt; best_center[1])</span>
</span><span id="CenterRefinement-3781"><a href="#CenterRefinement-3781"><span class="linenos">3781</span></a>        <span class="c1">#     or  (bckup[0] &lt; bckup[1]</span>
</span><span id="CenterRefinement-3782"><a href="#CenterRefinement-3782"><span class="linenos">3782</span></a>        <span class="c1">#     and not best_center[0] &lt; best_center[1])):</span>
</span><span id="CenterRefinement-3783"><a href="#CenterRefinement-3783"><span class="linenos">3783</span></a>        <span class="c1">#     best_center = best_center[::-1]</span>
</span><span id="CenterRefinement-3784"><a href="#CenterRefinement-3784"><span class="linenos">3784</span></a>        
</span><span id="CenterRefinement-3785"><a href="#CenterRefinement-3785"><span class="linenos">3785</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement-3786"><a href="#CenterRefinement-3786"><span class="linenos">3786</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">max_intensity_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement-3787"><a href="#CenterRefinement-3787"><span class="linenos">3787</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3788"><a href="#CenterRefinement-3788"><span class="linenos">3788</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement-3789"><a href="#CenterRefinement-3789"><span class="linenos">3789</span></a>    
</span><span id="CenterRefinement-3790"><a href="#CenterRefinement-3790"><span class="linenos">3790</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement-3791"><a href="#CenterRefinement-3791"><span class="linenos">3791</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-3792"><a href="#CenterRefinement-3792"><span class="linenos">3792</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement-3793"><a href="#CenterRefinement-3793"><span class="linenos">3793</span></a>                <span class="s2">&quot;Center Refinement (IntensitySum)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-3794"><a href="#CenterRefinement-3794"><span class="linenos">3794</span></a>        
</span><span id="CenterRefinement-3795"><a href="#CenterRefinement-3795"><span class="linenos">3795</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterRefinement-3796"><a href="#CenterRefinement-3796"><span class="linenos">3796</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterRefinement-3797"><a href="#CenterRefinement-3797"><span class="linenos">3797</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterRefinement-3798"><a href="#CenterRefinement-3798"><span class="linenos">3798</span></a>
</span><span id="CenterRefinement-3799"><a href="#CenterRefinement-3799"><span class="linenos">3799</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span><span id="CenterRefinement-3800"><a href="#CenterRefinement-3800"><span class="linenos">3800</span></a>    
</span><span id="CenterRefinement-3801"><a href="#CenterRefinement-3801"><span class="linenos">3801</span></a>    
</span><span id="CenterRefinement-3802"><a href="#CenterRefinement-3802"><span class="linenos">3802</span></a>    <span class="k">def</span> <span class="nf">diagnose_landscape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">search_range</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">21</span><span class="p">):</span>
</span><span id="CenterRefinement-3803"><a href="#CenterRefinement-3803"><span class="linenos">3803</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3804"><a href="#CenterRefinement-3804"><span class="linenos">3804</span></a><span class="sd">        Visualize the optimization landscape of a center refinement metric</span>
</span><span id="CenterRefinement-3805"><a href="#CenterRefinement-3805"><span class="linenos">3805</span></a><span class="sd">        around a candidate center location and radius.</span>
</span><span id="CenterRefinement-3806"><a href="#CenterRefinement-3806"><span class="linenos">3806</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3807"><a href="#CenterRefinement-3807"><span class="linenos">3807</span></a><span class="sd">        This function evaluates the selected metric over a grid of positions</span>
</span><span id="CenterRefinement-3808"><a href="#CenterRefinement-3808"><span class="linenos">3808</span></a><span class="sd">        in a 2D neighborhood around the given (px, py) center, using a fixed</span>
</span><span id="CenterRefinement-3809"><a href="#CenterRefinement-3809"><span class="linenos">3809</span></a><span class="sd">        radius `pr`, and visualizes the results as a heatmap with contours.</span>
</span><span id="CenterRefinement-3810"><a href="#CenterRefinement-3810"><span class="linenos">3810</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3811"><a href="#CenterRefinement-3811"><span class="linenos">3811</span></a><span class="sd">        It can be useful for diagnosing whether the optimization function</span>
</span><span id="CenterRefinement-3812"><a href="#CenterRefinement-3812"><span class="linenos">3812</span></a><span class="sd">        (e.g., standard deviation, median, or sum of pixel intensities) has</span>
</span><span id="CenterRefinement-3813"><a href="#CenterRefinement-3813"><span class="linenos">3813</span></a><span class="sd">        a smooth and well-behaved landscape, which is important for gradient</span>
</span><span id="CenterRefinement-3814"><a href="#CenterRefinement-3814"><span class="linenos">3814</span></a><span class="sd">        optimization methods.</span>
</span><span id="CenterRefinement-3815"><a href="#CenterRefinement-3815"><span class="linenos">3815</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3816"><a href="#CenterRefinement-3816"><span class="linenos">3816</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement-3817"><a href="#CenterRefinement-3817"><span class="linenos">3817</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement-3818"><a href="#CenterRefinement-3818"><span class="linenos">3818</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement-3819"><a href="#CenterRefinement-3819"><span class="linenos">3819</span></a><span class="sd">            X-coordinate of the candidate center.</span>
</span><span id="CenterRefinement-3820"><a href="#CenterRefinement-3820"><span class="linenos">3820</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3821"><a href="#CenterRefinement-3821"><span class="linenos">3821</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement-3822"><a href="#CenterRefinement-3822"><span class="linenos">3822</span></a><span class="sd">            Y-coordinate of the candidate center.</span>
</span><span id="CenterRefinement-3823"><a href="#CenterRefinement-3823"><span class="linenos">3823</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3824"><a href="#CenterRefinement-3824"><span class="linenos">3824</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement-3825"><a href="#CenterRefinement-3825"><span class="linenos">3825</span></a><span class="sd">            Radius of the circular region to evaluate the metric on.</span>
</span><span id="CenterRefinement-3826"><a href="#CenterRefinement-3826"><span class="linenos">3826</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3827"><a href="#CenterRefinement-3827"><span class="linenos">3827</span></a><span class="sd">        metric : str, optional</span>
</span><span id="CenterRefinement-3828"><a href="#CenterRefinement-3828"><span class="linenos">3828</span></a><span class="sd">            The metric to evaluate. Options are:</span>
</span><span id="CenterRefinement-3829"><a href="#CenterRefinement-3829"><span class="linenos">3829</span></a><span class="sd">            - &#39;std&#39;: standard deviation of pixel values (default)</span>
</span><span id="CenterRefinement-3830"><a href="#CenterRefinement-3830"><span class="linenos">3830</span></a><span class="sd">            - &#39;median&#39;: median of pixel values</span>
</span><span id="CenterRefinement-3831"><a href="#CenterRefinement-3831"><span class="linenos">3831</span></a><span class="sd">            - &#39;sum&#39;: sum of pixel values</span>
</span><span id="CenterRefinement-3832"><a href="#CenterRefinement-3832"><span class="linenos">3832</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3833"><a href="#CenterRefinement-3833"><span class="linenos">3833</span></a><span class="sd">        search_range : float, optional, default=2.0</span>
</span><span id="CenterRefinement-3834"><a href="#CenterRefinement-3834"><span class="linenos">3834</span></a><span class="sd">            The radius of the square region (in pixels) around the center </span>
</span><span id="CenterRefinement-3835"><a href="#CenterRefinement-3835"><span class="linenos">3835</span></a><span class="sd">            to explore. The grid will extend ±`search_range` in both x and y </span>
</span><span id="CenterRefinement-3836"><a href="#CenterRefinement-3836"><span class="linenos">3836</span></a><span class="sd">            directions.</span>
</span><span id="CenterRefinement-3837"><a href="#CenterRefinement-3837"><span class="linenos">3837</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-3838"><a href="#CenterRefinement-3838"><span class="linenos">3838</span></a><span class="sd">        steps : int, optional, default=21</span>
</span><span id="CenterRefinement-3839"><a href="#CenterRefinement-3839"><span class="linenos">3839</span></a><span class="sd">            The number of points to sample along each axis (grid resolution).</span>
</span><span id="CenterRefinement-3840"><a href="#CenterRefinement-3840"><span class="linenos">3840</span></a><span class="sd">            Must be an odd number to ensure the center point is included.</span>
</span><span id="CenterRefinement-3841"><a href="#CenterRefinement-3841"><span class="linenos">3841</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-3842"><a href="#CenterRefinement-3842"><span class="linenos">3842</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement-3843"><a href="#CenterRefinement-3843"><span class="linenos">3843</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement-3844"><a href="#CenterRefinement-3844"><span class="linenos">3844</span></a><span class="sd">        None</span>
</span><span id="CenterRefinement-3845"><a href="#CenterRefinement-3845"><span class="linenos">3845</span></a><span class="sd">            This method produces a matplotlib plot and does not return any value.</span>
</span><span id="CenterRefinement-3846"><a href="#CenterRefinement-3846"><span class="linenos">3846</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement-3847"><a href="#CenterRefinement-3847"><span class="linenos">3847</span></a>        <span class="c1"># Helper functions ----------------------------------------------------</span>
</span><span id="CenterRefinement-3848"><a href="#CenterRefinement-3848"><span class="linenos">3848</span></a>        <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterRefinement-3849"><a href="#CenterRefinement-3849"><span class="linenos">3849</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-3850"><a href="#CenterRefinement-3850"><span class="linenos">3850</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="CenterRefinement-3851"><a href="#CenterRefinement-3851"><span class="linenos">3851</span></a>        
</span><span id="CenterRefinement-3852"><a href="#CenterRefinement-3852"><span class="linenos">3852</span></a>        <span class="k">def</span> <span class="nf">intensity_std</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterRefinement-3853"><a href="#CenterRefinement-3853"><span class="linenos">3853</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-3854"><a href="#CenterRefinement-3854"><span class="linenos">3854</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="CenterRefinement-3855"><a href="#CenterRefinement-3855"><span class="linenos">3855</span></a>        
</span><span id="CenterRefinement-3856"><a href="#CenterRefinement-3856"><span class="linenos">3856</span></a>        <span class="k">def</span> <span class="nf">intensity_median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterRefinement-3857"><a href="#CenterRefinement-3857"><span class="linenos">3857</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-3858"><a href="#CenterRefinement-3858"><span class="linenos">3858</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="CenterRefinement-3859"><a href="#CenterRefinement-3859"><span class="linenos">3859</span></a>
</span><span id="CenterRefinement-3860"><a href="#CenterRefinement-3860"><span class="linenos">3860</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diagnosing landscape around (</span><span class="si">{</span><span class="n">px</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">py</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) with r=</span><span class="si">{</span><span class="n">pr</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3861"><a href="#CenterRefinement-3861"><span class="linenos">3861</span></a>        
</span><span id="CenterRefinement-3862"><a href="#CenterRefinement-3862"><span class="linenos">3862</span></a>        <span class="c1"># (0) Select the metric function --------------------------------------</span>
</span><span id="CenterRefinement-3863"><a href="#CenterRefinement-3863"><span class="linenos">3863</span></a>        <span class="n">metric_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">intensity_std</span><span class="p">,</span> 
</span><span id="CenterRefinement-3864"><a href="#CenterRefinement-3864"><span class="linenos">3864</span></a>                      <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">intensity_median</span><span class="p">,</span> 
</span><span id="CenterRefinement-3865"><a href="#CenterRefinement-3865"><span class="linenos">3865</span></a>                      <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="n">intensity_sum</span> <span class="p">}</span>
</span><span id="CenterRefinement-3866"><a href="#CenterRefinement-3866"><span class="linenos">3866</span></a>        <span class="n">metric_func</span> <span class="o">=</span> <span class="n">metric_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">intensity_std</span><span class="p">)</span>
</span><span id="CenterRefinement-3867"><a href="#CenterRefinement-3867"><span class="linenos">3867</span></a>    
</span><span id="CenterRefinement-3868"><a href="#CenterRefinement-3868"><span class="linenos">3868</span></a>        <span class="c1"># (1) Create a grid of x and y coordinates to test --------------------</span>
</span><span id="CenterRefinement-3869"><a href="#CenterRefinement-3869"><span class="linenos">3869</span></a>        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">px</span> <span class="o">-</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="CenterRefinement-3870"><a href="#CenterRefinement-3870"><span class="linenos">3870</span></a>        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">py</span> <span class="o">-</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="CenterRefinement-3871"><a href="#CenterRefinement-3871"><span class="linenos">3871</span></a>        <span class="n">score_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="n">steps</span><span class="p">))</span>
</span><span id="CenterRefinement-3872"><a href="#CenterRefinement-3872"><span class="linenos">3872</span></a>    
</span><span id="CenterRefinement-3873"><a href="#CenterRefinement-3873"><span class="linenos">3873</span></a>        <span class="c1"># (2) Calculate the metric score at each point on the grid ------------</span>
</span><span id="CenterRefinement-3874"><a href="#CenterRefinement-3874"><span class="linenos">3874</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_range</span><span class="p">):</span>
</span><span id="CenterRefinement-3875"><a href="#CenterRefinement-3875"><span class="linenos">3875</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_range</span><span class="p">):</span>
</span><span id="CenterRefinement-3876"><a href="#CenterRefinement-3876"><span class="linenos">3876</span></a>                <span class="n">score_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-3877"><a href="#CenterRefinement-3877"><span class="linenos">3877</span></a>    
</span><span id="CenterRefinement-3878"><a href="#CenterRefinement-3878"><span class="linenos">3878</span></a>        <span class="c1"># (3) Plot the results ------------------------------------------------</span>
</span><span id="CenterRefinement-3879"><a href="#CenterRefinement-3879"><span class="linenos">3879</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="CenterRefinement-3880"><a href="#CenterRefinement-3880"><span class="linenos">3880</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CenterRefinement-3881"><a href="#CenterRefinement-3881"><span class="linenos">3881</span></a>            <span class="n">score_grid</span><span class="p">,</span> 
</span><span id="CenterRefinement-3882"><a href="#CenterRefinement-3882"><span class="linenos">3882</span></a>            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> 
</span><span id="CenterRefinement-3883"><a href="#CenterRefinement-3883"><span class="linenos">3883</span></a>            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterRefinement-3884"><a href="#CenterRefinement-3884"><span class="linenos">3884</span></a>            <span class="p">)</span>
</span><span id="CenterRefinement-3885"><a href="#CenterRefinement-3885"><span class="linenos">3885</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Metric Score (&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3886"><a href="#CenterRefinement-3886"><span class="linenos">3886</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">score_grid</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="CenterRefinement-3887"><a href="#CenterRefinement-3887"><span class="linenos">3887</span></a>        
</span><span id="CenterRefinement-3888"><a href="#CenterRefinement-3888"><span class="linenos">3888</span></a>        <span class="c1"># Mark the starting point</span>
</span><span id="CenterRefinement-3889"><a href="#CenterRefinement-3889"><span class="linenos">3889</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Guess&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-3890"><a href="#CenterRefinement-3890"><span class="linenos">3890</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Optimization Landscape&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3891"><a href="#CenterRefinement-3891"><span class="linenos">3891</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X-coordinate&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3892"><a href="#CenterRefinement-3892"><span class="linenos">3892</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y-coordinate&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-3893"><a href="#CenterRefinement-3893"><span class="linenos">3893</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterRefinement-3894"><a href="#CenterRefinement-3894"><span class="linenos">3894</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>CenterRefinement - Final refinement of the center of a diffraction pattern.</p>

<p>This class performs refinement of the detected center coordinates in a 2D
diffraction pattern. It supports multiple refinement methods, both manual
and automatic, and optionally saves the refined center to a file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>parent</strong> (CenterLocator):
Reference to the parent CenterLocator object. Used to access shared
attributes like initial center estimates and configuration flags.</li>
<li><strong>input_image</strong> (str, Path, or numpy.ndarray):
The diffraction pattern image, either as a file path or a 2D NumPy array.</li>
<li><strong>refinement</strong> (str or None, optional, default=None):
The refinement method to apply. Options include:
<ul>
<li>'manual': Manual adjustment via user interaction on the selected ring.</li>
<li>'sum'   : Automatic refinement by maximizing the intensity sum </li>
<li>'var'   : Automatic refinement by minimizing the intensity variance
If None, no refinement is applied.</li>
</ul></li>
<li><strong>out_file</strong> (str, optional):
Path to a text file where the refined center coordinates will be saved.</li>
<li><strong>heq</strong> (bool, optional, default=False):
Whether to apply histogram equalization to the input image before
processing.</li>
<li><strong>icut</strong> (float, optional, default=None):
Cut-off intensity level for processing the image</li>
<li><strong>cmap</strong> (str, optional, default='gray'):
Colormap to be used when displaying the image for manual refinement.</li>
<li><strong>verbose</strong> (bool, optional, default=False):
Flag to enable or disable informational verbose during processing.</li>
<li><strong>print_sums</strong> (bool, optional, default=False):
If True, prints the sum of intensity values for the refined circle 
after each adjustment, relevant only for manual refinement methods.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>If an unsupported refinement method is provided, the program exits with
an error.</li>
<li>The coordinates <code>xx</code>, <code>yy</code>, and radius <code>rr</code> can be accessed after
initialization for further analysis or saving.</li>
<li>The refinement strategy relies on initial estimates provided by the parent 
object.</li>
<li>Manual refinement supports click-based center adjustments guided by visual 
feedback.</li>
<li>Sum/variance refinement automatically searches for the most likely center
by evaluating ring statistics.</li>
</ul>
</div>


                            <div id="CenterRefinement.ref_interactive" class="classattr">
                                        <input id="CenterRefinement.ref_interactive-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ref_interactive</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterRefinement.ref_interactive-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement.ref_interactive"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement.ref_interactive-3206"><a href="#CenterRefinement.ref_interactive-3206"><span class="linenos">3206</span></a>    <span class="k">def</span> <span class="nf">ref_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-3207"><a href="#CenterRefinement.ref_interactive-3207"><span class="linenos">3207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_interactive-3208"><a href="#CenterRefinement.ref_interactive-3208"><span class="linenos">3208</span></a><span class="sd">        Manual/interactive refinement of the diffraction pattern center.</span>
</span><span id="CenterRefinement.ref_interactive-3209"><a href="#CenterRefinement.ref_interactive-3209"><span class="linenos">3209</span></a><span class="sd">      </span>
</span><span id="CenterRefinement.ref_interactive-3210"><a href="#CenterRefinement.ref_interactive-3210"><span class="linenos">3210</span></a><span class="sd">        This method allows the user to fine-tune the estimated center</span>
</span><span id="CenterRefinement.ref_interactive-3211"><a href="#CenterRefinement.ref_interactive-3211"><span class="linenos">3211</span></a><span class="sd">        and radius of a diffraction ring through interactive keyboard controls.</span>
</span><span id="CenterRefinement.ref_interactive-3212"><a href="#CenterRefinement.ref_interactive-3212"><span class="linenos">3212</span></a><span class="sd">      </span>
</span><span id="CenterRefinement.ref_interactive-3213"><a href="#CenterRefinement.ref_interactive-3213"><span class="linenos">3213</span></a><span class="sd">        An new window is opened and the user can adjust the position</span>
</span><span id="CenterRefinement.ref_interactive-3214"><a href="#CenterRefinement.ref_interactive-3214"><span class="linenos">3214</span></a><span class="sd">        of the diffraction ring using the following keys (keyboard controls):</span>
</span><span id="CenterRefinement.ref_interactive-3215"><a href="#CenterRefinement.ref_interactive-3215"><span class="linenos">3215</span></a><span class="sd">        - Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</span>
</span><span id="CenterRefinement.ref_interactive-3216"><a href="#CenterRefinement.ref_interactive-3216"><span class="linenos">3216</span></a><span class="sd">        - &#39;+&#39; : Increase the radius</span>
</span><span id="CenterRefinement.ref_interactive-3217"><a href="#CenterRefinement.ref_interactive-3217"><span class="linenos">3217</span></a><span class="sd">        - &#39;-&#39; : Decrease the radius</span>
</span><span id="CenterRefinement.ref_interactive-3218"><a href="#CenterRefinement.ref_interactive-3218"><span class="linenos">3218</span></a><span class="sd">        - &#39;b&#39; : Increase step size (×5)</span>
</span><span id="CenterRefinement.ref_interactive-3219"><a href="#CenterRefinement.ref_interactive-3219"><span class="linenos">3219</span></a><span class="sd">        - &#39;l&#39; : Decrease step size (/5, with minimum step size 0.5)</span>
</span><span id="CenterRefinement.ref_interactive-3220"><a href="#CenterRefinement.ref_interactive-3220"><span class="linenos">3220</span></a><span class="sd">        - &#39;d&#39; : Done — finalize the center and radius</span>
</span><span id="CenterRefinement.ref_interactive-3221"><a href="#CenterRefinement.ref_interactive-3221"><span class="linenos">3221</span></a><span class="sd">        - Closing the figure: Cancels refinement and returns the original input </span>
</span><span id="CenterRefinement.ref_interactive-3222"><a href="#CenterRefinement.ref_interactive-3222"><span class="linenos">3222</span></a><span class="sd">          center and radius</span>
</span><span id="CenterRefinement.ref_interactive-3223"><a href="#CenterRefinement.ref_interactive-3223"><span class="linenos">3223</span></a><span class="sd">      </span>
</span><span id="CenterRefinement.ref_interactive-3224"><a href="#CenterRefinement.ref_interactive-3224"><span class="linenos">3224</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement.ref_interactive-3225"><a href="#CenterRefinement.ref_interactive-3225"><span class="linenos">3225</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement.ref_interactive-3226"><a href="#CenterRefinement.ref_interactive-3226"><span class="linenos">3226</span></a><span class="sd">        fig : matplotlib.figure.Figure</span>
</span><span id="CenterRefinement.ref_interactive-3227"><a href="#CenterRefinement.ref_interactive-3227"><span class="linenos">3227</span></a><span class="sd">            The figure window used for interactive refinement.</span>
</span><span id="CenterRefinement.ref_interactive-3228"><a href="#CenterRefinement.ref_interactive-3228"><span class="linenos">3228</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_interactive-3229"><a href="#CenterRefinement.ref_interactive-3229"><span class="linenos">3229</span></a><span class="sd">        circle : matplotlib.patches.Circle</span>
</span><span id="CenterRefinement.ref_interactive-3230"><a href="#CenterRefinement.ref_interactive-3230"><span class="linenos">3230</span></a><span class="sd">            The circle object known from</span>
</span><span id="CenterRefinement.ref_interactive-3231"><a href="#CenterRefinement.ref_interactive-3231"><span class="linenos">3231</span></a><span class="sd">            the previous step = from the center determination.</span>
</span><span id="CenterRefinement.ref_interactive-3232"><a href="#CenterRefinement.ref_interactive-3232"><span class="linenos">3232</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_interactive-3233"><a href="#CenterRefinement.ref_interactive-3233"><span class="linenos">3233</span></a><span class="sd">        center : tuple</span>
</span><span id="CenterRefinement.ref_interactive-3234"><a href="#CenterRefinement.ref_interactive-3234"><span class="linenos">3234</span></a><span class="sd">            The initial (x, y) center coordinates from</span>
</span><span id="CenterRefinement.ref_interactive-3235"><a href="#CenterRefinement.ref_interactive-3235"><span class="linenos">3235</span></a><span class="sd">            the previous step = from the center determination.</span>
</span><span id="CenterRefinement.ref_interactive-3236"><a href="#CenterRefinement.ref_interactive-3236"><span class="linenos">3236</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_interactive-3237"><a href="#CenterRefinement.ref_interactive-3237"><span class="linenos">3237</span></a><span class="sd">        plot_results : bool, optional, default=False</span>
</span><span id="CenterRefinement.ref_interactive-3238"><a href="#CenterRefinement.ref_interactive-3238"><span class="linenos">3238</span></a><span class="sd">            If True, the results of the adjustment are visualized.</span>
</span><span id="CenterRefinement.ref_interactive-3239"><a href="#CenterRefinement.ref_interactive-3239"><span class="linenos">3239</span></a><span class="sd">      </span>
</span><span id="CenterRefinement.ref_interactive-3240"><a href="#CenterRefinement.ref_interactive-3240"><span class="linenos">3240</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement.ref_interactive-3241"><a href="#CenterRefinement.ref_interactive-3241"><span class="linenos">3241</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement.ref_interactive-3242"><a href="#CenterRefinement.ref_interactive-3242"><span class="linenos">3242</span></a><span class="sd">        xy[0] : float</span>
</span><span id="CenterRefinement.ref_interactive-3243"><a href="#CenterRefinement.ref_interactive-3243"><span class="linenos">3243</span></a><span class="sd">            x-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterRefinement.ref_interactive-3244"><a href="#CenterRefinement.ref_interactive-3244"><span class="linenos">3244</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_interactive-3245"><a href="#CenterRefinement.ref_interactive-3245"><span class="linenos">3245</span></a><span class="sd">        xy[1] : float</span>
</span><span id="CenterRefinement.ref_interactive-3246"><a href="#CenterRefinement.ref_interactive-3246"><span class="linenos">3246</span></a><span class="sd">            y-coordinate of the adjusted center of the diffraction pattern.</span>
</span><span id="CenterRefinement.ref_interactive-3247"><a href="#CenterRefinement.ref_interactive-3247"><span class="linenos">3247</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_interactive-3248"><a href="#CenterRefinement.ref_interactive-3248"><span class="linenos">3248</span></a><span class="sd">        r : float</span>
</span><span id="CenterRefinement.ref_interactive-3249"><a href="#CenterRefinement.ref_interactive-3249"><span class="linenos">3249</span></a><span class="sd">            Adjusted radius of the diffraction ring.</span>
</span><span id="CenterRefinement.ref_interactive-3250"><a href="#CenterRefinement.ref_interactive-3250"><span class="linenos">3250</span></a><span class="sd">      </span>
</span><span id="CenterRefinement.ref_interactive-3251"><a href="#CenterRefinement.ref_interactive-3251"><span class="linenos">3251</span></a><span class="sd">        Notes</span>
</span><span id="CenterRefinement.ref_interactive-3252"><a href="#CenterRefinement.ref_interactive-3252"><span class="linenos">3252</span></a><span class="sd">        -----</span>
</span><span id="CenterRefinement.ref_interactive-3253"><a href="#CenterRefinement.ref_interactive-3253"><span class="linenos">3253</span></a><span class="sd">        - Interactive adjustments are visualized in real time.</span>
</span><span id="CenterRefinement.ref_interactive-3254"><a href="#CenterRefinement.ref_interactive-3254"><span class="linenos">3254</span></a><span class="sd">        - Intensity sum at the current center/radius is printed</span>
</span><span id="CenterRefinement.ref_interactive-3255"><a href="#CenterRefinement.ref_interactive-3255"><span class="linenos">3255</span></a><span class="sd">          if *print_sums* argument is True.</span>
</span><span id="CenterRefinement.ref_interactive-3256"><a href="#CenterRefinement.ref_interactive-3256"><span class="linenos">3256</span></a><span class="sd">        - Arrow key defaults in Matplotlib (e.g., navigation)</span>
</span><span id="CenterRefinement.ref_interactive-3257"><a href="#CenterRefinement.ref_interactive-3257"><span class="linenos">3257</span></a><span class="sd">          are temporarily disabled to allow movement control.</span>
</span><span id="CenterRefinement.ref_interactive-3258"><a href="#CenterRefinement.ref_interactive-3258"><span class="linenos">3258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_interactive-3259"><a href="#CenterRefinement.ref_interactive-3259"><span class="linenos">3259</span></a>             
</span><span id="CenterRefinement.ref_interactive-3260"><a href="#CenterRefinement.ref_interactive-3260"><span class="linenos">3260</span></a>        <span class="c1"># (0) Load original image ---------------------------------------------</span>
</span><span id="CenterRefinement.ref_interactive-3261"><a href="#CenterRefinement.ref_interactive-3261"><span class="linenos">3261</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3262"><a href="#CenterRefinement.ref_interactive-3262"><span class="linenos">3262</span></a>
</span><span id="CenterRefinement.ref_interactive-3263"><a href="#CenterRefinement.ref_interactive-3263"><span class="linenos">3263</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterRefinement.ref_interactive-3264"><a href="#CenterRefinement.ref_interactive-3264"><span class="linenos">3264</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3265"><a href="#CenterRefinement.ref_interactive-3265"><span class="linenos">3265</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3266"><a href="#CenterRefinement.ref_interactive-3266"><span class="linenos">3266</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3267"><a href="#CenterRefinement.ref_interactive-3267"><span class="linenos">3267</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-3268"><a href="#CenterRefinement.ref_interactive-3268"><span class="linenos">3268</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-3269"><a href="#CenterRefinement.ref_interactive-3269"><span class="linenos">3269</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3270"><a href="#CenterRefinement.ref_interactive-3270"><span class="linenos">3270</span></a>            
</span><span id="CenterRefinement.ref_interactive-3271"><a href="#CenterRefinement.ref_interactive-3271"><span class="linenos">3271</span></a>        <span class="c1"># (1) Initialize variables and flags ----------------------------------</span>
</span><span id="CenterRefinement.ref_interactive-3272"><a href="#CenterRefinement.ref_interactive-3272"><span class="linenos">3272</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_interactive-3273"><a href="#CenterRefinement.ref_interactive-3273"><span class="linenos">3273</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3274"><a href="#CenterRefinement.ref_interactive-3274"><span class="linenos">3274</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterRefinement.ref_interactive-3275"><a href="#CenterRefinement.ref_interactive-3275"><span class="linenos">3275</span></a>
</span><span id="CenterRefinement.ref_interactive-3276"><a href="#CenterRefinement.ref_interactive-3276"><span class="linenos">3276</span></a>        <span class="c1"># (2) User information ------------------------------------------------</span>
</span><span id="CenterRefinement.ref_interactive-3277"><a href="#CenterRefinement.ref_interactive-3277"><span class="linenos">3277</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-3278"><a href="#CenterRefinement.ref_interactive-3278"><span class="linenos">3278</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_interactive-3279"><a href="#CenterRefinement.ref_interactive-3279"><span class="linenos">3279</span></a><span class="s2">            </span>
</span><span id="CenterRefinement.ref_interactive-3280"><a href="#CenterRefinement.ref_interactive-3280"><span class="linenos">3280</span></a><span class="s2">            Interactive refinement. Use these keys:</span>
</span><span id="CenterRefinement.ref_interactive-3281"><a href="#CenterRefinement.ref_interactive-3281"><span class="linenos">3281</span></a><span class="s2">                  - &#39;←&#39; : move left</span>
</span><span id="CenterRefinement.ref_interactive-3282"><a href="#CenterRefinement.ref_interactive-3282"><span class="linenos">3282</span></a><span class="s2">                  - &#39;→&#39; : move right</span>
</span><span id="CenterRefinement.ref_interactive-3283"><a href="#CenterRefinement.ref_interactive-3283"><span class="linenos">3283</span></a><span class="s2">                  - &#39;↑&#39; : move up</span>
</span><span id="CenterRefinement.ref_interactive-3284"><a href="#CenterRefinement.ref_interactive-3284"><span class="linenos">3284</span></a><span class="s2">                  - &#39;↓&#39; : move down</span>
</span><span id="CenterRefinement.ref_interactive-3285"><a href="#CenterRefinement.ref_interactive-3285"><span class="linenos">3285</span></a><span class="s2">                  - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterRefinement.ref_interactive-3286"><a href="#CenterRefinement.ref_interactive-3286"><span class="linenos">3286</span></a><span class="s2">                  - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterRefinement.ref_interactive-3287"><a href="#CenterRefinement.ref_interactive-3287"><span class="linenos">3287</span></a><span class="s2">                  - &#39;b&#39; : increase step size</span>
</span><span id="CenterRefinement.ref_interactive-3288"><a href="#CenterRefinement.ref_interactive-3288"><span class="linenos">3288</span></a><span class="s2">                  - &#39;l&#39; : decrease step size</span>
</span><span id="CenterRefinement.ref_interactive-3289"><a href="#CenterRefinement.ref_interactive-3289"><span class="linenos">3289</span></a><span class="s2">                  - &#39;d&#39; : refinement done</span>
</span><span id="CenterRefinement.ref_interactive-3290"><a href="#CenterRefinement.ref_interactive-3290"><span class="linenos">3290</span></a><span class="s2">                  </span>
</span><span id="CenterRefinement.ref_interactive-3291"><a href="#CenterRefinement.ref_interactive-3291"><span class="linenos">3291</span></a><span class="s2">            DISCLAIMER: For the purpose of the center shift, the default</span>
</span><span id="CenterRefinement.ref_interactive-3292"><a href="#CenterRefinement.ref_interactive-3292"><span class="linenos">3292</span></a><span class="s2">            shortcuts for left and right arrows were removed.</span>
</span><span id="CenterRefinement.ref_interactive-3293"><a href="#CenterRefinement.ref_interactive-3293"><span class="linenos">3293</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3294"><a href="#CenterRefinement.ref_interactive-3294"><span class="linenos">3294</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3295"><a href="#CenterRefinement.ref_interactive-3295"><span class="linenos">3295</span></a>        
</span><span id="CenterRefinement.ref_interactive-3296"><a href="#CenterRefinement.ref_interactive-3296"><span class="linenos">3296</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3297"><a href="#CenterRefinement.ref_interactive-3297"><span class="linenos">3297</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3298"><a href="#CenterRefinement.ref_interactive-3298"><span class="linenos">3298</span></a>            
</span><span id="CenterRefinement.ref_interactive-3299"><a href="#CenterRefinement.ref_interactive-3299"><span class="linenos">3299</span></a>        <span class="c1"># (3) Create a figure and display the image ---------------------------</span>
</span><span id="CenterRefinement.ref_interactive-3300"><a href="#CenterRefinement.ref_interactive-3300"><span class="linenos">3300</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_interactive-3301"><a href="#CenterRefinement.ref_interactive-3301"><span class="linenos">3301</span></a>        
</span><span id="CenterRefinement.ref_interactive-3302"><a href="#CenterRefinement.ref_interactive-3302"><span class="linenos">3302</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterRefinement.ref_interactive-3303"><a href="#CenterRefinement.ref_interactive-3303"><span class="linenos">3303</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3304"><a href="#CenterRefinement.ref_interactive-3304"><span class="linenos">3304</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3305"><a href="#CenterRefinement.ref_interactive-3305"><span class="linenos">3305</span></a>        
</span><span id="CenterRefinement.ref_interactive-3306"><a href="#CenterRefinement.ref_interactive-3306"><span class="linenos">3306</span></a>        <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterRefinement.ref_interactive-3307"><a href="#CenterRefinement.ref_interactive-3307"><span class="linenos">3307</span></a>            <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">pr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3308"><a href="#CenterRefinement.ref_interactive-3308"><span class="linenos">3308</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3309"><a href="#CenterRefinement.ref_interactive-3309"><span class="linenos">3309</span></a>
</span><span id="CenterRefinement.ref_interactive-3310"><a href="#CenterRefinement.ref_interactive-3310"><span class="linenos">3310</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterRefinement.ref_interactive-3311"><a href="#CenterRefinement.ref_interactive-3311"><span class="linenos">3311</span></a>        <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3312"><a href="#CenterRefinement.ref_interactive-3312"><span class="linenos">3312</span></a>                    
</span><span id="CenterRefinement.ref_interactive-3313"><a href="#CenterRefinement.ref_interactive-3313"><span class="linenos">3313</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the center position.&#39;</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-3314"><a href="#CenterRefinement.ref_interactive-3314"><span class="linenos">3314</span></a>                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3315"><a href="#CenterRefinement.ref_interactive-3315"><span class="linenos">3315</span></a>
</span><span id="CenterRefinement.ref_interactive-3316"><a href="#CenterRefinement.ref_interactive-3316"><span class="linenos">3316</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3317"><a href="#CenterRefinement.ref_interactive-3317"><span class="linenos">3317</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3318"><a href="#CenterRefinement.ref_interactive-3318"><span class="linenos">3318</span></a>        
</span><span id="CenterRefinement.ref_interactive-3319"><a href="#CenterRefinement.ref_interactive-3319"><span class="linenos">3319</span></a>        <span class="c1"># (4) Enable interactive mode -----------------------------------------</span>
</span><span id="CenterRefinement.ref_interactive-3320"><a href="#CenterRefinement.ref_interactive-3320"><span class="linenos">3320</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-3321"><a href="#CenterRefinement.ref_interactive-3321"><span class="linenos">3321</span></a>        
</span><span id="CenterRefinement.ref_interactive-3322"><a href="#CenterRefinement.ref_interactive-3322"><span class="linenos">3322</span></a>
</span><span id="CenterRefinement.ref_interactive-3323"><a href="#CenterRefinement.ref_interactive-3323"><span class="linenos">3323</span></a>        <span class="c1"># (5) Display the image -----------------------------------------------</span>
</span><span id="CenterRefinement.ref_interactive-3324"><a href="#CenterRefinement.ref_interactive-3324"><span class="linenos">3324</span></a>        <span class="c1"># fig.set_size_inches(self.fig_width, self.fig_height)</span>
</span><span id="CenterRefinement.ref_interactive-3325"><a href="#CenterRefinement.ref_interactive-3325"><span class="linenos">3325</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3326"><a href="#CenterRefinement.ref_interactive-3326"><span class="linenos">3326</span></a>        
</span><span id="CenterRefinement.ref_interactive-3327"><a href="#CenterRefinement.ref_interactive-3327"><span class="linenos">3327</span></a>        <span class="c1"># (6) Define the event handler for figure close event -----------------</span>
</span><span id="CenterRefinement.ref_interactive-3328"><a href="#CenterRefinement.ref_interactive-3328"><span class="linenos">3328</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-3329"><a href="#CenterRefinement.ref_interactive-3329"><span class="linenos">3329</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement.ref_interactive-3330"><a href="#CenterRefinement.ref_interactive-3330"><span class="linenos">3330</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement.ref_interactive-3331"><a href="#CenterRefinement.ref_interactive-3331"><span class="linenos">3331</span></a> 
</span><span id="CenterRefinement.ref_interactive-3332"><a href="#CenterRefinement.ref_interactive-3332"><span class="linenos">3332</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterRefinement.ref_interactive-3333"><a href="#CenterRefinement.ref_interactive-3333"><span class="linenos">3333</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3334"><a href="#CenterRefinement.ref_interactive-3334"><span class="linenos">3334</span></a>
</span><span id="CenterRefinement.ref_interactive-3335"><a href="#CenterRefinement.ref_interactive-3335"><span class="linenos">3335</span></a>        <span class="c1"># (7) Define the callback function for key press events ---------------</span>
</span><span id="CenterRefinement.ref_interactive-3336"><a href="#CenterRefinement.ref_interactive-3336"><span class="linenos">3336</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-3337"><a href="#CenterRefinement.ref_interactive-3337"><span class="linenos">3337</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterRefinement.ref_interactive-3338"><a href="#CenterRefinement.ref_interactive-3338"><span class="linenos">3338</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement.ref_interactive-3339"><a href="#CenterRefinement.ref_interactive-3339"><span class="linenos">3339</span></a>        
</span><span id="CenterRefinement.ref_interactive-3340"><a href="#CenterRefinement.ref_interactive-3340"><span class="linenos">3340</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterRefinement.ref_interactive-3341"><a href="#CenterRefinement.ref_interactive-3341"><span class="linenos">3341</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterRefinement.ref_interactive-3342"><a href="#CenterRefinement.ref_interactive-3342"><span class="linenos">3342</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterRefinement.ref_interactive-3343"><a href="#CenterRefinement.ref_interactive-3343"><span class="linenos">3343</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterRefinement.ref_interactive-3344"><a href="#CenterRefinement.ref_interactive-3344"><span class="linenos">3344</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterRefinement.ref_interactive-3345"><a href="#CenterRefinement.ref_interactive-3345"><span class="linenos">3345</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterRefinement.ref_interactive-3346"><a href="#CenterRefinement.ref_interactive-3346"><span class="linenos">3346</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterRefinement.ref_interactive-3347"><a href="#CenterRefinement.ref_interactive-3347"><span class="linenos">3347</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterRefinement.ref_interactive-3348"><a href="#CenterRefinement.ref_interactive-3348"><span class="linenos">3348</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterRefinement.ref_interactive-3349"><a href="#CenterRefinement.ref_interactive-3349"><span class="linenos">3349</span></a>        
</span><span id="CenterRefinement.ref_interactive-3350"><a href="#CenterRefinement.ref_interactive-3350"><span class="linenos">3350</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterRefinement.ref_interactive-3351"><a href="#CenterRefinement.ref_interactive-3351"><span class="linenos">3351</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterRefinement.ref_interactive-3352"><a href="#CenterRefinement.ref_interactive-3352"><span class="linenos">3352</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterRefinement.ref_interactive-3353"><a href="#CenterRefinement.ref_interactive-3353"><span class="linenos">3353</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3354"><a href="#CenterRefinement.ref_interactive-3354"><span class="linenos">3354</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterRefinement.ref_interactive-3355"><a href="#CenterRefinement.ref_interactive-3355"><span class="linenos">3355</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3356"><a href="#CenterRefinement.ref_interactive-3356"><span class="linenos">3356</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-3357"><a href="#CenterRefinement.ref_interactive-3357"><span class="linenos">3357</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3358"><a href="#CenterRefinement.ref_interactive-3358"><span class="linenos">3358</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-3359"><a href="#CenterRefinement.ref_interactive-3359"><span class="linenos">3359</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3360"><a href="#CenterRefinement.ref_interactive-3360"><span class="linenos">3360</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-3361"><a href="#CenterRefinement.ref_interactive-3361"><span class="linenos">3361</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3362"><a href="#CenterRefinement.ref_interactive-3362"><span class="linenos">3362</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-3363"><a href="#CenterRefinement.ref_interactive-3363"><span class="linenos">3363</span></a>                    
</span><span id="CenterRefinement.ref_interactive-3364"><a href="#CenterRefinement.ref_interactive-3364"><span class="linenos">3364</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterRefinement.ref_interactive-3365"><a href="#CenterRefinement.ref_interactive-3365"><span class="linenos">3365</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3366"><a href="#CenterRefinement.ref_interactive-3366"><span class="linenos">3366</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-3367"><a href="#CenterRefinement.ref_interactive-3367"><span class="linenos">3367</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3368"><a href="#CenterRefinement.ref_interactive-3368"><span class="linenos">3368</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3369"><a href="#CenterRefinement.ref_interactive-3369"><span class="linenos">3369</span></a>            
</span><span id="CenterRefinement.ref_interactive-3370"><a href="#CenterRefinement.ref_interactive-3370"><span class="linenos">3370</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterRefinement.ref_interactive-3371"><a href="#CenterRefinement.ref_interactive-3371"><span class="linenos">3371</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3372"><a href="#CenterRefinement.ref_interactive-3372"><span class="linenos">3372</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement.ref_interactive-3373"><a href="#CenterRefinement.ref_interactive-3373"><span class="linenos">3373</span></a>        
</span><span id="CenterRefinement.ref_interactive-3374"><a href="#CenterRefinement.ref_interactive-3374"><span class="linenos">3374</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterRefinement.ref_interactive-3375"><a href="#CenterRefinement.ref_interactive-3375"><span class="linenos">3375</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3376"><a href="#CenterRefinement.ref_interactive-3376"><span class="linenos">3376</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterRefinement.ref_interactive-3377"><a href="#CenterRefinement.ref_interactive-3377"><span class="linenos">3377</span></a>        
</span><span id="CenterRefinement.ref_interactive-3378"><a href="#CenterRefinement.ref_interactive-3378"><span class="linenos">3378</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3379"><a href="#CenterRefinement.ref_interactive-3379"><span class="linenos">3379</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterRefinement.ref_interactive-3380"><a href="#CenterRefinement.ref_interactive-3380"><span class="linenos">3380</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3381"><a href="#CenterRefinement.ref_interactive-3381"><span class="linenos">3381</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterRefinement.ref_interactive-3382"><a href="#CenterRefinement.ref_interactive-3382"><span class="linenos">3382</span></a>        
</span><span id="CenterRefinement.ref_interactive-3383"><a href="#CenterRefinement.ref_interactive-3383"><span class="linenos">3383</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterRefinement.ref_interactive-3384"><a href="#CenterRefinement.ref_interactive-3384"><span class="linenos">3384</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterRefinement.ref_interactive-3385"><a href="#CenterRefinement.ref_interactive-3385"><span class="linenos">3385</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterRefinement.ref_interactive-3386"><a href="#CenterRefinement.ref_interactive-3386"><span class="linenos">3386</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterRefinement.ref_interactive-3387"><a href="#CenterRefinement.ref_interactive-3387"><span class="linenos">3387</span></a>        
</span><span id="CenterRefinement.ref_interactive-3388"><a href="#CenterRefinement.ref_interactive-3388"><span class="linenos">3388</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3389"><a href="#CenterRefinement.ref_interactive-3389"><span class="linenos">3389</span></a>        
</span><span id="CenterRefinement.ref_interactive-3390"><a href="#CenterRefinement.ref_interactive-3390"><span class="linenos">3390</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterRefinement.ref_interactive-3391"><a href="#CenterRefinement.ref_interactive-3391"><span class="linenos">3391</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-3392"><a href="#CenterRefinement.ref_interactive-3392"><span class="linenos">3392</span></a>
</span><span id="CenterRefinement.ref_interactive-3393"><a href="#CenterRefinement.ref_interactive-3393"><span class="linenos">3393</span></a>            
</span><span id="CenterRefinement.ref_interactive-3394"><a href="#CenterRefinement.ref_interactive-3394"><span class="linenos">3394</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterRefinement.ref_interactive-3395"><a href="#CenterRefinement.ref_interactive-3395"><span class="linenos">3395</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3396"><a href="#CenterRefinement.ref_interactive-3396"><span class="linenos">3396</span></a>        
</span><span id="CenterRefinement.ref_interactive-3397"><a href="#CenterRefinement.ref_interactive-3397"><span class="linenos">3397</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterRefinement.ref_interactive-3398"><a href="#CenterRefinement.ref_interactive-3398"><span class="linenos">3398</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3399"><a href="#CenterRefinement.ref_interactive-3399"><span class="linenos">3399</span></a>
</span><span id="CenterRefinement.ref_interactive-3400"><a href="#CenterRefinement.ref_interactive-3400"><span class="linenos">3400</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterRefinement.ref_interactive-3401"><a href="#CenterRefinement.ref_interactive-3401"><span class="linenos">3401</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterRefinement.ref_interactive-3402"><a href="#CenterRefinement.ref_interactive-3402"><span class="linenos">3402</span></a>               
</span><span id="CenterRefinement.ref_interactive-3403"><a href="#CenterRefinement.ref_interactive-3403"><span class="linenos">3403</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterRefinement.ref_interactive-3404"><a href="#CenterRefinement.ref_interactive-3404"><span class="linenos">3404</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3405"><a href="#CenterRefinement.ref_interactive-3405"><span class="linenos">3405</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3406"><a href="#CenterRefinement.ref_interactive-3406"><span class="linenos">3406</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3407"><a href="#CenterRefinement.ref_interactive-3407"><span class="linenos">3407</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-3408"><a href="#CenterRefinement.ref_interactive-3408"><span class="linenos">3408</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterRefinement.ref_interactive-3409"><a href="#CenterRefinement.ref_interactive-3409"><span class="linenos">3409</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement.ref_interactive-3410"><a href="#CenterRefinement.ref_interactive-3410"><span class="linenos">3410</span></a>         
</span><span id="CenterRefinement.ref_interactive-3411"><a href="#CenterRefinement.ref_interactive-3411"><span class="linenos">3411</span></a>        <span class="c1"># (8) Turn off interactive mode ---------------------------------------</span>
</span><span id="CenterRefinement.ref_interactive-3412"><a href="#CenterRefinement.ref_interactive-3412"><span class="linenos">3412</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-3413"><a href="#CenterRefinement.ref_interactive-3413"><span class="linenos">3413</span></a>        
</span><span id="CenterRefinement.ref_interactive-3414"><a href="#CenterRefinement.ref_interactive-3414"><span class="linenos">3414</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterRefinement.ref_interactive-3415"><a href="#CenterRefinement.ref_interactive-3415"><span class="linenos">3415</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-3416"><a href="#CenterRefinement.ref_interactive-3416"><span class="linenos">3416</span></a>
</span><span id="CenterRefinement.ref_interactive-3417"><a href="#CenterRefinement.ref_interactive-3417"><span class="linenos">3417</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-3418"><a href="#CenterRefinement.ref_interactive-3418"><span class="linenos">3418</span></a>        
</span><span id="CenterRefinement.ref_interactive-3419"><a href="#CenterRefinement.ref_interactive-3419"><span class="linenos">3419</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterRefinement.ref_interactive-3420"><a href="#CenterRefinement.ref_interactive-3420"><span class="linenos">3420</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterRefinement.ref_interactive-3421"><a href="#CenterRefinement.ref_interactive-3421"><span class="linenos">3421</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterRefinement.ref_interactive-3422"><a href="#CenterRefinement.ref_interactive-3422"><span class="linenos">3422</span></a>
</span><span id="CenterRefinement.ref_interactive-3423"><a href="#CenterRefinement.ref_interactive-3423"><span class="linenos">3423</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterRefinement.ref_interactive-3424"><a href="#CenterRefinement.ref_interactive-3424"><span class="linenos">3424</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-3425"><a href="#CenterRefinement.ref_interactive-3425"><span class="linenos">3425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement.ref_interactive-3426"><a href="#CenterRefinement.ref_interactive-3426"><span class="linenos">3426</span></a>
</span><span id="CenterRefinement.ref_interactive-3427"><a href="#CenterRefinement.ref_interactive-3427"><span class="linenos">3427</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>    
</span></pre></div>


            <div class="docstring"><p>Manual/interactive refinement of the diffraction pattern center.</p>

<p>This method allows the user to fine-tune the estimated center
and radius of a diffraction ring through interactive keyboard controls.</p>

<p>An new window is opened and the user can adjust the position
of the diffraction ring using the following keys (keyboard controls):</p>

<ul>
<li>Arrow keys (←, →, ↑, ↓): Move the center left, right, up, or down</li>
<li>'+' : Increase the radius</li>
<li>'-' : Decrease the radius</li>
<li>'b' : Increase step size (×5)</li>
<li>'l' : Decrease step size (/5, with minimum step size 0.5)</li>
<li>'d' : Done — finalize the center and radius</li>
<li>Closing the figure: Cancels refinement and returns the original input 
center and radius</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fig</strong> (matplotlib.figure.Figure):
The figure window used for interactive refinement.</li>
<li><strong>circle</strong> (matplotlib.patches.Circle):
The circle object known from
the previous step = from the center determination.</li>
<li><strong>center</strong> (tuple):
The initial (x, y) center coordinates from
the previous step = from the center determination.</li>
<li><strong>plot_results</strong> (bool, optional, default=False):
If True, the results of the adjustment are visualized.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xy[0]</strong> (float):
x-coordinate of the adjusted center of the diffraction pattern.</li>
<li><strong>xy[1]</strong> (float):
y-coordinate of the adjusted center of the diffraction pattern.</li>
<li><strong>r</strong> (float):
Adjusted radius of the diffraction ring.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>Interactive adjustments are visualized in real time.</li>
<li>Intensity sum at the current center/radius is printed
if <em>print_sums</em> argument is True.</li>
<li>Arrow key defaults in Matplotlib (e.g., navigation)
are temporarily disabled to allow movement control.</li>
</ul>
</div>


                            </div>
                            <div id="CenterRefinement.ref_var" class="classattr">
                                        <input id="CenterRefinement.ref_var-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ref_var</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterRefinement.ref_var-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement.ref_var"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement.ref_var-3430"><a href="#CenterRefinement.ref_var-3430"><span class="linenos">3430</span></a>    <span class="k">def</span> <span class="nf">ref_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_var-3431"><a href="#CenterRefinement.ref_var-3431"><span class="linenos">3431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_var-3432"><a href="#CenterRefinement.ref_var-3432"><span class="linenos">3432</span></a><span class="sd">        Refine the center coordinates (px, py) and radius (pr) of a circular </span>
</span><span id="CenterRefinement.ref_var-3433"><a href="#CenterRefinement.ref_var-3433"><span class="linenos">3433</span></a><span class="sd">        diffraction pattern by minimizing the variance of pixel intensities </span>
</span><span id="CenterRefinement.ref_var-3434"><a href="#CenterRefinement.ref_var-3434"><span class="linenos">3434</span></a><span class="sd">        along the circle&#39;s border.</span>
</span><span id="CenterRefinement.ref_var-3435"><a href="#CenterRefinement.ref_var-3435"><span class="linenos">3435</span></a>
</span><span id="CenterRefinement.ref_var-3436"><a href="#CenterRefinement.ref_var-3436"><span class="linenos">3436</span></a><span class="sd">        This method performs iterative local search in the 8-neighbourhood </span>
</span><span id="CenterRefinement.ref_var-3437"><a href="#CenterRefinement.ref_var-3437"><span class="linenos">3437</span></a><span class="sd">        around the current center to find a position and radius that minimize </span>
</span><span id="CenterRefinement.ref_var-3438"><a href="#CenterRefinement.ref_var-3438"><span class="linenos">3438</span></a><span class="sd">        the intensity variance. The refinement stops when convergence criteria </span>
</span><span id="CenterRefinement.ref_var-3439"><a href="#CenterRefinement.ref_var-3439"><span class="linenos">3439</span></a><span class="sd">        are met or after a maximum number of iterations.</span>
</span><span id="CenterRefinement.ref_var-3440"><a href="#CenterRefinement.ref_var-3440"><span class="linenos">3440</span></a>
</span><span id="CenterRefinement.ref_var-3441"><a href="#CenterRefinement.ref_var-3441"><span class="linenos">3441</span></a><span class="sd">        Neighborhood pattern tested (o = current center, x = candidate center):</span>
</span><span id="CenterRefinement.ref_var-3442"><a href="#CenterRefinement.ref_var-3442"><span class="linenos">3442</span></a><span class="sd">            x x x   --&gt; (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)</span>
</span><span id="CenterRefinement.ref_var-3443"><a href="#CenterRefinement.ref_var-3443"><span class="linenos">3443</span></a><span class="sd">            x o x   --&gt; (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement.ref_var-3444"><a href="#CenterRefinement.ref_var-3444"><span class="linenos">3444</span></a><span class="sd">            x x x   --&gt; (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement.ref_var-3445"><a href="#CenterRefinement.ref_var-3445"><span class="linenos">3445</span></a>
</span><span id="CenterRefinement.ref_var-3446"><a href="#CenterRefinement.ref_var-3446"><span class="linenos">3446</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement.ref_var-3447"><a href="#CenterRefinement.ref_var-3447"><span class="linenos">3447</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement.ref_var-3448"><a href="#CenterRefinement.ref_var-3448"><span class="linenos">3448</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement.ref_var-3449"><a href="#CenterRefinement.ref_var-3449"><span class="linenos">3449</span></a><span class="sd">            Initial x-coordinate of the detected center.</span>
</span><span id="CenterRefinement.ref_var-3450"><a href="#CenterRefinement.ref_var-3450"><span class="linenos">3450</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_var-3451"><a href="#CenterRefinement.ref_var-3451"><span class="linenos">3451</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement.ref_var-3452"><a href="#CenterRefinement.ref_var-3452"><span class="linenos">3452</span></a><span class="sd">            Initial y-coordinate of the detected center.</span>
</span><span id="CenterRefinement.ref_var-3453"><a href="#CenterRefinement.ref_var-3453"><span class="linenos">3453</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_var-3454"><a href="#CenterRefinement.ref_var-3454"><span class="linenos">3454</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement.ref_var-3455"><a href="#CenterRefinement.ref_var-3455"><span class="linenos">3455</span></a><span class="sd">            Initial radius of the detected circular pattern.</span>
</span><span id="CenterRefinement.ref_var-3456"><a href="#CenterRefinement.ref_var-3456"><span class="linenos">3456</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_var-3457"><a href="#CenterRefinement.ref_var-3457"><span class="linenos">3457</span></a><span class="sd">        plot_results : int, optional (default=0)</span>
</span><span id="CenterRefinement.ref_var-3458"><a href="#CenterRefinement.ref_var-3458"><span class="linenos">3458</span></a><span class="sd">            Whether to plot the refinement result (1 = yes, 0 = no).</span>
</span><span id="CenterRefinement.ref_var-3459"><a href="#CenterRefinement.ref_var-3459"><span class="linenos">3459</span></a>
</span><span id="CenterRefinement.ref_var-3460"><a href="#CenterRefinement.ref_var-3460"><span class="linenos">3460</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement.ref_var-3461"><a href="#CenterRefinement.ref_var-3461"><span class="linenos">3461</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement.ref_var-3462"><a href="#CenterRefinement.ref_var-3462"><span class="linenos">3462</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement.ref_var-3463"><a href="#CenterRefinement.ref_var-3463"><span class="linenos">3463</span></a><span class="sd">            Refined x-coordinate of the center.</span>
</span><span id="CenterRefinement.ref_var-3464"><a href="#CenterRefinement.ref_var-3464"><span class="linenos">3464</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_var-3465"><a href="#CenterRefinement.ref_var-3465"><span class="linenos">3465</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement.ref_var-3466"><a href="#CenterRefinement.ref_var-3466"><span class="linenos">3466</span></a><span class="sd">            Refined y-coordinate of the center.</span>
</span><span id="CenterRefinement.ref_var-3467"><a href="#CenterRefinement.ref_var-3467"><span class="linenos">3467</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_var-3468"><a href="#CenterRefinement.ref_var-3468"><span class="linenos">3468</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement.ref_var-3469"><a href="#CenterRefinement.ref_var-3469"><span class="linenos">3469</span></a><span class="sd">            Refined radius of the circular pattern.</span>
</span><span id="CenterRefinement.ref_var-3470"><a href="#CenterRefinement.ref_var-3470"><span class="linenos">3470</span></a>
</span><span id="CenterRefinement.ref_var-3471"><a href="#CenterRefinement.ref_var-3471"><span class="linenos">3471</span></a><span class="sd">        Notes</span>
</span><span id="CenterRefinement.ref_var-3472"><a href="#CenterRefinement.ref_var-3472"><span class="linenos">3472</span></a><span class="sd">        -----</span>
</span><span id="CenterRefinement.ref_var-3473"><a href="#CenterRefinement.ref_var-3473"><span class="linenos">3473</span></a><span class="sd">        - The function avoids overfitting to local minima by enforcing </span>
</span><span id="CenterRefinement.ref_var-3474"><a href="#CenterRefinement.ref_var-3474"><span class="linenos">3474</span></a><span class="sd">          convergence thresholds and consistency checks.</span>
</span><span id="CenterRefinement.ref_var-3475"><a href="#CenterRefinement.ref_var-3475"><span class="linenos">3475</span></a><span class="sd">        - If the refinement worsens the initial variance significantly or </span>
</span><span id="CenterRefinement.ref_var-3476"><a href="#CenterRefinement.ref_var-3476"><span class="linenos">3476</span></a><span class="sd">          suggests an invalid coordinate swap, the original input is preserved.</span>
</span><span id="CenterRefinement.ref_var-3477"><a href="#CenterRefinement.ref_var-3477"><span class="linenos">3477</span></a><span class="sd">        - Uses `self.parent.intensity_variance()` for evaluating the criterion.</span>
</span><span id="CenterRefinement.ref_var-3478"><a href="#CenterRefinement.ref_var-3478"><span class="linenos">3478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_var-3479"><a href="#CenterRefinement.ref_var-3479"><span class="linenos">3479</span></a>        
</span><span id="CenterRefinement.ref_var-3480"><a href="#CenterRefinement.ref_var-3480"><span class="linenos">3480</span></a>        <span class="c1"># Store input for plot</span>
</span><span id="CenterRefinement.ref_var-3481"><a href="#CenterRefinement.ref_var-3481"><span class="linenos">3481</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_var-3482"><a href="#CenterRefinement.ref_var-3482"><span class="linenos">3482</span></a>        
</span><span id="CenterRefinement.ref_var-3483"><a href="#CenterRefinement.ref_var-3483"><span class="linenos">3483</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterRefinement.ref_var-3484"><a href="#CenterRefinement.ref_var-3484"><span class="linenos">3484</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3485"><a href="#CenterRefinement.ref_var-3485"><span class="linenos">3485</span></a>
</span><span id="CenterRefinement.ref_var-3486"><a href="#CenterRefinement.ref_var-3486"><span class="linenos">3486</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement.ref_var-3487"><a href="#CenterRefinement.ref_var-3487"><span class="linenos">3487</span></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3488"><a href="#CenterRefinement.ref_var-3488"><span class="linenos">3488</span></a>        <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3489"><a href="#CenterRefinement.ref_var-3489"><span class="linenos">3489</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-3490"><a href="#CenterRefinement.ref_var-3490"><span class="linenos">3490</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3491"><a href="#CenterRefinement.ref_var-3491"><span class="linenos">3491</span></a>    
</span><span id="CenterRefinement.ref_var-3492"><a href="#CenterRefinement.ref_var-3492"><span class="linenos">3492</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement.ref_var-3493"><a href="#CenterRefinement.ref_var-3493"><span class="linenos">3493</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement.ref_var-3494"><a href="#CenterRefinement.ref_var-3494"><span class="linenos">3494</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement.ref_var-3495"><a href="#CenterRefinement.ref_var-3495"><span class="linenos">3495</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">min_intensity_var</span>
</span><span id="CenterRefinement.ref_var-3496"><a href="#CenterRefinement.ref_var-3496"><span class="linenos">3496</span></a>        
</span><span id="CenterRefinement.ref_var-3497"><a href="#CenterRefinement.ref_var-3497"><span class="linenos">3497</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement.ref_var-3498"><a href="#CenterRefinement.ref_var-3498"><span class="linenos">3498</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="CenterRefinement.ref_var-3499"><a href="#CenterRefinement.ref_var-3499"><span class="linenos">3499</span></a>        
</span><span id="CenterRefinement.ref_var-3500"><a href="#CenterRefinement.ref_var-3500"><span class="linenos">3500</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement.ref_var-3501"><a href="#CenterRefinement.ref_var-3501"><span class="linenos">3501</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement.ref_var-3502"><a href="#CenterRefinement.ref_var-3502"><span class="linenos">3502</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement.ref_var-3503"><a href="#CenterRefinement.ref_var-3503"><span class="linenos">3503</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement.ref_var-3504"><a href="#CenterRefinement.ref_var-3504"><span class="linenos">3504</span></a>    
</span><span id="CenterRefinement.ref_var-3505"><a href="#CenterRefinement.ref_var-3505"><span class="linenos">3505</span></a>    
</span><span id="CenterRefinement.ref_var-3506"><a href="#CenterRefinement.ref_var-3506"><span class="linenos">3506</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement.ref_var-3507"><a href="#CenterRefinement.ref_var-3507"><span class="linenos">3507</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement.ref_var-3508"><a href="#CenterRefinement.ref_var-3508"><span class="linenos">3508</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="CenterRefinement.ref_var-3509"><a href="#CenterRefinement.ref_var-3509"><span class="linenos">3509</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-3510"><a href="#CenterRefinement.ref_var-3510"><span class="linenos">3510</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3511"><a href="#CenterRefinement.ref_var-3511"><span class="linenos">3511</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_var-3512"><a href="#CenterRefinement.ref_var-3512"><span class="linenos">3512</span></a>        
</span><span id="CenterRefinement.ref_var-3513"><a href="#CenterRefinement.ref_var-3513"><span class="linenos">3513</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement.ref_var-3514"><a href="#CenterRefinement.ref_var-3514"><span class="linenos">3514</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement.ref_var-3515"><a href="#CenterRefinement.ref_var-3515"><span class="linenos">3515</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_var-3516"><a href="#CenterRefinement.ref_var-3516"><span class="linenos">3516</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-3517"><a href="#CenterRefinement.ref_var-3517"><span class="linenos">3517</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-3518"><a href="#CenterRefinement.ref_var-3518"><span class="linenos">3518</span></a>                                      <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement.ref_var-3519"><a href="#CenterRefinement.ref_var-3519"><span class="linenos">3519</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement.ref_var-3520"><a href="#CenterRefinement.ref_var-3520"><span class="linenos">3520</span></a>            <span class="n">curr_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_var-3521"><a href="#CenterRefinement.ref_var-3521"><span class="linenos">3521</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-3522"><a href="#CenterRefinement.ref_var-3522"><span class="linenos">3522</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement.ref_var-3523"><a href="#CenterRefinement.ref_var-3523"><span class="linenos">3523</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement.ref_var-3524"><a href="#CenterRefinement.ref_var-3524"><span class="linenos">3524</span></a>                <span class="n">curr_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="CenterRefinement.ref_var-3525"><a href="#CenterRefinement.ref_var-3525"><span class="linenos">3525</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-3526"><a href="#CenterRefinement.ref_var-3526"><span class="linenos">3526</span></a>            
</span><span id="CenterRefinement.ref_var-3527"><a href="#CenterRefinement.ref_var-3527"><span class="linenos">3527</span></a>            <span class="c1"># Find the minimum value coordinates within curr_intensity_var</span>
</span><span id="CenterRefinement.ref_var-3528"><a href="#CenterRefinement.ref_var-3528"><span class="linenos">3528</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_var-3529"><a href="#CenterRefinement.ref_var-3529"><span class="linenos">3529</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_var-3530"><a href="#CenterRefinement.ref_var-3530"><span class="linenos">3530</span></a>                    
</span><span id="CenterRefinement.ref_var-3531"><a href="#CenterRefinement.ref_var-3531"><span class="linenos">3531</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="CenterRefinement.ref_var-3532"><a href="#CenterRefinement.ref_var-3532"><span class="linenos">3532</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="CenterRefinement.ref_var-3533"><a href="#CenterRefinement.ref_var-3533"><span class="linenos">3533</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement.ref_var-3534"><a href="#CenterRefinement.ref_var-3534"><span class="linenos">3534</span></a>            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_intensity_var</span><span class="p">:</span>                           
</span><span id="CenterRefinement.ref_var-3535"><a href="#CenterRefinement.ref_var-3535"><span class="linenos">3535</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3536"><a href="#CenterRefinement.ref_var-3536"><span class="linenos">3536</span></a>                
</span><span id="CenterRefinement.ref_var-3537"><a href="#CenterRefinement.ref_var-3537"><span class="linenos">3537</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement.ref_var-3538"><a href="#CenterRefinement.ref_var-3538"><span class="linenos">3538</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_var-3539"><a href="#CenterRefinement.ref_var-3539"><span class="linenos">3539</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement.ref_var-3540"><a href="#CenterRefinement.ref_var-3540"><span class="linenos">3540</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-3541"><a href="#CenterRefinement.ref_var-3541"><span class="linenos">3541</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-3542"><a href="#CenterRefinement.ref_var-3542"><span class="linenos">3542</span></a>                
</span><span id="CenterRefinement.ref_var-3543"><a href="#CenterRefinement.ref_var-3543"><span class="linenos">3543</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement.ref_var-3544"><a href="#CenterRefinement.ref_var-3544"><span class="linenos">3544</span></a>            <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_var-3545"><a href="#CenterRefinement.ref_var-3545"><span class="linenos">3545</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-3546"><a href="#CenterRefinement.ref_var-3546"><span class="linenos">3546</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-3547"><a href="#CenterRefinement.ref_var-3547"><span class="linenos">3547</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement.ref_var-3548"><a href="#CenterRefinement.ref_var-3548"><span class="linenos">3548</span></a>            
</span><span id="CenterRefinement.ref_var-3549"><a href="#CenterRefinement.ref_var-3549"><span class="linenos">3549</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement.ref_var-3550"><a href="#CenterRefinement.ref_var-3550"><span class="linenos">3550</span></a>            <span class="c1"># constant. It iterates through different radius adjustments</span>
</span><span id="CenterRefinement.ref_var-3551"><a href="#CenterRefinement.ref_var-3551"><span class="linenos">3551</span></a>            <span class="c1"># to find a radius that maximizes the intensity sum of pixels.</span>
</span><span id="CenterRefinement.ref_var-3552"><a href="#CenterRefinement.ref_var-3552"><span class="linenos">3552</span></a>            
</span><span id="CenterRefinement.ref_var-3553"><a href="#CenterRefinement.ref_var-3553"><span class="linenos">3553</span></a>            <span class="n">radi_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_var-3554"><a href="#CenterRefinement.ref_var-3554"><span class="linenos">3554</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3555"><a href="#CenterRefinement.ref_var-3555"><span class="linenos">3555</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-3556"><a href="#CenterRefinement.ref_var-3556"><span class="linenos">3556</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement.ref_var-3557"><a href="#CenterRefinement.ref_var-3557"><span class="linenos">3557</span></a>                <span class="n">radi_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_var-3558"><a href="#CenterRefinement.ref_var-3558"><span class="linenos">3558</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-3559"><a href="#CenterRefinement.ref_var-3559"><span class="linenos">3559</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-3560"><a href="#CenterRefinement.ref_var-3560"><span class="linenos">3560</span></a>                                                             <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-3561"><a href="#CenterRefinement.ref_var-3561"><span class="linenos">3561</span></a>                
</span><span id="CenterRefinement.ref_var-3562"><a href="#CenterRefinement.ref_var-3562"><span class="linenos">3562</span></a>            <span class="c1"># Find the minimum value coordinates within curr_var</span>
</span><span id="CenterRefinement.ref_var-3563"><a href="#CenterRefinement.ref_var-3563"><span class="linenos">3563</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_var-3564"><a href="#CenterRefinement.ref_var-3564"><span class="linenos">3564</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_var-3565"><a href="#CenterRefinement.ref_var-3565"><span class="linenos">3565</span></a>            
</span><span id="CenterRefinement.ref_var-3566"><a href="#CenterRefinement.ref_var-3566"><span class="linenos">3566</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement.ref_var-3567"><a href="#CenterRefinement.ref_var-3567"><span class="linenos">3567</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_intensity_var</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-3568"><a href="#CenterRefinement.ref_var-3568"><span class="linenos">3568</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3569"><a href="#CenterRefinement.ref_var-3569"><span class="linenos">3569</span></a>                
</span><span id="CenterRefinement.ref_var-3570"><a href="#CenterRefinement.ref_var-3570"><span class="linenos">3570</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_var-3571"><a href="#CenterRefinement.ref_var-3571"><span class="linenos">3571</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement.ref_var-3572"><a href="#CenterRefinement.ref_var-3572"><span class="linenos">3572</span></a>                
</span><span id="CenterRefinement.ref_var-3573"><a href="#CenterRefinement.ref_var-3573"><span class="linenos">3573</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3574"><a href="#CenterRefinement.ref_var-3574"><span class="linenos">3574</span></a>
</span><span id="CenterRefinement.ref_var-3575"><a href="#CenterRefinement.ref_var-3575"><span class="linenos">3575</span></a>            
</span><span id="CenterRefinement.ref_var-3576"><a href="#CenterRefinement.ref_var-3576"><span class="linenos">3576</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement.ref_var-3577"><a href="#CenterRefinement.ref_var-3577"><span class="linenos">3577</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_intensity_var</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3578"><a href="#CenterRefinement.ref_var-3578"><span class="linenos">3578</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-3579"><a href="#CenterRefinement.ref_var-3579"><span class="linenos">3579</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement.ref_var-3580"><a href="#CenterRefinement.ref_var-3580"><span class="linenos">3580</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-3581"><a href="#CenterRefinement.ref_var-3581"><span class="linenos">3581</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement.ref_var-3582"><a href="#CenterRefinement.ref_var-3582"><span class="linenos">3582</span></a>        
</span><span id="CenterRefinement.ref_var-3583"><a href="#CenterRefinement.ref_var-3583"><span class="linenos">3583</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement.ref_var-3584"><a href="#CenterRefinement.ref_var-3584"><span class="linenos">3584</span></a>        <span class="c1">## (1) swapped coordinates</span>
</span><span id="CenterRefinement.ref_var-3585"><a href="#CenterRefinement.ref_var-3585"><span class="linenos">3585</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_var-3586"><a href="#CenterRefinement.ref_var-3586"><span class="linenos">3586</span></a>            <span class="ow">or</span>  <span class="p">(</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="CenterRefinement.ref_var-3587"><a href="#CenterRefinement.ref_var-3587"><span class="linenos">3587</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_var-3588"><a href="#CenterRefinement.ref_var-3588"><span class="linenos">3588</span></a>        
</span><span id="CenterRefinement.ref_var-3589"><a href="#CenterRefinement.ref_var-3589"><span class="linenos">3589</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement.ref_var-3590"><a href="#CenterRefinement.ref_var-3590"><span class="linenos">3590</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_intensity_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_var-3591"><a href="#CenterRefinement.ref_var-3591"><span class="linenos">3591</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3592"><a href="#CenterRefinement.ref_var-3592"><span class="linenos">3592</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-3593"><a href="#CenterRefinement.ref_var-3593"><span class="linenos">3593</span></a>    
</span><span id="CenterRefinement.ref_var-3594"><a href="#CenterRefinement.ref_var-3594"><span class="linenos">3594</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement.ref_var-3595"><a href="#CenterRefinement.ref_var-3595"><span class="linenos">3595</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_var-3596"><a href="#CenterRefinement.ref_var-3596"><span class="linenos">3596</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement.ref_var-3597"><a href="#CenterRefinement.ref_var-3597"><span class="linenos">3597</span></a>                <span class="s2">&quot;Center Refinement (IntensityVar)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement.ref_var-3598"><a href="#CenterRefinement.ref_var-3598"><span class="linenos">3598</span></a>                                  
</span><span id="CenterRefinement.ref_var-3599"><a href="#CenterRefinement.ref_var-3599"><span class="linenos">3599</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span></pre></div>


            <div class="docstring"><p>Refine the center coordinates (px, py) and radius (pr) of a circular 
diffraction pattern by minimizing the variance of pixel intensities 
along the circle's border.</p>

<p>This method performs iterative local search in the 8-neighbourhood 
around the current center to find a position and radius that minimize 
the intensity variance. The refinement stops when convergence criteria 
are met or after a maximum number of iterations.</p>

<p>Neighborhood pattern tested (o = current center, x = candidate center):
    x x x   --> (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)
    x o x   --> (px - dx, py)      (px, py)      (px + dx, py)
    x x x   --> (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>px</strong> (float):
Initial x-coordinate of the detected center.</li>
<li><strong>py</strong> (float):
Initial y-coordinate of the detected center.</li>
<li><strong>pr</strong> (float):
Initial radius of the detected circular pattern.</li>
<li><strong>plot_results</strong> (int, optional (default=0)):
Whether to plot the refinement result (1 = yes, 0 = no).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>px</strong> (float):
Refined x-coordinate of the center.</li>
<li><strong>py</strong> (float):
Refined y-coordinate of the center.</li>
<li><strong>pr</strong> (float):
Refined radius of the circular pattern.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The function avoids overfitting to local minima by enforcing 
convergence thresholds and consistency checks.</li>
<li>If the refinement worsens the initial variance significantly or 
suggests an invalid coordinate swap, the original input is preserved.</li>
<li>Uses <code>self.parent.intensity_variance()</code> for evaluating the criterion.</li>
</ul>
</div>


                            </div>
                            <div id="CenterRefinement.ref_sum" class="classattr">
                                        <input id="CenterRefinement.ref_sum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ref_sum</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterRefinement.ref_sum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement.ref_sum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement.ref_sum-3602"><a href="#CenterRefinement.ref_sum-3602"><span class="linenos">3602</span></a>    <span class="k">def</span> <span class="nf">ref_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">live_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_sum-3603"><a href="#CenterRefinement.ref_sum-3603"><span class="linenos">3603</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_sum-3604"><a href="#CenterRefinement.ref_sum-3604"><span class="linenos">3604</span></a><span class="sd">        Refine the center coordinates (px, py) and radius (pr) of a circular </span>
</span><span id="CenterRefinement.ref_sum-3605"><a href="#CenterRefinement.ref_sum-3605"><span class="linenos">3605</span></a><span class="sd">        diffraction pattern by maximizing the summed pixel intensity along </span>
</span><span id="CenterRefinement.ref_sum-3606"><a href="#CenterRefinement.ref_sum-3606"><span class="linenos">3606</span></a><span class="sd">        a circular ring.</span>
</span><span id="CenterRefinement.ref_sum-3607"><a href="#CenterRefinement.ref_sum-3607"><span class="linenos">3607</span></a>
</span><span id="CenterRefinement.ref_sum-3608"><a href="#CenterRefinement.ref_sum-3608"><span class="linenos">3608</span></a><span class="sd">        The method uses an iterative local search strategy based on gradient </span>
</span><span id="CenterRefinement.ref_sum-3609"><a href="#CenterRefinement.ref_sum-3609"><span class="linenos">3609</span></a><span class="sd">        ascent in the 8-neighbourhood around the current center to find </span>
</span><span id="CenterRefinement.ref_sum-3610"><a href="#CenterRefinement.ref_sum-3610"><span class="linenos">3610</span></a><span class="sd">        a position and radius that maximize the intensity sum. The center </span>
</span><span id="CenterRefinement.ref_sum-3611"><a href="#CenterRefinement.ref_sum-3611"><span class="linenos">3611</span></a><span class="sd">        is updated based on the best neighbor until convergence criteria </span>
</span><span id="CenterRefinement.ref_sum-3612"><a href="#CenterRefinement.ref_sum-3612"><span class="linenos">3612</span></a><span class="sd">        or maximum iteration limits are met.</span>
</span><span id="CenterRefinement.ref_sum-3613"><a href="#CenterRefinement.ref_sum-3613"><span class="linenos">3613</span></a>
</span><span id="CenterRefinement.ref_sum-3614"><a href="#CenterRefinement.ref_sum-3614"><span class="linenos">3614</span></a><span class="sd">        Neighborhood pattern tested (o = current center, x = candidate center):</span>
</span><span id="CenterRefinement.ref_sum-3615"><a href="#CenterRefinement.ref_sum-3615"><span class="linenos">3615</span></a><span class="sd">            x x x   --&gt; (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)</span>
</span><span id="CenterRefinement.ref_sum-3616"><a href="#CenterRefinement.ref_sum-3616"><span class="linenos">3616</span></a><span class="sd">            x o x   --&gt; (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement.ref_sum-3617"><a href="#CenterRefinement.ref_sum-3617"><span class="linenos">3617</span></a><span class="sd">            x x x   --&gt; (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement.ref_sum-3618"><a href="#CenterRefinement.ref_sum-3618"><span class="linenos">3618</span></a>
</span><span id="CenterRefinement.ref_sum-3619"><a href="#CenterRefinement.ref_sum-3619"><span class="linenos">3619</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement.ref_sum-3620"><a href="#CenterRefinement.ref_sum-3620"><span class="linenos">3620</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement.ref_sum-3621"><a href="#CenterRefinement.ref_sum-3621"><span class="linenos">3621</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement.ref_sum-3622"><a href="#CenterRefinement.ref_sum-3622"><span class="linenos">3622</span></a><span class="sd">            Initial x-coordinate of the detected center.</span>
</span><span id="CenterRefinement.ref_sum-3623"><a href="#CenterRefinement.ref_sum-3623"><span class="linenos">3623</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_sum-3624"><a href="#CenterRefinement.ref_sum-3624"><span class="linenos">3624</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement.ref_sum-3625"><a href="#CenterRefinement.ref_sum-3625"><span class="linenos">3625</span></a><span class="sd">            Initial y-coordinate of the detected center.</span>
</span><span id="CenterRefinement.ref_sum-3626"><a href="#CenterRefinement.ref_sum-3626"><span class="linenos">3626</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_sum-3627"><a href="#CenterRefinement.ref_sum-3627"><span class="linenos">3627</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement.ref_sum-3628"><a href="#CenterRefinement.ref_sum-3628"><span class="linenos">3628</span></a><span class="sd">            Initial radius of the detected circular pattern.</span>
</span><span id="CenterRefinement.ref_sum-3629"><a href="#CenterRefinement.ref_sum-3629"><span class="linenos">3629</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_sum-3630"><a href="#CenterRefinement.ref_sum-3630"><span class="linenos">3630</span></a><span class="sd">        plot_results : int, optional (default=0)</span>
</span><span id="CenterRefinement.ref_sum-3631"><a href="#CenterRefinement.ref_sum-3631"><span class="linenos">3631</span></a><span class="sd">            If set to 1, plots the final result of the refinement.</span>
</span><span id="CenterRefinement.ref_sum-3632"><a href="#CenterRefinement.ref_sum-3632"><span class="linenos">3632</span></a>
</span><span id="CenterRefinement.ref_sum-3633"><a href="#CenterRefinement.ref_sum-3633"><span class="linenos">3633</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement.ref_sum-3634"><a href="#CenterRefinement.ref_sum-3634"><span class="linenos">3634</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement.ref_sum-3635"><a href="#CenterRefinement.ref_sum-3635"><span class="linenos">3635</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement.ref_sum-3636"><a href="#CenterRefinement.ref_sum-3636"><span class="linenos">3636</span></a><span class="sd">            Refined x-coordinate of the center.</span>
</span><span id="CenterRefinement.ref_sum-3637"><a href="#CenterRefinement.ref_sum-3637"><span class="linenos">3637</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_sum-3638"><a href="#CenterRefinement.ref_sum-3638"><span class="linenos">3638</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement.ref_sum-3639"><a href="#CenterRefinement.ref_sum-3639"><span class="linenos">3639</span></a><span class="sd">            Refined y-coordinate of the center.</span>
</span><span id="CenterRefinement.ref_sum-3640"><a href="#CenterRefinement.ref_sum-3640"><span class="linenos">3640</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_sum-3641"><a href="#CenterRefinement.ref_sum-3641"><span class="linenos">3641</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement.ref_sum-3642"><a href="#CenterRefinement.ref_sum-3642"><span class="linenos">3642</span></a><span class="sd">            Refined radius of the circular pattern.</span>
</span><span id="CenterRefinement.ref_sum-3643"><a href="#CenterRefinement.ref_sum-3643"><span class="linenos">3643</span></a>
</span><span id="CenterRefinement.ref_sum-3644"><a href="#CenterRefinement.ref_sum-3644"><span class="linenos">3644</span></a><span class="sd">        Notes</span>
</span><span id="CenterRefinement.ref_sum-3645"><a href="#CenterRefinement.ref_sum-3645"><span class="linenos">3645</span></a><span class="sd">        -----</span>
</span><span id="CenterRefinement.ref_sum-3646"><a href="#CenterRefinement.ref_sum-3646"><span class="linenos">3646</span></a><span class="sd">        - Uses `self.parent.intensity_sum()` as the optimization criterion.</span>
</span><span id="CenterRefinement.ref_sum-3647"><a href="#CenterRefinement.ref_sum-3647"><span class="linenos">3647</span></a><span class="sd">        - Alternates between optimizing the center and the radius.</span>
</span><span id="CenterRefinement.ref_sum-3648"><a href="#CenterRefinement.ref_sum-3648"><span class="linenos">3648</span></a><span class="sd">        - Stops after no significant improvement over multiple iterations.</span>
</span><span id="CenterRefinement.ref_sum-3649"><a href="#CenterRefinement.ref_sum-3649"><span class="linenos">3649</span></a><span class="sd">        - If refinement worsens the result, the original values are retained.</span>
</span><span id="CenterRefinement.ref_sum-3650"><a href="#CenterRefinement.ref_sum-3650"><span class="linenos">3650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_sum-3651"><a href="#CenterRefinement.ref_sum-3651"><span class="linenos">3651</span></a>        <span class="c1"># Store input for plot via self.visualize_refinement()</span>
</span><span id="CenterRefinement.ref_sum-3652"><a href="#CenterRefinement.ref_sum-3652"><span class="linenos">3652</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_sum-3653"><a href="#CenterRefinement.ref_sum-3653"><span class="linenos">3653</span></a>    
</span><span id="CenterRefinement.ref_sum-3654"><a href="#CenterRefinement.ref_sum-3654"><span class="linenos">3654</span></a>        <span class="c1"># Image in which the center is refined</span>
</span><span id="CenterRefinement.ref_sum-3655"><a href="#CenterRefinement.ref_sum-3655"><span class="linenos">3655</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3656"><a href="#CenterRefinement.ref_sum-3656"><span class="linenos">3656</span></a>    
</span><span id="CenterRefinement.ref_sum-3657"><a href="#CenterRefinement.ref_sum-3657"><span class="linenos">3657</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement.ref_sum-3658"><a href="#CenterRefinement.ref_sum-3658"><span class="linenos">3658</span></a>        <span class="n">init_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3659"><a href="#CenterRefinement.ref_sum-3659"><span class="linenos">3659</span></a>        <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3660"><a href="#CenterRefinement.ref_sum-3660"><span class="linenos">3660</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-3661"><a href="#CenterRefinement.ref_sum-3661"><span class="linenos">3661</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3662"><a href="#CenterRefinement.ref_sum-3662"><span class="linenos">3662</span></a>        
</span><span id="CenterRefinement.ref_sum-3663"><a href="#CenterRefinement.ref_sum-3663"><span class="linenos">3663</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement.ref_sum-3664"><a href="#CenterRefinement.ref_sum-3664"><span class="linenos">3664</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement.ref_sum-3665"><a href="#CenterRefinement.ref_sum-3665"><span class="linenos">3665</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement.ref_sum-3666"><a href="#CenterRefinement.ref_sum-3666"><span class="linenos">3666</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">max_intensity_sum</span>
</span><span id="CenterRefinement.ref_sum-3667"><a href="#CenterRefinement.ref_sum-3667"><span class="linenos">3667</span></a>        
</span><span id="CenterRefinement.ref_sum-3668"><a href="#CenterRefinement.ref_sum-3668"><span class="linenos">3668</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement.ref_sum-3669"><a href="#CenterRefinement.ref_sum-3669"><span class="linenos">3669</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterRefinement.ref_sum-3670"><a href="#CenterRefinement.ref_sum-3670"><span class="linenos">3670</span></a>        
</span><span id="CenterRefinement.ref_sum-3671"><a href="#CenterRefinement.ref_sum-3671"><span class="linenos">3671</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement.ref_sum-3672"><a href="#CenterRefinement.ref_sum-3672"><span class="linenos">3672</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement.ref_sum-3673"><a href="#CenterRefinement.ref_sum-3673"><span class="linenos">3673</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement.ref_sum-3674"><a href="#CenterRefinement.ref_sum-3674"><span class="linenos">3674</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement.ref_sum-3675"><a href="#CenterRefinement.ref_sum-3675"><span class="linenos">3675</span></a>         
</span><span id="CenterRefinement.ref_sum-3676"><a href="#CenterRefinement.ref_sum-3676"><span class="linenos">3676</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement.ref_sum-3677"><a href="#CenterRefinement.ref_sum-3677"><span class="linenos">3677</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement.ref_sum-3678"><a href="#CenterRefinement.ref_sum-3678"><span class="linenos">3678</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="CenterRefinement.ref_sum-3679"><a href="#CenterRefinement.ref_sum-3679"><span class="linenos">3679</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-3680"><a href="#CenterRefinement.ref_sum-3680"><span class="linenos">3680</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3681"><a href="#CenterRefinement.ref_sum-3681"><span class="linenos">3681</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_sum-3682"><a href="#CenterRefinement.ref_sum-3682"><span class="linenos">3682</span></a>        
</span><span id="CenterRefinement.ref_sum-3683"><a href="#CenterRefinement.ref_sum-3683"><span class="linenos">3683</span></a>        <span class="c1"># Live plot initialization </span>
</span><span id="CenterRefinement.ref_sum-3684"><a href="#CenterRefinement.ref_sum-3684"><span class="linenos">3684</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3685"><a href="#CenterRefinement.ref_sum-3685"><span class="linenos">3685</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_sum-3686"><a href="#CenterRefinement.ref_sum-3686"><span class="linenos">3686</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_sum-3687"><a href="#CenterRefinement.ref_sum-3687"><span class="linenos">3687</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3688"><a href="#CenterRefinement.ref_sum-3688"><span class="linenos">3688</span></a>            <span class="n">circ_artist</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="n">best_center</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-3689"><a href="#CenterRefinement.ref_sum-3689"><span class="linenos">3689</span></a>                                 <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3690"><a href="#CenterRefinement.ref_sum-3690"><span class="linenos">3690</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ_artist</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3691"><a href="#CenterRefinement.ref_sum-3691"><span class="linenos">3691</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Refinement Progress&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3692"><a href="#CenterRefinement.ref_sum-3692"><span class="linenos">3692</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3693"><a href="#CenterRefinement.ref_sum-3693"><span class="linenos">3693</span></a>            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_sum-3694"><a href="#CenterRefinement.ref_sum-3694"><span class="linenos">3694</span></a>    
</span><span id="CenterRefinement.ref_sum-3695"><a href="#CenterRefinement.ref_sum-3695"><span class="linenos">3695</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement.ref_sum-3696"><a href="#CenterRefinement.ref_sum-3696"><span class="linenos">3696</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement.ref_sum-3697"><a href="#CenterRefinement.ref_sum-3697"><span class="linenos">3697</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-3698"><a href="#CenterRefinement.ref_sum-3698"><span class="linenos">3698</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-3699"><a href="#CenterRefinement.ref_sum-3699"><span class="linenos">3699</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-3700"><a href="#CenterRefinement.ref_sum-3700"><span class="linenos">3700</span></a>                                      <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3701"><a href="#CenterRefinement.ref_sum-3701"><span class="linenos">3701</span></a>            
</span><span id="CenterRefinement.ref_sum-3702"><a href="#CenterRefinement.ref_sum-3702"><span class="linenos">3702</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement.ref_sum-3703"><a href="#CenterRefinement.ref_sum-3703"><span class="linenos">3703</span></a>            <span class="n">curr_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_sum-3704"><a href="#CenterRefinement.ref_sum-3704"><span class="linenos">3704</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3705"><a href="#CenterRefinement.ref_sum-3705"><span class="linenos">3705</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement.ref_sum-3706"><a href="#CenterRefinement.ref_sum-3706"><span class="linenos">3706</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement.ref_sum-3707"><a href="#CenterRefinement.ref_sum-3707"><span class="linenos">3707</span></a>                <span class="n">curr_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-3708"><a href="#CenterRefinement.ref_sum-3708"><span class="linenos">3708</span></a>                                                        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-3709"><a href="#CenterRefinement.ref_sum-3709"><span class="linenos">3709</span></a>                                                        <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-3710"><a href="#CenterRefinement.ref_sum-3710"><span class="linenos">3710</span></a>            
</span><span id="CenterRefinement.ref_sum-3711"><a href="#CenterRefinement.ref_sum-3711"><span class="linenos">3711</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement.ref_sum-3712"><a href="#CenterRefinement.ref_sum-3712"><span class="linenos">3712</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_sum-3713"><a href="#CenterRefinement.ref_sum-3713"><span class="linenos">3713</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_sum-3714"><a href="#CenterRefinement.ref_sum-3714"><span class="linenos">3714</span></a>                    
</span><span id="CenterRefinement.ref_sum-3715"><a href="#CenterRefinement.ref_sum-3715"><span class="linenos">3715</span></a>            <span class="c1"># Check for improvement of criterion - in each iteration just once,</span>
</span><span id="CenterRefinement.ref_sum-3716"><a href="#CenterRefinement.ref_sum-3716"><span class="linenos">3716</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center</span>
</span><span id="CenterRefinement.ref_sum-3717"><a href="#CenterRefinement.ref_sum-3717"><span class="linenos">3717</span></a>            <span class="c1"># (in each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement.ref_sum-3718"><a href="#CenterRefinement.ref_sum-3718"><span class="linenos">3718</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>                           
</span><span id="CenterRefinement.ref_sum-3719"><a href="#CenterRefinement.ref_sum-3719"><span class="linenos">3719</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3720"><a href="#CenterRefinement.ref_sum-3720"><span class="linenos">3720</span></a>                
</span><span id="CenterRefinement.ref_sum-3721"><a href="#CenterRefinement.ref_sum-3721"><span class="linenos">3721</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement.ref_sum-3722"><a href="#CenterRefinement.ref_sum-3722"><span class="linenos">3722</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_sum-3723"><a href="#CenterRefinement.ref_sum-3723"><span class="linenos">3723</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement.ref_sum-3724"><a href="#CenterRefinement.ref_sum-3724"><span class="linenos">3724</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-3725"><a href="#CenterRefinement.ref_sum-3725"><span class="linenos">3725</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-3726"><a href="#CenterRefinement.ref_sum-3726"><span class="linenos">3726</span></a>    
</span><span id="CenterRefinement.ref_sum-3727"><a href="#CenterRefinement.ref_sum-3727"><span class="linenos">3727</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement.ref_sum-3728"><a href="#CenterRefinement.ref_sum-3728"><span class="linenos">3728</span></a>            <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-3729"><a href="#CenterRefinement.ref_sum-3729"><span class="linenos">3729</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-3730"><a href="#CenterRefinement.ref_sum-3730"><span class="linenos">3730</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-3731"><a href="#CenterRefinement.ref_sum-3731"><span class="linenos">3731</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3732"><a href="#CenterRefinement.ref_sum-3732"><span class="linenos">3732</span></a>    
</span><span id="CenterRefinement.ref_sum-3733"><a href="#CenterRefinement.ref_sum-3733"><span class="linenos">3733</span></a>        
</span><span id="CenterRefinement.ref_sum-3734"><a href="#CenterRefinement.ref_sum-3734"><span class="linenos">3734</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement.ref_sum-3735"><a href="#CenterRefinement.ref_sum-3735"><span class="linenos">3735</span></a>            <span class="c1"># constant. It iterates through different radius adjustments</span>
</span><span id="CenterRefinement.ref_sum-3736"><a href="#CenterRefinement.ref_sum-3736"><span class="linenos">3736</span></a>            <span class="c1"># to find a radius that maximizes the intensity sum of pixels.</span>
</span><span id="CenterRefinement.ref_sum-3737"><a href="#CenterRefinement.ref_sum-3737"><span class="linenos">3737</span></a>            
</span><span id="CenterRefinement.ref_sum-3738"><a href="#CenterRefinement.ref_sum-3738"><span class="linenos">3738</span></a>            <span class="n">radi_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_sum-3739"><a href="#CenterRefinement.ref_sum-3739"><span class="linenos">3739</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3740"><a href="#CenterRefinement.ref_sum-3740"><span class="linenos">3740</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3741"><a href="#CenterRefinement.ref_sum-3741"><span class="linenos">3741</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement.ref_sum-3742"><a href="#CenterRefinement.ref_sum-3742"><span class="linenos">3742</span></a>                <span class="n">radi_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-3743"><a href="#CenterRefinement.ref_sum-3743"><span class="linenos">3743</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-3744"><a href="#CenterRefinement.ref_sum-3744"><span class="linenos">3744</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-3745"><a href="#CenterRefinement.ref_sum-3745"><span class="linenos">3745</span></a>                                                            <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-3746"><a href="#CenterRefinement.ref_sum-3746"><span class="linenos">3746</span></a>                
</span><span id="CenterRefinement.ref_sum-3747"><a href="#CenterRefinement.ref_sum-3747"><span class="linenos">3747</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement.ref_sum-3748"><a href="#CenterRefinement.ref_sum-3748"><span class="linenos">3748</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_sum-3749"><a href="#CenterRefinement.ref_sum-3749"><span class="linenos">3749</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_sum-3750"><a href="#CenterRefinement.ref_sum-3750"><span class="linenos">3750</span></a>    
</span><span id="CenterRefinement.ref_sum-3751"><a href="#CenterRefinement.ref_sum-3751"><span class="linenos">3751</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement.ref_sum-3752"><a href="#CenterRefinement.ref_sum-3752"><span class="linenos">3752</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3753"><a href="#CenterRefinement.ref_sum-3753"><span class="linenos">3753</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3754"><a href="#CenterRefinement.ref_sum-3754"><span class="linenos">3754</span></a>                
</span><span id="CenterRefinement.ref_sum-3755"><a href="#CenterRefinement.ref_sum-3755"><span class="linenos">3755</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_sum-3756"><a href="#CenterRefinement.ref_sum-3756"><span class="linenos">3756</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement.ref_sum-3757"><a href="#CenterRefinement.ref_sum-3757"><span class="linenos">3757</span></a>                
</span><span id="CenterRefinement.ref_sum-3758"><a href="#CenterRefinement.ref_sum-3758"><span class="linenos">3758</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3759"><a href="#CenterRefinement.ref_sum-3759"><span class="linenos">3759</span></a>                
</span><span id="CenterRefinement.ref_sum-3760"><a href="#CenterRefinement.ref_sum-3760"><span class="linenos">3760</span></a>            
</span><span id="CenterRefinement.ref_sum-3761"><a href="#CenterRefinement.ref_sum-3761"><span class="linenos">3761</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement.ref_sum-3762"><a href="#CenterRefinement.ref_sum-3762"><span class="linenos">3762</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_intensity_sum</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3763"><a href="#CenterRefinement.ref_sum-3763"><span class="linenos">3763</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3764"><a href="#CenterRefinement.ref_sum-3764"><span class="linenos">3764</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement.ref_sum-3765"><a href="#CenterRefinement.ref_sum-3765"><span class="linenos">3765</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3766"><a href="#CenterRefinement.ref_sum-3766"><span class="linenos">3766</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement.ref_sum-3767"><a href="#CenterRefinement.ref_sum-3767"><span class="linenos">3767</span></a>                
</span><span id="CenterRefinement.ref_sum-3768"><a href="#CenterRefinement.ref_sum-3768"><span class="linenos">3768</span></a>            <span class="c1"># --- Live plot update ---</span>
</span><span id="CenterRefinement.ref_sum-3769"><a href="#CenterRefinement.ref_sum-3769"><span class="linenos">3769</span></a>            <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3770"><a href="#CenterRefinement.ref_sum-3770"><span class="linenos">3770</span></a>                <span class="n">circ_artist</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">best_center</span>
</span><span id="CenterRefinement.ref_sum-3771"><a href="#CenterRefinement.ref_sum-3771"><span class="linenos">3771</span></a>                <span class="n">circ_artist</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3772"><a href="#CenterRefinement.ref_sum-3772"><span class="linenos">3772</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="CenterRefinement.ref_sum-3773"><a href="#CenterRefinement.ref_sum-3773"><span class="linenos">3773</span></a>                    <span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> | Sum=</span><span class="si">{</span><span class="n">max_intensity_sum</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3774"><a href="#CenterRefinement.ref_sum-3774"><span class="linenos">3774</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_sum-3775"><a href="#CenterRefinement.ref_sum-3775"><span class="linenos">3775</span></a>                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_sum-3776"><a href="#CenterRefinement.ref_sum-3776"><span class="linenos">3776</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># small delay for visual update</span>
</span><span id="CenterRefinement.ref_sum-3777"><a href="#CenterRefinement.ref_sum-3777"><span class="linenos">3777</span></a>        
</span><span id="CenterRefinement.ref_sum-3778"><a href="#CenterRefinement.ref_sum-3778"><span class="linenos">3778</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement.ref_sum-3779"><a href="#CenterRefinement.ref_sum-3779"><span class="linenos">3779</span></a>        <span class="c1"># ## (1) swapped coordinates</span>
</span><span id="CenterRefinement.ref_sum-3780"><a href="#CenterRefinement.ref_sum-3780"><span class="linenos">3780</span></a>        <span class="c1"># if ((bckup[0] &gt; bckup[1] and not best_center[0] &gt; best_center[1])</span>
</span><span id="CenterRefinement.ref_sum-3781"><a href="#CenterRefinement.ref_sum-3781"><span class="linenos">3781</span></a>        <span class="c1">#     or  (bckup[0] &lt; bckup[1]</span>
</span><span id="CenterRefinement.ref_sum-3782"><a href="#CenterRefinement.ref_sum-3782"><span class="linenos">3782</span></a>        <span class="c1">#     and not best_center[0] &lt; best_center[1])):</span>
</span><span id="CenterRefinement.ref_sum-3783"><a href="#CenterRefinement.ref_sum-3783"><span class="linenos">3783</span></a>        <span class="c1">#     best_center = best_center[::-1]</span>
</span><span id="CenterRefinement.ref_sum-3784"><a href="#CenterRefinement.ref_sum-3784"><span class="linenos">3784</span></a>        
</span><span id="CenterRefinement.ref_sum-3785"><a href="#CenterRefinement.ref_sum-3785"><span class="linenos">3785</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement.ref_sum-3786"><a href="#CenterRefinement.ref_sum-3786"><span class="linenos">3786</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">max_intensity_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_sum-3787"><a href="#CenterRefinement.ref_sum-3787"><span class="linenos">3787</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3788"><a href="#CenterRefinement.ref_sum-3788"><span class="linenos">3788</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-3789"><a href="#CenterRefinement.ref_sum-3789"><span class="linenos">3789</span></a>    
</span><span id="CenterRefinement.ref_sum-3790"><a href="#CenterRefinement.ref_sum-3790"><span class="linenos">3790</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement.ref_sum-3791"><a href="#CenterRefinement.ref_sum-3791"><span class="linenos">3791</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_sum-3792"><a href="#CenterRefinement.ref_sum-3792"><span class="linenos">3792</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement.ref_sum-3793"><a href="#CenterRefinement.ref_sum-3793"><span class="linenos">3793</span></a>                <span class="s2">&quot;Center Refinement (IntensitySum)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement.ref_sum-3794"><a href="#CenterRefinement.ref_sum-3794"><span class="linenos">3794</span></a>        
</span><span id="CenterRefinement.ref_sum-3795"><a href="#CenterRefinement.ref_sum-3795"><span class="linenos">3795</span></a>        <span class="k">if</span> <span class="n">live_plot</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-3796"><a href="#CenterRefinement.ref_sum-3796"><span class="linenos">3796</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_sum-3797"><a href="#CenterRefinement.ref_sum-3797"><span class="linenos">3797</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_sum-3798"><a href="#CenterRefinement.ref_sum-3798"><span class="linenos">3798</span></a>
</span><span id="CenterRefinement.ref_sum-3799"><a href="#CenterRefinement.ref_sum-3799"><span class="linenos">3799</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span></pre></div>


            <div class="docstring"><p>Refine the center coordinates (px, py) and radius (pr) of a circular 
diffraction pattern by maximizing the summed pixel intensity along 
a circular ring.</p>

<p>The method uses an iterative local search strategy based on gradient 
ascent in the 8-neighbourhood around the current center to find 
a position and radius that maximize the intensity sum. The center 
is updated based on the best neighbor until convergence criteria 
or maximum iteration limits are met.</p>

<p>Neighborhood pattern tested (o = current center, x = candidate center):
    x x x   --> (px - dx, py + dy) (px, py + dy) (px + dx, py + dy)
    x o x   --> (px - dx, py)      (px, py)      (px + dx, py)
    x x x   --> (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>px</strong> (float):
Initial x-coordinate of the detected center.</li>
<li><strong>py</strong> (float):
Initial y-coordinate of the detected center.</li>
<li><strong>pr</strong> (float):
Initial radius of the detected circular pattern.</li>
<li><strong>plot_results</strong> (int, optional (default=0)):
If set to 1, plots the final result of the refinement.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>px</strong> (float):
Refined x-coordinate of the center.</li>
<li><strong>py</strong> (float):
Refined y-coordinate of the center.</li>
<li><strong>pr</strong> (float):
Refined radius of the circular pattern.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>Uses <code>self.parent.intensity_sum()</code> as the optimization criterion.</li>
<li>Alternates between optimizing the center and the radius.</li>
<li>Stops after no significant improvement over multiple iterations.</li>
<li>If refinement worsens the result, the original values are retained.</li>
</ul>
</div>


                            </div>
                            <div id="CenterRefinement.diagnose_landscape" class="classattr">
                                        <input id="CenterRefinement.diagnose_landscape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">diagnose_landscape</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span>, </span><span class="param"><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;std&#39;</span>, </span><span class="param"><span class="n">search_range</span><span class="o">=</span><span class="mf">2.0</span>, </span><span class="param"><span class="n">steps</span><span class="o">=</span><span class="mi">21</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterRefinement.diagnose_landscape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement.diagnose_landscape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement.diagnose_landscape-3802"><a href="#CenterRefinement.diagnose_landscape-3802"><span class="linenos">3802</span></a>    <span class="k">def</span> <span class="nf">diagnose_landscape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">search_range</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">21</span><span class="p">):</span>
</span><span id="CenterRefinement.diagnose_landscape-3803"><a href="#CenterRefinement.diagnose_landscape-3803"><span class="linenos">3803</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement.diagnose_landscape-3804"><a href="#CenterRefinement.diagnose_landscape-3804"><span class="linenos">3804</span></a><span class="sd">        Visualize the optimization landscape of a center refinement metric</span>
</span><span id="CenterRefinement.diagnose_landscape-3805"><a href="#CenterRefinement.diagnose_landscape-3805"><span class="linenos">3805</span></a><span class="sd">        around a candidate center location and radius.</span>
</span><span id="CenterRefinement.diagnose_landscape-3806"><a href="#CenterRefinement.diagnose_landscape-3806"><span class="linenos">3806</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.diagnose_landscape-3807"><a href="#CenterRefinement.diagnose_landscape-3807"><span class="linenos">3807</span></a><span class="sd">        This function evaluates the selected metric over a grid of positions</span>
</span><span id="CenterRefinement.diagnose_landscape-3808"><a href="#CenterRefinement.diagnose_landscape-3808"><span class="linenos">3808</span></a><span class="sd">        in a 2D neighborhood around the given (px, py) center, using a fixed</span>
</span><span id="CenterRefinement.diagnose_landscape-3809"><a href="#CenterRefinement.diagnose_landscape-3809"><span class="linenos">3809</span></a><span class="sd">        radius `pr`, and visualizes the results as a heatmap with contours.</span>
</span><span id="CenterRefinement.diagnose_landscape-3810"><a href="#CenterRefinement.diagnose_landscape-3810"><span class="linenos">3810</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.diagnose_landscape-3811"><a href="#CenterRefinement.diagnose_landscape-3811"><span class="linenos">3811</span></a><span class="sd">        It can be useful for diagnosing whether the optimization function</span>
</span><span id="CenterRefinement.diagnose_landscape-3812"><a href="#CenterRefinement.diagnose_landscape-3812"><span class="linenos">3812</span></a><span class="sd">        (e.g., standard deviation, median, or sum of pixel intensities) has</span>
</span><span id="CenterRefinement.diagnose_landscape-3813"><a href="#CenterRefinement.diagnose_landscape-3813"><span class="linenos">3813</span></a><span class="sd">        a smooth and well-behaved landscape, which is important for gradient</span>
</span><span id="CenterRefinement.diagnose_landscape-3814"><a href="#CenterRefinement.diagnose_landscape-3814"><span class="linenos">3814</span></a><span class="sd">        optimization methods.</span>
</span><span id="CenterRefinement.diagnose_landscape-3815"><a href="#CenterRefinement.diagnose_landscape-3815"><span class="linenos">3815</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.diagnose_landscape-3816"><a href="#CenterRefinement.diagnose_landscape-3816"><span class="linenos">3816</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement.diagnose_landscape-3817"><a href="#CenterRefinement.diagnose_landscape-3817"><span class="linenos">3817</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement.diagnose_landscape-3818"><a href="#CenterRefinement.diagnose_landscape-3818"><span class="linenos">3818</span></a><span class="sd">        px : float</span>
</span><span id="CenterRefinement.diagnose_landscape-3819"><a href="#CenterRefinement.diagnose_landscape-3819"><span class="linenos">3819</span></a><span class="sd">            X-coordinate of the candidate center.</span>
</span><span id="CenterRefinement.diagnose_landscape-3820"><a href="#CenterRefinement.diagnose_landscape-3820"><span class="linenos">3820</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.diagnose_landscape-3821"><a href="#CenterRefinement.diagnose_landscape-3821"><span class="linenos">3821</span></a><span class="sd">        py : float</span>
</span><span id="CenterRefinement.diagnose_landscape-3822"><a href="#CenterRefinement.diagnose_landscape-3822"><span class="linenos">3822</span></a><span class="sd">            Y-coordinate of the candidate center.</span>
</span><span id="CenterRefinement.diagnose_landscape-3823"><a href="#CenterRefinement.diagnose_landscape-3823"><span class="linenos">3823</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.diagnose_landscape-3824"><a href="#CenterRefinement.diagnose_landscape-3824"><span class="linenos">3824</span></a><span class="sd">        pr : float</span>
</span><span id="CenterRefinement.diagnose_landscape-3825"><a href="#CenterRefinement.diagnose_landscape-3825"><span class="linenos">3825</span></a><span class="sd">            Radius of the circular region to evaluate the metric on.</span>
</span><span id="CenterRefinement.diagnose_landscape-3826"><a href="#CenterRefinement.diagnose_landscape-3826"><span class="linenos">3826</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.diagnose_landscape-3827"><a href="#CenterRefinement.diagnose_landscape-3827"><span class="linenos">3827</span></a><span class="sd">        metric : str, optional</span>
</span><span id="CenterRefinement.diagnose_landscape-3828"><a href="#CenterRefinement.diagnose_landscape-3828"><span class="linenos">3828</span></a><span class="sd">            The metric to evaluate. Options are:</span>
</span><span id="CenterRefinement.diagnose_landscape-3829"><a href="#CenterRefinement.diagnose_landscape-3829"><span class="linenos">3829</span></a><span class="sd">            - &#39;std&#39;: standard deviation of pixel values (default)</span>
</span><span id="CenterRefinement.diagnose_landscape-3830"><a href="#CenterRefinement.diagnose_landscape-3830"><span class="linenos">3830</span></a><span class="sd">            - &#39;median&#39;: median of pixel values</span>
</span><span id="CenterRefinement.diagnose_landscape-3831"><a href="#CenterRefinement.diagnose_landscape-3831"><span class="linenos">3831</span></a><span class="sd">            - &#39;sum&#39;: sum of pixel values</span>
</span><span id="CenterRefinement.diagnose_landscape-3832"><a href="#CenterRefinement.diagnose_landscape-3832"><span class="linenos">3832</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.diagnose_landscape-3833"><a href="#CenterRefinement.diagnose_landscape-3833"><span class="linenos">3833</span></a><span class="sd">        search_range : float, optional, default=2.0</span>
</span><span id="CenterRefinement.diagnose_landscape-3834"><a href="#CenterRefinement.diagnose_landscape-3834"><span class="linenos">3834</span></a><span class="sd">            The radius of the square region (in pixels) around the center </span>
</span><span id="CenterRefinement.diagnose_landscape-3835"><a href="#CenterRefinement.diagnose_landscape-3835"><span class="linenos">3835</span></a><span class="sd">            to explore. The grid will extend ±`search_range` in both x and y </span>
</span><span id="CenterRefinement.diagnose_landscape-3836"><a href="#CenterRefinement.diagnose_landscape-3836"><span class="linenos">3836</span></a><span class="sd">            directions.</span>
</span><span id="CenterRefinement.diagnose_landscape-3837"><a href="#CenterRefinement.diagnose_landscape-3837"><span class="linenos">3837</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.diagnose_landscape-3838"><a href="#CenterRefinement.diagnose_landscape-3838"><span class="linenos">3838</span></a><span class="sd">        steps : int, optional, default=21</span>
</span><span id="CenterRefinement.diagnose_landscape-3839"><a href="#CenterRefinement.diagnose_landscape-3839"><span class="linenos">3839</span></a><span class="sd">            The number of points to sample along each axis (grid resolution).</span>
</span><span id="CenterRefinement.diagnose_landscape-3840"><a href="#CenterRefinement.diagnose_landscape-3840"><span class="linenos">3840</span></a><span class="sd">            Must be an odd number to ensure the center point is included.</span>
</span><span id="CenterRefinement.diagnose_landscape-3841"><a href="#CenterRefinement.diagnose_landscape-3841"><span class="linenos">3841</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.diagnose_landscape-3842"><a href="#CenterRefinement.diagnose_landscape-3842"><span class="linenos">3842</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement.diagnose_landscape-3843"><a href="#CenterRefinement.diagnose_landscape-3843"><span class="linenos">3843</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement.diagnose_landscape-3844"><a href="#CenterRefinement.diagnose_landscape-3844"><span class="linenos">3844</span></a><span class="sd">        None</span>
</span><span id="CenterRefinement.diagnose_landscape-3845"><a href="#CenterRefinement.diagnose_landscape-3845"><span class="linenos">3845</span></a><span class="sd">            This method produces a matplotlib plot and does not return any value.</span>
</span><span id="CenterRefinement.diagnose_landscape-3846"><a href="#CenterRefinement.diagnose_landscape-3846"><span class="linenos">3846</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterRefinement.diagnose_landscape-3847"><a href="#CenterRefinement.diagnose_landscape-3847"><span class="linenos">3847</span></a>        <span class="c1"># Helper functions ----------------------------------------------------</span>
</span><span id="CenterRefinement.diagnose_landscape-3848"><a href="#CenterRefinement.diagnose_landscape-3848"><span class="linenos">3848</span></a>        <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterRefinement.diagnose_landscape-3849"><a href="#CenterRefinement.diagnose_landscape-3849"><span class="linenos">3849</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3850"><a href="#CenterRefinement.diagnose_landscape-3850"><span class="linenos">3850</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3851"><a href="#CenterRefinement.diagnose_landscape-3851"><span class="linenos">3851</span></a>        
</span><span id="CenterRefinement.diagnose_landscape-3852"><a href="#CenterRefinement.diagnose_landscape-3852"><span class="linenos">3852</span></a>        <span class="k">def</span> <span class="nf">intensity_std</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterRefinement.diagnose_landscape-3853"><a href="#CenterRefinement.diagnose_landscape-3853"><span class="linenos">3853</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3854"><a href="#CenterRefinement.diagnose_landscape-3854"><span class="linenos">3854</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3855"><a href="#CenterRefinement.diagnose_landscape-3855"><span class="linenos">3855</span></a>        
</span><span id="CenterRefinement.diagnose_landscape-3856"><a href="#CenterRefinement.diagnose_landscape-3856"><span class="linenos">3856</span></a>        <span class="k">def</span> <span class="nf">intensity_median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
</span><span id="CenterRefinement.diagnose_landscape-3857"><a href="#CenterRefinement.diagnose_landscape-3857"><span class="linenos">3857</span></a>            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3858"><a href="#CenterRefinement.diagnose_landscape-3858"><span class="linenos">3858</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3859"><a href="#CenterRefinement.diagnose_landscape-3859"><span class="linenos">3859</span></a>
</span><span id="CenterRefinement.diagnose_landscape-3860"><a href="#CenterRefinement.diagnose_landscape-3860"><span class="linenos">3860</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diagnosing landscape around (</span><span class="si">{</span><span class="n">px</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">py</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) with r=</span><span class="si">{</span><span class="n">pr</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3861"><a href="#CenterRefinement.diagnose_landscape-3861"><span class="linenos">3861</span></a>        
</span><span id="CenterRefinement.diagnose_landscape-3862"><a href="#CenterRefinement.diagnose_landscape-3862"><span class="linenos">3862</span></a>        <span class="c1"># (0) Select the metric function --------------------------------------</span>
</span><span id="CenterRefinement.diagnose_landscape-3863"><a href="#CenterRefinement.diagnose_landscape-3863"><span class="linenos">3863</span></a>        <span class="n">metric_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">intensity_std</span><span class="p">,</span> 
</span><span id="CenterRefinement.diagnose_landscape-3864"><a href="#CenterRefinement.diagnose_landscape-3864"><span class="linenos">3864</span></a>                      <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">intensity_median</span><span class="p">,</span> 
</span><span id="CenterRefinement.diagnose_landscape-3865"><a href="#CenterRefinement.diagnose_landscape-3865"><span class="linenos">3865</span></a>                      <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="n">intensity_sum</span> <span class="p">}</span>
</span><span id="CenterRefinement.diagnose_landscape-3866"><a href="#CenterRefinement.diagnose_landscape-3866"><span class="linenos">3866</span></a>        <span class="n">metric_func</span> <span class="o">=</span> <span class="n">metric_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">intensity_std</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3867"><a href="#CenterRefinement.diagnose_landscape-3867"><span class="linenos">3867</span></a>    
</span><span id="CenterRefinement.diagnose_landscape-3868"><a href="#CenterRefinement.diagnose_landscape-3868"><span class="linenos">3868</span></a>        <span class="c1"># (1) Create a grid of x and y coordinates to test --------------------</span>
</span><span id="CenterRefinement.diagnose_landscape-3869"><a href="#CenterRefinement.diagnose_landscape-3869"><span class="linenos">3869</span></a>        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">px</span> <span class="o">-</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">px</span> <span class="o">+</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3870"><a href="#CenterRefinement.diagnose_landscape-3870"><span class="linenos">3870</span></a>        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">py</span> <span class="o">-</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">py</span> <span class="o">+</span> <span class="n">search_range</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3871"><a href="#CenterRefinement.diagnose_landscape-3871"><span class="linenos">3871</span></a>        <span class="n">score_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="n">steps</span><span class="p">))</span>
</span><span id="CenterRefinement.diagnose_landscape-3872"><a href="#CenterRefinement.diagnose_landscape-3872"><span class="linenos">3872</span></a>    
</span><span id="CenterRefinement.diagnose_landscape-3873"><a href="#CenterRefinement.diagnose_landscape-3873"><span class="linenos">3873</span></a>        <span class="c1"># (2) Calculate the metric score at each point on the grid ------------</span>
</span><span id="CenterRefinement.diagnose_landscape-3874"><a href="#CenterRefinement.diagnose_landscape-3874"><span class="linenos">3874</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_range</span><span class="p">):</span>
</span><span id="CenterRefinement.diagnose_landscape-3875"><a href="#CenterRefinement.diagnose_landscape-3875"><span class="linenos">3875</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_range</span><span class="p">):</span>
</span><span id="CenterRefinement.diagnose_landscape-3876"><a href="#CenterRefinement.diagnose_landscape-3876"><span class="linenos">3876</span></a>                <span class="n">score_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3877"><a href="#CenterRefinement.diagnose_landscape-3877"><span class="linenos">3877</span></a>    
</span><span id="CenterRefinement.diagnose_landscape-3878"><a href="#CenterRefinement.diagnose_landscape-3878"><span class="linenos">3878</span></a>        <span class="c1"># (3) Plot the results ------------------------------------------------</span>
</span><span id="CenterRefinement.diagnose_landscape-3879"><a href="#CenterRefinement.diagnose_landscape-3879"><span class="linenos">3879</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="CenterRefinement.diagnose_landscape-3880"><a href="#CenterRefinement.diagnose_landscape-3880"><span class="linenos">3880</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="CenterRefinement.diagnose_landscape-3881"><a href="#CenterRefinement.diagnose_landscape-3881"><span class="linenos">3881</span></a>            <span class="n">score_grid</span><span class="p">,</span> 
</span><span id="CenterRefinement.diagnose_landscape-3882"><a href="#CenterRefinement.diagnose_landscape-3882"><span class="linenos">3882</span></a>            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> 
</span><span id="CenterRefinement.diagnose_landscape-3883"><a href="#CenterRefinement.diagnose_landscape-3883"><span class="linenos">3883</span></a>            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterRefinement.diagnose_landscape-3884"><a href="#CenterRefinement.diagnose_landscape-3884"><span class="linenos">3884</span></a>            <span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3885"><a href="#CenterRefinement.diagnose_landscape-3885"><span class="linenos">3885</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Metric Score (&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3886"><a href="#CenterRefinement.diagnose_landscape-3886"><span class="linenos">3886</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">score_grid</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3887"><a href="#CenterRefinement.diagnose_landscape-3887"><span class="linenos">3887</span></a>        
</span><span id="CenterRefinement.diagnose_landscape-3888"><a href="#CenterRefinement.diagnose_landscape-3888"><span class="linenos">3888</span></a>        <span class="c1"># Mark the starting point</span>
</span><span id="CenterRefinement.diagnose_landscape-3889"><a href="#CenterRefinement.diagnose_landscape-3889"><span class="linenos">3889</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Guess&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3890"><a href="#CenterRefinement.diagnose_landscape-3890"><span class="linenos">3890</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Optimization Landscape&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3891"><a href="#CenterRefinement.diagnose_landscape-3891"><span class="linenos">3891</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X-coordinate&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3892"><a href="#CenterRefinement.diagnose_landscape-3892"><span class="linenos">3892</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y-coordinate&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.diagnose_landscape-3893"><a href="#CenterRefinement.diagnose_landscape-3893"><span class="linenos">3893</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterRefinement.diagnose_landscape-3894"><a href="#CenterRefinement.diagnose_landscape-3894"><span class="linenos">3894</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Visualize the optimization landscape of a center refinement metric
around a candidate center location and radius.</p>

<p>This function evaluates the selected metric over a grid of positions
in a 2D neighborhood around the given (px, py) center, using a fixed
radius <code>pr</code>, and visualizes the results as a heatmap with contours.</p>

<p>It can be useful for diagnosing whether the optimization function
(e.g., standard deviation, median, or sum of pixel intensities) has
a smooth and well-behaved landscape, which is important for gradient
optimization methods.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>px</strong> (float):
X-coordinate of the candidate center.</li>
<li><strong>py</strong> (float):
Y-coordinate of the candidate center.</li>
<li><strong>pr</strong> (float):
Radius of the circular region to evaluate the metric on.</li>
<li><strong>metric</strong> (str, optional):
The metric to evaluate. Options are:
<ul>
<li>'std': standard deviation of pixel values (default)</li>
<li>'median': median of pixel values</li>
<li>'sum': sum of pixel values</li>
</ul></li>
<li><strong>search_range</strong> (float, optional, default=2.0):
The radius of the square region (in pixels) around the center 
to explore. The grid will extend ±<code>search_range</code> in both x and y 
directions.</li>
<li><strong>steps</strong> (int, optional, default=21):
The number of points to sample along each axis (grid resolution).
Must be an odd number to ensure the center point is included.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong>: This method produces a matplotlib plot and does not return any value.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="HandlerCircle">
                            <input id="HandlerCircle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HandlerCircle</span><wbr>(<span class="base">matplotlib.legend_handler.HandlerBase</span>):

                <label class="view-source-button" for="HandlerCircle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HandlerCircle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HandlerCircle-3897"><a href="#HandlerCircle-3897"><span class="linenos">3897</span></a><span class="k">class</span> <span class="nc">HandlerCircle</span><span class="p">(</span><span class="n">HandlerBase</span><span class="p">):</span>
</span><span id="HandlerCircle-3898"><a href="#HandlerCircle-3898"><span class="linenos">3898</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HandlerCircle-3899"><a href="#HandlerCircle-3899"><span class="linenos">3899</span></a><span class="sd">    Helper class for creating circular markers in matplotlib legends.</span>
</span><span id="HandlerCircle-3900"><a href="#HandlerCircle-3900"><span class="linenos">3900</span></a>
</span><span id="HandlerCircle-3901"><a href="#HandlerCircle-3901"><span class="linenos">3901</span></a><span class="sd">    This class customizes the legend to display circular markers instead of the </span>
</span><span id="HandlerCircle-3902"><a href="#HandlerCircle-3902"><span class="linenos">3902</span></a><span class="sd">    default. It is intended for internal use within the module and not </span>
</span><span id="HandlerCircle-3903"><a href="#HandlerCircle-3903"><span class="linenos">3903</span></a><span class="sd">    for general use.</span>
</span><span id="HandlerCircle-3904"><a href="#HandlerCircle-3904"><span class="linenos">3904</span></a>
</span><span id="HandlerCircle-3905"><a href="#HandlerCircle-3905"><span class="linenos">3905</span></a><span class="sd">    Methods:</span>
</span><span id="HandlerCircle-3906"><a href="#HandlerCircle-3906"><span class="linenos">3906</span></a><span class="sd">    --------</span>
</span><span id="HandlerCircle-3907"><a href="#HandlerCircle-3907"><span class="linenos">3907</span></a><span class="sd">    create_artists(legend, </span>
</span><span id="HandlerCircle-3908"><a href="#HandlerCircle-3908"><span class="linenos">3908</span></a><span class="sd">                   orig_handle, </span>
</span><span id="HandlerCircle-3909"><a href="#HandlerCircle-3909"><span class="linenos">3909</span></a><span class="sd">                   xdescent,</span>
</span><span id="HandlerCircle-3910"><a href="#HandlerCircle-3910"><span class="linenos">3910</span></a><span class="sd">                   ydescent, </span>
</span><span id="HandlerCircle-3911"><a href="#HandlerCircle-3911"><span class="linenos">3911</span></a><span class="sd">                   width, </span>
</span><span id="HandlerCircle-3912"><a href="#HandlerCircle-3912"><span class="linenos">3912</span></a><span class="sd">                   height, </span>
</span><span id="HandlerCircle-3913"><a href="#HandlerCircle-3913"><span class="linenos">3913</span></a><span class="sd">                   fontsize, </span>
</span><span id="HandlerCircle-3914"><a href="#HandlerCircle-3914"><span class="linenos">3914</span></a><span class="sd">                   trans):</span>
</span><span id="HandlerCircle-3915"><a href="#HandlerCircle-3915"><span class="linenos">3915</span></a><span class="sd">        Creates a circular marker for the legend based on the original handle&#39;s </span>
</span><span id="HandlerCircle-3916"><a href="#HandlerCircle-3916"><span class="linenos">3916</span></a><span class="sd">        properties.</span>
</span><span id="HandlerCircle-3917"><a href="#HandlerCircle-3917"><span class="linenos">3917</span></a>
</span><span id="HandlerCircle-3918"><a href="#HandlerCircle-3918"><span class="linenos">3918</span></a><span class="sd">    Parameters for `create_artists`:</span>
</span><span id="HandlerCircle-3919"><a href="#HandlerCircle-3919"><span class="linenos">3919</span></a><span class="sd">        legend : matplotlib.legend.Legend</span>
</span><span id="HandlerCircle-3920"><a href="#HandlerCircle-3920"><span class="linenos">3920</span></a><span class="sd">            The legend instance where the custom marker will be used.</span>
</span><span id="HandlerCircle-3921"><a href="#HandlerCircle-3921"><span class="linenos">3921</span></a><span class="sd">        orig_handle : matplotlib.artist.Artist</span>
</span><span id="HandlerCircle-3922"><a href="#HandlerCircle-3922"><span class="linenos">3922</span></a><span class="sd">            The original handle containing the marker properties </span>
</span><span id="HandlerCircle-3923"><a href="#HandlerCircle-3923"><span class="linenos">3923</span></a><span class="sd">            (e.g., facecolor, edgecolor).</span>
</span><span id="HandlerCircle-3924"><a href="#HandlerCircle-3924"><span class="linenos">3924</span></a><span class="sd">        xdescent : float</span>
</span><span id="HandlerCircle-3925"><a href="#HandlerCircle-3925"><span class="linenos">3925</span></a><span class="sd">            Horizontal offset adjustment for the marker.</span>
</span><span id="HandlerCircle-3926"><a href="#HandlerCircle-3926"><span class="linenos">3926</span></a><span class="sd">        ydescent : float</span>
</span><span id="HandlerCircle-3927"><a href="#HandlerCircle-3927"><span class="linenos">3927</span></a><span class="sd">            Vertical offset adjustment for the marker.</span>
</span><span id="HandlerCircle-3928"><a href="#HandlerCircle-3928"><span class="linenos">3928</span></a><span class="sd">        width : float</span>
</span><span id="HandlerCircle-3929"><a href="#HandlerCircle-3929"><span class="linenos">3929</span></a><span class="sd">            Width of the legend entry.</span>
</span><span id="HandlerCircle-3930"><a href="#HandlerCircle-3930"><span class="linenos">3930</span></a><span class="sd">        height : float</span>
</span><span id="HandlerCircle-3931"><a href="#HandlerCircle-3931"><span class="linenos">3931</span></a><span class="sd">            Height of the legend entry.</span>
</span><span id="HandlerCircle-3932"><a href="#HandlerCircle-3932"><span class="linenos">3932</span></a><span class="sd">        fontsize : float</span>
</span><span id="HandlerCircle-3933"><a href="#HandlerCircle-3933"><span class="linenos">3933</span></a><span class="sd">            Font size of the legend text.</span>
</span><span id="HandlerCircle-3934"><a href="#HandlerCircle-3934"><span class="linenos">3934</span></a><span class="sd">        trans : matplotlib.transforms.Transform</span>
</span><span id="HandlerCircle-3935"><a href="#HandlerCircle-3935"><span class="linenos">3935</span></a><span class="sd">            Transformation applied to the marker&#39;s coordinates.</span>
</span><span id="HandlerCircle-3936"><a href="#HandlerCircle-3936"><span class="linenos">3936</span></a>
</span><span id="HandlerCircle-3937"><a href="#HandlerCircle-3937"><span class="linenos">3937</span></a><span class="sd">    Returns:</span>
</span><span id="HandlerCircle-3938"><a href="#HandlerCircle-3938"><span class="linenos">3938</span></a><span class="sd">    --------</span>
</span><span id="HandlerCircle-3939"><a href="#HandlerCircle-3939"><span class="linenos">3939</span></a><span class="sd">    list of matplotlib.patches.Circle</span>
</span><span id="HandlerCircle-3940"><a href="#HandlerCircle-3940"><span class="linenos">3940</span></a><span class="sd">        A list containing a single circular marker artist.</span>
</span><span id="HandlerCircle-3941"><a href="#HandlerCircle-3941"><span class="linenos">3941</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HandlerCircle-3942"><a href="#HandlerCircle-3942"><span class="linenos">3942</span></a>
</span><span id="HandlerCircle-3943"><a href="#HandlerCircle-3943"><span class="linenos">3943</span></a>    <span class="k">def</span> <span class="nf">create_artists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">,</span> <span class="n">xdescent</span><span class="p">,</span> <span class="n">ydescent</span><span class="p">,</span> 
</span><span id="HandlerCircle-3944"><a href="#HandlerCircle-3944"><span class="linenos">3944</span></a>                       <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
</span><span id="HandlerCircle-3945"><a href="#HandlerCircle-3945"><span class="linenos">3945</span></a>        <span class="c1"># Calculate the center and radius of the circle</span>
</span><span id="HandlerCircle-3946"><a href="#HandlerCircle-3946"><span class="linenos">3946</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle-3947"><a href="#HandlerCircle-3947"><span class="linenos">3947</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle-3948"><a href="#HandlerCircle-3948"><span class="linenos">3948</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle-3949"><a href="#HandlerCircle-3949"><span class="linenos">3949</span></a>
</span><span id="HandlerCircle-3950"><a href="#HandlerCircle-3950"><span class="linenos">3950</span></a>        <span class="c1"># Create a circular marker using the properties of the original handle</span>
</span><span id="HandlerCircle-3951"><a href="#HandlerCircle-3951"><span class="linenos">3951</span></a>        <span class="n">marker</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span>
</span><span id="HandlerCircle-3952"><a href="#HandlerCircle-3952"><span class="linenos">3952</span></a>                        <span class="n">facecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle-3953"><a href="#HandlerCircle-3953"><span class="linenos">3953</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle-3954"><a href="#HandlerCircle-3954"><span class="linenos">3954</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">(),</span>
</span><span id="HandlerCircle-3955"><a href="#HandlerCircle-3955"><span class="linenos">3955</span></a>                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
</span><span id="HandlerCircle-3956"><a href="#HandlerCircle-3956"><span class="linenos">3956</span></a>
</span><span id="HandlerCircle-3957"><a href="#HandlerCircle-3957"><span class="linenos">3957</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">marker</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Helper class for creating circular markers in matplotlib legends.</p>

<p>This class customizes the legend to display circular markers instead of the 
default. It is intended for internal use within the module and not 
for general use.</p>

<h2 id="methods">Methods:</h2>

<p>create_artists(legend, 
               orig_handle, 
               xdescent,
               ydescent, 
               width, 
               height, 
               fontsize, 
               trans):
    Creates a circular marker for the legend based on the original handle's 
    properties.</p>

<p>Parameters for <code><a href="#HandlerCircle.create_artists">create_artists</a></code>:
    legend : matplotlib.legend.Legend
        The legend instance where the custom marker will be used.
    orig_handle : matplotlib.artist.Artist
        The original handle containing the marker properties 
        (e.g., facecolor, edgecolor).
    xdescent : float
        Horizontal offset adjustment for the marker.
    ydescent : float
        Vertical offset adjustment for the marker.
    width : float
        Width of the legend entry.
    height : float
        Height of the legend entry.
    fontsize : float
        Font size of the legend text.
    trans : matplotlib.transforms.Transform
        Transformation applied to the marker's coordinates.</p>

<h2 id="returns">Returns:</h2>

<p>list of matplotlib.patches.Circle
    A list containing a single circular marker artist.</p>
</div>


                            <div id="HandlerCircle.create_artists" class="classattr">
                                        <input id="HandlerCircle.create_artists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_artists</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">legend</span>,</span><span class="param">	<span class="n">orig_handle</span>,</span><span class="param">	<span class="n">xdescent</span>,</span><span class="param">	<span class="n">ydescent</span>,</span><span class="param">	<span class="n">width</span>,</span><span class="param">	<span class="n">height</span>,</span><span class="param">	<span class="n">fontsize</span>,</span><span class="param">	<span class="n">trans</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="HandlerCircle.create_artists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HandlerCircle.create_artists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HandlerCircle.create_artists-3943"><a href="#HandlerCircle.create_artists-3943"><span class="linenos">3943</span></a>    <span class="k">def</span> <span class="nf">create_artists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">,</span> <span class="n">xdescent</span><span class="p">,</span> <span class="n">ydescent</span><span class="p">,</span> 
</span><span id="HandlerCircle.create_artists-3944"><a href="#HandlerCircle.create_artists-3944"><span class="linenos">3944</span></a>                       <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
</span><span id="HandlerCircle.create_artists-3945"><a href="#HandlerCircle.create_artists-3945"><span class="linenos">3945</span></a>        <span class="c1"># Calculate the center and radius of the circle</span>
</span><span id="HandlerCircle.create_artists-3946"><a href="#HandlerCircle.create_artists-3946"><span class="linenos">3946</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle.create_artists-3947"><a href="#HandlerCircle.create_artists-3947"><span class="linenos">3947</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle.create_artists-3948"><a href="#HandlerCircle.create_artists-3948"><span class="linenos">3948</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle.create_artists-3949"><a href="#HandlerCircle.create_artists-3949"><span class="linenos">3949</span></a>
</span><span id="HandlerCircle.create_artists-3950"><a href="#HandlerCircle.create_artists-3950"><span class="linenos">3950</span></a>        <span class="c1"># Create a circular marker using the properties of the original handle</span>
</span><span id="HandlerCircle.create_artists-3951"><a href="#HandlerCircle.create_artists-3951"><span class="linenos">3951</span></a>        <span class="n">marker</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span>
</span><span id="HandlerCircle.create_artists-3952"><a href="#HandlerCircle.create_artists-3952"><span class="linenos">3952</span></a>                        <span class="n">facecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle.create_artists-3953"><a href="#HandlerCircle.create_artists-3953"><span class="linenos">3953</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle.create_artists-3954"><a href="#HandlerCircle.create_artists-3954"><span class="linenos">3954</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">(),</span>
</span><span id="HandlerCircle.create_artists-3955"><a href="#HandlerCircle.create_artists-3955"><span class="linenos">3955</span></a>                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
</span><span id="HandlerCircle.create_artists-3956"><a href="#HandlerCircle.create_artists-3956"><span class="linenos">3956</span></a>
</span><span id="HandlerCircle.create_artists-3957"><a href="#HandlerCircle.create_artists-3957"><span class="linenos">3957</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">marker</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return the legend artists generated.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>legend</strong> (<code>~matplotlib.legend.Legend</code>):
The legend for which these legend artists are being created.</li>
<li><strong>orig_handle</strong> (<code>~matplotlib.artist.Artist</code> or similar):
The object for which these legend artists are being created.</li>
<li><strong>xdescent, ydescent, width, height</strong> (int):
The rectangle (<em>xdescent</em>, <em>ydescent</em>, <em>width</em>, <em>height</em>) that the
legend artists being created should fit within.</li>
<li><strong>fontsize</strong> (int):
The fontsize in pixels. The legend artists being created should
be scaled according to the given fontsize.</li>
<li><strong>trans</strong> (<code>~matplotlib.transforms.Transform</code>):
The transform that is applied to the legend artists being created.
Typically from unit coordinates in the handler box to screen
coordinates.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="PocketFFTBackend">
                            <input id="PocketFFTBackend-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PocketFFTBackend</span>:

                <label class="view-source-button" for="PocketFFTBackend-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PocketFFTBackend"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PocketFFTBackend-3960"><a href="#PocketFFTBackend-3960"><span class="linenos">3960</span></a><span class="k">class</span> <span class="nc">PocketFFTBackend</span><span class="p">:</span>
</span><span id="PocketFFTBackend-3961"><a href="#PocketFFTBackend-3961"><span class="linenos">3961</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PocketFFTBackend-3962"><a href="#PocketFFTBackend-3962"><span class="linenos">3962</span></a><span class="sd">    High-performance FFT backend leveraging SciPy&#39;s PocketFFT with optimized </span>
</span><span id="PocketFFTBackend-3963"><a href="#PocketFFTBackend-3963"><span class="linenos">3963</span></a><span class="sd">    defaults. This backend enhances the efficiency of Fast Fourier Transforms </span>
</span><span id="PocketFFTBackend-3964"><a href="#PocketFFTBackend-3964"><span class="linenos">3964</span></a><span class="sd">    (FFT), particularly for 2D transforms, which may experience up to a 50% </span>
</span><span id="PocketFFTBackend-3965"><a href="#PocketFFTBackend-3965"><span class="linenos">3965</span></a><span class="sd">    speed improvement over standard configurations.</span>
</span><span id="PocketFFTBackend-3966"><a href="#PocketFFTBackend-3966"><span class="linenos">3966</span></a>
</span><span id="PocketFFTBackend-3967"><a href="#PocketFFTBackend-3967"><span class="linenos">3967</span></a><span class="sd">    Attributes</span>
</span><span id="PocketFFTBackend-3968"><a href="#PocketFFTBackend-3968"><span class="linenos">3968</span></a><span class="sd">    ----------</span>
</span><span id="PocketFFTBackend-3969"><a href="#PocketFFTBackend-3969"><span class="linenos">3969</span></a><span class="sd">    __ua_domain__ : str</span>
</span><span id="PocketFFTBackend-3970"><a href="#PocketFFTBackend-3970"><span class="linenos">3970</span></a><span class="sd">        Universal array domain identifier for NumPy&#39;s SciPy-based FFT interface.</span>
</span><span id="PocketFFTBackend-3971"><a href="#PocketFFTBackend-3971"><span class="linenos">3971</span></a>
</span><span id="PocketFFTBackend-3972"><a href="#PocketFFTBackend-3972"><span class="linenos">3972</span></a><span class="sd">    Methods</span>
</span><span id="PocketFFTBackend-3973"><a href="#PocketFFTBackend-3973"><span class="linenos">3973</span></a><span class="sd">    -------</span>
</span><span id="PocketFFTBackend-3974"><a href="#PocketFFTBackend-3974"><span class="linenos">3974</span></a><span class="sd">    __ua_function__(method, args, kwargs)</span>
</span><span id="PocketFFTBackend-3975"><a href="#PocketFFTBackend-3975"><span class="linenos">3975</span></a><span class="sd">        Universal array function handler that dispatches FFT operations to the </span>
</span><span id="PocketFFTBackend-3976"><a href="#PocketFFTBackend-3976"><span class="linenos">3976</span></a><span class="sd">        corresponding PocketFFT implementation with optimized threading</span>
</span><span id="PocketFFTBackend-3977"><a href="#PocketFFTBackend-3977"><span class="linenos">3977</span></a><span class="sd">        settings.</span>
</span><span id="PocketFFTBackend-3978"><a href="#PocketFFTBackend-3978"><span class="linenos">3978</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PocketFFTBackend-3979"><a href="#PocketFFTBackend-3979"><span class="linenos">3979</span></a>
</span><span id="PocketFFTBackend-3980"><a href="#PocketFFTBackend-3980"><span class="linenos">3980</span></a>    <span class="n">__ua_domain__</span> <span class="o">=</span> <span class="s2">&quot;numpy.scipy.fft&quot;</span>
</span><span id="PocketFFTBackend-3981"><a href="#PocketFFTBackend-3981"><span class="linenos">3981</span></a>
</span><span id="PocketFFTBackend-3982"><a href="#PocketFFTBackend-3982"><span class="linenos">3982</span></a>    <span class="nd">@staticmethod</span>
</span><span id="PocketFFTBackend-3983"><a href="#PocketFFTBackend-3983"><span class="linenos">3983</span></a>    <span class="k">def</span> <span class="nf">__ua_function__</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="PocketFFTBackend-3984"><a href="#PocketFFTBackend-3984"><span class="linenos">3984</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PocketFFTBackend-3985"><a href="#PocketFFTBackend-3985"><span class="linenos">3985</span></a><span class="sd">        Dispatches FFT operations to SciPy&#39;s PocketFFT with optimized worker </span>
</span><span id="PocketFFTBackend-3986"><a href="#PocketFFTBackend-3986"><span class="linenos">3986</span></a><span class="sd">        settings. This method dynamically selects the appropriate PocketFFT </span>
</span><span id="PocketFFTBackend-3987"><a href="#PocketFFTBackend-3987"><span class="linenos">3987</span></a><span class="sd">        function and applies threading optimizations by adjusting the number </span>
</span><span id="PocketFFTBackend-3988"><a href="#PocketFFTBackend-3988"><span class="linenos">3988</span></a><span class="sd">        of workers.</span>
</span><span id="PocketFFTBackend-3989"><a href="#PocketFFTBackend-3989"><span class="linenos">3989</span></a>
</span><span id="PocketFFTBackend-3990"><a href="#PocketFFTBackend-3990"><span class="linenos">3990</span></a><span class="sd">        Parameters</span>
</span><span id="PocketFFTBackend-3991"><a href="#PocketFFTBackend-3991"><span class="linenos">3991</span></a><span class="sd">        ----------</span>
</span><span id="PocketFFTBackend-3992"><a href="#PocketFFTBackend-3992"><span class="linenos">3992</span></a><span class="sd">        method : callable</span>
</span><span id="PocketFFTBackend-3993"><a href="#PocketFFTBackend-3993"><span class="linenos">3993</span></a><span class="sd">            The FFT function being dispatched.</span>
</span><span id="PocketFFTBackend-3994"><a href="#PocketFFTBackend-3994"><span class="linenos">3994</span></a><span class="sd">        args : tuple</span>
</span><span id="PocketFFTBackend-3995"><a href="#PocketFFTBackend-3995"><span class="linenos">3995</span></a><span class="sd">            Positional arguments passed to the FFT function.</span>
</span><span id="PocketFFTBackend-3996"><a href="#PocketFFTBackend-3996"><span class="linenos">3996</span></a><span class="sd">        kwargs : dict</span>
</span><span id="PocketFFTBackend-3997"><a href="#PocketFFTBackend-3997"><span class="linenos">3997</span></a><span class="sd">            Keyword arguments passed to the FFT function, including</span>
</span><span id="PocketFFTBackend-3998"><a href="#PocketFFTBackend-3998"><span class="linenos">3998</span></a><span class="sd">            the optional &quot;workers&quot; parameter for parallel execution.</span>
</span><span id="PocketFFTBackend-3999"><a href="#PocketFFTBackend-3999"><span class="linenos">3999</span></a>
</span><span id="PocketFFTBackend-4000"><a href="#PocketFFTBackend-4000"><span class="linenos">4000</span></a><span class="sd">        Returns</span>
</span><span id="PocketFFTBackend-4001"><a href="#PocketFFTBackend-4001"><span class="linenos">4001</span></a><span class="sd">        -------</span>
</span><span id="PocketFFTBackend-4002"><a href="#PocketFFTBackend-4002"><span class="linenos">4002</span></a><span class="sd">        result : object</span>
</span><span id="PocketFFTBackend-4003"><a href="#PocketFFTBackend-4003"><span class="linenos">4003</span></a><span class="sd">            The output of the FFT function if supported; </span>
</span><span id="PocketFFTBackend-4004"><a href="#PocketFFTBackend-4004"><span class="linenos">4004</span></a><span class="sd">            otherwise, returns NotImplemented.</span>
</span><span id="PocketFFTBackend-4005"><a href="#PocketFFTBackend-4005"><span class="linenos">4005</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PocketFFTBackend-4006"><a href="#PocketFFTBackend-4006"><span class="linenos">4006</span></a>        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_pocketfft</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="PocketFFTBackend-4007"><a href="#PocketFFTBackend-4007"><span class="linenos">4007</span></a>        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PocketFFTBackend-4008"><a href="#PocketFFTBackend-4008"><span class="linenos">4008</span></a>            <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="PocketFFTBackend-4009"><a href="#PocketFFTBackend-4009"><span class="linenos">4009</span></a>        
</span><span id="PocketFFTBackend-4010"><a href="#PocketFFTBackend-4010"><span class="linenos">4010</span></a>        <span class="n">workers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;workers&quot;</span><span class="p">,</span> <span class="n">CPU_COUNT</span><span class="p">)</span>
</span><span id="PocketFFTBackend-4011"><a href="#PocketFFTBackend-4011"><span class="linenos">4011</span></a>        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>High-performance FFT backend leveraging SciPy's PocketFFT with optimized 
defaults. This backend enhances the efficiency of Fast Fourier Transforms 
(FFT), particularly for 2D transforms, which may experience up to a 50% 
speed improvement over standard configurations.</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>__ua_domain__</strong> (str):
Universal array domain identifier for NumPy's SciPy-based FFT interface.</li>
</ul>

<h6 id="methods">Methods</h6>

<p>__ua_function__(method, args, kwargs)
    Universal array function handler that dispatches FFT operations to the 
    corresponding PocketFFT implementation with optimized threading
    settings.</p>
</div>


                </section>
                <section id="IntensityCenter">
                            <input id="IntensityCenter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">IntensityCenter</span>:

                <label class="view-source-button" for="IntensityCenter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IntensityCenter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IntensityCenter-4014"><a href="#IntensityCenter-4014"><span class="linenos">4014</span></a><span class="k">class</span> <span class="nc">IntensityCenter</span><span class="p">:</span> 
</span><span id="IntensityCenter-4015"><a href="#IntensityCenter-4015"><span class="linenos">4015</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="IntensityCenter-4016"><a href="#IntensityCenter-4016"><span class="linenos">4016</span></a><span class="sd">    Simple center determination for a symmetric diffractogram.</span>
</span><span id="IntensityCenter-4017"><a href="#IntensityCenter-4017"><span class="linenos">4017</span></a><span class="sd">    </span>
</span><span id="IntensityCenter-4018"><a href="#IntensityCenter-4018"><span class="linenos">4018</span></a><span class="sd">    * The center is determined as a center of intensity.</span>
</span><span id="IntensityCenter-4019"><a href="#IntensityCenter-4019"><span class="linenos">4019</span></a><span class="sd">    * This works well for simple, symmetric diffraction patters, which are:</span>
</span><span id="IntensityCenter-4020"><a href="#IntensityCenter-4020"><span class="linenos">4020</span></a><span class="sd">      (i) without beamstopper, (ii) pre-centered, and (iii) powder-like.</span>
</span><span id="IntensityCenter-4021"><a href="#IntensityCenter-4021"><span class="linenos">4021</span></a><span class="sd">    * A real-life example of a simple symmetric diffractogram:</span>
</span><span id="IntensityCenter-4022"><a href="#IntensityCenter-4022"><span class="linenos">4022</span></a><span class="sd">      a good powder electron diffraction pattern from STEMDIFF software.</span>
</span><span id="IntensityCenter-4023"><a href="#IntensityCenter-4023"><span class="linenos">4023</span></a><span class="sd">    * This class is a legacy from previous EDIFF versions;</span>
</span><span id="IntensityCenter-4024"><a href="#IntensityCenter-4024"><span class="linenos">4024</span></a><span class="sd">      it is kept mostly for backward compatibility.</span>
</span><span id="IntensityCenter-4025"><a href="#IntensityCenter-4025"><span class="linenos">4025</span></a><span class="sd">      The functions in this class can be (and should be)</span>
</span><span id="IntensityCenter-4026"><a href="#IntensityCenter-4026"><span class="linenos">4026</span></a><span class="sd">      replaced by a simple call of ediff.center.CenterLocator object.</span>
</span><span id="IntensityCenter-4027"><a href="#IntensityCenter-4027"><span class="linenos">4027</span></a><span class="sd">      </span>
</span><span id="IntensityCenter-4028"><a href="#IntensityCenter-4028"><span class="linenos">4028</span></a><span class="sd">    &gt;&gt;&gt; # Center determination in a simple symmetric diffraction pattern</span>
</span><span id="IntensityCenter-4029"><a href="#IntensityCenter-4029"><span class="linenos">4029</span></a><span class="sd">    &gt;&gt;&gt; # (center = just center_of_intensity, no refinement</span>
</span><span id="IntensityCenter-4030"><a href="#IntensityCenter-4030"><span class="linenos">4030</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="IntensityCenter-4031"><a href="#IntensityCenter-4031"><span class="linenos">4031</span></a><span class="sd">    &gt;&gt;&gt; # (1) Old way = this (old, legacy) IntensityCenter class:</span>
</span><span id="IntensityCenter-4032"><a href="#IntensityCenter-4032"><span class="linenos">4032</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.IntensityCenter.center_of_intensity(</span>
</span><span id="IntensityCenter-4033"><a href="#IntensityCenter-4033"><span class="linenos">4033</span></a><span class="sd">    &gt;&gt;&gt;     arr, csquare=30, cintensity=0.8)</span>
</span><span id="IntensityCenter-4034"><a href="#IntensityCenter-4034"><span class="linenos">4034</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="IntensityCenter-4035"><a href="#IntensityCenter-4035"><span class="linenos">4035</span></a><span class="sd">    &gt;&gt;&gt; # (2) New way = newer (and more universal) CenterLocator class:</span>
</span><span id="IntensityCenter-4036"><a href="#IntensityCenter-4036"><span class="linenos">4036</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.CenterLocator(</span>
</span><span id="IntensityCenter-4037"><a href="#IntensityCenter-4037"><span class="linenos">4037</span></a><span class="sd">    &gt;&gt;&gt;     arr, detection_method=&#39;intensity&#39;, csquare=30, cintensity=0.8)</span>
</span><span id="IntensityCenter-4038"><a href="#IntensityCenter-4038"><span class="linenos">4038</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="IntensityCenter-4039"><a href="#IntensityCenter-4039"><span class="linenos">4039</span></a>    
</span><span id="IntensityCenter-4040"><a href="#IntensityCenter-4040"><span class="linenos">4040</span></a>    <span class="nd">@staticmethod</span>
</span><span id="IntensityCenter-4041"><a href="#IntensityCenter-4041"><span class="linenos">4041</span></a>    <span class="k">def</span> <span class="nf">center_of_intensity</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="IntensityCenter-4042"><a href="#IntensityCenter-4042"><span class="linenos">4042</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="IntensityCenter-4043"><a href="#IntensityCenter-4043"><span class="linenos">4043</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="IntensityCenter-4044"><a href="#IntensityCenter-4044"><span class="linenos">4044</span></a><span class="sd">        </span>
</span><span id="IntensityCenter-4045"><a href="#IntensityCenter-4045"><span class="linenos">4045</span></a><span class="sd">        Parameters</span>
</span><span id="IntensityCenter-4046"><a href="#IntensityCenter-4046"><span class="linenos">4046</span></a><span class="sd">        ----------</span>
</span><span id="IntensityCenter-4047"><a href="#IntensityCenter-4047"><span class="linenos">4047</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="IntensityCenter-4048"><a href="#IntensityCenter-4048"><span class="linenos">4048</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="IntensityCenter-4049"><a href="#IntensityCenter-4049"><span class="linenos">4049</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="IntensityCenter-4050"><a href="#IntensityCenter-4050"><span class="linenos">4050</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="IntensityCenter-4051"><a href="#IntensityCenter-4051"><span class="linenos">4051</span></a><span class="sd">            The intensity center is searched only within the central square.</span>
</span><span id="IntensityCenter-4052"><a href="#IntensityCenter-4052"><span class="linenos">4052</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="IntensityCenter-4053"><a href="#IntensityCenter-4053"><span class="linenos">4053</span></a><span class="sd">            to minimize the effect of an intensity assymetry around center. </span>
</span><span id="IntensityCenter-4054"><a href="#IntensityCenter-4054"><span class="linenos">4054</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="IntensityCenter-4055"><a href="#IntensityCenter-4055"><span class="linenos">4055</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="IntensityCenter-4056"><a href="#IntensityCenter-4056"><span class="linenos">4056</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="IntensityCenter-4057"><a href="#IntensityCenter-4057"><span class="linenos">4057</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="IntensityCenter-4058"><a href="#IntensityCenter-4058"><span class="linenos">4058</span></a><span class="sd">            </span>
</span><span id="IntensityCenter-4059"><a href="#IntensityCenter-4059"><span class="linenos">4059</span></a><span class="sd">        Returns</span>
</span><span id="IntensityCenter-4060"><a href="#IntensityCenter-4060"><span class="linenos">4060</span></a><span class="sd">        -------</span>
</span><span id="IntensityCenter-4061"><a href="#IntensityCenter-4061"><span class="linenos">4061</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="IntensityCenter-4062"><a href="#IntensityCenter-4062"><span class="linenos">4062</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="IntensityCenter-4063"><a href="#IntensityCenter-4063"><span class="linenos">4063</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.    </span>
</span><span id="IntensityCenter-4064"><a href="#IntensityCenter-4064"><span class="linenos">4064</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="IntensityCenter-4065"><a href="#IntensityCenter-4065"><span class="linenos">4065</span></a>        <span class="c1"># Get image/array size</span>
</span><span id="IntensityCenter-4066"><a href="#IntensityCenter-4066"><span class="linenos">4066</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="IntensityCenter-4067"><a href="#IntensityCenter-4067"><span class="linenos">4067</span></a>        <span class="c1"># Calculate borders around the central square</span>
</span><span id="IntensityCenter-4068"><a href="#IntensityCenter-4068"><span class="linenos">4068</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter-4069"><a href="#IntensityCenter-4069"><span class="linenos">4069</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter-4070"><a href="#IntensityCenter-4070"><span class="linenos">4070</span></a>        <span class="c1"># Create central square = cut off the borders</span>
</span><span id="IntensityCenter-4071"><a href="#IntensityCenter-4071"><span class="linenos">4071</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="IntensityCenter-4072"><a href="#IntensityCenter-4072"><span class="linenos">4072</span></a>        <span class="c1"># In the central square, set all values below cintenstity to zero</span>
</span><span id="IntensityCenter-4073"><a href="#IntensityCenter-4073"><span class="linenos">4073</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="IntensityCenter-4074"><a href="#IntensityCenter-4074"><span class="linenos">4074</span></a>        <span class="c1"># Calculate 1st central moments of the image</span>
</span><span id="IntensityCenter-4075"><a href="#IntensityCenter-4075"><span class="linenos">4075</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="IntensityCenter-4076"><a href="#IntensityCenter-4076"><span class="linenos">4076</span></a>        <span class="c1"># Calculate the intensity center = centroid according to www-help</span>
</span><span id="IntensityCenter-4077"><a href="#IntensityCenter-4077"><span class="linenos">4077</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="IntensityCenter-4078"><a href="#IntensityCenter-4078"><span class="linenos">4078</span></a>        <span class="c1"># We have centroid of the central square =&gt; recalculate to whole image</span>
</span><span id="IntensityCenter-4079"><a href="#IntensityCenter-4079"><span class="linenos">4079</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xborder</span><span class="p">,</span><span class="n">yc</span><span class="o">+</span><span class="n">yborder</span><span class="p">)</span>
</span><span id="IntensityCenter-4080"><a href="#IntensityCenter-4080"><span class="linenos">4080</span></a>        
</span><span id="IntensityCenter-4081"><a href="#IntensityCenter-4081"><span class="linenos">4081</span></a>        <span class="c1">## Return the final center</span>
</span><span id="IntensityCenter-4082"><a href="#IntensityCenter-4082"><span class="linenos">4082</span></a>        <span class="k">return</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Simple center determination for a symmetric diffractogram.</p>

<ul>
<li>The center is determined as a center of intensity.</li>
<li>This works well for simple, symmetric diffraction patters, which are:
(i) without beamstopper, (ii) pre-centered, and (iii) powder-like.</li>
<li>A real-life example of a simple symmetric diffractogram:
a good powder electron diffraction pattern from STEMDIFF software.</li>
<li>This class is a legacy from previous EDIFF versions;
it is kept mostly for backward compatibility.
The functions in this class can be (and should be)
replaced by a simple call of <a href="#CenterLocator">ediff.center.CenterLocator</a> object.</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Center determination in a simple symmetric diffraction pattern</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (center = just center_of_intensity, no refinement</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (1) Old way = this (old, legacy) IntensityCenter class:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span> <span class="o">=</span> <span class="n"><a href="#IntensityCenter.center_of_intensity">ediff.center.IntensityCenter.center_of_intensity</a></span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (2) New way = newer (and more universal) CenterLocator class:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span> <span class="o">=</span> <span class="n"><a href="#CenterLocator">ediff.center.CenterLocator</a></span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">arr</span><span class="p">,</span> <span class="n">detection_method</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</code></pre>
</div>
</div>


                            <div id="IntensityCenter.center_of_intensity" class="classattr">
                                        <input id="IntensityCenter.center_of_intensity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">center_of_intensity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">arr</span>, </span><span class="param"><span class="n">csquare</span><span class="o">=</span><span class="mi">20</span>, </span><span class="param"><span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="IntensityCenter.center_of_intensity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IntensityCenter.center_of_intensity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IntensityCenter.center_of_intensity-4040"><a href="#IntensityCenter.center_of_intensity-4040"><span class="linenos">4040</span></a>    <span class="nd">@staticmethod</span>
</span><span id="IntensityCenter.center_of_intensity-4041"><a href="#IntensityCenter.center_of_intensity-4041"><span class="linenos">4041</span></a>    <span class="k">def</span> <span class="nf">center_of_intensity</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="IntensityCenter.center_of_intensity-4042"><a href="#IntensityCenter.center_of_intensity-4042"><span class="linenos">4042</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="IntensityCenter.center_of_intensity-4043"><a href="#IntensityCenter.center_of_intensity-4043"><span class="linenos">4043</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="IntensityCenter.center_of_intensity-4044"><a href="#IntensityCenter.center_of_intensity-4044"><span class="linenos">4044</span></a><span class="sd">        </span>
</span><span id="IntensityCenter.center_of_intensity-4045"><a href="#IntensityCenter.center_of_intensity-4045"><span class="linenos">4045</span></a><span class="sd">        Parameters</span>
</span><span id="IntensityCenter.center_of_intensity-4046"><a href="#IntensityCenter.center_of_intensity-4046"><span class="linenos">4046</span></a><span class="sd">        ----------</span>
</span><span id="IntensityCenter.center_of_intensity-4047"><a href="#IntensityCenter.center_of_intensity-4047"><span class="linenos">4047</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="IntensityCenter.center_of_intensity-4048"><a href="#IntensityCenter.center_of_intensity-4048"><span class="linenos">4048</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="IntensityCenter.center_of_intensity-4049"><a href="#IntensityCenter.center_of_intensity-4049"><span class="linenos">4049</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="IntensityCenter.center_of_intensity-4050"><a href="#IntensityCenter.center_of_intensity-4050"><span class="linenos">4050</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="IntensityCenter.center_of_intensity-4051"><a href="#IntensityCenter.center_of_intensity-4051"><span class="linenos">4051</span></a><span class="sd">            The intensity center is searched only within the central square.</span>
</span><span id="IntensityCenter.center_of_intensity-4052"><a href="#IntensityCenter.center_of_intensity-4052"><span class="linenos">4052</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="IntensityCenter.center_of_intensity-4053"><a href="#IntensityCenter.center_of_intensity-4053"><span class="linenos">4053</span></a><span class="sd">            to minimize the effect of an intensity assymetry around center. </span>
</span><span id="IntensityCenter.center_of_intensity-4054"><a href="#IntensityCenter.center_of_intensity-4054"><span class="linenos">4054</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="IntensityCenter.center_of_intensity-4055"><a href="#IntensityCenter.center_of_intensity-4055"><span class="linenos">4055</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="IntensityCenter.center_of_intensity-4056"><a href="#IntensityCenter.center_of_intensity-4056"><span class="linenos">4056</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="IntensityCenter.center_of_intensity-4057"><a href="#IntensityCenter.center_of_intensity-4057"><span class="linenos">4057</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="IntensityCenter.center_of_intensity-4058"><a href="#IntensityCenter.center_of_intensity-4058"><span class="linenos">4058</span></a><span class="sd">            </span>
</span><span id="IntensityCenter.center_of_intensity-4059"><a href="#IntensityCenter.center_of_intensity-4059"><span class="linenos">4059</span></a><span class="sd">        Returns</span>
</span><span id="IntensityCenter.center_of_intensity-4060"><a href="#IntensityCenter.center_of_intensity-4060"><span class="linenos">4060</span></a><span class="sd">        -------</span>
</span><span id="IntensityCenter.center_of_intensity-4061"><a href="#IntensityCenter.center_of_intensity-4061"><span class="linenos">4061</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="IntensityCenter.center_of_intensity-4062"><a href="#IntensityCenter.center_of_intensity-4062"><span class="linenos">4062</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="IntensityCenter.center_of_intensity-4063"><a href="#IntensityCenter.center_of_intensity-4063"><span class="linenos">4063</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.    </span>
</span><span id="IntensityCenter.center_of_intensity-4064"><a href="#IntensityCenter.center_of_intensity-4064"><span class="linenos">4064</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="IntensityCenter.center_of_intensity-4065"><a href="#IntensityCenter.center_of_intensity-4065"><span class="linenos">4065</span></a>        <span class="c1"># Get image/array size</span>
</span><span id="IntensityCenter.center_of_intensity-4066"><a href="#IntensityCenter.center_of_intensity-4066"><span class="linenos">4066</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="IntensityCenter.center_of_intensity-4067"><a href="#IntensityCenter.center_of_intensity-4067"><span class="linenos">4067</span></a>        <span class="c1"># Calculate borders around the central square</span>
</span><span id="IntensityCenter.center_of_intensity-4068"><a href="#IntensityCenter.center_of_intensity-4068"><span class="linenos">4068</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter.center_of_intensity-4069"><a href="#IntensityCenter.center_of_intensity-4069"><span class="linenos">4069</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter.center_of_intensity-4070"><a href="#IntensityCenter.center_of_intensity-4070"><span class="linenos">4070</span></a>        <span class="c1"># Create central square = cut off the borders</span>
</span><span id="IntensityCenter.center_of_intensity-4071"><a href="#IntensityCenter.center_of_intensity-4071"><span class="linenos">4071</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="IntensityCenter.center_of_intensity-4072"><a href="#IntensityCenter.center_of_intensity-4072"><span class="linenos">4072</span></a>        <span class="c1"># In the central square, set all values below cintenstity to zero</span>
</span><span id="IntensityCenter.center_of_intensity-4073"><a href="#IntensityCenter.center_of_intensity-4073"><span class="linenos">4073</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="IntensityCenter.center_of_intensity-4074"><a href="#IntensityCenter.center_of_intensity-4074"><span class="linenos">4074</span></a>        <span class="c1"># Calculate 1st central moments of the image</span>
</span><span id="IntensityCenter.center_of_intensity-4075"><a href="#IntensityCenter.center_of_intensity-4075"><span class="linenos">4075</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="IntensityCenter.center_of_intensity-4076"><a href="#IntensityCenter.center_of_intensity-4076"><span class="linenos">4076</span></a>        <span class="c1"># Calculate the intensity center = centroid according to www-help</span>
</span><span id="IntensityCenter.center_of_intensity-4077"><a href="#IntensityCenter.center_of_intensity-4077"><span class="linenos">4077</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="IntensityCenter.center_of_intensity-4078"><a href="#IntensityCenter.center_of_intensity-4078"><span class="linenos">4078</span></a>        <span class="c1"># We have centroid of the central square =&gt; recalculate to whole image</span>
</span><span id="IntensityCenter.center_of_intensity-4079"><a href="#IntensityCenter.center_of_intensity-4079"><span class="linenos">4079</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xborder</span><span class="p">,</span><span class="n">yc</span><span class="o">+</span><span class="n">yborder</span><span class="p">)</span>
</span><span id="IntensityCenter.center_of_intensity-4080"><a href="#IntensityCenter.center_of_intensity-4080"><span class="linenos">4080</span></a>        
</span><span id="IntensityCenter.center_of_intensity-4081"><a href="#IntensityCenter.center_of_intensity-4081"><span class="linenos">4081</span></a>        <span class="c1">## Return the final center</span>
</span><span id="IntensityCenter.center_of_intensity-4082"><a href="#IntensityCenter.center_of_intensity-4082"><span class="linenos">4082</span></a>        <span class="k">return</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find center of intensity/mass of an array.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>arr</strong> (2D-numpy array):
The array, whose intensity center will be determined.</li>
<li><strong>csquare</strong> (int, optional, default is 20):
The size/edge of the square in the (geometrical) center.
The intensity center is searched only within the central square.
Reasons: To avoid other spots/diffractions and
to minimize the effect of an intensity assymetry around center.</li>
<li><strong>cintensity</strong> (float, optional, default is 0.8):
The intensity fraction.
When searching the intensity center, we will consider only
pixels with intensity &gt; max.intensity.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xc,yc</strong> (float,float):
XY-coordinates of the intensity/mass center of the array.
Round XY-coordinates if you use them for image/array calculations.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>