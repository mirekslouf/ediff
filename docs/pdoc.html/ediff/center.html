<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>ediff.center API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../ediff.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;ediff</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#module-ediffcenter">Module: ediff.center</a></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#CenterLocator">CenterLocator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CenterLocator.output">output</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.save_results">save_results</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.load_results">load_results</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.get_circle_pixels">get_circle_pixels</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.intensity_sum">intensity_sum</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.intensity_variance">intensity_variance</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.convert_coords">convert_coords</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterLocator.visualize_results">visualize_results</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CenterDetermination">CenterDetermination</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CenterDetermination.preprocess">preprocess</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_intensity">detection_intensity</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_Hough">detection_Hough</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.detection_3points">detection_3points</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.adjustment_3points">adjustment_3points</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.calculate_circle">calculate_circle</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.get_radius">get_radius</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterDetermination.visualize_center">visualize_center</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CenterRefinement">CenterRefinement</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CenterRefinement.ref_interactive">ref_interactive</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterRefinement.ref_var">ref_var</a>
                        </li>
                        <li>
                                <a class="function" href="#CenterRefinement.ref_sum">ref_sum</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HandlerCircle">HandlerCircle</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HandlerCircle.create_artists">create_artists</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#IntensityCenter">IntensityCenter</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#IntensityCenter.center_of_intensity">center_of_intensity</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../ediff.html">ediff</a><wbr>.center    </h1>

                        <div class="docstring"><h2 id="module-ediffcenter">Module: <a href="">ediff.center</a></h2>

<p>Find the center of a 2D diffraction pattern.</p>

<ul>
<li>The center determination may be surprisingly tricky in certain cases.</li>
<li>Nevertheless, the user just calls the CenterLocator class as shown below.</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Example: How to use CenterLocator and get results?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ediff</span> <span class="k">as</span> <span class="nn">ed</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">center</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">CenterLocator</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">input_image</span><span class="o">=</span><span class="s1">&#39;some_diffractogram.png&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">determination</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">refinement</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">messages</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">final_replot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determined center coordinates:&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Refined center coordinates   :&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</code></pre>
</div>
</div>

                        <input id="mod-center-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-center-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">Module: ediff.center</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">--------------------</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">Find the center of a 2D diffraction pattern.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">* The center determination may be surprisingly tricky in certain cases.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">* Nevertheless, the user just calls the CenterLocator class as shown below.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">&gt;&gt;&gt; # Example: How to use CenterLocator and get results?</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">&gt;&gt;&gt; import ediff as ed</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="sd">&gt;&gt;&gt;</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">&gt;&gt;&gt; center = ed.center.CenterLocator(</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">&gt;&gt;&gt;    input_image=&#39;some_diffractogram.png&#39;,</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">&gt;&gt;&gt;    determination=&#39;intensity&#39;,</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">&gt;&gt;&gt;    refinement=&#39;sum&#39;,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">&gt;&gt;&gt;    messages=False, final_replot=True)</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">&gt;&gt;&gt;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">&gt;&gt;&gt; print(&#39;Determined center coordinates:&#39;, center.x1, center.y1)</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">&gt;&gt;&gt; print(&#39;Refined center coordinates   :&#39;, center.x2, center.y2)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="c1"># CenterDet</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="c1"># PS 2023-10-06: CentDet update, methods compatibility</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="c1"># MS 2023-11-26: Improved code formatting and docs + TODO notes for PS</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="c1"># MS 2024-23-09: Re-desing/draft of CenterLocator =&gt; CenterLocator_new</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="c1">#   # CenterLocator - beter structure, clearer usage, saving/reading to files</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="c1">#   import ediff as ed</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="c1">#   CENTER = ed.center.CenterlLocator(args)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="c1">#   print(CENTER.x1,CENTER.y1)  # center coords after CenterDetermination</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="c1">#   print(CENTER.x2,CENTER.y2)  # center coords after CenterDetermination</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>    
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">import</span> <span class="nn">skimage</span> <span class="k">as</span> <span class="nn">sk</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">from</span> <span class="nn">matplotlib.legend_handler</span> <span class="kn">import</span> <span class="n">HandlerBase</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="kn">import</span> <span class="nn">ediff.io</span> 
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">moments</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">hough_circle</span><span class="p">,</span> <span class="n">hough_circle_peaks</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="k">class</span> <span class="nc">CenterLocator</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    CenterLocator object - determine and refine a diffractogram center.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">    Parameters</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    ----------</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">        The input image representing a 2D diffraction pattern, either as a </span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">        file path or a NumPy array.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">    determination : str or None, optional, default is None</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">        The method used for the initial center determination.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">        Options include:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">        - &#39;manual&#39;: Manual detection - user defines 3 points</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">          on selected diffraction ring.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">        - &#39;hough&#39;: Auto-detection - Hough transform for circle detection.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">        - &#39;intensity&#39;: Auto-detection - intensity center in central region.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">    refinement : str or None, optional, default is None</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        The method used for the final center refinement.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        Options include:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">        - &#39;manual&#39;: Manual adjustment - user adjust the position</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">          of the selected diffration ring.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        - &#39;sum&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">          with maximal sum of intensities.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">        - &#39;var&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">          with minimal variance of intensities.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">    in_file : str, optional, default is None</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">        Filename of the text file</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        for saving the center coordinates.</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">    out_file : str, optional, default is None</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">        Filename of the text file</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">        for loading the previously saved center coordinates.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">    heq : bool, optional, default is False</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        Flag to indicate whether to perform histogram equalization </span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">        on the input image.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        The equalization is done internally,</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">        the image on the screen remains unchanged.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">    icut : float, optional, default is None</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">        Cut-off intensity level for processing the image.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">    cmap : str, optional, default is &#39;gray&#39;</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">        Colormap to be used for displaying the image. </span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">    csquare : int, optional, default is 50</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">        Size of the central square,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        within which we will search the intensity center.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">    cintensity : float, optional, default is 0.8</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">        Threshold intensity</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        for finding the intensity center.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        Pixels with a (relative) intensity lower than cintensity are ignored.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">    messages : bool, optional, default is False</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        Flag to enable or disable informational messages during processing. </span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">    print_sums : bool, optional, default is False</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">        If True, prints the sum of intensity values for the refined circle </span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">        after each adjustment, relevant only for manual methods of center </span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">        determination and refinement.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    final_print : bool, optional, default is True</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">        If True, print determined and refined coordinates to stdout.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd"> </span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">    Returns</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">    -------</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">    None</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        The center coordinates are stored in instance variables</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        (x1,y1) for the determined center and</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        (x2,y2) for the refined center.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        Look at the initial example at the top of this module</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">        to see how to use CenterLocator class.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">            </span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">    Technical notes</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">    ---------------</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">    * The class initializes (and runs) two sub-classes (= processes),</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">      CenterDetermination and CenterRefinement.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">    * The two sub-classes/processes are hidden to common user,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">      altough they could be run separately.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>    
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>    
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>                 <span class="n">messages</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>                 <span class="n">final_print</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>        <span class="c1">## (0) Initialize input attributes</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="c1"># Input image = diffraction pattern</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="c1"># (it can be either image file or numpy array</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="c1"># Methods of center determination and center refinement</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="c1"># For reproducibility, convert the method names to lowercase</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="k">if</span> <span class="n">determination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="c1"># Text files for reading/saving center coordinates</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">in_file</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="c1"># Additional parameters</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">=</span> <span class="n">heq</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="o">=</span> <span class="n">icut</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span> <span class="o">=</span> <span class="n">csquare</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span> <span class="o">=</span> <span class="n">cintensity</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="n">messages</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span> <span class="o">=</span> <span class="n">print_sums</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span> <span class="o">=</span> <span class="n">final_print</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="c1">## (1) Initialize new attributes</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="c1"># The value of the following attribute can be adjusted</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">=</span> <span class="mi">100</span>          
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>        <span class="c1">## (2) Read input image</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="c1"># The input image can be numpy.array (ndarray) or image file (path/str)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">ediff</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>            
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>        <span class="c1">## (3) Read center coordinates</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>        
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="c1"># * The center coordinates may have been determined</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="c1">#   in a previous run of the program and saved to a text file.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="c1"># * We can Load coordinates from an input file if specified,</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="c1">#   this is done by the following commant.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="c1"># * As the saved coordinates can be used INSTEAD of CenterDetermination</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="c1">#   we will read them here.</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_results</span><span class="p">()</span>  
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="c1">## (4) Run CenterDetermination</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>        <span class="c1"># (4a) Initialize/run CenterDetermination</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center1</span> <span class="o">=</span> <span class="n">CenterDetermination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="p">,</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span><span class="p">,</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="c1"># (4b) Find radius of a circle/diffraction ring,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="c1">#      which is needed for the next step = CenterRefimenement.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">!=</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="c1">## (5) Initialize/run CenterRefinement</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center2</span> <span class="o">=</span> <span class="n">CenterRefinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span> 
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="p">,</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span> 
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="c1">## (6) Collect results from CenterDetermination + CenterRefinement</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="c1">## (7) Switch coordinates if necessary</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">):</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;hough&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="c1">## (8) Print the coordinates if required</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>            
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)))</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>            
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)))</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>                        
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="c1">## (9) Save results to a .txt file if specified</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span><span class="p">()</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        Return the final results of center determination and refinement. </span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        </span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">        Returns</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        -------</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">        x1 : float</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">            x-coordinate of the center from *determination* method</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">        y1 : float</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">            y-coordinate of the center from *determination* method</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        x2 : float</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">            x-coordinate of the center from *refinement* method</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">        y2 : float</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">            y-coordinate of the center from *refinement* method</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">            </span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">        Technical note</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">        --------------</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">        * The function always returns four parameters.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">        * In most cases, the output are four coordinates (x1,y1,x2,y2).</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">        * If the *refinement* method was None, the output is (x1,y1,x1,y1);</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">          i.e. the *determined* and *refined* center coordinates are the same.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="c1"># (1) Refinement method was not None =&gt; prepare (x1,y1,x2,y2)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="c1"># Convert to float</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> \
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> 
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)]</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="c1"># (2) Refinement method was None =&gt; prepare (x1,y1) = (x2,y2)                      </span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="c1"># Convert to float</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> \
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="c1"># Define x2,y2 = x1,y1</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>            
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="c1"># (3) Return (rounded) values of center coordinates</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>    
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">        Save the current results to a specified file. The results are formatted </span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">        to four decimal places for clarity.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">        </span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">        This method checks if a file path has been provided through </span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        the `in_file` attribute. </span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        </span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">        - If the specified file exists, the method appends the results </span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="sd">        (x1, y1, x2, y2) to the end of the file. </span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">        - If the file does not exist, it creates a new file and writes </span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">        the results to it.</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">        </span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">        </span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">        Parameters</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">        ----------</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">        None</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">        </span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">        Returns</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">        -------</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">        None</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">        </span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">        Notes</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">        -----</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">        - The results are written in the format:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>            <span class="c1"># Check if the specified file exists</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">):</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                <span class="c1"># Append results to in_file</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in append mode</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                <span class="c1"># If the file does not exist, create it and write results</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in write mode</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>    <span class="k">def</span> <span class="nf">load_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">        Load results from a specified text file.</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">    </span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        This method reads the coordinates from a text file defined by the </span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">        `out_file` attribute. It extracts pairs of coordinates (x1, y1) and </span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        (x2, y2) from each line in the file. The extracted values are stored in </span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        lists, allowing for the retrieval of multiple results.The most recent </span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">        values of x1, y1, x2, and y2 can be stored as instance variables</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        for easy access.</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">    </span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        Parameters</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        ----------</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">        None</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">    </span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">        Returns</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">        -------</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">        None</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">    </span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">        Notes</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">        -----</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        - The results are expected to be in the format:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">        - If multiple sets of coordinates are found, they are stored in lists,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">        and only the last set can be accessed as instance variables.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">        &#39;&#39;&#39;</span>        
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                <span class="c1"># Initialize lists to hold multiple values</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                <span class="n">x1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>                <span class="n">y1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                <span class="n">x2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                <span class="n">y2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>    
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>                    <span class="c1"># Strip and split each line to get the coordinates</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>                        <span class="c1"># Extract x1 and y1 or x2 and y2 based on line content</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>                        <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>                            <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>                            <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                            <span class="n">x1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                            <span class="n">y1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                        <span class="k">elif</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>                            <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                            <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>                            <span class="n">x2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                            <span class="n">y2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>    
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>                <span class="c1"># Store the last set of values as instance variables </span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>    
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                <span class="c1"># Store the last loaded values:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>                <span class="k">if</span> <span class="n">x1_values</span> <span class="ow">and</span> <span class="n">y1_values</span> <span class="ow">and</span> <span class="n">x2_values</span> <span class="ow">and</span> <span class="n">y2_values</span><span class="p">:</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>    
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error reading text file with center coordinates!&quot;</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>    <span class="k">def</span> <span class="nf">get_circle_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">        Get coordinates of pixels defining circle border</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">    </span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">        Parameters</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">        ----------</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">        self.image_path : str</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">            direct path to a image with diffraction patterns</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">        xc : float64</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">        yc : float64</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        radius : float64</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">        num_points : float64 </span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">            number of border points. The default is 360</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">        </span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">        Returns</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">        -------</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">        x : array of float64</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">            x-coordinates of pixels from circle border</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">        y : array of float64</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">            y-coordinates of pixels from circle border</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">            </span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="c1"># Generate angles from 0 to 2*pi</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>  
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>                
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="c1"># Calculate x,y-coordinates of points on the actual circle border</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="n">x_actual</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="n">y_actual</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="k">return</span> <span class="n">x_actual</span><span class="p">,</span> <span class="n">y_actual</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>          
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>    
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>    <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        Summation of intensity values of pixels of a diffraction pattern.</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        Parameters</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">        ----------</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        image : array of uint8</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">        px : float64</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">        py : float64</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">        pr : float64</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        Returns</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">        -------</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">        s : float64</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">            intensity sum</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pyc</span><span class="p">,</span> <span class="n">pxc</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">pxc</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>    
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>    
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>    <span class="k">def</span> <span class="nf">intensity_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">        Variance of intensity values of pixels of a diffraction pattern.</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">        Parameters</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">        ----------</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a><span class="sd">        image : array of uint8</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="sd">        px : float64</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">        py : float64</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">        pr : float64</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">        Returns</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">        -------</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        s : float64</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">            intensity variance</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span><span class="p">])</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>    
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>    
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>    <span class="k">def</span> <span class="nf">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">        Convert coordinates between numpy and matplotlib systems.</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="sd">    </span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="sd">        Parameters:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a><span class="sd">        ----------</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">        x : int or float</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a><span class="sd">            The x-coordinate in the numpy (column index) format.</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a><span class="sd">        y : int or float</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">            The y-coordinate in the numpy (row index) format.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="sd">    </span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        Returns:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">        -------</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">        tuple of (int or float, int or float)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">            The converted coordinates in matplotlib format, where:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">            - First element corresponds to y (new x in matplotlib).</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">            - Second element corresponds to x (new y in matplotlib).</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">        Visualize diffractogram and its center after</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">        center determination + refinement.</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">    </span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">        Parameters</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="sd">        ----------</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">        csquare : int, optional, default is None</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="sd">            If csquare argument is given,</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">            only the central square of the diffractogram will be plotted;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">            the size of the central square will be equal to csquare argument.</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">    </span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">        Returns</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">        -------</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">        None</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">            The output is the image of the diffractogram</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">            showing also the central coordinates and refinement ring.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>        
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="c1"># (0) Collect center coordinates and radii</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>        <span class="c1"># x1,y1,r1 = coordinates and radius of the determined circle/ring</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="c1"># x2,y2,r2 = coordinates and radius of the refined circle/ring</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>        <span class="n">r2</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>        
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="c1"># (1) Prepare the image of the diffractogram</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="c1"># ...copy diffractogram image</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="c1"># ...cut image intensity if required</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>            
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>        <span class="c1"># (2) Calculate intensity sum or intensity variance</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>            <span class="c1"># Refinement was based on minimizing the intensity variance</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>            <span class="n">dvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>            <span class="n">rvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-var: </span><span class="si">{</span><span class="n">dvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>                <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-var: </span><span class="si">{</span><span class="n">rvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="c1"># All other cases: manual refinement or maximixing intensity sum</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="n">dsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>            <span class="n">rsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>                <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-sum: </span><span class="si">{</span><span class="n">dsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>                <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-sum: </span><span class="si">{</span><span class="n">rsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="c1"># (3) Calculate xy-limits if we want to see only the central square</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="c1"># (if csquare argument was given, we will plot only the central square</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="c1"># (to achieve this, we pre-calculate params for ax.set_xlim/set_ylim</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="c1"># (the precalculated parameters will be used below during plotting</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>            <span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>            <span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">edge</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">edge</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">edge</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>            <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">edge</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>    
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="c1"># (4) Final plot: show the diffractogram + refinement results</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="c1"># ...prepare figure</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="c1"># ...show diffraction pattern</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>        <span class="c1"># ...set the title of the whole figure</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>            <span class="sa">f</span><span class="s1">&#39;Center Location (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="c1"># ...add initial center (after CenterDetermination)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labeld</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="c1"># ...add initial circle (after CenterDetermination)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="n">c0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">r1</span><span class="p">,</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detected&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>    
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="c1"># ...add final center coordinates (after CenterRefinement)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labelr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;springgreen&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="c1"># ...add final cirlce (after CenterRefinement)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>        <span class="n">c1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span> <span class="n">r2</span><span class="p">,</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;springgreen&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refined&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="c1"># ...move legend to the top right next to the image</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1">#fontsize=10,</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                  <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="n">Circle</span><span class="p">:</span> <span class="n">HandlerCircle</span><span class="p">()},</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.98</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> 
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                  <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="c1"># ...set xlim/ylim if we want to see only the central square</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>  <span class="c1"># the xmin/xmax were pre-calculated above</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span>  <span class="c1"># the ymin/ymax were pre-calculated above</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="c1"># ...do not hide axis decorations = labels, spines, ticks...</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="c1"># ...show the plot</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>    
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="k">class</span> <span class="nc">CenterDetermination</span><span class="p">:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">    CenterDetermination object - initial detection of a diffractogram center.</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">    This class is responsible for identifying the center coordinates of </span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">    a 2D diffraction pattern image using various detection methods specified </span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">    by the user. It initializes with the input image and other parameters</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">    that influence the center detection process.</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">    Parameters</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">    ----------</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">        Reference to the parent CenterLocator object, allowing access </span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">        to shared attributes and methods.</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">        The input image representing a 2D diffraction pattern, provided as </span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">        a file path or a NumPy array.</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">    determination : str or None, optional, default is None</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">        The method used for the initial center determination.</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">        Options include:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        - &#39;manual&#39;: Manual detection - user defines 3 points</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">          on selected diffraction ring.</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">        - &#39;hough&#39;: Auto-detection - Hough transform for circle detection.</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        - &#39;intensity&#39;: Auto-detection - intensity center in central region.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">    in_file : str, optional</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        Filename of the text file from which to load previously saved </span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">        center coordinates.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">    out_file : str, optional</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">        Filename of the text file to which the detected center coordinates </span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="sd">        will be saved.</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">    heq : bool, optional</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">        Flag to indicate whether to perform histogram equalization on the </span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">        input image. Default is False.</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">    icut : float, optional</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">        Cut-off intensity level for processing the image. Default is None.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">    cmap : str, optional</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">        Colormap to be used for displaying the image. Default is &#39;gray&#39;.</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">    csquare : int, optional</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">        Size of the square for processing. Default is 50.</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">    cintensity : float, optional</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">        Threshold intensity for detecting features in the image. Default is</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">        0.8.</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">    messages : bool, optional</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">        Flag to enable or disable informational messages during processing. </span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">        Default is False.</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">    print_sums : bool, optional</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">        If True, prints the sum of intensity values for the detected circle</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="sd">        after each adjustment, relevant only for manual detection methods.</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">    Returns</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">    -------</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">    None</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">    Notes</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">    -----</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">    - The class preprocesses the input image and then applies the specified </span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">      center detection method.</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">    - The detected center coordinates are stored in instance variables</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">      `x`, `y`, and `r`, representing the center&#39;s x-coordinate, </span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">      y-coordinate, and radius, respectively.</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>    
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                 <span class="n">input_image</span><span class="p">,</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                 <span class="n">messages</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="c1">## (0) Initialize input attributes</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="c1">## (1) Initialize new attributes</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="c1">## (2) Run functions</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="c1"># (2a) Preprocess data</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">preInit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>        
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        <span class="c1"># (2b) Center detection methods</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="k">if</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_3points</span><span class="p">()</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hough&quot;</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_Hough</span><span class="p">()</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_intensity</span><span class="p">(</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span> 
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cintensity</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>                <span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>                
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected determination method does not exist.&quot;</span><span class="p">)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>    <span class="c1">## Functions::</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">preInit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preHough</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preManual</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                   <span class="n">preVar</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preSum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preInt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; FOR AUTOMATIC METHODS OPTIMIZATION AND MORE UNIVERSAL SOLUTIONS</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a><span class="sd">        Function for input image preprocessing based on the methods </span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a><span class="sd">        defined in the class initialization - self.detection_method, </span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a><span class="sd">        self.correction_method.</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a><span class="sd">        Parameters</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a><span class="sd">        ----------</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a><span class="sd">        preInit : bool, optional</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a><span class="sd">            Perform preprocessing of the input image (when using icut or heq). </span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a><span class="sd">            This is called automatically every time, if no preprocessing</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">            specified, the detection and refinement will be performed on </span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a><span class="sd">            original image. The default is 0.</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="sd">        preHough : bool, optional</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">            Perform preprocessing for automatic detection via Hough transform. </span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">            </span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">        Returns</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">        -------</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">        manu : NumPy array</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">            Pre-processed image for the manual detection method</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a><span class="sd">        edges : array of bool</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="sd">            Detected edges via Canny detector for automatic Hough transform</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="c1"># Flags</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="n">control_print</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="c1"># Load original image</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>        <span class="c1">### After initialization: perform an image enhancement if specified</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="k">if</span> <span class="n">preInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="c1"># Enhance diffraction pattern to make it more visible</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Histogram equalized.&quot;</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">equalize_adapthist</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>                
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="c1"># # Edit contrast with a user-predefined parameter</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="c1"># if self.parent.icut is not None:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="c1">#     if self.parent.messages:</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="c1">#         print(&quot;Contrast enhanced.&quot;)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="c1">#     image = np.where(image &gt; self.parent.icut, </span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>            <span class="c1">#                      self.parent.icut, </span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="c1">#                      image)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            <span class="k">return</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="c1">### Hough transform: perform pre-processing necessary for the detection</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="k">if</span> <span class="n">preHough</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>           
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>                
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beamstopper removed.&#39;</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                    <span class="n">max_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                    
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                    
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>                            <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>                            <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                            <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>                    
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                    
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                    <span class="c1"># Erode the dilated edges to reduce thickness and smooth the contour</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                        
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No beamstopper.&#39;</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                                             <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                                             <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                                             <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                    
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                    
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                    <span class="c1"># Erode the dilated edges to reduce thickness and smooth the contour</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                    <span class="n">connected_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                        <span class="n">connected_edges</span><span class="p">,</span> 
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>                        <span class="n">min_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                    
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,)</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                <span class="c1"># Central square extraction</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>                <span class="k">if</span> <span class="mf">0.4</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.6</span><span class="p">:</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>                    
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>    
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>    
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>                                                     
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                    
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>                      <span class="c1">#  ax[1,1].imshow(connected_edges)</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>                    
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>                    
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>            <span class="k">return</span> <span class="n">edges</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>    
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>    <span class="k">def</span> <span class="nf">detection_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="p">,</span> <span class="n">cintensity</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">        </span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">        Parameters</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">        ----------</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">            The intensity center will be searched only within the central square.</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">            to minimize the effect of possible intensity assymetry around center. </span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">            </span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">        Returns</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        -------</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">        &#39;&#39;&#39;</span>  
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="c1"># (1) Get image/array size</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>        
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="c1"># (2) Calculate borders around the central square</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="c1"># (3) Create the central square,</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="c1"># from which the intensity center will be detected</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="c1"># (4) In the central square,</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="c1"># set all values below cintenstity to zero</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>        <span class="c1"># (5) Determine the intensity center from image moments</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>        <span class="c1"># see image moments in...</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="c1"># skimage: https://scikit-image.org/docs/dev/api/skimage.measure.html</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="c1"># wikipedia: https://en.wikipedia.org/wiki/Image_moment -&gt; Centroid</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>        <span class="c1"># ---</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="c1"># (a) Calculate 1st central moments of the image</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>        <span class="c1"># (b) Calculate the intensity center = centroid according to www-help</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="c1"># (c) We have centroid of the central square</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>        <span class="c1"># but we have to recalculate it to the whole image</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">xborder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">yborder</span><span class="p">)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="c1"># (d) Radius of a diffraction ring is hardcoded to 100 here</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="c1"># (6) User information (if required)</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (IntensityCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="c1"># (7) Plot results (if required)</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="c1"># (8) Return the results:</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="c1"># ! radius of the circle is just hardcoded here - see TODO note above</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>    
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>    <span class="k">def</span> <span class="nf">detection_Hough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;        </span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        Perform Hough transform to detect center of diffraction patterns.</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">        This is a method to automatically detect circular diffraction patterns</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">        </span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        Parameters</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">        ----------</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">            Default is 1. To cancel visualization, set plot_results = 0.</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">        Returns</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">        -------</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">        self.x : float64</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">        self.y : float64</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">        self.r : float64</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">                                    </span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="c1">## Image preprocessing</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="c1"># if the brightness of the image is small enough, pixel values greater</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="c1"># than 50 will be set to 0 -- removal of the beam stopper influence</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">:</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>                    <span class="n">im</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>                
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>            <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>                                     <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>                                     <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">:</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>                <span class="n">max_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>                <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>                <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>            
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>            <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>                                     <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> 
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                                     <span class="n">high_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>        <span class="c1"># Define the radii range for the concentric circles</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="c1"># (set empirically based on the available pictures)</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>        <span class="n">min_radius</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="n">max_radius</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="n">radius_step</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span> <span class="o">+</span> <span class="n">radius_step</span><span class="p">,</span> <span class="n">radius_step</span><span class="p">)</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="c1">### Perform the Hough transform to detect circles</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>        <span class="c1"># Circle detection involves converting edge pixels into parameter space, </span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>        <span class="c1"># where each point represents a possible circle center and radius. </span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>        <span class="c1"># The circles are then identified as peaks in the parameter space, </span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>        <span class="c1"># enabling accurate detection of circular shapes in the image.</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>        <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>        <span class="c1"># Extract the circle peaks</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>        <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> 
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                                                            <span class="n">radii</span><span class="p">,</span> 
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                                                            <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>        
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>        <span class="c1"># User information:</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (HoughTransform) : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> \
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="c1"># (7) Plot results (if required)</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>           
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>        <span class="c1"># Return results, convert coordinates to float</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>   
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>    <span class="k">def</span> <span class="nf">detection_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">        In the input image, select manually 3 points defining a circle using</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">        a key press event </span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">            - press &#39;1&#39; to select a point</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">                </span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">        If the user is not satisfied with the point selection, it can be</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a><span class="sd">        deleted using a key press event:</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">            - press &#39;2&#39; to delete the most recent</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">            - press &#39;3&#39; to delete the point closest to the cursor</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">        </span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">        If the user is satisified with the points selected, the rest </span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">        of the program will be executed </span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">            - press &#39;d&#39; to proceed &gt;DONE&lt;</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">        </span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">        Coordinates of the center and radius will be calculated automatically</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">        using method self.calculate_circle()</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">        </span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">        In addition, the user will be able to manually adjust the original</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">        center position by using pre-defined keys.</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">        </span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">        Parameters</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">        ----------</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">            Default is 1. To cancel visualization, set plot_results = 0.</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">        </span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">        Returns</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">        -------</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">        self.x : float64</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">        self.y : float64</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">        self.r : float64</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">            (if available, othervise returns None)</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">                                    </span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>        <span class="c1"># Load image</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>            
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a> 
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Select 3 points defining one of diffraction circles&quot;</span><span class="p">,</span> 
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                  <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="c1"># User information:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="sd">            CenterDetermination :: ThreePoints (semi-automated method)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="sd">            Select 3 points to define a diffraction circle using keys:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a><span class="sd">              - &#39;1&#39; : define a point at current cursor position</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">              - &#39;2&#39; : delete the last point</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">              - &#39;3&#39; : delete the point closest to the cursor</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">              - &#39;d&#39; : done = finished = go to the next step</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">            Close the figure to terminate. No center will be detected.</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>       
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="c1"># Enable interactive mode</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>        <span class="c1"># (figure is updated after every plotting command</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="c1"># (so that calling figure.show() is not necessary</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a> 
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="c1"># Initialize the list of coordinates</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span> 
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>        
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="c1"># Initialize all flags and counters</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>        <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># press &#39;d&#39; event</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># close window event</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>        <span class="n">point_counter</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># number of selected points</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execution terminated.&#39;</span><span class="p">)</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a> 
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>        
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="c1">### Define the callback function for key press events</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>        <span class="k">def</span> <span class="nf">onkeypress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>            <span class="c1"># nonlocal to modify the flag variable in the outer scope</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>            <span class="k">nonlocal</span> <span class="n">calculate_circle_flag</span><span class="p">,</span> <span class="n">point_counter</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="c1"># Store the zoom level</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>            <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a> 
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>            <span class="c1">## Delete points -- the closest to the cursor</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>                <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>                    <span class="n">pointer_x</span><span class="p">,</span> <span class="n">pointer_y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">pointer_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">pointer_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">]</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>                    <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">closest_index</span><span class="p">]</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>    
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>                    <span class="c1">## Redraw the image without the deleted point</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>                    <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>                        <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>                        <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>                    
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>                    
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>    
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>            <span class="c1"># Delete recent point (last added) -- independent on the cursor</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>                <span class="c1"># Check if there are points to delete</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>                    <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>                        <span class="c1"># Delete the last point in the list</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>    
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>                        <span class="c1"># Redraw the image without the deleted point</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                                  <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                                       <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>                                       <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>                        <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>                            <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>                            <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">)</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                        
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                        <span class="c1"># Retore the previous zoom level</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                    
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>            <span class="c1">## Select points </span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                <span class="c1"># Only allow selecting up to three points</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>                    <span class="c1"># Save the coordinates of the clicked point</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>                    <span class="n">new_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>                    
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>                    <span class="k">if</span> <span class="n">new_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>                        <span class="c1"># Do not allow multiple selection of one point</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The selected point already exists.&quot;</span><span class="p">)</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>                        <span class="c1"># Add selected point</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>                        <span class="c1"># Visualize the selected point on the image</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>                        <span class="c1"># Restore the previous zoom level</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>    
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>                        <span class="n">point_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>    
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>                    <span class="c1"># Turn off interactive mode</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>    
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>    
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>            <span class="c1"># Calculate circle or terminate</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>                    <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a> 
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select exactly 3 points to calculate the circle.&quot;</span><span class="p">)</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>    
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="n">cid0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress</span><span class="p">)</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>        <span class="c1"># Show the plot</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>      
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        <span class="c1"># Wait for &#39;d&#39; key event or close the figure if no points are selected</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">calculate_circle_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a> 
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>                <span class="c1"># Store the zoom level</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>                <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>                <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a> 
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>                <span class="c1"># Plot detected diffraction pattern</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                <span class="k">if</span> <span class="n">calculate_circle_flag</span><span class="p">:</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a> 
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_circle</span><span class="p">(</span><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>                    
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>                 
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>                    <span class="c1"># Plot center point</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>                    <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the position of the center using keys.&#39;</span><span class="p">)</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>                    <span class="c1"># Display the image</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution manually interrupted by user.&quot;</span><span class="p">)</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>                <span class="k">break</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ValueError:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>                <span class="k">break</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>           
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points selected. Returned None values.&quot;</span><span class="p">)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>             <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>        
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>        <span class="c1"># Disconnect key press events</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">cid0</span><span class="p">)</span> 
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>        
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="c1"># local variables save</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>        
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>        <span class="c1"># Manually adjust the calculated center coordinates</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjustment_3points</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>        <span class="c1"># Return the results:</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>    
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>    
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>    <span class="k">def</span> <span class="nf">adjustment_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a><span class="sd">        Adjustment of the center position calculated from 3 points.</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="sd">        Interactive refinement using keys:</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a><span class="sd">        The user can change the position of the center of the diffraction</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a><span class="sd">        pattern and also the radius of the detected pattern using keys:</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a><span class="sd">            - left / right / top / down arrows : move left / right / top / down</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a><span class="sd">            - &#39;+&#39; : increase radius</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="sd">            - &#39;-&#39; : decrease radius</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">            - &#39;d&#39; : done, termination of the refinement</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="sd">        If the interactive figure is closed without any modifications,</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="sd">        the function returns input variables and the proccess terminates.</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="sd">        </span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a><span class="sd">        Parameters</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a><span class="sd">        ----------</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a><span class="sd">        fig : figure.Figure object</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a><span class="sd">            interactive figure in which a diffraction pattern has been</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">            manually detected.</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="sd">        circle : patches.Circle object</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">            circle defined via 3 points manually delected</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">        center : tuple</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">            calculated center of the input circle.</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">        plot_results : boolean</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">            visualize results. The default is 1 (plot detected center).</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="sd">        Returns</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">        -------</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">        xy : tuple</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">            x,y-coordinates of the center of the diffraction pattern.</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">        r : integer</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">        &#39;&#39;&#39;</span>            
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="c1"># Remove default left / right arrow key press events</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a><span class="sd">            CenterDetermination :: ThreePoints (interactive adjustment)</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="sd">            Use these keys:</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="sd">              - &#39;&#39; : move left</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">              - &#39;&#39; : move right</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a><span class="sd">              - &#39;&#39; : move up</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">              - &#39;&#39; : move down</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">              - &#39;+&#39; : increase circle radius</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="sd">              - &#39;-&#39; : decrease circle radius</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="sd">              - &#39;b&#39; : increase step size</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">              - &#39;l&#39; : decrease step size</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">              - &#39;d&#39; : refinement done</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a><span class="sd">                  </span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a><span class="sd">            DISCLAIMER: For the purpose of the center position adjustment, </span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a><span class="sd">                        the default shortcuts for arrows were removed.</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>        
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>            
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>        
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>          
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>        
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>        
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                    
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>            
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>        
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>            <span class="c1"># Change step size </span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>        
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>        
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>        
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>            <span class="c1"># Update the plot</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>                
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>        
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>               
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>                
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>        
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>        <span class="c1"># User information:</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (ThreePoints)    : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>        
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>    
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>    
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>       
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>    <span class="k">def</span> <span class="nf">calculate_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>            <span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">]:</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a><span class="sd">        Calculates coordinates of the center and radius of a circle defined via</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a><span class="sd">        3 points determined by the user. Plots the calculated circle, detected </span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a><span class="sd">        points and marks the center.</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a><span class="sd">        </span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a><span class="sd">        Parameters</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a><span class="sd">        ----------</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="sd">            Plot the calculated center and circle. To cancel visualization, </span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a><span class="sd">            set plot_results = 0.</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a><span class="sd">        self.coords : array of float64</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="sd">            Coordinates of 3 manually selected points</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a><span class="sd">        </span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a><span class="sd">        Returns</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="sd">        -------</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a><span class="sd">        self.x : float64</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a><span class="sd">        self.y : float64</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="sd">        self.r : float64</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a><span class="sd">                                    </span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="c1"># Extract the coordinates of the points        </span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>        
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>        <span class="c1"># Compute the radius and center coordinates of the circle</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="c1"># a: the squared length of the side between the second </span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="c1">#    and third points (x[1], y[1]) and (x[2], y[2]).</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>            <span class="c1"># b: the squared length of the side between the first </span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="c1">#    and third points (x[0], y[0]) and (x[2], y[2]).</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>            <span class="c1"># c: the squared length of the side between the first </span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>            <span class="c1">#    and second points (x[0], y[0]) and (x[1], y[1]).</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="c1"># s: the twice the signed area of the triangle formed by 3 points</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>            
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> 
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>        
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>        <span class="c1"># coordinates of the center</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span> 
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>        
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>        <span class="c1"># radius</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="n">ar</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>        <span class="n">br</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>        <span class="n">cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="mf">0.5</span> 
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">ar</span><span class="o">*</span><span class="n">br</span><span class="o">*</span><span class="n">cr</span><span class="o">/</span><span class="p">((</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">-</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">-</span><span class="n">cr</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>        
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="c1"># # Print results</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>        <span class="c1"># if self.parent.messages:</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>        <span class="c1">#     print(&quot;CenterEstimator :: manual center detection&quot;)</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>        <span class="c1">#     print(f&quot;Center coordinates: {self.x:.2f} {self.y:.2f}&quot;)</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>                    
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>            <span class="c1"># Create and manage the figure</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>                      <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>            
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>            <span class="c1"># Plot center and points</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>            <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>                     <span class="s1">&#39;rx&#39;</span><span class="p">,</span> 
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center&#39;</span><span class="p">,</span> 
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>                     <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> 
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Circle points&#39;</span><span class="p">)</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Circle found using 3 manually detected points&#39;</span><span class="p">)</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>            
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>            <span class="c1"># Circle visualization</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>            <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> 
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>                                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>                                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>            
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>            <span class="c1"># Set the aspect ratio to equal to have a circular shape</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>            
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> 
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>                       <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> 
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> 
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>                       <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>        
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">disp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a><span class="sd">        Calculate the radius of a circle based on intensity profiles along </span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a><span class="sd">        horizontal and vertical axes.</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a><span class="sd">    </span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a><span class="sd">        Parameters</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a><span class="sd">        ----------</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a><span class="sd">            The 2D image array containing the circle.</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a><span class="sd">        x : float</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a><span class="sd">            The x-coordinate of the circle&#39;s center.</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a><span class="sd">        y : float</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a><span class="sd">            The y-coordinate of the circle&#39;s center.</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a><span class="sd">        disp : bool, optional</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a><span class="sd">            If True, visualizes the detected intensity profiles and peaks </span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="sd">            (default is False).</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a><span class="sd">    </span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a><span class="sd">        Returns</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a><span class="sd">        -------</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a><span class="sd">        float</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a><span class="sd">            The estimated radius of the circle. Defaults to 100 if no valid </span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a><span class="sd">            radius is detected.</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>        
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>        <span class="k">def</span> <span class="nf">match_peaks</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a><span class="sd">            Finds the most similar values across the left and right halves of </span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a><span class="sd">            an array, omitting the highest value. If exactly two peaks are </span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a><span class="sd">            detected, they are returned as the best pair.</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not enough values to compare</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough values to find similar pairs.&quot;</span><span class="p">)</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>    
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>            <span class="c1"># Special case: if there are exactly 2 peaks, return them</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exactly two peaks detected. Returning them as the best pair.&quot;</span><span class="p">)</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>    
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>            <span class="c1"># Find the index of the highest value</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>    
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>            <span class="c1"># Split into left and right halves, excluding the highest value</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>            <span class="n">left_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>            <span class="n">right_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>    
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check for empty halves</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One of the halves is empty.&quot;</span><span class="p">)</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>    
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>            <span class="c1"># Initialize variables for tracking the smallest difference</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>            <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>    
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>            <span class="c1"># Compare each value in the left with every value in the right</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l_val</span> <span class="o">-</span> <span class="n">r_val</span><span class="p">)</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>                    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">smallest_diff</span><span class="p">:</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>                        <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">diff</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>                        <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_indices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>    
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>            <span class="k">return</span> <span class="n">best_pair</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>    
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>    
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>        <span class="n">x_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>        <span class="n">y_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>    
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>        <span class="c1"># Define threshold for peak detection</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>        <span class="n">x_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>        <span class="n">y_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_line</span><span class="p">)</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>    
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>        <span class="c1"># Find peaks with dynamic height thresholds</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> 
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>                                    <span class="n">height</span><span class="o">=</span><span class="n">x_thr</span><span class="p">,</span> 
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>                                    <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>                                    <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span> <span class="o">=</span> <span class="n">x_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">]</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> 
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>                                    <span class="n">height</span><span class="o">=</span><span class="n">y_thr</span><span class="p">,</span> 
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>                                    <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>                                    <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="n">y_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">]</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>    
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>        <span class="c1"># Define half the length of the image</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>        <span class="n">half_length_x</span> <span class="o">=</span> <span class="n">x_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>        <span class="n">half_length_y</span> <span class="o">=</span> <span class="n">y_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>    
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>        <span class="c1"># Check the additional condition for xpeaks</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span><span class="p">)):</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xpeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">)</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>    
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="c1"># Check the additional condition for ypeaks</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span><span class="p">)):</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ypeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">)</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>    
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>        <span class="c1"># Determine radius based on available pairs</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">:</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>            <span class="n">rx_x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>            <span class="n">rx_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>    
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">:</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>            <span class="n">rx_y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>            <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>            <span class="n">rx_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>    
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>        <span class="k">if</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">rx_x</span><span class="p">,</span> <span class="n">rx_y</span><span class="p">])</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>        <span class="k">elif</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_x</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="k">elif</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_y</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pairs detected for radius calculation.&quot;</span><span class="p">)</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>            <span class="k">return</span> <span class="mi">100</span>  <span class="c1"># Default radius or error handling</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>    
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>            <span class="c1"># Plot xline with peaks</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>    
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>            <span class="c1"># Plot for xline</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;xline&#39;</span><span class="p">)</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in xline&#39;</span><span class="p">)</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>    
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>            <span class="c1"># Plot for yline</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;yline&#39;</span><span class="p">)</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>  
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in yline&#39;</span><span class="p">)</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>    
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>    
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>        <span class="k">return</span> <span class="n">rx</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>        
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>    <span class="k">def</span> <span class="nf">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a><span class="sd">        Visualize detected diffraction patterns and mark the center.</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a><span class="sd">        </span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a><span class="sd">        Parameters</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a><span class="sd">        ----------</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a><span class="sd">        tit : string</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a><span class="sd">            name of the method used for circle detection</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a><span class="sd">        x : float64</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a><span class="sd">        y : float64</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a><span class="sd">        r : float64</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a><span class="sd">        </span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a><span class="sd">        Returns</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a><span class="sd">        -------</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a><span class="sd">        None.</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a><span class="sd">                            </span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>        <span class="c1"># Load image</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>    
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>            
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>        
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a> 
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Detected center&quot;</span><span class="p">)</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>        <span class="c1"># Plot center point</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>                <span class="n">label</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;center:  [</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>        
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>        <span class="c1"># Display the image</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a><span class="k">class</span> <span class="nc">CenterRefinement</span><span class="p">:</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a><span class="sd">    CenterRefinement object - final refinement of a diffractogram center.</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a><span class="sd">    This class is responsible for refining the center coordinates of a </span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="sd">    diffraction pattern based on the selected refinement method. It </span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="sd">    initializes with the input image and other parameters that influence </span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">    the refinement process.</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a><span class="sd">    Parameters</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a><span class="sd">    ----------</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a><span class="sd">        Reference to the parent CenterLocator object, allowing access to </span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a><span class="sd">        shared attributes and methods.</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a><span class="sd">        The input image representing a 2D diffraction pattern, provided as </span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a><span class="sd">        a file path or a NumPy array.</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a><span class="sd">    refinement : str or None, optional, default is None</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a><span class="sd">        The method used for the final center refinement.</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a><span class="sd">        Options include:</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a><span class="sd">        - &#39;manual&#39;: Manual adjustment - user adjust the position</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a><span class="sd">          of the selected diffration ring.</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a><span class="sd">        - &#39;sum&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a><span class="sd">          with maximal sum of intensities.</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a><span class="sd">        - &#39;var&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a><span class="sd">          with minimal variance of intensities.</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a><span class="sd">    out_file : str, optional</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a><span class="sd">        Filename of the text file to which the refined center coordinates </span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a><span class="sd">        will be saved.</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a><span class="sd">    heq : bool, optional</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a><span class="sd">        Flag to indicate whether to perform histogram equalization on the</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a><span class="sd">        input image. Default is False.</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a><span class="sd">    icut : float, optional</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a><span class="sd">        Cut-off intensity level for processing the image. Default is None.</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a><span class="sd">    cmap : str, optional</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a><span class="sd">        Colormap to be used for displaying the image. Default is &#39;gray&#39;.</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a><span class="sd">    messages : bool, optional</span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a><span class="sd">        Flag to enable or disable informational messages during processing. </span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a><span class="sd">        Default is False.</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a><span class="sd">    print_sums : bool, optional</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a><span class="sd">        If True, prints the sum of intensity values for the refined circle </span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a><span class="sd">        after each adjustment, relevant only for manual refinement methods.</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a><span class="sd">    Returns</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a><span class="sd">    -------</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a><span class="sd">    None</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a><span class="sd">    Notes</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a><span class="sd">    -----</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a><span class="sd">    - The class refines the detected center coordinates based on the </span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a><span class="sd">      specified refinement method.</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a><span class="sd">    - The refined coordinates are stored in instance variables</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a><span class="sd">      `xx`, `yy`, and `rr`, representing the refined center&#39;s x-coordinate, </span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a><span class="sd">      y-coordinate, and radius, respectively.</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a><span class="sd">    - If an unsupported refinement method is specified, the class will print </span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a><span class="sd">      an error message and exit.</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>    
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a>                 <span class="n">messages</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>        
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>        <span class="c1">######################################################################</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>        
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>        <span class="c1">## (0) Initialize input attributes</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>        
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>        <span class="c1">## (1) Initialize new attributes</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>        
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>        <span class="c1">## (2) Run functions</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>            <span class="n">par_short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">center1</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>        
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>            <span class="k">if</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>                <span class="c1"># Manual refinement method</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> \
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> \
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>                            <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>                <span class="k">elif</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>        
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>                <span class="c1"># Intensity variance refinement</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_var</span><span class="p">(</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>        
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>                <span class="c1"># Intensity sum refinement</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_sum</span><span class="p">(</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>        
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected refinement method is not supported.&quot;</span><span class="p">)</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>                        
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>            
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>           
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>    <span class="k">def</span> <span class="nf">ref_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a><span class="sd">        Manual refinement of the detected diffraction pattern via one of </span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a><span class="sd">        the methods provided in the class CircleDetection.</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a><span class="sd">        </span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a><span class="sd">        The user can change the position of the center of the diffraction</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a><span class="sd">        pattern and also the radius of the detected pattern using keys:</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a><span class="sd">            - left / right / top / down arrows : move left / right / top / down</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a><span class="sd">            - &#39;+&#39; : increase radius</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a><span class="sd">            - &#39;-&#39; : decrease radius</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a><span class="sd">            - &#39;b&#39;/&#39;l&#39; : increase/decrease step size&quot;)</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a><span class="sd">            - &#39;d&#39; : done, termination of the refinement</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a><span class="sd">        If the interactive figure is closed without any modifications,</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a><span class="sd">        the function returns input variables and the proccess terminates.</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a><span class="sd">        </span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a><span class="sd">        The results are shown in a figure when the refinement is successful.</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a><span class="sd">        Parameters</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a><span class="sd">        ----------</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a><span class="sd">        px : float64</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a><span class="sd">            x-coordinate of the center</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a><span class="sd">        py : float64</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a><span class="sd">            y-coordinate of the center</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a><span class="sd">        pr : float64</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a><span class="sd">            radius of the circular diffraction pattern</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a><span class="sd">        Returns</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a><span class="sd">        -------</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a><span class="sd">        x : float64</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a><span class="sd">            new x-coordinate of the center</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a><span class="sd">        y : float64</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a><span class="sd">            new y-coordinate of the center</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a><span class="sd">        r : float64</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a><span class="sd">            new radius of the circular diffraction pattern</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>        
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>        <span class="c1"># Load original image</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>            
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>        
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="c1"># User information:</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a><span class="s2">            </span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a><span class="s2">            Interactive refinement. Use these keys:</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a><span class="s2">                  - &#39;&#39; : move left</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a><span class="s2">                  - &#39;&#39; : move right</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a><span class="s2">                  - &#39;&#39; : move up</span>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a><span class="s2">                  - &#39;&#39; : move down</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a><span class="s2">                  - &#39;+&#39; : increase circle radius</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a><span class="s2">                  - &#39;-&#39; : decrease circle radius</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a><span class="s2">                  - &#39;b&#39; : increase step size</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a><span class="s2">                  - &#39;l&#39; : decrease step size</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a><span class="s2">                  - &#39;d&#39; : refinement done</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a><span class="s2">                  </span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a><span class="s2">            DISCLAIMER: For the purpose of the center shift, the default</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a><span class="s2">            shortcuts for left and right arrows were removed.</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>        
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>            
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>        
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>        
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>        <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>            <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">pr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>        <span class="c1"># Plot center point</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>        <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>                    
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the center position.&#39;</span><span class="p">,</span> 
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>        
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>        <span class="c1"># Enable interactive mode</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>        
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>        <span class="c1"># Display the image</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>        <span class="c1"># fig.set_size_inches(self.fig_width, self.fig_height)</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>        
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a> 
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>        
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>        
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>                    
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>            
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>        
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>            <span class="c1"># Change step size </span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>        
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>        
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>        
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>        
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>            <span class="c1"># Update the plot</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>            
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>        
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>               
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>         
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>        
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>        
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>        <span class="c1"># User information:</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>    
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>        
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>    
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>    <span class="k">def</span> <span class="nf">ref_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a><span class="sd">        Adjust center coordinates of a detected circular diffraction pattern.</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a><span class="sd">        The center adjustment is based on variance minimization.</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a><span class="sd">        </span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a><span class="sd">        The 8-neighbourhood pixels (x) of the current center (o) </span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a><span class="sd">        will be tested regarding the minimization:</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a><span class="sd">    </span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a><span class="sd">        - x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a><span class="sd">    </span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a><span class="sd">        - x o x : (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a><span class="sd">    </span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a><span class="sd">        - x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a><span class="sd">        </span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a><span class="sd">        Parameters</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a><span class="sd">        ----------</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a><span class="sd">        self.image : array of uint8</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a><span class="sd">            Input image in which the diffraction pattern is to be found</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a><span class="sd">        px : float64</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a><span class="sd">            x-coordinate of the detected center to be adjusted</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a><span class="sd">        py : float64</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a><span class="sd">            y-coordinate of the detected center to be adjusted</span>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a><span class="sd">        pr : float64</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a><span class="sd">        plot_results : integer (default = 1)</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a><span class="sd">            Plot Detected center. The default is 1.</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a><span class="sd">        </span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a><span class="sd">        Returns</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a><span class="sd">        -------</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a><span class="sd">        px : array of int32</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a><span class="sd">           corrected x-coordinates of pixels from circle border</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a><span class="sd">        py : array of int32</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a><span class="sd">            corrected y-coordinates of pixels from circle border</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a><span class="sd">        pr : array of int32</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a><span class="sd">            radius of the detected center</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a><span class="sd">            </span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>        
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>        <span class="c1"># Store input for plot</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>        
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>        <span class="c1"># Load image</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>    
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">min_intensity_var</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>        
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>        
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>    
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>    
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>        
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>                                      <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>            <span class="n">curr_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>                <span class="n">curr_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">))</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>            
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>            <span class="c1"># Find the minimum value coordinates within curr_intensity_var</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>                    
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_intensity_var</span><span class="p">:</span>                           
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>                
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>                
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>            <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_var</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>            
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>            <span class="c1"># constant. It iterates through different radius adjustments to find</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>            <span class="c1"># a radius that maximizes the intensity sum of pixels</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>            
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>            <span class="n">radi_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>                <span class="n">radi_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_var</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>                                                             <span class="n">new_radius</span><span class="p">))</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>                
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>            <span class="c1"># Find the minimum value coordinates within curr_var</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>            
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_intensity_var</span><span class="p">:</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>                
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>                
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>            
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_intensity_var</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a>                    <span class="k">break</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a>        
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>        <span class="c1">## (1) swapped coordinates</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>            <span class="ow">or</span>  <span class="p">(</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>        
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_intensity_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>    
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>        <span class="c1"># Print results</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (IntensityVar)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>                                  
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>    
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>    
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>    <span class="k">def</span> <span class="nf">ref_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a><span class="sd">        Adjust center position based on gradient optimization method</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a><span class="sd">        via maximization of intensity sum.</span>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a><span class="sd">        </span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a><span class="sd">        The 8-neighbourhood pixels (x) of the current center (o) </span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a><span class="sd">        will be tested regarding the maximization:</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a><span class="sd">    </span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a><span class="sd">        - x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a><span class="sd">    </span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a><span class="sd">        - x o x : (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a><span class="sd">    </span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a><span class="sd">        - x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a><span class="sd">        </span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a><span class="sd">    </span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a><span class="sd">        Parameters</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a><span class="sd">        ----------</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a><span class="sd">        px : float64</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a><span class="sd">            x-coordinate of the detected center to be adjusted.</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a><span class="sd">        py : float64</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a><span class="sd">            y-coordinate of the detected center to be adjusted.</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a><span class="sd">        pr : float64</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a><span class="sd">            radius of the detected center.</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a><span class="sd">        plot_results : int, optional</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a><span class="sd">            Plot Detected center. </span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a><span class="sd">            The default is 1.</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a><span class="sd">    </span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a><span class="sd">        Returns  </span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a><span class="sd">        -------</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a><span class="sd">        best_center[0] : float64</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a><span class="sd">            Adjusted x-coordinate of the center.</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a><span class="sd">        best_center[1] : float64</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a><span class="sd">            Adjusted y-coordinate of the center.</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a><span class="sd">        best_radius : float64</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a><span class="sd">            The adjusted radius of the circular diffraction pattern.</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>        <span class="c1"># Store input for plot via self.visualize_refinement()</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>        <span class="c1"># Image in which the center is refined</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>        <span class="n">init_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>        <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a>        
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">max_intensity_sum</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a>        
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>        
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a>         
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>                                      <span class="n">best_radius</span><span class="p">)</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>            
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>            <span class="n">curr_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>                <span class="n">curr_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>                                                        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> 
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>                                                        <span class="n">best_radius</span><span class="p">))</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>            
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>                    
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>                           
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>                
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>    
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a>            <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>        
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>            <span class="c1"># constant. It iterates through different radius adjustments to find</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>            <span class="c1"># a radius that maximizes the intensity sum of pixels</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>            
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>            <span class="n">radi_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>                <span class="n">radi_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>                                                            <span class="n">new_radius</span><span class="p">))</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>                
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>                
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>                
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>                
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>            
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_intensity_sum</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>                    <span class="k">break</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>                
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>        
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>        <span class="c1"># ## (1) swapped coordinates</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a>        <span class="c1"># if ((bckup[0] &gt; bckup[1] and not best_center[0] &gt; best_center[1])</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>        <span class="c1">#     or  (bckup[0] &lt; bckup[1] and not best_center[0] &lt; best_center[1])):</span>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a>        <span class="c1">#     best_center = best_center[::-1]</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a>        
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">max_intensity_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a>    
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a>        <span class="c1"># Print results</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a>                <span class="s2">&quot;Center Refinement (IntensitySum)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>                
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a>    
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a>    
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a>    
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a><span class="k">class</span> <span class="nc">HandlerCircle</span><span class="p">(</span><span class="n">HandlerBase</span><span class="p">):</span>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a><span class="sd">    Helper class for creating circular markers in matplotlib legends.</span>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a><span class="sd">    This class customizes the legend to display circular markers instead of the </span>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a><span class="sd">    default. It is intended for internal use within the module and not </span>
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a><span class="sd">    for general use.</span>
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a><span class="sd">    Methods:</span>
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a><span class="sd">    --------</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a><span class="sd">    create_artists(legend, </span>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a><span class="sd">                   orig_handle, </span>
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a><span class="sd">                   xdescent,</span>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a><span class="sd">                   ydescent, </span>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a><span class="sd">                   width, </span>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a><span class="sd">                   height, </span>
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a><span class="sd">                   fontsize, </span>
</span><span id="L-2608"><a href="#L-2608"><span class="linenos">2608</span></a><span class="sd">                   trans):</span>
</span><span id="L-2609"><a href="#L-2609"><span class="linenos">2609</span></a><span class="sd">        Creates a circular marker for the legend based on the original handle&#39;s </span>
</span><span id="L-2610"><a href="#L-2610"><span class="linenos">2610</span></a><span class="sd">        properties.</span>
</span><span id="L-2611"><a href="#L-2611"><span class="linenos">2611</span></a>
</span><span id="L-2612"><a href="#L-2612"><span class="linenos">2612</span></a><span class="sd">    Parameters for `create_artists`:</span>
</span><span id="L-2613"><a href="#L-2613"><span class="linenos">2613</span></a><span class="sd">        legend : matplotlib.legend.Legend</span>
</span><span id="L-2614"><a href="#L-2614"><span class="linenos">2614</span></a><span class="sd">            The legend instance where the custom marker will be used.</span>
</span><span id="L-2615"><a href="#L-2615"><span class="linenos">2615</span></a><span class="sd">        orig_handle : matplotlib.artist.Artist</span>
</span><span id="L-2616"><a href="#L-2616"><span class="linenos">2616</span></a><span class="sd">            The original handle containing the marker properties </span>
</span><span id="L-2617"><a href="#L-2617"><span class="linenos">2617</span></a><span class="sd">            (e.g., facecolor, edgecolor).</span>
</span><span id="L-2618"><a href="#L-2618"><span class="linenos">2618</span></a><span class="sd">        xdescent : float</span>
</span><span id="L-2619"><a href="#L-2619"><span class="linenos">2619</span></a><span class="sd">            Horizontal offset adjustment for the marker.</span>
</span><span id="L-2620"><a href="#L-2620"><span class="linenos">2620</span></a><span class="sd">        ydescent : float</span>
</span><span id="L-2621"><a href="#L-2621"><span class="linenos">2621</span></a><span class="sd">            Vertical offset adjustment for the marker.</span>
</span><span id="L-2622"><a href="#L-2622"><span class="linenos">2622</span></a><span class="sd">        width : float</span>
</span><span id="L-2623"><a href="#L-2623"><span class="linenos">2623</span></a><span class="sd">            Width of the legend entry.</span>
</span><span id="L-2624"><a href="#L-2624"><span class="linenos">2624</span></a><span class="sd">        height : float</span>
</span><span id="L-2625"><a href="#L-2625"><span class="linenos">2625</span></a><span class="sd">            Height of the legend entry.</span>
</span><span id="L-2626"><a href="#L-2626"><span class="linenos">2626</span></a><span class="sd">        fontsize : float</span>
</span><span id="L-2627"><a href="#L-2627"><span class="linenos">2627</span></a><span class="sd">            Font size of the legend text.</span>
</span><span id="L-2628"><a href="#L-2628"><span class="linenos">2628</span></a><span class="sd">        trans : matplotlib.transforms.Transform</span>
</span><span id="L-2629"><a href="#L-2629"><span class="linenos">2629</span></a><span class="sd">            Transformation applied to the marker&#39;s coordinates.</span>
</span><span id="L-2630"><a href="#L-2630"><span class="linenos">2630</span></a>
</span><span id="L-2631"><a href="#L-2631"><span class="linenos">2631</span></a><span class="sd">    Returns:</span>
</span><span id="L-2632"><a href="#L-2632"><span class="linenos">2632</span></a><span class="sd">    --------</span>
</span><span id="L-2633"><a href="#L-2633"><span class="linenos">2633</span></a><span class="sd">    list of matplotlib.patches.Circle</span>
</span><span id="L-2634"><a href="#L-2634"><span class="linenos">2634</span></a><span class="sd">        A list containing a single circular marker artist.</span>
</span><span id="L-2635"><a href="#L-2635"><span class="linenos">2635</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2636"><a href="#L-2636"><span class="linenos">2636</span></a>
</span><span id="L-2637"><a href="#L-2637"><span class="linenos">2637</span></a>    <span class="k">def</span> <span class="nf">create_artists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">,</span> <span class="n">xdescent</span><span class="p">,</span> <span class="n">ydescent</span><span class="p">,</span> 
</span><span id="L-2638"><a href="#L-2638"><span class="linenos">2638</span></a>                       <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
</span><span id="L-2639"><a href="#L-2639"><span class="linenos">2639</span></a>        <span class="c1"># Calculate the center and radius of the circle</span>
</span><span id="L-2640"><a href="#L-2640"><span class="linenos">2640</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-2641"><a href="#L-2641"><span class="linenos">2641</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-2642"><a href="#L-2642"><span class="linenos">2642</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-2643"><a href="#L-2643"><span class="linenos">2643</span></a>
</span><span id="L-2644"><a href="#L-2644"><span class="linenos">2644</span></a>        <span class="c1"># Create a circular marker using the properties of the original handle</span>
</span><span id="L-2645"><a href="#L-2645"><span class="linenos">2645</span></a>        <span class="n">marker</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span>
</span><span id="L-2646"><a href="#L-2646"><span class="linenos">2646</span></a>                        <span class="n">facecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">(),</span>
</span><span id="L-2647"><a href="#L-2647"><span class="linenos">2647</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">(),</span>
</span><span id="L-2648"><a href="#L-2648"><span class="linenos">2648</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">(),</span>
</span><span id="L-2649"><a href="#L-2649"><span class="linenos">2649</span></a>                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
</span><span id="L-2650"><a href="#L-2650"><span class="linenos">2650</span></a>
</span><span id="L-2651"><a href="#L-2651"><span class="linenos">2651</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">marker</span><span class="p">]</span>
</span><span id="L-2652"><a href="#L-2652"><span class="linenos">2652</span></a>        
</span><span id="L-2653"><a href="#L-2653"><span class="linenos">2653</span></a>
</span><span id="L-2654"><a href="#L-2654"><span class="linenos">2654</span></a><span class="k">class</span> <span class="nc">IntensityCenter</span><span class="p">:</span> 
</span><span id="L-2655"><a href="#L-2655"><span class="linenos">2655</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2656"><a href="#L-2656"><span class="linenos">2656</span></a><span class="sd">    Simple center determination for a symmetric diffractogram.</span>
</span><span id="L-2657"><a href="#L-2657"><span class="linenos">2657</span></a><span class="sd">    </span>
</span><span id="L-2658"><a href="#L-2658"><span class="linenos">2658</span></a><span class="sd">    * The center is determined as a center of intensity.</span>
</span><span id="L-2659"><a href="#L-2659"><span class="linenos">2659</span></a><span class="sd">    * This works well for simple, symmetric diffraction patters, which are:</span>
</span><span id="L-2660"><a href="#L-2660"><span class="linenos">2660</span></a><span class="sd">      (i) without beamstopper, (ii) pre-centered, and (iii) powder-like.</span>
</span><span id="L-2661"><a href="#L-2661"><span class="linenos">2661</span></a><span class="sd">    * A real-life example of a simple symmetric diffractogram:</span>
</span><span id="L-2662"><a href="#L-2662"><span class="linenos">2662</span></a><span class="sd">      a good powder electron diffraction pattern from STEMDIFF software.</span>
</span><span id="L-2663"><a href="#L-2663"><span class="linenos">2663</span></a><span class="sd">    * This class is a legacy from previous EDIFF versions;</span>
</span><span id="L-2664"><a href="#L-2664"><span class="linenos">2664</span></a><span class="sd">      it is kept mostly for backward compatibility.</span>
</span><span id="L-2665"><a href="#L-2665"><span class="linenos">2665</span></a><span class="sd">      The functions in this class can be (and should be)</span>
</span><span id="L-2666"><a href="#L-2666"><span class="linenos">2666</span></a><span class="sd">      replaced by a simple call of ediff.center.CenterLocator object.</span>
</span><span id="L-2667"><a href="#L-2667"><span class="linenos">2667</span></a><span class="sd">      </span>
</span><span id="L-2668"><a href="#L-2668"><span class="linenos">2668</span></a><span class="sd">    &gt;&gt;&gt; # Center determination in a simple symmetric diffraction pattern</span>
</span><span id="L-2669"><a href="#L-2669"><span class="linenos">2669</span></a><span class="sd">    &gt;&gt;&gt; # (center = just center_of_intensity, no refinement</span>
</span><span id="L-2670"><a href="#L-2670"><span class="linenos">2670</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="L-2671"><a href="#L-2671"><span class="linenos">2671</span></a><span class="sd">    &gt;&gt;&gt; # (1) Old way = this (old, legacy) IntensityCenter class:</span>
</span><span id="L-2672"><a href="#L-2672"><span class="linenos">2672</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.IntensityCenter.center_of_intensity(</span>
</span><span id="L-2673"><a href="#L-2673"><span class="linenos">2673</span></a><span class="sd">    &gt;&gt;&gt;     arr, csquare=30, cintensity=0.8)</span>
</span><span id="L-2674"><a href="#L-2674"><span class="linenos">2674</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="L-2675"><a href="#L-2675"><span class="linenos">2675</span></a><span class="sd">    &gt;&gt;&gt; # (2) New way = newer (and more universal) CenterLocator class:</span>
</span><span id="L-2676"><a href="#L-2676"><span class="linenos">2676</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.CenterLocator(</span>
</span><span id="L-2677"><a href="#L-2677"><span class="linenos">2677</span></a><span class="sd">    &gt;&gt;&gt;     arr, detection_method=&#39;intensity&#39;, csquare=30, cintensity=0.8)</span>
</span><span id="L-2678"><a href="#L-2678"><span class="linenos">2678</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-2679"><a href="#L-2679"><span class="linenos">2679</span></a>    
</span><span id="L-2680"><a href="#L-2680"><span class="linenos">2680</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-2681"><a href="#L-2681"><span class="linenos">2681</span></a>    <span class="k">def</span> <span class="nf">center_of_intensity</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="L-2682"><a href="#L-2682"><span class="linenos">2682</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2683"><a href="#L-2683"><span class="linenos">2683</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="L-2684"><a href="#L-2684"><span class="linenos">2684</span></a><span class="sd">        </span>
</span><span id="L-2685"><a href="#L-2685"><span class="linenos">2685</span></a><span class="sd">        Parameters</span>
</span><span id="L-2686"><a href="#L-2686"><span class="linenos">2686</span></a><span class="sd">        ----------</span>
</span><span id="L-2687"><a href="#L-2687"><span class="linenos">2687</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="L-2688"><a href="#L-2688"><span class="linenos">2688</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="L-2689"><a href="#L-2689"><span class="linenos">2689</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="L-2690"><a href="#L-2690"><span class="linenos">2690</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="L-2691"><a href="#L-2691"><span class="linenos">2691</span></a><span class="sd">            The intensity center is searched only within the central square.</span>
</span><span id="L-2692"><a href="#L-2692"><span class="linenos">2692</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="L-2693"><a href="#L-2693"><span class="linenos">2693</span></a><span class="sd">            to minimize the effect of an intensity assymetry around center. </span>
</span><span id="L-2694"><a href="#L-2694"><span class="linenos">2694</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="L-2695"><a href="#L-2695"><span class="linenos">2695</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="L-2696"><a href="#L-2696"><span class="linenos">2696</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="L-2697"><a href="#L-2697"><span class="linenos">2697</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="L-2698"><a href="#L-2698"><span class="linenos">2698</span></a><span class="sd">            </span>
</span><span id="L-2699"><a href="#L-2699"><span class="linenos">2699</span></a><span class="sd">        Returns</span>
</span><span id="L-2700"><a href="#L-2700"><span class="linenos">2700</span></a><span class="sd">        -------</span>
</span><span id="L-2701"><a href="#L-2701"><span class="linenos">2701</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="L-2702"><a href="#L-2702"><span class="linenos">2702</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="L-2703"><a href="#L-2703"><span class="linenos">2703</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.    </span>
</span><span id="L-2704"><a href="#L-2704"><span class="linenos">2704</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2705"><a href="#L-2705"><span class="linenos">2705</span></a>        <span class="c1"># Get image/array size</span>
</span><span id="L-2706"><a href="#L-2706"><span class="linenos">2706</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-2707"><a href="#L-2707"><span class="linenos">2707</span></a>        <span class="c1"># Calculate borders around the central square</span>
</span><span id="L-2708"><a href="#L-2708"><span class="linenos">2708</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-2709"><a href="#L-2709"><span class="linenos">2709</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-2710"><a href="#L-2710"><span class="linenos">2710</span></a>        <span class="c1"># Create central square = cut off the borders</span>
</span><span id="L-2711"><a href="#L-2711"><span class="linenos">2711</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2712"><a href="#L-2712"><span class="linenos">2712</span></a>        <span class="c1"># In the central square, set all values below cintenstity to zero</span>
</span><span id="L-2713"><a href="#L-2713"><span class="linenos">2713</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-2714"><a href="#L-2714"><span class="linenos">2714</span></a>        <span class="c1"># Calculate 1st central moments of the image</span>
</span><span id="L-2715"><a href="#L-2715"><span class="linenos">2715</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2716"><a href="#L-2716"><span class="linenos">2716</span></a>        <span class="c1"># Calculate the intensity center = centroid according to www-help</span>
</span><span id="L-2717"><a href="#L-2717"><span class="linenos">2717</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-2718"><a href="#L-2718"><span class="linenos">2718</span></a>        <span class="c1"># We have centroid of the central square =&gt; recalculate to whole image</span>
</span><span id="L-2719"><a href="#L-2719"><span class="linenos">2719</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xborder</span><span class="p">,</span><span class="n">yc</span><span class="o">+</span><span class="n">yborder</span><span class="p">)</span>
</span><span id="L-2720"><a href="#L-2720"><span class="linenos">2720</span></a>        
</span><span id="L-2721"><a href="#L-2721"><span class="linenos">2721</span></a>        <span class="c1">## Return the final center</span>
</span><span id="L-2722"><a href="#L-2722"><span class="linenos">2722</span></a>        <span class="k">return</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span>
</span><span id="L-2723"><a href="#L-2723"><span class="linenos">2723</span></a>
</span><span id="L-2724"><a href="#L-2724"><span class="linenos">2724</span></a>
</span><span id="L-2725"><a href="#L-2725"><span class="linenos">2725</span></a>
</span><span id="L-2726"><a href="#L-2726"><span class="linenos">2726</span></a>
</span><span id="L-2727"><a href="#L-2727"><span class="linenos">2727</span></a>    
</span><span id="L-2728"><a href="#L-2728"><span class="linenos">2728</span></a>
</span><span id="L-2729"><a href="#L-2729"><span class="linenos">2729</span></a>    
</span></pre></div>


            </section>
                <section id="CenterLocator">
                            <input id="CenterLocator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CenterLocator</span>:

                <label class="view-source-button" for="CenterLocator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator-53"><a href="#CenterLocator-53"><span class="linenos"> 53</span></a><span class="k">class</span> <span class="nc">CenterLocator</span><span class="p">:</span>
</span><span id="CenterLocator-54"><a href="#CenterLocator-54"><span class="linenos"> 54</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator-55"><a href="#CenterLocator-55"><span class="linenos"> 55</span></a><span class="sd">    CenterLocator object - determine and refine a diffractogram center.</span>
</span><span id="CenterLocator-56"><a href="#CenterLocator-56"><span class="linenos"> 56</span></a>
</span><span id="CenterLocator-57"><a href="#CenterLocator-57"><span class="linenos"> 57</span></a><span class="sd">    Parameters</span>
</span><span id="CenterLocator-58"><a href="#CenterLocator-58"><span class="linenos"> 58</span></a><span class="sd">    ----------</span>
</span><span id="CenterLocator-59"><a href="#CenterLocator-59"><span class="linenos"> 59</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="CenterLocator-60"><a href="#CenterLocator-60"><span class="linenos"> 60</span></a><span class="sd">        The input image representing a 2D diffraction pattern, either as a </span>
</span><span id="CenterLocator-61"><a href="#CenterLocator-61"><span class="linenos"> 61</span></a><span class="sd">        file path or a NumPy array.</span>
</span><span id="CenterLocator-62"><a href="#CenterLocator-62"><span class="linenos"> 62</span></a><span class="sd">    determination : str or None, optional, default is None</span>
</span><span id="CenterLocator-63"><a href="#CenterLocator-63"><span class="linenos"> 63</span></a><span class="sd">        The method used for the initial center determination.</span>
</span><span id="CenterLocator-64"><a href="#CenterLocator-64"><span class="linenos"> 64</span></a><span class="sd">        Options include:</span>
</span><span id="CenterLocator-65"><a href="#CenterLocator-65"><span class="linenos"> 65</span></a><span class="sd">        - &#39;manual&#39;: Manual detection - user defines 3 points</span>
</span><span id="CenterLocator-66"><a href="#CenterLocator-66"><span class="linenos"> 66</span></a><span class="sd">          on selected diffraction ring.</span>
</span><span id="CenterLocator-67"><a href="#CenterLocator-67"><span class="linenos"> 67</span></a><span class="sd">        - &#39;hough&#39;: Auto-detection - Hough transform for circle detection.</span>
</span><span id="CenterLocator-68"><a href="#CenterLocator-68"><span class="linenos"> 68</span></a><span class="sd">        - &#39;intensity&#39;: Auto-detection - intensity center in central region.</span>
</span><span id="CenterLocator-69"><a href="#CenterLocator-69"><span class="linenos"> 69</span></a><span class="sd">    refinement : str or None, optional, default is None</span>
</span><span id="CenterLocator-70"><a href="#CenterLocator-70"><span class="linenos"> 70</span></a><span class="sd">        The method used for the final center refinement.</span>
</span><span id="CenterLocator-71"><a href="#CenterLocator-71"><span class="linenos"> 71</span></a><span class="sd">        Options include:</span>
</span><span id="CenterLocator-72"><a href="#CenterLocator-72"><span class="linenos"> 72</span></a><span class="sd">        - &#39;manual&#39;: Manual adjustment - user adjust the position</span>
</span><span id="CenterLocator-73"><a href="#CenterLocator-73"><span class="linenos"> 73</span></a><span class="sd">          of the selected diffration ring.</span>
</span><span id="CenterLocator-74"><a href="#CenterLocator-74"><span class="linenos"> 74</span></a><span class="sd">        - &#39;sum&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="CenterLocator-75"><a href="#CenterLocator-75"><span class="linenos"> 75</span></a><span class="sd">          with maximal sum of intensities.</span>
</span><span id="CenterLocator-76"><a href="#CenterLocator-76"><span class="linenos"> 76</span></a><span class="sd">        - &#39;var&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="CenterLocator-77"><a href="#CenterLocator-77"><span class="linenos"> 77</span></a><span class="sd">          with minimal variance of intensities.</span>
</span><span id="CenterLocator-78"><a href="#CenterLocator-78"><span class="linenos"> 78</span></a><span class="sd">    in_file : str, optional, default is None</span>
</span><span id="CenterLocator-79"><a href="#CenterLocator-79"><span class="linenos"> 79</span></a><span class="sd">        Filename of the text file</span>
</span><span id="CenterLocator-80"><a href="#CenterLocator-80"><span class="linenos"> 80</span></a><span class="sd">        for saving the center coordinates.</span>
</span><span id="CenterLocator-81"><a href="#CenterLocator-81"><span class="linenos"> 81</span></a><span class="sd">    out_file : str, optional, default is None</span>
</span><span id="CenterLocator-82"><a href="#CenterLocator-82"><span class="linenos"> 82</span></a><span class="sd">        Filename of the text file</span>
</span><span id="CenterLocator-83"><a href="#CenterLocator-83"><span class="linenos"> 83</span></a><span class="sd">        for loading the previously saved center coordinates.</span>
</span><span id="CenterLocator-84"><a href="#CenterLocator-84"><span class="linenos"> 84</span></a><span class="sd">    heq : bool, optional, default is False</span>
</span><span id="CenterLocator-85"><a href="#CenterLocator-85"><span class="linenos"> 85</span></a><span class="sd">        Flag to indicate whether to perform histogram equalization </span>
</span><span id="CenterLocator-86"><a href="#CenterLocator-86"><span class="linenos"> 86</span></a><span class="sd">        on the input image.</span>
</span><span id="CenterLocator-87"><a href="#CenterLocator-87"><span class="linenos"> 87</span></a><span class="sd">        The equalization is done internally,</span>
</span><span id="CenterLocator-88"><a href="#CenterLocator-88"><span class="linenos"> 88</span></a><span class="sd">        the image on the screen remains unchanged.</span>
</span><span id="CenterLocator-89"><a href="#CenterLocator-89"><span class="linenos"> 89</span></a><span class="sd">    icut : float, optional, default is None</span>
</span><span id="CenterLocator-90"><a href="#CenterLocator-90"><span class="linenos"> 90</span></a><span class="sd">        Cut-off intensity level for processing the image.</span>
</span><span id="CenterLocator-91"><a href="#CenterLocator-91"><span class="linenos"> 91</span></a><span class="sd">    cmap : str, optional, default is &#39;gray&#39;</span>
</span><span id="CenterLocator-92"><a href="#CenterLocator-92"><span class="linenos"> 92</span></a><span class="sd">        Colormap to be used for displaying the image. </span>
</span><span id="CenterLocator-93"><a href="#CenterLocator-93"><span class="linenos"> 93</span></a><span class="sd">    csquare : int, optional, default is 50</span>
</span><span id="CenterLocator-94"><a href="#CenterLocator-94"><span class="linenos"> 94</span></a><span class="sd">        Size of the central square,</span>
</span><span id="CenterLocator-95"><a href="#CenterLocator-95"><span class="linenos"> 95</span></a><span class="sd">        within which we will search the intensity center.</span>
</span><span id="CenterLocator-96"><a href="#CenterLocator-96"><span class="linenos"> 96</span></a><span class="sd">    cintensity : float, optional, default is 0.8</span>
</span><span id="CenterLocator-97"><a href="#CenterLocator-97"><span class="linenos"> 97</span></a><span class="sd">        Threshold intensity</span>
</span><span id="CenterLocator-98"><a href="#CenterLocator-98"><span class="linenos"> 98</span></a><span class="sd">        for finding the intensity center.</span>
</span><span id="CenterLocator-99"><a href="#CenterLocator-99"><span class="linenos"> 99</span></a><span class="sd">        Pixels with a (relative) intensity lower than cintensity are ignored.</span>
</span><span id="CenterLocator-100"><a href="#CenterLocator-100"><span class="linenos">100</span></a><span class="sd">    messages : bool, optional, default is False</span>
</span><span id="CenterLocator-101"><a href="#CenterLocator-101"><span class="linenos">101</span></a><span class="sd">        Flag to enable or disable informational messages during processing. </span>
</span><span id="CenterLocator-102"><a href="#CenterLocator-102"><span class="linenos">102</span></a><span class="sd">    print_sums : bool, optional, default is False</span>
</span><span id="CenterLocator-103"><a href="#CenterLocator-103"><span class="linenos">103</span></a><span class="sd">        If True, prints the sum of intensity values for the refined circle </span>
</span><span id="CenterLocator-104"><a href="#CenterLocator-104"><span class="linenos">104</span></a><span class="sd">        after each adjustment, relevant only for manual methods of center </span>
</span><span id="CenterLocator-105"><a href="#CenterLocator-105"><span class="linenos">105</span></a><span class="sd">        determination and refinement.</span>
</span><span id="CenterLocator-106"><a href="#CenterLocator-106"><span class="linenos">106</span></a><span class="sd">    final_print : bool, optional, default is True</span>
</span><span id="CenterLocator-107"><a href="#CenterLocator-107"><span class="linenos">107</span></a><span class="sd">        If True, print determined and refined coordinates to stdout.</span>
</span><span id="CenterLocator-108"><a href="#CenterLocator-108"><span class="linenos">108</span></a><span class="sd"> </span>
</span><span id="CenterLocator-109"><a href="#CenterLocator-109"><span class="linenos">109</span></a><span class="sd">    Returns</span>
</span><span id="CenterLocator-110"><a href="#CenterLocator-110"><span class="linenos">110</span></a><span class="sd">    -------</span>
</span><span id="CenterLocator-111"><a href="#CenterLocator-111"><span class="linenos">111</span></a><span class="sd">    None</span>
</span><span id="CenterLocator-112"><a href="#CenterLocator-112"><span class="linenos">112</span></a><span class="sd">        The center coordinates are stored in instance variables</span>
</span><span id="CenterLocator-113"><a href="#CenterLocator-113"><span class="linenos">113</span></a><span class="sd">        (x1,y1) for the determined center and</span>
</span><span id="CenterLocator-114"><a href="#CenterLocator-114"><span class="linenos">114</span></a><span class="sd">        (x2,y2) for the refined center.</span>
</span><span id="CenterLocator-115"><a href="#CenterLocator-115"><span class="linenos">115</span></a><span class="sd">        Look at the initial example at the top of this module</span>
</span><span id="CenterLocator-116"><a href="#CenterLocator-116"><span class="linenos">116</span></a><span class="sd">        to see how to use CenterLocator class.</span>
</span><span id="CenterLocator-117"><a href="#CenterLocator-117"><span class="linenos">117</span></a><span class="sd">            </span>
</span><span id="CenterLocator-118"><a href="#CenterLocator-118"><span class="linenos">118</span></a><span class="sd">    Technical notes</span>
</span><span id="CenterLocator-119"><a href="#CenterLocator-119"><span class="linenos">119</span></a><span class="sd">    ---------------</span>
</span><span id="CenterLocator-120"><a href="#CenterLocator-120"><span class="linenos">120</span></a><span class="sd">    * The class initializes (and runs) two sub-classes (= processes),</span>
</span><span id="CenterLocator-121"><a href="#CenterLocator-121"><span class="linenos">121</span></a><span class="sd">      CenterDetermination and CenterRefinement.</span>
</span><span id="CenterLocator-122"><a href="#CenterLocator-122"><span class="linenos">122</span></a><span class="sd">    * The two sub-classes/processes are hidden to common user,</span>
</span><span id="CenterLocator-123"><a href="#CenterLocator-123"><span class="linenos">123</span></a><span class="sd">      altough they could be run separately.</span>
</span><span id="CenterLocator-124"><a href="#CenterLocator-124"><span class="linenos">124</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="CenterLocator-125"><a href="#CenterLocator-125"><span class="linenos">125</span></a>    
</span><span id="CenterLocator-126"><a href="#CenterLocator-126"><span class="linenos">126</span></a>    
</span><span id="CenterLocator-127"><a href="#CenterLocator-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CenterLocator-128"><a href="#CenterLocator-128"><span class="linenos">128</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="CenterLocator-129"><a href="#CenterLocator-129"><span class="linenos">129</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="CenterLocator-130"><a href="#CenterLocator-130"><span class="linenos">130</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-131"><a href="#CenterLocator-131"><span class="linenos">131</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-132"><a href="#CenterLocator-132"><span class="linenos">132</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-133"><a href="#CenterLocator-133"><span class="linenos">133</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterLocator-134"><a href="#CenterLocator-134"><span class="linenos">134</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterLocator-135"><a href="#CenterLocator-135"><span class="linenos">135</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="CenterLocator-136"><a href="#CenterLocator-136"><span class="linenos">136</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="CenterLocator-137"><a href="#CenterLocator-137"><span class="linenos">137</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="CenterLocator-138"><a href="#CenterLocator-138"><span class="linenos">138</span></a>                 <span class="n">messages</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CenterLocator-139"><a href="#CenterLocator-139"><span class="linenos">139</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CenterLocator-140"><a href="#CenterLocator-140"><span class="linenos">140</span></a>                 <span class="n">final_print</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="CenterLocator-141"><a href="#CenterLocator-141"><span class="linenos">141</span></a>        
</span><span id="CenterLocator-142"><a href="#CenterLocator-142"><span class="linenos">142</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterLocator-143"><a href="#CenterLocator-143"><span class="linenos">143</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="CenterLocator-144"><a href="#CenterLocator-144"><span class="linenos">144</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="CenterLocator-145"><a href="#CenterLocator-145"><span class="linenos">145</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterLocator-146"><a href="#CenterLocator-146"><span class="linenos">146</span></a>
</span><span id="CenterLocator-147"><a href="#CenterLocator-147"><span class="linenos">147</span></a>        <span class="c1">## (0) Initialize input attributes</span>
</span><span id="CenterLocator-148"><a href="#CenterLocator-148"><span class="linenos">148</span></a>        
</span><span id="CenterLocator-149"><a href="#CenterLocator-149"><span class="linenos">149</span></a>        <span class="c1"># Input image = diffraction pattern</span>
</span><span id="CenterLocator-150"><a href="#CenterLocator-150"><span class="linenos">150</span></a>        <span class="c1"># (it can be either image file or numpy array</span>
</span><span id="CenterLocator-151"><a href="#CenterLocator-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="CenterLocator-152"><a href="#CenterLocator-152"><span class="linenos">152</span></a>        
</span><span id="CenterLocator-153"><a href="#CenterLocator-153"><span class="linenos">153</span></a>        <span class="c1"># Methods of center determination and center refinement</span>
</span><span id="CenterLocator-154"><a href="#CenterLocator-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span>
</span><span id="CenterLocator-155"><a href="#CenterLocator-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span>
</span><span id="CenterLocator-156"><a href="#CenterLocator-156"><span class="linenos">156</span></a>        <span class="c1"># For reproducibility, convert the method names to lowercase</span>
</span><span id="CenterLocator-157"><a href="#CenterLocator-157"><span class="linenos">157</span></a>        <span class="k">if</span> <span class="n">determination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-158"><a href="#CenterLocator-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">=</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="CenterLocator-159"><a href="#CenterLocator-159"><span class="linenos">159</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-160"><a href="#CenterLocator-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">=</span> <span class="n">refinement</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="CenterLocator-161"><a href="#CenterLocator-161"><span class="linenos">161</span></a>        
</span><span id="CenterLocator-162"><a href="#CenterLocator-162"><span class="linenos">162</span></a>        <span class="c1"># Text files for reading/saving center coordinates</span>
</span><span id="CenterLocator-163"><a href="#CenterLocator-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">in_file</span>
</span><span id="CenterLocator-164"><a href="#CenterLocator-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file</span>
</span><span id="CenterLocator-165"><a href="#CenterLocator-165"><span class="linenos">165</span></a>        
</span><span id="CenterLocator-166"><a href="#CenterLocator-166"><span class="linenos">166</span></a>        <span class="c1"># Additional parameters</span>
</span><span id="CenterLocator-167"><a href="#CenterLocator-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">=</span> <span class="n">heq</span>
</span><span id="CenterLocator-168"><a href="#CenterLocator-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="o">=</span> <span class="n">icut</span>
</span><span id="CenterLocator-169"><a href="#CenterLocator-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span>
</span><span id="CenterLocator-170"><a href="#CenterLocator-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span> <span class="o">=</span> <span class="n">csquare</span>
</span><span id="CenterLocator-171"><a href="#CenterLocator-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span> <span class="o">=</span> <span class="n">cintensity</span>
</span><span id="CenterLocator-172"><a href="#CenterLocator-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="n">messages</span>
</span><span id="CenterLocator-173"><a href="#CenterLocator-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span> <span class="o">=</span> <span class="n">print_sums</span>
</span><span id="CenterLocator-174"><a href="#CenterLocator-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span> <span class="o">=</span> <span class="n">final_print</span>
</span><span id="CenterLocator-175"><a href="#CenterLocator-175"><span class="linenos">175</span></a>        
</span><span id="CenterLocator-176"><a href="#CenterLocator-176"><span class="linenos">176</span></a>        <span class="c1">## (1) Initialize new attributes</span>
</span><span id="CenterLocator-177"><a href="#CenterLocator-177"><span class="linenos">177</span></a>        
</span><span id="CenterLocator-178"><a href="#CenterLocator-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-179"><a href="#CenterLocator-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-180"><a href="#CenterLocator-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-181"><a href="#CenterLocator-181"><span class="linenos">181</span></a>        
</span><span id="CenterLocator-182"><a href="#CenterLocator-182"><span class="linenos">182</span></a>        <span class="c1"># The value of the following attribute can be adjusted</span>
</span><span id="CenterLocator-183"><a href="#CenterLocator-183"><span class="linenos">183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">marker_size</span> <span class="o">=</span> <span class="mi">100</span>          
</span><span id="CenterLocator-184"><a href="#CenterLocator-184"><span class="linenos">184</span></a>
</span><span id="CenterLocator-185"><a href="#CenterLocator-185"><span class="linenos">185</span></a>        <span class="c1">## (2) Read input image</span>
</span><span id="CenterLocator-186"><a href="#CenterLocator-186"><span class="linenos">186</span></a>        
</span><span id="CenterLocator-187"><a href="#CenterLocator-187"><span class="linenos">187</span></a>        <span class="c1"># The input image can be numpy.array (ndarray) or image file (path/str)</span>
</span><span id="CenterLocator-188"><a href="#CenterLocator-188"><span class="linenos">188</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="CenterLocator-189"><a href="#CenterLocator-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="CenterLocator-190"><a href="#CenterLocator-190"><span class="linenos">190</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-191"><a href="#CenterLocator-191"><span class="linenos">191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">ediff</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">)</span>
</span><span id="CenterLocator-192"><a href="#CenterLocator-192"><span class="linenos">192</span></a>            
</span><span id="CenterLocator-193"><a href="#CenterLocator-193"><span class="linenos">193</span></a>        <span class="c1">## (3) Read center coordinates</span>
</span><span id="CenterLocator-194"><a href="#CenterLocator-194"><span class="linenos">194</span></a>        
</span><span id="CenterLocator-195"><a href="#CenterLocator-195"><span class="linenos">195</span></a>        <span class="c1"># * The center coordinates may have been determined</span>
</span><span id="CenterLocator-196"><a href="#CenterLocator-196"><span class="linenos">196</span></a>        <span class="c1">#   in a previous run of the program and saved to a text file.</span>
</span><span id="CenterLocator-197"><a href="#CenterLocator-197"><span class="linenos">197</span></a>        <span class="c1"># * We can Load coordinates from an input file if specified,</span>
</span><span id="CenterLocator-198"><a href="#CenterLocator-198"><span class="linenos">198</span></a>        <span class="c1">#   this is done by the following commant.</span>
</span><span id="CenterLocator-199"><a href="#CenterLocator-199"><span class="linenos">199</span></a>        <span class="c1"># * As the saved coordinates can be used INSTEAD of CenterDetermination</span>
</span><span id="CenterLocator-200"><a href="#CenterLocator-200"><span class="linenos">200</span></a>        <span class="c1">#   we will read them here.</span>
</span><span id="CenterLocator-201"><a href="#CenterLocator-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_results</span><span class="p">()</span>  
</span><span id="CenterLocator-202"><a href="#CenterLocator-202"><span class="linenos">202</span></a>        
</span><span id="CenterLocator-203"><a href="#CenterLocator-203"><span class="linenos">203</span></a>        <span class="c1">## (4) Run CenterDetermination</span>
</span><span id="CenterLocator-204"><a href="#CenterLocator-204"><span class="linenos">204</span></a>        
</span><span id="CenterLocator-205"><a href="#CenterLocator-205"><span class="linenos">205</span></a>        <span class="c1"># (4a) Initialize/run CenterDetermination</span>
</span><span id="CenterLocator-206"><a href="#CenterLocator-206"><span class="linenos">206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center1</span> <span class="o">=</span> <span class="n">CenterDetermination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CenterLocator-207"><a href="#CenterLocator-207"><span class="linenos">207</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span>
</span><span id="CenterLocator-208"><a href="#CenterLocator-208"><span class="linenos">208</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="p">,</span>
</span><span id="CenterLocator-209"><a href="#CenterLocator-209"><span class="linenos">209</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span>
</span><span id="CenterLocator-210"><a href="#CenterLocator-210"><span class="linenos">210</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="CenterLocator-211"><a href="#CenterLocator-211"><span class="linenos">211</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterLocator-212"><a href="#CenterLocator-212"><span class="linenos">212</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span>
</span><span id="CenterLocator-213"><a href="#CenterLocator-213"><span class="linenos">213</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cintensity</span><span class="p">,</span>
</span><span id="CenterLocator-214"><a href="#CenterLocator-214"><span class="linenos">214</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
</span><span id="CenterLocator-215"><a href="#CenterLocator-215"><span class="linenos">215</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="CenterLocator-216"><a href="#CenterLocator-216"><span class="linenos">216</span></a>        
</span><span id="CenterLocator-217"><a href="#CenterLocator-217"><span class="linenos">217</span></a>        <span class="c1"># (4b) Find radius of a circle/diffraction ring,</span>
</span><span id="CenterLocator-218"><a href="#CenterLocator-218"><span class="linenos">218</span></a>        <span class="c1">#      which is needed for the next step = CenterRefimenement.</span>
</span><span id="CenterLocator-219"><a href="#CenterLocator-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">!=</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterLocator-220"><a href="#CenterLocator-220"><span class="linenos">220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span>
</span><span id="CenterLocator-221"><a href="#CenterLocator-221"><span class="linenos">221</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterLocator-222"><a href="#CenterLocator-222"><span class="linenos">222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="CenterLocator-223"><a href="#CenterLocator-223"><span class="linenos">223</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterLocator-224"><a href="#CenterLocator-224"><span class="linenos">224</span></a>                <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterLocator-225"><a href="#CenterLocator-225"><span class="linenos">225</span></a>
</span><span id="CenterLocator-226"><a href="#CenterLocator-226"><span class="linenos">226</span></a>        <span class="c1">## (5) Initialize/run CenterRefinement</span>
</span><span id="CenterLocator-227"><a href="#CenterLocator-227"><span class="linenos">227</span></a>        
</span><span id="CenterLocator-228"><a href="#CenterLocator-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center2</span> <span class="o">=</span> <span class="n">CenterRefinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CenterLocator-229"><a href="#CenterLocator-229"><span class="linenos">229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">input_image</span><span class="p">,</span> 
</span><span id="CenterLocator-230"><a href="#CenterLocator-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="p">,</span>
</span><span id="CenterLocator-231"><a href="#CenterLocator-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
</span><span id="CenterLocator-232"><a href="#CenterLocator-232"><span class="linenos">232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span>
</span><span id="CenterLocator-233"><a href="#CenterLocator-233"><span class="linenos">233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">heq</span><span class="p">,</span> 
</span><span id="CenterLocator-234"><a href="#CenterLocator-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span>
</span><span id="CenterLocator-235"><a href="#CenterLocator-235"><span class="linenos">235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterLocator-236"><a href="#CenterLocator-236"><span class="linenos">236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
</span><span id="CenterLocator-237"><a href="#CenterLocator-237"><span class="linenos">237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_sums</span><span class="p">)</span>
</span><span id="CenterLocator-238"><a href="#CenterLocator-238"><span class="linenos">238</span></a>        
</span><span id="CenterLocator-239"><a href="#CenterLocator-239"><span class="linenos">239</span></a>        <span class="c1">## (6) Collect results from CenterDetermination + CenterRefinement</span>
</span><span id="CenterLocator-240"><a href="#CenterLocator-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="CenterLocator-241"><a href="#CenterLocator-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="CenterLocator-242"><a href="#CenterLocator-242"><span class="linenos">242</span></a>        
</span><span id="CenterLocator-243"><a href="#CenterLocator-243"><span class="linenos">243</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-244"><a href="#CenterLocator-244"><span class="linenos">244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span>
</span><span id="CenterLocator-245"><a href="#CenterLocator-245"><span class="linenos">245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span>
</span><span id="CenterLocator-246"><a href="#CenterLocator-246"><span class="linenos">246</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterLocator-247"><a href="#CenterLocator-247"><span class="linenos">247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="CenterLocator-248"><a href="#CenterLocator-248"><span class="linenos">248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="CenterLocator-249"><a href="#CenterLocator-249"><span class="linenos">249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">x</span>
</span><span id="CenterLocator-250"><a href="#CenterLocator-250"><span class="linenos">250</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">y</span>
</span><span id="CenterLocator-251"><a href="#CenterLocator-251"><span class="linenos">251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterLocator-252"><a href="#CenterLocator-252"><span class="linenos">252</span></a>        
</span><span id="CenterLocator-253"><a href="#CenterLocator-253"><span class="linenos">253</span></a>        <span class="c1">## (7) Switch coordinates if necessary</span>
</span><span id="CenterLocator-254"><a href="#CenterLocator-254"><span class="linenos">254</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">):</span>
</span><span id="CenterLocator-255"><a href="#CenterLocator-255"><span class="linenos">255</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator-256"><a href="#CenterLocator-256"><span class="linenos">256</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="CenterLocator-257"><a href="#CenterLocator-257"><span class="linenos">257</span></a>        
</span><span id="CenterLocator-258"><a href="#CenterLocator-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span><span class="s2">&quot;hough&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">):</span>
</span><span id="CenterLocator-259"><a href="#CenterLocator-259"><span class="linenos">259</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>  
</span><span id="CenterLocator-260"><a href="#CenterLocator-260"><span class="linenos">260</span></a>
</span><span id="CenterLocator-261"><a href="#CenterLocator-261"><span class="linenos">261</span></a>        <span class="c1">## (8) Print the coordinates if required</span>
</span><span id="CenterLocator-262"><a href="#CenterLocator-262"><span class="linenos">262</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_print</span><span class="p">:</span>
</span><span id="CenterLocator-263"><a href="#CenterLocator-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="p">)</span>
</span><span id="CenterLocator-264"><a href="#CenterLocator-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="p">)</span>
</span><span id="CenterLocator-265"><a href="#CenterLocator-265"><span class="linenos">265</span></a>            
</span><span id="CenterLocator-266"><a href="#CenterLocator-266"><span class="linenos">266</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-267"><a href="#CenterLocator-267"><span class="linenos">267</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)))</span>
</span><span id="CenterLocator-268"><a href="#CenterLocator-268"><span class="linenos">268</span></a>            
</span><span id="CenterLocator-269"><a href="#CenterLocator-269"><span class="linenos">269</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-270"><a href="#CenterLocator-270"><span class="linenos">270</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rText</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)))</span>
</span><span id="CenterLocator-271"><a href="#CenterLocator-271"><span class="linenos">271</span></a>                        
</span><span id="CenterLocator-272"><a href="#CenterLocator-272"><span class="linenos">272</span></a>        <span class="c1">## (9) Save results to a .txt file if specified</span>
</span><span id="CenterLocator-273"><a href="#CenterLocator-273"><span class="linenos">273</span></a>        <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-274"><a href="#CenterLocator-274"><span class="linenos">274</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span><span class="p">()</span>
</span><span id="CenterLocator-275"><a href="#CenterLocator-275"><span class="linenos">275</span></a>
</span><span id="CenterLocator-276"><a href="#CenterLocator-276"><span class="linenos">276</span></a>    
</span><span id="CenterLocator-277"><a href="#CenterLocator-277"><span class="linenos">277</span></a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator-278"><a href="#CenterLocator-278"><span class="linenos">278</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-279"><a href="#CenterLocator-279"><span class="linenos">279</span></a><span class="sd">        Return the final results of center determination and refinement. </span>
</span><span id="CenterLocator-280"><a href="#CenterLocator-280"><span class="linenos">280</span></a><span class="sd">        </span>
</span><span id="CenterLocator-281"><a href="#CenterLocator-281"><span class="linenos">281</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-282"><a href="#CenterLocator-282"><span class="linenos">282</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-283"><a href="#CenterLocator-283"><span class="linenos">283</span></a><span class="sd">        x1 : float</span>
</span><span id="CenterLocator-284"><a href="#CenterLocator-284"><span class="linenos">284</span></a><span class="sd">            x-coordinate of the center from *determination* method</span>
</span><span id="CenterLocator-285"><a href="#CenterLocator-285"><span class="linenos">285</span></a><span class="sd">        y1 : float</span>
</span><span id="CenterLocator-286"><a href="#CenterLocator-286"><span class="linenos">286</span></a><span class="sd">            y-coordinate of the center from *determination* method</span>
</span><span id="CenterLocator-287"><a href="#CenterLocator-287"><span class="linenos">287</span></a><span class="sd">        x2 : float</span>
</span><span id="CenterLocator-288"><a href="#CenterLocator-288"><span class="linenos">288</span></a><span class="sd">            x-coordinate of the center from *refinement* method</span>
</span><span id="CenterLocator-289"><a href="#CenterLocator-289"><span class="linenos">289</span></a><span class="sd">        y2 : float</span>
</span><span id="CenterLocator-290"><a href="#CenterLocator-290"><span class="linenos">290</span></a><span class="sd">            y-coordinate of the center from *refinement* method</span>
</span><span id="CenterLocator-291"><a href="#CenterLocator-291"><span class="linenos">291</span></a><span class="sd">            </span>
</span><span id="CenterLocator-292"><a href="#CenterLocator-292"><span class="linenos">292</span></a><span class="sd">        Technical note</span>
</span><span id="CenterLocator-293"><a href="#CenterLocator-293"><span class="linenos">293</span></a><span class="sd">        --------------</span>
</span><span id="CenterLocator-294"><a href="#CenterLocator-294"><span class="linenos">294</span></a><span class="sd">        * The function always returns four parameters.</span>
</span><span id="CenterLocator-295"><a href="#CenterLocator-295"><span class="linenos">295</span></a><span class="sd">        * In most cases, the output are four coordinates (x1,y1,x2,y2).</span>
</span><span id="CenterLocator-296"><a href="#CenterLocator-296"><span class="linenos">296</span></a><span class="sd">        * If the *refinement* method was None, the output is (x1,y1,x1,y1);</span>
</span><span id="CenterLocator-297"><a href="#CenterLocator-297"><span class="linenos">297</span></a><span class="sd">          i.e. the *determined* and *refined* center coordinates are the same.</span>
</span><span id="CenterLocator-298"><a href="#CenterLocator-298"><span class="linenos">298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator-299"><a href="#CenterLocator-299"><span class="linenos">299</span></a>        
</span><span id="CenterLocator-300"><a href="#CenterLocator-300"><span class="linenos">300</span></a>        <span class="c1"># (1) Refinement method was not None =&gt; prepare (x1,y1,x2,y2)</span>
</span><span id="CenterLocator-301"><a href="#CenterLocator-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterLocator-302"><a href="#CenterLocator-302"><span class="linenos">302</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator-303"><a href="#CenterLocator-303"><span class="linenos">303</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator-304"><a href="#CenterLocator-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> \
</span><span id="CenterLocator-305"><a href="#CenterLocator-305"><span class="linenos">305</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> 
</span><span id="CenterLocator-306"><a href="#CenterLocator-306"><span class="linenos">306</span></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)]</span>
</span><span id="CenterLocator-307"><a href="#CenterLocator-307"><span class="linenos">307</span></a>        <span class="c1"># (2) Refinement method was None =&gt; prepare (x1,y1) = (x2,y2)                      </span>
</span><span id="CenterLocator-308"><a href="#CenterLocator-308"><span class="linenos">308</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-309"><a href="#CenterLocator-309"><span class="linenos">309</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator-310"><a href="#CenterLocator-310"><span class="linenos">310</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator-311"><a href="#CenterLocator-311"><span class="linenos">311</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> \
</span><span id="CenterLocator-312"><a href="#CenterLocator-312"><span class="linenos">312</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)]</span>
</span><span id="CenterLocator-313"><a href="#CenterLocator-313"><span class="linenos">313</span></a>            <span class="c1"># Define x2,y2 = x1,y1</span>
</span><span id="CenterLocator-314"><a href="#CenterLocator-314"><span class="linenos">314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
</span><span id="CenterLocator-315"><a href="#CenterLocator-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span>
</span><span id="CenterLocator-316"><a href="#CenterLocator-316"><span class="linenos">316</span></a>            
</span><span id="CenterLocator-317"><a href="#CenterLocator-317"><span class="linenos">317</span></a>        <span class="c1"># (3) Return (rounded) values of center coordinates</span>
</span><span id="CenterLocator-318"><a href="#CenterLocator-318"><span class="linenos">318</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
</span><span id="CenterLocator-319"><a href="#CenterLocator-319"><span class="linenos">319</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="CenterLocator-320"><a href="#CenterLocator-320"><span class="linenos">320</span></a>
</span><span id="CenterLocator-321"><a href="#CenterLocator-321"><span class="linenos">321</span></a>    
</span><span id="CenterLocator-322"><a href="#CenterLocator-322"><span class="linenos">322</span></a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator-323"><a href="#CenterLocator-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator-324"><a href="#CenterLocator-324"><span class="linenos">324</span></a><span class="sd">        Save the current results to a specified file. The results are formatted </span>
</span><span id="CenterLocator-325"><a href="#CenterLocator-325"><span class="linenos">325</span></a><span class="sd">        to four decimal places for clarity.</span>
</span><span id="CenterLocator-326"><a href="#CenterLocator-326"><span class="linenos">326</span></a>
</span><span id="CenterLocator-327"><a href="#CenterLocator-327"><span class="linenos">327</span></a><span class="sd">        </span>
</span><span id="CenterLocator-328"><a href="#CenterLocator-328"><span class="linenos">328</span></a><span class="sd">        This method checks if a file path has been provided through </span>
</span><span id="CenterLocator-329"><a href="#CenterLocator-329"><span class="linenos">329</span></a><span class="sd">        the `in_file` attribute. </span>
</span><span id="CenterLocator-330"><a href="#CenterLocator-330"><span class="linenos">330</span></a><span class="sd">        </span>
</span><span id="CenterLocator-331"><a href="#CenterLocator-331"><span class="linenos">331</span></a><span class="sd">        - If the specified file exists, the method appends the results </span>
</span><span id="CenterLocator-332"><a href="#CenterLocator-332"><span class="linenos">332</span></a><span class="sd">        (x1, y1, x2, y2) to the end of the file. </span>
</span><span id="CenterLocator-333"><a href="#CenterLocator-333"><span class="linenos">333</span></a><span class="sd">        - If the file does not exist, it creates a new file and writes </span>
</span><span id="CenterLocator-334"><a href="#CenterLocator-334"><span class="linenos">334</span></a><span class="sd">        the results to it.</span>
</span><span id="CenterLocator-335"><a href="#CenterLocator-335"><span class="linenos">335</span></a><span class="sd">        </span>
</span><span id="CenterLocator-336"><a href="#CenterLocator-336"><span class="linenos">336</span></a><span class="sd">        </span>
</span><span id="CenterLocator-337"><a href="#CenterLocator-337"><span class="linenos">337</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-338"><a href="#CenterLocator-338"><span class="linenos">338</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-339"><a href="#CenterLocator-339"><span class="linenos">339</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-340"><a href="#CenterLocator-340"><span class="linenos">340</span></a><span class="sd">        </span>
</span><span id="CenterLocator-341"><a href="#CenterLocator-341"><span class="linenos">341</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-342"><a href="#CenterLocator-342"><span class="linenos">342</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-343"><a href="#CenterLocator-343"><span class="linenos">343</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-344"><a href="#CenterLocator-344"><span class="linenos">344</span></a><span class="sd">        </span>
</span><span id="CenterLocator-345"><a href="#CenterLocator-345"><span class="linenos">345</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator-346"><a href="#CenterLocator-346"><span class="linenos">346</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator-347"><a href="#CenterLocator-347"><span class="linenos">347</span></a><span class="sd">        - The results are written in the format:</span>
</span><span id="CenterLocator-348"><a href="#CenterLocator-348"><span class="linenos">348</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator-349"><a href="#CenterLocator-349"><span class="linenos">349</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator-350"><a href="#CenterLocator-350"><span class="linenos">350</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-351"><a href="#CenterLocator-351"><span class="linenos">351</span></a>        
</span><span id="CenterLocator-352"><a href="#CenterLocator-352"><span class="linenos">352</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-353"><a href="#CenterLocator-353"><span class="linenos">353</span></a>            <span class="c1"># Check if the specified file exists</span>
</span><span id="CenterLocator-354"><a href="#CenterLocator-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">):</span>
</span><span id="CenterLocator-355"><a href="#CenterLocator-355"><span class="linenos">355</span></a>                <span class="c1"># Append results to in_file</span>
</span><span id="CenterLocator-356"><a href="#CenterLocator-356"><span class="linenos">356</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in append mode</span>
</span><span id="CenterLocator-357"><a href="#CenterLocator-357"><span class="linenos">357</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-358"><a href="#CenterLocator-358"><span class="linenos">358</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-359"><a href="#CenterLocator-359"><span class="linenos">359</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-360"><a href="#CenterLocator-360"><span class="linenos">360</span></a>                <span class="c1"># If the file does not exist, create it and write results</span>
</span><span id="CenterLocator-361"><a href="#CenterLocator-361"><span class="linenos">361</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in write mode</span>
</span><span id="CenterLocator-362"><a href="#CenterLocator-362"><span class="linenos">362</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-363"><a href="#CenterLocator-363"><span class="linenos">363</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-364"><a href="#CenterLocator-364"><span class="linenos">364</span></a>
</span><span id="CenterLocator-365"><a href="#CenterLocator-365"><span class="linenos">365</span></a>
</span><span id="CenterLocator-366"><a href="#CenterLocator-366"><span class="linenos">366</span></a>    <span class="k">def</span> <span class="nf">load_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator-367"><a href="#CenterLocator-367"><span class="linenos">367</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator-368"><a href="#CenterLocator-368"><span class="linenos">368</span></a><span class="sd">        Load results from a specified text file.</span>
</span><span id="CenterLocator-369"><a href="#CenterLocator-369"><span class="linenos">369</span></a><span class="sd">    </span>
</span><span id="CenterLocator-370"><a href="#CenterLocator-370"><span class="linenos">370</span></a><span class="sd">        This method reads the coordinates from a text file defined by the </span>
</span><span id="CenterLocator-371"><a href="#CenterLocator-371"><span class="linenos">371</span></a><span class="sd">        `out_file` attribute. It extracts pairs of coordinates (x1, y1) and </span>
</span><span id="CenterLocator-372"><a href="#CenterLocator-372"><span class="linenos">372</span></a><span class="sd">        (x2, y2) from each line in the file. The extracted values are stored in </span>
</span><span id="CenterLocator-373"><a href="#CenterLocator-373"><span class="linenos">373</span></a><span class="sd">        lists, allowing for the retrieval of multiple results.The most recent </span>
</span><span id="CenterLocator-374"><a href="#CenterLocator-374"><span class="linenos">374</span></a><span class="sd">        values of x1, y1, x2, and y2 can be stored as instance variables</span>
</span><span id="CenterLocator-375"><a href="#CenterLocator-375"><span class="linenos">375</span></a><span class="sd">        for easy access.</span>
</span><span id="CenterLocator-376"><a href="#CenterLocator-376"><span class="linenos">376</span></a><span class="sd">    </span>
</span><span id="CenterLocator-377"><a href="#CenterLocator-377"><span class="linenos">377</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-378"><a href="#CenterLocator-378"><span class="linenos">378</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-379"><a href="#CenterLocator-379"><span class="linenos">379</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-380"><a href="#CenterLocator-380"><span class="linenos">380</span></a><span class="sd">    </span>
</span><span id="CenterLocator-381"><a href="#CenterLocator-381"><span class="linenos">381</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-382"><a href="#CenterLocator-382"><span class="linenos">382</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-383"><a href="#CenterLocator-383"><span class="linenos">383</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-384"><a href="#CenterLocator-384"><span class="linenos">384</span></a><span class="sd">    </span>
</span><span id="CenterLocator-385"><a href="#CenterLocator-385"><span class="linenos">385</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator-386"><a href="#CenterLocator-386"><span class="linenos">386</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator-387"><a href="#CenterLocator-387"><span class="linenos">387</span></a><span class="sd">        - The results are expected to be in the format:</span>
</span><span id="CenterLocator-388"><a href="#CenterLocator-388"><span class="linenos">388</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator-389"><a href="#CenterLocator-389"><span class="linenos">389</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator-390"><a href="#CenterLocator-390"><span class="linenos">390</span></a><span class="sd">        - If multiple sets of coordinates are found, they are stored in lists,</span>
</span><span id="CenterLocator-391"><a href="#CenterLocator-391"><span class="linenos">391</span></a><span class="sd">        and only the last set can be accessed as instance variables.</span>
</span><span id="CenterLocator-392"><a href="#CenterLocator-392"><span class="linenos">392</span></a><span class="sd">        &#39;&#39;&#39;</span>        
</span><span id="CenterLocator-393"><a href="#CenterLocator-393"><span class="linenos">393</span></a>        
</span><span id="CenterLocator-394"><a href="#CenterLocator-394"><span class="linenos">394</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">):</span>
</span><span id="CenterLocator-395"><a href="#CenterLocator-395"><span class="linenos">395</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CenterLocator-396"><a href="#CenterLocator-396"><span class="linenos">396</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CenterLocator-397"><a href="#CenterLocator-397"><span class="linenos">397</span></a>                
</span><span id="CenterLocator-398"><a href="#CenterLocator-398"><span class="linenos">398</span></a>                <span class="c1"># Initialize lists to hold multiple values</span>
</span><span id="CenterLocator-399"><a href="#CenterLocator-399"><span class="linenos">399</span></a>                <span class="n">x1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-400"><a href="#CenterLocator-400"><span class="linenos">400</span></a>                <span class="n">y1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-401"><a href="#CenterLocator-401"><span class="linenos">401</span></a>                <span class="n">x2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-402"><a href="#CenterLocator-402"><span class="linenos">402</span></a>                <span class="n">y2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator-403"><a href="#CenterLocator-403"><span class="linenos">403</span></a>    
</span><span id="CenterLocator-404"><a href="#CenterLocator-404"><span class="linenos">404</span></a>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="CenterLocator-405"><a href="#CenterLocator-405"><span class="linenos">405</span></a>                    <span class="c1"># Strip and split each line to get the coordinates</span>
</span><span id="CenterLocator-406"><a href="#CenterLocator-406"><span class="linenos">406</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-407"><a href="#CenterLocator-407"><span class="linenos">407</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterLocator-408"><a href="#CenterLocator-408"><span class="linenos">408</span></a>                        <span class="c1"># Extract x1 and y1 or x2 and y2 based on line content</span>
</span><span id="CenterLocator-409"><a href="#CenterLocator-409"><span class="linenos">409</span></a>                        <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator-410"><a href="#CenterLocator-410"><span class="linenos">410</span></a>                            <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-411"><a href="#CenterLocator-411"><span class="linenos">411</span></a>                            <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-412"><a href="#CenterLocator-412"><span class="linenos">412</span></a>                            <span class="n">x1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
</span><span id="CenterLocator-413"><a href="#CenterLocator-413"><span class="linenos">413</span></a>                            <span class="n">y1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator-414"><a href="#CenterLocator-414"><span class="linenos">414</span></a>                        <span class="k">elif</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator-415"><a href="#CenterLocator-415"><span class="linenos">415</span></a>                            <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-416"><a href="#CenterLocator-416"><span class="linenos">416</span></a>                            <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator-417"><a href="#CenterLocator-417"><span class="linenos">417</span></a>                            <span class="n">x2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</span><span id="CenterLocator-418"><a href="#CenterLocator-418"><span class="linenos">418</span></a>                            <span class="n">y2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator-419"><a href="#CenterLocator-419"><span class="linenos">419</span></a>    
</span><span id="CenterLocator-420"><a href="#CenterLocator-420"><span class="linenos">420</span></a>                <span class="c1"># Store the last set of values as instance variables </span>
</span><span id="CenterLocator-421"><a href="#CenterLocator-421"><span class="linenos">421</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span>
</span><span id="CenterLocator-422"><a href="#CenterLocator-422"><span class="linenos">422</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span>
</span><span id="CenterLocator-423"><a href="#CenterLocator-423"><span class="linenos">423</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span>
</span><span id="CenterLocator-424"><a href="#CenterLocator-424"><span class="linenos">424</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span>
</span><span id="CenterLocator-425"><a href="#CenterLocator-425"><span class="linenos">425</span></a>    
</span><span id="CenterLocator-426"><a href="#CenterLocator-426"><span class="linenos">426</span></a>                <span class="c1"># Store the last loaded values:</span>
</span><span id="CenterLocator-427"><a href="#CenterLocator-427"><span class="linenos">427</span></a>                <span class="k">if</span> <span class="n">x1_values</span> <span class="ow">and</span> <span class="n">y1_values</span> <span class="ow">and</span> <span class="n">x2_values</span> <span class="ow">and</span> <span class="n">y2_values</span><span class="p">:</span>
</span><span id="CenterLocator-428"><a href="#CenterLocator-428"><span class="linenos">428</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-429"><a href="#CenterLocator-429"><span class="linenos">429</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-430"><a href="#CenterLocator-430"><span class="linenos">430</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-431"><a href="#CenterLocator-431"><span class="linenos">431</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator-432"><a href="#CenterLocator-432"><span class="linenos">432</span></a>    
</span><span id="CenterLocator-433"><a href="#CenterLocator-433"><span class="linenos">433</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-434"><a href="#CenterLocator-434"><span class="linenos">434</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error reading text file with center coordinates!&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-435"><a href="#CenterLocator-435"><span class="linenos">435</span></a>
</span><span id="CenterLocator-436"><a href="#CenterLocator-436"><span class="linenos">436</span></a>
</span><span id="CenterLocator-437"><a href="#CenterLocator-437"><span class="linenos">437</span></a>    <span class="k">def</span> <span class="nf">get_circle_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
</span><span id="CenterLocator-438"><a href="#CenterLocator-438"><span class="linenos">438</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterLocator-439"><a href="#CenterLocator-439"><span class="linenos">439</span></a><span class="sd">        Get coordinates of pixels defining circle border</span>
</span><span id="CenterLocator-440"><a href="#CenterLocator-440"><span class="linenos">440</span></a><span class="sd">    </span>
</span><span id="CenterLocator-441"><a href="#CenterLocator-441"><span class="linenos">441</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-442"><a href="#CenterLocator-442"><span class="linenos">442</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-443"><a href="#CenterLocator-443"><span class="linenos">443</span></a><span class="sd">        self.image_path : str</span>
</span><span id="CenterLocator-444"><a href="#CenterLocator-444"><span class="linenos">444</span></a><span class="sd">            direct path to a image with diffraction patterns</span>
</span><span id="CenterLocator-445"><a href="#CenterLocator-445"><span class="linenos">445</span></a><span class="sd">        xc : float64</span>
</span><span id="CenterLocator-446"><a href="#CenterLocator-446"><span class="linenos">446</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterLocator-447"><a href="#CenterLocator-447"><span class="linenos">447</span></a><span class="sd">        yc : float64</span>
</span><span id="CenterLocator-448"><a href="#CenterLocator-448"><span class="linenos">448</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterLocator-449"><a href="#CenterLocator-449"><span class="linenos">449</span></a><span class="sd">        radius : float64</span>
</span><span id="CenterLocator-450"><a href="#CenterLocator-450"><span class="linenos">450</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterLocator-451"><a href="#CenterLocator-451"><span class="linenos">451</span></a><span class="sd">        num_points : float64 </span>
</span><span id="CenterLocator-452"><a href="#CenterLocator-452"><span class="linenos">452</span></a><span class="sd">            number of border points. The default is 360</span>
</span><span id="CenterLocator-453"><a href="#CenterLocator-453"><span class="linenos">453</span></a><span class="sd">        </span>
</span><span id="CenterLocator-454"><a href="#CenterLocator-454"><span class="linenos">454</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-455"><a href="#CenterLocator-455"><span class="linenos">455</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-456"><a href="#CenterLocator-456"><span class="linenos">456</span></a><span class="sd">        x : array of float64</span>
</span><span id="CenterLocator-457"><a href="#CenterLocator-457"><span class="linenos">457</span></a><span class="sd">            x-coordinates of pixels from circle border</span>
</span><span id="CenterLocator-458"><a href="#CenterLocator-458"><span class="linenos">458</span></a><span class="sd">        y : array of float64</span>
</span><span id="CenterLocator-459"><a href="#CenterLocator-459"><span class="linenos">459</span></a><span class="sd">            y-coordinates of pixels from circle border</span>
</span><span id="CenterLocator-460"><a href="#CenterLocator-460"><span class="linenos">460</span></a><span class="sd">            </span>
</span><span id="CenterLocator-461"><a href="#CenterLocator-461"><span class="linenos">461</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-462"><a href="#CenterLocator-462"><span class="linenos">462</span></a>        
</span><span id="CenterLocator-463"><a href="#CenterLocator-463"><span class="linenos">463</span></a>        <span class="c1"># Generate angles from 0 to 2*pi</span>
</span><span id="CenterLocator-464"><a href="#CenterLocator-464"><span class="linenos">464</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>  
</span><span id="CenterLocator-465"><a href="#CenterLocator-465"><span class="linenos">465</span></a>                
</span><span id="CenterLocator-466"><a href="#CenterLocator-466"><span class="linenos">466</span></a>        <span class="c1"># Calculate x,y-coordinates of points on the actual circle border</span>
</span><span id="CenterLocator-467"><a href="#CenterLocator-467"><span class="linenos">467</span></a>        <span class="n">x_actual</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="CenterLocator-468"><a href="#CenterLocator-468"><span class="linenos">468</span></a>        <span class="n">y_actual</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="CenterLocator-469"><a href="#CenterLocator-469"><span class="linenos">469</span></a>        
</span><span id="CenterLocator-470"><a href="#CenterLocator-470"><span class="linenos">470</span></a>        <span class="k">return</span> <span class="n">x_actual</span><span class="p">,</span> <span class="n">y_actual</span>
</span><span id="CenterLocator-471"><a href="#CenterLocator-471"><span class="linenos">471</span></a>          
</span><span id="CenterLocator-472"><a href="#CenterLocator-472"><span class="linenos">472</span></a>    
</span><span id="CenterLocator-473"><a href="#CenterLocator-473"><span class="linenos">473</span></a>    <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterLocator-474"><a href="#CenterLocator-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterLocator-475"><a href="#CenterLocator-475"><span class="linenos">475</span></a><span class="sd">        Summation of intensity values of pixels of a diffraction pattern.</span>
</span><span id="CenterLocator-476"><a href="#CenterLocator-476"><span class="linenos">476</span></a>
</span><span id="CenterLocator-477"><a href="#CenterLocator-477"><span class="linenos">477</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-478"><a href="#CenterLocator-478"><span class="linenos">478</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-479"><a href="#CenterLocator-479"><span class="linenos">479</span></a><span class="sd">        image : array of uint8</span>
</span><span id="CenterLocator-480"><a href="#CenterLocator-480"><span class="linenos">480</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="CenterLocator-481"><a href="#CenterLocator-481"><span class="linenos">481</span></a><span class="sd">        px : float64</span>
</span><span id="CenterLocator-482"><a href="#CenterLocator-482"><span class="linenos">482</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator-483"><a href="#CenterLocator-483"><span class="linenos">483</span></a><span class="sd">        py : float64</span>
</span><span id="CenterLocator-484"><a href="#CenterLocator-484"><span class="linenos">484</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator-485"><a href="#CenterLocator-485"><span class="linenos">485</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterLocator-486"><a href="#CenterLocator-486"><span class="linenos">486</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterLocator-487"><a href="#CenterLocator-487"><span class="linenos">487</span></a>
</span><span id="CenterLocator-488"><a href="#CenterLocator-488"><span class="linenos">488</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-489"><a href="#CenterLocator-489"><span class="linenos">489</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-490"><a href="#CenterLocator-490"><span class="linenos">490</span></a><span class="sd">        s : float64</span>
</span><span id="CenterLocator-491"><a href="#CenterLocator-491"><span class="linenos">491</span></a><span class="sd">            intensity sum</span>
</span><span id="CenterLocator-492"><a href="#CenterLocator-492"><span class="linenos">492</span></a>
</span><span id="CenterLocator-493"><a href="#CenterLocator-493"><span class="linenos">493</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-494"><a href="#CenterLocator-494"><span class="linenos">494</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="CenterLocator-495"><a href="#CenterLocator-495"><span class="linenos">495</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterLocator-496"><a href="#CenterLocator-496"><span class="linenos">496</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator-497"><a href="#CenterLocator-497"><span class="linenos">497</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator-498"><a href="#CenterLocator-498"><span class="linenos">498</span></a>        
</span><span id="CenterLocator-499"><a href="#CenterLocator-499"><span class="linenos">499</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="CenterLocator-500"><a href="#CenterLocator-500"><span class="linenos">500</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pyc</span><span class="p">,</span> <span class="n">pxc</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">pxc</span><span class="p">)</span>
</span><span id="CenterLocator-501"><a href="#CenterLocator-501"><span class="linenos">501</span></a>
</span><span id="CenterLocator-502"><a href="#CenterLocator-502"><span class="linenos">502</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="CenterLocator-503"><a href="#CenterLocator-503"><span class="linenos">503</span></a>    
</span><span id="CenterLocator-504"><a href="#CenterLocator-504"><span class="linenos">504</span></a>    
</span><span id="CenterLocator-505"><a href="#CenterLocator-505"><span class="linenos">505</span></a>    <span class="k">def</span> <span class="nf">intensity_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterLocator-506"><a href="#CenterLocator-506"><span class="linenos">506</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterLocator-507"><a href="#CenterLocator-507"><span class="linenos">507</span></a><span class="sd">        Variance of intensity values of pixels of a diffraction pattern.</span>
</span><span id="CenterLocator-508"><a href="#CenterLocator-508"><span class="linenos">508</span></a>
</span><span id="CenterLocator-509"><a href="#CenterLocator-509"><span class="linenos">509</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-510"><a href="#CenterLocator-510"><span class="linenos">510</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-511"><a href="#CenterLocator-511"><span class="linenos">511</span></a><span class="sd">        image : array of uint8</span>
</span><span id="CenterLocator-512"><a href="#CenterLocator-512"><span class="linenos">512</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="CenterLocator-513"><a href="#CenterLocator-513"><span class="linenos">513</span></a><span class="sd">        px : float64</span>
</span><span id="CenterLocator-514"><a href="#CenterLocator-514"><span class="linenos">514</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator-515"><a href="#CenterLocator-515"><span class="linenos">515</span></a><span class="sd">        py : float64</span>
</span><span id="CenterLocator-516"><a href="#CenterLocator-516"><span class="linenos">516</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator-517"><a href="#CenterLocator-517"><span class="linenos">517</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterLocator-518"><a href="#CenterLocator-518"><span class="linenos">518</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterLocator-519"><a href="#CenterLocator-519"><span class="linenos">519</span></a>
</span><span id="CenterLocator-520"><a href="#CenterLocator-520"><span class="linenos">520</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-521"><a href="#CenterLocator-521"><span class="linenos">521</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-522"><a href="#CenterLocator-522"><span class="linenos">522</span></a><span class="sd">        s : float64</span>
</span><span id="CenterLocator-523"><a href="#CenterLocator-523"><span class="linenos">523</span></a><span class="sd">            intensity variance</span>
</span><span id="CenterLocator-524"><a href="#CenterLocator-524"><span class="linenos">524</span></a>
</span><span id="CenterLocator-525"><a href="#CenterLocator-525"><span class="linenos">525</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-526"><a href="#CenterLocator-526"><span class="linenos">526</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="CenterLocator-527"><a href="#CenterLocator-527"><span class="linenos">527</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterLocator-528"><a href="#CenterLocator-528"><span class="linenos">528</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator-529"><a href="#CenterLocator-529"><span class="linenos">529</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator-530"><a href="#CenterLocator-530"><span class="linenos">530</span></a>        
</span><span id="CenterLocator-531"><a href="#CenterLocator-531"><span class="linenos">531</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="CenterLocator-532"><a href="#CenterLocator-532"><span class="linenos">532</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span><span class="p">])</span>
</span><span id="CenterLocator-533"><a href="#CenterLocator-533"><span class="linenos">533</span></a>        <span class="k">return</span> <span class="n">s</span>
</span><span id="CenterLocator-534"><a href="#CenterLocator-534"><span class="linenos">534</span></a>    
</span><span id="CenterLocator-535"><a href="#CenterLocator-535"><span class="linenos">535</span></a>    
</span><span id="CenterLocator-536"><a href="#CenterLocator-536"><span class="linenos">536</span></a>    <span class="k">def</span> <span class="nf">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="CenterLocator-537"><a href="#CenterLocator-537"><span class="linenos">537</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator-538"><a href="#CenterLocator-538"><span class="linenos">538</span></a><span class="sd">        Convert coordinates between numpy and matplotlib systems.</span>
</span><span id="CenterLocator-539"><a href="#CenterLocator-539"><span class="linenos">539</span></a><span class="sd">    </span>
</span><span id="CenterLocator-540"><a href="#CenterLocator-540"><span class="linenos">540</span></a><span class="sd">        Parameters:</span>
</span><span id="CenterLocator-541"><a href="#CenterLocator-541"><span class="linenos">541</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-542"><a href="#CenterLocator-542"><span class="linenos">542</span></a><span class="sd">        x : int or float</span>
</span><span id="CenterLocator-543"><a href="#CenterLocator-543"><span class="linenos">543</span></a><span class="sd">            The x-coordinate in the numpy (column index) format.</span>
</span><span id="CenterLocator-544"><a href="#CenterLocator-544"><span class="linenos">544</span></a><span class="sd">        y : int or float</span>
</span><span id="CenterLocator-545"><a href="#CenterLocator-545"><span class="linenos">545</span></a><span class="sd">            The y-coordinate in the numpy (row index) format.</span>
</span><span id="CenterLocator-546"><a href="#CenterLocator-546"><span class="linenos">546</span></a><span class="sd">    </span>
</span><span id="CenterLocator-547"><a href="#CenterLocator-547"><span class="linenos">547</span></a><span class="sd">        Returns:</span>
</span><span id="CenterLocator-548"><a href="#CenterLocator-548"><span class="linenos">548</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-549"><a href="#CenterLocator-549"><span class="linenos">549</span></a><span class="sd">        tuple of (int or float, int or float)</span>
</span><span id="CenterLocator-550"><a href="#CenterLocator-550"><span class="linenos">550</span></a><span class="sd">            The converted coordinates in matplotlib format, where:</span>
</span><span id="CenterLocator-551"><a href="#CenterLocator-551"><span class="linenos">551</span></a><span class="sd">            - First element corresponds to y (new x in matplotlib).</span>
</span><span id="CenterLocator-552"><a href="#CenterLocator-552"><span class="linenos">552</span></a><span class="sd">            - Second element corresponds to x (new y in matplotlib).</span>
</span><span id="CenterLocator-553"><a href="#CenterLocator-553"><span class="linenos">553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator-554"><a href="#CenterLocator-554"><span class="linenos">554</span></a>        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
</span><span id="CenterLocator-555"><a href="#CenterLocator-555"><span class="linenos">555</span></a>
</span><span id="CenterLocator-556"><a href="#CenterLocator-556"><span class="linenos">556</span></a>
</span><span id="CenterLocator-557"><a href="#CenterLocator-557"><span class="linenos">557</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CenterLocator-558"><a href="#CenterLocator-558"><span class="linenos">558</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator-559"><a href="#CenterLocator-559"><span class="linenos">559</span></a><span class="sd">        Visualize diffractogram and its center after</span>
</span><span id="CenterLocator-560"><a href="#CenterLocator-560"><span class="linenos">560</span></a><span class="sd">        center determination + refinement.</span>
</span><span id="CenterLocator-561"><a href="#CenterLocator-561"><span class="linenos">561</span></a><span class="sd">    </span>
</span><span id="CenterLocator-562"><a href="#CenterLocator-562"><span class="linenos">562</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator-563"><a href="#CenterLocator-563"><span class="linenos">563</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator-564"><a href="#CenterLocator-564"><span class="linenos">564</span></a><span class="sd">        csquare : int, optional, default is None</span>
</span><span id="CenterLocator-565"><a href="#CenterLocator-565"><span class="linenos">565</span></a><span class="sd">            If csquare argument is given,</span>
</span><span id="CenterLocator-566"><a href="#CenterLocator-566"><span class="linenos">566</span></a><span class="sd">            only the central square of the diffractogram will be plotted;</span>
</span><span id="CenterLocator-567"><a href="#CenterLocator-567"><span class="linenos">567</span></a><span class="sd">            the size of the central square will be equal to csquare argument.</span>
</span><span id="CenterLocator-568"><a href="#CenterLocator-568"><span class="linenos">568</span></a><span class="sd">    </span>
</span><span id="CenterLocator-569"><a href="#CenterLocator-569"><span class="linenos">569</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator-570"><a href="#CenterLocator-570"><span class="linenos">570</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator-571"><a href="#CenterLocator-571"><span class="linenos">571</span></a><span class="sd">        None</span>
</span><span id="CenterLocator-572"><a href="#CenterLocator-572"><span class="linenos">572</span></a><span class="sd">            The output is the image of the diffractogram</span>
</span><span id="CenterLocator-573"><a href="#CenterLocator-573"><span class="linenos">573</span></a><span class="sd">            showing also the central coordinates and refinement ring.</span>
</span><span id="CenterLocator-574"><a href="#CenterLocator-574"><span class="linenos">574</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator-575"><a href="#CenterLocator-575"><span class="linenos">575</span></a>        
</span><span id="CenterLocator-576"><a href="#CenterLocator-576"><span class="linenos">576</span></a>        <span class="c1"># (0) Collect center coordinates and radii</span>
</span><span id="CenterLocator-577"><a href="#CenterLocator-577"><span class="linenos">577</span></a>        <span class="c1"># x1,y1,r1 = coordinates and radius of the determined circle/ring</span>
</span><span id="CenterLocator-578"><a href="#CenterLocator-578"><span class="linenos">578</span></a>        <span class="c1"># x2,y2,r2 = coordinates and radius of the refined circle/ring</span>
</span><span id="CenterLocator-579"><a href="#CenterLocator-579"><span class="linenos">579</span></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator-580"><a href="#CenterLocator-580"><span class="linenos">580</span></a>        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterLocator-581"><a href="#CenterLocator-581"><span class="linenos">581</span></a>        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator-582"><a href="#CenterLocator-582"><span class="linenos">582</span></a>        <span class="n">r2</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span>
</span><span id="CenterLocator-583"><a href="#CenterLocator-583"><span class="linenos">583</span></a>        
</span><span id="CenterLocator-584"><a href="#CenterLocator-584"><span class="linenos">584</span></a>        <span class="c1"># (1) Prepare the image of the diffractogram</span>
</span><span id="CenterLocator-585"><a href="#CenterLocator-585"><span class="linenos">585</span></a>        <span class="c1"># ...copy diffractogram image</span>
</span><span id="CenterLocator-586"><a href="#CenterLocator-586"><span class="linenos">586</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterLocator-587"><a href="#CenterLocator-587"><span class="linenos">587</span></a>        <span class="c1"># ...cut image intensity if required</span>
</span><span id="CenterLocator-588"><a href="#CenterLocator-588"><span class="linenos">588</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-589"><a href="#CenterLocator-589"><span class="linenos">589</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator-590"><a href="#CenterLocator-590"><span class="linenos">590</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-591"><a href="#CenterLocator-591"><span class="linenos">591</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator-592"><a href="#CenterLocator-592"><span class="linenos">592</span></a>            
</span><span id="CenterLocator-593"><a href="#CenterLocator-593"><span class="linenos">593</span></a>        <span class="c1"># (2) Calculate intensity sum or intensity variance</span>
</span><span id="CenterLocator-594"><a href="#CenterLocator-594"><span class="linenos">594</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="CenterLocator-595"><a href="#CenterLocator-595"><span class="linenos">595</span></a>            <span class="c1"># Refinement was based on minimizing the intensity variance</span>
</span><span id="CenterLocator-596"><a href="#CenterLocator-596"><span class="linenos">596</span></a>            <span class="n">dvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator-597"><a href="#CenterLocator-597"><span class="linenos">597</span></a>            <span class="n">rvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator-598"><a href="#CenterLocator-598"><span class="linenos">598</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator-599"><a href="#CenterLocator-599"><span class="linenos">599</span></a>                <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator-600"><a href="#CenterLocator-600"><span class="linenos">600</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-var: </span><span class="si">{</span><span class="n">dvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-601"><a href="#CenterLocator-601"><span class="linenos">601</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator-602"><a href="#CenterLocator-602"><span class="linenos">602</span></a>                <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator-603"><a href="#CenterLocator-603"><span class="linenos">603</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-var: </span><span class="si">{</span><span class="n">rvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-604"><a href="#CenterLocator-604"><span class="linenos">604</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator-605"><a href="#CenterLocator-605"><span class="linenos">605</span></a>            <span class="c1"># All other cases: manual refinement or maximixing intensity sum</span>
</span><span id="CenterLocator-606"><a href="#CenterLocator-606"><span class="linenos">606</span></a>            <span class="n">dsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator-607"><a href="#CenterLocator-607"><span class="linenos">607</span></a>            <span class="n">rsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator-608"><a href="#CenterLocator-608"><span class="linenos">608</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator-609"><a href="#CenterLocator-609"><span class="linenos">609</span></a>                <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator-610"><a href="#CenterLocator-610"><span class="linenos">610</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-sum: </span><span class="si">{</span><span class="n">dsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-611"><a href="#CenterLocator-611"><span class="linenos">611</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator-612"><a href="#CenterLocator-612"><span class="linenos">612</span></a>                <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator-613"><a href="#CenterLocator-613"><span class="linenos">613</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-sum: </span><span class="si">{</span><span class="n">rsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-614"><a href="#CenterLocator-614"><span class="linenos">614</span></a>            
</span><span id="CenterLocator-615"><a href="#CenterLocator-615"><span class="linenos">615</span></a>        <span class="c1"># (3) Calculate xy-limits if we want to see only the central square</span>
</span><span id="CenterLocator-616"><a href="#CenterLocator-616"><span class="linenos">616</span></a>        <span class="c1"># (if csquare argument was given, we will plot only the central square</span>
</span><span id="CenterLocator-617"><a href="#CenterLocator-617"><span class="linenos">617</span></a>        <span class="c1"># (to achieve this, we pre-calculate params for ax.set_xlim/set_ylim</span>
</span><span id="CenterLocator-618"><a href="#CenterLocator-618"><span class="linenos">618</span></a>        <span class="c1"># (the precalculated parameters will be used below during plotting</span>
</span><span id="CenterLocator-619"><a href="#CenterLocator-619"><span class="linenos">619</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-620"><a href="#CenterLocator-620"><span class="linenos">620</span></a>            <span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterLocator-621"><a href="#CenterLocator-621"><span class="linenos">621</span></a>            <span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterLocator-622"><a href="#CenterLocator-622"><span class="linenos">622</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator-623"><a href="#CenterLocator-623"><span class="linenos">623</span></a>            <span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">edge</span>
</span><span id="CenterLocator-624"><a href="#CenterLocator-624"><span class="linenos">624</span></a>            <span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">edge</span>
</span><span id="CenterLocator-625"><a href="#CenterLocator-625"><span class="linenos">625</span></a>            <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">edge</span>
</span><span id="CenterLocator-626"><a href="#CenterLocator-626"><span class="linenos">626</span></a>            <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">edge</span>
</span><span id="CenterLocator-627"><a href="#CenterLocator-627"><span class="linenos">627</span></a>    
</span><span id="CenterLocator-628"><a href="#CenterLocator-628"><span class="linenos">628</span></a>        <span class="c1"># (4) Final plot: show the diffractogram + refinement results</span>
</span><span id="CenterLocator-629"><a href="#CenterLocator-629"><span class="linenos">629</span></a>        <span class="c1"># ...prepare figure</span>
</span><span id="CenterLocator-630"><a href="#CenterLocator-630"><span class="linenos">630</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterLocator-631"><a href="#CenterLocator-631"><span class="linenos">631</span></a>        <span class="c1"># ...show diffraction pattern</span>
</span><span id="CenterLocator-632"><a href="#CenterLocator-632"><span class="linenos">632</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterLocator-633"><a href="#CenterLocator-633"><span class="linenos">633</span></a>        <span class="c1"># ...set the title of the whole figure</span>
</span><span id="CenterLocator-634"><a href="#CenterLocator-634"><span class="linenos">634</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="CenterLocator-635"><a href="#CenterLocator-635"><span class="linenos">635</span></a>            <span class="sa">f</span><span class="s1">&#39;Center Location (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-636"><a href="#CenterLocator-636"><span class="linenos">636</span></a>        <span class="c1"># ...add initial center (after CenterDetermination)</span>
</span><span id="CenterLocator-637"><a href="#CenterLocator-637"><span class="linenos">637</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span>
</span><span id="CenterLocator-638"><a href="#CenterLocator-638"><span class="linenos">638</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labeld</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-639"><a href="#CenterLocator-639"><span class="linenos">639</span></a>        <span class="c1"># ...add initial circle (after CenterDetermination)</span>
</span><span id="CenterLocator-640"><a href="#CenterLocator-640"><span class="linenos">640</span></a>        <span class="n">c0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">r1</span><span class="p">,</span>
</span><span id="CenterLocator-641"><a href="#CenterLocator-641"><span class="linenos">641</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detected&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-642"><a href="#CenterLocator-642"><span class="linenos">642</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>    
</span><span id="CenterLocator-643"><a href="#CenterLocator-643"><span class="linenos">643</span></a>        <span class="c1"># ...add final center coordinates (after CenterRefinement)</span>
</span><span id="CenterLocator-644"><a href="#CenterLocator-644"><span class="linenos">644</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span>
</span><span id="CenterLocator-645"><a href="#CenterLocator-645"><span class="linenos">645</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labelr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;springgreen&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterLocator-646"><a href="#CenterLocator-646"><span class="linenos">646</span></a>        <span class="c1"># ...add final cirlce (after CenterRefinement)</span>
</span><span id="CenterLocator-647"><a href="#CenterLocator-647"><span class="linenos">647</span></a>        <span class="n">c1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span> <span class="n">r2</span><span class="p">,</span>
</span><span id="CenterLocator-648"><a href="#CenterLocator-648"><span class="linenos">648</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;springgreen&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refined&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator-649"><a href="#CenterLocator-649"><span class="linenos">649</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span><span id="CenterLocator-650"><a href="#CenterLocator-650"><span class="linenos">650</span></a>        <span class="c1"># ...move legend to the top right next to the image</span>
</span><span id="CenterLocator-651"><a href="#CenterLocator-651"><span class="linenos">651</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1">#fontsize=10,</span>
</span><span id="CenterLocator-652"><a href="#CenterLocator-652"><span class="linenos">652</span></a>                  <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="n">Circle</span><span class="p">:</span> <span class="n">HandlerCircle</span><span class="p">()},</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CenterLocator-653"><a href="#CenterLocator-653"><span class="linenos">653</span></a>                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.98</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> 
</span><span id="CenterLocator-654"><a href="#CenterLocator-654"><span class="linenos">654</span></a>                  <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="CenterLocator-655"><a href="#CenterLocator-655"><span class="linenos">655</span></a>        <span class="c1"># ...set xlim/ylim if we want to see only the central square</span>
</span><span id="CenterLocator-656"><a href="#CenterLocator-656"><span class="linenos">656</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator-657"><a href="#CenterLocator-657"><span class="linenos">657</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>  <span class="c1"># the xmin/xmax were pre-calculated above</span>
</span><span id="CenterLocator-658"><a href="#CenterLocator-658"><span class="linenos">658</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span>  <span class="c1"># the ymin/ymax were pre-calculated above</span>
</span><span id="CenterLocator-659"><a href="#CenterLocator-659"><span class="linenos">659</span></a>        <span class="c1"># ...do not hide axis decorations = labels, spines, ticks...</span>
</span><span id="CenterLocator-660"><a href="#CenterLocator-660"><span class="linenos">660</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
</span><span id="CenterLocator-661"><a href="#CenterLocator-661"><span class="linenos">661</span></a>        <span class="c1"># ...show the plot</span>
</span><span id="CenterLocator-662"><a href="#CenterLocator-662"><span class="linenos">662</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>CenterLocator object - determine and refine a diffractogram center.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>input_image</strong> (str, path, or numpy.array):
The input image representing a 2D diffraction pattern, either as a 
file path or a NumPy array.</li>
<li><strong>determination</strong> (str or None, optional, default is None):
The method used for the initial center determination.
Options include:
<ul>
<li>'manual': Manual detection - user defines 3 points
on selected diffraction ring.</li>
<li>'hough': Auto-detection - Hough transform for circle detection.</li>
<li>'intensity': Auto-detection - intensity center in central region.</li>
</ul></li>
<li><strong>refinement</strong> (str or None, optional, default is None):
The method used for the final center refinement.
Options include:
<ul>
<li>'manual': Manual adjustment - user adjust the position
of the selected diffration ring.</li>
<li>'sum': Auto-refinement - find a diffraction ring
with maximal sum of intensities.</li>
<li>'var': Auto-refinement - find a diffraction ring
with minimal variance of intensities.</li>
</ul></li>
<li><strong>in_file</strong> (str, optional, default is None):
Filename of the text file
for saving the center coordinates.</li>
<li><strong>out_file</strong> (str, optional, default is None):
Filename of the text file
for loading the previously saved center coordinates.</li>
<li><strong>heq</strong> (bool, optional, default is False):
Flag to indicate whether to perform histogram equalization 
on the input image.
The equalization is done internally,
the image on the screen remains unchanged.</li>
<li><strong>icut</strong> (float, optional, default is None):
Cut-off intensity level for processing the image.</li>
<li><strong>cmap</strong> (str, optional, default is 'gray'):
Colormap to be used for displaying the image.</li>
<li><strong>csquare</strong> (int, optional, default is 50):
Size of the central square,
within which we will search the intensity center.</li>
<li><strong>cintensity</strong> (float, optional, default is 0.8):
Threshold intensity
for finding the intensity center.
Pixels with a (relative) intensity lower than cintensity are ignored.</li>
<li><strong>messages</strong> (bool, optional, default is False):
Flag to enable or disable informational messages during processing.</li>
<li><strong>print_sums</strong> (bool, optional, default is False):
If True, prints the sum of intensity values for the refined circle 
after each adjustment, relevant only for manual methods of center 
determination and refinement.</li>
<li><strong>final_print</strong> (bool, optional, default is True):
If True, print determined and refined coordinates to stdout.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong>: The center coordinates are stored in instance variables
(x1,y1) for the determined center and
(x2,y2) for the refined center.
Look at the initial example at the top of this module
to see how to use CenterLocator class.</li>
</ul>

<h6 id="technical-notes">Technical notes</h6>

<ul>
<li>The class initializes (and runs) two sub-classes (= processes),
CenterDetermination and CenterRefinement.</li>
<li>The two sub-classes/processes are hidden to common user,
altough they could be run separately.</li>
</ul>
</div>


                            <div id="CenterLocator.output" class="classattr">
                                        <input id="CenterLocator.output-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">output</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.output-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.output"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.output-277"><a href="#CenterLocator.output-277"><span class="linenos">277</span></a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator.output-278"><a href="#CenterLocator.output-278"><span class="linenos">278</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.output-279"><a href="#CenterLocator.output-279"><span class="linenos">279</span></a><span class="sd">        Return the final results of center determination and refinement. </span>
</span><span id="CenterLocator.output-280"><a href="#CenterLocator.output-280"><span class="linenos">280</span></a><span class="sd">        </span>
</span><span id="CenterLocator.output-281"><a href="#CenterLocator.output-281"><span class="linenos">281</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.output-282"><a href="#CenterLocator.output-282"><span class="linenos">282</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.output-283"><a href="#CenterLocator.output-283"><span class="linenos">283</span></a><span class="sd">        x1 : float</span>
</span><span id="CenterLocator.output-284"><a href="#CenterLocator.output-284"><span class="linenos">284</span></a><span class="sd">            x-coordinate of the center from *determination* method</span>
</span><span id="CenterLocator.output-285"><a href="#CenterLocator.output-285"><span class="linenos">285</span></a><span class="sd">        y1 : float</span>
</span><span id="CenterLocator.output-286"><a href="#CenterLocator.output-286"><span class="linenos">286</span></a><span class="sd">            y-coordinate of the center from *determination* method</span>
</span><span id="CenterLocator.output-287"><a href="#CenterLocator.output-287"><span class="linenos">287</span></a><span class="sd">        x2 : float</span>
</span><span id="CenterLocator.output-288"><a href="#CenterLocator.output-288"><span class="linenos">288</span></a><span class="sd">            x-coordinate of the center from *refinement* method</span>
</span><span id="CenterLocator.output-289"><a href="#CenterLocator.output-289"><span class="linenos">289</span></a><span class="sd">        y2 : float</span>
</span><span id="CenterLocator.output-290"><a href="#CenterLocator.output-290"><span class="linenos">290</span></a><span class="sd">            y-coordinate of the center from *refinement* method</span>
</span><span id="CenterLocator.output-291"><a href="#CenterLocator.output-291"><span class="linenos">291</span></a><span class="sd">            </span>
</span><span id="CenterLocator.output-292"><a href="#CenterLocator.output-292"><span class="linenos">292</span></a><span class="sd">        Technical note</span>
</span><span id="CenterLocator.output-293"><a href="#CenterLocator.output-293"><span class="linenos">293</span></a><span class="sd">        --------------</span>
</span><span id="CenterLocator.output-294"><a href="#CenterLocator.output-294"><span class="linenos">294</span></a><span class="sd">        * The function always returns four parameters.</span>
</span><span id="CenterLocator.output-295"><a href="#CenterLocator.output-295"><span class="linenos">295</span></a><span class="sd">        * In most cases, the output are four coordinates (x1,y1,x2,y2).</span>
</span><span id="CenterLocator.output-296"><a href="#CenterLocator.output-296"><span class="linenos">296</span></a><span class="sd">        * If the *refinement* method was None, the output is (x1,y1,x1,y1);</span>
</span><span id="CenterLocator.output-297"><a href="#CenterLocator.output-297"><span class="linenos">297</span></a><span class="sd">          i.e. the *determined* and *refined* center coordinates are the same.</span>
</span><span id="CenterLocator.output-298"><a href="#CenterLocator.output-298"><span class="linenos">298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator.output-299"><a href="#CenterLocator.output-299"><span class="linenos">299</span></a>        
</span><span id="CenterLocator.output-300"><a href="#CenterLocator.output-300"><span class="linenos">300</span></a>        <span class="c1"># (1) Refinement method was not None =&gt; prepare (x1,y1,x2,y2)</span>
</span><span id="CenterLocator.output-301"><a href="#CenterLocator.output-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterLocator.output-302"><a href="#CenterLocator.output-302"><span class="linenos">302</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator.output-303"><a href="#CenterLocator.output-303"><span class="linenos">303</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator.output-304"><a href="#CenterLocator.output-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> \
</span><span id="CenterLocator.output-305"><a href="#CenterLocator.output-305"><span class="linenos">305</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> 
</span><span id="CenterLocator.output-306"><a href="#CenterLocator.output-306"><span class="linenos">306</span></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)]</span>
</span><span id="CenterLocator.output-307"><a href="#CenterLocator.output-307"><span class="linenos">307</span></a>        <span class="c1"># (2) Refinement method was None =&gt; prepare (x1,y1) = (x2,y2)                      </span>
</span><span id="CenterLocator.output-308"><a href="#CenterLocator.output-308"><span class="linenos">308</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.output-309"><a href="#CenterLocator.output-309"><span class="linenos">309</span></a>            <span class="c1"># Convert to float</span>
</span><span id="CenterLocator.output-310"><a href="#CenterLocator.output-310"><span class="linenos">310</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterLocator.output-311"><a href="#CenterLocator.output-311"><span class="linenos">311</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> \
</span><span id="CenterLocator.output-312"><a href="#CenterLocator.output-312"><span class="linenos">312</span></a>                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)]</span>
</span><span id="CenterLocator.output-313"><a href="#CenterLocator.output-313"><span class="linenos">313</span></a>            <span class="c1"># Define x2,y2 = x1,y1</span>
</span><span id="CenterLocator.output-314"><a href="#CenterLocator.output-314"><span class="linenos">314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span>
</span><span id="CenterLocator.output-315"><a href="#CenterLocator.output-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span>
</span><span id="CenterLocator.output-316"><a href="#CenterLocator.output-316"><span class="linenos">316</span></a>            
</span><span id="CenterLocator.output-317"><a href="#CenterLocator.output-317"><span class="linenos">317</span></a>        <span class="c1"># (3) Return (rounded) values of center coordinates</span>
</span><span id="CenterLocator.output-318"><a href="#CenterLocator.output-318"><span class="linenos">318</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
</span><span id="CenterLocator.output-319"><a href="#CenterLocator.output-319"><span class="linenos">319</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
</span></pre></div>


            <div class="docstring"><p>Return the final results of center determination and refinement. </p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>x1</strong> (float):
x-coordinate of the center from <em>determination</em> method</li>
<li><strong>y1</strong> (float):
y-coordinate of the center from <em>determination</em> method</li>
<li><strong>x2</strong> (float):
x-coordinate of the center from <em>refinement</em> method</li>
<li><strong>y2</strong> (float):
y-coordinate of the center from <em>refinement</em> method</li>
</ul>

<h6 id="technical-note">Technical note</h6>

<ul>
<li>The function always returns four parameters.</li>
<li>In most cases, the output are four coordinates (x1,y1,x2,y2).</li>
<li>If the <em>refinement</em> method was None, the output is (x1,y1,x1,y1);
i.e. the <em>determined</em> and <em>refined</em> center coordinates are the same.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.save_results" class="classattr">
                                        <input id="CenterLocator.save_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_results</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.save_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.save_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.save_results-322"><a href="#CenterLocator.save_results-322"><span class="linenos">322</span></a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator.save_results-323"><a href="#CenterLocator.save_results-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator.save_results-324"><a href="#CenterLocator.save_results-324"><span class="linenos">324</span></a><span class="sd">        Save the current results to a specified file. The results are formatted </span>
</span><span id="CenterLocator.save_results-325"><a href="#CenterLocator.save_results-325"><span class="linenos">325</span></a><span class="sd">        to four decimal places for clarity.</span>
</span><span id="CenterLocator.save_results-326"><a href="#CenterLocator.save_results-326"><span class="linenos">326</span></a>
</span><span id="CenterLocator.save_results-327"><a href="#CenterLocator.save_results-327"><span class="linenos">327</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-328"><a href="#CenterLocator.save_results-328"><span class="linenos">328</span></a><span class="sd">        This method checks if a file path has been provided through </span>
</span><span id="CenterLocator.save_results-329"><a href="#CenterLocator.save_results-329"><span class="linenos">329</span></a><span class="sd">        the `in_file` attribute. </span>
</span><span id="CenterLocator.save_results-330"><a href="#CenterLocator.save_results-330"><span class="linenos">330</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-331"><a href="#CenterLocator.save_results-331"><span class="linenos">331</span></a><span class="sd">        - If the specified file exists, the method appends the results </span>
</span><span id="CenterLocator.save_results-332"><a href="#CenterLocator.save_results-332"><span class="linenos">332</span></a><span class="sd">        (x1, y1, x2, y2) to the end of the file. </span>
</span><span id="CenterLocator.save_results-333"><a href="#CenterLocator.save_results-333"><span class="linenos">333</span></a><span class="sd">        - If the file does not exist, it creates a new file and writes </span>
</span><span id="CenterLocator.save_results-334"><a href="#CenterLocator.save_results-334"><span class="linenos">334</span></a><span class="sd">        the results to it.</span>
</span><span id="CenterLocator.save_results-335"><a href="#CenterLocator.save_results-335"><span class="linenos">335</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-336"><a href="#CenterLocator.save_results-336"><span class="linenos">336</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-337"><a href="#CenterLocator.save_results-337"><span class="linenos">337</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.save_results-338"><a href="#CenterLocator.save_results-338"><span class="linenos">338</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.save_results-339"><a href="#CenterLocator.save_results-339"><span class="linenos">339</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.save_results-340"><a href="#CenterLocator.save_results-340"><span class="linenos">340</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-341"><a href="#CenterLocator.save_results-341"><span class="linenos">341</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.save_results-342"><a href="#CenterLocator.save_results-342"><span class="linenos">342</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.save_results-343"><a href="#CenterLocator.save_results-343"><span class="linenos">343</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.save_results-344"><a href="#CenterLocator.save_results-344"><span class="linenos">344</span></a><span class="sd">        </span>
</span><span id="CenterLocator.save_results-345"><a href="#CenterLocator.save_results-345"><span class="linenos">345</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator.save_results-346"><a href="#CenterLocator.save_results-346"><span class="linenos">346</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator.save_results-347"><a href="#CenterLocator.save_results-347"><span class="linenos">347</span></a><span class="sd">        - The results are written in the format:</span>
</span><span id="CenterLocator.save_results-348"><a href="#CenterLocator.save_results-348"><span class="linenos">348</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator.save_results-349"><a href="#CenterLocator.save_results-349"><span class="linenos">349</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator.save_results-350"><a href="#CenterLocator.save_results-350"><span class="linenos">350</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.save_results-351"><a href="#CenterLocator.save_results-351"><span class="linenos">351</span></a>        
</span><span id="CenterLocator.save_results-352"><a href="#CenterLocator.save_results-352"><span class="linenos">352</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.save_results-353"><a href="#CenterLocator.save_results-353"><span class="linenos">353</span></a>            <span class="c1"># Check if the specified file exists</span>
</span><span id="CenterLocator.save_results-354"><a href="#CenterLocator.save_results-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">):</span>
</span><span id="CenterLocator.save_results-355"><a href="#CenterLocator.save_results-355"><span class="linenos">355</span></a>                <span class="c1"># Append results to in_file</span>
</span><span id="CenterLocator.save_results-356"><a href="#CenterLocator.save_results-356"><span class="linenos">356</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in append mode</span>
</span><span id="CenterLocator.save_results-357"><a href="#CenterLocator.save_results-357"><span class="linenos">357</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.save_results-358"><a href="#CenterLocator.save_results-358"><span class="linenos">358</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.save_results-359"><a href="#CenterLocator.save_results-359"><span class="linenos">359</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.save_results-360"><a href="#CenterLocator.save_results-360"><span class="linenos">360</span></a>                <span class="c1"># If the file does not exist, create it and write results</span>
</span><span id="CenterLocator.save_results-361"><a href="#CenterLocator.save_results-361"><span class="linenos">361</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Open in write mode</span>
</span><span id="CenterLocator.save_results-362"><a href="#CenterLocator.save_results-362"><span class="linenos">362</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y1: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.save_results-363"><a href="#CenterLocator.save_results-363"><span class="linenos">363</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, y2: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the current results to a specified file. The results are formatted 
to four decimal places for clarity.</p>

<p>This method checks if a file path has been provided through 
the <code>in_file</code> attribute. </p>

<ul>
<li>If the specified file exists, the method appends the results 
(x1, y1, x2, y2) to the end of the file. </li>
<li>If the file does not exist, it creates a new file and writes 
the results to it.</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The results are written in the format:
x1: <value>, y1: <value>
x2: <value>, y2: <value></li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.load_results" class="classattr">
                                        <input id="CenterLocator.load_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_results</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.load_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.load_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.load_results-366"><a href="#CenterLocator.load_results-366"><span class="linenos">366</span></a>    <span class="k">def</span> <span class="nf">load_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CenterLocator.load_results-367"><a href="#CenterLocator.load_results-367"><span class="linenos">367</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator.load_results-368"><a href="#CenterLocator.load_results-368"><span class="linenos">368</span></a><span class="sd">        Load results from a specified text file.</span>
</span><span id="CenterLocator.load_results-369"><a href="#CenterLocator.load_results-369"><span class="linenos">369</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-370"><a href="#CenterLocator.load_results-370"><span class="linenos">370</span></a><span class="sd">        This method reads the coordinates from a text file defined by the </span>
</span><span id="CenterLocator.load_results-371"><a href="#CenterLocator.load_results-371"><span class="linenos">371</span></a><span class="sd">        `out_file` attribute. It extracts pairs of coordinates (x1, y1) and </span>
</span><span id="CenterLocator.load_results-372"><a href="#CenterLocator.load_results-372"><span class="linenos">372</span></a><span class="sd">        (x2, y2) from each line in the file. The extracted values are stored in </span>
</span><span id="CenterLocator.load_results-373"><a href="#CenterLocator.load_results-373"><span class="linenos">373</span></a><span class="sd">        lists, allowing for the retrieval of multiple results.The most recent </span>
</span><span id="CenterLocator.load_results-374"><a href="#CenterLocator.load_results-374"><span class="linenos">374</span></a><span class="sd">        values of x1, y1, x2, and y2 can be stored as instance variables</span>
</span><span id="CenterLocator.load_results-375"><a href="#CenterLocator.load_results-375"><span class="linenos">375</span></a><span class="sd">        for easy access.</span>
</span><span id="CenterLocator.load_results-376"><a href="#CenterLocator.load_results-376"><span class="linenos">376</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-377"><a href="#CenterLocator.load_results-377"><span class="linenos">377</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.load_results-378"><a href="#CenterLocator.load_results-378"><span class="linenos">378</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.load_results-379"><a href="#CenterLocator.load_results-379"><span class="linenos">379</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.load_results-380"><a href="#CenterLocator.load_results-380"><span class="linenos">380</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-381"><a href="#CenterLocator.load_results-381"><span class="linenos">381</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.load_results-382"><a href="#CenterLocator.load_results-382"><span class="linenos">382</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.load_results-383"><a href="#CenterLocator.load_results-383"><span class="linenos">383</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.load_results-384"><a href="#CenterLocator.load_results-384"><span class="linenos">384</span></a><span class="sd">    </span>
</span><span id="CenterLocator.load_results-385"><a href="#CenterLocator.load_results-385"><span class="linenos">385</span></a><span class="sd">        Notes</span>
</span><span id="CenterLocator.load_results-386"><a href="#CenterLocator.load_results-386"><span class="linenos">386</span></a><span class="sd">        -----</span>
</span><span id="CenterLocator.load_results-387"><a href="#CenterLocator.load_results-387"><span class="linenos">387</span></a><span class="sd">        - The results are expected to be in the format:</span>
</span><span id="CenterLocator.load_results-388"><a href="#CenterLocator.load_results-388"><span class="linenos">388</span></a><span class="sd">            x1: &lt;value&gt;, y1: &lt;value&gt;</span>
</span><span id="CenterLocator.load_results-389"><a href="#CenterLocator.load_results-389"><span class="linenos">389</span></a><span class="sd">            x2: &lt;value&gt;, y2: &lt;value&gt;</span>
</span><span id="CenterLocator.load_results-390"><a href="#CenterLocator.load_results-390"><span class="linenos">390</span></a><span class="sd">        - If multiple sets of coordinates are found, they are stored in lists,</span>
</span><span id="CenterLocator.load_results-391"><a href="#CenterLocator.load_results-391"><span class="linenos">391</span></a><span class="sd">        and only the last set can be accessed as instance variables.</span>
</span><span id="CenterLocator.load_results-392"><a href="#CenterLocator.load_results-392"><span class="linenos">392</span></a><span class="sd">        &#39;&#39;&#39;</span>        
</span><span id="CenterLocator.load_results-393"><a href="#CenterLocator.load_results-393"><span class="linenos">393</span></a>        
</span><span id="CenterLocator.load_results-394"><a href="#CenterLocator.load_results-394"><span class="linenos">394</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">):</span>
</span><span id="CenterLocator.load_results-395"><a href="#CenterLocator.load_results-395"><span class="linenos">395</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-396"><a href="#CenterLocator.load_results-396"><span class="linenos">396</span></a>                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span id="CenterLocator.load_results-397"><a href="#CenterLocator.load_results-397"><span class="linenos">397</span></a>                
</span><span id="CenterLocator.load_results-398"><a href="#CenterLocator.load_results-398"><span class="linenos">398</span></a>                <span class="c1"># Initialize lists to hold multiple values</span>
</span><span id="CenterLocator.load_results-399"><a href="#CenterLocator.load_results-399"><span class="linenos">399</span></a>                <span class="n">x1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-400"><a href="#CenterLocator.load_results-400"><span class="linenos">400</span></a>                <span class="n">y1_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-401"><a href="#CenterLocator.load_results-401"><span class="linenos">401</span></a>                <span class="n">x2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-402"><a href="#CenterLocator.load_results-402"><span class="linenos">402</span></a>                <span class="n">y2_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterLocator.load_results-403"><a href="#CenterLocator.load_results-403"><span class="linenos">403</span></a>    
</span><span id="CenterLocator.load_results-404"><a href="#CenterLocator.load_results-404"><span class="linenos">404</span></a>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-405"><a href="#CenterLocator.load_results-405"><span class="linenos">405</span></a>                    <span class="c1"># Strip and split each line to get the coordinates</span>
</span><span id="CenterLocator.load_results-406"><a href="#CenterLocator.load_results-406"><span class="linenos">406</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-407"><a href="#CenterLocator.load_results-407"><span class="linenos">407</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-408"><a href="#CenterLocator.load_results-408"><span class="linenos">408</span></a>                        <span class="c1"># Extract x1 and y1 or x2 and y2 based on line content</span>
</span><span id="CenterLocator.load_results-409"><a href="#CenterLocator.load_results-409"><span class="linenos">409</span></a>                        <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator.load_results-410"><a href="#CenterLocator.load_results-410"><span class="linenos">410</span></a>                            <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-411"><a href="#CenterLocator.load_results-411"><span class="linenos">411</span></a>                            <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-412"><a href="#CenterLocator.load_results-412"><span class="linenos">412</span></a>                            <span class="n">x1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-413"><a href="#CenterLocator.load_results-413"><span class="linenos">413</span></a>                            <span class="n">y1_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-414"><a href="#CenterLocator.load_results-414"><span class="linenos">414</span></a>                        <span class="k">elif</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="CenterLocator.load_results-415"><a href="#CenterLocator.load_results-415"><span class="linenos">415</span></a>                            <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-416"><a href="#CenterLocator.load_results-416"><span class="linenos">416</span></a>                            <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="CenterLocator.load_results-417"><a href="#CenterLocator.load_results-417"><span class="linenos">417</span></a>                            <span class="n">x2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-418"><a href="#CenterLocator.load_results-418"><span class="linenos">418</span></a>                            <span class="n">y2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator.load_results-419"><a href="#CenterLocator.load_results-419"><span class="linenos">419</span></a>    
</span><span id="CenterLocator.load_results-420"><a href="#CenterLocator.load_results-420"><span class="linenos">420</span></a>                <span class="c1"># Store the last set of values as instance variables </span>
</span><span id="CenterLocator.load_results-421"><a href="#CenterLocator.load_results-421"><span class="linenos">421</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span>
</span><span id="CenterLocator.load_results-422"><a href="#CenterLocator.load_results-422"><span class="linenos">422</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span>
</span><span id="CenterLocator.load_results-423"><a href="#CenterLocator.load_results-423"><span class="linenos">423</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span>
</span><span id="CenterLocator.load_results-424"><a href="#CenterLocator.load_results-424"><span class="linenos">424</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span>
</span><span id="CenterLocator.load_results-425"><a href="#CenterLocator.load_results-425"><span class="linenos">425</span></a>    
</span><span id="CenterLocator.load_results-426"><a href="#CenterLocator.load_results-426"><span class="linenos">426</span></a>                <span class="c1"># Store the last loaded values:</span>
</span><span id="CenterLocator.load_results-427"><a href="#CenterLocator.load_results-427"><span class="linenos">427</span></a>                <span class="k">if</span> <span class="n">x1_values</span> <span class="ow">and</span> <span class="n">y1_values</span> <span class="ow">and</span> <span class="n">x2_values</span> <span class="ow">and</span> <span class="n">y2_values</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-428"><a href="#CenterLocator.load_results-428"><span class="linenos">428</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-429"><a href="#CenterLocator.load_results-429"><span class="linenos">429</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-430"><a href="#CenterLocator.load_results-430"><span class="linenos">430</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-431"><a href="#CenterLocator.load_results-431"><span class="linenos">431</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterLocator.load_results-432"><a href="#CenterLocator.load_results-432"><span class="linenos">432</span></a>    
</span><span id="CenterLocator.load_results-433"><a href="#CenterLocator.load_results-433"><span class="linenos">433</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.load_results-434"><a href="#CenterLocator.load_results-434"><span class="linenos">434</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error reading text file with center coordinates!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load results from a specified text file.</p>

<p>This method reads the coordinates from a text file defined by the 
<code>out_file</code> attribute. It extracts pairs of coordinates (x1, y1) and 
(x2, y2) from each line in the file. The extracted values are stored in 
lists, allowing for the retrieval of multiple results.The most recent 
values of x1, y1, x2, and y2 can be stored as instance variables
for easy access.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The results are expected to be in the format:
x1: <value>, y1: <value>
x2: <value>, y2: <value></li>
<li>If multiple sets of coordinates are found, they are stored in lists,
and only the last set can be accessed as instance variables.</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.get_circle_pixels" class="classattr">
                                        <input id="CenterLocator.get_circle_pixels-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_circle_pixels</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">xc</span>, </span><span class="param"><span class="n">yc</span>, </span><span class="param"><span class="n">radius</span>, </span><span class="param"><span class="n">num_points</span><span class="o">=</span><span class="mi">360</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.get_circle_pixels-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.get_circle_pixels"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.get_circle_pixels-437"><a href="#CenterLocator.get_circle_pixels-437"><span class="linenos">437</span></a>    <span class="k">def</span> <span class="nf">get_circle_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
</span><span id="CenterLocator.get_circle_pixels-438"><a href="#CenterLocator.get_circle_pixels-438"><span class="linenos">438</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterLocator.get_circle_pixels-439"><a href="#CenterLocator.get_circle_pixels-439"><span class="linenos">439</span></a><span class="sd">        Get coordinates of pixels defining circle border</span>
</span><span id="CenterLocator.get_circle_pixels-440"><a href="#CenterLocator.get_circle_pixels-440"><span class="linenos">440</span></a><span class="sd">    </span>
</span><span id="CenterLocator.get_circle_pixels-441"><a href="#CenterLocator.get_circle_pixels-441"><span class="linenos">441</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.get_circle_pixels-442"><a href="#CenterLocator.get_circle_pixels-442"><span class="linenos">442</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.get_circle_pixels-443"><a href="#CenterLocator.get_circle_pixels-443"><span class="linenos">443</span></a><span class="sd">        self.image_path : str</span>
</span><span id="CenterLocator.get_circle_pixels-444"><a href="#CenterLocator.get_circle_pixels-444"><span class="linenos">444</span></a><span class="sd">            direct path to a image with diffraction patterns</span>
</span><span id="CenterLocator.get_circle_pixels-445"><a href="#CenterLocator.get_circle_pixels-445"><span class="linenos">445</span></a><span class="sd">        xc : float64</span>
</span><span id="CenterLocator.get_circle_pixels-446"><a href="#CenterLocator.get_circle_pixels-446"><span class="linenos">446</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterLocator.get_circle_pixels-447"><a href="#CenterLocator.get_circle_pixels-447"><span class="linenos">447</span></a><span class="sd">        yc : float64</span>
</span><span id="CenterLocator.get_circle_pixels-448"><a href="#CenterLocator.get_circle_pixels-448"><span class="linenos">448</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterLocator.get_circle_pixels-449"><a href="#CenterLocator.get_circle_pixels-449"><span class="linenos">449</span></a><span class="sd">        radius : float64</span>
</span><span id="CenterLocator.get_circle_pixels-450"><a href="#CenterLocator.get_circle_pixels-450"><span class="linenos">450</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterLocator.get_circle_pixels-451"><a href="#CenterLocator.get_circle_pixels-451"><span class="linenos">451</span></a><span class="sd">        num_points : float64 </span>
</span><span id="CenterLocator.get_circle_pixels-452"><a href="#CenterLocator.get_circle_pixels-452"><span class="linenos">452</span></a><span class="sd">            number of border points. The default is 360</span>
</span><span id="CenterLocator.get_circle_pixels-453"><a href="#CenterLocator.get_circle_pixels-453"><span class="linenos">453</span></a><span class="sd">        </span>
</span><span id="CenterLocator.get_circle_pixels-454"><a href="#CenterLocator.get_circle_pixels-454"><span class="linenos">454</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.get_circle_pixels-455"><a href="#CenterLocator.get_circle_pixels-455"><span class="linenos">455</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.get_circle_pixels-456"><a href="#CenterLocator.get_circle_pixels-456"><span class="linenos">456</span></a><span class="sd">        x : array of float64</span>
</span><span id="CenterLocator.get_circle_pixels-457"><a href="#CenterLocator.get_circle_pixels-457"><span class="linenos">457</span></a><span class="sd">            x-coordinates of pixels from circle border</span>
</span><span id="CenterLocator.get_circle_pixels-458"><a href="#CenterLocator.get_circle_pixels-458"><span class="linenos">458</span></a><span class="sd">        y : array of float64</span>
</span><span id="CenterLocator.get_circle_pixels-459"><a href="#CenterLocator.get_circle_pixels-459"><span class="linenos">459</span></a><span class="sd">            y-coordinates of pixels from circle border</span>
</span><span id="CenterLocator.get_circle_pixels-460"><a href="#CenterLocator.get_circle_pixels-460"><span class="linenos">460</span></a><span class="sd">            </span>
</span><span id="CenterLocator.get_circle_pixels-461"><a href="#CenterLocator.get_circle_pixels-461"><span class="linenos">461</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.get_circle_pixels-462"><a href="#CenterLocator.get_circle_pixels-462"><span class="linenos">462</span></a>        
</span><span id="CenterLocator.get_circle_pixels-463"><a href="#CenterLocator.get_circle_pixels-463"><span class="linenos">463</span></a>        <span class="c1"># Generate angles from 0 to 2*pi</span>
</span><span id="CenterLocator.get_circle_pixels-464"><a href="#CenterLocator.get_circle_pixels-464"><span class="linenos">464</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num_points</span><span class="p">)</span>  
</span><span id="CenterLocator.get_circle_pixels-465"><a href="#CenterLocator.get_circle_pixels-465"><span class="linenos">465</span></a>                
</span><span id="CenterLocator.get_circle_pixels-466"><a href="#CenterLocator.get_circle_pixels-466"><span class="linenos">466</span></a>        <span class="c1"># Calculate x,y-coordinates of points on the actual circle border</span>
</span><span id="CenterLocator.get_circle_pixels-467"><a href="#CenterLocator.get_circle_pixels-467"><span class="linenos">467</span></a>        <span class="n">x_actual</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="CenterLocator.get_circle_pixels-468"><a href="#CenterLocator.get_circle_pixels-468"><span class="linenos">468</span></a>        <span class="n">y_actual</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="CenterLocator.get_circle_pixels-469"><a href="#CenterLocator.get_circle_pixels-469"><span class="linenos">469</span></a>        
</span><span id="CenterLocator.get_circle_pixels-470"><a href="#CenterLocator.get_circle_pixels-470"><span class="linenos">470</span></a>        <span class="k">return</span> <span class="n">x_actual</span><span class="p">,</span> <span class="n">y_actual</span>
</span></pre></div>


            <div class="docstring"><p>Get coordinates of pixels defining circle border</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>self.image_path</strong> (str):
direct path to a image with diffraction patterns</li>
<li><strong>xc</strong> (float64):
x-coordinate of the detected center</li>
<li><strong>yc</strong> (float64):
y-coordinate of the detected center</li>
<li><strong>radius</strong> (float64):
radius of the detected center</li>
<li><strong>num_points</strong> (float64):
number of border points. The default is 360</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>x</strong> (array of float64):
x-coordinates of pixels from circle border</li>
<li><strong>y</strong> (array of float64):
y-coordinates of pixels from circle border</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.intensity_sum" class="classattr">
                                        <input id="CenterLocator.intensity_sum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">intensity_sum</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.intensity_sum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.intensity_sum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.intensity_sum-473"><a href="#CenterLocator.intensity_sum-473"><span class="linenos">473</span></a>    <span class="k">def</span> <span class="nf">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterLocator.intensity_sum-474"><a href="#CenterLocator.intensity_sum-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterLocator.intensity_sum-475"><a href="#CenterLocator.intensity_sum-475"><span class="linenos">475</span></a><span class="sd">        Summation of intensity values of pixels of a diffraction pattern.</span>
</span><span id="CenterLocator.intensity_sum-476"><a href="#CenterLocator.intensity_sum-476"><span class="linenos">476</span></a>
</span><span id="CenterLocator.intensity_sum-477"><a href="#CenterLocator.intensity_sum-477"><span class="linenos">477</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.intensity_sum-478"><a href="#CenterLocator.intensity_sum-478"><span class="linenos">478</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.intensity_sum-479"><a href="#CenterLocator.intensity_sum-479"><span class="linenos">479</span></a><span class="sd">        image : array of uint8</span>
</span><span id="CenterLocator.intensity_sum-480"><a href="#CenterLocator.intensity_sum-480"><span class="linenos">480</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="CenterLocator.intensity_sum-481"><a href="#CenterLocator.intensity_sum-481"><span class="linenos">481</span></a><span class="sd">        px : float64</span>
</span><span id="CenterLocator.intensity_sum-482"><a href="#CenterLocator.intensity_sum-482"><span class="linenos">482</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_sum-483"><a href="#CenterLocator.intensity_sum-483"><span class="linenos">483</span></a><span class="sd">        py : float64</span>
</span><span id="CenterLocator.intensity_sum-484"><a href="#CenterLocator.intensity_sum-484"><span class="linenos">484</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_sum-485"><a href="#CenterLocator.intensity_sum-485"><span class="linenos">485</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterLocator.intensity_sum-486"><a href="#CenterLocator.intensity_sum-486"><span class="linenos">486</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_sum-487"><a href="#CenterLocator.intensity_sum-487"><span class="linenos">487</span></a>
</span><span id="CenterLocator.intensity_sum-488"><a href="#CenterLocator.intensity_sum-488"><span class="linenos">488</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.intensity_sum-489"><a href="#CenterLocator.intensity_sum-489"><span class="linenos">489</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.intensity_sum-490"><a href="#CenterLocator.intensity_sum-490"><span class="linenos">490</span></a><span class="sd">        s : float64</span>
</span><span id="CenterLocator.intensity_sum-491"><a href="#CenterLocator.intensity_sum-491"><span class="linenos">491</span></a><span class="sd">            intensity sum</span>
</span><span id="CenterLocator.intensity_sum-492"><a href="#CenterLocator.intensity_sum-492"><span class="linenos">492</span></a>
</span><span id="CenterLocator.intensity_sum-493"><a href="#CenterLocator.intensity_sum-493"><span class="linenos">493</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.intensity_sum-494"><a href="#CenterLocator.intensity_sum-494"><span class="linenos">494</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="CenterLocator.intensity_sum-495"><a href="#CenterLocator.intensity_sum-495"><span class="linenos">495</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_sum-496"><a href="#CenterLocator.intensity_sum-496"><span class="linenos">496</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_sum-497"><a href="#CenterLocator.intensity_sum-497"><span class="linenos">497</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_sum-498"><a href="#CenterLocator.intensity_sum-498"><span class="linenos">498</span></a>        
</span><span id="CenterLocator.intensity_sum-499"><a href="#CenterLocator.intensity_sum-499"><span class="linenos">499</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="CenterLocator.intensity_sum-500"><a href="#CenterLocator.intensity_sum-500"><span class="linenos">500</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pyc</span><span class="p">,</span> <span class="n">pxc</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">pxc</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_sum-501"><a href="#CenterLocator.intensity_sum-501"><span class="linenos">501</span></a>
</span><span id="CenterLocator.intensity_sum-502"><a href="#CenterLocator.intensity_sum-502"><span class="linenos">502</span></a>        <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Summation of intensity values of pixels of a diffraction pattern.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>image</strong> (array of uint8):
image from which the diffraction pattern has been detected.</li>
<li><strong>px</strong> (float64):
x-coordinate of the center of the diffraction pattern.</li>
<li><strong>py</strong> (float64):
y-coordinate of the center of the diffraction pattern.</li>
<li><strong>pr</strong> (float64):
radius of the diffraction pattern.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s</strong> (float64):
intensity sum</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.intensity_variance" class="classattr">
                                        <input id="CenterLocator.intensity_variance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">intensity_variance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.intensity_variance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.intensity_variance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.intensity_variance-505"><a href="#CenterLocator.intensity_variance-505"><span class="linenos">505</span></a>    <span class="k">def</span> <span class="nf">intensity_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterLocator.intensity_variance-506"><a href="#CenterLocator.intensity_variance-506"><span class="linenos">506</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterLocator.intensity_variance-507"><a href="#CenterLocator.intensity_variance-507"><span class="linenos">507</span></a><span class="sd">        Variance of intensity values of pixels of a diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-508"><a href="#CenterLocator.intensity_variance-508"><span class="linenos">508</span></a>
</span><span id="CenterLocator.intensity_variance-509"><a href="#CenterLocator.intensity_variance-509"><span class="linenos">509</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.intensity_variance-510"><a href="#CenterLocator.intensity_variance-510"><span class="linenos">510</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.intensity_variance-511"><a href="#CenterLocator.intensity_variance-511"><span class="linenos">511</span></a><span class="sd">        image : array of uint8</span>
</span><span id="CenterLocator.intensity_variance-512"><a href="#CenterLocator.intensity_variance-512"><span class="linenos">512</span></a><span class="sd">            image from which the diffraction pattern has been detected.</span>
</span><span id="CenterLocator.intensity_variance-513"><a href="#CenterLocator.intensity_variance-513"><span class="linenos">513</span></a><span class="sd">        px : float64</span>
</span><span id="CenterLocator.intensity_variance-514"><a href="#CenterLocator.intensity_variance-514"><span class="linenos">514</span></a><span class="sd">            x-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-515"><a href="#CenterLocator.intensity_variance-515"><span class="linenos">515</span></a><span class="sd">        py : float64</span>
</span><span id="CenterLocator.intensity_variance-516"><a href="#CenterLocator.intensity_variance-516"><span class="linenos">516</span></a><span class="sd">            y-coordinate of the center of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-517"><a href="#CenterLocator.intensity_variance-517"><span class="linenos">517</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterLocator.intensity_variance-518"><a href="#CenterLocator.intensity_variance-518"><span class="linenos">518</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterLocator.intensity_variance-519"><a href="#CenterLocator.intensity_variance-519"><span class="linenos">519</span></a>
</span><span id="CenterLocator.intensity_variance-520"><a href="#CenterLocator.intensity_variance-520"><span class="linenos">520</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.intensity_variance-521"><a href="#CenterLocator.intensity_variance-521"><span class="linenos">521</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.intensity_variance-522"><a href="#CenterLocator.intensity_variance-522"><span class="linenos">522</span></a><span class="sd">        s : float64</span>
</span><span id="CenterLocator.intensity_variance-523"><a href="#CenterLocator.intensity_variance-523"><span class="linenos">523</span></a><span class="sd">            intensity variance</span>
</span><span id="CenterLocator.intensity_variance-524"><a href="#CenterLocator.intensity_variance-524"><span class="linenos">524</span></a>
</span><span id="CenterLocator.intensity_variance-525"><a href="#CenterLocator.intensity_variance-525"><span class="linenos">525</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.intensity_variance-526"><a href="#CenterLocator.intensity_variance-526"><span class="linenos">526</span></a>        <span class="c1"># Extract pixels on the circle border</span>
</span><span id="CenterLocator.intensity_variance-527"><a href="#CenterLocator.intensity_variance-527"><span class="linenos">527</span></a>        <span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circle_pixels</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_variance-528"><a href="#CenterLocator.intensity_variance-528"><span class="linenos">528</span></a>        <span class="n">pxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_variance-529"><a href="#CenterLocator.intensity_variance-529"><span class="linenos">529</span></a>        <span class="n">pyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="CenterLocator.intensity_variance-530"><a href="#CenterLocator.intensity_variance-530"><span class="linenos">530</span></a>        
</span><span id="CenterLocator.intensity_variance-531"><a href="#CenterLocator.intensity_variance-531"><span class="linenos">531</span></a>        <span class="c1"># Calculate sum using the filtered values</span>
</span><span id="CenterLocator.intensity_variance-532"><a href="#CenterLocator.intensity_variance-532"><span class="linenos">532</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">pxc</span><span class="p">,</span> <span class="n">pyc</span><span class="p">])</span>
</span><span id="CenterLocator.intensity_variance-533"><a href="#CenterLocator.intensity_variance-533"><span class="linenos">533</span></a>        <span class="k">return</span> <span class="n">s</span>
</span></pre></div>


            <div class="docstring"><p>Variance of intensity values of pixels of a diffraction pattern.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>image</strong> (array of uint8):
image from which the diffraction pattern has been detected.</li>
<li><strong>px</strong> (float64):
x-coordinate of the center of the diffraction pattern.</li>
<li><strong>py</strong> (float64):
y-coordinate of the center of the diffraction pattern.</li>
<li><strong>pr</strong> (float64):
radius of the diffraction pattern.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>s</strong> (float64):
intensity variance</li>
</ul>
</div>


                            </div>
                            <div id="CenterLocator.convert_coords" class="classattr">
                                        <input id="CenterLocator.convert_coords-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_coords</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.convert_coords-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.convert_coords"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.convert_coords-536"><a href="#CenterLocator.convert_coords-536"><span class="linenos">536</span></a>    <span class="k">def</span> <span class="nf">convert_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="CenterLocator.convert_coords-537"><a href="#CenterLocator.convert_coords-537"><span class="linenos">537</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterLocator.convert_coords-538"><a href="#CenterLocator.convert_coords-538"><span class="linenos">538</span></a><span class="sd">        Convert coordinates between numpy and matplotlib systems.</span>
</span><span id="CenterLocator.convert_coords-539"><a href="#CenterLocator.convert_coords-539"><span class="linenos">539</span></a><span class="sd">    </span>
</span><span id="CenterLocator.convert_coords-540"><a href="#CenterLocator.convert_coords-540"><span class="linenos">540</span></a><span class="sd">        Parameters:</span>
</span><span id="CenterLocator.convert_coords-541"><a href="#CenterLocator.convert_coords-541"><span class="linenos">541</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.convert_coords-542"><a href="#CenterLocator.convert_coords-542"><span class="linenos">542</span></a><span class="sd">        x : int or float</span>
</span><span id="CenterLocator.convert_coords-543"><a href="#CenterLocator.convert_coords-543"><span class="linenos">543</span></a><span class="sd">            The x-coordinate in the numpy (column index) format.</span>
</span><span id="CenterLocator.convert_coords-544"><a href="#CenterLocator.convert_coords-544"><span class="linenos">544</span></a><span class="sd">        y : int or float</span>
</span><span id="CenterLocator.convert_coords-545"><a href="#CenterLocator.convert_coords-545"><span class="linenos">545</span></a><span class="sd">            The y-coordinate in the numpy (row index) format.</span>
</span><span id="CenterLocator.convert_coords-546"><a href="#CenterLocator.convert_coords-546"><span class="linenos">546</span></a><span class="sd">    </span>
</span><span id="CenterLocator.convert_coords-547"><a href="#CenterLocator.convert_coords-547"><span class="linenos">547</span></a><span class="sd">        Returns:</span>
</span><span id="CenterLocator.convert_coords-548"><a href="#CenterLocator.convert_coords-548"><span class="linenos">548</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.convert_coords-549"><a href="#CenterLocator.convert_coords-549"><span class="linenos">549</span></a><span class="sd">        tuple of (int or float, int or float)</span>
</span><span id="CenterLocator.convert_coords-550"><a href="#CenterLocator.convert_coords-550"><span class="linenos">550</span></a><span class="sd">            The converted coordinates in matplotlib format, where:</span>
</span><span id="CenterLocator.convert_coords-551"><a href="#CenterLocator.convert_coords-551"><span class="linenos">551</span></a><span class="sd">            - First element corresponds to y (new x in matplotlib).</span>
</span><span id="CenterLocator.convert_coords-552"><a href="#CenterLocator.convert_coords-552"><span class="linenos">552</span></a><span class="sd">            - Second element corresponds to x (new y in matplotlib).</span>
</span><span id="CenterLocator.convert_coords-553"><a href="#CenterLocator.convert_coords-553"><span class="linenos">553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterLocator.convert_coords-554"><a href="#CenterLocator.convert_coords-554"><span class="linenos">554</span></a>        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Convert coordinates between numpy and matplotlib systems.</p>

<h2 id="parameters">Parameters:</h2>

<p>x : int or float
    The x-coordinate in the numpy (column index) format.
y : int or float
    The y-coordinate in the numpy (row index) format.</p>

<h2 id="returns">Returns:</h2>

<p>tuple of (int or float, int or float)
    The converted coordinates in matplotlib format, where:
    - First element corresponds to y (new x in matplotlib).
    - Second element corresponds to x (new y in matplotlib).</p>
</div>


                            </div>
                            <div id="CenterLocator.visualize_results" class="classattr">
                                        <input id="CenterLocator.visualize_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_results</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csquare</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterLocator.visualize_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterLocator.visualize_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterLocator.visualize_results-557"><a href="#CenterLocator.visualize_results-557"><span class="linenos">557</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CenterLocator.visualize_results-558"><a href="#CenterLocator.visualize_results-558"><span class="linenos">558</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterLocator.visualize_results-559"><a href="#CenterLocator.visualize_results-559"><span class="linenos">559</span></a><span class="sd">        Visualize diffractogram and its center after</span>
</span><span id="CenterLocator.visualize_results-560"><a href="#CenterLocator.visualize_results-560"><span class="linenos">560</span></a><span class="sd">        center determination + refinement.</span>
</span><span id="CenterLocator.visualize_results-561"><a href="#CenterLocator.visualize_results-561"><span class="linenos">561</span></a><span class="sd">    </span>
</span><span id="CenterLocator.visualize_results-562"><a href="#CenterLocator.visualize_results-562"><span class="linenos">562</span></a><span class="sd">        Parameters</span>
</span><span id="CenterLocator.visualize_results-563"><a href="#CenterLocator.visualize_results-563"><span class="linenos">563</span></a><span class="sd">        ----------</span>
</span><span id="CenterLocator.visualize_results-564"><a href="#CenterLocator.visualize_results-564"><span class="linenos">564</span></a><span class="sd">        csquare : int, optional, default is None</span>
</span><span id="CenterLocator.visualize_results-565"><a href="#CenterLocator.visualize_results-565"><span class="linenos">565</span></a><span class="sd">            If csquare argument is given,</span>
</span><span id="CenterLocator.visualize_results-566"><a href="#CenterLocator.visualize_results-566"><span class="linenos">566</span></a><span class="sd">            only the central square of the diffractogram will be plotted;</span>
</span><span id="CenterLocator.visualize_results-567"><a href="#CenterLocator.visualize_results-567"><span class="linenos">567</span></a><span class="sd">            the size of the central square will be equal to csquare argument.</span>
</span><span id="CenterLocator.visualize_results-568"><a href="#CenterLocator.visualize_results-568"><span class="linenos">568</span></a><span class="sd">    </span>
</span><span id="CenterLocator.visualize_results-569"><a href="#CenterLocator.visualize_results-569"><span class="linenos">569</span></a><span class="sd">        Returns</span>
</span><span id="CenterLocator.visualize_results-570"><a href="#CenterLocator.visualize_results-570"><span class="linenos">570</span></a><span class="sd">        -------</span>
</span><span id="CenterLocator.visualize_results-571"><a href="#CenterLocator.visualize_results-571"><span class="linenos">571</span></a><span class="sd">        None</span>
</span><span id="CenterLocator.visualize_results-572"><a href="#CenterLocator.visualize_results-572"><span class="linenos">572</span></a><span class="sd">            The output is the image of the diffractogram</span>
</span><span id="CenterLocator.visualize_results-573"><a href="#CenterLocator.visualize_results-573"><span class="linenos">573</span></a><span class="sd">            showing also the central coordinates and refinement ring.</span>
</span><span id="CenterLocator.visualize_results-574"><a href="#CenterLocator.visualize_results-574"><span class="linenos">574</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterLocator.visualize_results-575"><a href="#CenterLocator.visualize_results-575"><span class="linenos">575</span></a>        
</span><span id="CenterLocator.visualize_results-576"><a href="#CenterLocator.visualize_results-576"><span class="linenos">576</span></a>        <span class="c1"># (0) Collect center coordinates and radii</span>
</span><span id="CenterLocator.visualize_results-577"><a href="#CenterLocator.visualize_results-577"><span class="linenos">577</span></a>        <span class="c1"># x1,y1,r1 = coordinates and radius of the determined circle/ring</span>
</span><span id="CenterLocator.visualize_results-578"><a href="#CenterLocator.visualize_results-578"><span class="linenos">578</span></a>        <span class="c1"># x2,y2,r2 = coordinates and radius of the refined circle/ring</span>
</span><span id="CenterLocator.visualize_results-579"><a href="#CenterLocator.visualize_results-579"><span class="linenos">579</span></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-580"><a href="#CenterLocator.visualize_results-580"><span class="linenos">580</span></a>        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center1</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterLocator.visualize_results-581"><a href="#CenterLocator.visualize_results-581"><span class="linenos">581</span></a>        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-582"><a href="#CenterLocator.visualize_results-582"><span class="linenos">582</span></a>        <span class="n">r2</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center2</span><span class="o">.</span><span class="n">rr</span>
</span><span id="CenterLocator.visualize_results-583"><a href="#CenterLocator.visualize_results-583"><span class="linenos">583</span></a>        
</span><span id="CenterLocator.visualize_results-584"><a href="#CenterLocator.visualize_results-584"><span class="linenos">584</span></a>        <span class="c1"># (1) Prepare the image of the diffractogram</span>
</span><span id="CenterLocator.visualize_results-585"><a href="#CenterLocator.visualize_results-585"><span class="linenos">585</span></a>        <span class="c1"># ...copy diffractogram image</span>
</span><span id="CenterLocator.visualize_results-586"><a href="#CenterLocator.visualize_results-586"><span class="linenos">586</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-587"><a href="#CenterLocator.visualize_results-587"><span class="linenos">587</span></a>        <span class="c1"># ...cut image intensity if required</span>
</span><span id="CenterLocator.visualize_results-588"><a href="#CenterLocator.visualize_results-588"><span class="linenos">588</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-589"><a href="#CenterLocator.visualize_results-589"><span class="linenos">589</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-590"><a href="#CenterLocator.visualize_results-590"><span class="linenos">590</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-591"><a href="#CenterLocator.visualize_results-591"><span class="linenos">591</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-592"><a href="#CenterLocator.visualize_results-592"><span class="linenos">592</span></a>            
</span><span id="CenterLocator.visualize_results-593"><a href="#CenterLocator.visualize_results-593"><span class="linenos">593</span></a>        <span class="c1"># (2) Calculate intensity sum or intensity variance</span>
</span><span id="CenterLocator.visualize_results-594"><a href="#CenterLocator.visualize_results-594"><span class="linenos">594</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-595"><a href="#CenterLocator.visualize_results-595"><span class="linenos">595</span></a>            <span class="c1"># Refinement was based on minimizing the intensity variance</span>
</span><span id="CenterLocator.visualize_results-596"><a href="#CenterLocator.visualize_results-596"><span class="linenos">596</span></a>            <span class="n">dvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-597"><a href="#CenterLocator.visualize_results-597"><span class="linenos">597</span></a>            <span class="n">rvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-598"><a href="#CenterLocator.visualize_results-598"><span class="linenos">598</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator.visualize_results-599"><a href="#CenterLocator.visualize_results-599"><span class="linenos">599</span></a>                <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator.visualize_results-600"><a href="#CenterLocator.visualize_results-600"><span class="linenos">600</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-var: </span><span class="si">{</span><span class="n">dvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-601"><a href="#CenterLocator.visualize_results-601"><span class="linenos">601</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator.visualize_results-602"><a href="#CenterLocator.visualize_results-602"><span class="linenos">602</span></a>                <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator.visualize_results-603"><a href="#CenterLocator.visualize_results-603"><span class="linenos">603</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-var: </span><span class="si">{</span><span class="n">rvar</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-604"><a href="#CenterLocator.visualize_results-604"><span class="linenos">604</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-605"><a href="#CenterLocator.visualize_results-605"><span class="linenos">605</span></a>            <span class="c1"># All other cases: manual refinement or maximixing intensity sum</span>
</span><span id="CenterLocator.visualize_results-606"><a href="#CenterLocator.visualize_results-606"><span class="linenos">606</span></a>            <span class="n">dsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-607"><a href="#CenterLocator.visualize_results-607"><span class="linenos">607</span></a>            <span class="n">rsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-608"><a href="#CenterLocator.visualize_results-608"><span class="linenos">608</span></a>            <span class="n">labeld</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator.visualize_results-609"><a href="#CenterLocator.visualize_results-609"><span class="linenos">609</span></a>                <span class="sa">f</span><span class="s1">&#39;d-center: [</span><span class="si">{</span><span class="n">x1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator.visualize_results-610"><a href="#CenterLocator.visualize_results-610"><span class="linenos">610</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-sum: </span><span class="si">{</span><span class="n">dsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-611"><a href="#CenterLocator.visualize_results-611"><span class="linenos">611</span></a>            <span class="n">labelr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterLocator.visualize_results-612"><a href="#CenterLocator.visualize_results-612"><span class="linenos">612</span></a>                <span class="sa">f</span><span class="s1">&#39;r-center: [</span><span class="si">{</span><span class="n">x2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span>
</span><span id="CenterLocator.visualize_results-613"><a href="#CenterLocator.visualize_results-613"><span class="linenos">613</span></a>                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;int-sum: </span><span class="si">{</span><span class="n">rsum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-614"><a href="#CenterLocator.visualize_results-614"><span class="linenos">614</span></a>            
</span><span id="CenterLocator.visualize_results-615"><a href="#CenterLocator.visualize_results-615"><span class="linenos">615</span></a>        <span class="c1"># (3) Calculate xy-limits if we want to see only the central square</span>
</span><span id="CenterLocator.visualize_results-616"><a href="#CenterLocator.visualize_results-616"><span class="linenos">616</span></a>        <span class="c1"># (if csquare argument was given, we will plot only the central square</span>
</span><span id="CenterLocator.visualize_results-617"><a href="#CenterLocator.visualize_results-617"><span class="linenos">617</span></a>        <span class="c1"># (to achieve this, we pre-calculate params for ax.set_xlim/set_ylim</span>
</span><span id="CenterLocator.visualize_results-618"><a href="#CenterLocator.visualize_results-618"><span class="linenos">618</span></a>        <span class="c1"># (the precalculated parameters will be used below during plotting</span>
</span><span id="CenterLocator.visualize_results-619"><a href="#CenterLocator.visualize_results-619"><span class="linenos">619</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-620"><a href="#CenterLocator.visualize_results-620"><span class="linenos">620</span></a>            <span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterLocator.visualize_results-621"><a href="#CenterLocator.visualize_results-621"><span class="linenos">621</span></a>            <span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterLocator.visualize_results-622"><a href="#CenterLocator.visualize_results-622"><span class="linenos">622</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterLocator.visualize_results-623"><a href="#CenterLocator.visualize_results-623"><span class="linenos">623</span></a>            <span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-624"><a href="#CenterLocator.visualize_results-624"><span class="linenos">624</span></a>            <span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-625"><a href="#CenterLocator.visualize_results-625"><span class="linenos">625</span></a>            <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-626"><a href="#CenterLocator.visualize_results-626"><span class="linenos">626</span></a>            <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">edge</span>
</span><span id="CenterLocator.visualize_results-627"><a href="#CenterLocator.visualize_results-627"><span class="linenos">627</span></a>    
</span><span id="CenterLocator.visualize_results-628"><a href="#CenterLocator.visualize_results-628"><span class="linenos">628</span></a>        <span class="c1"># (4) Final plot: show the diffractogram + refinement results</span>
</span><span id="CenterLocator.visualize_results-629"><a href="#CenterLocator.visualize_results-629"><span class="linenos">629</span></a>        <span class="c1"># ...prepare figure</span>
</span><span id="CenterLocator.visualize_results-630"><a href="#CenterLocator.visualize_results-630"><span class="linenos">630</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterLocator.visualize_results-631"><a href="#CenterLocator.visualize_results-631"><span class="linenos">631</span></a>        <span class="c1"># ...show diffraction pattern</span>
</span><span id="CenterLocator.visualize_results-632"><a href="#CenterLocator.visualize_results-632"><span class="linenos">632</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-633"><a href="#CenterLocator.visualize_results-633"><span class="linenos">633</span></a>        <span class="c1"># ...set the title of the whole figure</span>
</span><span id="CenterLocator.visualize_results-634"><a href="#CenterLocator.visualize_results-634"><span class="linenos">634</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
</span><span id="CenterLocator.visualize_results-635"><a href="#CenterLocator.visualize_results-635"><span class="linenos">635</span></a>            <span class="sa">f</span><span class="s1">&#39;Center Location (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">determination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refinement</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-636"><a href="#CenterLocator.visualize_results-636"><span class="linenos">636</span></a>        <span class="c1"># ...add initial center (after CenterDetermination)</span>
</span><span id="CenterLocator.visualize_results-637"><a href="#CenterLocator.visualize_results-637"><span class="linenos">637</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span>
</span><span id="CenterLocator.visualize_results-638"><a href="#CenterLocator.visualize_results-638"><span class="linenos">638</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labeld</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-639"><a href="#CenterLocator.visualize_results-639"><span class="linenos">639</span></a>        <span class="c1"># ...add initial circle (after CenterDetermination)</span>
</span><span id="CenterLocator.visualize_results-640"><a href="#CenterLocator.visualize_results-640"><span class="linenos">640</span></a>        <span class="n">c0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">r1</span><span class="p">,</span>
</span><span id="CenterLocator.visualize_results-641"><a href="#CenterLocator.visualize_results-641"><span class="linenos">641</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detected&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-642"><a href="#CenterLocator.visualize_results-642"><span class="linenos">642</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>    
</span><span id="CenterLocator.visualize_results-643"><a href="#CenterLocator.visualize_results-643"><span class="linenos">643</span></a>        <span class="c1"># ...add final center coordinates (after CenterRefinement)</span>
</span><span id="CenterLocator.visualize_results-644"><a href="#CenterLocator.visualize_results-644"><span class="linenos">644</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span>
</span><span id="CenterLocator.visualize_results-645"><a href="#CenterLocator.visualize_results-645"><span class="linenos">645</span></a>                   <span class="n">label</span><span class="o">=</span><span class="n">labelr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;springgreen&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-646"><a href="#CenterLocator.visualize_results-646"><span class="linenos">646</span></a>        <span class="c1"># ...add final cirlce (after CenterRefinement)</span>
</span><span id="CenterLocator.visualize_results-647"><a href="#CenterLocator.visualize_results-647"><span class="linenos">647</span></a>        <span class="n">c1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span> <span class="n">r2</span><span class="p">,</span>
</span><span id="CenterLocator.visualize_results-648"><a href="#CenterLocator.visualize_results-648"><span class="linenos">648</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;springgreen&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refined&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-649"><a href="#CenterLocator.visualize_results-649"><span class="linenos">649</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-650"><a href="#CenterLocator.visualize_results-650"><span class="linenos">650</span></a>        <span class="c1"># ...move legend to the top right next to the image</span>
</span><span id="CenterLocator.visualize_results-651"><a href="#CenterLocator.visualize_results-651"><span class="linenos">651</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1">#fontsize=10,</span>
</span><span id="CenterLocator.visualize_results-652"><a href="#CenterLocator.visualize_results-652"><span class="linenos">652</span></a>                  <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="n">Circle</span><span class="p">:</span> <span class="n">HandlerCircle</span><span class="p">()},</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="CenterLocator.visualize_results-653"><a href="#CenterLocator.visualize_results-653"><span class="linenos">653</span></a>                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.98</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> 
</span><span id="CenterLocator.visualize_results-654"><a href="#CenterLocator.visualize_results-654"><span class="linenos">654</span></a>                  <span class="n">bbox_transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-655"><a href="#CenterLocator.visualize_results-655"><span class="linenos">655</span></a>        <span class="c1"># ...set xlim/ylim if we want to see only the central square</span>
</span><span id="CenterLocator.visualize_results-656"><a href="#CenterLocator.visualize_results-656"><span class="linenos">656</span></a>        <span class="k">if</span> <span class="n">csquare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterLocator.visualize_results-657"><a href="#CenterLocator.visualize_results-657"><span class="linenos">657</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>  <span class="c1"># the xmin/xmax were pre-calculated above</span>
</span><span id="CenterLocator.visualize_results-658"><a href="#CenterLocator.visualize_results-658"><span class="linenos">658</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span>  <span class="c1"># the ymin/ymax were pre-calculated above</span>
</span><span id="CenterLocator.visualize_results-659"><a href="#CenterLocator.visualize_results-659"><span class="linenos">659</span></a>        <span class="c1"># ...do not hide axis decorations = labels, spines, ticks...</span>
</span><span id="CenterLocator.visualize_results-660"><a href="#CenterLocator.visualize_results-660"><span class="linenos">660</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
</span><span id="CenterLocator.visualize_results-661"><a href="#CenterLocator.visualize_results-661"><span class="linenos">661</span></a>        <span class="c1"># ...show the plot</span>
</span><span id="CenterLocator.visualize_results-662"><a href="#CenterLocator.visualize_results-662"><span class="linenos">662</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize diffractogram and its center after
center determination + refinement.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>csquare</strong> (int, optional, default is None):
If csquare argument is given,
only the central square of the diffractogram will be plotted;
the size of the central square will be equal to csquare argument.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong>: The output is the image of the diffractogram
showing also the central coordinates and refinement ring.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="CenterDetermination">
                            <input id="CenterDetermination-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CenterDetermination</span>:

                <label class="view-source-button" for="CenterDetermination-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination-666"><a href="#CenterDetermination-666"><span class="linenos"> 666</span></a><span class="k">class</span> <span class="nc">CenterDetermination</span><span class="p">:</span>
</span><span id="CenterDetermination-667"><a href="#CenterDetermination-667"><span class="linenos"> 667</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination-668"><a href="#CenterDetermination-668"><span class="linenos"> 668</span></a><span class="sd">    CenterDetermination object - initial detection of a diffractogram center.</span>
</span><span id="CenterDetermination-669"><a href="#CenterDetermination-669"><span class="linenos"> 669</span></a>
</span><span id="CenterDetermination-670"><a href="#CenterDetermination-670"><span class="linenos"> 670</span></a><span class="sd">    This class is responsible for identifying the center coordinates of </span>
</span><span id="CenterDetermination-671"><a href="#CenterDetermination-671"><span class="linenos"> 671</span></a><span class="sd">    a 2D diffraction pattern image using various detection methods specified </span>
</span><span id="CenterDetermination-672"><a href="#CenterDetermination-672"><span class="linenos"> 672</span></a><span class="sd">    by the user. It initializes with the input image and other parameters</span>
</span><span id="CenterDetermination-673"><a href="#CenterDetermination-673"><span class="linenos"> 673</span></a><span class="sd">    that influence the center detection process.</span>
</span><span id="CenterDetermination-674"><a href="#CenterDetermination-674"><span class="linenos"> 674</span></a>
</span><span id="CenterDetermination-675"><a href="#CenterDetermination-675"><span class="linenos"> 675</span></a><span class="sd">    Parameters</span>
</span><span id="CenterDetermination-676"><a href="#CenterDetermination-676"><span class="linenos"> 676</span></a><span class="sd">    ----------</span>
</span><span id="CenterDetermination-677"><a href="#CenterDetermination-677"><span class="linenos"> 677</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="CenterDetermination-678"><a href="#CenterDetermination-678"><span class="linenos"> 678</span></a><span class="sd">        Reference to the parent CenterLocator object, allowing access </span>
</span><span id="CenterDetermination-679"><a href="#CenterDetermination-679"><span class="linenos"> 679</span></a><span class="sd">        to shared attributes and methods.</span>
</span><span id="CenterDetermination-680"><a href="#CenterDetermination-680"><span class="linenos"> 680</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="CenterDetermination-681"><a href="#CenterDetermination-681"><span class="linenos"> 681</span></a><span class="sd">        The input image representing a 2D diffraction pattern, provided as </span>
</span><span id="CenterDetermination-682"><a href="#CenterDetermination-682"><span class="linenos"> 682</span></a><span class="sd">        a file path or a NumPy array.</span>
</span><span id="CenterDetermination-683"><a href="#CenterDetermination-683"><span class="linenos"> 683</span></a><span class="sd">    determination : str or None, optional, default is None</span>
</span><span id="CenterDetermination-684"><a href="#CenterDetermination-684"><span class="linenos"> 684</span></a><span class="sd">        The method used for the initial center determination.</span>
</span><span id="CenterDetermination-685"><a href="#CenterDetermination-685"><span class="linenos"> 685</span></a><span class="sd">        Options include:</span>
</span><span id="CenterDetermination-686"><a href="#CenterDetermination-686"><span class="linenos"> 686</span></a><span class="sd">        - &#39;manual&#39;: Manual detection - user defines 3 points</span>
</span><span id="CenterDetermination-687"><a href="#CenterDetermination-687"><span class="linenos"> 687</span></a><span class="sd">          on selected diffraction ring.</span>
</span><span id="CenterDetermination-688"><a href="#CenterDetermination-688"><span class="linenos"> 688</span></a><span class="sd">        - &#39;hough&#39;: Auto-detection - Hough transform for circle detection.</span>
</span><span id="CenterDetermination-689"><a href="#CenterDetermination-689"><span class="linenos"> 689</span></a><span class="sd">        - &#39;intensity&#39;: Auto-detection - intensity center in central region.</span>
</span><span id="CenterDetermination-690"><a href="#CenterDetermination-690"><span class="linenos"> 690</span></a><span class="sd">    in_file : str, optional</span>
</span><span id="CenterDetermination-691"><a href="#CenterDetermination-691"><span class="linenos"> 691</span></a><span class="sd">        Filename of the text file from which to load previously saved </span>
</span><span id="CenterDetermination-692"><a href="#CenterDetermination-692"><span class="linenos"> 692</span></a><span class="sd">        center coordinates.</span>
</span><span id="CenterDetermination-693"><a href="#CenterDetermination-693"><span class="linenos"> 693</span></a><span class="sd">    out_file : str, optional</span>
</span><span id="CenterDetermination-694"><a href="#CenterDetermination-694"><span class="linenos"> 694</span></a><span class="sd">        Filename of the text file to which the detected center coordinates </span>
</span><span id="CenterDetermination-695"><a href="#CenterDetermination-695"><span class="linenos"> 695</span></a><span class="sd">        will be saved.</span>
</span><span id="CenterDetermination-696"><a href="#CenterDetermination-696"><span class="linenos"> 696</span></a><span class="sd">    heq : bool, optional</span>
</span><span id="CenterDetermination-697"><a href="#CenterDetermination-697"><span class="linenos"> 697</span></a><span class="sd">        Flag to indicate whether to perform histogram equalization on the </span>
</span><span id="CenterDetermination-698"><a href="#CenterDetermination-698"><span class="linenos"> 698</span></a><span class="sd">        input image. Default is False.</span>
</span><span id="CenterDetermination-699"><a href="#CenterDetermination-699"><span class="linenos"> 699</span></a><span class="sd">    icut : float, optional</span>
</span><span id="CenterDetermination-700"><a href="#CenterDetermination-700"><span class="linenos"> 700</span></a><span class="sd">        Cut-off intensity level for processing the image. Default is None.</span>
</span><span id="CenterDetermination-701"><a href="#CenterDetermination-701"><span class="linenos"> 701</span></a><span class="sd">    cmap : str, optional</span>
</span><span id="CenterDetermination-702"><a href="#CenterDetermination-702"><span class="linenos"> 702</span></a><span class="sd">        Colormap to be used for displaying the image. Default is &#39;gray&#39;.</span>
</span><span id="CenterDetermination-703"><a href="#CenterDetermination-703"><span class="linenos"> 703</span></a><span class="sd">    csquare : int, optional</span>
</span><span id="CenterDetermination-704"><a href="#CenterDetermination-704"><span class="linenos"> 704</span></a><span class="sd">        Size of the square for processing. Default is 50.</span>
</span><span id="CenterDetermination-705"><a href="#CenterDetermination-705"><span class="linenos"> 705</span></a><span class="sd">    cintensity : float, optional</span>
</span><span id="CenterDetermination-706"><a href="#CenterDetermination-706"><span class="linenos"> 706</span></a><span class="sd">        Threshold intensity for detecting features in the image. Default is</span>
</span><span id="CenterDetermination-707"><a href="#CenterDetermination-707"><span class="linenos"> 707</span></a><span class="sd">        0.8.</span>
</span><span id="CenterDetermination-708"><a href="#CenterDetermination-708"><span class="linenos"> 708</span></a><span class="sd">    messages : bool, optional</span>
</span><span id="CenterDetermination-709"><a href="#CenterDetermination-709"><span class="linenos"> 709</span></a><span class="sd">        Flag to enable or disable informational messages during processing. </span>
</span><span id="CenterDetermination-710"><a href="#CenterDetermination-710"><span class="linenos"> 710</span></a><span class="sd">        Default is False.</span>
</span><span id="CenterDetermination-711"><a href="#CenterDetermination-711"><span class="linenos"> 711</span></a><span class="sd">    print_sums : bool, optional</span>
</span><span id="CenterDetermination-712"><a href="#CenterDetermination-712"><span class="linenos"> 712</span></a><span class="sd">        If True, prints the sum of intensity values for the detected circle</span>
</span><span id="CenterDetermination-713"><a href="#CenterDetermination-713"><span class="linenos"> 713</span></a><span class="sd">        after each adjustment, relevant only for manual detection methods.</span>
</span><span id="CenterDetermination-714"><a href="#CenterDetermination-714"><span class="linenos"> 714</span></a>
</span><span id="CenterDetermination-715"><a href="#CenterDetermination-715"><span class="linenos"> 715</span></a>
</span><span id="CenterDetermination-716"><a href="#CenterDetermination-716"><span class="linenos"> 716</span></a><span class="sd">    Returns</span>
</span><span id="CenterDetermination-717"><a href="#CenterDetermination-717"><span class="linenos"> 717</span></a><span class="sd">    -------</span>
</span><span id="CenterDetermination-718"><a href="#CenterDetermination-718"><span class="linenos"> 718</span></a><span class="sd">    None</span>
</span><span id="CenterDetermination-719"><a href="#CenterDetermination-719"><span class="linenos"> 719</span></a>
</span><span id="CenterDetermination-720"><a href="#CenterDetermination-720"><span class="linenos"> 720</span></a><span class="sd">    Notes</span>
</span><span id="CenterDetermination-721"><a href="#CenterDetermination-721"><span class="linenos"> 721</span></a><span class="sd">    -----</span>
</span><span id="CenterDetermination-722"><a href="#CenterDetermination-722"><span class="linenos"> 722</span></a><span class="sd">    - The class preprocesses the input image and then applies the specified </span>
</span><span id="CenterDetermination-723"><a href="#CenterDetermination-723"><span class="linenos"> 723</span></a><span class="sd">      center detection method.</span>
</span><span id="CenterDetermination-724"><a href="#CenterDetermination-724"><span class="linenos"> 724</span></a><span class="sd">    - The detected center coordinates are stored in instance variables</span>
</span><span id="CenterDetermination-725"><a href="#CenterDetermination-725"><span class="linenos"> 725</span></a><span class="sd">      `x`, `y`, and `r`, representing the center&#39;s x-coordinate, </span>
</span><span id="CenterDetermination-726"><a href="#CenterDetermination-726"><span class="linenos"> 726</span></a><span class="sd">      y-coordinate, and radius, respectively.</span>
</span><span id="CenterDetermination-727"><a href="#CenterDetermination-727"><span class="linenos"> 727</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-728"><a href="#CenterDetermination-728"><span class="linenos"> 728</span></a>    
</span><span id="CenterDetermination-729"><a href="#CenterDetermination-729"><span class="linenos"> 729</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="CenterDetermination-730"><a href="#CenterDetermination-730"><span class="linenos"> 730</span></a>                 <span class="n">input_image</span><span class="p">,</span>
</span><span id="CenterDetermination-731"><a href="#CenterDetermination-731"><span class="linenos"> 731</span></a>                 <span class="n">determination</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="CenterDetermination-732"><a href="#CenterDetermination-732"><span class="linenos"> 732</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterDetermination-733"><a href="#CenterDetermination-733"><span class="linenos"> 733</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterDetermination-734"><a href="#CenterDetermination-734"><span class="linenos"> 734</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterDetermination-735"><a href="#CenterDetermination-735"><span class="linenos"> 735</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterDetermination-736"><a href="#CenterDetermination-736"><span class="linenos"> 736</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="CenterDetermination-737"><a href="#CenterDetermination-737"><span class="linenos"> 737</span></a>                 <span class="n">csquare</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="CenterDetermination-738"><a href="#CenterDetermination-738"><span class="linenos"> 738</span></a>                 <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="CenterDetermination-739"><a href="#CenterDetermination-739"><span class="linenos"> 739</span></a>                 <span class="n">messages</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CenterDetermination-740"><a href="#CenterDetermination-740"><span class="linenos"> 740</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="CenterDetermination-741"><a href="#CenterDetermination-741"><span class="linenos"> 741</span></a>        
</span><span id="CenterDetermination-742"><a href="#CenterDetermination-742"><span class="linenos"> 742</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterDetermination-743"><a href="#CenterDetermination-743"><span class="linenos"> 743</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="CenterDetermination-744"><a href="#CenterDetermination-744"><span class="linenos"> 744</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="CenterDetermination-745"><a href="#CenterDetermination-745"><span class="linenos"> 745</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterDetermination-746"><a href="#CenterDetermination-746"><span class="linenos"> 746</span></a>        
</span><span id="CenterDetermination-747"><a href="#CenterDetermination-747"><span class="linenos"> 747</span></a>        <span class="c1">## (0) Initialize input attributes</span>
</span><span id="CenterDetermination-748"><a href="#CenterDetermination-748"><span class="linenos"> 748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="CenterDetermination-749"><a href="#CenterDetermination-749"><span class="linenos"> 749</span></a>        
</span><span id="CenterDetermination-750"><a href="#CenterDetermination-750"><span class="linenos"> 750</span></a>        <span class="c1">## (1) Initialize new attributes</span>
</span><span id="CenterDetermination-751"><a href="#CenterDetermination-751"><span class="linenos"> 751</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="CenterDetermination-752"><a href="#CenterDetermination-752"><span class="linenos"> 752</span></a>        
</span><span id="CenterDetermination-753"><a href="#CenterDetermination-753"><span class="linenos"> 753</span></a>        <span class="c1">## (2) Run functions</span>
</span><span id="CenterDetermination-754"><a href="#CenterDetermination-754"><span class="linenos"> 754</span></a>        <span class="c1"># (2a) Preprocess data</span>
</span><span id="CenterDetermination-755"><a href="#CenterDetermination-755"><span class="linenos"> 755</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">preInit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-756"><a href="#CenterDetermination-756"><span class="linenos"> 756</span></a>        
</span><span id="CenterDetermination-757"><a href="#CenterDetermination-757"><span class="linenos"> 757</span></a>        <span class="c1"># (2b) Center detection methods</span>
</span><span id="CenterDetermination-758"><a href="#CenterDetermination-758"><span class="linenos"> 758</span></a>        <span class="k">if</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-759"><a href="#CenterDetermination-759"><span class="linenos"> 759</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_3points</span><span class="p">()</span>
</span><span id="CenterDetermination-760"><a href="#CenterDetermination-760"><span class="linenos"> 760</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hough&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-761"><a href="#CenterDetermination-761"><span class="linenos"> 761</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_Hough</span><span class="p">()</span>
</span><span id="CenterDetermination-762"><a href="#CenterDetermination-762"><span class="linenos"> 762</span></a>        <span class="k">elif</span> <span class="n">determination</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span>
</span><span id="CenterDetermination-763"><a href="#CenterDetermination-763"><span class="linenos"> 763</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_intensity</span><span class="p">(</span>
</span><span id="CenterDetermination-764"><a href="#CenterDetermination-764"><span class="linenos"> 764</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">csquare</span><span class="p">,</span> 
</span><span id="CenterDetermination-765"><a href="#CenterDetermination-765"><span class="linenos"> 765</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cintensity</span>
</span><span id="CenterDetermination-766"><a href="#CenterDetermination-766"><span class="linenos"> 766</span></a>                <span class="p">)</span>
</span><span id="CenterDetermination-767"><a href="#CenterDetermination-767"><span class="linenos"> 767</span></a>                
</span><span id="CenterDetermination-768"><a href="#CenterDetermination-768"><span class="linenos"> 768</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterDetermination-769"><a href="#CenterDetermination-769"><span class="linenos"> 769</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected determination method does not exist.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-770"><a href="#CenterDetermination-770"><span class="linenos"> 770</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterDetermination-771"><a href="#CenterDetermination-771"><span class="linenos"> 771</span></a>
</span><span id="CenterDetermination-772"><a href="#CenterDetermination-772"><span class="linenos"> 772</span></a>
</span><span id="CenterDetermination-773"><a href="#CenterDetermination-773"><span class="linenos"> 773</span></a>    <span class="c1">## Functions::</span>
</span><span id="CenterDetermination-774"><a href="#CenterDetermination-774"><span class="linenos"> 774</span></a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">preInit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preHough</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preManual</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CenterDetermination-775"><a href="#CenterDetermination-775"><span class="linenos"> 775</span></a>                   <span class="n">preVar</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preSum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preInt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  
</span><span id="CenterDetermination-776"><a href="#CenterDetermination-776"><span class="linenos"> 776</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; FOR AUTOMATIC METHODS OPTIMIZATION AND MORE UNIVERSAL SOLUTIONS</span>
</span><span id="CenterDetermination-777"><a href="#CenterDetermination-777"><span class="linenos"> 777</span></a><span class="sd">        Function for input image preprocessing based on the methods </span>
</span><span id="CenterDetermination-778"><a href="#CenterDetermination-778"><span class="linenos"> 778</span></a><span class="sd">        defined in the class initialization - self.detection_method, </span>
</span><span id="CenterDetermination-779"><a href="#CenterDetermination-779"><span class="linenos"> 779</span></a><span class="sd">        self.correction_method.</span>
</span><span id="CenterDetermination-780"><a href="#CenterDetermination-780"><span class="linenos"> 780</span></a>
</span><span id="CenterDetermination-781"><a href="#CenterDetermination-781"><span class="linenos"> 781</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-782"><a href="#CenterDetermination-782"><span class="linenos"> 782</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-783"><a href="#CenterDetermination-783"><span class="linenos"> 783</span></a><span class="sd">        preInit : bool, optional</span>
</span><span id="CenterDetermination-784"><a href="#CenterDetermination-784"><span class="linenos"> 784</span></a><span class="sd">            Perform preprocessing of the input image (when using icut or heq). </span>
</span><span id="CenterDetermination-785"><a href="#CenterDetermination-785"><span class="linenos"> 785</span></a><span class="sd">            This is called automatically every time, if no preprocessing</span>
</span><span id="CenterDetermination-786"><a href="#CenterDetermination-786"><span class="linenos"> 786</span></a><span class="sd">            specified, the detection and refinement will be performed on </span>
</span><span id="CenterDetermination-787"><a href="#CenterDetermination-787"><span class="linenos"> 787</span></a><span class="sd">            original image. The default is 0.</span>
</span><span id="CenterDetermination-788"><a href="#CenterDetermination-788"><span class="linenos"> 788</span></a><span class="sd">        preHough : bool, optional</span>
</span><span id="CenterDetermination-789"><a href="#CenterDetermination-789"><span class="linenos"> 789</span></a><span class="sd">            Perform preprocessing for automatic detection via Hough transform. </span>
</span><span id="CenterDetermination-790"><a href="#CenterDetermination-790"><span class="linenos"> 790</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-791"><a href="#CenterDetermination-791"><span class="linenos"> 791</span></a>
</span><span id="CenterDetermination-792"><a href="#CenterDetermination-792"><span class="linenos"> 792</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-793"><a href="#CenterDetermination-793"><span class="linenos"> 793</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-794"><a href="#CenterDetermination-794"><span class="linenos"> 794</span></a><span class="sd">        manu : NumPy array</span>
</span><span id="CenterDetermination-795"><a href="#CenterDetermination-795"><span class="linenos"> 795</span></a><span class="sd">            Pre-processed image for the manual detection method</span>
</span><span id="CenterDetermination-796"><a href="#CenterDetermination-796"><span class="linenos"> 796</span></a><span class="sd">        edges : array of bool</span>
</span><span id="CenterDetermination-797"><a href="#CenterDetermination-797"><span class="linenos"> 797</span></a><span class="sd">            Detected edges via Canny detector for automatic Hough transform</span>
</span><span id="CenterDetermination-798"><a href="#CenterDetermination-798"><span class="linenos"> 798</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-799"><a href="#CenterDetermination-799"><span class="linenos"> 799</span></a>        
</span><span id="CenterDetermination-800"><a href="#CenterDetermination-800"><span class="linenos"> 800</span></a>        <span class="c1"># Flags</span>
</span><span id="CenterDetermination-801"><a href="#CenterDetermination-801"><span class="linenos"> 801</span></a>        <span class="n">control_print</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-802"><a href="#CenterDetermination-802"><span class="linenos"> 802</span></a>        
</span><span id="CenterDetermination-803"><a href="#CenterDetermination-803"><span class="linenos"> 803</span></a>        <span class="c1"># Load original image</span>
</span><span id="CenterDetermination-804"><a href="#CenterDetermination-804"><span class="linenos"> 804</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-805"><a href="#CenterDetermination-805"><span class="linenos"> 805</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-806"><a href="#CenterDetermination-806"><span class="linenos"> 806</span></a>            
</span><span id="CenterDetermination-807"><a href="#CenterDetermination-807"><span class="linenos"> 807</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-808"><a href="#CenterDetermination-808"><span class="linenos"> 808</span></a>        
</span><span id="CenterDetermination-809"><a href="#CenterDetermination-809"><span class="linenos"> 809</span></a>        <span class="c1">### After initialization: perform an image enhancement if specified</span>
</span><span id="CenterDetermination-810"><a href="#CenterDetermination-810"><span class="linenos"> 810</span></a>        <span class="k">if</span> <span class="n">preInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-811"><a href="#CenterDetermination-811"><span class="linenos"> 811</span></a>            <span class="c1"># Enhance diffraction pattern to make it more visible</span>
</span><span id="CenterDetermination-812"><a href="#CenterDetermination-812"><span class="linenos"> 812</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-813"><a href="#CenterDetermination-813"><span class="linenos"> 813</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-814"><a href="#CenterDetermination-814"><span class="linenos"> 814</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Histogram equalized.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-815"><a href="#CenterDetermination-815"><span class="linenos"> 815</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">equalize_adapthist</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-816"><a href="#CenterDetermination-816"><span class="linenos"> 816</span></a>
</span><span id="CenterDetermination-817"><a href="#CenterDetermination-817"><span class="linenos"> 817</span></a>                
</span><span id="CenterDetermination-818"><a href="#CenterDetermination-818"><span class="linenos"> 818</span></a>            <span class="c1"># # Edit contrast with a user-predefined parameter</span>
</span><span id="CenterDetermination-819"><a href="#CenterDetermination-819"><span class="linenos"> 819</span></a>            <span class="c1"># if self.parent.icut is not None:</span>
</span><span id="CenterDetermination-820"><a href="#CenterDetermination-820"><span class="linenos"> 820</span></a>            <span class="c1">#     if self.parent.messages:</span>
</span><span id="CenterDetermination-821"><a href="#CenterDetermination-821"><span class="linenos"> 821</span></a>            <span class="c1">#         print(&quot;Contrast enhanced.&quot;)</span>
</span><span id="CenterDetermination-822"><a href="#CenterDetermination-822"><span class="linenos"> 822</span></a>            <span class="c1">#     image = np.where(image &gt; self.parent.icut, </span>
</span><span id="CenterDetermination-823"><a href="#CenterDetermination-823"><span class="linenos"> 823</span></a>            <span class="c1">#                      self.parent.icut, </span>
</span><span id="CenterDetermination-824"><a href="#CenterDetermination-824"><span class="linenos"> 824</span></a>            <span class="c1">#                      image)</span>
</span><span id="CenterDetermination-825"><a href="#CenterDetermination-825"><span class="linenos"> 825</span></a>                
</span><span id="CenterDetermination-826"><a href="#CenterDetermination-826"><span class="linenos"> 826</span></a>
</span><span id="CenterDetermination-827"><a href="#CenterDetermination-827"><span class="linenos"> 827</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="CenterDetermination-828"><a href="#CenterDetermination-828"><span class="linenos"> 828</span></a>            <span class="k">return</span>
</span><span id="CenterDetermination-829"><a href="#CenterDetermination-829"><span class="linenos"> 829</span></a>        
</span><span id="CenterDetermination-830"><a href="#CenterDetermination-830"><span class="linenos"> 830</span></a>        <span class="c1">### Hough transform: perform pre-processing necessary for the detection</span>
</span><span id="CenterDetermination-831"><a href="#CenterDetermination-831"><span class="linenos"> 831</span></a>        <span class="k">if</span> <span class="n">preHough</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>           
</span><span id="CenterDetermination-832"><a href="#CenterDetermination-832"><span class="linenos"> 832</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-833"><a href="#CenterDetermination-833"><span class="linenos"> 833</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination-834"><a href="#CenterDetermination-834"><span class="linenos"> 834</span></a>                
</span><span id="CenterDetermination-835"><a href="#CenterDetermination-835"><span class="linenos"> 835</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination-836"><a href="#CenterDetermination-836"><span class="linenos"> 836</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-837"><a href="#CenterDetermination-837"><span class="linenos"> 837</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-838"><a href="#CenterDetermination-838"><span class="linenos"> 838</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beamstopper removed.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-839"><a href="#CenterDetermination-839"><span class="linenos"> 839</span></a>                    <span class="n">max_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination-840"><a href="#CenterDetermination-840"><span class="linenos"> 840</span></a>        
</span><span id="CenterDetermination-841"><a href="#CenterDetermination-841"><span class="linenos"> 841</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-842"><a href="#CenterDetermination-842"><span class="linenos"> 842</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-843"><a href="#CenterDetermination-843"><span class="linenos"> 843</span></a>        
</span><span id="CenterDetermination-844"><a href="#CenterDetermination-844"><span class="linenos"> 844</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination-845"><a href="#CenterDetermination-845"><span class="linenos"> 845</span></a>                    
</span><span id="CenterDetermination-846"><a href="#CenterDetermination-846"><span class="linenos"> 846</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination-847"><a href="#CenterDetermination-847"><span class="linenos"> 847</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination-848"><a href="#CenterDetermination-848"><span class="linenos"> 848</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-849"><a href="#CenterDetermination-849"><span class="linenos"> 849</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-850"><a href="#CenterDetermination-850"><span class="linenos"> 850</span></a>        
</span><span id="CenterDetermination-851"><a href="#CenterDetermination-851"><span class="linenos"> 851</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   
</span><span id="CenterDetermination-852"><a href="#CenterDetermination-852"><span class="linenos"> 852</span></a>                    
</span><span id="CenterDetermination-853"><a href="#CenterDetermination-853"><span class="linenos"> 853</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-854"><a href="#CenterDetermination-854"><span class="linenos"> 854</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-855"><a href="#CenterDetermination-855"><span class="linenos"> 855</span></a>                            <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-856"><a href="#CenterDetermination-856"><span class="linenos"> 856</span></a>                            <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination-857"><a href="#CenterDetermination-857"><span class="linenos"> 857</span></a>                            <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-858"><a href="#CenterDetermination-858"><span class="linenos"> 858</span></a>                    
</span><span id="CenterDetermination-859"><a href="#CenterDetermination-859"><span class="linenos"> 859</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination-860"><a href="#CenterDetermination-860"><span class="linenos"> 860</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="CenterDetermination-861"><a href="#CenterDetermination-861"><span class="linenos"> 861</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-862"><a href="#CenterDetermination-862"><span class="linenos"> 862</span></a>                    
</span><span id="CenterDetermination-863"><a href="#CenterDetermination-863"><span class="linenos"> 863</span></a>                    <span class="c1"># Erode the dilated edges to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination-864"><a href="#CenterDetermination-864"><span class="linenos"> 864</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-865"><a href="#CenterDetermination-865"><span class="linenos"> 865</span></a>
</span><span id="CenterDetermination-866"><a href="#CenterDetermination-866"><span class="linenos"> 866</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-867"><a href="#CenterDetermination-867"><span class="linenos"> 867</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-868"><a href="#CenterDetermination-868"><span class="linenos"> 868</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-869"><a href="#CenterDetermination-869"><span class="linenos"> 869</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-870"><a href="#CenterDetermination-870"><span class="linenos"> 870</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-871"><a href="#CenterDetermination-871"><span class="linenos"> 871</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-872"><a href="#CenterDetermination-872"><span class="linenos"> 872</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-873"><a href="#CenterDetermination-873"><span class="linenos"> 873</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-874"><a href="#CenterDetermination-874"><span class="linenos"> 874</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-875"><a href="#CenterDetermination-875"><span class="linenos"> 875</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-876"><a href="#CenterDetermination-876"><span class="linenos"> 876</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-877"><a href="#CenterDetermination-877"><span class="linenos"> 877</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-878"><a href="#CenterDetermination-878"><span class="linenos"> 878</span></a>                        
</span><span id="CenterDetermination-879"><a href="#CenterDetermination-879"><span class="linenos"> 879</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination-880"><a href="#CenterDetermination-880"><span class="linenos"> 880</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-881"><a href="#CenterDetermination-881"><span class="linenos"> 881</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-882"><a href="#CenterDetermination-882"><span class="linenos"> 882</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No beamstopper.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-883"><a href="#CenterDetermination-883"><span class="linenos"> 883</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-884"><a href="#CenterDetermination-884"><span class="linenos"> 884</span></a>                                             <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-885"><a href="#CenterDetermination-885"><span class="linenos"> 885</span></a>                                             <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination-886"><a href="#CenterDetermination-886"><span class="linenos"> 886</span></a>                                             <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination-887"><a href="#CenterDetermination-887"><span class="linenos"> 887</span></a>                    
</span><span id="CenterDetermination-888"><a href="#CenterDetermination-888"><span class="linenos"> 888</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination-889"><a href="#CenterDetermination-889"><span class="linenos"> 889</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="CenterDetermination-890"><a href="#CenterDetermination-890"><span class="linenos"> 890</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-891"><a href="#CenterDetermination-891"><span class="linenos"> 891</span></a>                    
</span><span id="CenterDetermination-892"><a href="#CenterDetermination-892"><span class="linenos"> 892</span></a>                    <span class="c1"># Erode the dilated edges to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination-893"><a href="#CenterDetermination-893"><span class="linenos"> 893</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination-894"><a href="#CenterDetermination-894"><span class="linenos"> 894</span></a>                    <span class="n">connected_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
</span><span id="CenterDetermination-895"><a href="#CenterDetermination-895"><span class="linenos"> 895</span></a>                        <span class="n">connected_edges</span><span class="p">,</span> 
</span><span id="CenterDetermination-896"><a href="#CenterDetermination-896"><span class="linenos"> 896</span></a>                        <span class="n">min_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination-897"><a href="#CenterDetermination-897"><span class="linenos"> 897</span></a>                    
</span><span id="CenterDetermination-898"><a href="#CenterDetermination-898"><span class="linenos"> 898</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-899"><a href="#CenterDetermination-899"><span class="linenos"> 899</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-900"><a href="#CenterDetermination-900"><span class="linenos"> 900</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-901"><a href="#CenterDetermination-901"><span class="linenos"> 901</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-902"><a href="#CenterDetermination-902"><span class="linenos"> 902</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-903"><a href="#CenterDetermination-903"><span class="linenos"> 903</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-904"><a href="#CenterDetermination-904"><span class="linenos"> 904</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,)</span>
</span><span id="CenterDetermination-905"><a href="#CenterDetermination-905"><span class="linenos"> 905</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-906"><a href="#CenterDetermination-906"><span class="linenos"> 906</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-907"><a href="#CenterDetermination-907"><span class="linenos"> 907</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-908"><a href="#CenterDetermination-908"><span class="linenos"> 908</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-909"><a href="#CenterDetermination-909"><span class="linenos"> 909</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-910"><a href="#CenterDetermination-910"><span class="linenos"> 910</span></a>                
</span><span id="CenterDetermination-911"><a href="#CenterDetermination-911"><span class="linenos"> 911</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
</span><span id="CenterDetermination-912"><a href="#CenterDetermination-912"><span class="linenos"> 912</span></a>                <span class="c1"># Central square extraction</span>
</span><span id="CenterDetermination-913"><a href="#CenterDetermination-913"><span class="linenos"> 913</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination-914"><a href="#CenterDetermination-914"><span class="linenos"> 914</span></a>
</span><span id="CenterDetermination-915"><a href="#CenterDetermination-915"><span class="linenos"> 915</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination-916"><a href="#CenterDetermination-916"><span class="linenos"> 916</span></a>                <span class="k">if</span> <span class="mf">0.4</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.6</span><span class="p">:</span>
</span><span id="CenterDetermination-917"><a href="#CenterDetermination-917"><span class="linenos"> 917</span></a>                    
</span><span id="CenterDetermination-918"><a href="#CenterDetermination-918"><span class="linenos"> 918</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination-919"><a href="#CenterDetermination-919"><span class="linenos"> 919</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-920"><a href="#CenterDetermination-920"><span class="linenos"> 920</span></a>    
</span><span id="CenterDetermination-921"><a href="#CenterDetermination-921"><span class="linenos"> 921</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-922"><a href="#CenterDetermination-922"><span class="linenos"> 922</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-923"><a href="#CenterDetermination-923"><span class="linenos"> 923</span></a>    
</span><span id="CenterDetermination-924"><a href="#CenterDetermination-924"><span class="linenos"> 924</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="CenterDetermination-925"><a href="#CenterDetermination-925"><span class="linenos"> 925</span></a>                                                     
</span><span id="CenterDetermination-926"><a href="#CenterDetermination-926"><span class="linenos"> 926</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-927"><a href="#CenterDetermination-927"><span class="linenos"> 927</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination-928"><a href="#CenterDetermination-928"><span class="linenos"> 928</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-929"><a href="#CenterDetermination-929"><span class="linenos"> 929</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-930"><a href="#CenterDetermination-930"><span class="linenos"> 930</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination-931"><a href="#CenterDetermination-931"><span class="linenos"> 931</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-932"><a href="#CenterDetermination-932"><span class="linenos"> 932</span></a>
</span><span id="CenterDetermination-933"><a href="#CenterDetermination-933"><span class="linenos"> 933</span></a>                    
</span><span id="CenterDetermination-934"><a href="#CenterDetermination-934"><span class="linenos"> 934</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-935"><a href="#CenterDetermination-935"><span class="linenos"> 935</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-936"><a href="#CenterDetermination-936"><span class="linenos"> 936</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-937"><a href="#CenterDetermination-937"><span class="linenos"> 937</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-938"><a href="#CenterDetermination-938"><span class="linenos"> 938</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-939"><a href="#CenterDetermination-939"><span class="linenos"> 939</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-940"><a href="#CenterDetermination-940"><span class="linenos"> 940</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-941"><a href="#CenterDetermination-941"><span class="linenos"> 941</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-942"><a href="#CenterDetermination-942"><span class="linenos"> 942</span></a>                      <span class="c1">#  ax[1,1].imshow(connected_edges)</span>
</span><span id="CenterDetermination-943"><a href="#CenterDetermination-943"><span class="linenos"> 943</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-944"><a href="#CenterDetermination-944"><span class="linenos"> 944</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-945"><a href="#CenterDetermination-945"><span class="linenos"> 945</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-946"><a href="#CenterDetermination-946"><span class="linenos"> 946</span></a>                    
</span><span id="CenterDetermination-947"><a href="#CenterDetermination-947"><span class="linenos"> 947</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination-948"><a href="#CenterDetermination-948"><span class="linenos"> 948</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-949"><a href="#CenterDetermination-949"><span class="linenos"> 949</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-950"><a href="#CenterDetermination-950"><span class="linenos"> 950</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination-951"><a href="#CenterDetermination-951"><span class="linenos"> 951</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-952"><a href="#CenterDetermination-952"><span class="linenos"> 952</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-953"><a href="#CenterDetermination-953"><span class="linenos"> 953</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination-954"><a href="#CenterDetermination-954"><span class="linenos"> 954</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination-955"><a href="#CenterDetermination-955"><span class="linenos"> 955</span></a>
</span><span id="CenterDetermination-956"><a href="#CenterDetermination-956"><span class="linenos"> 956</span></a>                    
</span><span id="CenterDetermination-957"><a href="#CenterDetermination-957"><span class="linenos"> 957</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-958"><a href="#CenterDetermination-958"><span class="linenos"> 958</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-959"><a href="#CenterDetermination-959"><span class="linenos"> 959</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-960"><a href="#CenterDetermination-960"><span class="linenos"> 960</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-961"><a href="#CenterDetermination-961"><span class="linenos"> 961</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-962"><a href="#CenterDetermination-962"><span class="linenos"> 962</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-963"><a href="#CenterDetermination-963"><span class="linenos"> 963</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-964"><a href="#CenterDetermination-964"><span class="linenos"> 964</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-965"><a href="#CenterDetermination-965"><span class="linenos"> 965</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-966"><a href="#CenterDetermination-966"><span class="linenos"> 966</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-967"><a href="#CenterDetermination-967"><span class="linenos"> 967</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-968"><a href="#CenterDetermination-968"><span class="linenos"> 968</span></a>            
</span><span id="CenterDetermination-969"><a href="#CenterDetermination-969"><span class="linenos"> 969</span></a>            <span class="k">return</span> <span class="n">edges</span>
</span><span id="CenterDetermination-970"><a href="#CenterDetermination-970"><span class="linenos"> 970</span></a>        
</span><span id="CenterDetermination-971"><a href="#CenterDetermination-971"><span class="linenos"> 971</span></a>    
</span><span id="CenterDetermination-972"><a href="#CenterDetermination-972"><span class="linenos"> 972</span></a>    <span class="k">def</span> <span class="nf">detection_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="p">,</span> <span class="n">cintensity</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination-973"><a href="#CenterDetermination-973"><span class="linenos"> 973</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination-974"><a href="#CenterDetermination-974"><span class="linenos"> 974</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="CenterDetermination-975"><a href="#CenterDetermination-975"><span class="linenos"> 975</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-976"><a href="#CenterDetermination-976"><span class="linenos"> 976</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-977"><a href="#CenterDetermination-977"><span class="linenos"> 977</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-978"><a href="#CenterDetermination-978"><span class="linenos"> 978</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="CenterDetermination-979"><a href="#CenterDetermination-979"><span class="linenos"> 979</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="CenterDetermination-980"><a href="#CenterDetermination-980"><span class="linenos"> 980</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="CenterDetermination-981"><a href="#CenterDetermination-981"><span class="linenos"> 981</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="CenterDetermination-982"><a href="#CenterDetermination-982"><span class="linenos"> 982</span></a><span class="sd">            The intensity center will be searched only within the central square.</span>
</span><span id="CenterDetermination-983"><a href="#CenterDetermination-983"><span class="linenos"> 983</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="CenterDetermination-984"><a href="#CenterDetermination-984"><span class="linenos"> 984</span></a><span class="sd">            to minimize the effect of possible intensity assymetry around center. </span>
</span><span id="CenterDetermination-985"><a href="#CenterDetermination-985"><span class="linenos"> 985</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="CenterDetermination-986"><a href="#CenterDetermination-986"><span class="linenos"> 986</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="CenterDetermination-987"><a href="#CenterDetermination-987"><span class="linenos"> 987</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="CenterDetermination-988"><a href="#CenterDetermination-988"><span class="linenos"> 988</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="CenterDetermination-989"><a href="#CenterDetermination-989"><span class="linenos"> 989</span></a><span class="sd">            </span>
</span><span id="CenterDetermination-990"><a href="#CenterDetermination-990"><span class="linenos"> 990</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-991"><a href="#CenterDetermination-991"><span class="linenos"> 991</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-992"><a href="#CenterDetermination-992"><span class="linenos"> 992</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="CenterDetermination-993"><a href="#CenterDetermination-993"><span class="linenos"> 993</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="CenterDetermination-994"><a href="#CenterDetermination-994"><span class="linenos"> 994</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.</span>
</span><span id="CenterDetermination-995"><a href="#CenterDetermination-995"><span class="linenos"> 995</span></a><span class="sd">        &#39;&#39;&#39;</span>  
</span><span id="CenterDetermination-996"><a href="#CenterDetermination-996"><span class="linenos"> 996</span></a>        
</span><span id="CenterDetermination-997"><a href="#CenterDetermination-997"><span class="linenos"> 997</span></a>        <span class="c1"># (1) Get image/array size</span>
</span><span id="CenterDetermination-998"><a href="#CenterDetermination-998"><span class="linenos"> 998</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-999"><a href="#CenterDetermination-999"><span class="linenos"> 999</span></a>        
</span><span id="CenterDetermination-1000"><a href="#CenterDetermination-1000"><span class="linenos">1000</span></a>                
</span><span id="CenterDetermination-1001"><a href="#CenterDetermination-1001"><span class="linenos">1001</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-1002"><a href="#CenterDetermination-1002"><span class="linenos">1002</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterDetermination-1003"><a href="#CenterDetermination-1003"><span class="linenos">1003</span></a>        
</span><span id="CenterDetermination-1004"><a href="#CenterDetermination-1004"><span class="linenos">1004</span></a>        <span class="c1"># (2) Calculate borders around the central square</span>
</span><span id="CenterDetermination-1005"><a href="#CenterDetermination-1005"><span class="linenos">1005</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1006"><a href="#CenterDetermination-1006"><span class="linenos">1006</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1007"><a href="#CenterDetermination-1007"><span class="linenos">1007</span></a>        
</span><span id="CenterDetermination-1008"><a href="#CenterDetermination-1008"><span class="linenos">1008</span></a>        <span class="c1"># (3) Create the central square,</span>
</span><span id="CenterDetermination-1009"><a href="#CenterDetermination-1009"><span class="linenos">1009</span></a>        <span class="c1"># from which the intensity center will be detected</span>
</span><span id="CenterDetermination-1010"><a href="#CenterDetermination-1010"><span class="linenos">1010</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="CenterDetermination-1011"><a href="#CenterDetermination-1011"><span class="linenos">1011</span></a>        
</span><span id="CenterDetermination-1012"><a href="#CenterDetermination-1012"><span class="linenos">1012</span></a>        <span class="c1"># (4) In the central square,</span>
</span><span id="CenterDetermination-1013"><a href="#CenterDetermination-1013"><span class="linenos">1013</span></a>        <span class="c1"># set all values below cintenstity to zero</span>
</span><span id="CenterDetermination-1014"><a href="#CenterDetermination-1014"><span class="linenos">1014</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination-1015"><a href="#CenterDetermination-1015"><span class="linenos">1015</span></a>        
</span><span id="CenterDetermination-1016"><a href="#CenterDetermination-1016"><span class="linenos">1016</span></a>        <span class="c1"># (5) Determine the intensity center from image moments</span>
</span><span id="CenterDetermination-1017"><a href="#CenterDetermination-1017"><span class="linenos">1017</span></a>        <span class="c1"># see image moments in...</span>
</span><span id="CenterDetermination-1018"><a href="#CenterDetermination-1018"><span class="linenos">1018</span></a>        <span class="c1"># skimage: https://scikit-image.org/docs/dev/api/skimage.measure.html</span>
</span><span id="CenterDetermination-1019"><a href="#CenterDetermination-1019"><span class="linenos">1019</span></a>        <span class="c1"># wikipedia: https://en.wikipedia.org/wiki/Image_moment -&gt; Centroid</span>
</span><span id="CenterDetermination-1020"><a href="#CenterDetermination-1020"><span class="linenos">1020</span></a>        <span class="c1"># ---</span>
</span><span id="CenterDetermination-1021"><a href="#CenterDetermination-1021"><span class="linenos">1021</span></a>        <span class="c1"># (a) Calculate 1st central moments of the image</span>
</span><span id="CenterDetermination-1022"><a href="#CenterDetermination-1022"><span class="linenos">1022</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1023"><a href="#CenterDetermination-1023"><span class="linenos">1023</span></a>        <span class="c1"># (b) Calculate the intensity center = centroid according to www-help</span>
</span><span id="CenterDetermination-1024"><a href="#CenterDetermination-1024"><span class="linenos">1024</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination-1025"><a href="#CenterDetermination-1025"><span class="linenos">1025</span></a>        <span class="c1"># (c) We have centroid of the central square</span>
</span><span id="CenterDetermination-1026"><a href="#CenterDetermination-1026"><span class="linenos">1026</span></a>        <span class="c1"># but we have to recalculate it to the whole image</span>
</span><span id="CenterDetermination-1027"><a href="#CenterDetermination-1027"><span class="linenos">1027</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">xborder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">yborder</span><span class="p">)</span>
</span><span id="CenterDetermination-1028"><a href="#CenterDetermination-1028"><span class="linenos">1028</span></a>        <span class="c1"># (d) Radius of a diffraction ring is hardcoded to 100 here</span>
</span><span id="CenterDetermination-1029"><a href="#CenterDetermination-1029"><span class="linenos">1029</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterDetermination-1030"><a href="#CenterDetermination-1030"><span class="linenos">1030</span></a>        
</span><span id="CenterDetermination-1031"><a href="#CenterDetermination-1031"><span class="linenos">1031</span></a>        <span class="c1"># (6) User information (if required)</span>
</span><span id="CenterDetermination-1032"><a href="#CenterDetermination-1032"><span class="linenos">1032</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination-1033"><a href="#CenterDetermination-1033"><span class="linenos">1033</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (IntensityCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-1034"><a href="#CenterDetermination-1034"><span class="linenos">1034</span></a>
</span><span id="CenterDetermination-1035"><a href="#CenterDetermination-1035"><span class="linenos">1035</span></a>
</span><span id="CenterDetermination-1036"><a href="#CenterDetermination-1036"><span class="linenos">1036</span></a>        <span class="c1"># (7) Plot results (if required)</span>
</span><span id="CenterDetermination-1037"><a href="#CenterDetermination-1037"><span class="linenos">1037</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1038"><a href="#CenterDetermination-1038"><span class="linenos">1038</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="CenterDetermination-1039"><a href="#CenterDetermination-1039"><span class="linenos">1039</span></a>                
</span><span id="CenterDetermination-1040"><a href="#CenterDetermination-1040"><span class="linenos">1040</span></a>        <span class="c1"># (8) Return the results:</span>
</span><span id="CenterDetermination-1041"><a href="#CenterDetermination-1041"><span class="linenos">1041</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="CenterDetermination-1042"><a href="#CenterDetermination-1042"><span class="linenos">1042</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination-1043"><a href="#CenterDetermination-1043"><span class="linenos">1043</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="CenterDetermination-1044"><a href="#CenterDetermination-1044"><span class="linenos">1044</span></a>        <span class="c1"># ! radius of the circle is just hardcoded here - see TODO note above</span>
</span><span id="CenterDetermination-1045"><a href="#CenterDetermination-1045"><span class="linenos">1045</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-1046"><a href="#CenterDetermination-1046"><span class="linenos">1046</span></a>    
</span><span id="CenterDetermination-1047"><a href="#CenterDetermination-1047"><span class="linenos">1047</span></a>
</span><span id="CenterDetermination-1048"><a href="#CenterDetermination-1048"><span class="linenos">1048</span></a>    <span class="k">def</span> <span class="nf">detection_Hough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination-1049"><a href="#CenterDetermination-1049"><span class="linenos">1049</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;        </span>
</span><span id="CenterDetermination-1050"><a href="#CenterDetermination-1050"><span class="linenos">1050</span></a><span class="sd">        Perform Hough transform to detect center of diffraction patterns.</span>
</span><span id="CenterDetermination-1051"><a href="#CenterDetermination-1051"><span class="linenos">1051</span></a><span class="sd">        This is a method to automatically detect circular diffraction patterns</span>
</span><span id="CenterDetermination-1052"><a href="#CenterDetermination-1052"><span class="linenos">1052</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1053"><a href="#CenterDetermination-1053"><span class="linenos">1053</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1054"><a href="#CenterDetermination-1054"><span class="linenos">1054</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1055"><a href="#CenterDetermination-1055"><span class="linenos">1055</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination-1056"><a href="#CenterDetermination-1056"><span class="linenos">1056</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="CenterDetermination-1057"><a href="#CenterDetermination-1057"><span class="linenos">1057</span></a><span class="sd">            Default is 1. To cancel visualization, set plot_results = 0.</span>
</span><span id="CenterDetermination-1058"><a href="#CenterDetermination-1058"><span class="linenos">1058</span></a>
</span><span id="CenterDetermination-1059"><a href="#CenterDetermination-1059"><span class="linenos">1059</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1060"><a href="#CenterDetermination-1060"><span class="linenos">1060</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1061"><a href="#CenterDetermination-1061"><span class="linenos">1061</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination-1062"><a href="#CenterDetermination-1062"><span class="linenos">1062</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination-1063"><a href="#CenterDetermination-1063"><span class="linenos">1063</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination-1064"><a href="#CenterDetermination-1064"><span class="linenos">1064</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination-1065"><a href="#CenterDetermination-1065"><span class="linenos">1065</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination-1066"><a href="#CenterDetermination-1066"><span class="linenos">1066</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination-1067"><a href="#CenterDetermination-1067"><span class="linenos">1067</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination-1068"><a href="#CenterDetermination-1068"><span class="linenos">1068</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1069"><a href="#CenterDetermination-1069"><span class="linenos">1069</span></a>        <span class="c1">## Image preprocessing</span>
</span><span id="CenterDetermination-1070"><a href="#CenterDetermination-1070"><span class="linenos">1070</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1071"><a href="#CenterDetermination-1071"><span class="linenos">1071</span></a>        
</span><span id="CenterDetermination-1072"><a href="#CenterDetermination-1072"><span class="linenos">1072</span></a>        <span class="c1"># if the brightness of the image is small enough, pixel values greater</span>
</span><span id="CenterDetermination-1073"><a href="#CenterDetermination-1073"><span class="linenos">1073</span></a>        <span class="c1"># than 50 will be set to 0 -- removal of the beam stopper influence</span>
</span><span id="CenterDetermination-1074"><a href="#CenterDetermination-1074"><span class="linenos">1074</span></a>        
</span><span id="CenterDetermination-1075"><a href="#CenterDetermination-1075"><span class="linenos">1075</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-1076"><a href="#CenterDetermination-1076"><span class="linenos">1076</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">:</span>
</span><span id="CenterDetermination-1077"><a href="#CenterDetermination-1077"><span class="linenos">1077</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="CenterDetermination-1078"><a href="#CenterDetermination-1078"><span class="linenos">1078</span></a>        
</span><span id="CenterDetermination-1079"><a href="#CenterDetermination-1079"><span class="linenos">1079</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-1080"><a href="#CenterDetermination-1080"><span class="linenos">1080</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1081"><a href="#CenterDetermination-1081"><span class="linenos">1081</span></a>        
</span><span id="CenterDetermination-1082"><a href="#CenterDetermination-1082"><span class="linenos">1082</span></a>                    <span class="n">im</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination-1083"><a href="#CenterDetermination-1083"><span class="linenos">1083</span></a>                
</span><span id="CenterDetermination-1084"><a href="#CenterDetermination-1084"><span class="linenos">1084</span></a>            <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-1085"><a href="#CenterDetermination-1085"><span class="linenos">1085</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination-1086"><a href="#CenterDetermination-1086"><span class="linenos">1086</span></a>                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1087"><a href="#CenterDetermination-1087"><span class="linenos">1087</span></a>                                     <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination-1088"><a href="#CenterDetermination-1088"><span class="linenos">1088</span></a>                                     <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination-1089"><a href="#CenterDetermination-1089"><span class="linenos">1089</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1090"><a href="#CenterDetermination-1090"><span class="linenos">1090</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">:</span>
</span><span id="CenterDetermination-1091"><a href="#CenterDetermination-1091"><span class="linenos">1091</span></a>                <span class="n">max_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="CenterDetermination-1092"><a href="#CenterDetermination-1092"><span class="linenos">1092</span></a>
</span><span id="CenterDetermination-1093"><a href="#CenterDetermination-1093"><span class="linenos">1093</span></a>                <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination-1094"><a href="#CenterDetermination-1094"><span class="linenos">1094</span></a>                <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1095"><a href="#CenterDetermination-1095"><span class="linenos">1095</span></a>
</span><span id="CenterDetermination-1096"><a href="#CenterDetermination-1096"><span class="linenos">1096</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination-1097"><a href="#CenterDetermination-1097"><span class="linenos">1097</span></a>            
</span><span id="CenterDetermination-1098"><a href="#CenterDetermination-1098"><span class="linenos">1098</span></a>            <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination-1099"><a href="#CenterDetermination-1099"><span class="linenos">1099</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination-1100"><a href="#CenterDetermination-1100"><span class="linenos">1100</span></a>                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1101"><a href="#CenterDetermination-1101"><span class="linenos">1101</span></a>                                     <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> 
</span><span id="CenterDetermination-1102"><a href="#CenterDetermination-1102"><span class="linenos">1102</span></a>                                     <span class="n">high_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1103"><a href="#CenterDetermination-1103"><span class="linenos">1103</span></a>        
</span><span id="CenterDetermination-1104"><a href="#CenterDetermination-1104"><span class="linenos">1104</span></a>        
</span><span id="CenterDetermination-1105"><a href="#CenterDetermination-1105"><span class="linenos">1105</span></a>        <span class="c1"># Define the radii range for the concentric circles</span>
</span><span id="CenterDetermination-1106"><a href="#CenterDetermination-1106"><span class="linenos">1106</span></a>        <span class="c1"># (set empirically based on the available pictures)</span>
</span><span id="CenterDetermination-1107"><a href="#CenterDetermination-1107"><span class="linenos">1107</span></a>        <span class="n">min_radius</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="CenterDetermination-1108"><a href="#CenterDetermination-1108"><span class="linenos">1108</span></a>        <span class="n">max_radius</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="CenterDetermination-1109"><a href="#CenterDetermination-1109"><span class="linenos">1109</span></a>        <span class="n">radius_step</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="CenterDetermination-1110"><a href="#CenterDetermination-1110"><span class="linenos">1110</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span> <span class="o">+</span> <span class="n">radius_step</span><span class="p">,</span> <span class="n">radius_step</span><span class="p">)</span>
</span><span id="CenterDetermination-1111"><a href="#CenterDetermination-1111"><span class="linenos">1111</span></a>
</span><span id="CenterDetermination-1112"><a href="#CenterDetermination-1112"><span class="linenos">1112</span></a>        <span class="c1">### Perform the Hough transform to detect circles</span>
</span><span id="CenterDetermination-1113"><a href="#CenterDetermination-1113"><span class="linenos">1113</span></a>        <span class="c1"># Circle detection involves converting edge pixels into parameter space, </span>
</span><span id="CenterDetermination-1114"><a href="#CenterDetermination-1114"><span class="linenos">1114</span></a>        <span class="c1"># where each point represents a possible circle center and radius. </span>
</span><span id="CenterDetermination-1115"><a href="#CenterDetermination-1115"><span class="linenos">1115</span></a>        <span class="c1"># The circles are then identified as peaks in the parameter space, </span>
</span><span id="CenterDetermination-1116"><a href="#CenterDetermination-1116"><span class="linenos">1116</span></a>        <span class="c1"># enabling accurate detection of circular shapes in the image.</span>
</span><span id="CenterDetermination-1117"><a href="#CenterDetermination-1117"><span class="linenos">1117</span></a>        <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>
</span><span id="CenterDetermination-1118"><a href="#CenterDetermination-1118"><span class="linenos">1118</span></a>
</span><span id="CenterDetermination-1119"><a href="#CenterDetermination-1119"><span class="linenos">1119</span></a>        <span class="c1"># Extract the circle peaks</span>
</span><span id="CenterDetermination-1120"><a href="#CenterDetermination-1120"><span class="linenos">1120</span></a>        <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> 
</span><span id="CenterDetermination-1121"><a href="#CenterDetermination-1121"><span class="linenos">1121</span></a>                                                            <span class="n">radii</span><span class="p">,</span> 
</span><span id="CenterDetermination-1122"><a href="#CenterDetermination-1122"><span class="linenos">1122</span></a>                                                            <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1123"><a href="#CenterDetermination-1123"><span class="linenos">1123</span></a>        
</span><span id="CenterDetermination-1124"><a href="#CenterDetermination-1124"><span class="linenos">1124</span></a>        
</span><span id="CenterDetermination-1125"><a href="#CenterDetermination-1125"><span class="linenos">1125</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination-1126"><a href="#CenterDetermination-1126"><span class="linenos">1126</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination-1127"><a href="#CenterDetermination-1127"><span class="linenos">1127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (HoughTransform) : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-1128"><a href="#CenterDetermination-1128"><span class="linenos">1128</span></a>        
</span><span id="CenterDetermination-1129"><a href="#CenterDetermination-1129"><span class="linenos">1129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> \
</span><span id="CenterDetermination-1130"><a href="#CenterDetermination-1130"><span class="linenos">1130</span></a>            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination-1131"><a href="#CenterDetermination-1131"><span class="linenos">1131</span></a>
</span><span id="CenterDetermination-1132"><a href="#CenterDetermination-1132"><span class="linenos">1132</span></a>        <span class="c1"># (7) Plot results (if required)</span>
</span><span id="CenterDetermination-1133"><a href="#CenterDetermination-1133"><span class="linenos">1133</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1134"><a href="#CenterDetermination-1134"><span class="linenos">1134</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="CenterDetermination-1135"><a href="#CenterDetermination-1135"><span class="linenos">1135</span></a>           
</span><span id="CenterDetermination-1136"><a href="#CenterDetermination-1136"><span class="linenos">1136</span></a>        <span class="c1"># Return results, convert coordinates to float</span>
</span><span id="CenterDetermination-1137"><a href="#CenterDetermination-1137"><span class="linenos">1137</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterDetermination-1138"><a href="#CenterDetermination-1138"><span class="linenos">1138</span></a>
</span><span id="CenterDetermination-1139"><a href="#CenterDetermination-1139"><span class="linenos">1139</span></a>   
</span><span id="CenterDetermination-1140"><a href="#CenterDetermination-1140"><span class="linenos">1140</span></a>    <span class="k">def</span> <span class="nf">detection_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination-1141"><a href="#CenterDetermination-1141"><span class="linenos">1141</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination-1142"><a href="#CenterDetermination-1142"><span class="linenos">1142</span></a><span class="sd">        In the input image, select manually 3 points defining a circle using</span>
</span><span id="CenterDetermination-1143"><a href="#CenterDetermination-1143"><span class="linenos">1143</span></a><span class="sd">        a key press event </span>
</span><span id="CenterDetermination-1144"><a href="#CenterDetermination-1144"><span class="linenos">1144</span></a><span class="sd">            - press &#39;1&#39; to select a point</span>
</span><span id="CenterDetermination-1145"><a href="#CenterDetermination-1145"><span class="linenos">1145</span></a><span class="sd">                </span>
</span><span id="CenterDetermination-1146"><a href="#CenterDetermination-1146"><span class="linenos">1146</span></a><span class="sd">        If the user is not satisfied with the point selection, it can be</span>
</span><span id="CenterDetermination-1147"><a href="#CenterDetermination-1147"><span class="linenos">1147</span></a><span class="sd">        deleted using a key press event:</span>
</span><span id="CenterDetermination-1148"><a href="#CenterDetermination-1148"><span class="linenos">1148</span></a><span class="sd">            - press &#39;2&#39; to delete the most recent</span>
</span><span id="CenterDetermination-1149"><a href="#CenterDetermination-1149"><span class="linenos">1149</span></a><span class="sd">            - press &#39;3&#39; to delete the point closest to the cursor</span>
</span><span id="CenterDetermination-1150"><a href="#CenterDetermination-1150"><span class="linenos">1150</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1151"><a href="#CenterDetermination-1151"><span class="linenos">1151</span></a><span class="sd">        If the user is satisified with the points selected, the rest </span>
</span><span id="CenterDetermination-1152"><a href="#CenterDetermination-1152"><span class="linenos">1152</span></a><span class="sd">        of the program will be executed </span>
</span><span id="CenterDetermination-1153"><a href="#CenterDetermination-1153"><span class="linenos">1153</span></a><span class="sd">            - press &#39;d&#39; to proceed &gt;DONE&lt;</span>
</span><span id="CenterDetermination-1154"><a href="#CenterDetermination-1154"><span class="linenos">1154</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1155"><a href="#CenterDetermination-1155"><span class="linenos">1155</span></a><span class="sd">        Coordinates of the center and radius will be calculated automatically</span>
</span><span id="CenterDetermination-1156"><a href="#CenterDetermination-1156"><span class="linenos">1156</span></a><span class="sd">        using method self.calculate_circle()</span>
</span><span id="CenterDetermination-1157"><a href="#CenterDetermination-1157"><span class="linenos">1157</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1158"><a href="#CenterDetermination-1158"><span class="linenos">1158</span></a><span class="sd">        In addition, the user will be able to manually adjust the original</span>
</span><span id="CenterDetermination-1159"><a href="#CenterDetermination-1159"><span class="linenos">1159</span></a><span class="sd">        center position by using pre-defined keys.</span>
</span><span id="CenterDetermination-1160"><a href="#CenterDetermination-1160"><span class="linenos">1160</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1161"><a href="#CenterDetermination-1161"><span class="linenos">1161</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1162"><a href="#CenterDetermination-1162"><span class="linenos">1162</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1163"><a href="#CenterDetermination-1163"><span class="linenos">1163</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination-1164"><a href="#CenterDetermination-1164"><span class="linenos">1164</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="CenterDetermination-1165"><a href="#CenterDetermination-1165"><span class="linenos">1165</span></a><span class="sd">            Default is 1. To cancel visualization, set plot_results = 0.</span>
</span><span id="CenterDetermination-1166"><a href="#CenterDetermination-1166"><span class="linenos">1166</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1167"><a href="#CenterDetermination-1167"><span class="linenos">1167</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1168"><a href="#CenterDetermination-1168"><span class="linenos">1168</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1169"><a href="#CenterDetermination-1169"><span class="linenos">1169</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination-1170"><a href="#CenterDetermination-1170"><span class="linenos">1170</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination-1171"><a href="#CenterDetermination-1171"><span class="linenos">1171</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination-1172"><a href="#CenterDetermination-1172"><span class="linenos">1172</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination-1173"><a href="#CenterDetermination-1173"><span class="linenos">1173</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination-1174"><a href="#CenterDetermination-1174"><span class="linenos">1174</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination-1175"><a href="#CenterDetermination-1175"><span class="linenos">1175</span></a><span class="sd">            (if available, othervise returns None)</span>
</span><span id="CenterDetermination-1176"><a href="#CenterDetermination-1176"><span class="linenos">1176</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination-1177"><a href="#CenterDetermination-1177"><span class="linenos">1177</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1178"><a href="#CenterDetermination-1178"><span class="linenos">1178</span></a>        
</span><span id="CenterDetermination-1179"><a href="#CenterDetermination-1179"><span class="linenos">1179</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterDetermination-1180"><a href="#CenterDetermination-1180"><span class="linenos">1180</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span>
</span><span id="CenterDetermination-1181"><a href="#CenterDetermination-1181"><span class="linenos">1181</span></a>        
</span><span id="CenterDetermination-1182"><a href="#CenterDetermination-1182"><span class="linenos">1182</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterDetermination-1183"><a href="#CenterDetermination-1183"><span class="linenos">1183</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-1184"><a href="#CenterDetermination-1184"><span class="linenos">1184</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1185"><a href="#CenterDetermination-1185"><span class="linenos">1185</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1186"><a href="#CenterDetermination-1186"><span class="linenos">1186</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination-1187"><a href="#CenterDetermination-1187"><span class="linenos">1187</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination-1188"><a href="#CenterDetermination-1188"><span class="linenos">1188</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination-1189"><a href="#CenterDetermination-1189"><span class="linenos">1189</span></a>            
</span><span id="CenterDetermination-1190"><a href="#CenterDetermination-1190"><span class="linenos">1190</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterDetermination-1191"><a href="#CenterDetermination-1191"><span class="linenos">1191</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="CenterDetermination-1192"><a href="#CenterDetermination-1192"><span class="linenos">1192</span></a>        
</span><span id="CenterDetermination-1193"><a href="#CenterDetermination-1193"><span class="linenos">1193</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination-1194"><a href="#CenterDetermination-1194"><span class="linenos">1194</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1195"><a href="#CenterDetermination-1195"><span class="linenos">1195</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1196"><a href="#CenterDetermination-1196"><span class="linenos">1196</span></a> 
</span><span id="CenterDetermination-1197"><a href="#CenterDetermination-1197"><span class="linenos">1197</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Select 3 points defining one of diffraction circles&quot;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1198"><a href="#CenterDetermination-1198"><span class="linenos">1198</span></a>                  <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-1199"><a href="#CenterDetermination-1199"><span class="linenos">1199</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1200"><a href="#CenterDetermination-1200"><span class="linenos">1200</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1201"><a href="#CenterDetermination-1201"><span class="linenos">1201</span></a>
</span><span id="CenterDetermination-1202"><a href="#CenterDetermination-1202"><span class="linenos">1202</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination-1203"><a href="#CenterDetermination-1203"><span class="linenos">1203</span></a>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination-1204"><a href="#CenterDetermination-1204"><span class="linenos">1204</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1205"><a href="#CenterDetermination-1205"><span class="linenos">1205</span></a><span class="sd">            CenterDetermination :: ThreePoints (semi-automated method)</span>
</span><span id="CenterDetermination-1206"><a href="#CenterDetermination-1206"><span class="linenos">1206</span></a><span class="sd">            Select 3 points to define a diffraction circle using keys:</span>
</span><span id="CenterDetermination-1207"><a href="#CenterDetermination-1207"><span class="linenos">1207</span></a><span class="sd">              - &#39;1&#39; : define a point at current cursor position</span>
</span><span id="CenterDetermination-1208"><a href="#CenterDetermination-1208"><span class="linenos">1208</span></a><span class="sd">              - &#39;2&#39; : delete the last point</span>
</span><span id="CenterDetermination-1209"><a href="#CenterDetermination-1209"><span class="linenos">1209</span></a><span class="sd">              - &#39;3&#39; : delete the point closest to the cursor</span>
</span><span id="CenterDetermination-1210"><a href="#CenterDetermination-1210"><span class="linenos">1210</span></a><span class="sd">              - &#39;d&#39; : done = finished = go to the next step</span>
</span><span id="CenterDetermination-1211"><a href="#CenterDetermination-1211"><span class="linenos">1211</span></a><span class="sd">            Close the figure to terminate. No center will be detected.</span>
</span><span id="CenterDetermination-1212"><a href="#CenterDetermination-1212"><span class="linenos">1212</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1213"><a href="#CenterDetermination-1213"><span class="linenos">1213</span></a>
</span><span id="CenterDetermination-1214"><a href="#CenterDetermination-1214"><span class="linenos">1214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1215"><a href="#CenterDetermination-1215"><span class="linenos">1215</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination-1216"><a href="#CenterDetermination-1216"><span class="linenos">1216</span></a>       
</span><span id="CenterDetermination-1217"><a href="#CenterDetermination-1217"><span class="linenos">1217</span></a>        <span class="c1"># Enable interactive mode</span>
</span><span id="CenterDetermination-1218"><a href="#CenterDetermination-1218"><span class="linenos">1218</span></a>        <span class="c1"># (figure is updated after every plotting command</span>
</span><span id="CenterDetermination-1219"><a href="#CenterDetermination-1219"><span class="linenos">1219</span></a>        <span class="c1"># (so that calling figure.show() is not necessary</span>
</span><span id="CenterDetermination-1220"><a href="#CenterDetermination-1220"><span class="linenos">1220</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination-1221"><a href="#CenterDetermination-1221"><span class="linenos">1221</span></a> 
</span><span id="CenterDetermination-1222"><a href="#CenterDetermination-1222"><span class="linenos">1222</span></a>        <span class="c1"># Initialize the list of coordinates</span>
</span><span id="CenterDetermination-1223"><a href="#CenterDetermination-1223"><span class="linenos">1223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span> 
</span><span id="CenterDetermination-1224"><a href="#CenterDetermination-1224"><span class="linenos">1224</span></a>        
</span><span id="CenterDetermination-1225"><a href="#CenterDetermination-1225"><span class="linenos">1225</span></a>        <span class="c1"># Initialize all flags and counters</span>
</span><span id="CenterDetermination-1226"><a href="#CenterDetermination-1226"><span class="linenos">1226</span></a>        <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># press &#39;d&#39; event</span>
</span><span id="CenterDetermination-1227"><a href="#CenterDetermination-1227"><span class="linenos">1227</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># close window event</span>
</span><span id="CenterDetermination-1228"><a href="#CenterDetermination-1228"><span class="linenos">1228</span></a>        <span class="n">point_counter</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># number of selected points</span>
</span><span id="CenterDetermination-1229"><a href="#CenterDetermination-1229"><span class="linenos">1229</span></a>        
</span><span id="CenterDetermination-1230"><a href="#CenterDetermination-1230"><span class="linenos">1230</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterDetermination-1231"><a href="#CenterDetermination-1231"><span class="linenos">1231</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-1232"><a href="#CenterDetermination-1232"><span class="linenos">1232</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-1233"><a href="#CenterDetermination-1233"><span class="linenos">1233</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-1234"><a href="#CenterDetermination-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1235"><a href="#CenterDetermination-1235"><span class="linenos">1235</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execution terminated.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1236"><a href="#CenterDetermination-1236"><span class="linenos">1236</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1237"><a href="#CenterDetermination-1237"><span class="linenos">1237</span></a>
</span><span id="CenterDetermination-1238"><a href="#CenterDetermination-1238"><span class="linenos">1238</span></a> 
</span><span id="CenterDetermination-1239"><a href="#CenterDetermination-1239"><span class="linenos">1239</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination-1240"><a href="#CenterDetermination-1240"><span class="linenos">1240</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination-1241"><a href="#CenterDetermination-1241"><span class="linenos">1241</span></a>        
</span><span id="CenterDetermination-1242"><a href="#CenterDetermination-1242"><span class="linenos">1242</span></a>        
</span><span id="CenterDetermination-1243"><a href="#CenterDetermination-1243"><span class="linenos">1243</span></a>        <span class="c1">### Define the callback function for key press events</span>
</span><span id="CenterDetermination-1244"><a href="#CenterDetermination-1244"><span class="linenos">1244</span></a>        <span class="k">def</span> <span class="nf">onkeypress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-1245"><a href="#CenterDetermination-1245"><span class="linenos">1245</span></a>            <span class="c1"># nonlocal to modify the flag variable in the outer scope</span>
</span><span id="CenterDetermination-1246"><a href="#CenterDetermination-1246"><span class="linenos">1246</span></a>            <span class="k">nonlocal</span> <span class="n">calculate_circle_flag</span><span class="p">,</span> <span class="n">point_counter</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-1247"><a href="#CenterDetermination-1247"><span class="linenos">1247</span></a>            
</span><span id="CenterDetermination-1248"><a href="#CenterDetermination-1248"><span class="linenos">1248</span></a>            <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination-1249"><a href="#CenterDetermination-1249"><span class="linenos">1249</span></a>            <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination-1250"><a href="#CenterDetermination-1250"><span class="linenos">1250</span></a>            <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination-1251"><a href="#CenterDetermination-1251"><span class="linenos">1251</span></a> 
</span><span id="CenterDetermination-1252"><a href="#CenterDetermination-1252"><span class="linenos">1252</span></a>            <span class="c1">## Delete points -- the closest to the cursor</span>
</span><span id="CenterDetermination-1253"><a href="#CenterDetermination-1253"><span class="linenos">1253</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1254"><a href="#CenterDetermination-1254"><span class="linenos">1254</span></a>                <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-1255"><a href="#CenterDetermination-1255"><span class="linenos">1255</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-1256"><a href="#CenterDetermination-1256"><span class="linenos">1256</span></a>                    <span class="n">pointer_x</span><span class="p">,</span> <span class="n">pointer_y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
</span><span id="CenterDetermination-1257"><a href="#CenterDetermination-1257"><span class="linenos">1257</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CenterDetermination-1258"><a href="#CenterDetermination-1258"><span class="linenos">1258</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">pointer_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">pointer_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1259"><a href="#CenterDetermination-1259"><span class="linenos">1259</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">]</span>
</span><span id="CenterDetermination-1260"><a href="#CenterDetermination-1260"><span class="linenos">1260</span></a>                    <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
</span><span id="CenterDetermination-1261"><a href="#CenterDetermination-1261"><span class="linenos">1261</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">closest_index</span><span class="p">]</span>
</span><span id="CenterDetermination-1262"><a href="#CenterDetermination-1262"><span class="linenos">1262</span></a>    
</span><span id="CenterDetermination-1263"><a href="#CenterDetermination-1263"><span class="linenos">1263</span></a>                    <span class="c1">## Redraw the image without the deleted point</span>
</span><span id="CenterDetermination-1264"><a href="#CenterDetermination-1264"><span class="linenos">1264</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination-1265"><a href="#CenterDetermination-1265"><span class="linenos">1265</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-1266"><a href="#CenterDetermination-1266"><span class="linenos">1266</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1267"><a href="#CenterDetermination-1267"><span class="linenos">1267</span></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination-1268"><a href="#CenterDetermination-1268"><span class="linenos">1268</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination-1269"><a href="#CenterDetermination-1269"><span class="linenos">1269</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1270"><a href="#CenterDetermination-1270"><span class="linenos">1270</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination-1271"><a href="#CenterDetermination-1271"><span class="linenos">1271</span></a>
</span><span id="CenterDetermination-1272"><a href="#CenterDetermination-1272"><span class="linenos">1272</span></a>                    <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination-1273"><a href="#CenterDetermination-1273"><span class="linenos">1273</span></a>                        <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination-1274"><a href="#CenterDetermination-1274"><span class="linenos">1274</span></a>                        <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1275"><a href="#CenterDetermination-1275"><span class="linenos">1275</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-1276"><a href="#CenterDetermination-1276"><span class="linenos">1276</span></a>                    
</span><span id="CenterDetermination-1277"><a href="#CenterDetermination-1277"><span class="linenos">1277</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination-1278"><a href="#CenterDetermination-1278"><span class="linenos">1278</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-1279"><a href="#CenterDetermination-1279"><span class="linenos">1279</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-1280"><a href="#CenterDetermination-1280"><span class="linenos">1280</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1281"><a href="#CenterDetermination-1281"><span class="linenos">1281</span></a>                    
</span><span id="CenterDetermination-1282"><a href="#CenterDetermination-1282"><span class="linenos">1282</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-1283"><a href="#CenterDetermination-1283"><span class="linenos">1283</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1284"><a href="#CenterDetermination-1284"><span class="linenos">1284</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1285"><a href="#CenterDetermination-1285"><span class="linenos">1285</span></a>    
</span><span id="CenterDetermination-1286"><a href="#CenterDetermination-1286"><span class="linenos">1286</span></a>            <span class="c1"># Delete recent point (last added) -- independent on the cursor</span>
</span><span id="CenterDetermination-1287"><a href="#CenterDetermination-1287"><span class="linenos">1287</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1288"><a href="#CenterDetermination-1288"><span class="linenos">1288</span></a>                <span class="c1"># Check if there are points to delete</span>
</span><span id="CenterDetermination-1289"><a href="#CenterDetermination-1289"><span class="linenos">1289</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span><span id="CenterDetermination-1290"><a href="#CenterDetermination-1290"><span class="linenos">1290</span></a>                    <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-1291"><a href="#CenterDetermination-1291"><span class="linenos">1291</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination-1292"><a href="#CenterDetermination-1292"><span class="linenos">1292</span></a>                        <span class="c1"># Delete the last point in the list</span>
</span><span id="CenterDetermination-1293"><a href="#CenterDetermination-1293"><span class="linenos">1293</span></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination-1294"><a href="#CenterDetermination-1294"><span class="linenos">1294</span></a>    
</span><span id="CenterDetermination-1295"><a href="#CenterDetermination-1295"><span class="linenos">1295</span></a>                        <span class="c1"># Redraw the image without the deleted point</span>
</span><span id="CenterDetermination-1296"><a href="#CenterDetermination-1296"><span class="linenos">1296</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination-1297"><a href="#CenterDetermination-1297"><span class="linenos">1297</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-1298"><a href="#CenterDetermination-1298"><span class="linenos">1298</span></a>                                  <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1299"><a href="#CenterDetermination-1299"><span class="linenos">1299</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination-1300"><a href="#CenterDetermination-1300"><span class="linenos">1300</span></a>                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination-1301"><a href="#CenterDetermination-1301"><span class="linenos">1301</span></a>                                       <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1302"><a href="#CenterDetermination-1302"><span class="linenos">1302</span></a>                                       <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination-1303"><a href="#CenterDetermination-1303"><span class="linenos">1303</span></a>
</span><span id="CenterDetermination-1304"><a href="#CenterDetermination-1304"><span class="linenos">1304</span></a>                        <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination-1305"><a href="#CenterDetermination-1305"><span class="linenos">1305</span></a>                            <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination-1306"><a href="#CenterDetermination-1306"><span class="linenos">1306</span></a>                            <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1307"><a href="#CenterDetermination-1307"><span class="linenos">1307</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">)</span>
</span><span id="CenterDetermination-1308"><a href="#CenterDetermination-1308"><span class="linenos">1308</span></a>                        
</span><span id="CenterDetermination-1309"><a href="#CenterDetermination-1309"><span class="linenos">1309</span></a>                        <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination-1310"><a href="#CenterDetermination-1310"><span class="linenos">1310</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-1311"><a href="#CenterDetermination-1311"><span class="linenos">1311</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-1312"><a href="#CenterDetermination-1312"><span class="linenos">1312</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1313"><a href="#CenterDetermination-1313"><span class="linenos">1313</span></a>
</span><span id="CenterDetermination-1314"><a href="#CenterDetermination-1314"><span class="linenos">1314</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-1315"><a href="#CenterDetermination-1315"><span class="linenos">1315</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1316"><a href="#CenterDetermination-1316"><span class="linenos">1316</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1317"><a href="#CenterDetermination-1317"><span class="linenos">1317</span></a>                    
</span><span id="CenterDetermination-1318"><a href="#CenterDetermination-1318"><span class="linenos">1318</span></a>            <span class="c1">## Select points </span>
</span><span id="CenterDetermination-1319"><a href="#CenterDetermination-1319"><span class="linenos">1319</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1320"><a href="#CenterDetermination-1320"><span class="linenos">1320</span></a>                <span class="c1"># Only allow selecting up to three points</span>
</span><span id="CenterDetermination-1321"><a href="#CenterDetermination-1321"><span class="linenos">1321</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  
</span><span id="CenterDetermination-1322"><a href="#CenterDetermination-1322"><span class="linenos">1322</span></a>                    <span class="c1"># Save the coordinates of the clicked point</span>
</span><span id="CenterDetermination-1323"><a href="#CenterDetermination-1323"><span class="linenos">1323</span></a>                    <span class="n">new_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</span><span id="CenterDetermination-1324"><a href="#CenterDetermination-1324"><span class="linenos">1324</span></a>                    
</span><span id="CenterDetermination-1325"><a href="#CenterDetermination-1325"><span class="linenos">1325</span></a>                    <span class="k">if</span> <span class="n">new_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination-1326"><a href="#CenterDetermination-1326"><span class="linenos">1326</span></a>                        <span class="c1"># Do not allow multiple selection of one point</span>
</span><span id="CenterDetermination-1327"><a href="#CenterDetermination-1327"><span class="linenos">1327</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The selected point already exists.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1328"><a href="#CenterDetermination-1328"><span class="linenos">1328</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1329"><a href="#CenterDetermination-1329"><span class="linenos">1329</span></a>                        <span class="c1"># Add selected point</span>
</span><span id="CenterDetermination-1330"><a href="#CenterDetermination-1330"><span class="linenos">1330</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
</span><span id="CenterDetermination-1331"><a href="#CenterDetermination-1331"><span class="linenos">1331</span></a>    
</span><span id="CenterDetermination-1332"><a href="#CenterDetermination-1332"><span class="linenos">1332</span></a>                        <span class="c1"># Visualize the selected point on the image</span>
</span><span id="CenterDetermination-1333"><a href="#CenterDetermination-1333"><span class="linenos">1333</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="CenterDetermination-1334"><a href="#CenterDetermination-1334"><span class="linenos">1334</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1335"><a href="#CenterDetermination-1335"><span class="linenos">1335</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination-1336"><a href="#CenterDetermination-1336"><span class="linenos">1336</span></a>
</span><span id="CenterDetermination-1337"><a href="#CenterDetermination-1337"><span class="linenos">1337</span></a>                        <span class="c1"># Restore the previous zoom level</span>
</span><span id="CenterDetermination-1338"><a href="#CenterDetermination-1338"><span class="linenos">1338</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-1339"><a href="#CenterDetermination-1339"><span class="linenos">1339</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-1340"><a href="#CenterDetermination-1340"><span class="linenos">1340</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1341"><a href="#CenterDetermination-1341"><span class="linenos">1341</span></a>
</span><span id="CenterDetermination-1342"><a href="#CenterDetermination-1342"><span class="linenos">1342</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-1343"><a href="#CenterDetermination-1343"><span class="linenos">1343</span></a>    
</span><span id="CenterDetermination-1344"><a href="#CenterDetermination-1344"><span class="linenos">1344</span></a>                        <span class="n">point_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterDetermination-1345"><a href="#CenterDetermination-1345"><span class="linenos">1345</span></a>
</span><span id="CenterDetermination-1346"><a href="#CenterDetermination-1346"><span class="linenos">1346</span></a>    
</span><span id="CenterDetermination-1347"><a href="#CenterDetermination-1347"><span class="linenos">1347</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination-1348"><a href="#CenterDetermination-1348"><span class="linenos">1348</span></a>                    <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination-1349"><a href="#CenterDetermination-1349"><span class="linenos">1349</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination-1350"><a href="#CenterDetermination-1350"><span class="linenos">1350</span></a>    
</span><span id="CenterDetermination-1351"><a href="#CenterDetermination-1351"><span class="linenos">1351</span></a>
</span><span id="CenterDetermination-1352"><a href="#CenterDetermination-1352"><span class="linenos">1352</span></a>    
</span><span id="CenterDetermination-1353"><a href="#CenterDetermination-1353"><span class="linenos">1353</span></a>            <span class="c1"># Calculate circle or terminate</span>
</span><span id="CenterDetermination-1354"><a href="#CenterDetermination-1354"><span class="linenos">1354</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1355"><a href="#CenterDetermination-1355"><span class="linenos">1355</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination-1356"><a href="#CenterDetermination-1356"><span class="linenos">1356</span></a>                    <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-1357"><a href="#CenterDetermination-1357"><span class="linenos">1357</span></a> 
</span><span id="CenterDetermination-1358"><a href="#CenterDetermination-1358"><span class="linenos">1358</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1359"><a href="#CenterDetermination-1359"><span class="linenos">1359</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select exactly 3 points to calculate the circle.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1360"><a href="#CenterDetermination-1360"><span class="linenos">1360</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-1361"><a href="#CenterDetermination-1361"><span class="linenos">1361</span></a>    
</span><span id="CenterDetermination-1362"><a href="#CenterDetermination-1362"><span class="linenos">1362</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination-1363"><a href="#CenterDetermination-1363"><span class="linenos">1363</span></a>        <span class="n">cid0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress</span><span class="p">)</span>
</span><span id="CenterDetermination-1364"><a href="#CenterDetermination-1364"><span class="linenos">1364</span></a>
</span><span id="CenterDetermination-1365"><a href="#CenterDetermination-1365"><span class="linenos">1365</span></a>        <span class="c1"># Show the plot</span>
</span><span id="CenterDetermination-1366"><a href="#CenterDetermination-1366"><span class="linenos">1366</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1367"><a href="#CenterDetermination-1367"><span class="linenos">1367</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1368"><a href="#CenterDetermination-1368"><span class="linenos">1368</span></a>
</span><span id="CenterDetermination-1369"><a href="#CenterDetermination-1369"><span class="linenos">1369</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1370"><a href="#CenterDetermination-1370"><span class="linenos">1370</span></a>      
</span><span id="CenterDetermination-1371"><a href="#CenterDetermination-1371"><span class="linenos">1371</span></a>        <span class="c1"># Wait for &#39;d&#39; key event or close the figure if no points are selected</span>
</span><span id="CenterDetermination-1372"><a href="#CenterDetermination-1372"><span class="linenos">1372</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">calculate_circle_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination-1373"><a href="#CenterDetermination-1373"><span class="linenos">1373</span></a> 
</span><span id="CenterDetermination-1374"><a href="#CenterDetermination-1374"><span class="linenos">1374</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination-1375"><a href="#CenterDetermination-1375"><span class="linenos">1375</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination-1376"><a href="#CenterDetermination-1376"><span class="linenos">1376</span></a>                <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination-1377"><a href="#CenterDetermination-1377"><span class="linenos">1377</span></a>                <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination-1378"><a href="#CenterDetermination-1378"><span class="linenos">1378</span></a>                <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination-1379"><a href="#CenterDetermination-1379"><span class="linenos">1379</span></a> 
</span><span id="CenterDetermination-1380"><a href="#CenterDetermination-1380"><span class="linenos">1380</span></a>                <span class="c1"># Plot detected diffraction pattern</span>
</span><span id="CenterDetermination-1381"><a href="#CenterDetermination-1381"><span class="linenos">1381</span></a>                <span class="k">if</span> <span class="n">calculate_circle_flag</span><span class="p">:</span>
</span><span id="CenterDetermination-1382"><a href="#CenterDetermination-1382"><span class="linenos">1382</span></a> 
</span><span id="CenterDetermination-1383"><a href="#CenterDetermination-1383"><span class="linenos">1383</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_circle</span><span class="p">(</span><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination-1384"><a href="#CenterDetermination-1384"><span class="linenos">1384</span></a>                    
</span><span id="CenterDetermination-1385"><a href="#CenterDetermination-1385"><span class="linenos">1385</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination-1386"><a href="#CenterDetermination-1386"><span class="linenos">1386</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-1387"><a href="#CenterDetermination-1387"><span class="linenos">1387</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1388"><a href="#CenterDetermination-1388"><span class="linenos">1388</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination-1389"><a href="#CenterDetermination-1389"><span class="linenos">1389</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination-1390"><a href="#CenterDetermination-1390"><span class="linenos">1390</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination-1391"><a href="#CenterDetermination-1391"><span class="linenos">1391</span></a>                 
</span><span id="CenterDetermination-1392"><a href="#CenterDetermination-1392"><span class="linenos">1392</span></a>                    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterDetermination-1393"><a href="#CenterDetermination-1393"><span class="linenos">1393</span></a>                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1394"><a href="#CenterDetermination-1394"><span class="linenos">1394</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination-1395"><a href="#CenterDetermination-1395"><span class="linenos">1395</span></a>        
</span><span id="CenterDetermination-1396"><a href="#CenterDetermination-1396"><span class="linenos">1396</span></a>                    <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination-1397"><a href="#CenterDetermination-1397"><span class="linenos">1397</span></a>                    <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination-1398"><a href="#CenterDetermination-1398"><span class="linenos">1398</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the position of the center using keys.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1399"><a href="#CenterDetermination-1399"><span class="linenos">1399</span></a>        
</span><span id="CenterDetermination-1400"><a href="#CenterDetermination-1400"><span class="linenos">1400</span></a>                    <span class="c1"># Display the image</span>
</span><span id="CenterDetermination-1401"><a href="#CenterDetermination-1401"><span class="linenos">1401</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-1402"><a href="#CenterDetermination-1402"><span class="linenos">1402</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1403"><a href="#CenterDetermination-1403"><span class="linenos">1403</span></a>
</span><span id="CenterDetermination-1404"><a href="#CenterDetermination-1404"><span class="linenos">1404</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1405"><a href="#CenterDetermination-1405"><span class="linenos">1405</span></a>
</span><span id="CenterDetermination-1406"><a href="#CenterDetermination-1406"><span class="linenos">1406</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination-1407"><a href="#CenterDetermination-1407"><span class="linenos">1407</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution manually interrupted by user.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1408"><a href="#CenterDetermination-1408"><span class="linenos">1408</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination-1409"><a href="#CenterDetermination-1409"><span class="linenos">1409</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="CenterDetermination-1410"><a href="#CenterDetermination-1410"><span class="linenos">1410</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ValueError:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="CenterDetermination-1411"><a href="#CenterDetermination-1411"><span class="linenos">1411</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination-1412"><a href="#CenterDetermination-1412"><span class="linenos">1412</span></a>           
</span><span id="CenterDetermination-1413"><a href="#CenterDetermination-1413"><span class="linenos">1413</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination-1414"><a href="#CenterDetermination-1414"><span class="linenos">1414</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination-1415"><a href="#CenterDetermination-1415"><span class="linenos">1415</span></a>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points selected. Returned None values.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1416"><a href="#CenterDetermination-1416"><span class="linenos">1416</span></a>             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterDetermination-1417"><a href="#CenterDetermination-1417"><span class="linenos">1417</span></a>             <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1418"><a href="#CenterDetermination-1418"><span class="linenos">1418</span></a>        
</span><span id="CenterDetermination-1419"><a href="#CenterDetermination-1419"><span class="linenos">1419</span></a>        <span class="c1"># Disconnect key press events</span>
</span><span id="CenterDetermination-1420"><a href="#CenterDetermination-1420"><span class="linenos">1420</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">cid0</span><span class="p">)</span> 
</span><span id="CenterDetermination-1421"><a href="#CenterDetermination-1421"><span class="linenos">1421</span></a>        
</span><span id="CenterDetermination-1422"><a href="#CenterDetermination-1422"><span class="linenos">1422</span></a>        <span class="c1"># local variables save</span>
</span><span id="CenterDetermination-1423"><a href="#CenterDetermination-1423"><span class="linenos">1423</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
</span><span id="CenterDetermination-1424"><a href="#CenterDetermination-1424"><span class="linenos">1424</span></a>        
</span><span id="CenterDetermination-1425"><a href="#CenterDetermination-1425"><span class="linenos">1425</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]</span>
</span><span id="CenterDetermination-1426"><a href="#CenterDetermination-1426"><span class="linenos">1426</span></a>        <span class="c1"># Manually adjust the calculated center coordinates</span>
</span><span id="CenterDetermination-1427"><a href="#CenterDetermination-1427"><span class="linenos">1427</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjustment_3points</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
</span><span id="CenterDetermination-1428"><a href="#CenterDetermination-1428"><span class="linenos">1428</span></a>
</span><span id="CenterDetermination-1429"><a href="#CenterDetermination-1429"><span class="linenos">1429</span></a>        <span class="c1"># Return the results:</span>
</span><span id="CenterDetermination-1430"><a href="#CenterDetermination-1430"><span class="linenos">1430</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="CenterDetermination-1431"><a href="#CenterDetermination-1431"><span class="linenos">1431</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination-1432"><a href="#CenterDetermination-1432"><span class="linenos">1432</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="CenterDetermination-1433"><a href="#CenterDetermination-1433"><span class="linenos">1433</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-1434"><a href="#CenterDetermination-1434"><span class="linenos">1434</span></a>    
</span><span id="CenterDetermination-1435"><a href="#CenterDetermination-1435"><span class="linenos">1435</span></a>    
</span><span id="CenterDetermination-1436"><a href="#CenterDetermination-1436"><span class="linenos">1436</span></a>    <span class="k">def</span> <span class="nf">adjustment_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="CenterDetermination-1437"><a href="#CenterDetermination-1437"><span class="linenos">1437</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1438"><a href="#CenterDetermination-1438"><span class="linenos">1438</span></a><span class="sd">        Adjustment of the center position calculated from 3 points.</span>
</span><span id="CenterDetermination-1439"><a href="#CenterDetermination-1439"><span class="linenos">1439</span></a><span class="sd">        Interactive refinement using keys:</span>
</span><span id="CenterDetermination-1440"><a href="#CenterDetermination-1440"><span class="linenos">1440</span></a>
</span><span id="CenterDetermination-1441"><a href="#CenterDetermination-1441"><span class="linenos">1441</span></a><span class="sd">        The user can change the position of the center of the diffraction</span>
</span><span id="CenterDetermination-1442"><a href="#CenterDetermination-1442"><span class="linenos">1442</span></a><span class="sd">        pattern and also the radius of the detected pattern using keys:</span>
</span><span id="CenterDetermination-1443"><a href="#CenterDetermination-1443"><span class="linenos">1443</span></a><span class="sd">            - left / right / top / down arrows : move left / right / top / down</span>
</span><span id="CenterDetermination-1444"><a href="#CenterDetermination-1444"><span class="linenos">1444</span></a><span class="sd">            - &#39;+&#39; : increase radius</span>
</span><span id="CenterDetermination-1445"><a href="#CenterDetermination-1445"><span class="linenos">1445</span></a><span class="sd">            - &#39;-&#39; : decrease radius</span>
</span><span id="CenterDetermination-1446"><a href="#CenterDetermination-1446"><span class="linenos">1446</span></a><span class="sd">            - &#39;d&#39; : done, termination of the refinement</span>
</span><span id="CenterDetermination-1447"><a href="#CenterDetermination-1447"><span class="linenos">1447</span></a>
</span><span id="CenterDetermination-1448"><a href="#CenterDetermination-1448"><span class="linenos">1448</span></a><span class="sd">        If the interactive figure is closed without any modifications,</span>
</span><span id="CenterDetermination-1449"><a href="#CenterDetermination-1449"><span class="linenos">1449</span></a><span class="sd">        the function returns input variables and the proccess terminates.</span>
</span><span id="CenterDetermination-1450"><a href="#CenterDetermination-1450"><span class="linenos">1450</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1451"><a href="#CenterDetermination-1451"><span class="linenos">1451</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1452"><a href="#CenterDetermination-1452"><span class="linenos">1452</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1453"><a href="#CenterDetermination-1453"><span class="linenos">1453</span></a><span class="sd">        fig : figure.Figure object</span>
</span><span id="CenterDetermination-1454"><a href="#CenterDetermination-1454"><span class="linenos">1454</span></a><span class="sd">            interactive figure in which a diffraction pattern has been</span>
</span><span id="CenterDetermination-1455"><a href="#CenterDetermination-1455"><span class="linenos">1455</span></a><span class="sd">            manually detected.</span>
</span><span id="CenterDetermination-1456"><a href="#CenterDetermination-1456"><span class="linenos">1456</span></a><span class="sd">        circle : patches.Circle object</span>
</span><span id="CenterDetermination-1457"><a href="#CenterDetermination-1457"><span class="linenos">1457</span></a><span class="sd">            circle defined via 3 points manually delected</span>
</span><span id="CenterDetermination-1458"><a href="#CenterDetermination-1458"><span class="linenos">1458</span></a><span class="sd">        center : tuple</span>
</span><span id="CenterDetermination-1459"><a href="#CenterDetermination-1459"><span class="linenos">1459</span></a><span class="sd">            calculated center of the input circle.</span>
</span><span id="CenterDetermination-1460"><a href="#CenterDetermination-1460"><span class="linenos">1460</span></a><span class="sd">        plot_results : boolean</span>
</span><span id="CenterDetermination-1461"><a href="#CenterDetermination-1461"><span class="linenos">1461</span></a><span class="sd">            visualize results. The default is 1 (plot detected center).</span>
</span><span id="CenterDetermination-1462"><a href="#CenterDetermination-1462"><span class="linenos">1462</span></a>
</span><span id="CenterDetermination-1463"><a href="#CenterDetermination-1463"><span class="linenos">1463</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1464"><a href="#CenterDetermination-1464"><span class="linenos">1464</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1465"><a href="#CenterDetermination-1465"><span class="linenos">1465</span></a><span class="sd">        xy : tuple</span>
</span><span id="CenterDetermination-1466"><a href="#CenterDetermination-1466"><span class="linenos">1466</span></a><span class="sd">            x,y-coordinates of the center of the diffraction pattern.</span>
</span><span id="CenterDetermination-1467"><a href="#CenterDetermination-1467"><span class="linenos">1467</span></a><span class="sd">        r : integer</span>
</span><span id="CenterDetermination-1468"><a href="#CenterDetermination-1468"><span class="linenos">1468</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterDetermination-1469"><a href="#CenterDetermination-1469"><span class="linenos">1469</span></a>
</span><span id="CenterDetermination-1470"><a href="#CenterDetermination-1470"><span class="linenos">1470</span></a><span class="sd">        &#39;&#39;&#39;</span>            
</span><span id="CenterDetermination-1471"><a href="#CenterDetermination-1471"><span class="linenos">1471</span></a>        <span class="c1"># Remove default left / right arrow key press events</span>
</span><span id="CenterDetermination-1472"><a href="#CenterDetermination-1472"><span class="linenos">1472</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1473"><a href="#CenterDetermination-1473"><span class="linenos">1473</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1474"><a href="#CenterDetermination-1474"><span class="linenos">1474</span></a>        
</span><span id="CenterDetermination-1475"><a href="#CenterDetermination-1475"><span class="linenos">1475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1476"><a href="#CenterDetermination-1476"><span class="linenos">1476</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination-1477"><a href="#CenterDetermination-1477"><span class="linenos">1477</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1478"><a href="#CenterDetermination-1478"><span class="linenos">1478</span></a><span class="sd">            CenterDetermination :: ThreePoints (interactive adjustment)</span>
</span><span id="CenterDetermination-1479"><a href="#CenterDetermination-1479"><span class="linenos">1479</span></a><span class="sd">            Use these keys:</span>
</span><span id="CenterDetermination-1480"><a href="#CenterDetermination-1480"><span class="linenos">1480</span></a><span class="sd">              - &#39;&#39; : move left</span>
</span><span id="CenterDetermination-1481"><a href="#CenterDetermination-1481"><span class="linenos">1481</span></a><span class="sd">              - &#39;&#39; : move right</span>
</span><span id="CenterDetermination-1482"><a href="#CenterDetermination-1482"><span class="linenos">1482</span></a><span class="sd">              - &#39;&#39; : move up</span>
</span><span id="CenterDetermination-1483"><a href="#CenterDetermination-1483"><span class="linenos">1483</span></a><span class="sd">              - &#39;&#39; : move down</span>
</span><span id="CenterDetermination-1484"><a href="#CenterDetermination-1484"><span class="linenos">1484</span></a><span class="sd">              - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterDetermination-1485"><a href="#CenterDetermination-1485"><span class="linenos">1485</span></a><span class="sd">              - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterDetermination-1486"><a href="#CenterDetermination-1486"><span class="linenos">1486</span></a><span class="sd">              - &#39;b&#39; : increase step size</span>
</span><span id="CenterDetermination-1487"><a href="#CenterDetermination-1487"><span class="linenos">1487</span></a><span class="sd">              - &#39;l&#39; : decrease step size</span>
</span><span id="CenterDetermination-1488"><a href="#CenterDetermination-1488"><span class="linenos">1488</span></a><span class="sd">              - &#39;d&#39; : refinement done</span>
</span><span id="CenterDetermination-1489"><a href="#CenterDetermination-1489"><span class="linenos">1489</span></a><span class="sd">                  </span>
</span><span id="CenterDetermination-1490"><a href="#CenterDetermination-1490"><span class="linenos">1490</span></a><span class="sd">            DISCLAIMER: For the purpose of the center position adjustment, </span>
</span><span id="CenterDetermination-1491"><a href="#CenterDetermination-1491"><span class="linenos">1491</span></a><span class="sd">                        the default shortcuts for arrows were removed.</span>
</span><span id="CenterDetermination-1492"><a href="#CenterDetermination-1492"><span class="linenos">1492</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1493"><a href="#CenterDetermination-1493"><span class="linenos">1493</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination-1494"><a href="#CenterDetermination-1494"><span class="linenos">1494</span></a>        
</span><span id="CenterDetermination-1495"><a href="#CenterDetermination-1495"><span class="linenos">1495</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination-1496"><a href="#CenterDetermination-1496"><span class="linenos">1496</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1497"><a href="#CenterDetermination-1497"><span class="linenos">1497</span></a>            
</span><span id="CenterDetermination-1498"><a href="#CenterDetermination-1498"><span class="linenos">1498</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="CenterDetermination-1499"><a href="#CenterDetermination-1499"><span class="linenos">1499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination-1500"><a href="#CenterDetermination-1500"><span class="linenos">1500</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination-1501"><a href="#CenterDetermination-1501"><span class="linenos">1501</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-1502"><a href="#CenterDetermination-1502"><span class="linenos">1502</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterDetermination-1503"><a href="#CenterDetermination-1503"><span class="linenos">1503</span></a>        
</span><span id="CenterDetermination-1504"><a href="#CenterDetermination-1504"><span class="linenos">1504</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-1505"><a href="#CenterDetermination-1505"><span class="linenos">1505</span></a>
</span><span id="CenterDetermination-1506"><a href="#CenterDetermination-1506"><span class="linenos">1506</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination-1507"><a href="#CenterDetermination-1507"><span class="linenos">1507</span></a>          
</span><span id="CenterDetermination-1508"><a href="#CenterDetermination-1508"><span class="linenos">1508</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterDetermination-1509"><a href="#CenterDetermination-1509"><span class="linenos">1509</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-1510"><a href="#CenterDetermination-1510"><span class="linenos">1510</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-1511"><a href="#CenterDetermination-1511"><span class="linenos">1511</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-1512"><a href="#CenterDetermination-1512"><span class="linenos">1512</span></a>
</span><span id="CenterDetermination-1513"><a href="#CenterDetermination-1513"><span class="linenos">1513</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination-1514"><a href="#CenterDetermination-1514"><span class="linenos">1514</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination-1515"><a href="#CenterDetermination-1515"><span class="linenos">1515</span></a>        
</span><span id="CenterDetermination-1516"><a href="#CenterDetermination-1516"><span class="linenos">1516</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="CenterDetermination-1517"><a href="#CenterDetermination-1517"><span class="linenos">1517</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination-1518"><a href="#CenterDetermination-1518"><span class="linenos">1518</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterDetermination-1519"><a href="#CenterDetermination-1519"><span class="linenos">1519</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination-1520"><a href="#CenterDetermination-1520"><span class="linenos">1520</span></a>        
</span><span id="CenterDetermination-1521"><a href="#CenterDetermination-1521"><span class="linenos">1521</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterDetermination-1522"><a href="#CenterDetermination-1522"><span class="linenos">1522</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterDetermination-1523"><a href="#CenterDetermination-1523"><span class="linenos">1523</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterDetermination-1524"><a href="#CenterDetermination-1524"><span class="linenos">1524</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterDetermination-1525"><a href="#CenterDetermination-1525"><span class="linenos">1525</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterDetermination-1526"><a href="#CenterDetermination-1526"><span class="linenos">1526</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterDetermination-1527"><a href="#CenterDetermination-1527"><span class="linenos">1527</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterDetermination-1528"><a href="#CenterDetermination-1528"><span class="linenos">1528</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterDetermination-1529"><a href="#CenterDetermination-1529"><span class="linenos">1529</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterDetermination-1530"><a href="#CenterDetermination-1530"><span class="linenos">1530</span></a>        
</span><span id="CenterDetermination-1531"><a href="#CenterDetermination-1531"><span class="linenos">1531</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterDetermination-1532"><a href="#CenterDetermination-1532"><span class="linenos">1532</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterDetermination-1533"><a href="#CenterDetermination-1533"><span class="linenos">1533</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterDetermination-1534"><a href="#CenterDetermination-1534"><span class="linenos">1534</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1535"><a href="#CenterDetermination-1535"><span class="linenos">1535</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterDetermination-1536"><a href="#CenterDetermination-1536"><span class="linenos">1536</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1537"><a href="#CenterDetermination-1537"><span class="linenos">1537</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-1538"><a href="#CenterDetermination-1538"><span class="linenos">1538</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1539"><a href="#CenterDetermination-1539"><span class="linenos">1539</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-1540"><a href="#CenterDetermination-1540"><span class="linenos">1540</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1541"><a href="#CenterDetermination-1541"><span class="linenos">1541</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-1542"><a href="#CenterDetermination-1542"><span class="linenos">1542</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1543"><a href="#CenterDetermination-1543"><span class="linenos">1543</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination-1544"><a href="#CenterDetermination-1544"><span class="linenos">1544</span></a>                    
</span><span id="CenterDetermination-1545"><a href="#CenterDetermination-1545"><span class="linenos">1545</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterDetermination-1546"><a href="#CenterDetermination-1546"><span class="linenos">1546</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination-1547"><a href="#CenterDetermination-1547"><span class="linenos">1547</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination-1548"><a href="#CenterDetermination-1548"><span class="linenos">1548</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-1549"><a href="#CenterDetermination-1549"><span class="linenos">1549</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1550"><a href="#CenterDetermination-1550"><span class="linenos">1550</span></a>            
</span><span id="CenterDetermination-1551"><a href="#CenterDetermination-1551"><span class="linenos">1551</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterDetermination-1552"><a href="#CenterDetermination-1552"><span class="linenos">1552</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1553"><a href="#CenterDetermination-1553"><span class="linenos">1553</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-1554"><a href="#CenterDetermination-1554"><span class="linenos">1554</span></a>        
</span><span id="CenterDetermination-1555"><a href="#CenterDetermination-1555"><span class="linenos">1555</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterDetermination-1556"><a href="#CenterDetermination-1556"><span class="linenos">1556</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1557"><a href="#CenterDetermination-1557"><span class="linenos">1557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterDetermination-1558"><a href="#CenterDetermination-1558"><span class="linenos">1558</span></a>        
</span><span id="CenterDetermination-1559"><a href="#CenterDetermination-1559"><span class="linenos">1559</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination-1560"><a href="#CenterDetermination-1560"><span class="linenos">1560</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterDetermination-1561"><a href="#CenterDetermination-1561"><span class="linenos">1561</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterDetermination-1562"><a href="#CenterDetermination-1562"><span class="linenos">1562</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterDetermination-1563"><a href="#CenterDetermination-1563"><span class="linenos">1563</span></a>        
</span><span id="CenterDetermination-1564"><a href="#CenterDetermination-1564"><span class="linenos">1564</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterDetermination-1565"><a href="#CenterDetermination-1565"><span class="linenos">1565</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterDetermination-1566"><a href="#CenterDetermination-1566"><span class="linenos">1566</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterDetermination-1567"><a href="#CenterDetermination-1567"><span class="linenos">1567</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterDetermination-1568"><a href="#CenterDetermination-1568"><span class="linenos">1568</span></a>        
</span><span id="CenterDetermination-1569"><a href="#CenterDetermination-1569"><span class="linenos">1569</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination-1570"><a href="#CenterDetermination-1570"><span class="linenos">1570</span></a>        
</span><span id="CenterDetermination-1571"><a href="#CenterDetermination-1571"><span class="linenos">1571</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterDetermination-1572"><a href="#CenterDetermination-1572"><span class="linenos">1572</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination-1573"><a href="#CenterDetermination-1573"><span class="linenos">1573</span></a>
</span><span id="CenterDetermination-1574"><a href="#CenterDetermination-1574"><span class="linenos">1574</span></a>                
</span><span id="CenterDetermination-1575"><a href="#CenterDetermination-1575"><span class="linenos">1575</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterDetermination-1576"><a href="#CenterDetermination-1576"><span class="linenos">1576</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterDetermination-1577"><a href="#CenterDetermination-1577"><span class="linenos">1577</span></a>        
</span><span id="CenterDetermination-1578"><a href="#CenterDetermination-1578"><span class="linenos">1578</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination-1579"><a href="#CenterDetermination-1579"><span class="linenos">1579</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterDetermination-1580"><a href="#CenterDetermination-1580"><span class="linenos">1580</span></a>
</span><span id="CenterDetermination-1581"><a href="#CenterDetermination-1581"><span class="linenos">1581</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterDetermination-1582"><a href="#CenterDetermination-1582"><span class="linenos">1582</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterDetermination-1583"><a href="#CenterDetermination-1583"><span class="linenos">1583</span></a>               
</span><span id="CenterDetermination-1584"><a href="#CenterDetermination-1584"><span class="linenos">1584</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterDetermination-1585"><a href="#CenterDetermination-1585"><span class="linenos">1585</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination-1586"><a href="#CenterDetermination-1586"><span class="linenos">1586</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination-1587"><a href="#CenterDetermination-1587"><span class="linenos">1587</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination-1588"><a href="#CenterDetermination-1588"><span class="linenos">1588</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination-1589"><a href="#CenterDetermination-1589"><span class="linenos">1589</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterDetermination-1590"><a href="#CenterDetermination-1590"><span class="linenos">1590</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination-1591"><a href="#CenterDetermination-1591"><span class="linenos">1591</span></a>                
</span><span id="CenterDetermination-1592"><a href="#CenterDetermination-1592"><span class="linenos">1592</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination-1593"><a href="#CenterDetermination-1593"><span class="linenos">1593</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination-1594"><a href="#CenterDetermination-1594"><span class="linenos">1594</span></a>        
</span><span id="CenterDetermination-1595"><a href="#CenterDetermination-1595"><span class="linenos">1595</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterDetermination-1596"><a href="#CenterDetermination-1596"><span class="linenos">1596</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1597"><a href="#CenterDetermination-1597"><span class="linenos">1597</span></a>
</span><span id="CenterDetermination-1598"><a href="#CenterDetermination-1598"><span class="linenos">1598</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1599"><a href="#CenterDetermination-1599"><span class="linenos">1599</span></a>        
</span><span id="CenterDetermination-1600"><a href="#CenterDetermination-1600"><span class="linenos">1600</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination-1601"><a href="#CenterDetermination-1601"><span class="linenos">1601</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination-1602"><a href="#CenterDetermination-1602"><span class="linenos">1602</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterDetermination-1603"><a href="#CenterDetermination-1603"><span class="linenos">1603</span></a>
</span><span id="CenterDetermination-1604"><a href="#CenterDetermination-1604"><span class="linenos">1604</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination-1605"><a href="#CenterDetermination-1605"><span class="linenos">1605</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination-1606"><a href="#CenterDetermination-1606"><span class="linenos">1606</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (ThreePoints)    : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination-1607"><a href="#CenterDetermination-1607"><span class="linenos">1607</span></a>        
</span><span id="CenterDetermination-1608"><a href="#CenterDetermination-1608"><span class="linenos">1608</span></a>    
</span><span id="CenterDetermination-1609"><a href="#CenterDetermination-1609"><span class="linenos">1609</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>
</span><span id="CenterDetermination-1610"><a href="#CenterDetermination-1610"><span class="linenos">1610</span></a>    
</span><span id="CenterDetermination-1611"><a href="#CenterDetermination-1611"><span class="linenos">1611</span></a>       
</span><span id="CenterDetermination-1612"><a href="#CenterDetermination-1612"><span class="linenos">1612</span></a>    <span class="k">def</span> <span class="nf">calculate_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span>
</span><span id="CenterDetermination-1613"><a href="#CenterDetermination-1613"><span class="linenos">1613</span></a>            <span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">]:</span>
</span><span id="CenterDetermination-1614"><a href="#CenterDetermination-1614"><span class="linenos">1614</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterDetermination-1615"><a href="#CenterDetermination-1615"><span class="linenos">1615</span></a><span class="sd">        Calculates coordinates of the center and radius of a circle defined via</span>
</span><span id="CenterDetermination-1616"><a href="#CenterDetermination-1616"><span class="linenos">1616</span></a><span class="sd">        3 points determined by the user. Plots the calculated circle, detected </span>
</span><span id="CenterDetermination-1617"><a href="#CenterDetermination-1617"><span class="linenos">1617</span></a><span class="sd">        points and marks the center.</span>
</span><span id="CenterDetermination-1618"><a href="#CenterDetermination-1618"><span class="linenos">1618</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1619"><a href="#CenterDetermination-1619"><span class="linenos">1619</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1620"><a href="#CenterDetermination-1620"><span class="linenos">1620</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1621"><a href="#CenterDetermination-1621"><span class="linenos">1621</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination-1622"><a href="#CenterDetermination-1622"><span class="linenos">1622</span></a><span class="sd">            Plot the calculated center and circle. To cancel visualization, </span>
</span><span id="CenterDetermination-1623"><a href="#CenterDetermination-1623"><span class="linenos">1623</span></a><span class="sd">            set plot_results = 0.</span>
</span><span id="CenterDetermination-1624"><a href="#CenterDetermination-1624"><span class="linenos">1624</span></a><span class="sd">        self.coords : array of float64</span>
</span><span id="CenterDetermination-1625"><a href="#CenterDetermination-1625"><span class="linenos">1625</span></a><span class="sd">            Coordinates of 3 manually selected points</span>
</span><span id="CenterDetermination-1626"><a href="#CenterDetermination-1626"><span class="linenos">1626</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1627"><a href="#CenterDetermination-1627"><span class="linenos">1627</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1628"><a href="#CenterDetermination-1628"><span class="linenos">1628</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1629"><a href="#CenterDetermination-1629"><span class="linenos">1629</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination-1630"><a href="#CenterDetermination-1630"><span class="linenos">1630</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination-1631"><a href="#CenterDetermination-1631"><span class="linenos">1631</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination-1632"><a href="#CenterDetermination-1632"><span class="linenos">1632</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination-1633"><a href="#CenterDetermination-1633"><span class="linenos">1633</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination-1634"><a href="#CenterDetermination-1634"><span class="linenos">1634</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination-1635"><a href="#CenterDetermination-1635"><span class="linenos">1635</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination-1636"><a href="#CenterDetermination-1636"><span class="linenos">1636</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1637"><a href="#CenterDetermination-1637"><span class="linenos">1637</span></a>        <span class="c1"># Extract the coordinates of the points        </span>
</span><span id="CenterDetermination-1638"><a href="#CenterDetermination-1638"><span class="linenos">1638</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination-1639"><a href="#CenterDetermination-1639"><span class="linenos">1639</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination-1640"><a href="#CenterDetermination-1640"><span class="linenos">1640</span></a>        
</span><span id="CenterDetermination-1641"><a href="#CenterDetermination-1641"><span class="linenos">1641</span></a>        <span class="c1"># Compute the radius and center coordinates of the circle</span>
</span><span id="CenterDetermination-1642"><a href="#CenterDetermination-1642"><span class="linenos">1642</span></a>            <span class="c1"># a: the squared length of the side between the second </span>
</span><span id="CenterDetermination-1643"><a href="#CenterDetermination-1643"><span class="linenos">1643</span></a>            <span class="c1">#    and third points (x[1], y[1]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination-1644"><a href="#CenterDetermination-1644"><span class="linenos">1644</span></a>            <span class="c1"># b: the squared length of the side between the first </span>
</span><span id="CenterDetermination-1645"><a href="#CenterDetermination-1645"><span class="linenos">1645</span></a>            <span class="c1">#    and third points (x[0], y[0]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination-1646"><a href="#CenterDetermination-1646"><span class="linenos">1646</span></a>            <span class="c1"># c: the squared length of the side between the first </span>
</span><span id="CenterDetermination-1647"><a href="#CenterDetermination-1647"><span class="linenos">1647</span></a>            <span class="c1">#    and second points (x[0], y[0]) and (x[1], y[1]).</span>
</span><span id="CenterDetermination-1648"><a href="#CenterDetermination-1648"><span class="linenos">1648</span></a>            <span class="c1"># s: the twice the signed area of the triangle formed by 3 points</span>
</span><span id="CenterDetermination-1649"><a href="#CenterDetermination-1649"><span class="linenos">1649</span></a>            
</span><span id="CenterDetermination-1650"><a href="#CenterDetermination-1650"><span class="linenos">1650</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination-1651"><a href="#CenterDetermination-1651"><span class="linenos">1651</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination-1652"><a href="#CenterDetermination-1652"><span class="linenos">1652</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination-1653"><a href="#CenterDetermination-1653"><span class="linenos">1653</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> 
</span><span id="CenterDetermination-1654"><a href="#CenterDetermination-1654"><span class="linenos">1654</span></a>        
</span><span id="CenterDetermination-1655"><a href="#CenterDetermination-1655"><span class="linenos">1655</span></a>        <span class="c1"># coordinates of the center</span>
</span><span id="CenterDetermination-1656"><a href="#CenterDetermination-1656"><span class="linenos">1656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span>
</span><span id="CenterDetermination-1657"><a href="#CenterDetermination-1657"><span class="linenos">1657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span> 
</span><span id="CenterDetermination-1658"><a href="#CenterDetermination-1658"><span class="linenos">1658</span></a>        
</span><span id="CenterDetermination-1659"><a href="#CenterDetermination-1659"><span class="linenos">1659</span></a>        <span class="c1"># radius</span>
</span><span id="CenterDetermination-1660"><a href="#CenterDetermination-1660"><span class="linenos">1660</span></a>        <span class="n">ar</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination-1661"><a href="#CenterDetermination-1661"><span class="linenos">1661</span></a>        <span class="n">br</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination-1662"><a href="#CenterDetermination-1662"><span class="linenos">1662</span></a>        <span class="n">cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="mf">0.5</span> 
</span><span id="CenterDetermination-1663"><a href="#CenterDetermination-1663"><span class="linenos">1663</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">ar</span><span class="o">*</span><span class="n">br</span><span class="o">*</span><span class="n">cr</span><span class="o">/</span><span class="p">((</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">-</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">-</span><span class="n">cr</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination-1664"><a href="#CenterDetermination-1664"><span class="linenos">1664</span></a>        
</span><span id="CenterDetermination-1665"><a href="#CenterDetermination-1665"><span class="linenos">1665</span></a>        <span class="c1"># # Print results</span>
</span><span id="CenterDetermination-1666"><a href="#CenterDetermination-1666"><span class="linenos">1666</span></a>        <span class="c1"># if self.parent.messages:</span>
</span><span id="CenterDetermination-1667"><a href="#CenterDetermination-1667"><span class="linenos">1667</span></a>        <span class="c1">#     print(&quot;CenterEstimator :: manual center detection&quot;)</span>
</span><span id="CenterDetermination-1668"><a href="#CenterDetermination-1668"><span class="linenos">1668</span></a>        <span class="c1">#     print(f&quot;Center coordinates: {self.x:.2f} {self.y:.2f}&quot;)</span>
</span><span id="CenterDetermination-1669"><a href="#CenterDetermination-1669"><span class="linenos">1669</span></a>                    
</span><span id="CenterDetermination-1670"><a href="#CenterDetermination-1670"><span class="linenos">1670</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination-1671"><a href="#CenterDetermination-1671"><span class="linenos">1671</span></a>            <span class="c1"># Create and manage the figure</span>
</span><span id="CenterDetermination-1672"><a href="#CenterDetermination-1672"><span class="linenos">1672</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination-1673"><a href="#CenterDetermination-1673"><span class="linenos">1673</span></a>            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
</span><span id="CenterDetermination-1674"><a href="#CenterDetermination-1674"><span class="linenos">1674</span></a>            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
</span><span id="CenterDetermination-1675"><a href="#CenterDetermination-1675"><span class="linenos">1675</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination-1676"><a href="#CenterDetermination-1676"><span class="linenos">1676</span></a>                      <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1677"><a href="#CenterDetermination-1677"><span class="linenos">1677</span></a>            
</span><span id="CenterDetermination-1678"><a href="#CenterDetermination-1678"><span class="linenos">1678</span></a>            <span class="c1"># Plot center and points</span>
</span><span id="CenterDetermination-1679"><a href="#CenterDetermination-1679"><span class="linenos">1679</span></a>            <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination-1680"><a href="#CenterDetermination-1680"><span class="linenos">1680</span></a>                     <span class="s1">&#39;rx&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1681"><a href="#CenterDetermination-1681"><span class="linenos">1681</span></a>                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1682"><a href="#CenterDetermination-1682"><span class="linenos">1682</span></a>                     <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination-1683"><a href="#CenterDetermination-1683"><span class="linenos">1683</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination-1684"><a href="#CenterDetermination-1684"><span class="linenos">1684</span></a>                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1685"><a href="#CenterDetermination-1685"><span class="linenos">1685</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1686"><a href="#CenterDetermination-1686"><span class="linenos">1686</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Circle points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1687"><a href="#CenterDetermination-1687"><span class="linenos">1687</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Circle found using 3 manually detected points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1688"><a href="#CenterDetermination-1688"><span class="linenos">1688</span></a>            
</span><span id="CenterDetermination-1689"><a href="#CenterDetermination-1689"><span class="linenos">1689</span></a>            <span class="c1"># Circle visualization</span>
</span><span id="CenterDetermination-1690"><a href="#CenterDetermination-1690"><span class="linenos">1690</span></a>            <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterDetermination-1691"><a href="#CenterDetermination-1691"><span class="linenos">1691</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="CenterDetermination-1692"><a href="#CenterDetermination-1692"><span class="linenos">1692</span></a>                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1693"><a href="#CenterDetermination-1693"><span class="linenos">1693</span></a>                                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="CenterDetermination-1694"><a href="#CenterDetermination-1694"><span class="linenos">1694</span></a>                                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1695"><a href="#CenterDetermination-1695"><span class="linenos">1695</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination-1696"><a href="#CenterDetermination-1696"><span class="linenos">1696</span></a>            
</span><span id="CenterDetermination-1697"><a href="#CenterDetermination-1697"><span class="linenos">1697</span></a>            <span class="c1"># Set the aspect ratio to equal to have a circular shape</span>
</span><span id="CenterDetermination-1698"><a href="#CenterDetermination-1698"><span class="linenos">1698</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1699"><a href="#CenterDetermination-1699"><span class="linenos">1699</span></a>            
</span><span id="CenterDetermination-1700"><a href="#CenterDetermination-1700"><span class="linenos">1700</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1701"><a href="#CenterDetermination-1701"><span class="linenos">1701</span></a>                       <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="CenterDetermination-1702"><a href="#CenterDetermination-1702"><span class="linenos">1702</span></a>                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> 
</span><span id="CenterDetermination-1703"><a href="#CenterDetermination-1703"><span class="linenos">1703</span></a>                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination-1704"><a href="#CenterDetermination-1704"><span class="linenos">1704</span></a>                       <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1705"><a href="#CenterDetermination-1705"><span class="linenos">1705</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1706"><a href="#CenterDetermination-1706"><span class="linenos">1706</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1707"><a href="#CenterDetermination-1707"><span class="linenos">1707</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination-1708"><a href="#CenterDetermination-1708"><span class="linenos">1708</span></a>
</span><span id="CenterDetermination-1709"><a href="#CenterDetermination-1709"><span class="linenos">1709</span></a>        
</span><span id="CenterDetermination-1710"><a href="#CenterDetermination-1710"><span class="linenos">1710</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination-1711"><a href="#CenterDetermination-1711"><span class="linenos">1711</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination-1712"><a href="#CenterDetermination-1712"><span class="linenos">1712</span></a>        
</span><span id="CenterDetermination-1713"><a href="#CenterDetermination-1713"><span class="linenos">1713</span></a>
</span><span id="CenterDetermination-1714"><a href="#CenterDetermination-1714"><span class="linenos">1714</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle</span>
</span><span id="CenterDetermination-1715"><a href="#CenterDetermination-1715"><span class="linenos">1715</span></a>
</span><span id="CenterDetermination-1716"><a href="#CenterDetermination-1716"><span class="linenos">1716</span></a>
</span><span id="CenterDetermination-1717"><a href="#CenterDetermination-1717"><span class="linenos">1717</span></a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span>
</span><span id="CenterDetermination-1718"><a href="#CenterDetermination-1718"><span class="linenos">1718</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">disp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterDetermination-1719"><a href="#CenterDetermination-1719"><span class="linenos">1719</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1720"><a href="#CenterDetermination-1720"><span class="linenos">1720</span></a><span class="sd">        Calculate the radius of a circle based on intensity profiles along </span>
</span><span id="CenterDetermination-1721"><a href="#CenterDetermination-1721"><span class="linenos">1721</span></a><span class="sd">        horizontal and vertical axes.</span>
</span><span id="CenterDetermination-1722"><a href="#CenterDetermination-1722"><span class="linenos">1722</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1723"><a href="#CenterDetermination-1723"><span class="linenos">1723</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1724"><a href="#CenterDetermination-1724"><span class="linenos">1724</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1725"><a href="#CenterDetermination-1725"><span class="linenos">1725</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="CenterDetermination-1726"><a href="#CenterDetermination-1726"><span class="linenos">1726</span></a><span class="sd">            The 2D image array containing the circle.</span>
</span><span id="CenterDetermination-1727"><a href="#CenterDetermination-1727"><span class="linenos">1727</span></a><span class="sd">        x : float</span>
</span><span id="CenterDetermination-1728"><a href="#CenterDetermination-1728"><span class="linenos">1728</span></a><span class="sd">            The x-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination-1729"><a href="#CenterDetermination-1729"><span class="linenos">1729</span></a><span class="sd">        y : float</span>
</span><span id="CenterDetermination-1730"><a href="#CenterDetermination-1730"><span class="linenos">1730</span></a><span class="sd">            The y-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination-1731"><a href="#CenterDetermination-1731"><span class="linenos">1731</span></a><span class="sd">        disp : bool, optional</span>
</span><span id="CenterDetermination-1732"><a href="#CenterDetermination-1732"><span class="linenos">1732</span></a><span class="sd">            If True, visualizes the detected intensity profiles and peaks </span>
</span><span id="CenterDetermination-1733"><a href="#CenterDetermination-1733"><span class="linenos">1733</span></a><span class="sd">            (default is False).</span>
</span><span id="CenterDetermination-1734"><a href="#CenterDetermination-1734"><span class="linenos">1734</span></a><span class="sd">    </span>
</span><span id="CenterDetermination-1735"><a href="#CenterDetermination-1735"><span class="linenos">1735</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1736"><a href="#CenterDetermination-1736"><span class="linenos">1736</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1737"><a href="#CenterDetermination-1737"><span class="linenos">1737</span></a><span class="sd">        float</span>
</span><span id="CenterDetermination-1738"><a href="#CenterDetermination-1738"><span class="linenos">1738</span></a><span class="sd">            The estimated radius of the circle. Defaults to 100 if no valid </span>
</span><span id="CenterDetermination-1739"><a href="#CenterDetermination-1739"><span class="linenos">1739</span></a><span class="sd">            radius is detected.</span>
</span><span id="CenterDetermination-1740"><a href="#CenterDetermination-1740"><span class="linenos">1740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1741"><a href="#CenterDetermination-1741"><span class="linenos">1741</span></a>        
</span><span id="CenterDetermination-1742"><a href="#CenterDetermination-1742"><span class="linenos">1742</span></a>        <span class="k">def</span> <span class="nf">match_peaks</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span><span id="CenterDetermination-1743"><a href="#CenterDetermination-1743"><span class="linenos">1743</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1744"><a href="#CenterDetermination-1744"><span class="linenos">1744</span></a><span class="sd">            Finds the most similar values across the left and right halves of </span>
</span><span id="CenterDetermination-1745"><a href="#CenterDetermination-1745"><span class="linenos">1745</span></a><span class="sd">            an array, omitting the highest value. If exactly two peaks are </span>
</span><span id="CenterDetermination-1746"><a href="#CenterDetermination-1746"><span class="linenos">1746</span></a><span class="sd">            detected, they are returned as the best pair.</span>
</span><span id="CenterDetermination-1747"><a href="#CenterDetermination-1747"><span class="linenos">1747</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterDetermination-1748"><a href="#CenterDetermination-1748"><span class="linenos">1748</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not enough values to compare</span>
</span><span id="CenterDetermination-1749"><a href="#CenterDetermination-1749"><span class="linenos">1749</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1750"><a href="#CenterDetermination-1750"><span class="linenos">1750</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough values to find similar pairs.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1751"><a href="#CenterDetermination-1751"><span class="linenos">1751</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1752"><a href="#CenterDetermination-1752"><span class="linenos">1752</span></a>    
</span><span id="CenterDetermination-1753"><a href="#CenterDetermination-1753"><span class="linenos">1753</span></a>            <span class="c1"># Special case: if there are exactly 2 peaks, return them</span>
</span><span id="CenterDetermination-1754"><a href="#CenterDetermination-1754"><span class="linenos">1754</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination-1755"><a href="#CenterDetermination-1755"><span class="linenos">1755</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1756"><a href="#CenterDetermination-1756"><span class="linenos">1756</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exactly two peaks detected. Returning them as the best pair.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1757"><a href="#CenterDetermination-1757"><span class="linenos">1757</span></a>                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span id="CenterDetermination-1758"><a href="#CenterDetermination-1758"><span class="linenos">1758</span></a>    
</span><span id="CenterDetermination-1759"><a href="#CenterDetermination-1759"><span class="linenos">1759</span></a>            <span class="c1"># Find the index of the highest value</span>
</span><span id="CenterDetermination-1760"><a href="#CenterDetermination-1760"><span class="linenos">1760</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span id="CenterDetermination-1761"><a href="#CenterDetermination-1761"><span class="linenos">1761</span></a>    
</span><span id="CenterDetermination-1762"><a href="#CenterDetermination-1762"><span class="linenos">1762</span></a>            <span class="c1"># Split into left and right halves, excluding the highest value</span>
</span><span id="CenterDetermination-1763"><a href="#CenterDetermination-1763"><span class="linenos">1763</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="CenterDetermination-1764"><a href="#CenterDetermination-1764"><span class="linenos">1764</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="CenterDetermination-1765"><a href="#CenterDetermination-1765"><span class="linenos">1765</span></a>            <span class="n">left_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>
</span><span id="CenterDetermination-1766"><a href="#CenterDetermination-1766"><span class="linenos">1766</span></a>            <span class="n">right_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
</span><span id="CenterDetermination-1767"><a href="#CenterDetermination-1767"><span class="linenos">1767</span></a>    
</span><span id="CenterDetermination-1768"><a href="#CenterDetermination-1768"><span class="linenos">1768</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check for empty halves</span>
</span><span id="CenterDetermination-1769"><a href="#CenterDetermination-1769"><span class="linenos">1769</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1770"><a href="#CenterDetermination-1770"><span class="linenos">1770</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One of the halves is empty.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1771"><a href="#CenterDetermination-1771"><span class="linenos">1771</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1772"><a href="#CenterDetermination-1772"><span class="linenos">1772</span></a>    
</span><span id="CenterDetermination-1773"><a href="#CenterDetermination-1773"><span class="linenos">1773</span></a>            <span class="c1"># Initialize variables for tracking the smallest difference</span>
</span><span id="CenterDetermination-1774"><a href="#CenterDetermination-1774"><span class="linenos">1774</span></a>            <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="CenterDetermination-1775"><a href="#CenterDetermination-1775"><span class="linenos">1775</span></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="CenterDetermination-1776"><a href="#CenterDetermination-1776"><span class="linenos">1776</span></a>    
</span><span id="CenterDetermination-1777"><a href="#CenterDetermination-1777"><span class="linenos">1777</span></a>            <span class="c1"># Compare each value in the left with every value in the right</span>
</span><span id="CenterDetermination-1778"><a href="#CenterDetermination-1778"><span class="linenos">1778</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
</span><span id="CenterDetermination-1779"><a href="#CenterDetermination-1779"><span class="linenos">1779</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
</span><span id="CenterDetermination-1780"><a href="#CenterDetermination-1780"><span class="linenos">1780</span></a>                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l_val</span> <span class="o">-</span> <span class="n">r_val</span><span class="p">)</span>
</span><span id="CenterDetermination-1781"><a href="#CenterDetermination-1781"><span class="linenos">1781</span></a>                    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">smallest_diff</span><span class="p">:</span>
</span><span id="CenterDetermination-1782"><a href="#CenterDetermination-1782"><span class="linenos">1782</span></a>                        <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">diff</span>
</span><span id="CenterDetermination-1783"><a href="#CenterDetermination-1783"><span class="linenos">1783</span></a>                        <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_indices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="CenterDetermination-1784"><a href="#CenterDetermination-1784"><span class="linenos">1784</span></a>    
</span><span id="CenterDetermination-1785"><a href="#CenterDetermination-1785"><span class="linenos">1785</span></a>            <span class="k">return</span> <span class="n">best_pair</span>
</span><span id="CenterDetermination-1786"><a href="#CenterDetermination-1786"><span class="linenos">1786</span></a>    
</span><span id="CenterDetermination-1787"><a href="#CenterDetermination-1787"><span class="linenos">1787</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1788"><a href="#CenterDetermination-1788"><span class="linenos">1788</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1789"><a href="#CenterDetermination-1789"><span class="linenos">1789</span></a>    
</span><span id="CenterDetermination-1790"><a href="#CenterDetermination-1790"><span class="linenos">1790</span></a>        <span class="n">x_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="CenterDetermination-1791"><a href="#CenterDetermination-1791"><span class="linenos">1791</span></a>        <span class="n">y_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</span><span id="CenterDetermination-1792"><a href="#CenterDetermination-1792"><span class="linenos">1792</span></a>    
</span><span id="CenterDetermination-1793"><a href="#CenterDetermination-1793"><span class="linenos">1793</span></a>        <span class="c1"># Define threshold for peak detection</span>
</span><span id="CenterDetermination-1794"><a href="#CenterDetermination-1794"><span class="linenos">1794</span></a>        <span class="n">x_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span>
</span><span id="CenterDetermination-1795"><a href="#CenterDetermination-1795"><span class="linenos">1795</span></a>        <span class="n">y_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_line</span><span class="p">)</span>
</span><span id="CenterDetermination-1796"><a href="#CenterDetermination-1796"><span class="linenos">1796</span></a>    
</span><span id="CenterDetermination-1797"><a href="#CenterDetermination-1797"><span class="linenos">1797</span></a>        <span class="c1"># Find peaks with dynamic height thresholds</span>
</span><span id="CenterDetermination-1798"><a href="#CenterDetermination-1798"><span class="linenos">1798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> 
</span><span id="CenterDetermination-1799"><a href="#CenterDetermination-1799"><span class="linenos">1799</span></a>                                    <span class="n">height</span><span class="o">=</span><span class="n">x_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination-1800"><a href="#CenterDetermination-1800"><span class="linenos">1800</span></a>                                    <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination-1801"><a href="#CenterDetermination-1801"><span class="linenos">1801</span></a>                                    <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination-1802"><a href="#CenterDetermination-1802"><span class="linenos">1802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span> <span class="o">=</span> <span class="n">x_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">]</span>
</span><span id="CenterDetermination-1803"><a href="#CenterDetermination-1803"><span class="linenos">1803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> 
</span><span id="CenterDetermination-1804"><a href="#CenterDetermination-1804"><span class="linenos">1804</span></a>                                    <span class="n">height</span><span class="o">=</span><span class="n">y_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination-1805"><a href="#CenterDetermination-1805"><span class="linenos">1805</span></a>                                    <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination-1806"><a href="#CenterDetermination-1806"><span class="linenos">1806</span></a>                                    <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination-1807"><a href="#CenterDetermination-1807"><span class="linenos">1807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="n">y_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">]</span>
</span><span id="CenterDetermination-1808"><a href="#CenterDetermination-1808"><span class="linenos">1808</span></a>    
</span><span id="CenterDetermination-1809"><a href="#CenterDetermination-1809"><span class="linenos">1809</span></a>        <span class="c1"># Define half the length of the image</span>
</span><span id="CenterDetermination-1810"><a href="#CenterDetermination-1810"><span class="linenos">1810</span></a>        <span class="n">half_length_x</span> <span class="o">=</span> <span class="n">x_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1811"><a href="#CenterDetermination-1811"><span class="linenos">1811</span></a>        <span class="n">half_length_y</span> <span class="o">=</span> <span class="n">y_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1812"><a href="#CenterDetermination-1812"><span class="linenos">1812</span></a>    
</span><span id="CenterDetermination-1813"><a href="#CenterDetermination-1813"><span class="linenos">1813</span></a>        <span class="c1"># Check the additional condition for xpeaks</span>
</span><span id="CenterDetermination-1814"><a href="#CenterDetermination-1814"><span class="linenos">1814</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination-1815"><a href="#CenterDetermination-1815"><span class="linenos">1815</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination-1816"><a href="#CenterDetermination-1816"><span class="linenos">1816</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span><span class="p">)):</span>
</span><span id="CenterDetermination-1817"><a href="#CenterDetermination-1817"><span class="linenos">1817</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1818"><a href="#CenterDetermination-1818"><span class="linenos">1818</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xpeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1819"><a href="#CenterDetermination-1819"><span class="linenos">1819</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1820"><a href="#CenterDetermination-1820"><span class="linenos">1820</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1821"><a href="#CenterDetermination-1821"><span class="linenos">1821</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">)</span>
</span><span id="CenterDetermination-1822"><a href="#CenterDetermination-1822"><span class="linenos">1822</span></a>    
</span><span id="CenterDetermination-1823"><a href="#CenterDetermination-1823"><span class="linenos">1823</span></a>        <span class="c1"># Check the additional condition for ypeaks</span>
</span><span id="CenterDetermination-1824"><a href="#CenterDetermination-1824"><span class="linenos">1824</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination-1825"><a href="#CenterDetermination-1825"><span class="linenos">1825</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination-1826"><a href="#CenterDetermination-1826"><span class="linenos">1826</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span><span class="p">)):</span>
</span><span id="CenterDetermination-1827"><a href="#CenterDetermination-1827"><span class="linenos">1827</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1828"><a href="#CenterDetermination-1828"><span class="linenos">1828</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ypeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1829"><a href="#CenterDetermination-1829"><span class="linenos">1829</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1830"><a href="#CenterDetermination-1830"><span class="linenos">1830</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1831"><a href="#CenterDetermination-1831"><span class="linenos">1831</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">)</span>
</span><span id="CenterDetermination-1832"><a href="#CenterDetermination-1832"><span class="linenos">1832</span></a>    
</span><span id="CenterDetermination-1833"><a href="#CenterDetermination-1833"><span class="linenos">1833</span></a>        <span class="c1"># Determine radius based on available pairs</span>
</span><span id="CenterDetermination-1834"><a href="#CenterDetermination-1834"><span class="linenos">1834</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">:</span>
</span><span id="CenterDetermination-1835"><a href="#CenterDetermination-1835"><span class="linenos">1835</span></a>            <span class="n">rx_x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1836"><a href="#CenterDetermination-1836"><span class="linenos">1836</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1837"><a href="#CenterDetermination-1837"><span class="linenos">1837</span></a>            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination-1838"><a href="#CenterDetermination-1838"><span class="linenos">1838</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination-1839"><a href="#CenterDetermination-1839"><span class="linenos">1839</span></a>            <span class="n">rx_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1840"><a href="#CenterDetermination-1840"><span class="linenos">1840</span></a>    
</span><span id="CenterDetermination-1841"><a href="#CenterDetermination-1841"><span class="linenos">1841</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">:</span>
</span><span id="CenterDetermination-1842"><a href="#CenterDetermination-1842"><span class="linenos">1842</span></a>            <span class="n">rx_y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination-1843"><a href="#CenterDetermination-1843"><span class="linenos">1843</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1844"><a href="#CenterDetermination-1844"><span class="linenos">1844</span></a>            <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination-1845"><a href="#CenterDetermination-1845"><span class="linenos">1845</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination-1846"><a href="#CenterDetermination-1846"><span class="linenos">1846</span></a>            <span class="n">rx_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination-1847"><a href="#CenterDetermination-1847"><span class="linenos">1847</span></a>    
</span><span id="CenterDetermination-1848"><a href="#CenterDetermination-1848"><span class="linenos">1848</span></a>        <span class="k">if</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-1849"><a href="#CenterDetermination-1849"><span class="linenos">1849</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">rx_x</span><span class="p">,</span> <span class="n">rx_y</span><span class="p">])</span>
</span><span id="CenterDetermination-1850"><a href="#CenterDetermination-1850"><span class="linenos">1850</span></a>        <span class="k">elif</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-1851"><a href="#CenterDetermination-1851"><span class="linenos">1851</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_x</span>
</span><span id="CenterDetermination-1852"><a href="#CenterDetermination-1852"><span class="linenos">1852</span></a>        <span class="k">elif</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-1853"><a href="#CenterDetermination-1853"><span class="linenos">1853</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_y</span>
</span><span id="CenterDetermination-1854"><a href="#CenterDetermination-1854"><span class="linenos">1854</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1855"><a href="#CenterDetermination-1855"><span class="linenos">1855</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination-1856"><a href="#CenterDetermination-1856"><span class="linenos">1856</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pairs detected for radius calculation.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1857"><a href="#CenterDetermination-1857"><span class="linenos">1857</span></a>            <span class="k">return</span> <span class="mi">100</span>  <span class="c1"># Default radius or error handling</span>
</span><span id="CenterDetermination-1858"><a href="#CenterDetermination-1858"><span class="linenos">1858</span></a>    
</span><span id="CenterDetermination-1859"><a href="#CenterDetermination-1859"><span class="linenos">1859</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination-1860"><a href="#CenterDetermination-1860"><span class="linenos">1860</span></a>            <span class="c1"># Plot xline with peaks</span>
</span><span id="CenterDetermination-1861"><a href="#CenterDetermination-1861"><span class="linenos">1861</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="CenterDetermination-1862"><a href="#CenterDetermination-1862"><span class="linenos">1862</span></a>    
</span><span id="CenterDetermination-1863"><a href="#CenterDetermination-1863"><span class="linenos">1863</span></a>            <span class="c1"># Plot for xline</span>
</span><span id="CenterDetermination-1864"><a href="#CenterDetermination-1864"><span class="linenos">1864</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination-1865"><a href="#CenterDetermination-1865"><span class="linenos">1865</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1866"><a href="#CenterDetermination-1866"><span class="linenos">1866</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1867"><a href="#CenterDetermination-1867"><span class="linenos">1867</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1868"><a href="#CenterDetermination-1868"><span class="linenos">1868</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1869"><a href="#CenterDetermination-1869"><span class="linenos">1869</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1870"><a href="#CenterDetermination-1870"><span class="linenos">1870</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination-1871"><a href="#CenterDetermination-1871"><span class="linenos">1871</span></a>    
</span><span id="CenterDetermination-1872"><a href="#CenterDetermination-1872"><span class="linenos">1872</span></a>            <span class="c1"># Plot for yline</span>
</span><span id="CenterDetermination-1873"><a href="#CenterDetermination-1873"><span class="linenos">1873</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination-1874"><a href="#CenterDetermination-1874"><span class="linenos">1874</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1875"><a href="#CenterDetermination-1875"><span class="linenos">1875</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>  
</span><span id="CenterDetermination-1876"><a href="#CenterDetermination-1876"><span class="linenos">1876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1877"><a href="#CenterDetermination-1877"><span class="linenos">1877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1878"><a href="#CenterDetermination-1878"><span class="linenos">1878</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1879"><a href="#CenterDetermination-1879"><span class="linenos">1879</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination-1880"><a href="#CenterDetermination-1880"><span class="linenos">1880</span></a>    
</span><span id="CenterDetermination-1881"><a href="#CenterDetermination-1881"><span class="linenos">1881</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1882"><a href="#CenterDetermination-1882"><span class="linenos">1882</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination-1883"><a href="#CenterDetermination-1883"><span class="linenos">1883</span></a>    
</span><span id="CenterDetermination-1884"><a href="#CenterDetermination-1884"><span class="linenos">1884</span></a>        <span class="k">return</span> <span class="n">rx</span>
</span><span id="CenterDetermination-1885"><a href="#CenterDetermination-1885"><span class="linenos">1885</span></a>
</span><span id="CenterDetermination-1886"><a href="#CenterDetermination-1886"><span class="linenos">1886</span></a>        
</span><span id="CenterDetermination-1887"><a href="#CenterDetermination-1887"><span class="linenos">1887</span></a>    <span class="k">def</span> <span class="nf">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-1888"><a href="#CenterDetermination-1888"><span class="linenos">1888</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination-1889"><a href="#CenterDetermination-1889"><span class="linenos">1889</span></a><span class="sd">        Visualize detected diffraction patterns and mark the center.</span>
</span><span id="CenterDetermination-1890"><a href="#CenterDetermination-1890"><span class="linenos">1890</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1891"><a href="#CenterDetermination-1891"><span class="linenos">1891</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination-1892"><a href="#CenterDetermination-1892"><span class="linenos">1892</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination-1893"><a href="#CenterDetermination-1893"><span class="linenos">1893</span></a><span class="sd">        tit : string</span>
</span><span id="CenterDetermination-1894"><a href="#CenterDetermination-1894"><span class="linenos">1894</span></a><span class="sd">            name of the method used for circle detection</span>
</span><span id="CenterDetermination-1895"><a href="#CenterDetermination-1895"><span class="linenos">1895</span></a><span class="sd">        x : float64</span>
</span><span id="CenterDetermination-1896"><a href="#CenterDetermination-1896"><span class="linenos">1896</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination-1897"><a href="#CenterDetermination-1897"><span class="linenos">1897</span></a><span class="sd">        y : float64</span>
</span><span id="CenterDetermination-1898"><a href="#CenterDetermination-1898"><span class="linenos">1898</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination-1899"><a href="#CenterDetermination-1899"><span class="linenos">1899</span></a><span class="sd">        r : float64</span>
</span><span id="CenterDetermination-1900"><a href="#CenterDetermination-1900"><span class="linenos">1900</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination-1901"><a href="#CenterDetermination-1901"><span class="linenos">1901</span></a><span class="sd">        </span>
</span><span id="CenterDetermination-1902"><a href="#CenterDetermination-1902"><span class="linenos">1902</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination-1903"><a href="#CenterDetermination-1903"><span class="linenos">1903</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination-1904"><a href="#CenterDetermination-1904"><span class="linenos">1904</span></a><span class="sd">        None.</span>
</span><span id="CenterDetermination-1905"><a href="#CenterDetermination-1905"><span class="linenos">1905</span></a><span class="sd">                            </span>
</span><span id="CenterDetermination-1906"><a href="#CenterDetermination-1906"><span class="linenos">1906</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination-1907"><a href="#CenterDetermination-1907"><span class="linenos">1907</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterDetermination-1908"><a href="#CenterDetermination-1908"><span class="linenos">1908</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination-1909"><a href="#CenterDetermination-1909"><span class="linenos">1909</span></a>    
</span><span id="CenterDetermination-1910"><a href="#CenterDetermination-1910"><span class="linenos">1910</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination-1911"><a href="#CenterDetermination-1911"><span class="linenos">1911</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-1912"><a href="#CenterDetermination-1912"><span class="linenos">1912</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination-1913"><a href="#CenterDetermination-1913"><span class="linenos">1913</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination-1914"><a href="#CenterDetermination-1914"><span class="linenos">1914</span></a>            
</span><span id="CenterDetermination-1915"><a href="#CenterDetermination-1915"><span class="linenos">1915</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterDetermination-1916"><a href="#CenterDetermination-1916"><span class="linenos">1916</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination-1917"><a href="#CenterDetermination-1917"><span class="linenos">1917</span></a>        
</span><span id="CenterDetermination-1918"><a href="#CenterDetermination-1918"><span class="linenos">1918</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination-1919"><a href="#CenterDetermination-1919"><span class="linenos">1919</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1920"><a href="#CenterDetermination-1920"><span class="linenos">1920</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1921"><a href="#CenterDetermination-1921"><span class="linenos">1921</span></a> 
</span><span id="CenterDetermination-1922"><a href="#CenterDetermination-1922"><span class="linenos">1922</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Detected center&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1923"><a href="#CenterDetermination-1923"><span class="linenos">1923</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1924"><a href="#CenterDetermination-1924"><span class="linenos">1924</span></a>
</span><span id="CenterDetermination-1925"><a href="#CenterDetermination-1925"><span class="linenos">1925</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination-1926"><a href="#CenterDetermination-1926"><span class="linenos">1926</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination-1927"><a href="#CenterDetermination-1927"><span class="linenos">1927</span></a>                <span class="n">label</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;center:  [</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span>
</span><span id="CenterDetermination-1928"><a href="#CenterDetermination-1928"><span class="linenos">1928</span></a>                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterDetermination-1929"><a href="#CenterDetermination-1929"><span class="linenos">1929</span></a>
</span><span id="CenterDetermination-1930"><a href="#CenterDetermination-1930"><span class="linenos">1930</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1931"><a href="#CenterDetermination-1931"><span class="linenos">1931</span></a>        
</span><span id="CenterDetermination-1932"><a href="#CenterDetermination-1932"><span class="linenos">1932</span></a>        <span class="c1"># Display the image</span>
</span><span id="CenterDetermination-1933"><a href="#CenterDetermination-1933"><span class="linenos">1933</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination-1934"><a href="#CenterDetermination-1934"><span class="linenos">1934</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination-1935"><a href="#CenterDetermination-1935"><span class="linenos">1935</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination-1936"><a href="#CenterDetermination-1936"><span class="linenos">1936</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>CenterDetermination object - initial detection of a diffractogram center.</p>

<p>This class is responsible for identifying the center coordinates of 
a 2D diffraction pattern image using various detection methods specified 
by the user. It initializes with the input image and other parameters
that influence the center detection process.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>parent</strong> (CenterLocator):
Reference to the parent CenterLocator object, allowing access 
to shared attributes and methods.</li>
<li><strong>input_image</strong> (str, path, or numpy.array):
The input image representing a 2D diffraction pattern, provided as 
a file path or a NumPy array.</li>
<li><strong>determination</strong> (str or None, optional, default is None):
The method used for the initial center determination.
Options include:
<ul>
<li>'manual': Manual detection - user defines 3 points
on selected diffraction ring.</li>
<li>'hough': Auto-detection - Hough transform for circle detection.</li>
<li>'intensity': Auto-detection - intensity center in central region.</li>
</ul></li>
<li><strong>in_file</strong> (str, optional):
Filename of the text file from which to load previously saved 
center coordinates.</li>
<li><strong>out_file</strong> (str, optional):
Filename of the text file to which the detected center coordinates 
will be saved.</li>
<li><strong>heq</strong> (bool, optional):
Flag to indicate whether to perform histogram equalization on the 
input image. Default is False.</li>
<li><strong>icut</strong> (float, optional):
Cut-off intensity level for processing the image. Default is None.</li>
<li><strong>cmap</strong> (str, optional):
Colormap to be used for displaying the image. Default is 'gray'.</li>
<li><strong>csquare</strong> (int, optional):
Size of the square for processing. Default is 50.</li>
<li><strong>cintensity</strong> (float, optional):
Threshold intensity for detecting features in the image. Default is
0.8.</li>
<li><strong>messages</strong> (bool, optional):
Flag to enable or disable informational messages during processing. 
Default is False.</li>
<li><strong>print_sums</strong> (bool, optional):
If True, prints the sum of intensity values for the detected circle
after each adjustment, relevant only for manual detection methods.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The class preprocesses the input image and then applies the specified 
center detection method.</li>
<li>The detected center coordinates are stored in instance variables
<code>x</code>, <code>y</code>, and <code>r</code>, representing the center's x-coordinate, 
y-coordinate, and radius, respectively.</li>
</ul>
</div>


                            <div id="CenterDetermination.preprocess" class="classattr">
                                        <input id="CenterDetermination.preprocess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preprocess</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">preInit</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preHough</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preManual</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preVar</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preSum</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">preInt</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.preprocess-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.preprocess"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.preprocess-774"><a href="#CenterDetermination.preprocess-774"><span class="linenos">774</span></a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">preInit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preHough</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preManual</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="CenterDetermination.preprocess-775"><a href="#CenterDetermination.preprocess-775"><span class="linenos">775</span></a>                   <span class="n">preVar</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preSum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">preInt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  
</span><span id="CenterDetermination.preprocess-776"><a href="#CenterDetermination.preprocess-776"><span class="linenos">776</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; FOR AUTOMATIC METHODS OPTIMIZATION AND MORE UNIVERSAL SOLUTIONS</span>
</span><span id="CenterDetermination.preprocess-777"><a href="#CenterDetermination.preprocess-777"><span class="linenos">777</span></a><span class="sd">        Function for input image preprocessing based on the methods </span>
</span><span id="CenterDetermination.preprocess-778"><a href="#CenterDetermination.preprocess-778"><span class="linenos">778</span></a><span class="sd">        defined in the class initialization - self.detection_method, </span>
</span><span id="CenterDetermination.preprocess-779"><a href="#CenterDetermination.preprocess-779"><span class="linenos">779</span></a><span class="sd">        self.correction_method.</span>
</span><span id="CenterDetermination.preprocess-780"><a href="#CenterDetermination.preprocess-780"><span class="linenos">780</span></a>
</span><span id="CenterDetermination.preprocess-781"><a href="#CenterDetermination.preprocess-781"><span class="linenos">781</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.preprocess-782"><a href="#CenterDetermination.preprocess-782"><span class="linenos">782</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.preprocess-783"><a href="#CenterDetermination.preprocess-783"><span class="linenos">783</span></a><span class="sd">        preInit : bool, optional</span>
</span><span id="CenterDetermination.preprocess-784"><a href="#CenterDetermination.preprocess-784"><span class="linenos">784</span></a><span class="sd">            Perform preprocessing of the input image (when using icut or heq). </span>
</span><span id="CenterDetermination.preprocess-785"><a href="#CenterDetermination.preprocess-785"><span class="linenos">785</span></a><span class="sd">            This is called automatically every time, if no preprocessing</span>
</span><span id="CenterDetermination.preprocess-786"><a href="#CenterDetermination.preprocess-786"><span class="linenos">786</span></a><span class="sd">            specified, the detection and refinement will be performed on </span>
</span><span id="CenterDetermination.preprocess-787"><a href="#CenterDetermination.preprocess-787"><span class="linenos">787</span></a><span class="sd">            original image. The default is 0.</span>
</span><span id="CenterDetermination.preprocess-788"><a href="#CenterDetermination.preprocess-788"><span class="linenos">788</span></a><span class="sd">        preHough : bool, optional</span>
</span><span id="CenterDetermination.preprocess-789"><a href="#CenterDetermination.preprocess-789"><span class="linenos">789</span></a><span class="sd">            Perform preprocessing for automatic detection via Hough transform. </span>
</span><span id="CenterDetermination.preprocess-790"><a href="#CenterDetermination.preprocess-790"><span class="linenos">790</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.preprocess-791"><a href="#CenterDetermination.preprocess-791"><span class="linenos">791</span></a>
</span><span id="CenterDetermination.preprocess-792"><a href="#CenterDetermination.preprocess-792"><span class="linenos">792</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.preprocess-793"><a href="#CenterDetermination.preprocess-793"><span class="linenos">793</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.preprocess-794"><a href="#CenterDetermination.preprocess-794"><span class="linenos">794</span></a><span class="sd">        manu : NumPy array</span>
</span><span id="CenterDetermination.preprocess-795"><a href="#CenterDetermination.preprocess-795"><span class="linenos">795</span></a><span class="sd">            Pre-processed image for the manual detection method</span>
</span><span id="CenterDetermination.preprocess-796"><a href="#CenterDetermination.preprocess-796"><span class="linenos">796</span></a><span class="sd">        edges : array of bool</span>
</span><span id="CenterDetermination.preprocess-797"><a href="#CenterDetermination.preprocess-797"><span class="linenos">797</span></a><span class="sd">            Detected edges via Canny detector for automatic Hough transform</span>
</span><span id="CenterDetermination.preprocess-798"><a href="#CenterDetermination.preprocess-798"><span class="linenos">798</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.preprocess-799"><a href="#CenterDetermination.preprocess-799"><span class="linenos">799</span></a>        
</span><span id="CenterDetermination.preprocess-800"><a href="#CenterDetermination.preprocess-800"><span class="linenos">800</span></a>        <span class="c1"># Flags</span>
</span><span id="CenterDetermination.preprocess-801"><a href="#CenterDetermination.preprocess-801"><span class="linenos">801</span></a>        <span class="n">control_print</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.preprocess-802"><a href="#CenterDetermination.preprocess-802"><span class="linenos">802</span></a>        
</span><span id="CenterDetermination.preprocess-803"><a href="#CenterDetermination.preprocess-803"><span class="linenos">803</span></a>        <span class="c1"># Load original image</span>
</span><span id="CenterDetermination.preprocess-804"><a href="#CenterDetermination.preprocess-804"><span class="linenos">804</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-805"><a href="#CenterDetermination.preprocess-805"><span class="linenos">805</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-806"><a href="#CenterDetermination.preprocess-806"><span class="linenos">806</span></a>            
</span><span id="CenterDetermination.preprocess-807"><a href="#CenterDetermination.preprocess-807"><span class="linenos">807</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-808"><a href="#CenterDetermination.preprocess-808"><span class="linenos">808</span></a>        
</span><span id="CenterDetermination.preprocess-809"><a href="#CenterDetermination.preprocess-809"><span class="linenos">809</span></a>        <span class="c1">### After initialization: perform an image enhancement if specified</span>
</span><span id="CenterDetermination.preprocess-810"><a href="#CenterDetermination.preprocess-810"><span class="linenos">810</span></a>        <span class="k">if</span> <span class="n">preInit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-811"><a href="#CenterDetermination.preprocess-811"><span class="linenos">811</span></a>            <span class="c1"># Enhance diffraction pattern to make it more visible</span>
</span><span id="CenterDetermination.preprocess-812"><a href="#CenterDetermination.preprocess-812"><span class="linenos">812</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-813"><a href="#CenterDetermination.preprocess-813"><span class="linenos">813</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-814"><a href="#CenterDetermination.preprocess-814"><span class="linenos">814</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Histogram equalized.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-815"><a href="#CenterDetermination.preprocess-815"><span class="linenos">815</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">equalize_adapthist</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-816"><a href="#CenterDetermination.preprocess-816"><span class="linenos">816</span></a>
</span><span id="CenterDetermination.preprocess-817"><a href="#CenterDetermination.preprocess-817"><span class="linenos">817</span></a>                
</span><span id="CenterDetermination.preprocess-818"><a href="#CenterDetermination.preprocess-818"><span class="linenos">818</span></a>            <span class="c1"># # Edit contrast with a user-predefined parameter</span>
</span><span id="CenterDetermination.preprocess-819"><a href="#CenterDetermination.preprocess-819"><span class="linenos">819</span></a>            <span class="c1"># if self.parent.icut is not None:</span>
</span><span id="CenterDetermination.preprocess-820"><a href="#CenterDetermination.preprocess-820"><span class="linenos">820</span></a>            <span class="c1">#     if self.parent.messages:</span>
</span><span id="CenterDetermination.preprocess-821"><a href="#CenterDetermination.preprocess-821"><span class="linenos">821</span></a>            <span class="c1">#         print(&quot;Contrast enhanced.&quot;)</span>
</span><span id="CenterDetermination.preprocess-822"><a href="#CenterDetermination.preprocess-822"><span class="linenos">822</span></a>            <span class="c1">#     image = np.where(image &gt; self.parent.icut, </span>
</span><span id="CenterDetermination.preprocess-823"><a href="#CenterDetermination.preprocess-823"><span class="linenos">823</span></a>            <span class="c1">#                      self.parent.icut, </span>
</span><span id="CenterDetermination.preprocess-824"><a href="#CenterDetermination.preprocess-824"><span class="linenos">824</span></a>            <span class="c1">#                      image)</span>
</span><span id="CenterDetermination.preprocess-825"><a href="#CenterDetermination.preprocess-825"><span class="linenos">825</span></a>                
</span><span id="CenterDetermination.preprocess-826"><a href="#CenterDetermination.preprocess-826"><span class="linenos">826</span></a>
</span><span id="CenterDetermination.preprocess-827"><a href="#CenterDetermination.preprocess-827"><span class="linenos">827</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="CenterDetermination.preprocess-828"><a href="#CenterDetermination.preprocess-828"><span class="linenos">828</span></a>            <span class="k">return</span>
</span><span id="CenterDetermination.preprocess-829"><a href="#CenterDetermination.preprocess-829"><span class="linenos">829</span></a>        
</span><span id="CenterDetermination.preprocess-830"><a href="#CenterDetermination.preprocess-830"><span class="linenos">830</span></a>        <span class="c1">### Hough transform: perform pre-processing necessary for the detection</span>
</span><span id="CenterDetermination.preprocess-831"><a href="#CenterDetermination.preprocess-831"><span class="linenos">831</span></a>        <span class="k">if</span> <span class="n">preHough</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>           
</span><span id="CenterDetermination.preprocess-832"><a href="#CenterDetermination.preprocess-832"><span class="linenos">832</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-833"><a href="#CenterDetermination.preprocess-833"><span class="linenos">833</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination.preprocess-834"><a href="#CenterDetermination.preprocess-834"><span class="linenos">834</span></a>                
</span><span id="CenterDetermination.preprocess-835"><a href="#CenterDetermination.preprocess-835"><span class="linenos">835</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination.preprocess-836"><a href="#CenterDetermination.preprocess-836"><span class="linenos">836</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-837"><a href="#CenterDetermination.preprocess-837"><span class="linenos">837</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-838"><a href="#CenterDetermination.preprocess-838"><span class="linenos">838</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beamstopper removed.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-839"><a href="#CenterDetermination.preprocess-839"><span class="linenos">839</span></a>                    <span class="n">max_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-840"><a href="#CenterDetermination.preprocess-840"><span class="linenos">840</span></a>        
</span><span id="CenterDetermination.preprocess-841"><a href="#CenterDetermination.preprocess-841"><span class="linenos">841</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-842"><a href="#CenterDetermination.preprocess-842"><span class="linenos">842</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-843"><a href="#CenterDetermination.preprocess-843"><span class="linenos">843</span></a>        
</span><span id="CenterDetermination.preprocess-844"><a href="#CenterDetermination.preprocess-844"><span class="linenos">844</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination.preprocess-845"><a href="#CenterDetermination.preprocess-845"><span class="linenos">845</span></a>                    
</span><span id="CenterDetermination.preprocess-846"><a href="#CenterDetermination.preprocess-846"><span class="linenos">846</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination.preprocess-847"><a href="#CenterDetermination.preprocess-847"><span class="linenos">847</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-848"><a href="#CenterDetermination.preprocess-848"><span class="linenos">848</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-849"><a href="#CenterDetermination.preprocess-849"><span class="linenos">849</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-850"><a href="#CenterDetermination.preprocess-850"><span class="linenos">850</span></a>        
</span><span id="CenterDetermination.preprocess-851"><a href="#CenterDetermination.preprocess-851"><span class="linenos">851</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   
</span><span id="CenterDetermination.preprocess-852"><a href="#CenterDetermination.preprocess-852"><span class="linenos">852</span></a>                    
</span><span id="CenterDetermination.preprocess-853"><a href="#CenterDetermination.preprocess-853"><span class="linenos">853</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-854"><a href="#CenterDetermination.preprocess-854"><span class="linenos">854</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-855"><a href="#CenterDetermination.preprocess-855"><span class="linenos">855</span></a>                            <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-856"><a href="#CenterDetermination.preprocess-856"><span class="linenos">856</span></a>                            <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination.preprocess-857"><a href="#CenterDetermination.preprocess-857"><span class="linenos">857</span></a>                            <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-858"><a href="#CenterDetermination.preprocess-858"><span class="linenos">858</span></a>                    
</span><span id="CenterDetermination.preprocess-859"><a href="#CenterDetermination.preprocess-859"><span class="linenos">859</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination.preprocess-860"><a href="#CenterDetermination.preprocess-860"><span class="linenos">860</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-861"><a href="#CenterDetermination.preprocess-861"><span class="linenos">861</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-862"><a href="#CenterDetermination.preprocess-862"><span class="linenos">862</span></a>                    
</span><span id="CenterDetermination.preprocess-863"><a href="#CenterDetermination.preprocess-863"><span class="linenos">863</span></a>                    <span class="c1"># Erode the dilated edges to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination.preprocess-864"><a href="#CenterDetermination.preprocess-864"><span class="linenos">864</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-865"><a href="#CenterDetermination.preprocess-865"><span class="linenos">865</span></a>
</span><span id="CenterDetermination.preprocess-866"><a href="#CenterDetermination.preprocess-866"><span class="linenos">866</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-867"><a href="#CenterDetermination.preprocess-867"><span class="linenos">867</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-868"><a href="#CenterDetermination.preprocess-868"><span class="linenos">868</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-869"><a href="#CenterDetermination.preprocess-869"><span class="linenos">869</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-870"><a href="#CenterDetermination.preprocess-870"><span class="linenos">870</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-871"><a href="#CenterDetermination.preprocess-871"><span class="linenos">871</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-872"><a href="#CenterDetermination.preprocess-872"><span class="linenos">872</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-873"><a href="#CenterDetermination.preprocess-873"><span class="linenos">873</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-874"><a href="#CenterDetermination.preprocess-874"><span class="linenos">874</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-875"><a href="#CenterDetermination.preprocess-875"><span class="linenos">875</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-876"><a href="#CenterDetermination.preprocess-876"><span class="linenos">876</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-877"><a href="#CenterDetermination.preprocess-877"><span class="linenos">877</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-878"><a href="#CenterDetermination.preprocess-878"><span class="linenos">878</span></a>                        
</span><span id="CenterDetermination.preprocess-879"><a href="#CenterDetermination.preprocess-879"><span class="linenos">879</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination.preprocess-880"><a href="#CenterDetermination.preprocess-880"><span class="linenos">880</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-881"><a href="#CenterDetermination.preprocess-881"><span class="linenos">881</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-882"><a href="#CenterDetermination.preprocess-882"><span class="linenos">882</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No beamstopper.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-883"><a href="#CenterDetermination.preprocess-883"><span class="linenos">883</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-884"><a href="#CenterDetermination.preprocess-884"><span class="linenos">884</span></a>                                             <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-885"><a href="#CenterDetermination.preprocess-885"><span class="linenos">885</span></a>                                             <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-886"><a href="#CenterDetermination.preprocess-886"><span class="linenos">886</span></a>                                             <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-887"><a href="#CenterDetermination.preprocess-887"><span class="linenos">887</span></a>                    
</span><span id="CenterDetermination.preprocess-888"><a href="#CenterDetermination.preprocess-888"><span class="linenos">888</span></a>                    <span class="c1"># Dilate the edges to connect them</span>
</span><span id="CenterDetermination.preprocess-889"><a href="#CenterDetermination.preprocess-889"><span class="linenos">889</span></a>                    <span class="n">selem</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-890"><a href="#CenterDetermination.preprocess-890"><span class="linenos">890</span></a>                    <span class="n">dilated_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-891"><a href="#CenterDetermination.preprocess-891"><span class="linenos">891</span></a>                    
</span><span id="CenterDetermination.preprocess-892"><a href="#CenterDetermination.preprocess-892"><span class="linenos">892</span></a>                    <span class="c1"># Erode the dilated edges to reduce thickness and smooth the contour</span>
</span><span id="CenterDetermination.preprocess-893"><a href="#CenterDetermination.preprocess-893"><span class="linenos">893</span></a>                    <span class="n">connected_edges</span><span class="o">=</span><span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">dilated_edges</span><span class="p">,</span><span class="n">selem</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-894"><a href="#CenterDetermination.preprocess-894"><span class="linenos">894</span></a>                    <span class="n">connected_edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
</span><span id="CenterDetermination.preprocess-895"><a href="#CenterDetermination.preprocess-895"><span class="linenos">895</span></a>                        <span class="n">connected_edges</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-896"><a href="#CenterDetermination.preprocess-896"><span class="linenos">896</span></a>                        <span class="n">min_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-897"><a href="#CenterDetermination.preprocess-897"><span class="linenos">897</span></a>                    
</span><span id="CenterDetermination.preprocess-898"><a href="#CenterDetermination.preprocess-898"><span class="linenos">898</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-899"><a href="#CenterDetermination.preprocess-899"><span class="linenos">899</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-900"><a href="#CenterDetermination.preprocess-900"><span class="linenos">900</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-901"><a href="#CenterDetermination.preprocess-901"><span class="linenos">901</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-902"><a href="#CenterDetermination.preprocess-902"><span class="linenos">902</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-903"><a href="#CenterDetermination.preprocess-903"><span class="linenos">903</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-904"><a href="#CenterDetermination.preprocess-904"><span class="linenos">904</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,)</span>
</span><span id="CenterDetermination.preprocess-905"><a href="#CenterDetermination.preprocess-905"><span class="linenos">905</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-906"><a href="#CenterDetermination.preprocess-906"><span class="linenos">906</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">connected_edges</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-907"><a href="#CenterDetermination.preprocess-907"><span class="linenos">907</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-908"><a href="#CenterDetermination.preprocess-908"><span class="linenos">908</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-909"><a href="#CenterDetermination.preprocess-909"><span class="linenos">909</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-910"><a href="#CenterDetermination.preprocess-910"><span class="linenos">910</span></a>                
</span><span id="CenterDetermination.preprocess-911"><a href="#CenterDetermination.preprocess-911"><span class="linenos">911</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
</span><span id="CenterDetermination.preprocess-912"><a href="#CenterDetermination.preprocess-912"><span class="linenos">912</span></a>                <span class="c1"># Central square extraction</span>
</span><span id="CenterDetermination.preprocess-913"><a href="#CenterDetermination.preprocess-913"><span class="linenos">913</span></a>                <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>   
</span><span id="CenterDetermination.preprocess-914"><a href="#CenterDetermination.preprocess-914"><span class="linenos">914</span></a>
</span><span id="CenterDetermination.preprocess-915"><a href="#CenterDetermination.preprocess-915"><span class="linenos">915</span></a>                <span class="c1"># Beam stopper present in image</span>
</span><span id="CenterDetermination.preprocess-916"><a href="#CenterDetermination.preprocess-916"><span class="linenos">916</span></a>                <span class="k">if</span> <span class="mf">0.4</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">csq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.6</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-917"><a href="#CenterDetermination.preprocess-917"><span class="linenos">917</span></a>                    
</span><span id="CenterDetermination.preprocess-918"><a href="#CenterDetermination.preprocess-918"><span class="linenos">918</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> \
</span><span id="CenterDetermination.preprocess-919"><a href="#CenterDetermination.preprocess-919"><span class="linenos">919</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-920"><a href="#CenterDetermination.preprocess-920"><span class="linenos">920</span></a>    
</span><span id="CenterDetermination.preprocess-921"><a href="#CenterDetermination.preprocess-921"><span class="linenos">921</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-922"><a href="#CenterDetermination.preprocess-922"><span class="linenos">922</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.preprocess-923"><a href="#CenterDetermination.preprocess-923"><span class="linenos">923</span></a>    
</span><span id="CenterDetermination.preprocess-924"><a href="#CenterDetermination.preprocess-924"><span class="linenos">924</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
</span><span id="CenterDetermination.preprocess-925"><a href="#CenterDetermination.preprocess-925"><span class="linenos">925</span></a>                                                     
</span><span id="CenterDetermination.preprocess-926"><a href="#CenterDetermination.preprocess-926"><span class="linenos">926</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-927"><a href="#CenterDetermination.preprocess-927"><span class="linenos">927</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination.preprocess-928"><a href="#CenterDetermination.preprocess-928"><span class="linenos">928</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-929"><a href="#CenterDetermination.preprocess-929"><span class="linenos">929</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-930"><a href="#CenterDetermination.preprocess-930"><span class="linenos">930</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination.preprocess-931"><a href="#CenterDetermination.preprocess-931"><span class="linenos">931</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-932"><a href="#CenterDetermination.preprocess-932"><span class="linenos">932</span></a>
</span><span id="CenterDetermination.preprocess-933"><a href="#CenterDetermination.preprocess-933"><span class="linenos">933</span></a>                    
</span><span id="CenterDetermination.preprocess-934"><a href="#CenterDetermination.preprocess-934"><span class="linenos">934</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-935"><a href="#CenterDetermination.preprocess-935"><span class="linenos">935</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-936"><a href="#CenterDetermination.preprocess-936"><span class="linenos">936</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-937"><a href="#CenterDetermination.preprocess-937"><span class="linenos">937</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-938"><a href="#CenterDetermination.preprocess-938"><span class="linenos">938</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-939"><a href="#CenterDetermination.preprocess-939"><span class="linenos">939</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-940"><a href="#CenterDetermination.preprocess-940"><span class="linenos">940</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-941"><a href="#CenterDetermination.preprocess-941"><span class="linenos">941</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-942"><a href="#CenterDetermination.preprocess-942"><span class="linenos">942</span></a>                      <span class="c1">#  ax[1,1].imshow(connected_edges)</span>
</span><span id="CenterDetermination.preprocess-943"><a href="#CenterDetermination.preprocess-943"><span class="linenos">943</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-944"><a href="#CenterDetermination.preprocess-944"><span class="linenos">944</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-945"><a href="#CenterDetermination.preprocess-945"><span class="linenos">945</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-946"><a href="#CenterDetermination.preprocess-946"><span class="linenos">946</span></a>                    
</span><span id="CenterDetermination.preprocess-947"><a href="#CenterDetermination.preprocess-947"><span class="linenos">947</span></a>                <span class="c1"># No beam stopper in image</span>
</span><span id="CenterDetermination.preprocess-948"><a href="#CenterDetermination.preprocess-948"><span class="linenos">948</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-949"><a href="#CenterDetermination.preprocess-949"><span class="linenos">949</span></a>                    <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.preprocess-950"><a href="#CenterDetermination.preprocess-950"><span class="linenos">950</span></a>                    <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span>
</span><span id="CenterDetermination.preprocess-951"><a href="#CenterDetermination.preprocess-951"><span class="linenos">951</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-952"><a href="#CenterDetermination.preprocess-952"><span class="linenos">952</span></a>                        <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.preprocess-953"><a href="#CenterDetermination.preprocess-953"><span class="linenos">953</span></a>                        <span class="n">low_threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">),</span> 
</span><span id="CenterDetermination.preprocess-954"><a href="#CenterDetermination.preprocess-954"><span class="linenos">954</span></a>                        <span class="n">high_threshold</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">))</span>
</span><span id="CenterDetermination.preprocess-955"><a href="#CenterDetermination.preprocess-955"><span class="linenos">955</span></a>
</span><span id="CenterDetermination.preprocess-956"><a href="#CenterDetermination.preprocess-956"><span class="linenos">956</span></a>                    
</span><span id="CenterDetermination.preprocess-957"><a href="#CenterDetermination.preprocess-957"><span class="linenos">957</span></a>                    <span class="k">if</span> <span class="n">control_print</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.preprocess-958"><a href="#CenterDetermination.preprocess-958"><span class="linenos">958</span></a>                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-959"><a href="#CenterDetermination.preprocess-959"><span class="linenos">959</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-960"><a href="#CenterDetermination.preprocess-960"><span class="linenos">960</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original image&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-961"><a href="#CenterDetermination.preprocess-961"><span class="linenos">961</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-962"><a href="#CenterDetermination.preprocess-962"><span class="linenos">962</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hough pre-processed&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-963"><a href="#CenterDetermination.preprocess-963"><span class="linenos">963</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-964"><a href="#CenterDetermination.preprocess-964"><span class="linenos">964</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-965"><a href="#CenterDetermination.preprocess-965"><span class="linenos">965</span></a>                        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Connected edges&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-966"><a href="#CenterDetermination.preprocess-966"><span class="linenos">966</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.preprocess-967"><a href="#CenterDetermination.preprocess-967"><span class="linenos">967</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.preprocess-968"><a href="#CenterDetermination.preprocess-968"><span class="linenos">968</span></a>            
</span><span id="CenterDetermination.preprocess-969"><a href="#CenterDetermination.preprocess-969"><span class="linenos">969</span></a>            <span class="k">return</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>FOR AUTOMATIC METHODS OPTIMIZATION AND MORE UNIVERSAL SOLUTIONS
Function for input image preprocessing based on the methods 
defined in the class initialization - self.detection_method, 
self.correction_method.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>preInit</strong> (bool, optional):
Perform preprocessing of the input image (when using icut or heq). 
This is called automatically every time, if no preprocessing
specified, the detection and refinement will be performed on 
original image. The default is 0.</li>
<li><strong>preHough</strong> (bool, optional):
Perform preprocessing for automatic detection via Hough transform.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>manu</strong> (NumPy array):
Pre-processed image for the manual detection method</li>
<li><strong>edges</strong> (array of bool):
Detected edges via Canny detector for automatic Hough transform</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_intensity" class="classattr">
                                        <input id="CenterDetermination.detection_intensity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_intensity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">csquare</span>, </span><span class="param"><span class="n">cintensity</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_intensity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_intensity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_intensity-972"><a href="#CenterDetermination.detection_intensity-972"><span class="linenos"> 972</span></a>    <span class="k">def</span> <span class="nf">detection_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csquare</span><span class="p">,</span> <span class="n">cintensity</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_intensity-973"><a href="#CenterDetermination.detection_intensity-973"><span class="linenos"> 973</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination.detection_intensity-974"><a href="#CenterDetermination.detection_intensity-974"><span class="linenos"> 974</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="CenterDetermination.detection_intensity-975"><a href="#CenterDetermination.detection_intensity-975"><span class="linenos"> 975</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_intensity-976"><a href="#CenterDetermination.detection_intensity-976"><span class="linenos"> 976</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_intensity-977"><a href="#CenterDetermination.detection_intensity-977"><span class="linenos"> 977</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_intensity-978"><a href="#CenterDetermination.detection_intensity-978"><span class="linenos"> 978</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="CenterDetermination.detection_intensity-979"><a href="#CenterDetermination.detection_intensity-979"><span class="linenos"> 979</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="CenterDetermination.detection_intensity-980"><a href="#CenterDetermination.detection_intensity-980"><span class="linenos"> 980</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="CenterDetermination.detection_intensity-981"><a href="#CenterDetermination.detection_intensity-981"><span class="linenos"> 981</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="CenterDetermination.detection_intensity-982"><a href="#CenterDetermination.detection_intensity-982"><span class="linenos"> 982</span></a><span class="sd">            The intensity center will be searched only within the central square.</span>
</span><span id="CenterDetermination.detection_intensity-983"><a href="#CenterDetermination.detection_intensity-983"><span class="linenos"> 983</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="CenterDetermination.detection_intensity-984"><a href="#CenterDetermination.detection_intensity-984"><span class="linenos"> 984</span></a><span class="sd">            to minimize the effect of possible intensity assymetry around center. </span>
</span><span id="CenterDetermination.detection_intensity-985"><a href="#CenterDetermination.detection_intensity-985"><span class="linenos"> 985</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="CenterDetermination.detection_intensity-986"><a href="#CenterDetermination.detection_intensity-986"><span class="linenos"> 986</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="CenterDetermination.detection_intensity-987"><a href="#CenterDetermination.detection_intensity-987"><span class="linenos"> 987</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="CenterDetermination.detection_intensity-988"><a href="#CenterDetermination.detection_intensity-988"><span class="linenos"> 988</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="CenterDetermination.detection_intensity-989"><a href="#CenterDetermination.detection_intensity-989"><span class="linenos"> 989</span></a><span class="sd">            </span>
</span><span id="CenterDetermination.detection_intensity-990"><a href="#CenterDetermination.detection_intensity-990"><span class="linenos"> 990</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_intensity-991"><a href="#CenterDetermination.detection_intensity-991"><span class="linenos"> 991</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_intensity-992"><a href="#CenterDetermination.detection_intensity-992"><span class="linenos"> 992</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="CenterDetermination.detection_intensity-993"><a href="#CenterDetermination.detection_intensity-993"><span class="linenos"> 993</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="CenterDetermination.detection_intensity-994"><a href="#CenterDetermination.detection_intensity-994"><span class="linenos"> 994</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.</span>
</span><span id="CenterDetermination.detection_intensity-995"><a href="#CenterDetermination.detection_intensity-995"><span class="linenos"> 995</span></a><span class="sd">        &#39;&#39;&#39;</span>  
</span><span id="CenterDetermination.detection_intensity-996"><a href="#CenterDetermination.detection_intensity-996"><span class="linenos"> 996</span></a>        
</span><span id="CenterDetermination.detection_intensity-997"><a href="#CenterDetermination.detection_intensity-997"><span class="linenos"> 997</span></a>        <span class="c1"># (1) Get image/array size</span>
</span><span id="CenterDetermination.detection_intensity-998"><a href="#CenterDetermination.detection_intensity-998"><span class="linenos"> 998</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-999"><a href="#CenterDetermination.detection_intensity-999"><span class="linenos"> 999</span></a>        
</span><span id="CenterDetermination.detection_intensity-1000"><a href="#CenterDetermination.detection_intensity-1000"><span class="linenos">1000</span></a>                
</span><span id="CenterDetermination.detection_intensity-1001"><a href="#CenterDetermination.detection_intensity-1001"><span class="linenos">1001</span></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1002"><a href="#CenterDetermination.detection_intensity-1002"><span class="linenos">1002</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="CenterDetermination.detection_intensity-1003"><a href="#CenterDetermination.detection_intensity-1003"><span class="linenos">1003</span></a>        
</span><span id="CenterDetermination.detection_intensity-1004"><a href="#CenterDetermination.detection_intensity-1004"><span class="linenos">1004</span></a>        <span class="c1"># (2) Calculate borders around the central square</span>
</span><span id="CenterDetermination.detection_intensity-1005"><a href="#CenterDetermination.detection_intensity-1005"><span class="linenos">1005</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_intensity-1006"><a href="#CenterDetermination.detection_intensity-1006"><span class="linenos">1006</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="CenterDetermination.detection_intensity-1007"><a href="#CenterDetermination.detection_intensity-1007"><span class="linenos">1007</span></a>        
</span><span id="CenterDetermination.detection_intensity-1008"><a href="#CenterDetermination.detection_intensity-1008"><span class="linenos">1008</span></a>        <span class="c1"># (3) Create the central square,</span>
</span><span id="CenterDetermination.detection_intensity-1009"><a href="#CenterDetermination.detection_intensity-1009"><span class="linenos">1009</span></a>        <span class="c1"># from which the intensity center will be detected</span>
</span><span id="CenterDetermination.detection_intensity-1010"><a href="#CenterDetermination.detection_intensity-1010"><span class="linenos">1010</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_intensity-1011"><a href="#CenterDetermination.detection_intensity-1011"><span class="linenos">1011</span></a>        
</span><span id="CenterDetermination.detection_intensity-1012"><a href="#CenterDetermination.detection_intensity-1012"><span class="linenos">1012</span></a>        <span class="c1"># (4) In the central square,</span>
</span><span id="CenterDetermination.detection_intensity-1013"><a href="#CenterDetermination.detection_intensity-1013"><span class="linenos">1013</span></a>        <span class="c1"># set all values below cintenstity to zero</span>
</span><span id="CenterDetermination.detection_intensity-1014"><a href="#CenterDetermination.detection_intensity-1014"><span class="linenos">1014</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1015"><a href="#CenterDetermination.detection_intensity-1015"><span class="linenos">1015</span></a>        
</span><span id="CenterDetermination.detection_intensity-1016"><a href="#CenterDetermination.detection_intensity-1016"><span class="linenos">1016</span></a>        <span class="c1"># (5) Determine the intensity center from image moments</span>
</span><span id="CenterDetermination.detection_intensity-1017"><a href="#CenterDetermination.detection_intensity-1017"><span class="linenos">1017</span></a>        <span class="c1"># see image moments in...</span>
</span><span id="CenterDetermination.detection_intensity-1018"><a href="#CenterDetermination.detection_intensity-1018"><span class="linenos">1018</span></a>        <span class="c1"># skimage: https://scikit-image.org/docs/dev/api/skimage.measure.html</span>
</span><span id="CenterDetermination.detection_intensity-1019"><a href="#CenterDetermination.detection_intensity-1019"><span class="linenos">1019</span></a>        <span class="c1"># wikipedia: https://en.wikipedia.org/wiki/Image_moment -&gt; Centroid</span>
</span><span id="CenterDetermination.detection_intensity-1020"><a href="#CenterDetermination.detection_intensity-1020"><span class="linenos">1020</span></a>        <span class="c1"># ---</span>
</span><span id="CenterDetermination.detection_intensity-1021"><a href="#CenterDetermination.detection_intensity-1021"><span class="linenos">1021</span></a>        <span class="c1"># (a) Calculate 1st central moments of the image</span>
</span><span id="CenterDetermination.detection_intensity-1022"><a href="#CenterDetermination.detection_intensity-1022"><span class="linenos">1022</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1023"><a href="#CenterDetermination.detection_intensity-1023"><span class="linenos">1023</span></a>        <span class="c1"># (b) Calculate the intensity center = centroid according to www-help</span>
</span><span id="CenterDetermination.detection_intensity-1024"><a href="#CenterDetermination.detection_intensity-1024"><span class="linenos">1024</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination.detection_intensity-1025"><a href="#CenterDetermination.detection_intensity-1025"><span class="linenos">1025</span></a>        <span class="c1"># (c) We have centroid of the central square</span>
</span><span id="CenterDetermination.detection_intensity-1026"><a href="#CenterDetermination.detection_intensity-1026"><span class="linenos">1026</span></a>        <span class="c1"># but we have to recalculate it to the whole image</span>
</span><span id="CenterDetermination.detection_intensity-1027"><a href="#CenterDetermination.detection_intensity-1027"><span class="linenos">1027</span></a>        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">xborder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">yborder</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_intensity-1028"><a href="#CenterDetermination.detection_intensity-1028"><span class="linenos">1028</span></a>        <span class="c1"># (d) Radius of a diffraction ring is hardcoded to 100 here</span>
</span><span id="CenterDetermination.detection_intensity-1029"><a href="#CenterDetermination.detection_intensity-1029"><span class="linenos">1029</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterDetermination.detection_intensity-1030"><a href="#CenterDetermination.detection_intensity-1030"><span class="linenos">1030</span></a>        
</span><span id="CenterDetermination.detection_intensity-1031"><a href="#CenterDetermination.detection_intensity-1031"><span class="linenos">1031</span></a>        <span class="c1"># (6) User information (if required)</span>
</span><span id="CenterDetermination.detection_intensity-1032"><a href="#CenterDetermination.detection_intensity-1032"><span class="linenos">1032</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_intensity-1033"><a href="#CenterDetermination.detection_intensity-1033"><span class="linenos">1033</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (IntensityCenter): (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.detection_intensity-1034"><a href="#CenterDetermination.detection_intensity-1034"><span class="linenos">1034</span></a>
</span><span id="CenterDetermination.detection_intensity-1035"><a href="#CenterDetermination.detection_intensity-1035"><span class="linenos">1035</span></a>
</span><span id="CenterDetermination.detection_intensity-1036"><a href="#CenterDetermination.detection_intensity-1036"><span class="linenos">1036</span></a>        <span class="c1"># (7) Plot results (if required)</span>
</span><span id="CenterDetermination.detection_intensity-1037"><a href="#CenterDetermination.detection_intensity-1037"><span class="linenos">1037</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_intensity-1038"><a href="#CenterDetermination.detection_intensity-1038"><span class="linenos">1038</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_intensity-1039"><a href="#CenterDetermination.detection_intensity-1039"><span class="linenos">1039</span></a>                
</span><span id="CenterDetermination.detection_intensity-1040"><a href="#CenterDetermination.detection_intensity-1040"><span class="linenos">1040</span></a>        <span class="c1"># (8) Return the results:</span>
</span><span id="CenterDetermination.detection_intensity-1041"><a href="#CenterDetermination.detection_intensity-1041"><span class="linenos">1041</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="CenterDetermination.detection_intensity-1042"><a href="#CenterDetermination.detection_intensity-1042"><span class="linenos">1042</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination.detection_intensity-1043"><a href="#CenterDetermination.detection_intensity-1043"><span class="linenos">1043</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="CenterDetermination.detection_intensity-1044"><a href="#CenterDetermination.detection_intensity-1044"><span class="linenos">1044</span></a>        <span class="c1"># ! radius of the circle is just hardcoded here - see TODO note above</span>
</span><span id="CenterDetermination.detection_intensity-1045"><a href="#CenterDetermination.detection_intensity-1045"><span class="linenos">1045</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find center of intensity/mass of an array.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>arr</strong> (2D-numpy array):
The array, whose intensity center will be determined.</li>
<li><strong>csquare</strong> (int, optional, default is 20):
The size/edge of the square in the (geometrical) center.
The intensity center will be searched only within the central square.
Reasons: To avoid other spots/diffractions and
to minimize the effect of possible intensity assymetry around center.</li>
<li><strong>cintensity</strong> (float, optional, default is 0.8):
The intensity fraction.
When searching the intensity center, we will consider only
pixels with intensity &gt; max.intensity.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xc,yc</strong> (float,float):
XY-coordinates of the intensity/mass center of the array.
Round XY-coordinates if you use them for image/array calculations.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_Hough" class="classattr">
                                        <input id="CenterDetermination.detection_Hough-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_Hough</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_Hough-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_Hough"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_Hough-1048"><a href="#CenterDetermination.detection_Hough-1048"><span class="linenos">1048</span></a>    <span class="k">def</span> <span class="nf">detection_Hough</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_Hough-1049"><a href="#CenterDetermination.detection_Hough-1049"><span class="linenos">1049</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;        </span>
</span><span id="CenterDetermination.detection_Hough-1050"><a href="#CenterDetermination.detection_Hough-1050"><span class="linenos">1050</span></a><span class="sd">        Perform Hough transform to detect center of diffraction patterns.</span>
</span><span id="CenterDetermination.detection_Hough-1051"><a href="#CenterDetermination.detection_Hough-1051"><span class="linenos">1051</span></a><span class="sd">        This is a method to automatically detect circular diffraction patterns</span>
</span><span id="CenterDetermination.detection_Hough-1052"><a href="#CenterDetermination.detection_Hough-1052"><span class="linenos">1052</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_Hough-1053"><a href="#CenterDetermination.detection_Hough-1053"><span class="linenos">1053</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_Hough-1054"><a href="#CenterDetermination.detection_Hough-1054"><span class="linenos">1054</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_Hough-1055"><a href="#CenterDetermination.detection_Hough-1055"><span class="linenos">1055</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination.detection_Hough-1056"><a href="#CenterDetermination.detection_Hough-1056"><span class="linenos">1056</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="CenterDetermination.detection_Hough-1057"><a href="#CenterDetermination.detection_Hough-1057"><span class="linenos">1057</span></a><span class="sd">            Default is 1. To cancel visualization, set plot_results = 0.</span>
</span><span id="CenterDetermination.detection_Hough-1058"><a href="#CenterDetermination.detection_Hough-1058"><span class="linenos">1058</span></a>
</span><span id="CenterDetermination.detection_Hough-1059"><a href="#CenterDetermination.detection_Hough-1059"><span class="linenos">1059</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_Hough-1060"><a href="#CenterDetermination.detection_Hough-1060"><span class="linenos">1060</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_Hough-1061"><a href="#CenterDetermination.detection_Hough-1061"><span class="linenos">1061</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination.detection_Hough-1062"><a href="#CenterDetermination.detection_Hough-1062"><span class="linenos">1062</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination.detection_Hough-1063"><a href="#CenterDetermination.detection_Hough-1063"><span class="linenos">1063</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination.detection_Hough-1064"><a href="#CenterDetermination.detection_Hough-1064"><span class="linenos">1064</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination.detection_Hough-1065"><a href="#CenterDetermination.detection_Hough-1065"><span class="linenos">1065</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination.detection_Hough-1066"><a href="#CenterDetermination.detection_Hough-1066"><span class="linenos">1066</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination.detection_Hough-1067"><a href="#CenterDetermination.detection_Hough-1067"><span class="linenos">1067</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination.detection_Hough-1068"><a href="#CenterDetermination.detection_Hough-1068"><span class="linenos">1068</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination.detection_Hough-1069"><a href="#CenterDetermination.detection_Hough-1069"><span class="linenos">1069</span></a>        <span class="c1">## Image preprocessing</span>
</span><span id="CenterDetermination.detection_Hough-1070"><a href="#CenterDetermination.detection_Hough-1070"><span class="linenos">1070</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1071"><a href="#CenterDetermination.detection_Hough-1071"><span class="linenos">1071</span></a>        
</span><span id="CenterDetermination.detection_Hough-1072"><a href="#CenterDetermination.detection_Hough-1072"><span class="linenos">1072</span></a>        <span class="c1"># if the brightness of the image is small enough, pixel values greater</span>
</span><span id="CenterDetermination.detection_Hough-1073"><a href="#CenterDetermination.detection_Hough-1073"><span class="linenos">1073</span></a>        <span class="c1"># than 50 will be set to 0 -- removal of the beam stopper influence</span>
</span><span id="CenterDetermination.detection_Hough-1074"><a href="#CenterDetermination.detection_Hough-1074"><span class="linenos">1074</span></a>        
</span><span id="CenterDetermination.detection_Hough-1075"><a href="#CenterDetermination.detection_Hough-1075"><span class="linenos">1075</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1076"><a href="#CenterDetermination.detection_Hough-1076"><span class="linenos">1076</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1077"><a href="#CenterDetermination.detection_Hough-1077"><span class="linenos">1077</span></a>                    <span class="n">max_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1078"><a href="#CenterDetermination.detection_Hough-1078"><span class="linenos">1078</span></a>        
</span><span id="CenterDetermination.detection_Hough-1079"><a href="#CenterDetermination.detection_Hough-1079"><span class="linenos">1079</span></a>                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_Hough-1080"><a href="#CenterDetermination.detection_Hough-1080"><span class="linenos">1080</span></a>                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_Hough-1081"><a href="#CenterDetermination.detection_Hough-1081"><span class="linenos">1081</span></a>        
</span><span id="CenterDetermination.detection_Hough-1082"><a href="#CenterDetermination.detection_Hough-1082"><span class="linenos">1082</span></a>                    <span class="n">im</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination.detection_Hough-1083"><a href="#CenterDetermination.detection_Hough-1083"><span class="linenos">1083</span></a>                
</span><span id="CenterDetermination.detection_Hough-1084"><a href="#CenterDetermination.detection_Hough-1084"><span class="linenos">1084</span></a>            <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.detection_Hough-1085"><a href="#CenterDetermination.detection_Hough-1085"><span class="linenos">1085</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1086"><a href="#CenterDetermination.detection_Hough-1086"><span class="linenos">1086</span></a>                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1087"><a href="#CenterDetermination.detection_Hough-1087"><span class="linenos">1087</span></a>                                     <span class="n">low_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1088"><a href="#CenterDetermination.detection_Hough-1088"><span class="linenos">1088</span></a>                                     <span class="n">high_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1089"><a href="#CenterDetermination.detection_Hough-1089"><span class="linenos">1089</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">heq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1090"><a href="#CenterDetermination.detection_Hough-1090"><span class="linenos">1090</span></a>            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1091"><a href="#CenterDetermination.detection_Hough-1091"><span class="linenos">1091</span></a>                <span class="n">max_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1092"><a href="#CenterDetermination.detection_Hough-1092"><span class="linenos">1092</span></a>
</span><span id="CenterDetermination.detection_Hough-1093"><a href="#CenterDetermination.detection_Hough-1093"><span class="linenos">1093</span></a>                <span class="n">row_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_Hough-1094"><a href="#CenterDetermination.detection_Hough-1094"><span class="linenos">1094</span></a>                <span class="n">col_idx</span> <span class="o">=</span> <span class="n">max_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_Hough-1095"><a href="#CenterDetermination.detection_Hough-1095"><span class="linenos">1095</span></a>
</span><span id="CenterDetermination.detection_Hough-1096"><a href="#CenterDetermination.detection_Hough-1096"><span class="linenos">1096</span></a>                <span class="n">im</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="CenterDetermination.detection_Hough-1097"><a href="#CenterDetermination.detection_Hough-1097"><span class="linenos">1097</span></a>            
</span><span id="CenterDetermination.detection_Hough-1098"><a href="#CenterDetermination.detection_Hough-1098"><span class="linenos">1098</span></a>            <span class="c1"># Detect edges using the Canny edge detector</span>
</span><span id="CenterDetermination.detection_Hough-1099"><a href="#CenterDetermination.detection_Hough-1099"><span class="linenos">1099</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1100"><a href="#CenterDetermination.detection_Hough-1100"><span class="linenos">1100</span></a>                                     <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1101"><a href="#CenterDetermination.detection_Hough-1101"><span class="linenos">1101</span></a>                                     <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1102"><a href="#CenterDetermination.detection_Hough-1102"><span class="linenos">1102</span></a>                                     <span class="n">high_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1103"><a href="#CenterDetermination.detection_Hough-1103"><span class="linenos">1103</span></a>        
</span><span id="CenterDetermination.detection_Hough-1104"><a href="#CenterDetermination.detection_Hough-1104"><span class="linenos">1104</span></a>        
</span><span id="CenterDetermination.detection_Hough-1105"><a href="#CenterDetermination.detection_Hough-1105"><span class="linenos">1105</span></a>        <span class="c1"># Define the radii range for the concentric circles</span>
</span><span id="CenterDetermination.detection_Hough-1106"><a href="#CenterDetermination.detection_Hough-1106"><span class="linenos">1106</span></a>        <span class="c1"># (set empirically based on the available pictures)</span>
</span><span id="CenterDetermination.detection_Hough-1107"><a href="#CenterDetermination.detection_Hough-1107"><span class="linenos">1107</span></a>        <span class="n">min_radius</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="CenterDetermination.detection_Hough-1108"><a href="#CenterDetermination.detection_Hough-1108"><span class="linenos">1108</span></a>        <span class="n">max_radius</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="CenterDetermination.detection_Hough-1109"><a href="#CenterDetermination.detection_Hough-1109"><span class="linenos">1109</span></a>        <span class="n">radius_step</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="CenterDetermination.detection_Hough-1110"><a href="#CenterDetermination.detection_Hough-1110"><span class="linenos">1110</span></a>        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_radius</span><span class="p">,</span> <span class="n">max_radius</span> <span class="o">+</span> <span class="n">radius_step</span><span class="p">,</span> <span class="n">radius_step</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1111"><a href="#CenterDetermination.detection_Hough-1111"><span class="linenos">1111</span></a>
</span><span id="CenterDetermination.detection_Hough-1112"><a href="#CenterDetermination.detection_Hough-1112"><span class="linenos">1112</span></a>        <span class="c1">### Perform the Hough transform to detect circles</span>
</span><span id="CenterDetermination.detection_Hough-1113"><a href="#CenterDetermination.detection_Hough-1113"><span class="linenos">1113</span></a>        <span class="c1"># Circle detection involves converting edge pixels into parameter space, </span>
</span><span id="CenterDetermination.detection_Hough-1114"><a href="#CenterDetermination.detection_Hough-1114"><span class="linenos">1114</span></a>        <span class="c1"># where each point represents a possible circle center and radius. </span>
</span><span id="CenterDetermination.detection_Hough-1115"><a href="#CenterDetermination.detection_Hough-1115"><span class="linenos">1115</span></a>        <span class="c1"># The circles are then identified as peaks in the parameter space, </span>
</span><span id="CenterDetermination.detection_Hough-1116"><a href="#CenterDetermination.detection_Hough-1116"><span class="linenos">1116</span></a>        <span class="c1"># enabling accurate detection of circular shapes in the image.</span>
</span><span id="CenterDetermination.detection_Hough-1117"><a href="#CenterDetermination.detection_Hough-1117"><span class="linenos">1117</span></a>        <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1118"><a href="#CenterDetermination.detection_Hough-1118"><span class="linenos">1118</span></a>
</span><span id="CenterDetermination.detection_Hough-1119"><a href="#CenterDetermination.detection_Hough-1119"><span class="linenos">1119</span></a>        <span class="c1"># Extract the circle peaks</span>
</span><span id="CenterDetermination.detection_Hough-1120"><a href="#CenterDetermination.detection_Hough-1120"><span class="linenos">1120</span></a>        <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1121"><a href="#CenterDetermination.detection_Hough-1121"><span class="linenos">1121</span></a>                                                            <span class="n">radii</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_Hough-1122"><a href="#CenterDetermination.detection_Hough-1122"><span class="linenos">1122</span></a>                                                            <span class="n">total_num_peaks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_Hough-1123"><a href="#CenterDetermination.detection_Hough-1123"><span class="linenos">1123</span></a>        
</span><span id="CenterDetermination.detection_Hough-1124"><a href="#CenterDetermination.detection_Hough-1124"><span class="linenos">1124</span></a>        
</span><span id="CenterDetermination.detection_Hough-1125"><a href="#CenterDetermination.detection_Hough-1125"><span class="linenos">1125</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination.detection_Hough-1126"><a href="#CenterDetermination.detection_Hough-1126"><span class="linenos">1126</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_Hough-1127"><a href="#CenterDetermination.detection_Hough-1127"><span class="linenos">1127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (HoughTransform) : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.detection_Hough-1128"><a href="#CenterDetermination.detection_Hough-1128"><span class="linenos">1128</span></a>        
</span><span id="CenterDetermination.detection_Hough-1129"><a href="#CenterDetermination.detection_Hough-1129"><span class="linenos">1129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> \
</span><span id="CenterDetermination.detection_Hough-1130"><a href="#CenterDetermination.detection_Hough-1130"><span class="linenos">1130</span></a>            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="CenterDetermination.detection_Hough-1131"><a href="#CenterDetermination.detection_Hough-1131"><span class="linenos">1131</span></a>
</span><span id="CenterDetermination.detection_Hough-1132"><a href="#CenterDetermination.detection_Hough-1132"><span class="linenos">1132</span></a>        <span class="c1"># (7) Plot results (if required)</span>
</span><span id="CenterDetermination.detection_Hough-1133"><a href="#CenterDetermination.detection_Hough-1133"><span class="linenos">1133</span></a>        <span class="k">if</span> <span class="n">plot_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_Hough-1134"><a href="#CenterDetermination.detection_Hough-1134"><span class="linenos">1134</span></a>           <span class="bp">self</span><span class="o">.</span><span class="n">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_Hough-1135"><a href="#CenterDetermination.detection_Hough-1135"><span class="linenos">1135</span></a>           
</span><span id="CenterDetermination.detection_Hough-1136"><a href="#CenterDetermination.detection_Hough-1136"><span class="linenos">1136</span></a>        <span class="c1"># Return results, convert coordinates to float</span>
</span><span id="CenterDetermination.detection_Hough-1137"><a href="#CenterDetermination.detection_Hough-1137"><span class="linenos">1137</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
</span></pre></div>


            <div class="docstring"><p>Perform Hough transform to detect center of diffraction patterns.
This is a method to automatically detect circular diffraction patterns</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>plot_results</strong> (int, binary):
Plot the pattern determined by pixels selected by the user.
Default is 1. To cancel visualization, set plot_results = 0.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>self.x</strong> (float64):
x-coordinate of the detected center</li>
<li><strong>self.y</strong> (float64):
y-coordinate of the detected center</li>
<li><strong>self.r</strong> (float64):
radius of the detected center</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.detection_3points" class="classattr">
                                        <input id="CenterDetermination.detection_3points-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detection_3points</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterDetermination.detection_3points-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.detection_3points"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.detection_3points-1140"><a href="#CenterDetermination.detection_3points-1140"><span class="linenos">1140</span></a>    <span class="k">def</span> <span class="nf">detection_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_3points-1141"><a href="#CenterDetermination.detection_3points-1141"><span class="linenos">1141</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination.detection_3points-1142"><a href="#CenterDetermination.detection_3points-1142"><span class="linenos">1142</span></a><span class="sd">        In the input image, select manually 3 points defining a circle using</span>
</span><span id="CenterDetermination.detection_3points-1143"><a href="#CenterDetermination.detection_3points-1143"><span class="linenos">1143</span></a><span class="sd">        a key press event </span>
</span><span id="CenterDetermination.detection_3points-1144"><a href="#CenterDetermination.detection_3points-1144"><span class="linenos">1144</span></a><span class="sd">            - press &#39;1&#39; to select a point</span>
</span><span id="CenterDetermination.detection_3points-1145"><a href="#CenterDetermination.detection_3points-1145"><span class="linenos">1145</span></a><span class="sd">                </span>
</span><span id="CenterDetermination.detection_3points-1146"><a href="#CenterDetermination.detection_3points-1146"><span class="linenos">1146</span></a><span class="sd">        If the user is not satisfied with the point selection, it can be</span>
</span><span id="CenterDetermination.detection_3points-1147"><a href="#CenterDetermination.detection_3points-1147"><span class="linenos">1147</span></a><span class="sd">        deleted using a key press event:</span>
</span><span id="CenterDetermination.detection_3points-1148"><a href="#CenterDetermination.detection_3points-1148"><span class="linenos">1148</span></a><span class="sd">            - press &#39;2&#39; to delete the most recent</span>
</span><span id="CenterDetermination.detection_3points-1149"><a href="#CenterDetermination.detection_3points-1149"><span class="linenos">1149</span></a><span class="sd">            - press &#39;3&#39; to delete the point closest to the cursor</span>
</span><span id="CenterDetermination.detection_3points-1150"><a href="#CenterDetermination.detection_3points-1150"><span class="linenos">1150</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_3points-1151"><a href="#CenterDetermination.detection_3points-1151"><span class="linenos">1151</span></a><span class="sd">        If the user is satisified with the points selected, the rest </span>
</span><span id="CenterDetermination.detection_3points-1152"><a href="#CenterDetermination.detection_3points-1152"><span class="linenos">1152</span></a><span class="sd">        of the program will be executed </span>
</span><span id="CenterDetermination.detection_3points-1153"><a href="#CenterDetermination.detection_3points-1153"><span class="linenos">1153</span></a><span class="sd">            - press &#39;d&#39; to proceed &gt;DONE&lt;</span>
</span><span id="CenterDetermination.detection_3points-1154"><a href="#CenterDetermination.detection_3points-1154"><span class="linenos">1154</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_3points-1155"><a href="#CenterDetermination.detection_3points-1155"><span class="linenos">1155</span></a><span class="sd">        Coordinates of the center and radius will be calculated automatically</span>
</span><span id="CenterDetermination.detection_3points-1156"><a href="#CenterDetermination.detection_3points-1156"><span class="linenos">1156</span></a><span class="sd">        using method self.calculate_circle()</span>
</span><span id="CenterDetermination.detection_3points-1157"><a href="#CenterDetermination.detection_3points-1157"><span class="linenos">1157</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_3points-1158"><a href="#CenterDetermination.detection_3points-1158"><span class="linenos">1158</span></a><span class="sd">        In addition, the user will be able to manually adjust the original</span>
</span><span id="CenterDetermination.detection_3points-1159"><a href="#CenterDetermination.detection_3points-1159"><span class="linenos">1159</span></a><span class="sd">        center position by using pre-defined keys.</span>
</span><span id="CenterDetermination.detection_3points-1160"><a href="#CenterDetermination.detection_3points-1160"><span class="linenos">1160</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_3points-1161"><a href="#CenterDetermination.detection_3points-1161"><span class="linenos">1161</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.detection_3points-1162"><a href="#CenterDetermination.detection_3points-1162"><span class="linenos">1162</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.detection_3points-1163"><a href="#CenterDetermination.detection_3points-1163"><span class="linenos">1163</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination.detection_3points-1164"><a href="#CenterDetermination.detection_3points-1164"><span class="linenos">1164</span></a><span class="sd">            Plot the pattern determined by pixels selected by the user.</span>
</span><span id="CenterDetermination.detection_3points-1165"><a href="#CenterDetermination.detection_3points-1165"><span class="linenos">1165</span></a><span class="sd">            Default is 1. To cancel visualization, set plot_results = 0.</span>
</span><span id="CenterDetermination.detection_3points-1166"><a href="#CenterDetermination.detection_3points-1166"><span class="linenos">1166</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.detection_3points-1167"><a href="#CenterDetermination.detection_3points-1167"><span class="linenos">1167</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.detection_3points-1168"><a href="#CenterDetermination.detection_3points-1168"><span class="linenos">1168</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.detection_3points-1169"><a href="#CenterDetermination.detection_3points-1169"><span class="linenos">1169</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination.detection_3points-1170"><a href="#CenterDetermination.detection_3points-1170"><span class="linenos">1170</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination.detection_3points-1171"><a href="#CenterDetermination.detection_3points-1171"><span class="linenos">1171</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination.detection_3points-1172"><a href="#CenterDetermination.detection_3points-1172"><span class="linenos">1172</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination.detection_3points-1173"><a href="#CenterDetermination.detection_3points-1173"><span class="linenos">1173</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination.detection_3points-1174"><a href="#CenterDetermination.detection_3points-1174"><span class="linenos">1174</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination.detection_3points-1175"><a href="#CenterDetermination.detection_3points-1175"><span class="linenos">1175</span></a><span class="sd">            (if available, othervise returns None)</span>
</span><span id="CenterDetermination.detection_3points-1176"><a href="#CenterDetermination.detection_3points-1176"><span class="linenos">1176</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination.detection_3points-1177"><a href="#CenterDetermination.detection_3points-1177"><span class="linenos">1177</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination.detection_3points-1178"><a href="#CenterDetermination.detection_3points-1178"><span class="linenos">1178</span></a>        
</span><span id="CenterDetermination.detection_3points-1179"><a href="#CenterDetermination.detection_3points-1179"><span class="linenos">1179</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterDetermination.detection_3points-1180"><a href="#CenterDetermination.detection_3points-1180"><span class="linenos">1180</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span>
</span><span id="CenterDetermination.detection_3points-1181"><a href="#CenterDetermination.detection_3points-1181"><span class="linenos">1181</span></a>        
</span><span id="CenterDetermination.detection_3points-1182"><a href="#CenterDetermination.detection_3points-1182"><span class="linenos">1182</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterDetermination.detection_3points-1183"><a href="#CenterDetermination.detection_3points-1183"><span class="linenos">1183</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1184"><a href="#CenterDetermination.detection_3points-1184"><span class="linenos">1184</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1185"><a href="#CenterDetermination.detection_3points-1185"><span class="linenos">1185</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1186"><a href="#CenterDetermination.detection_3points-1186"><span class="linenos">1186</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1187"><a href="#CenterDetermination.detection_3points-1187"><span class="linenos">1187</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1188"><a href="#CenterDetermination.detection_3points-1188"><span class="linenos">1188</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1189"><a href="#CenterDetermination.detection_3points-1189"><span class="linenos">1189</span></a>            
</span><span id="CenterDetermination.detection_3points-1190"><a href="#CenterDetermination.detection_3points-1190"><span class="linenos">1190</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterDetermination.detection_3points-1191"><a href="#CenterDetermination.detection_3points-1191"><span class="linenos">1191</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="CenterDetermination.detection_3points-1192"><a href="#CenterDetermination.detection_3points-1192"><span class="linenos">1192</span></a>        
</span><span id="CenterDetermination.detection_3points-1193"><a href="#CenterDetermination.detection_3points-1193"><span class="linenos">1193</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination.detection_3points-1194"><a href="#CenterDetermination.detection_3points-1194"><span class="linenos">1194</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1195"><a href="#CenterDetermination.detection_3points-1195"><span class="linenos">1195</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1196"><a href="#CenterDetermination.detection_3points-1196"><span class="linenos">1196</span></a> 
</span><span id="CenterDetermination.detection_3points-1197"><a href="#CenterDetermination.detection_3points-1197"><span class="linenos">1197</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Select 3 points defining one of diffraction circles&quot;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1198"><a href="#CenterDetermination.detection_3points-1198"><span class="linenos">1198</span></a>                  <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1199"><a href="#CenterDetermination.detection_3points-1199"><span class="linenos">1199</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1200"><a href="#CenterDetermination.detection_3points-1200"><span class="linenos">1200</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1201"><a href="#CenterDetermination.detection_3points-1201"><span class="linenos">1201</span></a>
</span><span id="CenterDetermination.detection_3points-1202"><a href="#CenterDetermination.detection_3points-1202"><span class="linenos">1202</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination.detection_3points-1203"><a href="#CenterDetermination.detection_3points-1203"><span class="linenos">1203</span></a>        <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-1204"><a href="#CenterDetermination.detection_3points-1204"><span class="linenos">1204</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.detection_3points-1205"><a href="#CenterDetermination.detection_3points-1205"><span class="linenos">1205</span></a><span class="sd">            CenterDetermination :: ThreePoints (semi-automated method)</span>
</span><span id="CenterDetermination.detection_3points-1206"><a href="#CenterDetermination.detection_3points-1206"><span class="linenos">1206</span></a><span class="sd">            Select 3 points to define a diffraction circle using keys:</span>
</span><span id="CenterDetermination.detection_3points-1207"><a href="#CenterDetermination.detection_3points-1207"><span class="linenos">1207</span></a><span class="sd">              - &#39;1&#39; : define a point at current cursor position</span>
</span><span id="CenterDetermination.detection_3points-1208"><a href="#CenterDetermination.detection_3points-1208"><span class="linenos">1208</span></a><span class="sd">              - &#39;2&#39; : delete the last point</span>
</span><span id="CenterDetermination.detection_3points-1209"><a href="#CenterDetermination.detection_3points-1209"><span class="linenos">1209</span></a><span class="sd">              - &#39;3&#39; : delete the point closest to the cursor</span>
</span><span id="CenterDetermination.detection_3points-1210"><a href="#CenterDetermination.detection_3points-1210"><span class="linenos">1210</span></a><span class="sd">              - &#39;d&#39; : done = finished = go to the next step</span>
</span><span id="CenterDetermination.detection_3points-1211"><a href="#CenterDetermination.detection_3points-1211"><span class="linenos">1211</span></a><span class="sd">            Close the figure to terminate. No center will be detected.</span>
</span><span id="CenterDetermination.detection_3points-1212"><a href="#CenterDetermination.detection_3points-1212"><span class="linenos">1212</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1213"><a href="#CenterDetermination.detection_3points-1213"><span class="linenos">1213</span></a>
</span><span id="CenterDetermination.detection_3points-1214"><a href="#CenterDetermination.detection_3points-1214"><span class="linenos">1214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1215"><a href="#CenterDetermination.detection_3points-1215"><span class="linenos">1215</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1216"><a href="#CenterDetermination.detection_3points-1216"><span class="linenos">1216</span></a>       
</span><span id="CenterDetermination.detection_3points-1217"><a href="#CenterDetermination.detection_3points-1217"><span class="linenos">1217</span></a>        <span class="c1"># Enable interactive mode</span>
</span><span id="CenterDetermination.detection_3points-1218"><a href="#CenterDetermination.detection_3points-1218"><span class="linenos">1218</span></a>        <span class="c1"># (figure is updated after every plotting command</span>
</span><span id="CenterDetermination.detection_3points-1219"><a href="#CenterDetermination.detection_3points-1219"><span class="linenos">1219</span></a>        <span class="c1"># (so that calling figure.show() is not necessary</span>
</span><span id="CenterDetermination.detection_3points-1220"><a href="#CenterDetermination.detection_3points-1220"><span class="linenos">1220</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1221"><a href="#CenterDetermination.detection_3points-1221"><span class="linenos">1221</span></a> 
</span><span id="CenterDetermination.detection_3points-1222"><a href="#CenterDetermination.detection_3points-1222"><span class="linenos">1222</span></a>        <span class="c1"># Initialize the list of coordinates</span>
</span><span id="CenterDetermination.detection_3points-1223"><a href="#CenterDetermination.detection_3points-1223"><span class="linenos">1223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span> 
</span><span id="CenterDetermination.detection_3points-1224"><a href="#CenterDetermination.detection_3points-1224"><span class="linenos">1224</span></a>        
</span><span id="CenterDetermination.detection_3points-1225"><a href="#CenterDetermination.detection_3points-1225"><span class="linenos">1225</span></a>        <span class="c1"># Initialize all flags and counters</span>
</span><span id="CenterDetermination.detection_3points-1226"><a href="#CenterDetermination.detection_3points-1226"><span class="linenos">1226</span></a>        <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># press &#39;d&#39; event</span>
</span><span id="CenterDetermination.detection_3points-1227"><a href="#CenterDetermination.detection_3points-1227"><span class="linenos">1227</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># close window event</span>
</span><span id="CenterDetermination.detection_3points-1228"><a href="#CenterDetermination.detection_3points-1228"><span class="linenos">1228</span></a>        <span class="n">point_counter</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># number of selected points</span>
</span><span id="CenterDetermination.detection_3points-1229"><a href="#CenterDetermination.detection_3points-1229"><span class="linenos">1229</span></a>        
</span><span id="CenterDetermination.detection_3points-1230"><a href="#CenterDetermination.detection_3points-1230"><span class="linenos">1230</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterDetermination.detection_3points-1231"><a href="#CenterDetermination.detection_3points-1231"><span class="linenos">1231</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_3points-1232"><a href="#CenterDetermination.detection_3points-1232"><span class="linenos">1232</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.detection_3points-1233"><a href="#CenterDetermination.detection_3points-1233"><span class="linenos">1233</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.detection_3points-1234"><a href="#CenterDetermination.detection_3points-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1235"><a href="#CenterDetermination.detection_3points-1235"><span class="linenos">1235</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execution terminated.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1236"><a href="#CenterDetermination.detection_3points-1236"><span class="linenos">1236</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1237"><a href="#CenterDetermination.detection_3points-1237"><span class="linenos">1237</span></a>
</span><span id="CenterDetermination.detection_3points-1238"><a href="#CenterDetermination.detection_3points-1238"><span class="linenos">1238</span></a> 
</span><span id="CenterDetermination.detection_3points-1239"><a href="#CenterDetermination.detection_3points-1239"><span class="linenos">1239</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination.detection_3points-1240"><a href="#CenterDetermination.detection_3points-1240"><span class="linenos">1240</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1241"><a href="#CenterDetermination.detection_3points-1241"><span class="linenos">1241</span></a>        
</span><span id="CenterDetermination.detection_3points-1242"><a href="#CenterDetermination.detection_3points-1242"><span class="linenos">1242</span></a>        
</span><span id="CenterDetermination.detection_3points-1243"><a href="#CenterDetermination.detection_3points-1243"><span class="linenos">1243</span></a>        <span class="c1">### Define the callback function for key press events</span>
</span><span id="CenterDetermination.detection_3points-1244"><a href="#CenterDetermination.detection_3points-1244"><span class="linenos">1244</span></a>        <span class="k">def</span> <span class="nf">onkeypress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.detection_3points-1245"><a href="#CenterDetermination.detection_3points-1245"><span class="linenos">1245</span></a>            <span class="c1"># nonlocal to modify the flag variable in the outer scope</span>
</span><span id="CenterDetermination.detection_3points-1246"><a href="#CenterDetermination.detection_3points-1246"><span class="linenos">1246</span></a>            <span class="k">nonlocal</span> <span class="n">calculate_circle_flag</span><span class="p">,</span> <span class="n">point_counter</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.detection_3points-1247"><a href="#CenterDetermination.detection_3points-1247"><span class="linenos">1247</span></a>            
</span><span id="CenterDetermination.detection_3points-1248"><a href="#CenterDetermination.detection_3points-1248"><span class="linenos">1248</span></a>            <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination.detection_3points-1249"><a href="#CenterDetermination.detection_3points-1249"><span class="linenos">1249</span></a>            <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1250"><a href="#CenterDetermination.detection_3points-1250"><span class="linenos">1250</span></a>            <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1251"><a href="#CenterDetermination.detection_3points-1251"><span class="linenos">1251</span></a> 
</span><span id="CenterDetermination.detection_3points-1252"><a href="#CenterDetermination.detection_3points-1252"><span class="linenos">1252</span></a>            <span class="c1">## Delete points -- the closest to the cursor</span>
</span><span id="CenterDetermination.detection_3points-1253"><a href="#CenterDetermination.detection_3points-1253"><span class="linenos">1253</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1254"><a href="#CenterDetermination.detection_3points-1254"><span class="linenos">1254</span></a>                <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.detection_3points-1255"><a href="#CenterDetermination.detection_3points-1255"><span class="linenos">1255</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1256"><a href="#CenterDetermination.detection_3points-1256"><span class="linenos">1256</span></a>                    <span class="n">pointer_x</span><span class="p">,</span> <span class="n">pointer_y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
</span><span id="CenterDetermination.detection_3points-1257"><a href="#CenterDetermination.detection_3points-1257"><span class="linenos">1257</span></a>                    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="CenterDetermination.detection_3points-1258"><a href="#CenterDetermination.detection_3points-1258"><span class="linenos">1258</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">pointer_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">pointer_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1259"><a href="#CenterDetermination.detection_3points-1259"><span class="linenos">1259</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-1260"><a href="#CenterDetermination.detection_3points-1260"><span class="linenos">1260</span></a>                    <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1261"><a href="#CenterDetermination.detection_3points-1261"><span class="linenos">1261</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">closest_index</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-1262"><a href="#CenterDetermination.detection_3points-1262"><span class="linenos">1262</span></a>    
</span><span id="CenterDetermination.detection_3points-1263"><a href="#CenterDetermination.detection_3points-1263"><span class="linenos">1263</span></a>                    <span class="c1">## Redraw the image without the deleted point</span>
</span><span id="CenterDetermination.detection_3points-1264"><a href="#CenterDetermination.detection_3points-1264"><span class="linenos">1264</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1265"><a href="#CenterDetermination.detection_3points-1265"><span class="linenos">1265</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-1266"><a href="#CenterDetermination.detection_3points-1266"><span class="linenos">1266</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1267"><a href="#CenterDetermination.detection_3points-1267"><span class="linenos">1267</span></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1268"><a href="#CenterDetermination.detection_3points-1268"><span class="linenos">1268</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1269"><a href="#CenterDetermination.detection_3points-1269"><span class="linenos">1269</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1270"><a href="#CenterDetermination.detection_3points-1270"><span class="linenos">1270</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1271"><a href="#CenterDetermination.detection_3points-1271"><span class="linenos">1271</span></a>
</span><span id="CenterDetermination.detection_3points-1272"><a href="#CenterDetermination.detection_3points-1272"><span class="linenos">1272</span></a>                    <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-1273"><a href="#CenterDetermination.detection_3points-1273"><span class="linenos">1273</span></a>                        <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination.detection_3points-1274"><a href="#CenterDetermination.detection_3points-1274"><span class="linenos">1274</span></a>                        <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1275"><a href="#CenterDetermination.detection_3points-1275"><span class="linenos">1275</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1276"><a href="#CenterDetermination.detection_3points-1276"><span class="linenos">1276</span></a>                    
</span><span id="CenterDetermination.detection_3points-1277"><a href="#CenterDetermination.detection_3points-1277"><span class="linenos">1277</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-1278"><a href="#CenterDetermination.detection_3points-1278"><span class="linenos">1278</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1279"><a href="#CenterDetermination.detection_3points-1279"><span class="linenos">1279</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1280"><a href="#CenterDetermination.detection_3points-1280"><span class="linenos">1280</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1281"><a href="#CenterDetermination.detection_3points-1281"><span class="linenos">1281</span></a>                    
</span><span id="CenterDetermination.detection_3points-1282"><a href="#CenterDetermination.detection_3points-1282"><span class="linenos">1282</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1283"><a href="#CenterDetermination.detection_3points-1283"><span class="linenos">1283</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1284"><a href="#CenterDetermination.detection_3points-1284"><span class="linenos">1284</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1285"><a href="#CenterDetermination.detection_3points-1285"><span class="linenos">1285</span></a>    
</span><span id="CenterDetermination.detection_3points-1286"><a href="#CenterDetermination.detection_3points-1286"><span class="linenos">1286</span></a>            <span class="c1"># Delete recent point (last added) -- independent on the cursor</span>
</span><span id="CenterDetermination.detection_3points-1287"><a href="#CenterDetermination.detection_3points-1287"><span class="linenos">1287</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1288"><a href="#CenterDetermination.detection_3points-1288"><span class="linenos">1288</span></a>                <span class="c1"># Check if there are points to delete</span>
</span><span id="CenterDetermination.detection_3points-1289"><a href="#CenterDetermination.detection_3points-1289"><span class="linenos">1289</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span><span id="CenterDetermination.detection_3points-1290"><a href="#CenterDetermination.detection_3points-1290"><span class="linenos">1290</span></a>                    <span class="n">point_counter</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.detection_3points-1291"><a href="#CenterDetermination.detection_3points-1291"><span class="linenos">1291</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1292"><a href="#CenterDetermination.detection_3points-1292"><span class="linenos">1292</span></a>                        <span class="c1"># Delete the last point in the list</span>
</span><span id="CenterDetermination.detection_3points-1293"><a href="#CenterDetermination.detection_3points-1293"><span class="linenos">1293</span></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-1294"><a href="#CenterDetermination.detection_3points-1294"><span class="linenos">1294</span></a>    
</span><span id="CenterDetermination.detection_3points-1295"><a href="#CenterDetermination.detection_3points-1295"><span class="linenos">1295</span></a>                        <span class="c1"># Redraw the image without the deleted point</span>
</span><span id="CenterDetermination.detection_3points-1296"><a href="#CenterDetermination.detection_3points-1296"><span class="linenos">1296</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1297"><a href="#CenterDetermination.detection_3points-1297"><span class="linenos">1297</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-1298"><a href="#CenterDetermination.detection_3points-1298"><span class="linenos">1298</span></a>                                  <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1299"><a href="#CenterDetermination.detection_3points-1299"><span class="linenos">1299</span></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1300"><a href="#CenterDetermination.detection_3points-1300"><span class="linenos">1300</span></a>                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-1301"><a href="#CenterDetermination.detection_3points-1301"><span class="linenos">1301</span></a>                                       <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1302"><a href="#CenterDetermination.detection_3points-1302"><span class="linenos">1302</span></a>                                       <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1303"><a href="#CenterDetermination.detection_3points-1303"><span class="linenos">1303</span></a>
</span><span id="CenterDetermination.detection_3points-1304"><a href="#CenterDetermination.detection_3points-1304"><span class="linenos">1304</span></a>                        <span class="n">my_plot_title</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-1305"><a href="#CenterDetermination.detection_3points-1305"><span class="linenos">1305</span></a>                            <span class="s2">&quot;Select 3 points to define &quot;</span>
</span><span id="CenterDetermination.detection_3points-1306"><a href="#CenterDetermination.detection_3points-1306"><span class="linenos">1306</span></a>                            <span class="s2">&quot;one of diffraction circles.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1307"><a href="#CenterDetermination.detection_3points-1307"><span class="linenos">1307</span></a>                        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">my_plot_title</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1308"><a href="#CenterDetermination.detection_3points-1308"><span class="linenos">1308</span></a>                        
</span><span id="CenterDetermination.detection_3points-1309"><a href="#CenterDetermination.detection_3points-1309"><span class="linenos">1309</span></a>                        <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-1310"><a href="#CenterDetermination.detection_3points-1310"><span class="linenos">1310</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1311"><a href="#CenterDetermination.detection_3points-1311"><span class="linenos">1311</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1312"><a href="#CenterDetermination.detection_3points-1312"><span class="linenos">1312</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1313"><a href="#CenterDetermination.detection_3points-1313"><span class="linenos">1313</span></a>
</span><span id="CenterDetermination.detection_3points-1314"><a href="#CenterDetermination.detection_3points-1314"><span class="linenos">1314</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1315"><a href="#CenterDetermination.detection_3points-1315"><span class="linenos">1315</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1316"><a href="#CenterDetermination.detection_3points-1316"><span class="linenos">1316</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points to delete.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1317"><a href="#CenterDetermination.detection_3points-1317"><span class="linenos">1317</span></a>                    
</span><span id="CenterDetermination.detection_3points-1318"><a href="#CenterDetermination.detection_3points-1318"><span class="linenos">1318</span></a>            <span class="c1">## Select points </span>
</span><span id="CenterDetermination.detection_3points-1319"><a href="#CenterDetermination.detection_3points-1319"><span class="linenos">1319</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1320"><a href="#CenterDetermination.detection_3points-1320"><span class="linenos">1320</span></a>                <span class="c1"># Only allow selecting up to three points</span>
</span><span id="CenterDetermination.detection_3points-1321"><a href="#CenterDetermination.detection_3points-1321"><span class="linenos">1321</span></a>                <span class="k">if</span> <span class="n">point_counter</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  
</span><span id="CenterDetermination.detection_3points-1322"><a href="#CenterDetermination.detection_3points-1322"><span class="linenos">1322</span></a>                    <span class="c1"># Save the coordinates of the clicked point</span>
</span><span id="CenterDetermination.detection_3points-1323"><a href="#CenterDetermination.detection_3points-1323"><span class="linenos">1323</span></a>                    <span class="n">new_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1324"><a href="#CenterDetermination.detection_3points-1324"><span class="linenos">1324</span></a>                    
</span><span id="CenterDetermination.detection_3points-1325"><a href="#CenterDetermination.detection_3points-1325"><span class="linenos">1325</span></a>                    <span class="k">if</span> <span class="n">new_point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1326"><a href="#CenterDetermination.detection_3points-1326"><span class="linenos">1326</span></a>                        <span class="c1"># Do not allow multiple selection of one point</span>
</span><span id="CenterDetermination.detection_3points-1327"><a href="#CenterDetermination.detection_3points-1327"><span class="linenos">1327</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The selected point already exists.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1328"><a href="#CenterDetermination.detection_3points-1328"><span class="linenos">1328</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1329"><a href="#CenterDetermination.detection_3points-1329"><span class="linenos">1329</span></a>                        <span class="c1"># Add selected point</span>
</span><span id="CenterDetermination.detection_3points-1330"><a href="#CenterDetermination.detection_3points-1330"><span class="linenos">1330</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_point</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1331"><a href="#CenterDetermination.detection_3points-1331"><span class="linenos">1331</span></a>    
</span><span id="CenterDetermination.detection_3points-1332"><a href="#CenterDetermination.detection_3points-1332"><span class="linenos">1332</span></a>                        <span class="c1"># Visualize the selected point on the image</span>
</span><span id="CenterDetermination.detection_3points-1333"><a href="#CenterDetermination.detection_3points-1333"><span class="linenos">1333</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1334"><a href="#CenterDetermination.detection_3points-1334"><span class="linenos">1334</span></a>                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.detection_3points-1335"><a href="#CenterDetermination.detection_3points-1335"><span class="linenos">1335</span></a>                                   <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">marker_size</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1336"><a href="#CenterDetermination.detection_3points-1336"><span class="linenos">1336</span></a>
</span><span id="CenterDetermination.detection_3points-1337"><a href="#CenterDetermination.detection_3points-1337"><span class="linenos">1337</span></a>                        <span class="c1"># Restore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-1338"><a href="#CenterDetermination.detection_3points-1338"><span class="linenos">1338</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1339"><a href="#CenterDetermination.detection_3points-1339"><span class="linenos">1339</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1340"><a href="#CenterDetermination.detection_3points-1340"><span class="linenos">1340</span></a>                        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1341"><a href="#CenterDetermination.detection_3points-1341"><span class="linenos">1341</span></a>
</span><span id="CenterDetermination.detection_3points-1342"><a href="#CenterDetermination.detection_3points-1342"><span class="linenos">1342</span></a>                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1343"><a href="#CenterDetermination.detection_3points-1343"><span class="linenos">1343</span></a>    
</span><span id="CenterDetermination.detection_3points-1344"><a href="#CenterDetermination.detection_3points-1344"><span class="linenos">1344</span></a>                        <span class="n">point_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterDetermination.detection_3points-1345"><a href="#CenterDetermination.detection_3points-1345"><span class="linenos">1345</span></a>
</span><span id="CenterDetermination.detection_3points-1346"><a href="#CenterDetermination.detection_3points-1346"><span class="linenos">1346</span></a>    
</span><span id="CenterDetermination.detection_3points-1347"><a href="#CenterDetermination.detection_3points-1347"><span class="linenos">1347</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1348"><a href="#CenterDetermination.detection_3points-1348"><span class="linenos">1348</span></a>                    <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination.detection_3points-1349"><a href="#CenterDetermination.detection_3points-1349"><span class="linenos">1349</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1350"><a href="#CenterDetermination.detection_3points-1350"><span class="linenos">1350</span></a>    
</span><span id="CenterDetermination.detection_3points-1351"><a href="#CenterDetermination.detection_3points-1351"><span class="linenos">1351</span></a>
</span><span id="CenterDetermination.detection_3points-1352"><a href="#CenterDetermination.detection_3points-1352"><span class="linenos">1352</span></a>    
</span><span id="CenterDetermination.detection_3points-1353"><a href="#CenterDetermination.detection_3points-1353"><span class="linenos">1353</span></a>            <span class="c1"># Calculate circle or terminate</span>
</span><span id="CenterDetermination.detection_3points-1354"><a href="#CenterDetermination.detection_3points-1354"><span class="linenos">1354</span></a>            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1355"><a href="#CenterDetermination.detection_3points-1355"><span class="linenos">1355</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1356"><a href="#CenterDetermination.detection_3points-1356"><span class="linenos">1356</span></a>                    <span class="n">calculate_circle_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.detection_3points-1357"><a href="#CenterDetermination.detection_3points-1357"><span class="linenos">1357</span></a> 
</span><span id="CenterDetermination.detection_3points-1358"><a href="#CenterDetermination.detection_3points-1358"><span class="linenos">1358</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1359"><a href="#CenterDetermination.detection_3points-1359"><span class="linenos">1359</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select exactly 3 points to calculate the circle.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1360"><a href="#CenterDetermination.detection_3points-1360"><span class="linenos">1360</span></a>                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1361"><a href="#CenterDetermination.detection_3points-1361"><span class="linenos">1361</span></a>    
</span><span id="CenterDetermination.detection_3points-1362"><a href="#CenterDetermination.detection_3points-1362"><span class="linenos">1362</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination.detection_3points-1363"><a href="#CenterDetermination.detection_3points-1363"><span class="linenos">1363</span></a>        <span class="n">cid0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1364"><a href="#CenterDetermination.detection_3points-1364"><span class="linenos">1364</span></a>
</span><span id="CenterDetermination.detection_3points-1365"><a href="#CenterDetermination.detection_3points-1365"><span class="linenos">1365</span></a>        <span class="c1"># Show the plot</span>
</span><span id="CenterDetermination.detection_3points-1366"><a href="#CenterDetermination.detection_3points-1366"><span class="linenos">1366</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1367"><a href="#CenterDetermination.detection_3points-1367"><span class="linenos">1367</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1368"><a href="#CenterDetermination.detection_3points-1368"><span class="linenos">1368</span></a>
</span><span id="CenterDetermination.detection_3points-1369"><a href="#CenterDetermination.detection_3points-1369"><span class="linenos">1369</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1370"><a href="#CenterDetermination.detection_3points-1370"><span class="linenos">1370</span></a>      
</span><span id="CenterDetermination.detection_3points-1371"><a href="#CenterDetermination.detection_3points-1371"><span class="linenos">1371</span></a>        <span class="c1"># Wait for &#39;d&#39; key event or close the figure if no points are selected</span>
</span><span id="CenterDetermination.detection_3points-1372"><a href="#CenterDetermination.detection_3points-1372"><span class="linenos">1372</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">calculate_circle_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1373"><a href="#CenterDetermination.detection_3points-1373"><span class="linenos">1373</span></a> 
</span><span id="CenterDetermination.detection_3points-1374"><a href="#CenterDetermination.detection_3points-1374"><span class="linenos">1374</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1375"><a href="#CenterDetermination.detection_3points-1375"><span class="linenos">1375</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1376"><a href="#CenterDetermination.detection_3points-1376"><span class="linenos">1376</span></a>                <span class="c1"># Store the zoom level</span>
</span><span id="CenterDetermination.detection_3points-1377"><a href="#CenterDetermination.detection_3points-1377"><span class="linenos">1377</span></a>                <span class="n">current_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1378"><a href="#CenterDetermination.detection_3points-1378"><span class="linenos">1378</span></a>                <span class="n">current_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1379"><a href="#CenterDetermination.detection_3points-1379"><span class="linenos">1379</span></a> 
</span><span id="CenterDetermination.detection_3points-1380"><a href="#CenterDetermination.detection_3points-1380"><span class="linenos">1380</span></a>                <span class="c1"># Plot detected diffraction pattern</span>
</span><span id="CenterDetermination.detection_3points-1381"><a href="#CenterDetermination.detection_3points-1381"><span class="linenos">1381</span></a>                <span class="k">if</span> <span class="n">calculate_circle_flag</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1382"><a href="#CenterDetermination.detection_3points-1382"><span class="linenos">1382</span></a> 
</span><span id="CenterDetermination.detection_3points-1383"><a href="#CenterDetermination.detection_3points-1383"><span class="linenos">1383</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_circle</span><span class="p">(</span><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1384"><a href="#CenterDetermination.detection_3points-1384"><span class="linenos">1384</span></a>                    
</span><span id="CenterDetermination.detection_3points-1385"><a href="#CenterDetermination.detection_3points-1385"><span class="linenos">1385</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1386"><a href="#CenterDetermination.detection_3points-1386"><span class="linenos">1386</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.detection_3points-1387"><a href="#CenterDetermination.detection_3points-1387"><span class="linenos">1387</span></a>                              <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1388"><a href="#CenterDetermination.detection_3points-1388"><span class="linenos">1388</span></a>                    <span class="c1"># Retore the previous zoom level</span>
</span><span id="CenterDetermination.detection_3points-1389"><a href="#CenterDetermination.detection_3points-1389"><span class="linenos">1389</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">current_xlim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1390"><a href="#CenterDetermination.detection_3points-1390"><span class="linenos">1390</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">current_ylim</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1391"><a href="#CenterDetermination.detection_3points-1391"><span class="linenos">1391</span></a>                 
</span><span id="CenterDetermination.detection_3points-1392"><a href="#CenterDetermination.detection_3points-1392"><span class="linenos">1392</span></a>                    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterDetermination.detection_3points-1393"><a href="#CenterDetermination.detection_3points-1393"><span class="linenos">1393</span></a>                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1394"><a href="#CenterDetermination.detection_3points-1394"><span class="linenos">1394</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1395"><a href="#CenterDetermination.detection_3points-1395"><span class="linenos">1395</span></a>        
</span><span id="CenterDetermination.detection_3points-1396"><a href="#CenterDetermination.detection_3points-1396"><span class="linenos">1396</span></a>                    <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination.detection_3points-1397"><a href="#CenterDetermination.detection_3points-1397"><span class="linenos">1397</span></a>                    <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1398"><a href="#CenterDetermination.detection_3points-1398"><span class="linenos">1398</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the position of the center using keys.&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1399"><a href="#CenterDetermination.detection_3points-1399"><span class="linenos">1399</span></a>        
</span><span id="CenterDetermination.detection_3points-1400"><a href="#CenterDetermination.detection_3points-1400"><span class="linenos">1400</span></a>                    <span class="c1"># Display the image</span>
</span><span id="CenterDetermination.detection_3points-1401"><a href="#CenterDetermination.detection_3points-1401"><span class="linenos">1401</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1402"><a href="#CenterDetermination.detection_3points-1402"><span class="linenos">1402</span></a>                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1403"><a href="#CenterDetermination.detection_3points-1403"><span class="linenos">1403</span></a>
</span><span id="CenterDetermination.detection_3points-1404"><a href="#CenterDetermination.detection_3points-1404"><span class="linenos">1404</span></a>                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1405"><a href="#CenterDetermination.detection_3points-1405"><span class="linenos">1405</span></a>
</span><span id="CenterDetermination.detection_3points-1406"><a href="#CenterDetermination.detection_3points-1406"><span class="linenos">1406</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1407"><a href="#CenterDetermination.detection_3points-1407"><span class="linenos">1407</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution manually interrupted by user.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1408"><a href="#CenterDetermination.detection_3points-1408"><span class="linenos">1408</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination.detection_3points-1409"><a href="#CenterDetermination.detection_3points-1409"><span class="linenos">1409</span></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="CenterDetermination.detection_3points-1410"><a href="#CenterDetermination.detection_3points-1410"><span class="linenos">1410</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ValueError:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1411"><a href="#CenterDetermination.detection_3points-1411"><span class="linenos">1411</span></a>                <span class="k">break</span>
</span><span id="CenterDetermination.detection_3points-1412"><a href="#CenterDetermination.detection_3points-1412"><span class="linenos">1412</span></a>           
</span><span id="CenterDetermination.detection_3points-1413"><a href="#CenterDetermination.detection_3points-1413"><span class="linenos">1413</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination.detection_3points-1414"><a href="#CenterDetermination.detection_3points-1414"><span class="linenos">1414</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination.detection_3points-1415"><a href="#CenterDetermination.detection_3points-1415"><span class="linenos">1415</span></a>             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No points selected. Returned None values.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1416"><a href="#CenterDetermination.detection_3points-1416"><span class="linenos">1416</span></a>             <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterDetermination.detection_3points-1417"><a href="#CenterDetermination.detection_3points-1417"><span class="linenos">1417</span></a>             <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.detection_3points-1418"><a href="#CenterDetermination.detection_3points-1418"><span class="linenos">1418</span></a>        
</span><span id="CenterDetermination.detection_3points-1419"><a href="#CenterDetermination.detection_3points-1419"><span class="linenos">1419</span></a>        <span class="c1"># Disconnect key press events</span>
</span><span id="CenterDetermination.detection_3points-1420"><a href="#CenterDetermination.detection_3points-1420"><span class="linenos">1420</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">cid0</span><span class="p">)</span> 
</span><span id="CenterDetermination.detection_3points-1421"><a href="#CenterDetermination.detection_3points-1421"><span class="linenos">1421</span></a>        
</span><span id="CenterDetermination.detection_3points-1422"><a href="#CenterDetermination.detection_3points-1422"><span class="linenos">1422</span></a>        <span class="c1"># local variables save</span>
</span><span id="CenterDetermination.detection_3points-1423"><a href="#CenterDetermination.detection_3points-1423"><span class="linenos">1423</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
</span><span id="CenterDetermination.detection_3points-1424"><a href="#CenterDetermination.detection_3points-1424"><span class="linenos">1424</span></a>        
</span><span id="CenterDetermination.detection_3points-1425"><a href="#CenterDetermination.detection_3points-1425"><span class="linenos">1425</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">]</span>
</span><span id="CenterDetermination.detection_3points-1426"><a href="#CenterDetermination.detection_3points-1426"><span class="linenos">1426</span></a>        <span class="c1"># Manually adjust the calculated center coordinates</span>
</span><span id="CenterDetermination.detection_3points-1427"><a href="#CenterDetermination.detection_3points-1427"><span class="linenos">1427</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjustment_3points</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
</span><span id="CenterDetermination.detection_3points-1428"><a href="#CenterDetermination.detection_3points-1428"><span class="linenos">1428</span></a>
</span><span id="CenterDetermination.detection_3points-1429"><a href="#CenterDetermination.detection_3points-1429"><span class="linenos">1429</span></a>        <span class="c1"># Return the results:</span>
</span><span id="CenterDetermination.detection_3points-1430"><a href="#CenterDetermination.detection_3points-1430"><span class="linenos">1430</span></a>        <span class="c1"># a) XY-coordinates of the center</span>
</span><span id="CenterDetermination.detection_3points-1431"><a href="#CenterDetermination.detection_3points-1431"><span class="linenos">1431</span></a>        <span class="c1"># b) radius of the circle/diff.ring,</span>
</span><span id="CenterDetermination.detection_3points-1432"><a href="#CenterDetermination.detection_3points-1432"><span class="linenos">1432</span></a>        <span class="c1">#    from which the center was determined</span>
</span><span id="CenterDetermination.detection_3points-1433"><a href="#CenterDetermination.detection_3points-1433"><span class="linenos">1433</span></a>        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>In the input image, select manually 3 points defining a circle using
a key press event 
    - press '1' to select a point</p>

<p>If the user is not satisfied with the point selection, it can be
deleted using a key press event:
    - press '2' to delete the most recent
    - press '3' to delete the point closest to the cursor</p>

<p>If the user is satisified with the points selected, the rest 
of the program will be executed 
    - press 'd' to proceed &gt;DONE&lt;</p>

<p>Coordinates of the center and radius will be calculated automatically
using method self.calculate_circle()</p>

<p>In addition, the user will be able to manually adjust the original
center position by using pre-defined keys.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>plot_results</strong> (int, binary):
Plot the pattern determined by pixels selected by the user.
Default is 1. To cancel visualization, set plot_results = 0.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>self.x</strong> (float64):
x-coordinate of the detected center</li>
<li><strong>self.y</strong> (float64):
y-coordinate of the detected center</li>
<li><strong>self.r</strong> (float64):
radius of the detected center
(if available, othervise returns None)</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.adjustment_3points" class="classattr">
                                        <input id="CenterDetermination.adjustment_3points-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">adjustment_3points</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fig</span>, </span><span class="param"><span class="n">circle</span>, </span><span class="param"><span class="n">center</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">) -> <span class="nb">tuple</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.adjustment_3points-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.adjustment_3points"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.adjustment_3points-1436"><a href="#CenterDetermination.adjustment_3points-1436"><span class="linenos">1436</span></a>    <span class="k">def</span> <span class="nf">adjustment_3points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1437"><a href="#CenterDetermination.adjustment_3points-1437"><span class="linenos">1437</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterDetermination.adjustment_3points-1438"><a href="#CenterDetermination.adjustment_3points-1438"><span class="linenos">1438</span></a><span class="sd">        Adjustment of the center position calculated from 3 points.</span>
</span><span id="CenterDetermination.adjustment_3points-1439"><a href="#CenterDetermination.adjustment_3points-1439"><span class="linenos">1439</span></a><span class="sd">        Interactive refinement using keys:</span>
</span><span id="CenterDetermination.adjustment_3points-1440"><a href="#CenterDetermination.adjustment_3points-1440"><span class="linenos">1440</span></a>
</span><span id="CenterDetermination.adjustment_3points-1441"><a href="#CenterDetermination.adjustment_3points-1441"><span class="linenos">1441</span></a><span class="sd">        The user can change the position of the center of the diffraction</span>
</span><span id="CenterDetermination.adjustment_3points-1442"><a href="#CenterDetermination.adjustment_3points-1442"><span class="linenos">1442</span></a><span class="sd">        pattern and also the radius of the detected pattern using keys:</span>
</span><span id="CenterDetermination.adjustment_3points-1443"><a href="#CenterDetermination.adjustment_3points-1443"><span class="linenos">1443</span></a><span class="sd">            - left / right / top / down arrows : move left / right / top / down</span>
</span><span id="CenterDetermination.adjustment_3points-1444"><a href="#CenterDetermination.adjustment_3points-1444"><span class="linenos">1444</span></a><span class="sd">            - &#39;+&#39; : increase radius</span>
</span><span id="CenterDetermination.adjustment_3points-1445"><a href="#CenterDetermination.adjustment_3points-1445"><span class="linenos">1445</span></a><span class="sd">            - &#39;-&#39; : decrease radius</span>
</span><span id="CenterDetermination.adjustment_3points-1446"><a href="#CenterDetermination.adjustment_3points-1446"><span class="linenos">1446</span></a><span class="sd">            - &#39;d&#39; : done, termination of the refinement</span>
</span><span id="CenterDetermination.adjustment_3points-1447"><a href="#CenterDetermination.adjustment_3points-1447"><span class="linenos">1447</span></a>
</span><span id="CenterDetermination.adjustment_3points-1448"><a href="#CenterDetermination.adjustment_3points-1448"><span class="linenos">1448</span></a><span class="sd">        If the interactive figure is closed without any modifications,</span>
</span><span id="CenterDetermination.adjustment_3points-1449"><a href="#CenterDetermination.adjustment_3points-1449"><span class="linenos">1449</span></a><span class="sd">        the function returns input variables and the proccess terminates.</span>
</span><span id="CenterDetermination.adjustment_3points-1450"><a href="#CenterDetermination.adjustment_3points-1450"><span class="linenos">1450</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.adjustment_3points-1451"><a href="#CenterDetermination.adjustment_3points-1451"><span class="linenos">1451</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.adjustment_3points-1452"><a href="#CenterDetermination.adjustment_3points-1452"><span class="linenos">1452</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.adjustment_3points-1453"><a href="#CenterDetermination.adjustment_3points-1453"><span class="linenos">1453</span></a><span class="sd">        fig : figure.Figure object</span>
</span><span id="CenterDetermination.adjustment_3points-1454"><a href="#CenterDetermination.adjustment_3points-1454"><span class="linenos">1454</span></a><span class="sd">            interactive figure in which a diffraction pattern has been</span>
</span><span id="CenterDetermination.adjustment_3points-1455"><a href="#CenterDetermination.adjustment_3points-1455"><span class="linenos">1455</span></a><span class="sd">            manually detected.</span>
</span><span id="CenterDetermination.adjustment_3points-1456"><a href="#CenterDetermination.adjustment_3points-1456"><span class="linenos">1456</span></a><span class="sd">        circle : patches.Circle object</span>
</span><span id="CenterDetermination.adjustment_3points-1457"><a href="#CenterDetermination.adjustment_3points-1457"><span class="linenos">1457</span></a><span class="sd">            circle defined via 3 points manually delected</span>
</span><span id="CenterDetermination.adjustment_3points-1458"><a href="#CenterDetermination.adjustment_3points-1458"><span class="linenos">1458</span></a><span class="sd">        center : tuple</span>
</span><span id="CenterDetermination.adjustment_3points-1459"><a href="#CenterDetermination.adjustment_3points-1459"><span class="linenos">1459</span></a><span class="sd">            calculated center of the input circle.</span>
</span><span id="CenterDetermination.adjustment_3points-1460"><a href="#CenterDetermination.adjustment_3points-1460"><span class="linenos">1460</span></a><span class="sd">        plot_results : boolean</span>
</span><span id="CenterDetermination.adjustment_3points-1461"><a href="#CenterDetermination.adjustment_3points-1461"><span class="linenos">1461</span></a><span class="sd">            visualize results. The default is 1 (plot detected center).</span>
</span><span id="CenterDetermination.adjustment_3points-1462"><a href="#CenterDetermination.adjustment_3points-1462"><span class="linenos">1462</span></a>
</span><span id="CenterDetermination.adjustment_3points-1463"><a href="#CenterDetermination.adjustment_3points-1463"><span class="linenos">1463</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.adjustment_3points-1464"><a href="#CenterDetermination.adjustment_3points-1464"><span class="linenos">1464</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.adjustment_3points-1465"><a href="#CenterDetermination.adjustment_3points-1465"><span class="linenos">1465</span></a><span class="sd">        xy : tuple</span>
</span><span id="CenterDetermination.adjustment_3points-1466"><a href="#CenterDetermination.adjustment_3points-1466"><span class="linenos">1466</span></a><span class="sd">            x,y-coordinates of the center of the diffraction pattern.</span>
</span><span id="CenterDetermination.adjustment_3points-1467"><a href="#CenterDetermination.adjustment_3points-1467"><span class="linenos">1467</span></a><span class="sd">        r : integer</span>
</span><span id="CenterDetermination.adjustment_3points-1468"><a href="#CenterDetermination.adjustment_3points-1468"><span class="linenos">1468</span></a><span class="sd">            radius of the diffraction pattern.</span>
</span><span id="CenterDetermination.adjustment_3points-1469"><a href="#CenterDetermination.adjustment_3points-1469"><span class="linenos">1469</span></a>
</span><span id="CenterDetermination.adjustment_3points-1470"><a href="#CenterDetermination.adjustment_3points-1470"><span class="linenos">1470</span></a><span class="sd">        &#39;&#39;&#39;</span>            
</span><span id="CenterDetermination.adjustment_3points-1471"><a href="#CenterDetermination.adjustment_3points-1471"><span class="linenos">1471</span></a>        <span class="c1"># Remove default left / right arrow key press events</span>
</span><span id="CenterDetermination.adjustment_3points-1472"><a href="#CenterDetermination.adjustment_3points-1472"><span class="linenos">1472</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1473"><a href="#CenterDetermination.adjustment_3points-1473"><span class="linenos">1473</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1474"><a href="#CenterDetermination.adjustment_3points-1474"><span class="linenos">1474</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1475"><a href="#CenterDetermination.adjustment_3points-1475"><span class="linenos">1475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1476"><a href="#CenterDetermination.adjustment_3points-1476"><span class="linenos">1476</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
</span><span id="CenterDetermination.adjustment_3points-1477"><a href="#CenterDetermination.adjustment_3points-1477"><span class="linenos">1477</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.adjustment_3points-1478"><a href="#CenterDetermination.adjustment_3points-1478"><span class="linenos">1478</span></a><span class="sd">            CenterDetermination :: ThreePoints (interactive adjustment)</span>
</span><span id="CenterDetermination.adjustment_3points-1479"><a href="#CenterDetermination.adjustment_3points-1479"><span class="linenos">1479</span></a><span class="sd">            Use these keys:</span>
</span><span id="CenterDetermination.adjustment_3points-1480"><a href="#CenterDetermination.adjustment_3points-1480"><span class="linenos">1480</span></a><span class="sd">              - &#39;&#39; : move left</span>
</span><span id="CenterDetermination.adjustment_3points-1481"><a href="#CenterDetermination.adjustment_3points-1481"><span class="linenos">1481</span></a><span class="sd">              - &#39;&#39; : move right</span>
</span><span id="CenterDetermination.adjustment_3points-1482"><a href="#CenterDetermination.adjustment_3points-1482"><span class="linenos">1482</span></a><span class="sd">              - &#39;&#39; : move up</span>
</span><span id="CenterDetermination.adjustment_3points-1483"><a href="#CenterDetermination.adjustment_3points-1483"><span class="linenos">1483</span></a><span class="sd">              - &#39;&#39; : move down</span>
</span><span id="CenterDetermination.adjustment_3points-1484"><a href="#CenterDetermination.adjustment_3points-1484"><span class="linenos">1484</span></a><span class="sd">              - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterDetermination.adjustment_3points-1485"><a href="#CenterDetermination.adjustment_3points-1485"><span class="linenos">1485</span></a><span class="sd">              - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterDetermination.adjustment_3points-1486"><a href="#CenterDetermination.adjustment_3points-1486"><span class="linenos">1486</span></a><span class="sd">              - &#39;b&#39; : increase step size</span>
</span><span id="CenterDetermination.adjustment_3points-1487"><a href="#CenterDetermination.adjustment_3points-1487"><span class="linenos">1487</span></a><span class="sd">              - &#39;l&#39; : decrease step size</span>
</span><span id="CenterDetermination.adjustment_3points-1488"><a href="#CenterDetermination.adjustment_3points-1488"><span class="linenos">1488</span></a><span class="sd">              - &#39;d&#39; : refinement done</span>
</span><span id="CenterDetermination.adjustment_3points-1489"><a href="#CenterDetermination.adjustment_3points-1489"><span class="linenos">1489</span></a><span class="sd">                  </span>
</span><span id="CenterDetermination.adjustment_3points-1490"><a href="#CenterDetermination.adjustment_3points-1490"><span class="linenos">1490</span></a><span class="sd">            DISCLAIMER: For the purpose of the center position adjustment, </span>
</span><span id="CenterDetermination.adjustment_3points-1491"><a href="#CenterDetermination.adjustment_3points-1491"><span class="linenos">1491</span></a><span class="sd">                        the default shortcuts for arrows were removed.</span>
</span><span id="CenterDetermination.adjustment_3points-1492"><a href="#CenterDetermination.adjustment_3points-1492"><span class="linenos">1492</span></a><span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1493"><a href="#CenterDetermination.adjustment_3points-1493"><span class="linenos">1493</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1494"><a href="#CenterDetermination.adjustment_3points-1494"><span class="linenos">1494</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1495"><a href="#CenterDetermination.adjustment_3points-1495"><span class="linenos">1495</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1496"><a href="#CenterDetermination.adjustment_3points-1496"><span class="linenos">1496</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1497"><a href="#CenterDetermination.adjustment_3points-1497"><span class="linenos">1497</span></a>            
</span><span id="CenterDetermination.adjustment_3points-1498"><a href="#CenterDetermination.adjustment_3points-1498"><span class="linenos">1498</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="CenterDetermination.adjustment_3points-1499"><a href="#CenterDetermination.adjustment_3points-1499"><span class="linenos">1499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination.adjustment_3points-1500"><a href="#CenterDetermination.adjustment_3points-1500"><span class="linenos">1500</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
</span><span id="CenterDetermination.adjustment_3points-1501"><a href="#CenterDetermination.adjustment_3points-1501"><span class="linenos">1501</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1502"><a href="#CenterDetermination.adjustment_3points-1502"><span class="linenos">1502</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterDetermination.adjustment_3points-1503"><a href="#CenterDetermination.adjustment_3points-1503"><span class="linenos">1503</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1504"><a href="#CenterDetermination.adjustment_3points-1504"><span class="linenos">1504</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1505"><a href="#CenterDetermination.adjustment_3points-1505"><span class="linenos">1505</span></a>
</span><span id="CenterDetermination.adjustment_3points-1506"><a href="#CenterDetermination.adjustment_3points-1506"><span class="linenos">1506</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-1507"><a href="#CenterDetermination.adjustment_3points-1507"><span class="linenos">1507</span></a>          
</span><span id="CenterDetermination.adjustment_3points-1508"><a href="#CenterDetermination.adjustment_3points-1508"><span class="linenos">1508</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterDetermination.adjustment_3points-1509"><a href="#CenterDetermination.adjustment_3points-1509"><span class="linenos">1509</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.adjustment_3points-1510"><a href="#CenterDetermination.adjustment_3points-1510"><span class="linenos">1510</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.adjustment_3points-1511"><a href="#CenterDetermination.adjustment_3points-1511"><span class="linenos">1511</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.adjustment_3points-1512"><a href="#CenterDetermination.adjustment_3points-1512"><span class="linenos">1512</span></a>
</span><span id="CenterDetermination.adjustment_3points-1513"><a href="#CenterDetermination.adjustment_3points-1513"><span class="linenos">1513</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterDetermination.adjustment_3points-1514"><a href="#CenterDetermination.adjustment_3points-1514"><span class="linenos">1514</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1515"><a href="#CenterDetermination.adjustment_3points-1515"><span class="linenos">1515</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1516"><a href="#CenterDetermination.adjustment_3points-1516"><span class="linenos">1516</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="CenterDetermination.adjustment_3points-1517"><a href="#CenterDetermination.adjustment_3points-1517"><span class="linenos">1517</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterDetermination.adjustment_3points-1518"><a href="#CenterDetermination.adjustment_3points-1518"><span class="linenos">1518</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterDetermination.adjustment_3points-1519"><a href="#CenterDetermination.adjustment_3points-1519"><span class="linenos">1519</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterDetermination.adjustment_3points-1520"><a href="#CenterDetermination.adjustment_3points-1520"><span class="linenos">1520</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1521"><a href="#CenterDetermination.adjustment_3points-1521"><span class="linenos">1521</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterDetermination.adjustment_3points-1522"><a href="#CenterDetermination.adjustment_3points-1522"><span class="linenos">1522</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterDetermination.adjustment_3points-1523"><a href="#CenterDetermination.adjustment_3points-1523"><span class="linenos">1523</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterDetermination.adjustment_3points-1524"><a href="#CenterDetermination.adjustment_3points-1524"><span class="linenos">1524</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterDetermination.adjustment_3points-1525"><a href="#CenterDetermination.adjustment_3points-1525"><span class="linenos">1525</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterDetermination.adjustment_3points-1526"><a href="#CenterDetermination.adjustment_3points-1526"><span class="linenos">1526</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterDetermination.adjustment_3points-1527"><a href="#CenterDetermination.adjustment_3points-1527"><span class="linenos">1527</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterDetermination.adjustment_3points-1528"><a href="#CenterDetermination.adjustment_3points-1528"><span class="linenos">1528</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterDetermination.adjustment_3points-1529"><a href="#CenterDetermination.adjustment_3points-1529"><span class="linenos">1529</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterDetermination.adjustment_3points-1530"><a href="#CenterDetermination.adjustment_3points-1530"><span class="linenos">1530</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1531"><a href="#CenterDetermination.adjustment_3points-1531"><span class="linenos">1531</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterDetermination.adjustment_3points-1532"><a href="#CenterDetermination.adjustment_3points-1532"><span class="linenos">1532</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterDetermination.adjustment_3points-1533"><a href="#CenterDetermination.adjustment_3points-1533"><span class="linenos">1533</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterDetermination.adjustment_3points-1534"><a href="#CenterDetermination.adjustment_3points-1534"><span class="linenos">1534</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1535"><a href="#CenterDetermination.adjustment_3points-1535"><span class="linenos">1535</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterDetermination.adjustment_3points-1536"><a href="#CenterDetermination.adjustment_3points-1536"><span class="linenos">1536</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1537"><a href="#CenterDetermination.adjustment_3points-1537"><span class="linenos">1537</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-1538"><a href="#CenterDetermination.adjustment_3points-1538"><span class="linenos">1538</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1539"><a href="#CenterDetermination.adjustment_3points-1539"><span class="linenos">1539</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-1540"><a href="#CenterDetermination.adjustment_3points-1540"><span class="linenos">1540</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1541"><a href="#CenterDetermination.adjustment_3points-1541"><span class="linenos">1541</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-1542"><a href="#CenterDetermination.adjustment_3points-1542"><span class="linenos">1542</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1543"><a href="#CenterDetermination.adjustment_3points-1543"><span class="linenos">1543</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterDetermination.adjustment_3points-1544"><a href="#CenterDetermination.adjustment_3points-1544"><span class="linenos">1544</span></a>                    
</span><span id="CenterDetermination.adjustment_3points-1545"><a href="#CenterDetermination.adjustment_3points-1545"><span class="linenos">1545</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterDetermination.adjustment_3points-1546"><a href="#CenterDetermination.adjustment_3points-1546"><span class="linenos">1546</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1547"><a href="#CenterDetermination.adjustment_3points-1547"><span class="linenos">1547</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterDetermination.adjustment_3points-1548"><a href="#CenterDetermination.adjustment_3points-1548"><span class="linenos">1548</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1549"><a href="#CenterDetermination.adjustment_3points-1549"><span class="linenos">1549</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1550"><a href="#CenterDetermination.adjustment_3points-1550"><span class="linenos">1550</span></a>            
</span><span id="CenterDetermination.adjustment_3points-1551"><a href="#CenterDetermination.adjustment_3points-1551"><span class="linenos">1551</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterDetermination.adjustment_3points-1552"><a href="#CenterDetermination.adjustment_3points-1552"><span class="linenos">1552</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1553"><a href="#CenterDetermination.adjustment_3points-1553"><span class="linenos">1553</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.adjustment_3points-1554"><a href="#CenterDetermination.adjustment_3points-1554"><span class="linenos">1554</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1555"><a href="#CenterDetermination.adjustment_3points-1555"><span class="linenos">1555</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterDetermination.adjustment_3points-1556"><a href="#CenterDetermination.adjustment_3points-1556"><span class="linenos">1556</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1557"><a href="#CenterDetermination.adjustment_3points-1557"><span class="linenos">1557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterDetermination.adjustment_3points-1558"><a href="#CenterDetermination.adjustment_3points-1558"><span class="linenos">1558</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1559"><a href="#CenterDetermination.adjustment_3points-1559"><span class="linenos">1559</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1560"><a href="#CenterDetermination.adjustment_3points-1560"><span class="linenos">1560</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterDetermination.adjustment_3points-1561"><a href="#CenterDetermination.adjustment_3points-1561"><span class="linenos">1561</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1562"><a href="#CenterDetermination.adjustment_3points-1562"><span class="linenos">1562</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterDetermination.adjustment_3points-1563"><a href="#CenterDetermination.adjustment_3points-1563"><span class="linenos">1563</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1564"><a href="#CenterDetermination.adjustment_3points-1564"><span class="linenos">1564</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterDetermination.adjustment_3points-1565"><a href="#CenterDetermination.adjustment_3points-1565"><span class="linenos">1565</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterDetermination.adjustment_3points-1566"><a href="#CenterDetermination.adjustment_3points-1566"><span class="linenos">1566</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterDetermination.adjustment_3points-1567"><a href="#CenterDetermination.adjustment_3points-1567"><span class="linenos">1567</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterDetermination.adjustment_3points-1568"><a href="#CenterDetermination.adjustment_3points-1568"><span class="linenos">1568</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1569"><a href="#CenterDetermination.adjustment_3points-1569"><span class="linenos">1569</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1570"><a href="#CenterDetermination.adjustment_3points-1570"><span class="linenos">1570</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1571"><a href="#CenterDetermination.adjustment_3points-1571"><span class="linenos">1571</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterDetermination.adjustment_3points-1572"><a href="#CenterDetermination.adjustment_3points-1572"><span class="linenos">1572</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-1573"><a href="#CenterDetermination.adjustment_3points-1573"><span class="linenos">1573</span></a>
</span><span id="CenterDetermination.adjustment_3points-1574"><a href="#CenterDetermination.adjustment_3points-1574"><span class="linenos">1574</span></a>                
</span><span id="CenterDetermination.adjustment_3points-1575"><a href="#CenterDetermination.adjustment_3points-1575"><span class="linenos">1575</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterDetermination.adjustment_3points-1576"><a href="#CenterDetermination.adjustment_3points-1576"><span class="linenos">1576</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1577"><a href="#CenterDetermination.adjustment_3points-1577"><span class="linenos">1577</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1578"><a href="#CenterDetermination.adjustment_3points-1578"><span class="linenos">1578</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterDetermination.adjustment_3points-1579"><a href="#CenterDetermination.adjustment_3points-1579"><span class="linenos">1579</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1580"><a href="#CenterDetermination.adjustment_3points-1580"><span class="linenos">1580</span></a>
</span><span id="CenterDetermination.adjustment_3points-1581"><a href="#CenterDetermination.adjustment_3points-1581"><span class="linenos">1581</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterDetermination.adjustment_3points-1582"><a href="#CenterDetermination.adjustment_3points-1582"><span class="linenos">1582</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterDetermination.adjustment_3points-1583"><a href="#CenterDetermination.adjustment_3points-1583"><span class="linenos">1583</span></a>               
</span><span id="CenterDetermination.adjustment_3points-1584"><a href="#CenterDetermination.adjustment_3points-1584"><span class="linenos">1584</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterDetermination.adjustment_3points-1585"><a href="#CenterDetermination.adjustment_3points-1585"><span class="linenos">1585</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1586"><a href="#CenterDetermination.adjustment_3points-1586"><span class="linenos">1586</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1587"><a href="#CenterDetermination.adjustment_3points-1587"><span class="linenos">1587</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1588"><a href="#CenterDetermination.adjustment_3points-1588"><span class="linenos">1588</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterDetermination.adjustment_3points-1589"><a href="#CenterDetermination.adjustment_3points-1589"><span class="linenos">1589</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterDetermination.adjustment_3points-1590"><a href="#CenterDetermination.adjustment_3points-1590"><span class="linenos">1590</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterDetermination.adjustment_3points-1591"><a href="#CenterDetermination.adjustment_3points-1591"><span class="linenos">1591</span></a>                
</span><span id="CenterDetermination.adjustment_3points-1592"><a href="#CenterDetermination.adjustment_3points-1592"><span class="linenos">1592</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterDetermination.adjustment_3points-1593"><a href="#CenterDetermination.adjustment_3points-1593"><span class="linenos">1593</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-1594"><a href="#CenterDetermination.adjustment_3points-1594"><span class="linenos">1594</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1595"><a href="#CenterDetermination.adjustment_3points-1595"><span class="linenos">1595</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterDetermination.adjustment_3points-1596"><a href="#CenterDetermination.adjustment_3points-1596"><span class="linenos">1596</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.adjustment_3points-1597"><a href="#CenterDetermination.adjustment_3points-1597"><span class="linenos">1597</span></a>
</span><span id="CenterDetermination.adjustment_3points-1598"><a href="#CenterDetermination.adjustment_3points-1598"><span class="linenos">1598</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.adjustment_3points-1599"><a href="#CenterDetermination.adjustment_3points-1599"><span class="linenos">1599</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1600"><a href="#CenterDetermination.adjustment_3points-1600"><span class="linenos">1600</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterDetermination.adjustment_3points-1601"><a href="#CenterDetermination.adjustment_3points-1601"><span class="linenos">1601</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterDetermination.adjustment_3points-1602"><a href="#CenterDetermination.adjustment_3points-1602"><span class="linenos">1602</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterDetermination.adjustment_3points-1603"><a href="#CenterDetermination.adjustment_3points-1603"><span class="linenos">1603</span></a>
</span><span id="CenterDetermination.adjustment_3points-1604"><a href="#CenterDetermination.adjustment_3points-1604"><span class="linenos">1604</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterDetermination.adjustment_3points-1605"><a href="#CenterDetermination.adjustment_3points-1605"><span class="linenos">1605</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterDetermination.adjustment_3points-1606"><a href="#CenterDetermination.adjustment_3points-1606"><span class="linenos">1606</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dText</span> <span class="o">=</span> <span class="s2">&quot;Center Determination (ThreePoints)    : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterDetermination.adjustment_3points-1607"><a href="#CenterDetermination.adjustment_3points-1607"><span class="linenos">1607</span></a>        
</span><span id="CenterDetermination.adjustment_3points-1608"><a href="#CenterDetermination.adjustment_3points-1608"><span class="linenos">1608</span></a>    
</span><span id="CenterDetermination.adjustment_3points-1609"><a href="#CenterDetermination.adjustment_3points-1609"><span class="linenos">1609</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>
</span></pre></div>


            <div class="docstring"><p>Adjustment of the center position calculated from 3 points.
Interactive refinement using keys:</p>

<p>The user can change the position of the center of the diffraction
pattern and also the radius of the detected pattern using keys:
    - left / right / top / down arrows : move left / right / top / down
    - '+' : increase radius
    - '-' : decrease radius
    - 'd' : done, termination of the refinement</p>

<p>If the interactive figure is closed without any modifications,
the function returns input variables and the proccess terminates.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fig</strong> (figure.Figure object):
interactive figure in which a diffraction pattern has been
manually detected.</li>
<li><strong>circle</strong> (patches.Circle object):
circle defined via 3 points manually delected</li>
<li><strong>center</strong> (tuple):
calculated center of the input circle.</li>
<li><strong>plot_results</strong> (boolean):
visualize results. The default is 1 (plot detected center).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xy</strong> (tuple):
x,y-coordinates of the center of the diffraction pattern.</li>
<li><strong>r</strong> (integer):
radius of the diffraction pattern.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.calculate_circle" class="classattr">
                                        <input id="CenterDetermination.calculate_circle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_circle</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">plot_results</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.calculate_circle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.calculate_circle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.calculate_circle-1612"><a href="#CenterDetermination.calculate_circle-1612"><span class="linenos">1612</span></a>    <span class="k">def</span> <span class="nf">calculate_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_results</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span>
</span><span id="CenterDetermination.calculate_circle-1613"><a href="#CenterDetermination.calculate_circle-1613"><span class="linenos">1613</span></a>            <span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">]:</span>
</span><span id="CenterDetermination.calculate_circle-1614"><a href="#CenterDetermination.calculate_circle-1614"><span class="linenos">1614</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterDetermination.calculate_circle-1615"><a href="#CenterDetermination.calculate_circle-1615"><span class="linenos">1615</span></a><span class="sd">        Calculates coordinates of the center and radius of a circle defined via</span>
</span><span id="CenterDetermination.calculate_circle-1616"><a href="#CenterDetermination.calculate_circle-1616"><span class="linenos">1616</span></a><span class="sd">        3 points determined by the user. Plots the calculated circle, detected </span>
</span><span id="CenterDetermination.calculate_circle-1617"><a href="#CenterDetermination.calculate_circle-1617"><span class="linenos">1617</span></a><span class="sd">        points and marks the center.</span>
</span><span id="CenterDetermination.calculate_circle-1618"><a href="#CenterDetermination.calculate_circle-1618"><span class="linenos">1618</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.calculate_circle-1619"><a href="#CenterDetermination.calculate_circle-1619"><span class="linenos">1619</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.calculate_circle-1620"><a href="#CenterDetermination.calculate_circle-1620"><span class="linenos">1620</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.calculate_circle-1621"><a href="#CenterDetermination.calculate_circle-1621"><span class="linenos">1621</span></a><span class="sd">        plot_results : int, binary</span>
</span><span id="CenterDetermination.calculate_circle-1622"><a href="#CenterDetermination.calculate_circle-1622"><span class="linenos">1622</span></a><span class="sd">            Plot the calculated center and circle. To cancel visualization, </span>
</span><span id="CenterDetermination.calculate_circle-1623"><a href="#CenterDetermination.calculate_circle-1623"><span class="linenos">1623</span></a><span class="sd">            set plot_results = 0.</span>
</span><span id="CenterDetermination.calculate_circle-1624"><a href="#CenterDetermination.calculate_circle-1624"><span class="linenos">1624</span></a><span class="sd">        self.coords : array of float64</span>
</span><span id="CenterDetermination.calculate_circle-1625"><a href="#CenterDetermination.calculate_circle-1625"><span class="linenos">1625</span></a><span class="sd">            Coordinates of 3 manually selected points</span>
</span><span id="CenterDetermination.calculate_circle-1626"><a href="#CenterDetermination.calculate_circle-1626"><span class="linenos">1626</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.calculate_circle-1627"><a href="#CenterDetermination.calculate_circle-1627"><span class="linenos">1627</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.calculate_circle-1628"><a href="#CenterDetermination.calculate_circle-1628"><span class="linenos">1628</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.calculate_circle-1629"><a href="#CenterDetermination.calculate_circle-1629"><span class="linenos">1629</span></a><span class="sd">        self.x : float64</span>
</span><span id="CenterDetermination.calculate_circle-1630"><a href="#CenterDetermination.calculate_circle-1630"><span class="linenos">1630</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination.calculate_circle-1631"><a href="#CenterDetermination.calculate_circle-1631"><span class="linenos">1631</span></a><span class="sd">        self.y : float64</span>
</span><span id="CenterDetermination.calculate_circle-1632"><a href="#CenterDetermination.calculate_circle-1632"><span class="linenos">1632</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination.calculate_circle-1633"><a href="#CenterDetermination.calculate_circle-1633"><span class="linenos">1633</span></a><span class="sd">        self.r : float64</span>
</span><span id="CenterDetermination.calculate_circle-1634"><a href="#CenterDetermination.calculate_circle-1634"><span class="linenos">1634</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination.calculate_circle-1635"><a href="#CenterDetermination.calculate_circle-1635"><span class="linenos">1635</span></a><span class="sd">                                    </span>
</span><span id="CenterDetermination.calculate_circle-1636"><a href="#CenterDetermination.calculate_circle-1636"><span class="linenos">1636</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination.calculate_circle-1637"><a href="#CenterDetermination.calculate_circle-1637"><span class="linenos">1637</span></a>        <span class="c1"># Extract the coordinates of the points        </span>
</span><span id="CenterDetermination.calculate_circle-1638"><a href="#CenterDetermination.calculate_circle-1638"><span class="linenos">1638</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination.calculate_circle-1639"><a href="#CenterDetermination.calculate_circle-1639"><span class="linenos">1639</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination.calculate_circle-1640"><a href="#CenterDetermination.calculate_circle-1640"><span class="linenos">1640</span></a>        
</span><span id="CenterDetermination.calculate_circle-1641"><a href="#CenterDetermination.calculate_circle-1641"><span class="linenos">1641</span></a>        <span class="c1"># Compute the radius and center coordinates of the circle</span>
</span><span id="CenterDetermination.calculate_circle-1642"><a href="#CenterDetermination.calculate_circle-1642"><span class="linenos">1642</span></a>            <span class="c1"># a: the squared length of the side between the second </span>
</span><span id="CenterDetermination.calculate_circle-1643"><a href="#CenterDetermination.calculate_circle-1643"><span class="linenos">1643</span></a>            <span class="c1">#    and third points (x[1], y[1]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination.calculate_circle-1644"><a href="#CenterDetermination.calculate_circle-1644"><span class="linenos">1644</span></a>            <span class="c1"># b: the squared length of the side between the first </span>
</span><span id="CenterDetermination.calculate_circle-1645"><a href="#CenterDetermination.calculate_circle-1645"><span class="linenos">1645</span></a>            <span class="c1">#    and third points (x[0], y[0]) and (x[2], y[2]).</span>
</span><span id="CenterDetermination.calculate_circle-1646"><a href="#CenterDetermination.calculate_circle-1646"><span class="linenos">1646</span></a>            <span class="c1"># c: the squared length of the side between the first </span>
</span><span id="CenterDetermination.calculate_circle-1647"><a href="#CenterDetermination.calculate_circle-1647"><span class="linenos">1647</span></a>            <span class="c1">#    and second points (x[0], y[0]) and (x[1], y[1]).</span>
</span><span id="CenterDetermination.calculate_circle-1648"><a href="#CenterDetermination.calculate_circle-1648"><span class="linenos">1648</span></a>            <span class="c1"># s: the twice the signed area of the triangle formed by 3 points</span>
</span><span id="CenterDetermination.calculate_circle-1649"><a href="#CenterDetermination.calculate_circle-1649"><span class="linenos">1649</span></a>            
</span><span id="CenterDetermination.calculate_circle-1650"><a href="#CenterDetermination.calculate_circle-1650"><span class="linenos">1650</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination.calculate_circle-1651"><a href="#CenterDetermination.calculate_circle-1651"><span class="linenos">1651</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination.calculate_circle-1652"><a href="#CenterDetermination.calculate_circle-1652"><span class="linenos">1652</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CenterDetermination.calculate_circle-1653"><a href="#CenterDetermination.calculate_circle-1653"><span class="linenos">1653</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> 
</span><span id="CenterDetermination.calculate_circle-1654"><a href="#CenterDetermination.calculate_circle-1654"><span class="linenos">1654</span></a>        
</span><span id="CenterDetermination.calculate_circle-1655"><a href="#CenterDetermination.calculate_circle-1655"><span class="linenos">1655</span></a>        <span class="c1"># coordinates of the center</span>
</span><span id="CenterDetermination.calculate_circle-1656"><a href="#CenterDetermination.calculate_circle-1656"><span class="linenos">1656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span>
</span><span id="CenterDetermination.calculate_circle-1657"><a href="#CenterDetermination.calculate_circle-1657"><span class="linenos">1657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span> 
</span><span id="CenterDetermination.calculate_circle-1658"><a href="#CenterDetermination.calculate_circle-1658"><span class="linenos">1658</span></a>        
</span><span id="CenterDetermination.calculate_circle-1659"><a href="#CenterDetermination.calculate_circle-1659"><span class="linenos">1659</span></a>        <span class="c1"># radius</span>
</span><span id="CenterDetermination.calculate_circle-1660"><a href="#CenterDetermination.calculate_circle-1660"><span class="linenos">1660</span></a>        <span class="n">ar</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination.calculate_circle-1661"><a href="#CenterDetermination.calculate_circle-1661"><span class="linenos">1661</span></a>        <span class="n">br</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination.calculate_circle-1662"><a href="#CenterDetermination.calculate_circle-1662"><span class="linenos">1662</span></a>        <span class="n">cr</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="mf">0.5</span> 
</span><span id="CenterDetermination.calculate_circle-1663"><a href="#CenterDetermination.calculate_circle-1663"><span class="linenos">1663</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">ar</span><span class="o">*</span><span class="n">br</span><span class="o">*</span><span class="n">cr</span><span class="o">/</span><span class="p">((</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">-</span><span class="n">br</span><span class="o">+</span><span class="n">cr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ar</span><span class="o">+</span><span class="n">br</span><span class="o">-</span><span class="n">cr</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="CenterDetermination.calculate_circle-1664"><a href="#CenterDetermination.calculate_circle-1664"><span class="linenos">1664</span></a>        
</span><span id="CenterDetermination.calculate_circle-1665"><a href="#CenterDetermination.calculate_circle-1665"><span class="linenos">1665</span></a>        <span class="c1"># # Print results</span>
</span><span id="CenterDetermination.calculate_circle-1666"><a href="#CenterDetermination.calculate_circle-1666"><span class="linenos">1666</span></a>        <span class="c1"># if self.parent.messages:</span>
</span><span id="CenterDetermination.calculate_circle-1667"><a href="#CenterDetermination.calculate_circle-1667"><span class="linenos">1667</span></a>        <span class="c1">#     print(&quot;CenterEstimator :: manual center detection&quot;)</span>
</span><span id="CenterDetermination.calculate_circle-1668"><a href="#CenterDetermination.calculate_circle-1668"><span class="linenos">1668</span></a>        <span class="c1">#     print(f&quot;Center coordinates: {self.x:.2f} {self.y:.2f}&quot;)</span>
</span><span id="CenterDetermination.calculate_circle-1669"><a href="#CenterDetermination.calculate_circle-1669"><span class="linenos">1669</span></a>                    
</span><span id="CenterDetermination.calculate_circle-1670"><a href="#CenterDetermination.calculate_circle-1670"><span class="linenos">1670</span></a>        <span class="k">if</span> <span class="n">plot_results</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CenterDetermination.calculate_circle-1671"><a href="#CenterDetermination.calculate_circle-1671"><span class="linenos">1671</span></a>            <span class="c1"># Create and manage the figure</span>
</span><span id="CenterDetermination.calculate_circle-1672"><a href="#CenterDetermination.calculate_circle-1672"><span class="linenos">1672</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-1673"><a href="#CenterDetermination.calculate_circle-1673"><span class="linenos">1673</span></a>            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-1674"><a href="#CenterDetermination.calculate_circle-1674"><span class="linenos">1674</span></a>            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-1675"><a href="#CenterDetermination.calculate_circle-1675"><span class="linenos">1675</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="CenterDetermination.calculate_circle-1676"><a href="#CenterDetermination.calculate_circle-1676"><span class="linenos">1676</span></a>                      <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1677"><a href="#CenterDetermination.calculate_circle-1677"><span class="linenos">1677</span></a>            
</span><span id="CenterDetermination.calculate_circle-1678"><a href="#CenterDetermination.calculate_circle-1678"><span class="linenos">1678</span></a>            <span class="c1"># Plot center and points</span>
</span><span id="CenterDetermination.calculate_circle-1679"><a href="#CenterDetermination.calculate_circle-1679"><span class="linenos">1679</span></a>            <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1680"><a href="#CenterDetermination.calculate_circle-1680"><span class="linenos">1680</span></a>                     <span class="s1">&#39;rx&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1681"><a href="#CenterDetermination.calculate_circle-1681"><span class="linenos">1681</span></a>                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1682"><a href="#CenterDetermination.calculate_circle-1682"><span class="linenos">1682</span></a>                     <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1683"><a href="#CenterDetermination.calculate_circle-1683"><span class="linenos">1683</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1684"><a href="#CenterDetermination.calculate_circle-1684"><span class="linenos">1684</span></a>                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1685"><a href="#CenterDetermination.calculate_circle-1685"><span class="linenos">1685</span></a>                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1686"><a href="#CenterDetermination.calculate_circle-1686"><span class="linenos">1686</span></a>                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Circle points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1687"><a href="#CenterDetermination.calculate_circle-1687"><span class="linenos">1687</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Circle found using 3 manually detected points&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1688"><a href="#CenterDetermination.calculate_circle-1688"><span class="linenos">1688</span></a>            
</span><span id="CenterDetermination.calculate_circle-1689"><a href="#CenterDetermination.calculate_circle-1689"><span class="linenos">1689</span></a>            <span class="c1"># Circle visualization</span>
</span><span id="CenterDetermination.calculate_circle-1690"><a href="#CenterDetermination.calculate_circle-1690"><span class="linenos">1690</span></a>            <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterDetermination.calculate_circle-1691"><a href="#CenterDetermination.calculate_circle-1691"><span class="linenos">1691</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1692"><a href="#CenterDetermination.calculate_circle-1692"><span class="linenos">1692</span></a>                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1693"><a href="#CenterDetermination.calculate_circle-1693"><span class="linenos">1693</span></a>                                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="CenterDetermination.calculate_circle-1694"><a href="#CenterDetermination.calculate_circle-1694"><span class="linenos">1694</span></a>                                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1695"><a href="#CenterDetermination.calculate_circle-1695"><span class="linenos">1695</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1696"><a href="#CenterDetermination.calculate_circle-1696"><span class="linenos">1696</span></a>            
</span><span id="CenterDetermination.calculate_circle-1697"><a href="#CenterDetermination.calculate_circle-1697"><span class="linenos">1697</span></a>            <span class="c1"># Set the aspect ratio to equal to have a circular shape</span>
</span><span id="CenterDetermination.calculate_circle-1698"><a href="#CenterDetermination.calculate_circle-1698"><span class="linenos">1698</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1699"><a href="#CenterDetermination.calculate_circle-1699"><span class="linenos">1699</span></a>            
</span><span id="CenterDetermination.calculate_circle-1700"><a href="#CenterDetermination.calculate_circle-1700"><span class="linenos">1700</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1701"><a href="#CenterDetermination.calculate_circle-1701"><span class="linenos">1701</span></a>                       <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1702"><a href="#CenterDetermination.calculate_circle-1702"><span class="linenos">1702</span></a>                       <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> 
</span><span id="CenterDetermination.calculate_circle-1703"><a href="#CenterDetermination.calculate_circle-1703"><span class="linenos">1703</span></a>                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> 
</span><span id="CenterDetermination.calculate_circle-1704"><a href="#CenterDetermination.calculate_circle-1704"><span class="linenos">1704</span></a>                       <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1705"><a href="#CenterDetermination.calculate_circle-1705"><span class="linenos">1705</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1706"><a href="#CenterDetermination.calculate_circle-1706"><span class="linenos">1706</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.calculate_circle-1707"><a href="#CenterDetermination.calculate_circle-1707"><span class="linenos">1707</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1708"><a href="#CenterDetermination.calculate_circle-1708"><span class="linenos">1708</span></a>
</span><span id="CenterDetermination.calculate_circle-1709"><a href="#CenterDetermination.calculate_circle-1709"><span class="linenos">1709</span></a>        
</span><span id="CenterDetermination.calculate_circle-1710"><a href="#CenterDetermination.calculate_circle-1710"><span class="linenos">1710</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1711"><a href="#CenterDetermination.calculate_circle-1711"><span class="linenos">1711</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterDetermination.calculate_circle-1712"><a href="#CenterDetermination.calculate_circle-1712"><span class="linenos">1712</span></a>        
</span><span id="CenterDetermination.calculate_circle-1713"><a href="#CenterDetermination.calculate_circle-1713"><span class="linenos">1713</span></a>
</span><span id="CenterDetermination.calculate_circle-1714"><a href="#CenterDetermination.calculate_circle-1714"><span class="linenos">1714</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle</span>
</span></pre></div>


            <div class="docstring"><p>Calculates coordinates of the center and radius of a circle defined via
3 points determined by the user. Plots the calculated circle, detected 
points and marks the center.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>plot_results</strong> (int, binary):
Plot the calculated center and circle. To cancel visualization, 
set plot_results = 0.</li>
<li><strong>self.coords</strong> (array of float64):
Coordinates of 3 manually selected points</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>self.x</strong> (float64):
x-coordinate of the detected center</li>
<li><strong>self.y</strong> (float64):
y-coordinate of the detected center</li>
<li><strong>self.r</strong> (float64):
radius of the detected center</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.get_radius" class="classattr">
                                        <input id="CenterDetermination.get_radius-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_radius</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">im</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">y</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">disp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.get_radius-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.get_radius"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.get_radius-1717"><a href="#CenterDetermination.get_radius-1717"><span class="linenos">1717</span></a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span>
</span><span id="CenterDetermination.get_radius-1718"><a href="#CenterDetermination.get_radius-1718"><span class="linenos">1718</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">disp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1719"><a href="#CenterDetermination.get_radius-1719"><span class="linenos">1719</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-1720"><a href="#CenterDetermination.get_radius-1720"><span class="linenos">1720</span></a><span class="sd">        Calculate the radius of a circle based on intensity profiles along </span>
</span><span id="CenterDetermination.get_radius-1721"><a href="#CenterDetermination.get_radius-1721"><span class="linenos">1721</span></a><span class="sd">        horizontal and vertical axes.</span>
</span><span id="CenterDetermination.get_radius-1722"><a href="#CenterDetermination.get_radius-1722"><span class="linenos">1722</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.get_radius-1723"><a href="#CenterDetermination.get_radius-1723"><span class="linenos">1723</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.get_radius-1724"><a href="#CenterDetermination.get_radius-1724"><span class="linenos">1724</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.get_radius-1725"><a href="#CenterDetermination.get_radius-1725"><span class="linenos">1725</span></a><span class="sd">        im : np.ndarray</span>
</span><span id="CenterDetermination.get_radius-1726"><a href="#CenterDetermination.get_radius-1726"><span class="linenos">1726</span></a><span class="sd">            The 2D image array containing the circle.</span>
</span><span id="CenterDetermination.get_radius-1727"><a href="#CenterDetermination.get_radius-1727"><span class="linenos">1727</span></a><span class="sd">        x : float</span>
</span><span id="CenterDetermination.get_radius-1728"><a href="#CenterDetermination.get_radius-1728"><span class="linenos">1728</span></a><span class="sd">            The x-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination.get_radius-1729"><a href="#CenterDetermination.get_radius-1729"><span class="linenos">1729</span></a><span class="sd">        y : float</span>
</span><span id="CenterDetermination.get_radius-1730"><a href="#CenterDetermination.get_radius-1730"><span class="linenos">1730</span></a><span class="sd">            The y-coordinate of the circle&#39;s center.</span>
</span><span id="CenterDetermination.get_radius-1731"><a href="#CenterDetermination.get_radius-1731"><span class="linenos">1731</span></a><span class="sd">        disp : bool, optional</span>
</span><span id="CenterDetermination.get_radius-1732"><a href="#CenterDetermination.get_radius-1732"><span class="linenos">1732</span></a><span class="sd">            If True, visualizes the detected intensity profiles and peaks </span>
</span><span id="CenterDetermination.get_radius-1733"><a href="#CenterDetermination.get_radius-1733"><span class="linenos">1733</span></a><span class="sd">            (default is False).</span>
</span><span id="CenterDetermination.get_radius-1734"><a href="#CenterDetermination.get_radius-1734"><span class="linenos">1734</span></a><span class="sd">    </span>
</span><span id="CenterDetermination.get_radius-1735"><a href="#CenterDetermination.get_radius-1735"><span class="linenos">1735</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.get_radius-1736"><a href="#CenterDetermination.get_radius-1736"><span class="linenos">1736</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.get_radius-1737"><a href="#CenterDetermination.get_radius-1737"><span class="linenos">1737</span></a><span class="sd">        float</span>
</span><span id="CenterDetermination.get_radius-1738"><a href="#CenterDetermination.get_radius-1738"><span class="linenos">1738</span></a><span class="sd">            The estimated radius of the circle. Defaults to 100 if no valid </span>
</span><span id="CenterDetermination.get_radius-1739"><a href="#CenterDetermination.get_radius-1739"><span class="linenos">1739</span></a><span class="sd">            radius is detected.</span>
</span><span id="CenterDetermination.get_radius-1740"><a href="#CenterDetermination.get_radius-1740"><span class="linenos">1740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-1741"><a href="#CenterDetermination.get_radius-1741"><span class="linenos">1741</span></a>        
</span><span id="CenterDetermination.get_radius-1742"><a href="#CenterDetermination.get_radius-1742"><span class="linenos">1742</span></a>        <span class="k">def</span> <span class="nf">match_peaks</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
</span><span id="CenterDetermination.get_radius-1743"><a href="#CenterDetermination.get_radius-1743"><span class="linenos">1743</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-1744"><a href="#CenterDetermination.get_radius-1744"><span class="linenos">1744</span></a><span class="sd">            Finds the most similar values across the left and right halves of </span>
</span><span id="CenterDetermination.get_radius-1745"><a href="#CenterDetermination.get_radius-1745"><span class="linenos">1745</span></a><span class="sd">            an array, omitting the highest value. If exactly two peaks are </span>
</span><span id="CenterDetermination.get_radius-1746"><a href="#CenterDetermination.get_radius-1746"><span class="linenos">1746</span></a><span class="sd">            detected, they are returned as the best pair.</span>
</span><span id="CenterDetermination.get_radius-1747"><a href="#CenterDetermination.get_radius-1747"><span class="linenos">1747</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="CenterDetermination.get_radius-1748"><a href="#CenterDetermination.get_radius-1748"><span class="linenos">1748</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Not enough values to compare</span>
</span><span id="CenterDetermination.get_radius-1749"><a href="#CenterDetermination.get_radius-1749"><span class="linenos">1749</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1750"><a href="#CenterDetermination.get_radius-1750"><span class="linenos">1750</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough values to find similar pairs.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1751"><a href="#CenterDetermination.get_radius-1751"><span class="linenos">1751</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1752"><a href="#CenterDetermination.get_radius-1752"><span class="linenos">1752</span></a>    
</span><span id="CenterDetermination.get_radius-1753"><a href="#CenterDetermination.get_radius-1753"><span class="linenos">1753</span></a>            <span class="c1"># Special case: if there are exactly 2 peaks, return them</span>
</span><span id="CenterDetermination.get_radius-1754"><a href="#CenterDetermination.get_radius-1754"><span class="linenos">1754</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1755"><a href="#CenterDetermination.get_radius-1755"><span class="linenos">1755</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1756"><a href="#CenterDetermination.get_radius-1756"><span class="linenos">1756</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exactly two peaks detected. Returning them as the best pair.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1757"><a href="#CenterDetermination.get_radius-1757"><span class="linenos">1757</span></a>                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span id="CenterDetermination.get_radius-1758"><a href="#CenterDetermination.get_radius-1758"><span class="linenos">1758</span></a>    
</span><span id="CenterDetermination.get_radius-1759"><a href="#CenterDetermination.get_radius-1759"><span class="linenos">1759</span></a>            <span class="c1"># Find the index of the highest value</span>
</span><span id="CenterDetermination.get_radius-1760"><a href="#CenterDetermination.get_radius-1760"><span class="linenos">1760</span></a>            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1761"><a href="#CenterDetermination.get_radius-1761"><span class="linenos">1761</span></a>    
</span><span id="CenterDetermination.get_radius-1762"><a href="#CenterDetermination.get_radius-1762"><span class="linenos">1762</span></a>            <span class="c1"># Split into left and right halves, excluding the highest value</span>
</span><span id="CenterDetermination.get_radius-1763"><a href="#CenterDetermination.get_radius-1763"><span class="linenos">1763</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="n">center_idx</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-1764"><a href="#CenterDetermination.get_radius-1764"><span class="linenos">1764</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="CenterDetermination.get_radius-1765"><a href="#CenterDetermination.get_radius-1765"><span class="linenos">1765</span></a>            <span class="n">left_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1766"><a href="#CenterDetermination.get_radius-1766"><span class="linenos">1766</span></a>            <span class="n">right_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">center_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
</span><span id="CenterDetermination.get_radius-1767"><a href="#CenterDetermination.get_radius-1767"><span class="linenos">1767</span></a>    
</span><span id="CenterDetermination.get_radius-1768"><a href="#CenterDetermination.get_radius-1768"><span class="linenos">1768</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check for empty halves</span>
</span><span id="CenterDetermination.get_radius-1769"><a href="#CenterDetermination.get_radius-1769"><span class="linenos">1769</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1770"><a href="#CenterDetermination.get_radius-1770"><span class="linenos">1770</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One of the halves is empty.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1771"><a href="#CenterDetermination.get_radius-1771"><span class="linenos">1771</span></a>                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1772"><a href="#CenterDetermination.get_radius-1772"><span class="linenos">1772</span></a>    
</span><span id="CenterDetermination.get_radius-1773"><a href="#CenterDetermination.get_radius-1773"><span class="linenos">1773</span></a>            <span class="c1"># Initialize variables for tracking the smallest difference</span>
</span><span id="CenterDetermination.get_radius-1774"><a href="#CenterDetermination.get_radius-1774"><span class="linenos">1774</span></a>            <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="CenterDetermination.get_radius-1775"><a href="#CenterDetermination.get_radius-1775"><span class="linenos">1775</span></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1776"><a href="#CenterDetermination.get_radius-1776"><span class="linenos">1776</span></a>    
</span><span id="CenterDetermination.get_radius-1777"><a href="#CenterDetermination.get_radius-1777"><span class="linenos">1777</span></a>            <span class="c1"># Compare each value in the left with every value in the right</span>
</span><span id="CenterDetermination.get_radius-1778"><a href="#CenterDetermination.get_radius-1778"><span class="linenos">1778</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left</span><span class="p">):</span>
</span><span id="CenterDetermination.get_radius-1779"><a href="#CenterDetermination.get_radius-1779"><span class="linenos">1779</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">r_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
</span><span id="CenterDetermination.get_radius-1780"><a href="#CenterDetermination.get_radius-1780"><span class="linenos">1780</span></a>                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">l_val</span> <span class="o">-</span> <span class="n">r_val</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1781"><a href="#CenterDetermination.get_radius-1781"><span class="linenos">1781</span></a>                    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">smallest_diff</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1782"><a href="#CenterDetermination.get_radius-1782"><span class="linenos">1782</span></a>                        <span class="n">smallest_diff</span> <span class="o">=</span> <span class="n">diff</span>
</span><span id="CenterDetermination.get_radius-1783"><a href="#CenterDetermination.get_radius-1783"><span class="linenos">1783</span></a>                        <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">right_indices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="CenterDetermination.get_radius-1784"><a href="#CenterDetermination.get_radius-1784"><span class="linenos">1784</span></a>    
</span><span id="CenterDetermination.get_radius-1785"><a href="#CenterDetermination.get_radius-1785"><span class="linenos">1785</span></a>            <span class="k">return</span> <span class="n">best_pair</span>
</span><span id="CenterDetermination.get_radius-1786"><a href="#CenterDetermination.get_radius-1786"><span class="linenos">1786</span></a>    
</span><span id="CenterDetermination.get_radius-1787"><a href="#CenterDetermination.get_radius-1787"><span class="linenos">1787</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1788"><a href="#CenterDetermination.get_radius-1788"><span class="linenos">1788</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1789"><a href="#CenterDetermination.get_radius-1789"><span class="linenos">1789</span></a>    
</span><span id="CenterDetermination.get_radius-1790"><a href="#CenterDetermination.get_radius-1790"><span class="linenos">1790</span></a>        <span class="n">x_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="CenterDetermination.get_radius-1791"><a href="#CenterDetermination.get_radius-1791"><span class="linenos">1791</span></a>        <span class="n">y_line</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
</span><span id="CenterDetermination.get_radius-1792"><a href="#CenterDetermination.get_radius-1792"><span class="linenos">1792</span></a>    
</span><span id="CenterDetermination.get_radius-1793"><a href="#CenterDetermination.get_radius-1793"><span class="linenos">1793</span></a>        <span class="c1"># Define threshold for peak detection</span>
</span><span id="CenterDetermination.get_radius-1794"><a href="#CenterDetermination.get_radius-1794"><span class="linenos">1794</span></a>        <span class="n">x_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1795"><a href="#CenterDetermination.get_radius-1795"><span class="linenos">1795</span></a>        <span class="n">y_thr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_line</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1796"><a href="#CenterDetermination.get_radius-1796"><span class="linenos">1796</span></a>    
</span><span id="CenterDetermination.get_radius-1797"><a href="#CenterDetermination.get_radius-1797"><span class="linenos">1797</span></a>        <span class="c1"># Find peaks with dynamic height thresholds</span>
</span><span id="CenterDetermination.get_radius-1798"><a href="#CenterDetermination.get_radius-1798"><span class="linenos">1798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-1799"><a href="#CenterDetermination.get_radius-1799"><span class="linenos">1799</span></a>                                    <span class="n">height</span><span class="o">=</span><span class="n">x_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-1800"><a href="#CenterDetermination.get_radius-1800"><span class="linenos">1800</span></a>                                    <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-1801"><a href="#CenterDetermination.get_radius-1801"><span class="linenos">1801</span></a>                                    <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1802"><a href="#CenterDetermination.get_radius-1802"><span class="linenos">1802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span> <span class="o">=</span> <span class="n">x_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-1803"><a href="#CenterDetermination.get_radius-1803"><span class="linenos">1803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-1804"><a href="#CenterDetermination.get_radius-1804"><span class="linenos">1804</span></a>                                    <span class="n">height</span><span class="o">=</span><span class="n">y_thr</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-1805"><a href="#CenterDetermination.get_radius-1805"><span class="linenos">1805</span></a>                                    <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="CenterDetermination.get_radius-1806"><a href="#CenterDetermination.get_radius-1806"><span class="linenos">1806</span></a>                                    <span class="n">distance</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1807"><a href="#CenterDetermination.get_radius-1807"><span class="linenos">1807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span> <span class="o">=</span> <span class="n">y_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">]</span>
</span><span id="CenterDetermination.get_radius-1808"><a href="#CenterDetermination.get_radius-1808"><span class="linenos">1808</span></a>    
</span><span id="CenterDetermination.get_radius-1809"><a href="#CenterDetermination.get_radius-1809"><span class="linenos">1809</span></a>        <span class="c1"># Define half the length of the image</span>
</span><span id="CenterDetermination.get_radius-1810"><a href="#CenterDetermination.get_radius-1810"><span class="linenos">1810</span></a>        <span class="n">half_length_x</span> <span class="o">=</span> <span class="n">x_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-1811"><a href="#CenterDetermination.get_radius-1811"><span class="linenos">1811</span></a>        <span class="n">half_length_y</span> <span class="o">=</span> <span class="n">y_line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-1812"><a href="#CenterDetermination.get_radius-1812"><span class="linenos">1812</span></a>    
</span><span id="CenterDetermination.get_radius-1813"><a href="#CenterDetermination.get_radius-1813"><span class="linenos">1813</span></a>        <span class="c1"># Check the additional condition for xpeaks</span>
</span><span id="CenterDetermination.get_radius-1814"><a href="#CenterDetermination.get_radius-1814"><span class="linenos">1814</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination.get_radius-1815"><a href="#CenterDetermination.get_radius-1815"><span class="linenos">1815</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_x</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination.get_radius-1816"><a href="#CenterDetermination.get_radius-1816"><span class="linenos">1816</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_x</span><span class="p">)):</span>
</span><span id="CenterDetermination.get_radius-1817"><a href="#CenterDetermination.get_radius-1817"><span class="linenos">1817</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1818"><a href="#CenterDetermination.get_radius-1818"><span class="linenos">1818</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xpeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1819"><a href="#CenterDetermination.get_radius-1819"><span class="linenos">1819</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1820"><a href="#CenterDetermination.get_radius-1820"><span class="linenos">1820</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1821"><a href="#CenterDetermination.get_radius-1821"><span class="linenos">1821</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1822"><a href="#CenterDetermination.get_radius-1822"><span class="linenos">1822</span></a>    
</span><span id="CenterDetermination.get_radius-1823"><a href="#CenterDetermination.get_radius-1823"><span class="linenos">1823</span></a>        <span class="c1"># Check the additional condition for ypeaks</span>
</span><span id="CenterDetermination.get_radius-1824"><a href="#CenterDetermination.get_radius-1824"><span class="linenos">1824</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="CenterDetermination.get_radius-1825"><a href="#CenterDetermination.get_radius-1825"><span class="linenos">1825</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">half_length_y</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="CenterDetermination.get_radius-1826"><a href="#CenterDetermination.get_radius-1826"><span class="linenos">1826</span></a>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">half_length_y</span><span class="p">)):</span>
</span><span id="CenterDetermination.get_radius-1827"><a href="#CenterDetermination.get_radius-1827"><span class="linenos">1827</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1828"><a href="#CenterDetermination.get_radius-1828"><span class="linenos">1828</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ypeaks condition met: Both peaks are on the same side of the center.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1829"><a href="#CenterDetermination.get_radius-1829"><span class="linenos">1829</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1830"><a href="#CenterDetermination.get_radius-1830"><span class="linenos">1830</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1831"><a href="#CenterDetermination.get_radius-1831"><span class="linenos">1831</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="o">=</span> <span class="n">match_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1832"><a href="#CenterDetermination.get_radius-1832"><span class="linenos">1832</span></a>    
</span><span id="CenterDetermination.get_radius-1833"><a href="#CenterDetermination.get_radius-1833"><span class="linenos">1833</span></a>        <span class="c1"># Determine radius based on available pairs</span>
</span><span id="CenterDetermination.get_radius-1834"><a href="#CenterDetermination.get_radius-1834"><span class="linenos">1834</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1835"><a href="#CenterDetermination.get_radius-1835"><span class="linenos">1835</span></a>            <span class="n">rx_x</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1836"><a href="#CenterDetermination.get_radius-1836"><span class="linenos">1836</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1837"><a href="#CenterDetermination.get_radius-1837"><span class="linenos">1837</span></a>            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-1838"><a href="#CenterDetermination.get_radius-1838"><span class="linenos">1838</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairX</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-1839"><a href="#CenterDetermination.get_radius-1839"><span class="linenos">1839</span></a>            <span class="n">rx_x</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-1840"><a href="#CenterDetermination.get_radius-1840"><span class="linenos">1840</span></a>    
</span><span id="CenterDetermination.get_radius-1841"><a href="#CenterDetermination.get_radius-1841"><span class="linenos">1841</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1842"><a href="#CenterDetermination.get_radius-1842"><span class="linenos">1842</span></a>            <span class="n">rx_y</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CenterDetermination.get_radius-1843"><a href="#CenterDetermination.get_radius-1843"><span class="linenos">1843</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1844"><a href="#CenterDetermination.get_radius-1844"><span class="linenos">1844</span></a>            <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-1845"><a href="#CenterDetermination.get_radius-1845"><span class="linenos">1845</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pairY</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="CenterDetermination.get_radius-1846"><a href="#CenterDetermination.get_radius-1846"><span class="linenos">1846</span></a>            <span class="n">rx_y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="CenterDetermination.get_radius-1847"><a href="#CenterDetermination.get_radius-1847"><span class="linenos">1847</span></a>    
</span><span id="CenterDetermination.get_radius-1848"><a href="#CenterDetermination.get_radius-1848"><span class="linenos">1848</span></a>        <span class="k">if</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1849"><a href="#CenterDetermination.get_radius-1849"><span class="linenos">1849</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">rx_x</span><span class="p">,</span> <span class="n">rx_y</span><span class="p">])</span>
</span><span id="CenterDetermination.get_radius-1850"><a href="#CenterDetermination.get_radius-1850"><span class="linenos">1850</span></a>        <span class="k">elif</span> <span class="n">rx_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1851"><a href="#CenterDetermination.get_radius-1851"><span class="linenos">1851</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_x</span>
</span><span id="CenterDetermination.get_radius-1852"><a href="#CenterDetermination.get_radius-1852"><span class="linenos">1852</span></a>        <span class="k">elif</span> <span class="n">rx_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1853"><a href="#CenterDetermination.get_radius-1853"><span class="linenos">1853</span></a>            <span class="n">rx</span> <span class="o">=</span> <span class="n">rx_y</span>
</span><span id="CenterDetermination.get_radius-1854"><a href="#CenterDetermination.get_radius-1854"><span class="linenos">1854</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1855"><a href="#CenterDetermination.get_radius-1855"><span class="linenos">1855</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1856"><a href="#CenterDetermination.get_radius-1856"><span class="linenos">1856</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid pairs detected for radius calculation.&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1857"><a href="#CenterDetermination.get_radius-1857"><span class="linenos">1857</span></a>            <span class="k">return</span> <span class="mi">100</span>  <span class="c1"># Default radius or error handling</span>
</span><span id="CenterDetermination.get_radius-1858"><a href="#CenterDetermination.get_radius-1858"><span class="linenos">1858</span></a>    
</span><span id="CenterDetermination.get_radius-1859"><a href="#CenterDetermination.get_radius-1859"><span class="linenos">1859</span></a>        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
</span><span id="CenterDetermination.get_radius-1860"><a href="#CenterDetermination.get_radius-1860"><span class="linenos">1860</span></a>            <span class="c1"># Plot xline with peaks</span>
</span><span id="CenterDetermination.get_radius-1861"><a href="#CenterDetermination.get_radius-1861"><span class="linenos">1861</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="CenterDetermination.get_radius-1862"><a href="#CenterDetermination.get_radius-1862"><span class="linenos">1862</span></a>    
</span><span id="CenterDetermination.get_radius-1863"><a href="#CenterDetermination.get_radius-1863"><span class="linenos">1863</span></a>            <span class="c1"># Plot for xline</span>
</span><span id="CenterDetermination.get_radius-1864"><a href="#CenterDetermination.get_radius-1864"><span class="linenos">1864</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1865"><a href="#CenterDetermination.get_radius-1865"><span class="linenos">1865</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1866"><a href="#CenterDetermination.get_radius-1866"><span class="linenos">1866</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1867"><a href="#CenterDetermination.get_radius-1867"><span class="linenos">1867</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in xline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1868"><a href="#CenterDetermination.get_radius-1868"><span class="linenos">1868</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1869"><a href="#CenterDetermination.get_radius-1869"><span class="linenos">1869</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1870"><a href="#CenterDetermination.get_radius-1870"><span class="linenos">1870</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-1871"><a href="#CenterDetermination.get_radius-1871"><span class="linenos">1871</span></a>    
</span><span id="CenterDetermination.get_radius-1872"><a href="#CenterDetermination.get_radius-1872"><span class="linenos">1872</span></a>            <span class="c1"># Plot for yline</span>
</span><span id="CenterDetermination.get_radius-1873"><a href="#CenterDetermination.get_radius-1873"><span class="linenos">1873</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1874"><a href="#CenterDetermination.get_radius-1874"><span class="linenos">1874</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1875"><a href="#CenterDetermination.get_radius-1875"><span class="linenos">1875</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypeaks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yyvals</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peaks&#39;</span><span class="p">)</span>  
</span><span id="CenterDetermination.get_radius-1876"><a href="#CenterDetermination.get_radius-1876"><span class="linenos">1876</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peaks in yline&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1877"><a href="#CenterDetermination.get_radius-1877"><span class="linenos">1877</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1878"><a href="#CenterDetermination.get_radius-1878"><span class="linenos">1878</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.get_radius-1879"><a href="#CenterDetermination.get_radius-1879"><span class="linenos">1879</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-1880"><a href="#CenterDetermination.get_radius-1880"><span class="linenos">1880</span></a>    
</span><span id="CenterDetermination.get_radius-1881"><a href="#CenterDetermination.get_radius-1881"><span class="linenos">1881</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-1882"><a href="#CenterDetermination.get_radius-1882"><span class="linenos">1882</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="CenterDetermination.get_radius-1883"><a href="#CenterDetermination.get_radius-1883"><span class="linenos">1883</span></a>    
</span><span id="CenterDetermination.get_radius-1884"><a href="#CenterDetermination.get_radius-1884"><span class="linenos">1884</span></a>        <span class="k">return</span> <span class="n">rx</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the radius of a circle based on intensity profiles along 
horizontal and vertical axes.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>im</strong> (np.ndarray):
The 2D image array containing the circle.</li>
<li><strong>x</strong> (float):
The x-coordinate of the circle's center.</li>
<li><strong>y</strong> (float):
The y-coordinate of the circle's center.</li>
<li><strong>disp</strong> (bool, optional):
If True, visualizes the detected intensity profiles and peaks 
(default is False).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: The estimated radius of the circle. Defaults to 100 if no valid 
radius is detected.</li>
</ul>
</div>


                            </div>
                            <div id="CenterDetermination.visualize_center" class="classattr">
                                        <input id="CenterDetermination.visualize_center-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_center</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">y</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">r</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CenterDetermination.visualize_center-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterDetermination.visualize_center"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterDetermination.visualize_center-1887"><a href="#CenterDetermination.visualize_center-1887"><span class="linenos">1887</span></a>    <span class="k">def</span> <span class="nf">visualize_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-1888"><a href="#CenterDetermination.visualize_center-1888"><span class="linenos">1888</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterDetermination.visualize_center-1889"><a href="#CenterDetermination.visualize_center-1889"><span class="linenos">1889</span></a><span class="sd">        Visualize detected diffraction patterns and mark the center.</span>
</span><span id="CenterDetermination.visualize_center-1890"><a href="#CenterDetermination.visualize_center-1890"><span class="linenos">1890</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.visualize_center-1891"><a href="#CenterDetermination.visualize_center-1891"><span class="linenos">1891</span></a><span class="sd">        Parameters</span>
</span><span id="CenterDetermination.visualize_center-1892"><a href="#CenterDetermination.visualize_center-1892"><span class="linenos">1892</span></a><span class="sd">        ----------</span>
</span><span id="CenterDetermination.visualize_center-1893"><a href="#CenterDetermination.visualize_center-1893"><span class="linenos">1893</span></a><span class="sd">        tit : string</span>
</span><span id="CenterDetermination.visualize_center-1894"><a href="#CenterDetermination.visualize_center-1894"><span class="linenos">1894</span></a><span class="sd">            name of the method used for circle detection</span>
</span><span id="CenterDetermination.visualize_center-1895"><a href="#CenterDetermination.visualize_center-1895"><span class="linenos">1895</span></a><span class="sd">        x : float64</span>
</span><span id="CenterDetermination.visualize_center-1896"><a href="#CenterDetermination.visualize_center-1896"><span class="linenos">1896</span></a><span class="sd">            x-coordinate of the detected center</span>
</span><span id="CenterDetermination.visualize_center-1897"><a href="#CenterDetermination.visualize_center-1897"><span class="linenos">1897</span></a><span class="sd">        y : float64</span>
</span><span id="CenterDetermination.visualize_center-1898"><a href="#CenterDetermination.visualize_center-1898"><span class="linenos">1898</span></a><span class="sd">            y-coordinate of the detected center</span>
</span><span id="CenterDetermination.visualize_center-1899"><a href="#CenterDetermination.visualize_center-1899"><span class="linenos">1899</span></a><span class="sd">        r : float64</span>
</span><span id="CenterDetermination.visualize_center-1900"><a href="#CenterDetermination.visualize_center-1900"><span class="linenos">1900</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterDetermination.visualize_center-1901"><a href="#CenterDetermination.visualize_center-1901"><span class="linenos">1901</span></a><span class="sd">        </span>
</span><span id="CenterDetermination.visualize_center-1902"><a href="#CenterDetermination.visualize_center-1902"><span class="linenos">1902</span></a><span class="sd">        Returns</span>
</span><span id="CenterDetermination.visualize_center-1903"><a href="#CenterDetermination.visualize_center-1903"><span class="linenos">1903</span></a><span class="sd">        -------</span>
</span><span id="CenterDetermination.visualize_center-1904"><a href="#CenterDetermination.visualize_center-1904"><span class="linenos">1904</span></a><span class="sd">        None.</span>
</span><span id="CenterDetermination.visualize_center-1905"><a href="#CenterDetermination.visualize_center-1905"><span class="linenos">1905</span></a><span class="sd">                            </span>
</span><span id="CenterDetermination.visualize_center-1906"><a href="#CenterDetermination.visualize_center-1906"><span class="linenos">1906</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterDetermination.visualize_center-1907"><a href="#CenterDetermination.visualize_center-1907"><span class="linenos">1907</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterDetermination.visualize_center-1908"><a href="#CenterDetermination.visualize_center-1908"><span class="linenos">1908</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1909"><a href="#CenterDetermination.visualize_center-1909"><span class="linenos">1909</span></a>    
</span><span id="CenterDetermination.visualize_center-1910"><a href="#CenterDetermination.visualize_center-1910"><span class="linenos">1910</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-1911"><a href="#CenterDetermination.visualize_center-1911"><span class="linenos">1911</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1912"><a href="#CenterDetermination.visualize_center-1912"><span class="linenos">1912</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CenterDetermination.visualize_center-1913"><a href="#CenterDetermination.visualize_center-1913"><span class="linenos">1913</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1914"><a href="#CenterDetermination.visualize_center-1914"><span class="linenos">1914</span></a>            
</span><span id="CenterDetermination.visualize_center-1915"><a href="#CenterDetermination.visualize_center-1915"><span class="linenos">1915</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterDetermination.visualize_center-1916"><a href="#CenterDetermination.visualize_center-1916"><span class="linenos">1916</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="CenterDetermination.visualize_center-1917"><a href="#CenterDetermination.visualize_center-1917"><span class="linenos">1917</span></a>        
</span><span id="CenterDetermination.visualize_center-1918"><a href="#CenterDetermination.visualize_center-1918"><span class="linenos">1918</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterDetermination.visualize_center-1919"><a href="#CenterDetermination.visualize_center-1919"><span class="linenos">1919</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1920"><a href="#CenterDetermination.visualize_center-1920"><span class="linenos">1920</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1921"><a href="#CenterDetermination.visualize_center-1921"><span class="linenos">1921</span></a> 
</span><span id="CenterDetermination.visualize_center-1922"><a href="#CenterDetermination.visualize_center-1922"><span class="linenos">1922</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Detected center&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1923"><a href="#CenterDetermination.visualize_center-1923"><span class="linenos">1923</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1924"><a href="#CenterDetermination.visualize_center-1924"><span class="linenos">1924</span></a>
</span><span id="CenterDetermination.visualize_center-1925"><a href="#CenterDetermination.visualize_center-1925"><span class="linenos">1925</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterDetermination.visualize_center-1926"><a href="#CenterDetermination.visualize_center-1926"><span class="linenos">1926</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span>
</span><span id="CenterDetermination.visualize_center-1927"><a href="#CenterDetermination.visualize_center-1927"><span class="linenos">1927</span></a>                <span class="n">label</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;center:  [</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span>
</span><span id="CenterDetermination.visualize_center-1928"><a href="#CenterDetermination.visualize_center-1928"><span class="linenos">1928</span></a>                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1929"><a href="#CenterDetermination.visualize_center-1929"><span class="linenos">1929</span></a>
</span><span id="CenterDetermination.visualize_center-1930"><a href="#CenterDetermination.visualize_center-1930"><span class="linenos">1930</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1931"><a href="#CenterDetermination.visualize_center-1931"><span class="linenos">1931</span></a>        
</span><span id="CenterDetermination.visualize_center-1932"><a href="#CenterDetermination.visualize_center-1932"><span class="linenos">1932</span></a>        <span class="c1"># Display the image</span>
</span><span id="CenterDetermination.visualize_center-1933"><a href="#CenterDetermination.visualize_center-1933"><span class="linenos">1933</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1934"><a href="#CenterDetermination.visualize_center-1934"><span class="linenos">1934</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterDetermination.visualize_center-1935"><a href="#CenterDetermination.visualize_center-1935"><span class="linenos">1935</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterDetermination.visualize_center-1936"><a href="#CenterDetermination.visualize_center-1936"><span class="linenos">1936</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize detected diffraction patterns and mark the center.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>tit</strong> (string):
name of the method used for circle detection</li>
<li><strong>x</strong> (float64):
x-coordinate of the detected center</li>
<li><strong>y</strong> (float64):
y-coordinate of the detected center</li>
<li><strong>r</strong> (float64):
radius of the detected center</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                            </div>
                </section>
                <section id="CenterRefinement">
                            <input id="CenterRefinement-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CenterRefinement</span>:

                <label class="view-source-button" for="CenterRefinement-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement-1940"><a href="#CenterRefinement-1940"><span class="linenos">1940</span></a><span class="k">class</span> <span class="nc">CenterRefinement</span><span class="p">:</span>
</span><span id="CenterRefinement-1941"><a href="#CenterRefinement-1941"><span class="linenos">1941</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="CenterRefinement-1942"><a href="#CenterRefinement-1942"><span class="linenos">1942</span></a><span class="sd">    CenterRefinement object - final refinement of a diffractogram center.</span>
</span><span id="CenterRefinement-1943"><a href="#CenterRefinement-1943"><span class="linenos">1943</span></a>
</span><span id="CenterRefinement-1944"><a href="#CenterRefinement-1944"><span class="linenos">1944</span></a><span class="sd">    This class is responsible for refining the center coordinates of a </span>
</span><span id="CenterRefinement-1945"><a href="#CenterRefinement-1945"><span class="linenos">1945</span></a><span class="sd">    diffraction pattern based on the selected refinement method. It </span>
</span><span id="CenterRefinement-1946"><a href="#CenterRefinement-1946"><span class="linenos">1946</span></a><span class="sd">    initializes with the input image and other parameters that influence </span>
</span><span id="CenterRefinement-1947"><a href="#CenterRefinement-1947"><span class="linenos">1947</span></a><span class="sd">    the refinement process.</span>
</span><span id="CenterRefinement-1948"><a href="#CenterRefinement-1948"><span class="linenos">1948</span></a>
</span><span id="CenterRefinement-1949"><a href="#CenterRefinement-1949"><span class="linenos">1949</span></a><span class="sd">    Parameters</span>
</span><span id="CenterRefinement-1950"><a href="#CenterRefinement-1950"><span class="linenos">1950</span></a><span class="sd">    ----------</span>
</span><span id="CenterRefinement-1951"><a href="#CenterRefinement-1951"><span class="linenos">1951</span></a><span class="sd">    parent : CenterLocator</span>
</span><span id="CenterRefinement-1952"><a href="#CenterRefinement-1952"><span class="linenos">1952</span></a><span class="sd">        Reference to the parent CenterLocator object, allowing access to </span>
</span><span id="CenterRefinement-1953"><a href="#CenterRefinement-1953"><span class="linenos">1953</span></a><span class="sd">        shared attributes and methods.</span>
</span><span id="CenterRefinement-1954"><a href="#CenterRefinement-1954"><span class="linenos">1954</span></a><span class="sd">    input_image : str, path, or numpy.array</span>
</span><span id="CenterRefinement-1955"><a href="#CenterRefinement-1955"><span class="linenos">1955</span></a><span class="sd">        The input image representing a 2D diffraction pattern, provided as </span>
</span><span id="CenterRefinement-1956"><a href="#CenterRefinement-1956"><span class="linenos">1956</span></a><span class="sd">        a file path or a NumPy array.</span>
</span><span id="CenterRefinement-1957"><a href="#CenterRefinement-1957"><span class="linenos">1957</span></a><span class="sd">    refinement : str or None, optional, default is None</span>
</span><span id="CenterRefinement-1958"><a href="#CenterRefinement-1958"><span class="linenos">1958</span></a><span class="sd">        The method used for the final center refinement.</span>
</span><span id="CenterRefinement-1959"><a href="#CenterRefinement-1959"><span class="linenos">1959</span></a><span class="sd">        Options include:</span>
</span><span id="CenterRefinement-1960"><a href="#CenterRefinement-1960"><span class="linenos">1960</span></a><span class="sd">        - &#39;manual&#39;: Manual adjustment - user adjust the position</span>
</span><span id="CenterRefinement-1961"><a href="#CenterRefinement-1961"><span class="linenos">1961</span></a><span class="sd">          of the selected diffration ring.</span>
</span><span id="CenterRefinement-1962"><a href="#CenterRefinement-1962"><span class="linenos">1962</span></a><span class="sd">        - &#39;sum&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="CenterRefinement-1963"><a href="#CenterRefinement-1963"><span class="linenos">1963</span></a><span class="sd">          with maximal sum of intensities.</span>
</span><span id="CenterRefinement-1964"><a href="#CenterRefinement-1964"><span class="linenos">1964</span></a><span class="sd">        - &#39;var&#39;: Auto-refinement - find a diffraction ring</span>
</span><span id="CenterRefinement-1965"><a href="#CenterRefinement-1965"><span class="linenos">1965</span></a><span class="sd">          with minimal variance of intensities.</span>
</span><span id="CenterRefinement-1966"><a href="#CenterRefinement-1966"><span class="linenos">1966</span></a><span class="sd">    out_file : str, optional</span>
</span><span id="CenterRefinement-1967"><a href="#CenterRefinement-1967"><span class="linenos">1967</span></a><span class="sd">        Filename of the text file to which the refined center coordinates </span>
</span><span id="CenterRefinement-1968"><a href="#CenterRefinement-1968"><span class="linenos">1968</span></a><span class="sd">        will be saved.</span>
</span><span id="CenterRefinement-1969"><a href="#CenterRefinement-1969"><span class="linenos">1969</span></a><span class="sd">    heq : bool, optional</span>
</span><span id="CenterRefinement-1970"><a href="#CenterRefinement-1970"><span class="linenos">1970</span></a><span class="sd">        Flag to indicate whether to perform histogram equalization on the</span>
</span><span id="CenterRefinement-1971"><a href="#CenterRefinement-1971"><span class="linenos">1971</span></a><span class="sd">        input image. Default is False.</span>
</span><span id="CenterRefinement-1972"><a href="#CenterRefinement-1972"><span class="linenos">1972</span></a><span class="sd">    icut : float, optional</span>
</span><span id="CenterRefinement-1973"><a href="#CenterRefinement-1973"><span class="linenos">1973</span></a><span class="sd">        Cut-off intensity level for processing the image. Default is None.</span>
</span><span id="CenterRefinement-1974"><a href="#CenterRefinement-1974"><span class="linenos">1974</span></a><span class="sd">    cmap : str, optional</span>
</span><span id="CenterRefinement-1975"><a href="#CenterRefinement-1975"><span class="linenos">1975</span></a><span class="sd">        Colormap to be used for displaying the image. Default is &#39;gray&#39;.</span>
</span><span id="CenterRefinement-1976"><a href="#CenterRefinement-1976"><span class="linenos">1976</span></a><span class="sd">    messages : bool, optional</span>
</span><span id="CenterRefinement-1977"><a href="#CenterRefinement-1977"><span class="linenos">1977</span></a><span class="sd">        Flag to enable or disable informational messages during processing. </span>
</span><span id="CenterRefinement-1978"><a href="#CenterRefinement-1978"><span class="linenos">1978</span></a><span class="sd">        Default is False.</span>
</span><span id="CenterRefinement-1979"><a href="#CenterRefinement-1979"><span class="linenos">1979</span></a><span class="sd">    print_sums : bool, optional</span>
</span><span id="CenterRefinement-1980"><a href="#CenterRefinement-1980"><span class="linenos">1980</span></a><span class="sd">        If True, prints the sum of intensity values for the refined circle </span>
</span><span id="CenterRefinement-1981"><a href="#CenterRefinement-1981"><span class="linenos">1981</span></a><span class="sd">        after each adjustment, relevant only for manual refinement methods.</span>
</span><span id="CenterRefinement-1982"><a href="#CenterRefinement-1982"><span class="linenos">1982</span></a>
</span><span id="CenterRefinement-1983"><a href="#CenterRefinement-1983"><span class="linenos">1983</span></a><span class="sd">    Returns</span>
</span><span id="CenterRefinement-1984"><a href="#CenterRefinement-1984"><span class="linenos">1984</span></a><span class="sd">    -------</span>
</span><span id="CenterRefinement-1985"><a href="#CenterRefinement-1985"><span class="linenos">1985</span></a><span class="sd">    None</span>
</span><span id="CenterRefinement-1986"><a href="#CenterRefinement-1986"><span class="linenos">1986</span></a>
</span><span id="CenterRefinement-1987"><a href="#CenterRefinement-1987"><span class="linenos">1987</span></a><span class="sd">    Notes</span>
</span><span id="CenterRefinement-1988"><a href="#CenterRefinement-1988"><span class="linenos">1988</span></a><span class="sd">    -----</span>
</span><span id="CenterRefinement-1989"><a href="#CenterRefinement-1989"><span class="linenos">1989</span></a><span class="sd">    - The class refines the detected center coordinates based on the </span>
</span><span id="CenterRefinement-1990"><a href="#CenterRefinement-1990"><span class="linenos">1990</span></a><span class="sd">      specified refinement method.</span>
</span><span id="CenterRefinement-1991"><a href="#CenterRefinement-1991"><span class="linenos">1991</span></a><span class="sd">    - The refined coordinates are stored in instance variables</span>
</span><span id="CenterRefinement-1992"><a href="#CenterRefinement-1992"><span class="linenos">1992</span></a><span class="sd">      `xx`, `yy`, and `rr`, representing the refined center&#39;s x-coordinate, </span>
</span><span id="CenterRefinement-1993"><a href="#CenterRefinement-1993"><span class="linenos">1993</span></a><span class="sd">      y-coordinate, and radius, respectively.</span>
</span><span id="CenterRefinement-1994"><a href="#CenterRefinement-1994"><span class="linenos">1994</span></a><span class="sd">    - If an unsupported refinement method is specified, the class will print </span>
</span><span id="CenterRefinement-1995"><a href="#CenterRefinement-1995"><span class="linenos">1995</span></a><span class="sd">      an error message and exit.</span>
</span><span id="CenterRefinement-1996"><a href="#CenterRefinement-1996"><span class="linenos">1996</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="CenterRefinement-1997"><a href="#CenterRefinement-1997"><span class="linenos">1997</span></a>    
</span><span id="CenterRefinement-1998"><a href="#CenterRefinement-1998"><span class="linenos">1998</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span>
</span><span id="CenterRefinement-1999"><a href="#CenterRefinement-1999"><span class="linenos">1999</span></a>                 <span class="n">input_image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2000"><a href="#CenterRefinement-2000"><span class="linenos">2000</span></a>                 <span class="n">refinement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-2001"><a href="#CenterRefinement-2001"><span class="linenos">2001</span></a>                 <span class="n">in_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-2002"><a href="#CenterRefinement-2002"><span class="linenos">2002</span></a>                 <span class="n">out_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-2003"><a href="#CenterRefinement-2003"><span class="linenos">2003</span></a>                 <span class="n">heq</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="CenterRefinement-2004"><a href="#CenterRefinement-2004"><span class="linenos">2004</span></a>                 <span class="n">icut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CenterRefinement-2005"><a href="#CenterRefinement-2005"><span class="linenos">2005</span></a>                 <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="CenterRefinement-2006"><a href="#CenterRefinement-2006"><span class="linenos">2006</span></a>                 <span class="n">messages</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CenterRefinement-2007"><a href="#CenterRefinement-2007"><span class="linenos">2007</span></a>                 <span class="n">print_sums</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="CenterRefinement-2008"><a href="#CenterRefinement-2008"><span class="linenos">2008</span></a>        
</span><span id="CenterRefinement-2009"><a href="#CenterRefinement-2009"><span class="linenos">2009</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterRefinement-2010"><a href="#CenterRefinement-2010"><span class="linenos">2010</span></a>        <span class="c1"># PRIVATE FUNCTION: Initialize CenterLocator object.</span>
</span><span id="CenterRefinement-2011"><a href="#CenterRefinement-2011"><span class="linenos">2011</span></a>        <span class="c1"># The parameters are described above in class definition.</span>
</span><span id="CenterRefinement-2012"><a href="#CenterRefinement-2012"><span class="linenos">2012</span></a>        <span class="c1">######################################################################</span>
</span><span id="CenterRefinement-2013"><a href="#CenterRefinement-2013"><span class="linenos">2013</span></a>        
</span><span id="CenterRefinement-2014"><a href="#CenterRefinement-2014"><span class="linenos">2014</span></a>        <span class="c1">## (0) Initialize input attributes</span>
</span><span id="CenterRefinement-2015"><a href="#CenterRefinement-2015"><span class="linenos">2015</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="CenterRefinement-2016"><a href="#CenterRefinement-2016"><span class="linenos">2016</span></a>        
</span><span id="CenterRefinement-2017"><a href="#CenterRefinement-2017"><span class="linenos">2017</span></a>        <span class="c1">## (1) Initialize new attributes</span>
</span><span id="CenterRefinement-2018"><a href="#CenterRefinement-2018"><span class="linenos">2018</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="CenterRefinement-2019"><a href="#CenterRefinement-2019"><span class="linenos">2019</span></a>        
</span><span id="CenterRefinement-2020"><a href="#CenterRefinement-2020"><span class="linenos">2020</span></a>        <span class="c1">## (2) Run functions</span>
</span><span id="CenterRefinement-2021"><a href="#CenterRefinement-2021"><span class="linenos">2021</span></a>        <span class="k">if</span> <span class="n">refinement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterRefinement-2022"><a href="#CenterRefinement-2022"><span class="linenos">2022</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CenterRefinement-2023"><a href="#CenterRefinement-2023"><span class="linenos">2023</span></a>            <span class="n">par_short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">center1</span>
</span><span id="CenterRefinement-2024"><a href="#CenterRefinement-2024"><span class="linenos">2024</span></a>        
</span><span id="CenterRefinement-2025"><a href="#CenterRefinement-2025"><span class="linenos">2025</span></a>            <span class="k">if</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
</span><span id="CenterRefinement-2026"><a href="#CenterRefinement-2026"><span class="linenos">2026</span></a>                <span class="c1"># Manual refinement method</span>
</span><span id="CenterRefinement-2027"><a href="#CenterRefinement-2027"><span class="linenos">2027</span></a>                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2028"><a href="#CenterRefinement-2028"><span class="linenos">2028</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> \
</span><span id="CenterRefinement-2029"><a href="#CenterRefinement-2029"><span class="linenos">2029</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span>
</span><span id="CenterRefinement-2030"><a href="#CenterRefinement-2030"><span class="linenos">2030</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> \
</span><span id="CenterRefinement-2031"><a href="#CenterRefinement-2031"><span class="linenos">2031</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par_short</span><span class="o">.</span><span class="n">backip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterRefinement-2032"><a href="#CenterRefinement-2032"><span class="linenos">2032</span></a>                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-2033"><a href="#CenterRefinement-2033"><span class="linenos">2033</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement-2034"><a href="#CenterRefinement-2034"><span class="linenos">2034</span></a>                            <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-2035"><a href="#CenterRefinement-2035"><span class="linenos">2035</span></a>                <span class="k">elif</span> <span class="n">parent</span><span class="o">.</span><span class="n">determination</span> <span class="o">==</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2036"><a href="#CenterRefinement-2036"><span class="linenos">2036</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="CenterRefinement-2037"><a href="#CenterRefinement-2037"><span class="linenos">2037</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-2038"><a href="#CenterRefinement-2038"><span class="linenos">2038</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement-2039"><a href="#CenterRefinement-2039"><span class="linenos">2039</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_interactive</span><span class="p">(</span>
</span><span id="CenterRefinement-2040"><a href="#CenterRefinement-2040"><span class="linenos">2040</span></a>                        <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-2041"><a href="#CenterRefinement-2041"><span class="linenos">2041</span></a>        
</span><span id="CenterRefinement-2042"><a href="#CenterRefinement-2042"><span class="linenos">2042</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;var&quot;</span><span class="p">:</span>
</span><span id="CenterRefinement-2043"><a href="#CenterRefinement-2043"><span class="linenos">2043</span></a>                <span class="c1"># Intensity variance refinement</span>
</span><span id="CenterRefinement-2044"><a href="#CenterRefinement-2044"><span class="linenos">2044</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_var</span><span class="p">(</span>
</span><span id="CenterRefinement-2045"><a href="#CenterRefinement-2045"><span class="linenos">2045</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-2046"><a href="#CenterRefinement-2046"><span class="linenos">2046</span></a>        
</span><span id="CenterRefinement-2047"><a href="#CenterRefinement-2047"><span class="linenos">2047</span></a>            <span class="k">elif</span> <span class="n">refinement</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
</span><span id="CenterRefinement-2048"><a href="#CenterRefinement-2048"><span class="linenos">2048</span></a>                <span class="c1"># Intensity sum refinement</span>
</span><span id="CenterRefinement-2049"><a href="#CenterRefinement-2049"><span class="linenos">2049</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_sum</span><span class="p">(</span>
</span><span id="CenterRefinement-2050"><a href="#CenterRefinement-2050"><span class="linenos">2050</span></a>                    <span class="n">par_short</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">par_short</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-2051"><a href="#CenterRefinement-2051"><span class="linenos">2051</span></a>        
</span><span id="CenterRefinement-2052"><a href="#CenterRefinement-2052"><span class="linenos">2052</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement-2053"><a href="#CenterRefinement-2053"><span class="linenos">2053</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected refinement method is not supported.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-2054"><a href="#CenterRefinement-2054"><span class="linenos">2054</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</span><span id="CenterRefinement-2055"><a href="#CenterRefinement-2055"><span class="linenos">2055</span></a>                        
</span><span id="CenterRefinement-2056"><a href="#CenterRefinement-2056"><span class="linenos">2056</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="CenterRefinement-2057"><a href="#CenterRefinement-2057"><span class="linenos">2057</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="CenterRefinement-2058"><a href="#CenterRefinement-2058"><span class="linenos">2058</span></a>            
</span><span id="CenterRefinement-2059"><a href="#CenterRefinement-2059"><span class="linenos">2059</span></a>           
</span><span id="CenterRefinement-2060"><a href="#CenterRefinement-2060"><span class="linenos">2060</span></a>    <span class="k">def</span> <span class="nf">ref_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterRefinement-2061"><a href="#CenterRefinement-2061"><span class="linenos">2061</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterRefinement-2062"><a href="#CenterRefinement-2062"><span class="linenos">2062</span></a><span class="sd">        Manual refinement of the detected diffraction pattern via one of </span>
</span><span id="CenterRefinement-2063"><a href="#CenterRefinement-2063"><span class="linenos">2063</span></a><span class="sd">        the methods provided in the class CircleDetection.</span>
</span><span id="CenterRefinement-2064"><a href="#CenterRefinement-2064"><span class="linenos">2064</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-2065"><a href="#CenterRefinement-2065"><span class="linenos">2065</span></a><span class="sd">        The user can change the position of the center of the diffraction</span>
</span><span id="CenterRefinement-2066"><a href="#CenterRefinement-2066"><span class="linenos">2066</span></a><span class="sd">        pattern and also the radius of the detected pattern using keys:</span>
</span><span id="CenterRefinement-2067"><a href="#CenterRefinement-2067"><span class="linenos">2067</span></a><span class="sd">            - left / right / top / down arrows : move left / right / top / down</span>
</span><span id="CenterRefinement-2068"><a href="#CenterRefinement-2068"><span class="linenos">2068</span></a><span class="sd">            - &#39;+&#39; : increase radius</span>
</span><span id="CenterRefinement-2069"><a href="#CenterRefinement-2069"><span class="linenos">2069</span></a><span class="sd">            - &#39;-&#39; : decrease radius</span>
</span><span id="CenterRefinement-2070"><a href="#CenterRefinement-2070"><span class="linenos">2070</span></a><span class="sd">            - &#39;b&#39;/&#39;l&#39; : increase/decrease step size&quot;)</span>
</span><span id="CenterRefinement-2071"><a href="#CenterRefinement-2071"><span class="linenos">2071</span></a><span class="sd">            - &#39;d&#39; : done, termination of the refinement</span>
</span><span id="CenterRefinement-2072"><a href="#CenterRefinement-2072"><span class="linenos">2072</span></a>
</span><span id="CenterRefinement-2073"><a href="#CenterRefinement-2073"><span class="linenos">2073</span></a><span class="sd">        If the interactive figure is closed without any modifications,</span>
</span><span id="CenterRefinement-2074"><a href="#CenterRefinement-2074"><span class="linenos">2074</span></a><span class="sd">        the function returns input variables and the proccess terminates.</span>
</span><span id="CenterRefinement-2075"><a href="#CenterRefinement-2075"><span class="linenos">2075</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-2076"><a href="#CenterRefinement-2076"><span class="linenos">2076</span></a><span class="sd">        The results are shown in a figure when the refinement is successful.</span>
</span><span id="CenterRefinement-2077"><a href="#CenterRefinement-2077"><span class="linenos">2077</span></a>
</span><span id="CenterRefinement-2078"><a href="#CenterRefinement-2078"><span class="linenos">2078</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement-2079"><a href="#CenterRefinement-2079"><span class="linenos">2079</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement-2080"><a href="#CenterRefinement-2080"><span class="linenos">2080</span></a><span class="sd">        px : float64</span>
</span><span id="CenterRefinement-2081"><a href="#CenterRefinement-2081"><span class="linenos">2081</span></a><span class="sd">            x-coordinate of the center</span>
</span><span id="CenterRefinement-2082"><a href="#CenterRefinement-2082"><span class="linenos">2082</span></a><span class="sd">        py : float64</span>
</span><span id="CenterRefinement-2083"><a href="#CenterRefinement-2083"><span class="linenos">2083</span></a><span class="sd">            y-coordinate of the center</span>
</span><span id="CenterRefinement-2084"><a href="#CenterRefinement-2084"><span class="linenos">2084</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterRefinement-2085"><a href="#CenterRefinement-2085"><span class="linenos">2085</span></a><span class="sd">            radius of the circular diffraction pattern</span>
</span><span id="CenterRefinement-2086"><a href="#CenterRefinement-2086"><span class="linenos">2086</span></a>
</span><span id="CenterRefinement-2087"><a href="#CenterRefinement-2087"><span class="linenos">2087</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement-2088"><a href="#CenterRefinement-2088"><span class="linenos">2088</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement-2089"><a href="#CenterRefinement-2089"><span class="linenos">2089</span></a><span class="sd">        x : float64</span>
</span><span id="CenterRefinement-2090"><a href="#CenterRefinement-2090"><span class="linenos">2090</span></a><span class="sd">            new x-coordinate of the center</span>
</span><span id="CenterRefinement-2091"><a href="#CenterRefinement-2091"><span class="linenos">2091</span></a><span class="sd">        y : float64</span>
</span><span id="CenterRefinement-2092"><a href="#CenterRefinement-2092"><span class="linenos">2092</span></a><span class="sd">            new y-coordinate of the center</span>
</span><span id="CenterRefinement-2093"><a href="#CenterRefinement-2093"><span class="linenos">2093</span></a><span class="sd">        r : float64</span>
</span><span id="CenterRefinement-2094"><a href="#CenterRefinement-2094"><span class="linenos">2094</span></a><span class="sd">            new radius of the circular diffraction pattern</span>
</span><span id="CenterRefinement-2095"><a href="#CenterRefinement-2095"><span class="linenos">2095</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterRefinement-2096"><a href="#CenterRefinement-2096"><span class="linenos">2096</span></a>        
</span><span id="CenterRefinement-2097"><a href="#CenterRefinement-2097"><span class="linenos">2097</span></a>        <span class="c1"># Load original image</span>
</span><span id="CenterRefinement-2098"><a href="#CenterRefinement-2098"><span class="linenos">2098</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterRefinement-2099"><a href="#CenterRefinement-2099"><span class="linenos">2099</span></a>
</span><span id="CenterRefinement-2100"><a href="#CenterRefinement-2100"><span class="linenos">2100</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterRefinement-2101"><a href="#CenterRefinement-2101"><span class="linenos">2101</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterRefinement-2102"><a href="#CenterRefinement-2102"><span class="linenos">2102</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterRefinement-2103"><a href="#CenterRefinement-2103"><span class="linenos">2103</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-2104"><a href="#CenterRefinement-2104"><span class="linenos">2104</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement-2105"><a href="#CenterRefinement-2105"><span class="linenos">2105</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement-2106"><a href="#CenterRefinement-2106"><span class="linenos">2106</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterRefinement-2107"><a href="#CenterRefinement-2107"><span class="linenos">2107</span></a>            
</span><span id="CenterRefinement-2108"><a href="#CenterRefinement-2108"><span class="linenos">2108</span></a>        
</span><span id="CenterRefinement-2109"><a href="#CenterRefinement-2109"><span class="linenos">2109</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="CenterRefinement-2110"><a href="#CenterRefinement-2110"><span class="linenos">2110</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement-2111"><a href="#CenterRefinement-2111"><span class="linenos">2111</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-2112"><a href="#CenterRefinement-2112"><span class="linenos">2112</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterRefinement-2113"><a href="#CenterRefinement-2113"><span class="linenos">2113</span></a>
</span><span id="CenterRefinement-2114"><a href="#CenterRefinement-2114"><span class="linenos">2114</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterRefinement-2115"><a href="#CenterRefinement-2115"><span class="linenos">2115</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterRefinement-2116"><a href="#CenterRefinement-2116"><span class="linenos">2116</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement-2117"><a href="#CenterRefinement-2117"><span class="linenos">2117</span></a><span class="s2">            </span>
</span><span id="CenterRefinement-2118"><a href="#CenterRefinement-2118"><span class="linenos">2118</span></a><span class="s2">            Interactive refinement. Use these keys:</span>
</span><span id="CenterRefinement-2119"><a href="#CenterRefinement-2119"><span class="linenos">2119</span></a><span class="s2">                  - &#39;&#39; : move left</span>
</span><span id="CenterRefinement-2120"><a href="#CenterRefinement-2120"><span class="linenos">2120</span></a><span class="s2">                  - &#39;&#39; : move right</span>
</span><span id="CenterRefinement-2121"><a href="#CenterRefinement-2121"><span class="linenos">2121</span></a><span class="s2">                  - &#39;&#39; : move up</span>
</span><span id="CenterRefinement-2122"><a href="#CenterRefinement-2122"><span class="linenos">2122</span></a><span class="s2">                  - &#39;&#39; : move down</span>
</span><span id="CenterRefinement-2123"><a href="#CenterRefinement-2123"><span class="linenos">2123</span></a><span class="s2">                  - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterRefinement-2124"><a href="#CenterRefinement-2124"><span class="linenos">2124</span></a><span class="s2">                  - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterRefinement-2125"><a href="#CenterRefinement-2125"><span class="linenos">2125</span></a><span class="s2">                  - &#39;b&#39; : increase step size</span>
</span><span id="CenterRefinement-2126"><a href="#CenterRefinement-2126"><span class="linenos">2126</span></a><span class="s2">                  - &#39;l&#39; : decrease step size</span>
</span><span id="CenterRefinement-2127"><a href="#CenterRefinement-2127"><span class="linenos">2127</span></a><span class="s2">                  - &#39;d&#39; : refinement done</span>
</span><span id="CenterRefinement-2128"><a href="#CenterRefinement-2128"><span class="linenos">2128</span></a><span class="s2">                  </span>
</span><span id="CenterRefinement-2129"><a href="#CenterRefinement-2129"><span class="linenos">2129</span></a><span class="s2">            DISCLAIMER: For the purpose of the center shift, the default</span>
</span><span id="CenterRefinement-2130"><a href="#CenterRefinement-2130"><span class="linenos">2130</span></a><span class="s2">            shortcuts for left and right arrows were removed.</span>
</span><span id="CenterRefinement-2131"><a href="#CenterRefinement-2131"><span class="linenos">2131</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-2132"><a href="#CenterRefinement-2132"><span class="linenos">2132</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterRefinement-2133"><a href="#CenterRefinement-2133"><span class="linenos">2133</span></a>        
</span><span id="CenterRefinement-2134"><a href="#CenterRefinement-2134"><span class="linenos">2134</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement-2135"><a href="#CenterRefinement-2135"><span class="linenos">2135</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-2136"><a href="#CenterRefinement-2136"><span class="linenos">2136</span></a>            
</span><span id="CenterRefinement-2137"><a href="#CenterRefinement-2137"><span class="linenos">2137</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterRefinement-2138"><a href="#CenterRefinement-2138"><span class="linenos">2138</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="CenterRefinement-2139"><a href="#CenterRefinement-2139"><span class="linenos">2139</span></a>        
</span><span id="CenterRefinement-2140"><a href="#CenterRefinement-2140"><span class="linenos">2140</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterRefinement-2141"><a href="#CenterRefinement-2141"><span class="linenos">2141</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-2142"><a href="#CenterRefinement-2142"><span class="linenos">2142</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-2143"><a href="#CenterRefinement-2143"><span class="linenos">2143</span></a>        
</span><span id="CenterRefinement-2144"><a href="#CenterRefinement-2144"><span class="linenos">2144</span></a>        <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterRefinement-2145"><a href="#CenterRefinement-2145"><span class="linenos">2145</span></a>            <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">pr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement-2146"><a href="#CenterRefinement-2146"><span class="linenos">2146</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterRefinement-2147"><a href="#CenterRefinement-2147"><span class="linenos">2147</span></a>
</span><span id="CenterRefinement-2148"><a href="#CenterRefinement-2148"><span class="linenos">2148</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterRefinement-2149"><a href="#CenterRefinement-2149"><span class="linenos">2149</span></a>        <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterRefinement-2150"><a href="#CenterRefinement-2150"><span class="linenos">2150</span></a>                    
</span><span id="CenterRefinement-2151"><a href="#CenterRefinement-2151"><span class="linenos">2151</span></a>
</span><span id="CenterRefinement-2152"><a href="#CenterRefinement-2152"><span class="linenos">2152</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the center position.&#39;</span><span class="p">,</span> 
</span><span id="CenterRefinement-2153"><a href="#CenterRefinement-2153"><span class="linenos">2153</span></a>                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement-2154"><a href="#CenterRefinement-2154"><span class="linenos">2154</span></a>
</span><span id="CenterRefinement-2155"><a href="#CenterRefinement-2155"><span class="linenos">2155</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-2156"><a href="#CenterRefinement-2156"><span class="linenos">2156</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-2157"><a href="#CenterRefinement-2157"><span class="linenos">2157</span></a>        
</span><span id="CenterRefinement-2158"><a href="#CenterRefinement-2158"><span class="linenos">2158</span></a>        <span class="c1"># Enable interactive mode</span>
</span><span id="CenterRefinement-2159"><a href="#CenterRefinement-2159"><span class="linenos">2159</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterRefinement-2160"><a href="#CenterRefinement-2160"><span class="linenos">2160</span></a>        
</span><span id="CenterRefinement-2161"><a href="#CenterRefinement-2161"><span class="linenos">2161</span></a>
</span><span id="CenterRefinement-2162"><a href="#CenterRefinement-2162"><span class="linenos">2162</span></a>        <span class="c1"># Display the image</span>
</span><span id="CenterRefinement-2163"><a href="#CenterRefinement-2163"><span class="linenos">2163</span></a>        <span class="c1"># fig.set_size_inches(self.fig_width, self.fig_height)</span>
</span><span id="CenterRefinement-2164"><a href="#CenterRefinement-2164"><span class="linenos">2164</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement-2165"><a href="#CenterRefinement-2165"><span class="linenos">2165</span></a>        
</span><span id="CenterRefinement-2166"><a href="#CenterRefinement-2166"><span class="linenos">2166</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterRefinement-2167"><a href="#CenterRefinement-2167"><span class="linenos">2167</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement-2168"><a href="#CenterRefinement-2168"><span class="linenos">2168</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement-2169"><a href="#CenterRefinement-2169"><span class="linenos">2169</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement-2170"><a href="#CenterRefinement-2170"><span class="linenos">2170</span></a> 
</span><span id="CenterRefinement-2171"><a href="#CenterRefinement-2171"><span class="linenos">2171</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterRefinement-2172"><a href="#CenterRefinement-2172"><span class="linenos">2172</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterRefinement-2173"><a href="#CenterRefinement-2173"><span class="linenos">2173</span></a>
</span><span id="CenterRefinement-2174"><a href="#CenterRefinement-2174"><span class="linenos">2174</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="CenterRefinement-2175"><a href="#CenterRefinement-2175"><span class="linenos">2175</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement-2176"><a href="#CenterRefinement-2176"><span class="linenos">2176</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterRefinement-2177"><a href="#CenterRefinement-2177"><span class="linenos">2177</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement-2178"><a href="#CenterRefinement-2178"><span class="linenos">2178</span></a>        
</span><span id="CenterRefinement-2179"><a href="#CenterRefinement-2179"><span class="linenos">2179</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterRefinement-2180"><a href="#CenterRefinement-2180"><span class="linenos">2180</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterRefinement-2181"><a href="#CenterRefinement-2181"><span class="linenos">2181</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterRefinement-2182"><a href="#CenterRefinement-2182"><span class="linenos">2182</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterRefinement-2183"><a href="#CenterRefinement-2183"><span class="linenos">2183</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterRefinement-2184"><a href="#CenterRefinement-2184"><span class="linenos">2184</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterRefinement-2185"><a href="#CenterRefinement-2185"><span class="linenos">2185</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterRefinement-2186"><a href="#CenterRefinement-2186"><span class="linenos">2186</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterRefinement-2187"><a href="#CenterRefinement-2187"><span class="linenos">2187</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterRefinement-2188"><a href="#CenterRefinement-2188"><span class="linenos">2188</span></a>        
</span><span id="CenterRefinement-2189"><a href="#CenterRefinement-2189"><span class="linenos">2189</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterRefinement-2190"><a href="#CenterRefinement-2190"><span class="linenos">2190</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterRefinement-2191"><a href="#CenterRefinement-2191"><span class="linenos">2191</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterRefinement-2192"><a href="#CenterRefinement-2192"><span class="linenos">2192</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement-2193"><a href="#CenterRefinement-2193"><span class="linenos">2193</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterRefinement-2194"><a href="#CenterRefinement-2194"><span class="linenos">2194</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2195"><a href="#CenterRefinement-2195"><span class="linenos">2195</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-2196"><a href="#CenterRefinement-2196"><span class="linenos">2196</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2197"><a href="#CenterRefinement-2197"><span class="linenos">2197</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-2198"><a href="#CenterRefinement-2198"><span class="linenos">2198</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2199"><a href="#CenterRefinement-2199"><span class="linenos">2199</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-2200"><a href="#CenterRefinement-2200"><span class="linenos">2200</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2201"><a href="#CenterRefinement-2201"><span class="linenos">2201</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement-2202"><a href="#CenterRefinement-2202"><span class="linenos">2202</span></a>                    
</span><span id="CenterRefinement-2203"><a href="#CenterRefinement-2203"><span class="linenos">2203</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterRefinement-2204"><a href="#CenterRefinement-2204"><span class="linenos">2204</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement-2205"><a href="#CenterRefinement-2205"><span class="linenos">2205</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterRefinement-2206"><a href="#CenterRefinement-2206"><span class="linenos">2206</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement-2207"><a href="#CenterRefinement-2207"><span class="linenos">2207</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement-2208"><a href="#CenterRefinement-2208"><span class="linenos">2208</span></a>            
</span><span id="CenterRefinement-2209"><a href="#CenterRefinement-2209"><span class="linenos">2209</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterRefinement-2210"><a href="#CenterRefinement-2210"><span class="linenos">2210</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2211"><a href="#CenterRefinement-2211"><span class="linenos">2211</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement-2212"><a href="#CenterRefinement-2212"><span class="linenos">2212</span></a>        
</span><span id="CenterRefinement-2213"><a href="#CenterRefinement-2213"><span class="linenos">2213</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterRefinement-2214"><a href="#CenterRefinement-2214"><span class="linenos">2214</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2215"><a href="#CenterRefinement-2215"><span class="linenos">2215</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterRefinement-2216"><a href="#CenterRefinement-2216"><span class="linenos">2216</span></a>        
</span><span id="CenterRefinement-2217"><a href="#CenterRefinement-2217"><span class="linenos">2217</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement-2218"><a href="#CenterRefinement-2218"><span class="linenos">2218</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterRefinement-2219"><a href="#CenterRefinement-2219"><span class="linenos">2219</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterRefinement-2220"><a href="#CenterRefinement-2220"><span class="linenos">2220</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterRefinement-2221"><a href="#CenterRefinement-2221"><span class="linenos">2221</span></a>        
</span><span id="CenterRefinement-2222"><a href="#CenterRefinement-2222"><span class="linenos">2222</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterRefinement-2223"><a href="#CenterRefinement-2223"><span class="linenos">2223</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterRefinement-2224"><a href="#CenterRefinement-2224"><span class="linenos">2224</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterRefinement-2225"><a href="#CenterRefinement-2225"><span class="linenos">2225</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterRefinement-2226"><a href="#CenterRefinement-2226"><span class="linenos">2226</span></a>        
</span><span id="CenterRefinement-2227"><a href="#CenterRefinement-2227"><span class="linenos">2227</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement-2228"><a href="#CenterRefinement-2228"><span class="linenos">2228</span></a>        
</span><span id="CenterRefinement-2229"><a href="#CenterRefinement-2229"><span class="linenos">2229</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterRefinement-2230"><a href="#CenterRefinement-2230"><span class="linenos">2230</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterRefinement-2231"><a href="#CenterRefinement-2231"><span class="linenos">2231</span></a>
</span><span id="CenterRefinement-2232"><a href="#CenterRefinement-2232"><span class="linenos">2232</span></a>            
</span><span id="CenterRefinement-2233"><a href="#CenterRefinement-2233"><span class="linenos">2233</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterRefinement-2234"><a href="#CenterRefinement-2234"><span class="linenos">2234</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterRefinement-2235"><a href="#CenterRefinement-2235"><span class="linenos">2235</span></a>        
</span><span id="CenterRefinement-2236"><a href="#CenterRefinement-2236"><span class="linenos">2236</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterRefinement-2237"><a href="#CenterRefinement-2237"><span class="linenos">2237</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterRefinement-2238"><a href="#CenterRefinement-2238"><span class="linenos">2238</span></a>
</span><span id="CenterRefinement-2239"><a href="#CenterRefinement-2239"><span class="linenos">2239</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterRefinement-2240"><a href="#CenterRefinement-2240"><span class="linenos">2240</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterRefinement-2241"><a href="#CenterRefinement-2241"><span class="linenos">2241</span></a>               
</span><span id="CenterRefinement-2242"><a href="#CenterRefinement-2242"><span class="linenos">2242</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterRefinement-2243"><a href="#CenterRefinement-2243"><span class="linenos">2243</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterRefinement-2244"><a href="#CenterRefinement-2244"><span class="linenos">2244</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterRefinement-2245"><a href="#CenterRefinement-2245"><span class="linenos">2245</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterRefinement-2246"><a href="#CenterRefinement-2246"><span class="linenos">2246</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterRefinement-2247"><a href="#CenterRefinement-2247"><span class="linenos">2247</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterRefinement-2248"><a href="#CenterRefinement-2248"><span class="linenos">2248</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement-2249"><a href="#CenterRefinement-2249"><span class="linenos">2249</span></a>         
</span><span id="CenterRefinement-2250"><a href="#CenterRefinement-2250"><span class="linenos">2250</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterRefinement-2251"><a href="#CenterRefinement-2251"><span class="linenos">2251</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterRefinement-2252"><a href="#CenterRefinement-2252"><span class="linenos">2252</span></a>        
</span><span id="CenterRefinement-2253"><a href="#CenterRefinement-2253"><span class="linenos">2253</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterRefinement-2254"><a href="#CenterRefinement-2254"><span class="linenos">2254</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterRefinement-2255"><a href="#CenterRefinement-2255"><span class="linenos">2255</span></a>
</span><span id="CenterRefinement-2256"><a href="#CenterRefinement-2256"><span class="linenos">2256</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement-2257"><a href="#CenterRefinement-2257"><span class="linenos">2257</span></a>        
</span><span id="CenterRefinement-2258"><a href="#CenterRefinement-2258"><span class="linenos">2258</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterRefinement-2259"><a href="#CenterRefinement-2259"><span class="linenos">2259</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterRefinement-2260"><a href="#CenterRefinement-2260"><span class="linenos">2260</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterRefinement-2261"><a href="#CenterRefinement-2261"><span class="linenos">2261</span></a>
</span><span id="CenterRefinement-2262"><a href="#CenterRefinement-2262"><span class="linenos">2262</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterRefinement-2263"><a href="#CenterRefinement-2263"><span class="linenos">2263</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-2264"><a href="#CenterRefinement-2264"><span class="linenos">2264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-2265"><a href="#CenterRefinement-2265"><span class="linenos">2265</span></a>
</span><span id="CenterRefinement-2266"><a href="#CenterRefinement-2266"><span class="linenos">2266</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>    
</span><span id="CenterRefinement-2267"><a href="#CenterRefinement-2267"><span class="linenos">2267</span></a>        
</span><span id="CenterRefinement-2268"><a href="#CenterRefinement-2268"><span class="linenos">2268</span></a>    
</span><span id="CenterRefinement-2269"><a href="#CenterRefinement-2269"><span class="linenos">2269</span></a>    <span class="k">def</span> <span class="nf">ref_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterRefinement-2270"><a href="#CenterRefinement-2270"><span class="linenos">2270</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterRefinement-2271"><a href="#CenterRefinement-2271"><span class="linenos">2271</span></a><span class="sd">        Adjust center coordinates of a detected circular diffraction pattern.</span>
</span><span id="CenterRefinement-2272"><a href="#CenterRefinement-2272"><span class="linenos">2272</span></a><span class="sd">        The center adjustment is based on variance minimization.</span>
</span><span id="CenterRefinement-2273"><a href="#CenterRefinement-2273"><span class="linenos">2273</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-2274"><a href="#CenterRefinement-2274"><span class="linenos">2274</span></a><span class="sd">        The 8-neighbourhood pixels (x) of the current center (o) </span>
</span><span id="CenterRefinement-2275"><a href="#CenterRefinement-2275"><span class="linenos">2275</span></a><span class="sd">        will be tested regarding the minimization:</span>
</span><span id="CenterRefinement-2276"><a href="#CenterRefinement-2276"><span class="linenos">2276</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2277"><a href="#CenterRefinement-2277"><span class="linenos">2277</span></a><span class="sd">        - x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</span>
</span><span id="CenterRefinement-2278"><a href="#CenterRefinement-2278"><span class="linenos">2278</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2279"><a href="#CenterRefinement-2279"><span class="linenos">2279</span></a><span class="sd">        - x o x : (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement-2280"><a href="#CenterRefinement-2280"><span class="linenos">2280</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2281"><a href="#CenterRefinement-2281"><span class="linenos">2281</span></a><span class="sd">        - x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement-2282"><a href="#CenterRefinement-2282"><span class="linenos">2282</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-2283"><a href="#CenterRefinement-2283"><span class="linenos">2283</span></a>
</span><span id="CenterRefinement-2284"><a href="#CenterRefinement-2284"><span class="linenos">2284</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement-2285"><a href="#CenterRefinement-2285"><span class="linenos">2285</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement-2286"><a href="#CenterRefinement-2286"><span class="linenos">2286</span></a><span class="sd">        self.image : array of uint8</span>
</span><span id="CenterRefinement-2287"><a href="#CenterRefinement-2287"><span class="linenos">2287</span></a><span class="sd">            Input image in which the diffraction pattern is to be found</span>
</span><span id="CenterRefinement-2288"><a href="#CenterRefinement-2288"><span class="linenos">2288</span></a><span class="sd">        px : float64</span>
</span><span id="CenterRefinement-2289"><a href="#CenterRefinement-2289"><span class="linenos">2289</span></a><span class="sd">            x-coordinate of the detected center to be adjusted</span>
</span><span id="CenterRefinement-2290"><a href="#CenterRefinement-2290"><span class="linenos">2290</span></a><span class="sd">        py : float64</span>
</span><span id="CenterRefinement-2291"><a href="#CenterRefinement-2291"><span class="linenos">2291</span></a><span class="sd">            y-coordinate of the detected center to be adjusted</span>
</span><span id="CenterRefinement-2292"><a href="#CenterRefinement-2292"><span class="linenos">2292</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterRefinement-2293"><a href="#CenterRefinement-2293"><span class="linenos">2293</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterRefinement-2294"><a href="#CenterRefinement-2294"><span class="linenos">2294</span></a><span class="sd">        plot_results : integer (default = 1)</span>
</span><span id="CenterRefinement-2295"><a href="#CenterRefinement-2295"><span class="linenos">2295</span></a><span class="sd">            Plot Detected center. The default is 1.</span>
</span><span id="CenterRefinement-2296"><a href="#CenterRefinement-2296"><span class="linenos">2296</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-2297"><a href="#CenterRefinement-2297"><span class="linenos">2297</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement-2298"><a href="#CenterRefinement-2298"><span class="linenos">2298</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement-2299"><a href="#CenterRefinement-2299"><span class="linenos">2299</span></a><span class="sd">        px : array of int32</span>
</span><span id="CenterRefinement-2300"><a href="#CenterRefinement-2300"><span class="linenos">2300</span></a><span class="sd">           corrected x-coordinates of pixels from circle border</span>
</span><span id="CenterRefinement-2301"><a href="#CenterRefinement-2301"><span class="linenos">2301</span></a><span class="sd">        py : array of int32</span>
</span><span id="CenterRefinement-2302"><a href="#CenterRefinement-2302"><span class="linenos">2302</span></a><span class="sd">            corrected y-coordinates of pixels from circle border</span>
</span><span id="CenterRefinement-2303"><a href="#CenterRefinement-2303"><span class="linenos">2303</span></a><span class="sd">        pr : array of int32</span>
</span><span id="CenterRefinement-2304"><a href="#CenterRefinement-2304"><span class="linenos">2304</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterRefinement-2305"><a href="#CenterRefinement-2305"><span class="linenos">2305</span></a><span class="sd">            </span>
</span><span id="CenterRefinement-2306"><a href="#CenterRefinement-2306"><span class="linenos">2306</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterRefinement-2307"><a href="#CenterRefinement-2307"><span class="linenos">2307</span></a>        
</span><span id="CenterRefinement-2308"><a href="#CenterRefinement-2308"><span class="linenos">2308</span></a>        <span class="c1"># Store input for plot</span>
</span><span id="CenterRefinement-2309"><a href="#CenterRefinement-2309"><span class="linenos">2309</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement-2310"><a href="#CenterRefinement-2310"><span class="linenos">2310</span></a>        
</span><span id="CenterRefinement-2311"><a href="#CenterRefinement-2311"><span class="linenos">2311</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterRefinement-2312"><a href="#CenterRefinement-2312"><span class="linenos">2312</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement-2313"><a href="#CenterRefinement-2313"><span class="linenos">2313</span></a>
</span><span id="CenterRefinement-2314"><a href="#CenterRefinement-2314"><span class="linenos">2314</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement-2315"><a href="#CenterRefinement-2315"><span class="linenos">2315</span></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-2316"><a href="#CenterRefinement-2316"><span class="linenos">2316</span></a>        <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-2317"><a href="#CenterRefinement-2317"><span class="linenos">2317</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement-2318"><a href="#CenterRefinement-2318"><span class="linenos">2318</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-2319"><a href="#CenterRefinement-2319"><span class="linenos">2319</span></a>    
</span><span id="CenterRefinement-2320"><a href="#CenterRefinement-2320"><span class="linenos">2320</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement-2321"><a href="#CenterRefinement-2321"><span class="linenos">2321</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement-2322"><a href="#CenterRefinement-2322"><span class="linenos">2322</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement-2323"><a href="#CenterRefinement-2323"><span class="linenos">2323</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">min_intensity_var</span>
</span><span id="CenterRefinement-2324"><a href="#CenterRefinement-2324"><span class="linenos">2324</span></a>        
</span><span id="CenterRefinement-2325"><a href="#CenterRefinement-2325"><span class="linenos">2325</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement-2326"><a href="#CenterRefinement-2326"><span class="linenos">2326</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="CenterRefinement-2327"><a href="#CenterRefinement-2327"><span class="linenos">2327</span></a>        
</span><span id="CenterRefinement-2328"><a href="#CenterRefinement-2328"><span class="linenos">2328</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement-2329"><a href="#CenterRefinement-2329"><span class="linenos">2329</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement-2330"><a href="#CenterRefinement-2330"><span class="linenos">2330</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement-2331"><a href="#CenterRefinement-2331"><span class="linenos">2331</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement-2332"><a href="#CenterRefinement-2332"><span class="linenos">2332</span></a>    
</span><span id="CenterRefinement-2333"><a href="#CenterRefinement-2333"><span class="linenos">2333</span></a>    
</span><span id="CenterRefinement-2334"><a href="#CenterRefinement-2334"><span class="linenos">2334</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement-2335"><a href="#CenterRefinement-2335"><span class="linenos">2335</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement-2336"><a href="#CenterRefinement-2336"><span class="linenos">2336</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="CenterRefinement-2337"><a href="#CenterRefinement-2337"><span class="linenos">2337</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement-2338"><a href="#CenterRefinement-2338"><span class="linenos">2338</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-2339"><a href="#CenterRefinement-2339"><span class="linenos">2339</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement-2340"><a href="#CenterRefinement-2340"><span class="linenos">2340</span></a>        
</span><span id="CenterRefinement-2341"><a href="#CenterRefinement-2341"><span class="linenos">2341</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement-2342"><a href="#CenterRefinement-2342"><span class="linenos">2342</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement-2343"><a href="#CenterRefinement-2343"><span class="linenos">2343</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2344"><a href="#CenterRefinement-2344"><span class="linenos">2344</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-2345"><a href="#CenterRefinement-2345"><span class="linenos">2345</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-2346"><a href="#CenterRefinement-2346"><span class="linenos">2346</span></a>                                      <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement-2347"><a href="#CenterRefinement-2347"><span class="linenos">2347</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement-2348"><a href="#CenterRefinement-2348"><span class="linenos">2348</span></a>            <span class="n">curr_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-2349"><a href="#CenterRefinement-2349"><span class="linenos">2349</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement-2350"><a href="#CenterRefinement-2350"><span class="linenos">2350</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement-2351"><a href="#CenterRefinement-2351"><span class="linenos">2351</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement-2352"><a href="#CenterRefinement-2352"><span class="linenos">2352</span></a>                <span class="n">curr_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="CenterRefinement-2353"><a href="#CenterRefinement-2353"><span class="linenos">2353</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-2354"><a href="#CenterRefinement-2354"><span class="linenos">2354</span></a>            
</span><span id="CenterRefinement-2355"><a href="#CenterRefinement-2355"><span class="linenos">2355</span></a>            <span class="c1"># Find the minimum value coordinates within curr_intensity_var</span>
</span><span id="CenterRefinement-2356"><a href="#CenterRefinement-2356"><span class="linenos">2356</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement-2357"><a href="#CenterRefinement-2357"><span class="linenos">2357</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-2358"><a href="#CenterRefinement-2358"><span class="linenos">2358</span></a>                    
</span><span id="CenterRefinement-2359"><a href="#CenterRefinement-2359"><span class="linenos">2359</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="CenterRefinement-2360"><a href="#CenterRefinement-2360"><span class="linenos">2360</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="CenterRefinement-2361"><a href="#CenterRefinement-2361"><span class="linenos">2361</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement-2362"><a href="#CenterRefinement-2362"><span class="linenos">2362</span></a>            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_intensity_var</span><span class="p">:</span>                           
</span><span id="CenterRefinement-2363"><a href="#CenterRefinement-2363"><span class="linenos">2363</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement-2364"><a href="#CenterRefinement-2364"><span class="linenos">2364</span></a>                
</span><span id="CenterRefinement-2365"><a href="#CenterRefinement-2365"><span class="linenos">2365</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement-2366"><a href="#CenterRefinement-2366"><span class="linenos">2366</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement-2367"><a href="#CenterRefinement-2367"><span class="linenos">2367</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement-2368"><a href="#CenterRefinement-2368"><span class="linenos">2368</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement-2369"><a href="#CenterRefinement-2369"><span class="linenos">2369</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement-2370"><a href="#CenterRefinement-2370"><span class="linenos">2370</span></a>                
</span><span id="CenterRefinement-2371"><a href="#CenterRefinement-2371"><span class="linenos">2371</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement-2372"><a href="#CenterRefinement-2372"><span class="linenos">2372</span></a>            <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_var</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2373"><a href="#CenterRefinement-2373"><span class="linenos">2373</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-2374"><a href="#CenterRefinement-2374"><span class="linenos">2374</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-2375"><a href="#CenterRefinement-2375"><span class="linenos">2375</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement-2376"><a href="#CenterRefinement-2376"><span class="linenos">2376</span></a>            
</span><span id="CenterRefinement-2377"><a href="#CenterRefinement-2377"><span class="linenos">2377</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement-2378"><a href="#CenterRefinement-2378"><span class="linenos">2378</span></a>            <span class="c1"># constant. It iterates through different radius adjustments to find</span>
</span><span id="CenterRefinement-2379"><a href="#CenterRefinement-2379"><span class="linenos">2379</span></a>            <span class="c1"># a radius that maximizes the intensity sum of pixels</span>
</span><span id="CenterRefinement-2380"><a href="#CenterRefinement-2380"><span class="linenos">2380</span></a>            
</span><span id="CenterRefinement-2381"><a href="#CenterRefinement-2381"><span class="linenos">2381</span></a>            <span class="n">radi_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-2382"><a href="#CenterRefinement-2382"><span class="linenos">2382</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-2383"><a href="#CenterRefinement-2383"><span class="linenos">2383</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement-2384"><a href="#CenterRefinement-2384"><span class="linenos">2384</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement-2385"><a href="#CenterRefinement-2385"><span class="linenos">2385</span></a>                <span class="n">radi_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_var</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2386"><a href="#CenterRefinement-2386"><span class="linenos">2386</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-2387"><a href="#CenterRefinement-2387"><span class="linenos">2387</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-2388"><a href="#CenterRefinement-2388"><span class="linenos">2388</span></a>                                                             <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-2389"><a href="#CenterRefinement-2389"><span class="linenos">2389</span></a>                
</span><span id="CenterRefinement-2390"><a href="#CenterRefinement-2390"><span class="linenos">2390</span></a>            <span class="c1"># Find the minimum value coordinates within curr_var</span>
</span><span id="CenterRefinement-2391"><a href="#CenterRefinement-2391"><span class="linenos">2391</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement-2392"><a href="#CenterRefinement-2392"><span class="linenos">2392</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-2393"><a href="#CenterRefinement-2393"><span class="linenos">2393</span></a>            
</span><span id="CenterRefinement-2394"><a href="#CenterRefinement-2394"><span class="linenos">2394</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement-2395"><a href="#CenterRefinement-2395"><span class="linenos">2395</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_intensity_var</span><span class="p">:</span>
</span><span id="CenterRefinement-2396"><a href="#CenterRefinement-2396"><span class="linenos">2396</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement-2397"><a href="#CenterRefinement-2397"><span class="linenos">2397</span></a>                
</span><span id="CenterRefinement-2398"><a href="#CenterRefinement-2398"><span class="linenos">2398</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement-2399"><a href="#CenterRefinement-2399"><span class="linenos">2399</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement-2400"><a href="#CenterRefinement-2400"><span class="linenos">2400</span></a>                
</span><span id="CenterRefinement-2401"><a href="#CenterRefinement-2401"><span class="linenos">2401</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement-2402"><a href="#CenterRefinement-2402"><span class="linenos">2402</span></a>
</span><span id="CenterRefinement-2403"><a href="#CenterRefinement-2403"><span class="linenos">2403</span></a>            
</span><span id="CenterRefinement-2404"><a href="#CenterRefinement-2404"><span class="linenos">2404</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement-2405"><a href="#CenterRefinement-2405"><span class="linenos">2405</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_intensity_var</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement-2406"><a href="#CenterRefinement-2406"><span class="linenos">2406</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement-2407"><a href="#CenterRefinement-2407"><span class="linenos">2407</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement-2408"><a href="#CenterRefinement-2408"><span class="linenos">2408</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="CenterRefinement-2409"><a href="#CenterRefinement-2409"><span class="linenos">2409</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement-2410"><a href="#CenterRefinement-2410"><span class="linenos">2410</span></a>        
</span><span id="CenterRefinement-2411"><a href="#CenterRefinement-2411"><span class="linenos">2411</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement-2412"><a href="#CenterRefinement-2412"><span class="linenos">2412</span></a>        <span class="c1">## (1) swapped coordinates</span>
</span><span id="CenterRefinement-2413"><a href="#CenterRefinement-2413"><span class="linenos">2413</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-2414"><a href="#CenterRefinement-2414"><span class="linenos">2414</span></a>            <span class="ow">or</span>  <span class="p">(</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="CenterRefinement-2415"><a href="#CenterRefinement-2415"><span class="linenos">2415</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterRefinement-2416"><a href="#CenterRefinement-2416"><span class="linenos">2416</span></a>        
</span><span id="CenterRefinement-2417"><a href="#CenterRefinement-2417"><span class="linenos">2417</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement-2418"><a href="#CenterRefinement-2418"><span class="linenos">2418</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_intensity_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement-2419"><a href="#CenterRefinement-2419"><span class="linenos">2419</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-2420"><a href="#CenterRefinement-2420"><span class="linenos">2420</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement-2421"><a href="#CenterRefinement-2421"><span class="linenos">2421</span></a>    
</span><span id="CenterRefinement-2422"><a href="#CenterRefinement-2422"><span class="linenos">2422</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement-2423"><a href="#CenterRefinement-2423"><span class="linenos">2423</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-2424"><a href="#CenterRefinement-2424"><span class="linenos">2424</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (IntensityVar)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-2425"><a href="#CenterRefinement-2425"><span class="linenos">2425</span></a>                                  
</span><span id="CenterRefinement-2426"><a href="#CenterRefinement-2426"><span class="linenos">2426</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span><span id="CenterRefinement-2427"><a href="#CenterRefinement-2427"><span class="linenos">2427</span></a>    
</span><span id="CenterRefinement-2428"><a href="#CenterRefinement-2428"><span class="linenos">2428</span></a>    
</span><span id="CenterRefinement-2429"><a href="#CenterRefinement-2429"><span class="linenos">2429</span></a>    <span class="k">def</span> <span class="nf">ref_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterRefinement-2430"><a href="#CenterRefinement-2430"><span class="linenos">2430</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterRefinement-2431"><a href="#CenterRefinement-2431"><span class="linenos">2431</span></a><span class="sd">        Adjust center position based on gradient optimization method</span>
</span><span id="CenterRefinement-2432"><a href="#CenterRefinement-2432"><span class="linenos">2432</span></a><span class="sd">        via maximization of intensity sum.</span>
</span><span id="CenterRefinement-2433"><a href="#CenterRefinement-2433"><span class="linenos">2433</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-2434"><a href="#CenterRefinement-2434"><span class="linenos">2434</span></a><span class="sd">        The 8-neighbourhood pixels (x) of the current center (o) </span>
</span><span id="CenterRefinement-2435"><a href="#CenterRefinement-2435"><span class="linenos">2435</span></a><span class="sd">        will be tested regarding the maximization:</span>
</span><span id="CenterRefinement-2436"><a href="#CenterRefinement-2436"><span class="linenos">2436</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2437"><a href="#CenterRefinement-2437"><span class="linenos">2437</span></a><span class="sd">        - x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</span>
</span><span id="CenterRefinement-2438"><a href="#CenterRefinement-2438"><span class="linenos">2438</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2439"><a href="#CenterRefinement-2439"><span class="linenos">2439</span></a><span class="sd">        - x o x : (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement-2440"><a href="#CenterRefinement-2440"><span class="linenos">2440</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2441"><a href="#CenterRefinement-2441"><span class="linenos">2441</span></a><span class="sd">        - x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement-2442"><a href="#CenterRefinement-2442"><span class="linenos">2442</span></a><span class="sd">        </span>
</span><span id="CenterRefinement-2443"><a href="#CenterRefinement-2443"><span class="linenos">2443</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2444"><a href="#CenterRefinement-2444"><span class="linenos">2444</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement-2445"><a href="#CenterRefinement-2445"><span class="linenos">2445</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement-2446"><a href="#CenterRefinement-2446"><span class="linenos">2446</span></a><span class="sd">        px : float64</span>
</span><span id="CenterRefinement-2447"><a href="#CenterRefinement-2447"><span class="linenos">2447</span></a><span class="sd">            x-coordinate of the detected center to be adjusted.</span>
</span><span id="CenterRefinement-2448"><a href="#CenterRefinement-2448"><span class="linenos">2448</span></a><span class="sd">        py : float64</span>
</span><span id="CenterRefinement-2449"><a href="#CenterRefinement-2449"><span class="linenos">2449</span></a><span class="sd">            y-coordinate of the detected center to be adjusted.</span>
</span><span id="CenterRefinement-2450"><a href="#CenterRefinement-2450"><span class="linenos">2450</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterRefinement-2451"><a href="#CenterRefinement-2451"><span class="linenos">2451</span></a><span class="sd">            radius of the detected center.</span>
</span><span id="CenterRefinement-2452"><a href="#CenterRefinement-2452"><span class="linenos">2452</span></a><span class="sd">        plot_results : int, optional</span>
</span><span id="CenterRefinement-2453"><a href="#CenterRefinement-2453"><span class="linenos">2453</span></a><span class="sd">            Plot Detected center. </span>
</span><span id="CenterRefinement-2454"><a href="#CenterRefinement-2454"><span class="linenos">2454</span></a><span class="sd">            The default is 1.</span>
</span><span id="CenterRefinement-2455"><a href="#CenterRefinement-2455"><span class="linenos">2455</span></a><span class="sd">    </span>
</span><span id="CenterRefinement-2456"><a href="#CenterRefinement-2456"><span class="linenos">2456</span></a><span class="sd">        Returns  </span>
</span><span id="CenterRefinement-2457"><a href="#CenterRefinement-2457"><span class="linenos">2457</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement-2458"><a href="#CenterRefinement-2458"><span class="linenos">2458</span></a><span class="sd">        best_center[0] : float64</span>
</span><span id="CenterRefinement-2459"><a href="#CenterRefinement-2459"><span class="linenos">2459</span></a><span class="sd">            Adjusted x-coordinate of the center.</span>
</span><span id="CenterRefinement-2460"><a href="#CenterRefinement-2460"><span class="linenos">2460</span></a><span class="sd">        best_center[1] : float64</span>
</span><span id="CenterRefinement-2461"><a href="#CenterRefinement-2461"><span class="linenos">2461</span></a><span class="sd">            Adjusted y-coordinate of the center.</span>
</span><span id="CenterRefinement-2462"><a href="#CenterRefinement-2462"><span class="linenos">2462</span></a><span class="sd">        best_radius : float64</span>
</span><span id="CenterRefinement-2463"><a href="#CenterRefinement-2463"><span class="linenos">2463</span></a><span class="sd">            The adjusted radius of the circular diffraction pattern.</span>
</span><span id="CenterRefinement-2464"><a href="#CenterRefinement-2464"><span class="linenos">2464</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterRefinement-2465"><a href="#CenterRefinement-2465"><span class="linenos">2465</span></a>        <span class="c1"># Store input for plot via self.visualize_refinement()</span>
</span><span id="CenterRefinement-2466"><a href="#CenterRefinement-2466"><span class="linenos">2466</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement-2467"><a href="#CenterRefinement-2467"><span class="linenos">2467</span></a>
</span><span id="CenterRefinement-2468"><a href="#CenterRefinement-2468"><span class="linenos">2468</span></a>        <span class="c1"># Image in which the center is refined</span>
</span><span id="CenterRefinement-2469"><a href="#CenterRefinement-2469"><span class="linenos">2469</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement-2470"><a href="#CenterRefinement-2470"><span class="linenos">2470</span></a>
</span><span id="CenterRefinement-2471"><a href="#CenterRefinement-2471"><span class="linenos">2471</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement-2472"><a href="#CenterRefinement-2472"><span class="linenos">2472</span></a>        <span class="n">init_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-2473"><a href="#CenterRefinement-2473"><span class="linenos">2473</span></a>        <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-2474"><a href="#CenterRefinement-2474"><span class="linenos">2474</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement-2475"><a href="#CenterRefinement-2475"><span class="linenos">2475</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement-2476"><a href="#CenterRefinement-2476"><span class="linenos">2476</span></a>        
</span><span id="CenterRefinement-2477"><a href="#CenterRefinement-2477"><span class="linenos">2477</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement-2478"><a href="#CenterRefinement-2478"><span class="linenos">2478</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement-2479"><a href="#CenterRefinement-2479"><span class="linenos">2479</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement-2480"><a href="#CenterRefinement-2480"><span class="linenos">2480</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">max_intensity_sum</span>
</span><span id="CenterRefinement-2481"><a href="#CenterRefinement-2481"><span class="linenos">2481</span></a>        
</span><span id="CenterRefinement-2482"><a href="#CenterRefinement-2482"><span class="linenos">2482</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement-2483"><a href="#CenterRefinement-2483"><span class="linenos">2483</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterRefinement-2484"><a href="#CenterRefinement-2484"><span class="linenos">2484</span></a>        
</span><span id="CenterRefinement-2485"><a href="#CenterRefinement-2485"><span class="linenos">2485</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement-2486"><a href="#CenterRefinement-2486"><span class="linenos">2486</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement-2487"><a href="#CenterRefinement-2487"><span class="linenos">2487</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement-2488"><a href="#CenterRefinement-2488"><span class="linenos">2488</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement-2489"><a href="#CenterRefinement-2489"><span class="linenos">2489</span></a>         
</span><span id="CenterRefinement-2490"><a href="#CenterRefinement-2490"><span class="linenos">2490</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement-2491"><a href="#CenterRefinement-2491"><span class="linenos">2491</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement-2492"><a href="#CenterRefinement-2492"><span class="linenos">2492</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="CenterRefinement-2493"><a href="#CenterRefinement-2493"><span class="linenos">2493</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement-2494"><a href="#CenterRefinement-2494"><span class="linenos">2494</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-2495"><a href="#CenterRefinement-2495"><span class="linenos">2495</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement-2496"><a href="#CenterRefinement-2496"><span class="linenos">2496</span></a>
</span><span id="CenterRefinement-2497"><a href="#CenterRefinement-2497"><span class="linenos">2497</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement-2498"><a href="#CenterRefinement-2498"><span class="linenos">2498</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement-2499"><a href="#CenterRefinement-2499"><span class="linenos">2499</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2500"><a href="#CenterRefinement-2500"><span class="linenos">2500</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-2501"><a href="#CenterRefinement-2501"><span class="linenos">2501</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-2502"><a href="#CenterRefinement-2502"><span class="linenos">2502</span></a>                                      <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement-2503"><a href="#CenterRefinement-2503"><span class="linenos">2503</span></a>            
</span><span id="CenterRefinement-2504"><a href="#CenterRefinement-2504"><span class="linenos">2504</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement-2505"><a href="#CenterRefinement-2505"><span class="linenos">2505</span></a>            <span class="n">curr_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-2506"><a href="#CenterRefinement-2506"><span class="linenos">2506</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement-2507"><a href="#CenterRefinement-2507"><span class="linenos">2507</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement-2508"><a href="#CenterRefinement-2508"><span class="linenos">2508</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement-2509"><a href="#CenterRefinement-2509"><span class="linenos">2509</span></a>                <span class="n">curr_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2510"><a href="#CenterRefinement-2510"><span class="linenos">2510</span></a>                                                        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> 
</span><span id="CenterRefinement-2511"><a href="#CenterRefinement-2511"><span class="linenos">2511</span></a>                                                        <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-2512"><a href="#CenterRefinement-2512"><span class="linenos">2512</span></a>            
</span><span id="CenterRefinement-2513"><a href="#CenterRefinement-2513"><span class="linenos">2513</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement-2514"><a href="#CenterRefinement-2514"><span class="linenos">2514</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement-2515"><a href="#CenterRefinement-2515"><span class="linenos">2515</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-2516"><a href="#CenterRefinement-2516"><span class="linenos">2516</span></a>                    
</span><span id="CenterRefinement-2517"><a href="#CenterRefinement-2517"><span class="linenos">2517</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="CenterRefinement-2518"><a href="#CenterRefinement-2518"><span class="linenos">2518</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="CenterRefinement-2519"><a href="#CenterRefinement-2519"><span class="linenos">2519</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement-2520"><a href="#CenterRefinement-2520"><span class="linenos">2520</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>                           
</span><span id="CenterRefinement-2521"><a href="#CenterRefinement-2521"><span class="linenos">2521</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement-2522"><a href="#CenterRefinement-2522"><span class="linenos">2522</span></a>                
</span><span id="CenterRefinement-2523"><a href="#CenterRefinement-2523"><span class="linenos">2523</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement-2524"><a href="#CenterRefinement-2524"><span class="linenos">2524</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement-2525"><a href="#CenterRefinement-2525"><span class="linenos">2525</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement-2526"><a href="#CenterRefinement-2526"><span class="linenos">2526</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement-2527"><a href="#CenterRefinement-2527"><span class="linenos">2527</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement-2528"><a href="#CenterRefinement-2528"><span class="linenos">2528</span></a>    
</span><span id="CenterRefinement-2529"><a href="#CenterRefinement-2529"><span class="linenos">2529</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement-2530"><a href="#CenterRefinement-2530"><span class="linenos">2530</span></a>            <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2531"><a href="#CenterRefinement-2531"><span class="linenos">2531</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-2532"><a href="#CenterRefinement-2532"><span class="linenos">2532</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-2533"><a href="#CenterRefinement-2533"><span class="linenos">2533</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement-2534"><a href="#CenterRefinement-2534"><span class="linenos">2534</span></a>
</span><span id="CenterRefinement-2535"><a href="#CenterRefinement-2535"><span class="linenos">2535</span></a>        
</span><span id="CenterRefinement-2536"><a href="#CenterRefinement-2536"><span class="linenos">2536</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement-2537"><a href="#CenterRefinement-2537"><span class="linenos">2537</span></a>            <span class="c1"># constant. It iterates through different radius adjustments to find</span>
</span><span id="CenterRefinement-2538"><a href="#CenterRefinement-2538"><span class="linenos">2538</span></a>            <span class="c1"># a radius that maximizes the intensity sum of pixels</span>
</span><span id="CenterRefinement-2539"><a href="#CenterRefinement-2539"><span class="linenos">2539</span></a>            
</span><span id="CenterRefinement-2540"><a href="#CenterRefinement-2540"><span class="linenos">2540</span></a>            <span class="n">radi_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement-2541"><a href="#CenterRefinement-2541"><span class="linenos">2541</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement-2542"><a href="#CenterRefinement-2542"><span class="linenos">2542</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement-2543"><a href="#CenterRefinement-2543"><span class="linenos">2543</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement-2544"><a href="#CenterRefinement-2544"><span class="linenos">2544</span></a>                <span class="n">radi_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement-2545"><a href="#CenterRefinement-2545"><span class="linenos">2545</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement-2546"><a href="#CenterRefinement-2546"><span class="linenos">2546</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement-2547"><a href="#CenterRefinement-2547"><span class="linenos">2547</span></a>                                                            <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement-2548"><a href="#CenterRefinement-2548"><span class="linenos">2548</span></a>                
</span><span id="CenterRefinement-2549"><a href="#CenterRefinement-2549"><span class="linenos">2549</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement-2550"><a href="#CenterRefinement-2550"><span class="linenos">2550</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement-2551"><a href="#CenterRefinement-2551"><span class="linenos">2551</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement-2552"><a href="#CenterRefinement-2552"><span class="linenos">2552</span></a>
</span><span id="CenterRefinement-2553"><a href="#CenterRefinement-2553"><span class="linenos">2553</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement-2554"><a href="#CenterRefinement-2554"><span class="linenos">2554</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>
</span><span id="CenterRefinement-2555"><a href="#CenterRefinement-2555"><span class="linenos">2555</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement-2556"><a href="#CenterRefinement-2556"><span class="linenos">2556</span></a>                
</span><span id="CenterRefinement-2557"><a href="#CenterRefinement-2557"><span class="linenos">2557</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement-2558"><a href="#CenterRefinement-2558"><span class="linenos">2558</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement-2559"><a href="#CenterRefinement-2559"><span class="linenos">2559</span></a>                
</span><span id="CenterRefinement-2560"><a href="#CenterRefinement-2560"><span class="linenos">2560</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement-2561"><a href="#CenterRefinement-2561"><span class="linenos">2561</span></a>                
</span><span id="CenterRefinement-2562"><a href="#CenterRefinement-2562"><span class="linenos">2562</span></a>            
</span><span id="CenterRefinement-2563"><a href="#CenterRefinement-2563"><span class="linenos">2563</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement-2564"><a href="#CenterRefinement-2564"><span class="linenos">2564</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_intensity_sum</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement-2565"><a href="#CenterRefinement-2565"><span class="linenos">2565</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement-2566"><a href="#CenterRefinement-2566"><span class="linenos">2566</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement-2567"><a href="#CenterRefinement-2567"><span class="linenos">2567</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
</span><span id="CenterRefinement-2568"><a href="#CenterRefinement-2568"><span class="linenos">2568</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement-2569"><a href="#CenterRefinement-2569"><span class="linenos">2569</span></a>                
</span><span id="CenterRefinement-2570"><a href="#CenterRefinement-2570"><span class="linenos">2570</span></a>
</span><span id="CenterRefinement-2571"><a href="#CenterRefinement-2571"><span class="linenos">2571</span></a>        
</span><span id="CenterRefinement-2572"><a href="#CenterRefinement-2572"><span class="linenos">2572</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement-2573"><a href="#CenterRefinement-2573"><span class="linenos">2573</span></a>        <span class="c1"># ## (1) swapped coordinates</span>
</span><span id="CenterRefinement-2574"><a href="#CenterRefinement-2574"><span class="linenos">2574</span></a>        <span class="c1"># if ((bckup[0] &gt; bckup[1] and not best_center[0] &gt; best_center[1])</span>
</span><span id="CenterRefinement-2575"><a href="#CenterRefinement-2575"><span class="linenos">2575</span></a>        <span class="c1">#     or  (bckup[0] &lt; bckup[1] and not best_center[0] &lt; best_center[1])):</span>
</span><span id="CenterRefinement-2576"><a href="#CenterRefinement-2576"><span class="linenos">2576</span></a>        <span class="c1">#     best_center = best_center[::-1]</span>
</span><span id="CenterRefinement-2577"><a href="#CenterRefinement-2577"><span class="linenos">2577</span></a>        
</span><span id="CenterRefinement-2578"><a href="#CenterRefinement-2578"><span class="linenos">2578</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement-2579"><a href="#CenterRefinement-2579"><span class="linenos">2579</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">max_intensity_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement-2580"><a href="#CenterRefinement-2580"><span class="linenos">2580</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement-2581"><a href="#CenterRefinement-2581"><span class="linenos">2581</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement-2582"><a href="#CenterRefinement-2582"><span class="linenos">2582</span></a>    
</span><span id="CenterRefinement-2583"><a href="#CenterRefinement-2583"><span class="linenos">2583</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement-2584"><a href="#CenterRefinement-2584"><span class="linenos">2584</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement-2585"><a href="#CenterRefinement-2585"><span class="linenos">2585</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement-2586"><a href="#CenterRefinement-2586"><span class="linenos">2586</span></a>                <span class="s2">&quot;Center Refinement (IntensitySum)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement-2587"><a href="#CenterRefinement-2587"><span class="linenos">2587</span></a>                
</span><span id="CenterRefinement-2588"><a href="#CenterRefinement-2588"><span class="linenos">2588</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span></pre></div>


            <div class="docstring"><p>CenterRefinement object - final refinement of a diffractogram center.</p>

<p>This class is responsible for refining the center coordinates of a 
diffraction pattern based on the selected refinement method. It 
initializes with the input image and other parameters that influence 
the refinement process.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>parent</strong> (CenterLocator):
Reference to the parent CenterLocator object, allowing access to 
shared attributes and methods.</li>
<li><strong>input_image</strong> (str, path, or numpy.array):
The input image representing a 2D diffraction pattern, provided as 
a file path or a NumPy array.</li>
<li><strong>refinement</strong> (str or None, optional, default is None):
The method used for the final center refinement.
Options include:
<ul>
<li>'manual': Manual adjustment - user adjust the position
of the selected diffration ring.</li>
<li>'sum': Auto-refinement - find a diffraction ring
with maximal sum of intensities.</li>
<li>'var': Auto-refinement - find a diffraction ring
with minimal variance of intensities.</li>
</ul></li>
<li><strong>out_file</strong> (str, optional):
Filename of the text file to which the refined center coordinates 
will be saved.</li>
<li><strong>heq</strong> (bool, optional):
Flag to indicate whether to perform histogram equalization on the
input image. Default is False.</li>
<li><strong>icut</strong> (float, optional):
Cut-off intensity level for processing the image. Default is None.</li>
<li><strong>cmap</strong> (str, optional):
Colormap to be used for displaying the image. Default is 'gray'.</li>
<li><strong>messages</strong> (bool, optional):
Flag to enable or disable informational messages during processing. 
Default is False.</li>
<li><strong>print_sums</strong> (bool, optional):
If True, prints the sum of intensity values for the refined circle 
after each adjustment, relevant only for manual refinement methods.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The class refines the detected center coordinates based on the 
specified refinement method.</li>
<li>The refined coordinates are stored in instance variables
<code>xx</code>, <code>yy</code>, and <code>rr</code>, representing the refined center's x-coordinate, 
y-coordinate, and radius, respectively.</li>
<li>If an unsupported refinement method is specified, the class will print 
an error message and exit.</li>
</ul>
</div>


                            <div id="CenterRefinement.ref_interactive" class="classattr">
                                        <input id="CenterRefinement.ref_interactive-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ref_interactive</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterRefinement.ref_interactive-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement.ref_interactive"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement.ref_interactive-2060"><a href="#CenterRefinement.ref_interactive-2060"><span class="linenos">2060</span></a>    <span class="k">def</span> <span class="nf">ref_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-2061"><a href="#CenterRefinement.ref_interactive-2061"><span class="linenos">2061</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterRefinement.ref_interactive-2062"><a href="#CenterRefinement.ref_interactive-2062"><span class="linenos">2062</span></a><span class="sd">        Manual refinement of the detected diffraction pattern via one of </span>
</span><span id="CenterRefinement.ref_interactive-2063"><a href="#CenterRefinement.ref_interactive-2063"><span class="linenos">2063</span></a><span class="sd">        the methods provided in the class CircleDetection.</span>
</span><span id="CenterRefinement.ref_interactive-2064"><a href="#CenterRefinement.ref_interactive-2064"><span class="linenos">2064</span></a><span class="sd">        </span>
</span><span id="CenterRefinement.ref_interactive-2065"><a href="#CenterRefinement.ref_interactive-2065"><span class="linenos">2065</span></a><span class="sd">        The user can change the position of the center of the diffraction</span>
</span><span id="CenterRefinement.ref_interactive-2066"><a href="#CenterRefinement.ref_interactive-2066"><span class="linenos">2066</span></a><span class="sd">        pattern and also the radius of the detected pattern using keys:</span>
</span><span id="CenterRefinement.ref_interactive-2067"><a href="#CenterRefinement.ref_interactive-2067"><span class="linenos">2067</span></a><span class="sd">            - left / right / top / down arrows : move left / right / top / down</span>
</span><span id="CenterRefinement.ref_interactive-2068"><a href="#CenterRefinement.ref_interactive-2068"><span class="linenos">2068</span></a><span class="sd">            - &#39;+&#39; : increase radius</span>
</span><span id="CenterRefinement.ref_interactive-2069"><a href="#CenterRefinement.ref_interactive-2069"><span class="linenos">2069</span></a><span class="sd">            - &#39;-&#39; : decrease radius</span>
</span><span id="CenterRefinement.ref_interactive-2070"><a href="#CenterRefinement.ref_interactive-2070"><span class="linenos">2070</span></a><span class="sd">            - &#39;b&#39;/&#39;l&#39; : increase/decrease step size&quot;)</span>
</span><span id="CenterRefinement.ref_interactive-2071"><a href="#CenterRefinement.ref_interactive-2071"><span class="linenos">2071</span></a><span class="sd">            - &#39;d&#39; : done, termination of the refinement</span>
</span><span id="CenterRefinement.ref_interactive-2072"><a href="#CenterRefinement.ref_interactive-2072"><span class="linenos">2072</span></a>
</span><span id="CenterRefinement.ref_interactive-2073"><a href="#CenterRefinement.ref_interactive-2073"><span class="linenos">2073</span></a><span class="sd">        If the interactive figure is closed without any modifications,</span>
</span><span id="CenterRefinement.ref_interactive-2074"><a href="#CenterRefinement.ref_interactive-2074"><span class="linenos">2074</span></a><span class="sd">        the function returns input variables and the proccess terminates.</span>
</span><span id="CenterRefinement.ref_interactive-2075"><a href="#CenterRefinement.ref_interactive-2075"><span class="linenos">2075</span></a><span class="sd">        </span>
</span><span id="CenterRefinement.ref_interactive-2076"><a href="#CenterRefinement.ref_interactive-2076"><span class="linenos">2076</span></a><span class="sd">        The results are shown in a figure when the refinement is successful.</span>
</span><span id="CenterRefinement.ref_interactive-2077"><a href="#CenterRefinement.ref_interactive-2077"><span class="linenos">2077</span></a>
</span><span id="CenterRefinement.ref_interactive-2078"><a href="#CenterRefinement.ref_interactive-2078"><span class="linenos">2078</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement.ref_interactive-2079"><a href="#CenterRefinement.ref_interactive-2079"><span class="linenos">2079</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement.ref_interactive-2080"><a href="#CenterRefinement.ref_interactive-2080"><span class="linenos">2080</span></a><span class="sd">        px : float64</span>
</span><span id="CenterRefinement.ref_interactive-2081"><a href="#CenterRefinement.ref_interactive-2081"><span class="linenos">2081</span></a><span class="sd">            x-coordinate of the center</span>
</span><span id="CenterRefinement.ref_interactive-2082"><a href="#CenterRefinement.ref_interactive-2082"><span class="linenos">2082</span></a><span class="sd">        py : float64</span>
</span><span id="CenterRefinement.ref_interactive-2083"><a href="#CenterRefinement.ref_interactive-2083"><span class="linenos">2083</span></a><span class="sd">            y-coordinate of the center</span>
</span><span id="CenterRefinement.ref_interactive-2084"><a href="#CenterRefinement.ref_interactive-2084"><span class="linenos">2084</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterRefinement.ref_interactive-2085"><a href="#CenterRefinement.ref_interactive-2085"><span class="linenos">2085</span></a><span class="sd">            radius of the circular diffraction pattern</span>
</span><span id="CenterRefinement.ref_interactive-2086"><a href="#CenterRefinement.ref_interactive-2086"><span class="linenos">2086</span></a>
</span><span id="CenterRefinement.ref_interactive-2087"><a href="#CenterRefinement.ref_interactive-2087"><span class="linenos">2087</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement.ref_interactive-2088"><a href="#CenterRefinement.ref_interactive-2088"><span class="linenos">2088</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement.ref_interactive-2089"><a href="#CenterRefinement.ref_interactive-2089"><span class="linenos">2089</span></a><span class="sd">        x : float64</span>
</span><span id="CenterRefinement.ref_interactive-2090"><a href="#CenterRefinement.ref_interactive-2090"><span class="linenos">2090</span></a><span class="sd">            new x-coordinate of the center</span>
</span><span id="CenterRefinement.ref_interactive-2091"><a href="#CenterRefinement.ref_interactive-2091"><span class="linenos">2091</span></a><span class="sd">        y : float64</span>
</span><span id="CenterRefinement.ref_interactive-2092"><a href="#CenterRefinement.ref_interactive-2092"><span class="linenos">2092</span></a><span class="sd">            new y-coordinate of the center</span>
</span><span id="CenterRefinement.ref_interactive-2093"><a href="#CenterRefinement.ref_interactive-2093"><span class="linenos">2093</span></a><span class="sd">        r : float64</span>
</span><span id="CenterRefinement.ref_interactive-2094"><a href="#CenterRefinement.ref_interactive-2094"><span class="linenos">2094</span></a><span class="sd">            new radius of the circular diffraction pattern</span>
</span><span id="CenterRefinement.ref_interactive-2095"><a href="#CenterRefinement.ref_interactive-2095"><span class="linenos">2095</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterRefinement.ref_interactive-2096"><a href="#CenterRefinement.ref_interactive-2096"><span class="linenos">2096</span></a>        
</span><span id="CenterRefinement.ref_interactive-2097"><a href="#CenterRefinement.ref_interactive-2097"><span class="linenos">2097</span></a>        <span class="c1"># Load original image</span>
</span><span id="CenterRefinement.ref_interactive-2098"><a href="#CenterRefinement.ref_interactive-2098"><span class="linenos">2098</span></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2099"><a href="#CenterRefinement.ref_interactive-2099"><span class="linenos">2099</span></a>
</span><span id="CenterRefinement.ref_interactive-2100"><a href="#CenterRefinement.ref_interactive-2100"><span class="linenos">2100</span></a>        <span class="c1"># Edit contrast with a user-predefined parameter</span>
</span><span id="CenterRefinement.ref_interactive-2101"><a href="#CenterRefinement.ref_interactive-2101"><span class="linenos">2101</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2102"><a href="#CenterRefinement.ref_interactive-2102"><span class="linenos">2102</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2103"><a href="#CenterRefinement.ref_interactive-2103"><span class="linenos">2103</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contrast enhanced.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2104"><a href="#CenterRefinement.ref_interactive-2104"><span class="linenos">2104</span></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-2105"><a href="#CenterRefinement.ref_interactive-2105"><span class="linenos">2105</span></a>                              <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">icut</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-2106"><a href="#CenterRefinement.ref_interactive-2106"><span class="linenos">2106</span></a>                              <span class="n">im</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2107"><a href="#CenterRefinement.ref_interactive-2107"><span class="linenos">2107</span></a>            
</span><span id="CenterRefinement.ref_interactive-2108"><a href="#CenterRefinement.ref_interactive-2108"><span class="linenos">2108</span></a>        
</span><span id="CenterRefinement.ref_interactive-2109"><a href="#CenterRefinement.ref_interactive-2109"><span class="linenos">2109</span></a>        <span class="c1"># Initialize variables and flags</span>
</span><span id="CenterRefinement.ref_interactive-2110"><a href="#CenterRefinement.ref_interactive-2110"><span class="linenos">2110</span></a>        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_interactive-2111"><a href="#CenterRefinement.ref_interactive-2111"><span class="linenos">2111</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2112"><a href="#CenterRefinement.ref_interactive-2112"><span class="linenos">2112</span></a>        <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CenterRefinement.ref_interactive-2113"><a href="#CenterRefinement.ref_interactive-2113"><span class="linenos">2113</span></a>
</span><span id="CenterRefinement.ref_interactive-2114"><a href="#CenterRefinement.ref_interactive-2114"><span class="linenos">2114</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterRefinement.ref_interactive-2115"><a href="#CenterRefinement.ref_interactive-2115"><span class="linenos">2115</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2116"><a href="#CenterRefinement.ref_interactive-2116"><span class="linenos">2116</span></a>            <span class="n">instructions</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="CenterRefinement.ref_interactive-2117"><a href="#CenterRefinement.ref_interactive-2117"><span class="linenos">2117</span></a><span class="s2">            </span>
</span><span id="CenterRefinement.ref_interactive-2118"><a href="#CenterRefinement.ref_interactive-2118"><span class="linenos">2118</span></a><span class="s2">            Interactive refinement. Use these keys:</span>
</span><span id="CenterRefinement.ref_interactive-2119"><a href="#CenterRefinement.ref_interactive-2119"><span class="linenos">2119</span></a><span class="s2">                  - &#39;&#39; : move left</span>
</span><span id="CenterRefinement.ref_interactive-2120"><a href="#CenterRefinement.ref_interactive-2120"><span class="linenos">2120</span></a><span class="s2">                  - &#39;&#39; : move right</span>
</span><span id="CenterRefinement.ref_interactive-2121"><a href="#CenterRefinement.ref_interactive-2121"><span class="linenos">2121</span></a><span class="s2">                  - &#39;&#39; : move up</span>
</span><span id="CenterRefinement.ref_interactive-2122"><a href="#CenterRefinement.ref_interactive-2122"><span class="linenos">2122</span></a><span class="s2">                  - &#39;&#39; : move down</span>
</span><span id="CenterRefinement.ref_interactive-2123"><a href="#CenterRefinement.ref_interactive-2123"><span class="linenos">2123</span></a><span class="s2">                  - &#39;+&#39; : increase circle radius</span>
</span><span id="CenterRefinement.ref_interactive-2124"><a href="#CenterRefinement.ref_interactive-2124"><span class="linenos">2124</span></a><span class="s2">                  - &#39;-&#39; : decrease circle radius</span>
</span><span id="CenterRefinement.ref_interactive-2125"><a href="#CenterRefinement.ref_interactive-2125"><span class="linenos">2125</span></a><span class="s2">                  - &#39;b&#39; : increase step size</span>
</span><span id="CenterRefinement.ref_interactive-2126"><a href="#CenterRefinement.ref_interactive-2126"><span class="linenos">2126</span></a><span class="s2">                  - &#39;l&#39; : decrease step size</span>
</span><span id="CenterRefinement.ref_interactive-2127"><a href="#CenterRefinement.ref_interactive-2127"><span class="linenos">2127</span></a><span class="s2">                  - &#39;d&#39; : refinement done</span>
</span><span id="CenterRefinement.ref_interactive-2128"><a href="#CenterRefinement.ref_interactive-2128"><span class="linenos">2128</span></a><span class="s2">                  </span>
</span><span id="CenterRefinement.ref_interactive-2129"><a href="#CenterRefinement.ref_interactive-2129"><span class="linenos">2129</span></a><span class="s2">            DISCLAIMER: For the purpose of the center shift, the default</span>
</span><span id="CenterRefinement.ref_interactive-2130"><a href="#CenterRefinement.ref_interactive-2130"><span class="linenos">2130</span></a><span class="s2">            shortcuts for left and right arrows were removed.</span>
</span><span id="CenterRefinement.ref_interactive-2131"><a href="#CenterRefinement.ref_interactive-2131"><span class="linenos">2131</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2132"><a href="#CenterRefinement.ref_interactive-2132"><span class="linenos">2132</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2133"><a href="#CenterRefinement.ref_interactive-2133"><span class="linenos">2133</span></a>        
</span><span id="CenterRefinement.ref_interactive-2134"><a href="#CenterRefinement.ref_interactive-2134"><span class="linenos">2134</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2135"><a href="#CenterRefinement.ref_interactive-2135"><span class="linenos">2135</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intensity sums during refinement:&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2136"><a href="#CenterRefinement.ref_interactive-2136"><span class="linenos">2136</span></a>            
</span><span id="CenterRefinement.ref_interactive-2137"><a href="#CenterRefinement.ref_interactive-2137"><span class="linenos">2137</span></a>        <span class="c1"># Create a figure and display the image</span>
</span><span id="CenterRefinement.ref_interactive-2138"><a href="#CenterRefinement.ref_interactive-2138"><span class="linenos">2138</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_interactive-2139"><a href="#CenterRefinement.ref_interactive-2139"><span class="linenos">2139</span></a>        
</span><span id="CenterRefinement.ref_interactive-2140"><a href="#CenterRefinement.ref_interactive-2140"><span class="linenos">2140</span></a>        <span class="c1"># Allow using arrows to move back and forth between view ports</span>
</span><span id="CenterRefinement.ref_interactive-2141"><a href="#CenterRefinement.ref_interactive-2141"><span class="linenos">2141</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.back&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2142"><a href="#CenterRefinement.ref_interactive-2142"><span class="linenos">2142</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;keymap.forward&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2143"><a href="#CenterRefinement.ref_interactive-2143"><span class="linenos">2143</span></a>        
</span><span id="CenterRefinement.ref_interactive-2144"><a href="#CenterRefinement.ref_interactive-2144"><span class="linenos">2144</span></a>        <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
</span><span id="CenterRefinement.ref_interactive-2145"><a href="#CenterRefinement.ref_interactive-2145"><span class="linenos">2145</span></a>            <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">pr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2146"><a href="#CenterRefinement.ref_interactive-2146"><span class="linenos">2146</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2147"><a href="#CenterRefinement.ref_interactive-2147"><span class="linenos">2147</span></a>
</span><span id="CenterRefinement.ref_interactive-2148"><a href="#CenterRefinement.ref_interactive-2148"><span class="linenos">2148</span></a>        <span class="c1"># Plot center point</span>
</span><span id="CenterRefinement.ref_interactive-2149"><a href="#CenterRefinement.ref_interactive-2149"><span class="linenos">2149</span></a>        <span class="n">center</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="s1">&#39;rx&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2150"><a href="#CenterRefinement.ref_interactive-2150"><span class="linenos">2150</span></a>                    
</span><span id="CenterRefinement.ref_interactive-2151"><a href="#CenterRefinement.ref_interactive-2151"><span class="linenos">2151</span></a>
</span><span id="CenterRefinement.ref_interactive-2152"><a href="#CenterRefinement.ref_interactive-2152"><span class="linenos">2152</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manually adjust the center position.&#39;</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-2153"><a href="#CenterRefinement.ref_interactive-2153"><span class="linenos">2153</span></a>                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2154"><a href="#CenterRefinement.ref_interactive-2154"><span class="linenos">2154</span></a>
</span><span id="CenterRefinement.ref_interactive-2155"><a href="#CenterRefinement.ref_interactive-2155"><span class="linenos">2155</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2156"><a href="#CenterRefinement.ref_interactive-2156"><span class="linenos">2156</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2157"><a href="#CenterRefinement.ref_interactive-2157"><span class="linenos">2157</span></a>        
</span><span id="CenterRefinement.ref_interactive-2158"><a href="#CenterRefinement.ref_interactive-2158"><span class="linenos">2158</span></a>        <span class="c1"># Enable interactive mode</span>
</span><span id="CenterRefinement.ref_interactive-2159"><a href="#CenterRefinement.ref_interactive-2159"><span class="linenos">2159</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-2160"><a href="#CenterRefinement.ref_interactive-2160"><span class="linenos">2160</span></a>        
</span><span id="CenterRefinement.ref_interactive-2161"><a href="#CenterRefinement.ref_interactive-2161"><span class="linenos">2161</span></a>
</span><span id="CenterRefinement.ref_interactive-2162"><a href="#CenterRefinement.ref_interactive-2162"><span class="linenos">2162</span></a>        <span class="c1"># Display the image</span>
</span><span id="CenterRefinement.ref_interactive-2163"><a href="#CenterRefinement.ref_interactive-2163"><span class="linenos">2163</span></a>        <span class="c1"># fig.set_size_inches(self.fig_width, self.fig_height)</span>
</span><span id="CenterRefinement.ref_interactive-2164"><a href="#CenterRefinement.ref_interactive-2164"><span class="linenos">2164</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2165"><a href="#CenterRefinement.ref_interactive-2165"><span class="linenos">2165</span></a>        
</span><span id="CenterRefinement.ref_interactive-2166"><a href="#CenterRefinement.ref_interactive-2166"><span class="linenos">2166</span></a>        <span class="c1">### Define the event handler for figure close event</span>
</span><span id="CenterRefinement.ref_interactive-2167"><a href="#CenterRefinement.ref_interactive-2167"><span class="linenos">2167</span></a>        <span class="k">def</span> <span class="nf">onclose</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-2168"><a href="#CenterRefinement.ref_interactive-2168"><span class="linenos">2168</span></a>            <span class="k">nonlocal</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement.ref_interactive-2169"><a href="#CenterRefinement.ref_interactive-2169"><span class="linenos">2169</span></a>            <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement.ref_interactive-2170"><a href="#CenterRefinement.ref_interactive-2170"><span class="linenos">2170</span></a> 
</span><span id="CenterRefinement.ref_interactive-2171"><a href="#CenterRefinement.ref_interactive-2171"><span class="linenos">2171</span></a>        <span class="c1"># Connect the event handler to the figure close event</span>
</span><span id="CenterRefinement.ref_interactive-2172"><a href="#CenterRefinement.ref_interactive-2172"><span class="linenos">2172</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">onclose</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2173"><a href="#CenterRefinement.ref_interactive-2173"><span class="linenos">2173</span></a>
</span><span id="CenterRefinement.ref_interactive-2174"><a href="#CenterRefinement.ref_interactive-2174"><span class="linenos">2174</span></a>        <span class="c1"># Define the callback function for key press events</span>
</span><span id="CenterRefinement.ref_interactive-2175"><a href="#CenterRefinement.ref_interactive-2175"><span class="linenos">2175</span></a>        <span class="k">def</span> <span class="nf">onkeypress2</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-2176"><a href="#CenterRefinement.ref_interactive-2176"><span class="linenos">2176</span></a>            <span class="c1"># Use nonlocal to modify the center position in the outer scope</span>
</span><span id="CenterRefinement.ref_interactive-2177"><a href="#CenterRefinement.ref_interactive-2177"><span class="linenos">2177</span></a>            <span class="k">nonlocal</span> <span class="n">xy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">termination_flag</span>
</span><span id="CenterRefinement.ref_interactive-2178"><a href="#CenterRefinement.ref_interactive-2178"><span class="linenos">2178</span></a>        
</span><span id="CenterRefinement.ref_interactive-2179"><a href="#CenterRefinement.ref_interactive-2179"><span class="linenos">2179</span></a>            <span class="c1"># OTHER KEYS USED IN INTERACTIVE FIGURES</span>
</span><span id="CenterRefinement.ref_interactive-2180"><a href="#CenterRefinement.ref_interactive-2180"><span class="linenos">2180</span></a>            <span class="c1">#   event.key == &#39;1&#39;: select a point in self.detection_3points()</span>
</span><span id="CenterRefinement.ref_interactive-2181"><a href="#CenterRefinement.ref_interactive-2181"><span class="linenos">2181</span></a>            <span class="c1">#   event.key == &#39;2&#39;: delete the last point in self.detection...</span>
</span><span id="CenterRefinement.ref_interactive-2182"><a href="#CenterRefinement.ref_interactive-2182"><span class="linenos">2182</span></a>            <span class="c1">#   event.key == &#39;3&#39;: delete a point in self.detection...</span>
</span><span id="CenterRefinement.ref_interactive-2183"><a href="#CenterRefinement.ref_interactive-2183"><span class="linenos">2183</span></a>            <span class="c1">#   event.key == &#39;+&#39;: increase circle radius</span>
</span><span id="CenterRefinement.ref_interactive-2184"><a href="#CenterRefinement.ref_interactive-2184"><span class="linenos">2184</span></a>            <span class="c1">#   event.key == &#39;-&#39;: decrease circle radius           </span>
</span><span id="CenterRefinement.ref_interactive-2185"><a href="#CenterRefinement.ref_interactive-2185"><span class="linenos">2185</span></a>            <span class="c1">#   event.key == &#39;b&#39;: increase the step size (big step size)</span>
</span><span id="CenterRefinement.ref_interactive-2186"><a href="#CenterRefinement.ref_interactive-2186"><span class="linenos">2186</span></a>            <span class="c1">#   event.key == &#39;l&#39;: decrease the step size (little step size)</span>
</span><span id="CenterRefinement.ref_interactive-2187"><a href="#CenterRefinement.ref_interactive-2187"><span class="linenos">2187</span></a>            <span class="c1">#   event.key == &#39;d&#39;: proceed in self.detection_3points()</span>
</span><span id="CenterRefinement.ref_interactive-2188"><a href="#CenterRefinement.ref_interactive-2188"><span class="linenos">2188</span></a>        
</span><span id="CenterRefinement.ref_interactive-2189"><a href="#CenterRefinement.ref_interactive-2189"><span class="linenos">2189</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>                    
</span><span id="CenterRefinement.ref_interactive-2190"><a href="#CenterRefinement.ref_interactive-2190"><span class="linenos">2190</span></a>                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
</span><span id="CenterRefinement.ref_interactive-2191"><a href="#CenterRefinement.ref_interactive-2191"><span class="linenos">2191</span></a>                    <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CenterRefinement.ref_interactive-2192"><a href="#CenterRefinement.ref_interactive-2192"><span class="linenos">2192</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2193"><a href="#CenterRefinement.ref_interactive-2193"><span class="linenos">2193</span></a>                    <span class="c1"># Perform shifts normally</span>
</span><span id="CenterRefinement.ref_interactive-2194"><a href="#CenterRefinement.ref_interactive-2194"><span class="linenos">2194</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2195"><a href="#CenterRefinement.ref_interactive-2195"><span class="linenos">2195</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-2196"><a href="#CenterRefinement.ref_interactive-2196"><span class="linenos">2196</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2197"><a href="#CenterRefinement.ref_interactive-2197"><span class="linenos">2197</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-2198"><a href="#CenterRefinement.ref_interactive-2198"><span class="linenos">2198</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2199"><a href="#CenterRefinement.ref_interactive-2199"><span class="linenos">2199</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-2200"><a href="#CenterRefinement.ref_interactive-2200"><span class="linenos">2200</span></a>                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2201"><a href="#CenterRefinement.ref_interactive-2201"><span class="linenos">2201</span></a>                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
</span><span id="CenterRefinement.ref_interactive-2202"><a href="#CenterRefinement.ref_interactive-2202"><span class="linenos">2202</span></a>                    
</span><span id="CenterRefinement.ref_interactive-2203"><a href="#CenterRefinement.ref_interactive-2203"><span class="linenos">2203</span></a>                    <span class="c1"># Print sum only for arrow keys</span>
</span><span id="CenterRefinement.ref_interactive-2204"><a href="#CenterRefinement.ref_interactive-2204"><span class="linenos">2204</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">print_sums</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2205"><a href="#CenterRefinement.ref_interactive-2205"><span class="linenos">2205</span></a>                        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">to_refine</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_interactive-2206"><a href="#CenterRefinement.ref_interactive-2206"><span class="linenos">2206</span></a>                                                      <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2207"><a href="#CenterRefinement.ref_interactive-2207"><span class="linenos">2207</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2208"><a href="#CenterRefinement.ref_interactive-2208"><span class="linenos">2208</span></a>            
</span><span id="CenterRefinement.ref_interactive-2209"><a href="#CenterRefinement.ref_interactive-2209"><span class="linenos">2209</span></a>            <span class="c1"># Terminate the interactive refinement with &#39;d&#39; key</span>
</span><span id="CenterRefinement.ref_interactive-2210"><a href="#CenterRefinement.ref_interactive-2210"><span class="linenos">2210</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2211"><a href="#CenterRefinement.ref_interactive-2211"><span class="linenos">2211</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement.ref_interactive-2212"><a href="#CenterRefinement.ref_interactive-2212"><span class="linenos">2212</span></a>        
</span><span id="CenterRefinement.ref_interactive-2213"><a href="#CenterRefinement.ref_interactive-2213"><span class="linenos">2213</span></a>            <span class="c1"># Change step size </span>
</span><span id="CenterRefinement.ref_interactive-2214"><a href="#CenterRefinement.ref_interactive-2214"><span class="linenos">2214</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2215"><a href="#CenterRefinement.ref_interactive-2215"><span class="linenos">2215</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="CenterRefinement.ref_interactive-2216"><a href="#CenterRefinement.ref_interactive-2216"><span class="linenos">2216</span></a>        
</span><span id="CenterRefinement.ref_interactive-2217"><a href="#CenterRefinement.ref_interactive-2217"><span class="linenos">2217</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2218"><a href="#CenterRefinement.ref_interactive-2218"><span class="linenos">2218</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="mi">5</span>
</span><span id="CenterRefinement.ref_interactive-2219"><a href="#CenterRefinement.ref_interactive-2219"><span class="linenos">2219</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2220"><a href="#CenterRefinement.ref_interactive-2220"><span class="linenos">2220</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="CenterRefinement.ref_interactive-2221"><a href="#CenterRefinement.ref_interactive-2221"><span class="linenos">2221</span></a>        
</span><span id="CenterRefinement.ref_interactive-2222"><a href="#CenterRefinement.ref_interactive-2222"><span class="linenos">2222</span></a>            <span class="c1"># Update the plot with the new center position</span>
</span><span id="CenterRefinement.ref_interactive-2223"><a href="#CenterRefinement.ref_interactive-2223"><span class="linenos">2223</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_center</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># circle</span>
</span><span id="CenterRefinement.ref_interactive-2224"><a href="#CenterRefinement.ref_interactive-2224"><span class="linenos">2224</span></a>            <span class="n">circle</span><span class="o">.</span><span class="n">set_radius</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>               <span class="c1"># radius</span>
</span><span id="CenterRefinement.ref_interactive-2225"><a href="#CenterRefinement.ref_interactive-2225"><span class="linenos">2225</span></a>            <span class="n">center</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># center</span>
</span><span id="CenterRefinement.ref_interactive-2226"><a href="#CenterRefinement.ref_interactive-2226"><span class="linenos">2226</span></a>        
</span><span id="CenterRefinement.ref_interactive-2227"><a href="#CenterRefinement.ref_interactive-2227"><span class="linenos">2227</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Manually adjust the center position.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2228"><a href="#CenterRefinement.ref_interactive-2228"><span class="linenos">2228</span></a>        
</span><span id="CenterRefinement.ref_interactive-2229"><a href="#CenterRefinement.ref_interactive-2229"><span class="linenos">2229</span></a>            <span class="c1"># Update the plot</span>
</span><span id="CenterRefinement.ref_interactive-2230"><a href="#CenterRefinement.ref_interactive-2230"><span class="linenos">2230</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-2231"><a href="#CenterRefinement.ref_interactive-2231"><span class="linenos">2231</span></a>
</span><span id="CenterRefinement.ref_interactive-2232"><a href="#CenterRefinement.ref_interactive-2232"><span class="linenos">2232</span></a>            
</span><span id="CenterRefinement.ref_interactive-2233"><a href="#CenterRefinement.ref_interactive-2233"><span class="linenos">2233</span></a>        <span class="c1"># Disconnect the on_key_press1 event handler from the figure</span>
</span><span id="CenterRefinement.ref_interactive-2234"><a href="#CenterRefinement.ref_interactive-2234"><span class="linenos">2234</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2235"><a href="#CenterRefinement.ref_interactive-2235"><span class="linenos">2235</span></a>        
</span><span id="CenterRefinement.ref_interactive-2236"><a href="#CenterRefinement.ref_interactive-2236"><span class="linenos">2236</span></a>        <span class="c1"># Connect the callback function to the key press event</span>
</span><span id="CenterRefinement.ref_interactive-2237"><a href="#CenterRefinement.ref_interactive-2237"><span class="linenos">2237</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">onkeypress2</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2238"><a href="#CenterRefinement.ref_interactive-2238"><span class="linenos">2238</span></a>
</span><span id="CenterRefinement.ref_interactive-2239"><a href="#CenterRefinement.ref_interactive-2239"><span class="linenos">2239</span></a>        <span class="c1"># Enable interaction mode</span>
</span><span id="CenterRefinement.ref_interactive-2240"><a href="#CenterRefinement.ref_interactive-2240"><span class="linenos">2240</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 
</span><span id="CenterRefinement.ref_interactive-2241"><a href="#CenterRefinement.ref_interactive-2241"><span class="linenos">2241</span></a>               
</span><span id="CenterRefinement.ref_interactive-2242"><a href="#CenterRefinement.ref_interactive-2242"><span class="linenos">2242</span></a>        <span class="c1"># Wait for &#39;d&#39; key press or figure closure</span>
</span><span id="CenterRefinement.ref_interactive-2243"><a href="#CenterRefinement.ref_interactive-2243"><span class="linenos">2243</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">termination_flag</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2244"><a href="#CenterRefinement.ref_interactive-2244"><span class="linenos">2244</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2245"><a href="#CenterRefinement.ref_interactive-2245"><span class="linenos">2245</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2246"><a href="#CenterRefinement.ref_interactive-2246"><span class="linenos">2246</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_interactive-2247"><a href="#CenterRefinement.ref_interactive-2247"><span class="linenos">2247</span></a>                <span class="c1"># If the user manually closes the figure, terminate the loop</span>
</span><span id="CenterRefinement.ref_interactive-2248"><a href="#CenterRefinement.ref_interactive-2248"><span class="linenos">2248</span></a>                <span class="n">termination_flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CenterRefinement.ref_interactive-2249"><a href="#CenterRefinement.ref_interactive-2249"><span class="linenos">2249</span></a>         
</span><span id="CenterRefinement.ref_interactive-2250"><a href="#CenterRefinement.ref_interactive-2250"><span class="linenos">2250</span></a>        <span class="c1"># Turn off interactive mode</span>
</span><span id="CenterRefinement.ref_interactive-2251"><a href="#CenterRefinement.ref_interactive-2251"><span class="linenos">2251</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-2252"><a href="#CenterRefinement.ref_interactive-2252"><span class="linenos">2252</span></a>        
</span><span id="CenterRefinement.ref_interactive-2253"><a href="#CenterRefinement.ref_interactive-2253"><span class="linenos">2253</span></a>        <span class="c1"># Display the final figure with the selected center position and radius</span>
</span><span id="CenterRefinement.ref_interactive-2254"><a href="#CenterRefinement.ref_interactive-2254"><span class="linenos">2254</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="CenterRefinement.ref_interactive-2255"><a href="#CenterRefinement.ref_interactive-2255"><span class="linenos">2255</span></a>
</span><span id="CenterRefinement.ref_interactive-2256"><a href="#CenterRefinement.ref_interactive-2256"><span class="linenos">2256</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_interactive-2257"><a href="#CenterRefinement.ref_interactive-2257"><span class="linenos">2257</span></a>        
</span><span id="CenterRefinement.ref_interactive-2258"><a href="#CenterRefinement.ref_interactive-2258"><span class="linenos">2258</span></a>        <span class="c1"># If the termination_flag is True, stop the code</span>
</span><span id="CenterRefinement.ref_interactive-2259"><a href="#CenterRefinement.ref_interactive-2259"><span class="linenos">2259</span></a>        <span class="k">if</span> <span class="n">termination_flag</span><span class="p">:</span> 
</span><span id="CenterRefinement.ref_interactive-2260"><a href="#CenterRefinement.ref_interactive-2260"><span class="linenos">2260</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the figure</span>
</span><span id="CenterRefinement.ref_interactive-2261"><a href="#CenterRefinement.ref_interactive-2261"><span class="linenos">2261</span></a>
</span><span id="CenterRefinement.ref_interactive-2262"><a href="#CenterRefinement.ref_interactive-2262"><span class="linenos">2262</span></a>        <span class="c1"># User information:</span>
</span><span id="CenterRefinement.ref_interactive-2263"><a href="#CenterRefinement.ref_interactive-2263"><span class="linenos">2263</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_interactive-2264"><a href="#CenterRefinement.ref_interactive-2264"><span class="linenos">2264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (Interactive)       : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement.ref_interactive-2265"><a href="#CenterRefinement.ref_interactive-2265"><span class="linenos">2265</span></a>
</span><span id="CenterRefinement.ref_interactive-2266"><a href="#CenterRefinement.ref_interactive-2266"><span class="linenos">2266</span></a>        <span class="k">return</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span>    
</span></pre></div>


            <div class="docstring"><p>Manual refinement of the detected diffraction pattern via one of 
the methods provided in the class CircleDetection.</p>

<p>The user can change the position of the center of the diffraction
pattern and also the radius of the detected pattern using keys:
    - left / right / top / down arrows : move left / right / top / down
    - '+' : increase radius
    - '-' : decrease radius
    - 'b'/'l' : increase/decrease step size")
    - 'd' : done, termination of the refinement</p>

<p>If the interactive figure is closed without any modifications,
the function returns input variables and the proccess terminates.</p>

<p>The results are shown in a figure when the refinement is successful.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>px</strong> (float64):
x-coordinate of the center</li>
<li><strong>py</strong> (float64):
y-coordinate of the center</li>
<li><strong>pr</strong> (float64):
radius of the circular diffraction pattern</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>x</strong> (float64):
new x-coordinate of the center</li>
<li><strong>y</strong> (float64):
new y-coordinate of the center</li>
<li><strong>r</strong> (float64):
new radius of the circular diffraction pattern</li>
</ul>
</div>


                            </div>
                            <div id="CenterRefinement.ref_var" class="classattr">
                                        <input id="CenterRefinement.ref_var-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ref_var</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterRefinement.ref_var-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement.ref_var"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement.ref_var-2269"><a href="#CenterRefinement.ref_var-2269"><span class="linenos">2269</span></a>    <span class="k">def</span> <span class="nf">ref_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_var-2270"><a href="#CenterRefinement.ref_var-2270"><span class="linenos">2270</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;         </span>
</span><span id="CenterRefinement.ref_var-2271"><a href="#CenterRefinement.ref_var-2271"><span class="linenos">2271</span></a><span class="sd">        Adjust center coordinates of a detected circular diffraction pattern.</span>
</span><span id="CenterRefinement.ref_var-2272"><a href="#CenterRefinement.ref_var-2272"><span class="linenos">2272</span></a><span class="sd">        The center adjustment is based on variance minimization.</span>
</span><span id="CenterRefinement.ref_var-2273"><a href="#CenterRefinement.ref_var-2273"><span class="linenos">2273</span></a><span class="sd">        </span>
</span><span id="CenterRefinement.ref_var-2274"><a href="#CenterRefinement.ref_var-2274"><span class="linenos">2274</span></a><span class="sd">        The 8-neighbourhood pixels (x) of the current center (o) </span>
</span><span id="CenterRefinement.ref_var-2275"><a href="#CenterRefinement.ref_var-2275"><span class="linenos">2275</span></a><span class="sd">        will be tested regarding the minimization:</span>
</span><span id="CenterRefinement.ref_var-2276"><a href="#CenterRefinement.ref_var-2276"><span class="linenos">2276</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_var-2277"><a href="#CenterRefinement.ref_var-2277"><span class="linenos">2277</span></a><span class="sd">        - x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</span>
</span><span id="CenterRefinement.ref_var-2278"><a href="#CenterRefinement.ref_var-2278"><span class="linenos">2278</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_var-2279"><a href="#CenterRefinement.ref_var-2279"><span class="linenos">2279</span></a><span class="sd">        - x o x : (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement.ref_var-2280"><a href="#CenterRefinement.ref_var-2280"><span class="linenos">2280</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_var-2281"><a href="#CenterRefinement.ref_var-2281"><span class="linenos">2281</span></a><span class="sd">        - x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement.ref_var-2282"><a href="#CenterRefinement.ref_var-2282"><span class="linenos">2282</span></a><span class="sd">        </span>
</span><span id="CenterRefinement.ref_var-2283"><a href="#CenterRefinement.ref_var-2283"><span class="linenos">2283</span></a>
</span><span id="CenterRefinement.ref_var-2284"><a href="#CenterRefinement.ref_var-2284"><span class="linenos">2284</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement.ref_var-2285"><a href="#CenterRefinement.ref_var-2285"><span class="linenos">2285</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement.ref_var-2286"><a href="#CenterRefinement.ref_var-2286"><span class="linenos">2286</span></a><span class="sd">        self.image : array of uint8</span>
</span><span id="CenterRefinement.ref_var-2287"><a href="#CenterRefinement.ref_var-2287"><span class="linenos">2287</span></a><span class="sd">            Input image in which the diffraction pattern is to be found</span>
</span><span id="CenterRefinement.ref_var-2288"><a href="#CenterRefinement.ref_var-2288"><span class="linenos">2288</span></a><span class="sd">        px : float64</span>
</span><span id="CenterRefinement.ref_var-2289"><a href="#CenterRefinement.ref_var-2289"><span class="linenos">2289</span></a><span class="sd">            x-coordinate of the detected center to be adjusted</span>
</span><span id="CenterRefinement.ref_var-2290"><a href="#CenterRefinement.ref_var-2290"><span class="linenos">2290</span></a><span class="sd">        py : float64</span>
</span><span id="CenterRefinement.ref_var-2291"><a href="#CenterRefinement.ref_var-2291"><span class="linenos">2291</span></a><span class="sd">            y-coordinate of the detected center to be adjusted</span>
</span><span id="CenterRefinement.ref_var-2292"><a href="#CenterRefinement.ref_var-2292"><span class="linenos">2292</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterRefinement.ref_var-2293"><a href="#CenterRefinement.ref_var-2293"><span class="linenos">2293</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterRefinement.ref_var-2294"><a href="#CenterRefinement.ref_var-2294"><span class="linenos">2294</span></a><span class="sd">        plot_results : integer (default = 1)</span>
</span><span id="CenterRefinement.ref_var-2295"><a href="#CenterRefinement.ref_var-2295"><span class="linenos">2295</span></a><span class="sd">            Plot Detected center. The default is 1.</span>
</span><span id="CenterRefinement.ref_var-2296"><a href="#CenterRefinement.ref_var-2296"><span class="linenos">2296</span></a><span class="sd">        </span>
</span><span id="CenterRefinement.ref_var-2297"><a href="#CenterRefinement.ref_var-2297"><span class="linenos">2297</span></a><span class="sd">        Returns</span>
</span><span id="CenterRefinement.ref_var-2298"><a href="#CenterRefinement.ref_var-2298"><span class="linenos">2298</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement.ref_var-2299"><a href="#CenterRefinement.ref_var-2299"><span class="linenos">2299</span></a><span class="sd">        px : array of int32</span>
</span><span id="CenterRefinement.ref_var-2300"><a href="#CenterRefinement.ref_var-2300"><span class="linenos">2300</span></a><span class="sd">           corrected x-coordinates of pixels from circle border</span>
</span><span id="CenterRefinement.ref_var-2301"><a href="#CenterRefinement.ref_var-2301"><span class="linenos">2301</span></a><span class="sd">        py : array of int32</span>
</span><span id="CenterRefinement.ref_var-2302"><a href="#CenterRefinement.ref_var-2302"><span class="linenos">2302</span></a><span class="sd">            corrected y-coordinates of pixels from circle border</span>
</span><span id="CenterRefinement.ref_var-2303"><a href="#CenterRefinement.ref_var-2303"><span class="linenos">2303</span></a><span class="sd">        pr : array of int32</span>
</span><span id="CenterRefinement.ref_var-2304"><a href="#CenterRefinement.ref_var-2304"><span class="linenos">2304</span></a><span class="sd">            radius of the detected center</span>
</span><span id="CenterRefinement.ref_var-2305"><a href="#CenterRefinement.ref_var-2305"><span class="linenos">2305</span></a><span class="sd">            </span>
</span><span id="CenterRefinement.ref_var-2306"><a href="#CenterRefinement.ref_var-2306"><span class="linenos">2306</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterRefinement.ref_var-2307"><a href="#CenterRefinement.ref_var-2307"><span class="linenos">2307</span></a>        
</span><span id="CenterRefinement.ref_var-2308"><a href="#CenterRefinement.ref_var-2308"><span class="linenos">2308</span></a>        <span class="c1"># Store input for plot</span>
</span><span id="CenterRefinement.ref_var-2309"><a href="#CenterRefinement.ref_var-2309"><span class="linenos">2309</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_var-2310"><a href="#CenterRefinement.ref_var-2310"><span class="linenos">2310</span></a>        
</span><span id="CenterRefinement.ref_var-2311"><a href="#CenterRefinement.ref_var-2311"><span class="linenos">2311</span></a>        <span class="c1"># Load image</span>
</span><span id="CenterRefinement.ref_var-2312"><a href="#CenterRefinement.ref_var-2312"><span class="linenos">2312</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2313"><a href="#CenterRefinement.ref_var-2313"><span class="linenos">2313</span></a>
</span><span id="CenterRefinement.ref_var-2314"><a href="#CenterRefinement.ref_var-2314"><span class="linenos">2314</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement.ref_var-2315"><a href="#CenterRefinement.ref_var-2315"><span class="linenos">2315</span></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2316"><a href="#CenterRefinement.ref_var-2316"><span class="linenos">2316</span></a>        <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2317"><a href="#CenterRefinement.ref_var-2317"><span class="linenos">2317</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-2318"><a href="#CenterRefinement.ref_var-2318"><span class="linenos">2318</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2319"><a href="#CenterRefinement.ref_var-2319"><span class="linenos">2319</span></a>    
</span><span id="CenterRefinement.ref_var-2320"><a href="#CenterRefinement.ref_var-2320"><span class="linenos">2320</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement.ref_var-2321"><a href="#CenterRefinement.ref_var-2321"><span class="linenos">2321</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement.ref_var-2322"><a href="#CenterRefinement.ref_var-2322"><span class="linenos">2322</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement.ref_var-2323"><a href="#CenterRefinement.ref_var-2323"><span class="linenos">2323</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">min_intensity_var</span>
</span><span id="CenterRefinement.ref_var-2324"><a href="#CenterRefinement.ref_var-2324"><span class="linenos">2324</span></a>        
</span><span id="CenterRefinement.ref_var-2325"><a href="#CenterRefinement.ref_var-2325"><span class="linenos">2325</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement.ref_var-2326"><a href="#CenterRefinement.ref_var-2326"><span class="linenos">2326</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="CenterRefinement.ref_var-2327"><a href="#CenterRefinement.ref_var-2327"><span class="linenos">2327</span></a>        
</span><span id="CenterRefinement.ref_var-2328"><a href="#CenterRefinement.ref_var-2328"><span class="linenos">2328</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement.ref_var-2329"><a href="#CenterRefinement.ref_var-2329"><span class="linenos">2329</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement.ref_var-2330"><a href="#CenterRefinement.ref_var-2330"><span class="linenos">2330</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement.ref_var-2331"><a href="#CenterRefinement.ref_var-2331"><span class="linenos">2331</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement.ref_var-2332"><a href="#CenterRefinement.ref_var-2332"><span class="linenos">2332</span></a>    
</span><span id="CenterRefinement.ref_var-2333"><a href="#CenterRefinement.ref_var-2333"><span class="linenos">2333</span></a>    
</span><span id="CenterRefinement.ref_var-2334"><a href="#CenterRefinement.ref_var-2334"><span class="linenos">2334</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement.ref_var-2335"><a href="#CenterRefinement.ref_var-2335"><span class="linenos">2335</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement.ref_var-2336"><a href="#CenterRefinement.ref_var-2336"><span class="linenos">2336</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="CenterRefinement.ref_var-2337"><a href="#CenterRefinement.ref_var-2337"><span class="linenos">2337</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-2338"><a href="#CenterRefinement.ref_var-2338"><span class="linenos">2338</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2339"><a href="#CenterRefinement.ref_var-2339"><span class="linenos">2339</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_var-2340"><a href="#CenterRefinement.ref_var-2340"><span class="linenos">2340</span></a>        
</span><span id="CenterRefinement.ref_var-2341"><a href="#CenterRefinement.ref_var-2341"><span class="linenos">2341</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement.ref_var-2342"><a href="#CenterRefinement.ref_var-2342"><span class="linenos">2342</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement.ref_var-2343"><a href="#CenterRefinement.ref_var-2343"><span class="linenos">2343</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_var-2344"><a href="#CenterRefinement.ref_var-2344"><span class="linenos">2344</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-2345"><a href="#CenterRefinement.ref_var-2345"><span class="linenos">2345</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-2346"><a href="#CenterRefinement.ref_var-2346"><span class="linenos">2346</span></a>                                      <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement.ref_var-2347"><a href="#CenterRefinement.ref_var-2347"><span class="linenos">2347</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement.ref_var-2348"><a href="#CenterRefinement.ref_var-2348"><span class="linenos">2348</span></a>            <span class="n">curr_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_var-2349"><a href="#CenterRefinement.ref_var-2349"><span class="linenos">2349</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-2350"><a href="#CenterRefinement.ref_var-2350"><span class="linenos">2350</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement.ref_var-2351"><a href="#CenterRefinement.ref_var-2351"><span class="linenos">2351</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement.ref_var-2352"><a href="#CenterRefinement.ref_var-2352"><span class="linenos">2352</span></a>                <span class="n">curr_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="CenterRefinement.ref_var-2353"><a href="#CenterRefinement.ref_var-2353"><span class="linenos">2353</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_variance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-2354"><a href="#CenterRefinement.ref_var-2354"><span class="linenos">2354</span></a>            
</span><span id="CenterRefinement.ref_var-2355"><a href="#CenterRefinement.ref_var-2355"><span class="linenos">2355</span></a>            <span class="c1"># Find the minimum value coordinates within curr_intensity_var</span>
</span><span id="CenterRefinement.ref_var-2356"><a href="#CenterRefinement.ref_var-2356"><span class="linenos">2356</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_var-2357"><a href="#CenterRefinement.ref_var-2357"><span class="linenos">2357</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_var-2358"><a href="#CenterRefinement.ref_var-2358"><span class="linenos">2358</span></a>                    
</span><span id="CenterRefinement.ref_var-2359"><a href="#CenterRefinement.ref_var-2359"><span class="linenos">2359</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="CenterRefinement.ref_var-2360"><a href="#CenterRefinement.ref_var-2360"><span class="linenos">2360</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="CenterRefinement.ref_var-2361"><a href="#CenterRefinement.ref_var-2361"><span class="linenos">2361</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement.ref_var-2362"><a href="#CenterRefinement.ref_var-2362"><span class="linenos">2362</span></a>            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_intensity_var</span><span class="p">:</span>                           
</span><span id="CenterRefinement.ref_var-2363"><a href="#CenterRefinement.ref_var-2363"><span class="linenos">2363</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2364"><a href="#CenterRefinement.ref_var-2364"><span class="linenos">2364</span></a>                
</span><span id="CenterRefinement.ref_var-2365"><a href="#CenterRefinement.ref_var-2365"><span class="linenos">2365</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement.ref_var-2366"><a href="#CenterRefinement.ref_var-2366"><span class="linenos">2366</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_var-2367"><a href="#CenterRefinement.ref_var-2367"><span class="linenos">2367</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement.ref_var-2368"><a href="#CenterRefinement.ref_var-2368"><span class="linenos">2368</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-2369"><a href="#CenterRefinement.ref_var-2369"><span class="linenos">2369</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-2370"><a href="#CenterRefinement.ref_var-2370"><span class="linenos">2370</span></a>                
</span><span id="CenterRefinement.ref_var-2371"><a href="#CenterRefinement.ref_var-2371"><span class="linenos">2371</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement.ref_var-2372"><a href="#CenterRefinement.ref_var-2372"><span class="linenos">2372</span></a>            <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_var</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_var-2373"><a href="#CenterRefinement.ref_var-2373"><span class="linenos">2373</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-2374"><a href="#CenterRefinement.ref_var-2374"><span class="linenos">2374</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-2375"><a href="#CenterRefinement.ref_var-2375"><span class="linenos">2375</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span> 
</span><span id="CenterRefinement.ref_var-2376"><a href="#CenterRefinement.ref_var-2376"><span class="linenos">2376</span></a>            
</span><span id="CenterRefinement.ref_var-2377"><a href="#CenterRefinement.ref_var-2377"><span class="linenos">2377</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement.ref_var-2378"><a href="#CenterRefinement.ref_var-2378"><span class="linenos">2378</span></a>            <span class="c1"># constant. It iterates through different radius adjustments to find</span>
</span><span id="CenterRefinement.ref_var-2379"><a href="#CenterRefinement.ref_var-2379"><span class="linenos">2379</span></a>            <span class="c1"># a radius that maximizes the intensity sum of pixels</span>
</span><span id="CenterRefinement.ref_var-2380"><a href="#CenterRefinement.ref_var-2380"><span class="linenos">2380</span></a>            
</span><span id="CenterRefinement.ref_var-2381"><a href="#CenterRefinement.ref_var-2381"><span class="linenos">2381</span></a>            <span class="n">radi_intensity_var</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_var-2382"><a href="#CenterRefinement.ref_var-2382"><span class="linenos">2382</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2383"><a href="#CenterRefinement.ref_var-2383"><span class="linenos">2383</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-2384"><a href="#CenterRefinement.ref_var-2384"><span class="linenos">2384</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement.ref_var-2385"><a href="#CenterRefinement.ref_var-2385"><span class="linenos">2385</span></a>                <span class="n">radi_intensity_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_var</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_var-2386"><a href="#CenterRefinement.ref_var-2386"><span class="linenos">2386</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-2387"><a href="#CenterRefinement.ref_var-2387"><span class="linenos">2387</span></a>                                                             <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_var-2388"><a href="#CenterRefinement.ref_var-2388"><span class="linenos">2388</span></a>                                                             <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_var-2389"><a href="#CenterRefinement.ref_var-2389"><span class="linenos">2389</span></a>                
</span><span id="CenterRefinement.ref_var-2390"><a href="#CenterRefinement.ref_var-2390"><span class="linenos">2390</span></a>            <span class="c1"># Find the minimum value coordinates within curr_var</span>
</span><span id="CenterRefinement.ref_var-2391"><a href="#CenterRefinement.ref_var-2391"><span class="linenos">2391</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_var-2392"><a href="#CenterRefinement.ref_var-2392"><span class="linenos">2392</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_var-2393"><a href="#CenterRefinement.ref_var-2393"><span class="linenos">2393</span></a>            
</span><span id="CenterRefinement.ref_var-2394"><a href="#CenterRefinement.ref_var-2394"><span class="linenos">2394</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement.ref_var-2395"><a href="#CenterRefinement.ref_var-2395"><span class="linenos">2395</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_intensity_var</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-2396"><a href="#CenterRefinement.ref_var-2396"><span class="linenos">2396</span></a>                <span class="n">min_intensity_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_var</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2397"><a href="#CenterRefinement.ref_var-2397"><span class="linenos">2397</span></a>                
</span><span id="CenterRefinement.ref_var-2398"><a href="#CenterRefinement.ref_var-2398"><span class="linenos">2398</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_var-2399"><a href="#CenterRefinement.ref_var-2399"><span class="linenos">2399</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement.ref_var-2400"><a href="#CenterRefinement.ref_var-2400"><span class="linenos">2400</span></a>                
</span><span id="CenterRefinement.ref_var-2401"><a href="#CenterRefinement.ref_var-2401"><span class="linenos">2401</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2402"><a href="#CenterRefinement.ref_var-2402"><span class="linenos">2402</span></a>
</span><span id="CenterRefinement.ref_var-2403"><a href="#CenterRefinement.ref_var-2403"><span class="linenos">2403</span></a>            
</span><span id="CenterRefinement.ref_var-2404"><a href="#CenterRefinement.ref_var-2404"><span class="linenos">2404</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement.ref_var-2405"><a href="#CenterRefinement.ref_var-2405"><span class="linenos">2405</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_intensity_var</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2406"><a href="#CenterRefinement.ref_var-2406"><span class="linenos">2406</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-2407"><a href="#CenterRefinement.ref_var-2407"><span class="linenos">2407</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement.ref_var-2408"><a href="#CenterRefinement.ref_var-2408"><span class="linenos">2408</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_var-2409"><a href="#CenterRefinement.ref_var-2409"><span class="linenos">2409</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement.ref_var-2410"><a href="#CenterRefinement.ref_var-2410"><span class="linenos">2410</span></a>        
</span><span id="CenterRefinement.ref_var-2411"><a href="#CenterRefinement.ref_var-2411"><span class="linenos">2411</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement.ref_var-2412"><a href="#CenterRefinement.ref_var-2412"><span class="linenos">2412</span></a>        <span class="c1">## (1) swapped coordinates</span>
</span><span id="CenterRefinement.ref_var-2413"><a href="#CenterRefinement.ref_var-2413"><span class="linenos">2413</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_var-2414"><a href="#CenterRefinement.ref_var-2414"><span class="linenos">2414</span></a>            <span class="ow">or</span>  <span class="p">(</span><span class="n">bckup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bckup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="CenterRefinement.ref_var-2415"><a href="#CenterRefinement.ref_var-2415"><span class="linenos">2415</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_var-2416"><a href="#CenterRefinement.ref_var-2416"><span class="linenos">2416</span></a>        
</span><span id="CenterRefinement.ref_var-2417"><a href="#CenterRefinement.ref_var-2417"><span class="linenos">2417</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement.ref_var-2418"><a href="#CenterRefinement.ref_var-2418"><span class="linenos">2418</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_intensity_var</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_var-2419"><a href="#CenterRefinement.ref_var-2419"><span class="linenos">2419</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2420"><a href="#CenterRefinement.ref_var-2420"><span class="linenos">2420</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_var-2421"><a href="#CenterRefinement.ref_var-2421"><span class="linenos">2421</span></a>    
</span><span id="CenterRefinement.ref_var-2422"><a href="#CenterRefinement.ref_var-2422"><span class="linenos">2422</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement.ref_var-2423"><a href="#CenterRefinement.ref_var-2423"><span class="linenos">2423</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_var-2424"><a href="#CenterRefinement.ref_var-2424"><span class="linenos">2424</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> <span class="s2">&quot;Center Refinement (IntensityVar)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement.ref_var-2425"><a href="#CenterRefinement.ref_var-2425"><span class="linenos">2425</span></a>                                  
</span><span id="CenterRefinement.ref_var-2426"><a href="#CenterRefinement.ref_var-2426"><span class="linenos">2426</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span></pre></div>


            <div class="docstring"><p>Adjust center coordinates of a detected circular diffraction pattern.
The center adjustment is based on variance minimization.</p>

<p>The 8-neighbourhood pixels (x) of the current center (o) 
will be tested regarding the minimization:</p>

<ul>
<li><p>x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</p></li>
<li><p>x o x : (px - dx, py)      (px, py)      (px + dx, py)</p></li>
<li><p>x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</p></li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>self.image</strong> (array of uint8):
Input image in which the diffraction pattern is to be found</li>
<li><strong>px</strong> (float64):
x-coordinate of the detected center to be adjusted</li>
<li><strong>py</strong> (float64):
y-coordinate of the detected center to be adjusted</li>
<li><strong>pr</strong> (float64):
radius of the detected center</li>
<li><strong>plot_results</strong> (integer (default = 1)):
Plot Detected center. The default is 1.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>px</strong> (array of int32):
corrected x-coordinates of pixels from circle border</li>
<li><strong>py</strong> (array of int32):
corrected y-coordinates of pixels from circle border</li>
<li><strong>pr</strong> (array of int32):
radius of the detected center</li>
</ul>
</div>


                            </div>
                            <div id="CenterRefinement.ref_sum" class="classattr">
                                        <input id="CenterRefinement.ref_sum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ref_sum</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">px</span>, </span><span class="param"><span class="n">py</span>, </span><span class="param"><span class="n">pr</span>, </span><span class="param"><span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CenterRefinement.ref_sum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CenterRefinement.ref_sum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CenterRefinement.ref_sum-2429"><a href="#CenterRefinement.ref_sum-2429"><span class="linenos">2429</span></a>    <span class="k">def</span> <span class="nf">ref_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_sum-2430"><a href="#CenterRefinement.ref_sum-2430"><span class="linenos">2430</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="CenterRefinement.ref_sum-2431"><a href="#CenterRefinement.ref_sum-2431"><span class="linenos">2431</span></a><span class="sd">        Adjust center position based on gradient optimization method</span>
</span><span id="CenterRefinement.ref_sum-2432"><a href="#CenterRefinement.ref_sum-2432"><span class="linenos">2432</span></a><span class="sd">        via maximization of intensity sum.</span>
</span><span id="CenterRefinement.ref_sum-2433"><a href="#CenterRefinement.ref_sum-2433"><span class="linenos">2433</span></a><span class="sd">        </span>
</span><span id="CenterRefinement.ref_sum-2434"><a href="#CenterRefinement.ref_sum-2434"><span class="linenos">2434</span></a><span class="sd">        The 8-neighbourhood pixels (x) of the current center (o) </span>
</span><span id="CenterRefinement.ref_sum-2435"><a href="#CenterRefinement.ref_sum-2435"><span class="linenos">2435</span></a><span class="sd">        will be tested regarding the maximization:</span>
</span><span id="CenterRefinement.ref_sum-2436"><a href="#CenterRefinement.ref_sum-2436"><span class="linenos">2436</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_sum-2437"><a href="#CenterRefinement.ref_sum-2437"><span class="linenos">2437</span></a><span class="sd">        - x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</span>
</span><span id="CenterRefinement.ref_sum-2438"><a href="#CenterRefinement.ref_sum-2438"><span class="linenos">2438</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_sum-2439"><a href="#CenterRefinement.ref_sum-2439"><span class="linenos">2439</span></a><span class="sd">        - x o x : (px - dx, py)      (px, py)      (px + dx, py)</span>
</span><span id="CenterRefinement.ref_sum-2440"><a href="#CenterRefinement.ref_sum-2440"><span class="linenos">2440</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_sum-2441"><a href="#CenterRefinement.ref_sum-2441"><span class="linenos">2441</span></a><span class="sd">        - x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</span>
</span><span id="CenterRefinement.ref_sum-2442"><a href="#CenterRefinement.ref_sum-2442"><span class="linenos">2442</span></a><span class="sd">        </span>
</span><span id="CenterRefinement.ref_sum-2443"><a href="#CenterRefinement.ref_sum-2443"><span class="linenos">2443</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_sum-2444"><a href="#CenterRefinement.ref_sum-2444"><span class="linenos">2444</span></a><span class="sd">        Parameters</span>
</span><span id="CenterRefinement.ref_sum-2445"><a href="#CenterRefinement.ref_sum-2445"><span class="linenos">2445</span></a><span class="sd">        ----------</span>
</span><span id="CenterRefinement.ref_sum-2446"><a href="#CenterRefinement.ref_sum-2446"><span class="linenos">2446</span></a><span class="sd">        px : float64</span>
</span><span id="CenterRefinement.ref_sum-2447"><a href="#CenterRefinement.ref_sum-2447"><span class="linenos">2447</span></a><span class="sd">            x-coordinate of the detected center to be adjusted.</span>
</span><span id="CenterRefinement.ref_sum-2448"><a href="#CenterRefinement.ref_sum-2448"><span class="linenos">2448</span></a><span class="sd">        py : float64</span>
</span><span id="CenterRefinement.ref_sum-2449"><a href="#CenterRefinement.ref_sum-2449"><span class="linenos">2449</span></a><span class="sd">            y-coordinate of the detected center to be adjusted.</span>
</span><span id="CenterRefinement.ref_sum-2450"><a href="#CenterRefinement.ref_sum-2450"><span class="linenos">2450</span></a><span class="sd">        pr : float64</span>
</span><span id="CenterRefinement.ref_sum-2451"><a href="#CenterRefinement.ref_sum-2451"><span class="linenos">2451</span></a><span class="sd">            radius of the detected center.</span>
</span><span id="CenterRefinement.ref_sum-2452"><a href="#CenterRefinement.ref_sum-2452"><span class="linenos">2452</span></a><span class="sd">        plot_results : int, optional</span>
</span><span id="CenterRefinement.ref_sum-2453"><a href="#CenterRefinement.ref_sum-2453"><span class="linenos">2453</span></a><span class="sd">            Plot Detected center. </span>
</span><span id="CenterRefinement.ref_sum-2454"><a href="#CenterRefinement.ref_sum-2454"><span class="linenos">2454</span></a><span class="sd">            The default is 1.</span>
</span><span id="CenterRefinement.ref_sum-2455"><a href="#CenterRefinement.ref_sum-2455"><span class="linenos">2455</span></a><span class="sd">    </span>
</span><span id="CenterRefinement.ref_sum-2456"><a href="#CenterRefinement.ref_sum-2456"><span class="linenos">2456</span></a><span class="sd">        Returns  </span>
</span><span id="CenterRefinement.ref_sum-2457"><a href="#CenterRefinement.ref_sum-2457"><span class="linenos">2457</span></a><span class="sd">        -------</span>
</span><span id="CenterRefinement.ref_sum-2458"><a href="#CenterRefinement.ref_sum-2458"><span class="linenos">2458</span></a><span class="sd">        best_center[0] : float64</span>
</span><span id="CenterRefinement.ref_sum-2459"><a href="#CenterRefinement.ref_sum-2459"><span class="linenos">2459</span></a><span class="sd">            Adjusted x-coordinate of the center.</span>
</span><span id="CenterRefinement.ref_sum-2460"><a href="#CenterRefinement.ref_sum-2460"><span class="linenos">2460</span></a><span class="sd">        best_center[1] : float64</span>
</span><span id="CenterRefinement.ref_sum-2461"><a href="#CenterRefinement.ref_sum-2461"><span class="linenos">2461</span></a><span class="sd">            Adjusted y-coordinate of the center.</span>
</span><span id="CenterRefinement.ref_sum-2462"><a href="#CenterRefinement.ref_sum-2462"><span class="linenos">2462</span></a><span class="sd">        best_radius : float64</span>
</span><span id="CenterRefinement.ref_sum-2463"><a href="#CenterRefinement.ref_sum-2463"><span class="linenos">2463</span></a><span class="sd">            The adjusted radius of the circular diffraction pattern.</span>
</span><span id="CenterRefinement.ref_sum-2464"><a href="#CenterRefinement.ref_sum-2464"><span class="linenos">2464</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="CenterRefinement.ref_sum-2465"><a href="#CenterRefinement.ref_sum-2465"><span class="linenos">2465</span></a>        <span class="c1"># Store input for plot via self.visualize_refinement()</span>
</span><span id="CenterRefinement.ref_sum-2466"><a href="#CenterRefinement.ref_sum-2466"><span class="linenos">2466</span></a>        <span class="n">bckup</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_sum-2467"><a href="#CenterRefinement.ref_sum-2467"><span class="linenos">2467</span></a>
</span><span id="CenterRefinement.ref_sum-2468"><a href="#CenterRefinement.ref_sum-2468"><span class="linenos">2468</span></a>        <span class="c1"># Image in which the center is refined</span>
</span><span id="CenterRefinement.ref_sum-2469"><a href="#CenterRefinement.ref_sum-2469"><span class="linenos">2469</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2470"><a href="#CenterRefinement.ref_sum-2470"><span class="linenos">2470</span></a>
</span><span id="CenterRefinement.ref_sum-2471"><a href="#CenterRefinement.ref_sum-2471"><span class="linenos">2471</span></a>        <span class="c1"># Starting values to be modified </span>
</span><span id="CenterRefinement.ref_sum-2472"><a href="#CenterRefinement.ref_sum-2472"><span class="linenos">2472</span></a>        <span class="n">init_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2473"><a href="#CenterRefinement.ref_sum-2473"><span class="linenos">2473</span></a>        <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2474"><a href="#CenterRefinement.ref_sum-2474"><span class="linenos">2474</span></a>        <span class="n">best_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">py</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-2475"><a href="#CenterRefinement.ref_sum-2475"><span class="linenos">2475</span></a>        <span class="n">best_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2476"><a href="#CenterRefinement.ref_sum-2476"><span class="linenos">2476</span></a>        
</span><span id="CenterRefinement.ref_sum-2477"><a href="#CenterRefinement.ref_sum-2477"><span class="linenos">2477</span></a>        <span class="c1"># Convergence criterion for termination of gradient optimization </span>
</span><span id="CenterRefinement.ref_sum-2478"><a href="#CenterRefinement.ref_sum-2478"><span class="linenos">2478</span></a>        <span class="c1"># (1) small positive value that serves as a threshold to determine </span>
</span><span id="CenterRefinement.ref_sum-2479"><a href="#CenterRefinement.ref_sum-2479"><span class="linenos">2479</span></a>        <span class="c1">#     when the optimization process has converged</span>
</span><span id="CenterRefinement.ref_sum-2480"><a href="#CenterRefinement.ref_sum-2480"><span class="linenos">2480</span></a>        <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">max_intensity_sum</span>
</span><span id="CenterRefinement.ref_sum-2481"><a href="#CenterRefinement.ref_sum-2481"><span class="linenos">2481</span></a>        
</span><span id="CenterRefinement.ref_sum-2482"><a href="#CenterRefinement.ref_sum-2482"><span class="linenos">2482</span></a>        <span class="c1"># (2) maximum number of iterations of optimization</span>
</span><span id="CenterRefinement.ref_sum-2483"><a href="#CenterRefinement.ref_sum-2483"><span class="linenos">2483</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="CenterRefinement.ref_sum-2484"><a href="#CenterRefinement.ref_sum-2484"><span class="linenos">2484</span></a>        
</span><span id="CenterRefinement.ref_sum-2485"><a href="#CenterRefinement.ref_sum-2485"><span class="linenos">2485</span></a>        <span class="c1"># (3) keep track of the number of consecutive iterations where there </span>
</span><span id="CenterRefinement.ref_sum-2486"><a href="#CenterRefinement.ref_sum-2486"><span class="linenos">2486</span></a>        <span class="c1">#     is no improvement in the objective function beyond </span>
</span><span id="CenterRefinement.ref_sum-2487"><a href="#CenterRefinement.ref_sum-2487"><span class="linenos">2487</span></a>        <span class="c1">#     the convergence threshold</span>
</span><span id="CenterRefinement.ref_sum-2488"><a href="#CenterRefinement.ref_sum-2488"><span class="linenos">2488</span></a>        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CenterRefinement.ref_sum-2489"><a href="#CenterRefinement.ref_sum-2489"><span class="linenos">2489</span></a>         
</span><span id="CenterRefinement.ref_sum-2490"><a href="#CenterRefinement.ref_sum-2490"><span class="linenos">2490</span></a>        <span class="c1"># iterative refinement of the center of a circle while keeping</span>
</span><span id="CenterRefinement.ref_sum-2491"><a href="#CenterRefinement.ref_sum-2491"><span class="linenos">2491</span></a>        <span class="c1"># the radius constant.</span>
</span><span id="CenterRefinement.ref_sum-2492"><a href="#CenterRefinement.ref_sum-2492"><span class="linenos">2492</span></a>        <span class="n">step</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="CenterRefinement.ref_sum-2493"><a href="#CenterRefinement.ref_sum-2493"><span class="linenos">2493</span></a>        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-2494"><a href="#CenterRefinement.ref_sum-2494"><span class="linenos">2494</span></a>            <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2495"><a href="#CenterRefinement.ref_sum-2495"><span class="linenos">2495</span></a>            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
</span><span id="CenterRefinement.ref_sum-2496"><a href="#CenterRefinement.ref_sum-2496"><span class="linenos">2496</span></a>
</span><span id="CenterRefinement.ref_sum-2497"><a href="#CenterRefinement.ref_sum-2497"><span class="linenos">2497</span></a>        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>    
</span><span id="CenterRefinement.ref_sum-2498"><a href="#CenterRefinement.ref_sum-2498"><span class="linenos">2498</span></a>            <span class="c1"># Refine center while keeping radius constant</span>
</span><span id="CenterRefinement.ref_sum-2499"><a href="#CenterRefinement.ref_sum-2499"><span class="linenos">2499</span></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-2500"><a href="#CenterRefinement.ref_sum-2500"><span class="linenos">2500</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-2501"><a href="#CenterRefinement.ref_sum-2501"><span class="linenos">2501</span></a>                                      <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-2502"><a href="#CenterRefinement.ref_sum-2502"><span class="linenos">2502</span></a>                                      <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2503"><a href="#CenterRefinement.ref_sum-2503"><span class="linenos">2503</span></a>            
</span><span id="CenterRefinement.ref_sum-2504"><a href="#CenterRefinement.ref_sum-2504"><span class="linenos">2504</span></a>            <span class="c1"># Store intensity sums of the current center&#39;s neighborhood</span>
</span><span id="CenterRefinement.ref_sum-2505"><a href="#CenterRefinement.ref_sum-2505"><span class="linenos">2505</span></a>            <span class="n">curr_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_sum-2506"><a href="#CenterRefinement.ref_sum-2506"><span class="linenos">2506</span></a>            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-2507"><a href="#CenterRefinement.ref_sum-2507"><span class="linenos">2507</span></a>                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span>
</span><span id="CenterRefinement.ref_sum-2508"><a href="#CenterRefinement.ref_sum-2508"><span class="linenos">2508</span></a>                <span class="c1"># Check if the point is within the expanded search radius</span>
</span><span id="CenterRefinement.ref_sum-2509"><a href="#CenterRefinement.ref_sum-2509"><span class="linenos">2509</span></a>                <span class="n">curr_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-2510"><a href="#CenterRefinement.ref_sum-2510"><span class="linenos">2510</span></a>                                                        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-2511"><a href="#CenterRefinement.ref_sum-2511"><span class="linenos">2511</span></a>                                                        <span class="n">best_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-2512"><a href="#CenterRefinement.ref_sum-2512"><span class="linenos">2512</span></a>            
</span><span id="CenterRefinement.ref_sum-2513"><a href="#CenterRefinement.ref_sum-2513"><span class="linenos">2513</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement.ref_sum-2514"><a href="#CenterRefinement.ref_sum-2514"><span class="linenos">2514</span></a>            <span class="n">cx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_sum-2515"><a href="#CenterRefinement.ref_sum-2515"><span class="linenos">2515</span></a>                                     <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_sum-2516"><a href="#CenterRefinement.ref_sum-2516"><span class="linenos">2516</span></a>                    
</span><span id="CenterRefinement.ref_sum-2517"><a href="#CenterRefinement.ref_sum-2517"><span class="linenos">2517</span></a>            <span class="c1"># Check for improvement of criterion -- in each iteration just once,</span>
</span><span id="CenterRefinement.ref_sum-2518"><a href="#CenterRefinement.ref_sum-2518"><span class="linenos">2518</span></a>            <span class="c1"># as the algorithm checks the neighbourhood of the best center (in</span>
</span><span id="CenterRefinement.ref_sum-2519"><a href="#CenterRefinement.ref_sum-2519"><span class="linenos">2519</span></a>            <span class="c1"># each iteration, the center is updated if possible)</span>
</span><span id="CenterRefinement.ref_sum-2520"><a href="#CenterRefinement.ref_sum-2520"><span class="linenos">2520</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>                           
</span><span id="CenterRefinement.ref_sum-2521"><a href="#CenterRefinement.ref_sum-2521"><span class="linenos">2521</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2522"><a href="#CenterRefinement.ref_sum-2522"><span class="linenos">2522</span></a>                
</span><span id="CenterRefinement.ref_sum-2523"><a href="#CenterRefinement.ref_sum-2523"><span class="linenos">2523</span></a>                <span class="c1"># Calculate the new best coordinates of the center</span>
</span><span id="CenterRefinement.ref_sum-2524"><a href="#CenterRefinement.ref_sum-2524"><span class="linenos">2524</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_sum-2525"><a href="#CenterRefinement.ref_sum-2525"><span class="linenos">2525</span></a>                <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> 
</span><span id="CenterRefinement.ref_sum-2526"><a href="#CenterRefinement.ref_sum-2526"><span class="linenos">2526</span></a>                                     <span class="n">best_center</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-2527"><a href="#CenterRefinement.ref_sum-2527"><span class="linenos">2527</span></a>                <span class="n">best_center</span> <span class="o">=</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-2528"><a href="#CenterRefinement.ref_sum-2528"><span class="linenos">2528</span></a>    
</span><span id="CenterRefinement.ref_sum-2529"><a href="#CenterRefinement.ref_sum-2529"><span class="linenos">2529</span></a>            <span class="c1"># Update maximum intensity sum </span>
</span><span id="CenterRefinement.ref_sum-2530"><a href="#CenterRefinement.ref_sum-2530"><span class="linenos">2530</span></a>            <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-2531"><a href="#CenterRefinement.ref_sum-2531"><span class="linenos">2531</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-2532"><a href="#CenterRefinement.ref_sum-2532"><span class="linenos">2532</span></a>                                                    <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-2533"><a href="#CenterRefinement.ref_sum-2533"><span class="linenos">2533</span></a>                                                    <span class="n">best_radius</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2534"><a href="#CenterRefinement.ref_sum-2534"><span class="linenos">2534</span></a>
</span><span id="CenterRefinement.ref_sum-2535"><a href="#CenterRefinement.ref_sum-2535"><span class="linenos">2535</span></a>        
</span><span id="CenterRefinement.ref_sum-2536"><a href="#CenterRefinement.ref_sum-2536"><span class="linenos">2536</span></a>            <span class="c1"># Refine radius if necessary while keeping the center position </span>
</span><span id="CenterRefinement.ref_sum-2537"><a href="#CenterRefinement.ref_sum-2537"><span class="linenos">2537</span></a>            <span class="c1"># constant. It iterates through different radius adjustments to find</span>
</span><span id="CenterRefinement.ref_sum-2538"><a href="#CenterRefinement.ref_sum-2538"><span class="linenos">2538</span></a>            <span class="c1"># a radius that maximizes the intensity sum of pixels</span>
</span><span id="CenterRefinement.ref_sum-2539"><a href="#CenterRefinement.ref_sum-2539"><span class="linenos">2539</span></a>            
</span><span id="CenterRefinement.ref_sum-2540"><a href="#CenterRefinement.ref_sum-2540"><span class="linenos">2540</span></a>            <span class="n">radi_intensity_sum</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CenterRefinement.ref_sum-2541"><a href="#CenterRefinement.ref_sum-2541"><span class="linenos">2541</span></a>            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2542"><a href="#CenterRefinement.ref_sum-2542"><span class="linenos">2542</span></a>            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-2543"><a href="#CenterRefinement.ref_sum-2543"><span class="linenos">2543</span></a>                <span class="n">new_radius</span> <span class="o">=</span> <span class="n">best_radius</span> <span class="o">+</span> <span class="n">dr</span>
</span><span id="CenterRefinement.ref_sum-2544"><a href="#CenterRefinement.ref_sum-2544"><span class="linenos">2544</span></a>                <span class="n">radi_intensity_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">intensity_sum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> 
</span><span id="CenterRefinement.ref_sum-2545"><a href="#CenterRefinement.ref_sum-2545"><span class="linenos">2545</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-2546"><a href="#CenterRefinement.ref_sum-2546"><span class="linenos">2546</span></a>                                                            <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
</span><span id="CenterRefinement.ref_sum-2547"><a href="#CenterRefinement.ref_sum-2547"><span class="linenos">2547</span></a>                                                            <span class="n">new_radius</span><span class="p">))</span>
</span><span id="CenterRefinement.ref_sum-2548"><a href="#CenterRefinement.ref_sum-2548"><span class="linenos">2548</span></a>                
</span><span id="CenterRefinement.ref_sum-2549"><a href="#CenterRefinement.ref_sum-2549"><span class="linenos">2549</span></a>            <span class="c1"># Find the maximum value coordinates within curr_sum</span>
</span><span id="CenterRefinement.ref_sum-2550"><a href="#CenterRefinement.ref_sum-2550"><span class="linenos">2550</span></a>            <span class="n">rx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span>
</span><span id="CenterRefinement.ref_sum-2551"><a href="#CenterRefinement.ref_sum-2551"><span class="linenos">2551</span></a>                                      <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CenterRefinement.ref_sum-2552"><a href="#CenterRefinement.ref_sum-2552"><span class="linenos">2552</span></a>
</span><span id="CenterRefinement.ref_sum-2553"><a href="#CenterRefinement.ref_sum-2553"><span class="linenos">2553</span></a>            <span class="c1"># Check for improvement of criterion</span>
</span><span id="CenterRefinement.ref_sum-2554"><a href="#CenterRefinement.ref_sum-2554"><span class="linenos">2554</span></a>            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_intensity_sum</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-2555"><a href="#CenterRefinement.ref_sum-2555"><span class="linenos">2555</span></a>                <span class="n">max_intensity_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radi_intensity_sum</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2556"><a href="#CenterRefinement.ref_sum-2556"><span class="linenos">2556</span></a>                
</span><span id="CenterRefinement.ref_sum-2557"><a href="#CenterRefinement.ref_sum-2557"><span class="linenos">2557</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span>
</span><span id="CenterRefinement.ref_sum-2558"><a href="#CenterRefinement.ref_sum-2558"><span class="linenos">2558</span></a>                <span class="n">nr</span> <span class="o">=</span> <span class="n">best_radius</span><span class="o">+</span><span class="n">n</span>
</span><span id="CenterRefinement.ref_sum-2559"><a href="#CenterRefinement.ref_sum-2559"><span class="linenos">2559</span></a>                
</span><span id="CenterRefinement.ref_sum-2560"><a href="#CenterRefinement.ref_sum-2560"><span class="linenos">2560</span></a>                <span class="n">best_radius</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2561"><a href="#CenterRefinement.ref_sum-2561"><span class="linenos">2561</span></a>                
</span><span id="CenterRefinement.ref_sum-2562"><a href="#CenterRefinement.ref_sum-2562"><span class="linenos">2562</span></a>            
</span><span id="CenterRefinement.ref_sum-2563"><a href="#CenterRefinement.ref_sum-2563"><span class="linenos">2563</span></a>            <span class="c1"># Check for convergence and improvement (termination conditions)</span>
</span><span id="CenterRefinement.ref_sum-2564"><a href="#CenterRefinement.ref_sum-2564"><span class="linenos">2564</span></a>            <span class="n">impr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_intensity_sum</span> <span class="o">-</span> <span class="n">curr</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2565"><a href="#CenterRefinement.ref_sum-2565"><span class="linenos">2565</span></a>            <span class="k">if</span> <span class="n">impr</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-2566"><a href="#CenterRefinement.ref_sum-2566"><span class="linenos">2566</span></a>                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CenterRefinement.ref_sum-2567"><a href="#CenterRefinement.ref_sum-2567"><span class="linenos">2567</span></a>                <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
</span><span id="CenterRefinement.ref_sum-2568"><a href="#CenterRefinement.ref_sum-2568"><span class="linenos">2568</span></a>                    <span class="k">break</span>
</span><span id="CenterRefinement.ref_sum-2569"><a href="#CenterRefinement.ref_sum-2569"><span class="linenos">2569</span></a>                
</span><span id="CenterRefinement.ref_sum-2570"><a href="#CenterRefinement.ref_sum-2570"><span class="linenos">2570</span></a>
</span><span id="CenterRefinement.ref_sum-2571"><a href="#CenterRefinement.ref_sum-2571"><span class="linenos">2571</span></a>        
</span><span id="CenterRefinement.ref_sum-2572"><a href="#CenterRefinement.ref_sum-2572"><span class="linenos">2572</span></a>        <span class="c1"># Avoid incorrect/redundant refinement</span>
</span><span id="CenterRefinement.ref_sum-2573"><a href="#CenterRefinement.ref_sum-2573"><span class="linenos">2573</span></a>        <span class="c1"># ## (1) swapped coordinates</span>
</span><span id="CenterRefinement.ref_sum-2574"><a href="#CenterRefinement.ref_sum-2574"><span class="linenos">2574</span></a>        <span class="c1"># if ((bckup[0] &gt; bckup[1] and not best_center[0] &gt; best_center[1])</span>
</span><span id="CenterRefinement.ref_sum-2575"><a href="#CenterRefinement.ref_sum-2575"><span class="linenos">2575</span></a>        <span class="c1">#     or  (bckup[0] &lt; bckup[1] and not best_center[0] &lt; best_center[1])):</span>
</span><span id="CenterRefinement.ref_sum-2576"><a href="#CenterRefinement.ref_sum-2576"><span class="linenos">2576</span></a>        <span class="c1">#     best_center = best_center[::-1]</span>
</span><span id="CenterRefinement.ref_sum-2577"><a href="#CenterRefinement.ref_sum-2577"><span class="linenos">2577</span></a>        
</span><span id="CenterRefinement.ref_sum-2578"><a href="#CenterRefinement.ref_sum-2578"><span class="linenos">2578</span></a>        <span class="c1">## (2) worsened final maximum intensity sum than the initial one</span>
</span><span id="CenterRefinement.ref_sum-2579"><a href="#CenterRefinement.ref_sum-2579"><span class="linenos">2579</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">init_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">max_intensity_sum</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_sum-2580"><a href="#CenterRefinement.ref_sum-2580"><span class="linenos">2580</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refinement redundant.&quot;</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2581"><a href="#CenterRefinement.ref_sum-2581"><span class="linenos">2581</span></a>            <span class="n">best_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bckup</span><span class="p">)</span>
</span><span id="CenterRefinement.ref_sum-2582"><a href="#CenterRefinement.ref_sum-2582"><span class="linenos">2582</span></a>    
</span><span id="CenterRefinement.ref_sum-2583"><a href="#CenterRefinement.ref_sum-2583"><span class="linenos">2583</span></a>        <span class="c1"># Print results</span>
</span><span id="CenterRefinement.ref_sum-2584"><a href="#CenterRefinement.ref_sum-2584"><span class="linenos">2584</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">messages</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">final_print</span><span class="p">):</span>
</span><span id="CenterRefinement.ref_sum-2585"><a href="#CenterRefinement.ref_sum-2585"><span class="linenos">2585</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rText</span> <span class="o">=</span> \
</span><span id="CenterRefinement.ref_sum-2586"><a href="#CenterRefinement.ref_sum-2586"><span class="linenos">2586</span></a>                <span class="s2">&quot;Center Refinement (IntensitySum)      : (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span>
</span><span id="CenterRefinement.ref_sum-2587"><a href="#CenterRefinement.ref_sum-2587"><span class="linenos">2587</span></a>                
</span><span id="CenterRefinement.ref_sum-2588"><a href="#CenterRefinement.ref_sum-2588"><span class="linenos">2588</span></a>        <span class="k">return</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_radius</span>
</span></pre></div>


            <div class="docstring"><p>Adjust center position based on gradient optimization method
via maximization of intensity sum.</p>

<p>The 8-neighbourhood pixels (x) of the current center (o) 
will be tested regarding the maximization:</p>

<ul>
<li><p>x x x : (px - dx, py + dy) (px, py + dy) ( px + dx, py + dy)</p></li>
<li><p>x o x : (px - dx, py)      (px, py)      (px + dx, py)</p></li>
<li><p>x x x : (px - dx, py - dy) (px, py - dy) (px + dx, py - dy)</p></li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>px</strong> (float64):
x-coordinate of the detected center to be adjusted.</li>
<li><strong>py</strong> (float64):
y-coordinate of the detected center to be adjusted.</li>
<li><strong>pr</strong> (float64):
radius of the detected center.</li>
<li><strong>plot_results</strong> (int, optional):
Plot Detected center. 
The default is 1.</li>
</ul>

<h6 id="returns">Returns</h6>

<p>best_center[0] : float64
    Adjusted x-coordinate of the center.
best_center[1] : float64
    Adjusted y-coordinate of the center.
best_radius : float64
    The adjusted radius of the circular diffraction pattern.</p>
</div>


                            </div>
                </section>
                <section id="HandlerCircle">
                            <input id="HandlerCircle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">HandlerCircle</span><wbr>(<span class="base">matplotlib.legend_handler.HandlerBase</span>):

                <label class="view-source-button" for="HandlerCircle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HandlerCircle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HandlerCircle-2592"><a href="#HandlerCircle-2592"><span class="linenos">2592</span></a><span class="k">class</span> <span class="nc">HandlerCircle</span><span class="p">(</span><span class="n">HandlerBase</span><span class="p">):</span>
</span><span id="HandlerCircle-2593"><a href="#HandlerCircle-2593"><span class="linenos">2593</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="HandlerCircle-2594"><a href="#HandlerCircle-2594"><span class="linenos">2594</span></a><span class="sd">    Helper class for creating circular markers in matplotlib legends.</span>
</span><span id="HandlerCircle-2595"><a href="#HandlerCircle-2595"><span class="linenos">2595</span></a>
</span><span id="HandlerCircle-2596"><a href="#HandlerCircle-2596"><span class="linenos">2596</span></a><span class="sd">    This class customizes the legend to display circular markers instead of the </span>
</span><span id="HandlerCircle-2597"><a href="#HandlerCircle-2597"><span class="linenos">2597</span></a><span class="sd">    default. It is intended for internal use within the module and not </span>
</span><span id="HandlerCircle-2598"><a href="#HandlerCircle-2598"><span class="linenos">2598</span></a><span class="sd">    for general use.</span>
</span><span id="HandlerCircle-2599"><a href="#HandlerCircle-2599"><span class="linenos">2599</span></a>
</span><span id="HandlerCircle-2600"><a href="#HandlerCircle-2600"><span class="linenos">2600</span></a><span class="sd">    Methods:</span>
</span><span id="HandlerCircle-2601"><a href="#HandlerCircle-2601"><span class="linenos">2601</span></a><span class="sd">    --------</span>
</span><span id="HandlerCircle-2602"><a href="#HandlerCircle-2602"><span class="linenos">2602</span></a><span class="sd">    create_artists(legend, </span>
</span><span id="HandlerCircle-2603"><a href="#HandlerCircle-2603"><span class="linenos">2603</span></a><span class="sd">                   orig_handle, </span>
</span><span id="HandlerCircle-2604"><a href="#HandlerCircle-2604"><span class="linenos">2604</span></a><span class="sd">                   xdescent,</span>
</span><span id="HandlerCircle-2605"><a href="#HandlerCircle-2605"><span class="linenos">2605</span></a><span class="sd">                   ydescent, </span>
</span><span id="HandlerCircle-2606"><a href="#HandlerCircle-2606"><span class="linenos">2606</span></a><span class="sd">                   width, </span>
</span><span id="HandlerCircle-2607"><a href="#HandlerCircle-2607"><span class="linenos">2607</span></a><span class="sd">                   height, </span>
</span><span id="HandlerCircle-2608"><a href="#HandlerCircle-2608"><span class="linenos">2608</span></a><span class="sd">                   fontsize, </span>
</span><span id="HandlerCircle-2609"><a href="#HandlerCircle-2609"><span class="linenos">2609</span></a><span class="sd">                   trans):</span>
</span><span id="HandlerCircle-2610"><a href="#HandlerCircle-2610"><span class="linenos">2610</span></a><span class="sd">        Creates a circular marker for the legend based on the original handle&#39;s </span>
</span><span id="HandlerCircle-2611"><a href="#HandlerCircle-2611"><span class="linenos">2611</span></a><span class="sd">        properties.</span>
</span><span id="HandlerCircle-2612"><a href="#HandlerCircle-2612"><span class="linenos">2612</span></a>
</span><span id="HandlerCircle-2613"><a href="#HandlerCircle-2613"><span class="linenos">2613</span></a><span class="sd">    Parameters for `create_artists`:</span>
</span><span id="HandlerCircle-2614"><a href="#HandlerCircle-2614"><span class="linenos">2614</span></a><span class="sd">        legend : matplotlib.legend.Legend</span>
</span><span id="HandlerCircle-2615"><a href="#HandlerCircle-2615"><span class="linenos">2615</span></a><span class="sd">            The legend instance where the custom marker will be used.</span>
</span><span id="HandlerCircle-2616"><a href="#HandlerCircle-2616"><span class="linenos">2616</span></a><span class="sd">        orig_handle : matplotlib.artist.Artist</span>
</span><span id="HandlerCircle-2617"><a href="#HandlerCircle-2617"><span class="linenos">2617</span></a><span class="sd">            The original handle containing the marker properties </span>
</span><span id="HandlerCircle-2618"><a href="#HandlerCircle-2618"><span class="linenos">2618</span></a><span class="sd">            (e.g., facecolor, edgecolor).</span>
</span><span id="HandlerCircle-2619"><a href="#HandlerCircle-2619"><span class="linenos">2619</span></a><span class="sd">        xdescent : float</span>
</span><span id="HandlerCircle-2620"><a href="#HandlerCircle-2620"><span class="linenos">2620</span></a><span class="sd">            Horizontal offset adjustment for the marker.</span>
</span><span id="HandlerCircle-2621"><a href="#HandlerCircle-2621"><span class="linenos">2621</span></a><span class="sd">        ydescent : float</span>
</span><span id="HandlerCircle-2622"><a href="#HandlerCircle-2622"><span class="linenos">2622</span></a><span class="sd">            Vertical offset adjustment for the marker.</span>
</span><span id="HandlerCircle-2623"><a href="#HandlerCircle-2623"><span class="linenos">2623</span></a><span class="sd">        width : float</span>
</span><span id="HandlerCircle-2624"><a href="#HandlerCircle-2624"><span class="linenos">2624</span></a><span class="sd">            Width of the legend entry.</span>
</span><span id="HandlerCircle-2625"><a href="#HandlerCircle-2625"><span class="linenos">2625</span></a><span class="sd">        height : float</span>
</span><span id="HandlerCircle-2626"><a href="#HandlerCircle-2626"><span class="linenos">2626</span></a><span class="sd">            Height of the legend entry.</span>
</span><span id="HandlerCircle-2627"><a href="#HandlerCircle-2627"><span class="linenos">2627</span></a><span class="sd">        fontsize : float</span>
</span><span id="HandlerCircle-2628"><a href="#HandlerCircle-2628"><span class="linenos">2628</span></a><span class="sd">            Font size of the legend text.</span>
</span><span id="HandlerCircle-2629"><a href="#HandlerCircle-2629"><span class="linenos">2629</span></a><span class="sd">        trans : matplotlib.transforms.Transform</span>
</span><span id="HandlerCircle-2630"><a href="#HandlerCircle-2630"><span class="linenos">2630</span></a><span class="sd">            Transformation applied to the marker&#39;s coordinates.</span>
</span><span id="HandlerCircle-2631"><a href="#HandlerCircle-2631"><span class="linenos">2631</span></a>
</span><span id="HandlerCircle-2632"><a href="#HandlerCircle-2632"><span class="linenos">2632</span></a><span class="sd">    Returns:</span>
</span><span id="HandlerCircle-2633"><a href="#HandlerCircle-2633"><span class="linenos">2633</span></a><span class="sd">    --------</span>
</span><span id="HandlerCircle-2634"><a href="#HandlerCircle-2634"><span class="linenos">2634</span></a><span class="sd">    list of matplotlib.patches.Circle</span>
</span><span id="HandlerCircle-2635"><a href="#HandlerCircle-2635"><span class="linenos">2635</span></a><span class="sd">        A list containing a single circular marker artist.</span>
</span><span id="HandlerCircle-2636"><a href="#HandlerCircle-2636"><span class="linenos">2636</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="HandlerCircle-2637"><a href="#HandlerCircle-2637"><span class="linenos">2637</span></a>
</span><span id="HandlerCircle-2638"><a href="#HandlerCircle-2638"><span class="linenos">2638</span></a>    <span class="k">def</span> <span class="nf">create_artists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">,</span> <span class="n">xdescent</span><span class="p">,</span> <span class="n">ydescent</span><span class="p">,</span> 
</span><span id="HandlerCircle-2639"><a href="#HandlerCircle-2639"><span class="linenos">2639</span></a>                       <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
</span><span id="HandlerCircle-2640"><a href="#HandlerCircle-2640"><span class="linenos">2640</span></a>        <span class="c1"># Calculate the center and radius of the circle</span>
</span><span id="HandlerCircle-2641"><a href="#HandlerCircle-2641"><span class="linenos">2641</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle-2642"><a href="#HandlerCircle-2642"><span class="linenos">2642</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle-2643"><a href="#HandlerCircle-2643"><span class="linenos">2643</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle-2644"><a href="#HandlerCircle-2644"><span class="linenos">2644</span></a>
</span><span id="HandlerCircle-2645"><a href="#HandlerCircle-2645"><span class="linenos">2645</span></a>        <span class="c1"># Create a circular marker using the properties of the original handle</span>
</span><span id="HandlerCircle-2646"><a href="#HandlerCircle-2646"><span class="linenos">2646</span></a>        <span class="n">marker</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span>
</span><span id="HandlerCircle-2647"><a href="#HandlerCircle-2647"><span class="linenos">2647</span></a>                        <span class="n">facecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle-2648"><a href="#HandlerCircle-2648"><span class="linenos">2648</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle-2649"><a href="#HandlerCircle-2649"><span class="linenos">2649</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">(),</span>
</span><span id="HandlerCircle-2650"><a href="#HandlerCircle-2650"><span class="linenos">2650</span></a>                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
</span><span id="HandlerCircle-2651"><a href="#HandlerCircle-2651"><span class="linenos">2651</span></a>
</span><span id="HandlerCircle-2652"><a href="#HandlerCircle-2652"><span class="linenos">2652</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">marker</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Helper class for creating circular markers in matplotlib legends.</p>

<p>This class customizes the legend to display circular markers instead of the 
default. It is intended for internal use within the module and not 
for general use.</p>

<h2 id="methods">Methods:</h2>

<p>create_artists(legend, 
               orig_handle, 
               xdescent,
               ydescent, 
               width, 
               height, 
               fontsize, 
               trans):
    Creates a circular marker for the legend based on the original handle's 
    properties.</p>

<p>Parameters for <code><a href="#HandlerCircle.create_artists">create_artists</a></code>:
    legend : matplotlib.legend.Legend
        The legend instance where the custom marker will be used.
    orig_handle : matplotlib.artist.Artist
        The original handle containing the marker properties 
        (e.g., facecolor, edgecolor).
    xdescent : float
        Horizontal offset adjustment for the marker.
    ydescent : float
        Vertical offset adjustment for the marker.
    width : float
        Width of the legend entry.
    height : float
        Height of the legend entry.
    fontsize : float
        Font size of the legend text.
    trans : matplotlib.transforms.Transform
        Transformation applied to the marker's coordinates.</p>

<h2 id="returns">Returns:</h2>

<p>list of matplotlib.patches.Circle
    A list containing a single circular marker artist.</p>
</div>


                            <div id="HandlerCircle.create_artists" class="classattr">
                                        <input id="HandlerCircle.create_artists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_artists</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">legend</span>,</span><span class="param">	<span class="n">orig_handle</span>,</span><span class="param">	<span class="n">xdescent</span>,</span><span class="param">	<span class="n">ydescent</span>,</span><span class="param">	<span class="n">width</span>,</span><span class="param">	<span class="n">height</span>,</span><span class="param">	<span class="n">fontsize</span>,</span><span class="param">	<span class="n">trans</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="HandlerCircle.create_artists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HandlerCircle.create_artists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HandlerCircle.create_artists-2638"><a href="#HandlerCircle.create_artists-2638"><span class="linenos">2638</span></a>    <span class="k">def</span> <span class="nf">create_artists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">,</span> <span class="n">xdescent</span><span class="p">,</span> <span class="n">ydescent</span><span class="p">,</span> 
</span><span id="HandlerCircle.create_artists-2639"><a href="#HandlerCircle.create_artists-2639"><span class="linenos">2639</span></a>                       <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
</span><span id="HandlerCircle.create_artists-2640"><a href="#HandlerCircle.create_artists-2640"><span class="linenos">2640</span></a>        <span class="c1"># Calculate the center and radius of the circle</span>
</span><span id="HandlerCircle.create_artists-2641"><a href="#HandlerCircle.create_artists-2641"><span class="linenos">2641</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle.create_artists-2642"><a href="#HandlerCircle.create_artists-2642"><span class="linenos">2642</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle.create_artists-2643"><a href="#HandlerCircle.create_artists-2643"><span class="linenos">2643</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="HandlerCircle.create_artists-2644"><a href="#HandlerCircle.create_artists-2644"><span class="linenos">2644</span></a>
</span><span id="HandlerCircle.create_artists-2645"><a href="#HandlerCircle.create_artists-2645"><span class="linenos">2645</span></a>        <span class="c1"># Create a circular marker using the properties of the original handle</span>
</span><span id="HandlerCircle.create_artists-2646"><a href="#HandlerCircle.create_artists-2646"><span class="linenos">2646</span></a>        <span class="n">marker</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span>
</span><span id="HandlerCircle.create_artists-2647"><a href="#HandlerCircle.create_artists-2647"><span class="linenos">2647</span></a>                        <span class="n">facecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle.create_artists-2648"><a href="#HandlerCircle.create_artists-2648"><span class="linenos">2648</span></a>                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_edgecolor</span><span class="p">(),</span>
</span><span id="HandlerCircle.create_artists-2649"><a href="#HandlerCircle.create_artists-2649"><span class="linenos">2649</span></a>                        <span class="n">linewidth</span><span class="o">=</span><span class="n">orig_handle</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">(),</span>
</span><span id="HandlerCircle.create_artists-2650"><a href="#HandlerCircle.create_artists-2650"><span class="linenos">2650</span></a>                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
</span><span id="HandlerCircle.create_artists-2651"><a href="#HandlerCircle.create_artists-2651"><span class="linenos">2651</span></a>
</span><span id="HandlerCircle.create_artists-2652"><a href="#HandlerCircle.create_artists-2652"><span class="linenos">2652</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">marker</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return the legend artists generated.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>legend</strong> (<code>~matplotlib.legend.Legend</code>):
The legend for which these legend artists are being created.</li>
<li><strong>orig_handle</strong> (<code>~matplotlib.artist.Artist</code> or similar):
The object for which these legend artists are being created.</li>
<li><strong>xdescent, ydescent, width, height</strong> (int):
The rectangle (<em>xdescent</em>, <em>ydescent</em>, <em>width</em>, <em>height</em>) that the
legend artists being created should fit within.</li>
<li><strong>fontsize</strong> (int):
The fontsize in pixels. The legend artists being created should
be scaled according to the given fontsize.</li>
<li><strong>trans</strong> (<code>~matplotlib.transforms.Transform</code>):
The transform that is applied to the legend artists being created.
Typically from unit coordinates in the handler box to screen
coordinates.</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>matplotlib.legend_handler.HandlerBase</dt>
                                <dd id="HandlerCircle.__init__" class="function">HandlerBase</dd>
                <dd id="HandlerCircle.legend_artist" class="function">legend_artist</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="IntensityCenter">
                            <input id="IntensityCenter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">IntensityCenter</span>:

                <label class="view-source-button" for="IntensityCenter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IntensityCenter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IntensityCenter-2655"><a href="#IntensityCenter-2655"><span class="linenos">2655</span></a><span class="k">class</span> <span class="nc">IntensityCenter</span><span class="p">:</span> 
</span><span id="IntensityCenter-2656"><a href="#IntensityCenter-2656"><span class="linenos">2656</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="IntensityCenter-2657"><a href="#IntensityCenter-2657"><span class="linenos">2657</span></a><span class="sd">    Simple center determination for a symmetric diffractogram.</span>
</span><span id="IntensityCenter-2658"><a href="#IntensityCenter-2658"><span class="linenos">2658</span></a><span class="sd">    </span>
</span><span id="IntensityCenter-2659"><a href="#IntensityCenter-2659"><span class="linenos">2659</span></a><span class="sd">    * The center is determined as a center of intensity.</span>
</span><span id="IntensityCenter-2660"><a href="#IntensityCenter-2660"><span class="linenos">2660</span></a><span class="sd">    * This works well for simple, symmetric diffraction patters, which are:</span>
</span><span id="IntensityCenter-2661"><a href="#IntensityCenter-2661"><span class="linenos">2661</span></a><span class="sd">      (i) without beamstopper, (ii) pre-centered, and (iii) powder-like.</span>
</span><span id="IntensityCenter-2662"><a href="#IntensityCenter-2662"><span class="linenos">2662</span></a><span class="sd">    * A real-life example of a simple symmetric diffractogram:</span>
</span><span id="IntensityCenter-2663"><a href="#IntensityCenter-2663"><span class="linenos">2663</span></a><span class="sd">      a good powder electron diffraction pattern from STEMDIFF software.</span>
</span><span id="IntensityCenter-2664"><a href="#IntensityCenter-2664"><span class="linenos">2664</span></a><span class="sd">    * This class is a legacy from previous EDIFF versions;</span>
</span><span id="IntensityCenter-2665"><a href="#IntensityCenter-2665"><span class="linenos">2665</span></a><span class="sd">      it is kept mostly for backward compatibility.</span>
</span><span id="IntensityCenter-2666"><a href="#IntensityCenter-2666"><span class="linenos">2666</span></a><span class="sd">      The functions in this class can be (and should be)</span>
</span><span id="IntensityCenter-2667"><a href="#IntensityCenter-2667"><span class="linenos">2667</span></a><span class="sd">      replaced by a simple call of ediff.center.CenterLocator object.</span>
</span><span id="IntensityCenter-2668"><a href="#IntensityCenter-2668"><span class="linenos">2668</span></a><span class="sd">      </span>
</span><span id="IntensityCenter-2669"><a href="#IntensityCenter-2669"><span class="linenos">2669</span></a><span class="sd">    &gt;&gt;&gt; # Center determination in a simple symmetric diffraction pattern</span>
</span><span id="IntensityCenter-2670"><a href="#IntensityCenter-2670"><span class="linenos">2670</span></a><span class="sd">    &gt;&gt;&gt; # (center = just center_of_intensity, no refinement</span>
</span><span id="IntensityCenter-2671"><a href="#IntensityCenter-2671"><span class="linenos">2671</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="IntensityCenter-2672"><a href="#IntensityCenter-2672"><span class="linenos">2672</span></a><span class="sd">    &gt;&gt;&gt; # (1) Old way = this (old, legacy) IntensityCenter class:</span>
</span><span id="IntensityCenter-2673"><a href="#IntensityCenter-2673"><span class="linenos">2673</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.IntensityCenter.center_of_intensity(</span>
</span><span id="IntensityCenter-2674"><a href="#IntensityCenter-2674"><span class="linenos">2674</span></a><span class="sd">    &gt;&gt;&gt;     arr, csquare=30, cintensity=0.8)</span>
</span><span id="IntensityCenter-2675"><a href="#IntensityCenter-2675"><span class="linenos">2675</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="IntensityCenter-2676"><a href="#IntensityCenter-2676"><span class="linenos">2676</span></a><span class="sd">    &gt;&gt;&gt; # (2) New way = newer (and more universal) CenterLocator class:</span>
</span><span id="IntensityCenter-2677"><a href="#IntensityCenter-2677"><span class="linenos">2677</span></a><span class="sd">    &gt;&gt;&gt; xc,yc = ediff.center.CenterLocator(</span>
</span><span id="IntensityCenter-2678"><a href="#IntensityCenter-2678"><span class="linenos">2678</span></a><span class="sd">    &gt;&gt;&gt;     arr, detection_method=&#39;intensity&#39;, csquare=30, cintensity=0.8)</span>
</span><span id="IntensityCenter-2679"><a href="#IntensityCenter-2679"><span class="linenos">2679</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="IntensityCenter-2680"><a href="#IntensityCenter-2680"><span class="linenos">2680</span></a>    
</span><span id="IntensityCenter-2681"><a href="#IntensityCenter-2681"><span class="linenos">2681</span></a>    <span class="nd">@staticmethod</span>
</span><span id="IntensityCenter-2682"><a href="#IntensityCenter-2682"><span class="linenos">2682</span></a>    <span class="k">def</span> <span class="nf">center_of_intensity</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="IntensityCenter-2683"><a href="#IntensityCenter-2683"><span class="linenos">2683</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="IntensityCenter-2684"><a href="#IntensityCenter-2684"><span class="linenos">2684</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="IntensityCenter-2685"><a href="#IntensityCenter-2685"><span class="linenos">2685</span></a><span class="sd">        </span>
</span><span id="IntensityCenter-2686"><a href="#IntensityCenter-2686"><span class="linenos">2686</span></a><span class="sd">        Parameters</span>
</span><span id="IntensityCenter-2687"><a href="#IntensityCenter-2687"><span class="linenos">2687</span></a><span class="sd">        ----------</span>
</span><span id="IntensityCenter-2688"><a href="#IntensityCenter-2688"><span class="linenos">2688</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="IntensityCenter-2689"><a href="#IntensityCenter-2689"><span class="linenos">2689</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="IntensityCenter-2690"><a href="#IntensityCenter-2690"><span class="linenos">2690</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="IntensityCenter-2691"><a href="#IntensityCenter-2691"><span class="linenos">2691</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="IntensityCenter-2692"><a href="#IntensityCenter-2692"><span class="linenos">2692</span></a><span class="sd">            The intensity center is searched only within the central square.</span>
</span><span id="IntensityCenter-2693"><a href="#IntensityCenter-2693"><span class="linenos">2693</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="IntensityCenter-2694"><a href="#IntensityCenter-2694"><span class="linenos">2694</span></a><span class="sd">            to minimize the effect of an intensity assymetry around center. </span>
</span><span id="IntensityCenter-2695"><a href="#IntensityCenter-2695"><span class="linenos">2695</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="IntensityCenter-2696"><a href="#IntensityCenter-2696"><span class="linenos">2696</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="IntensityCenter-2697"><a href="#IntensityCenter-2697"><span class="linenos">2697</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="IntensityCenter-2698"><a href="#IntensityCenter-2698"><span class="linenos">2698</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="IntensityCenter-2699"><a href="#IntensityCenter-2699"><span class="linenos">2699</span></a><span class="sd">            </span>
</span><span id="IntensityCenter-2700"><a href="#IntensityCenter-2700"><span class="linenos">2700</span></a><span class="sd">        Returns</span>
</span><span id="IntensityCenter-2701"><a href="#IntensityCenter-2701"><span class="linenos">2701</span></a><span class="sd">        -------</span>
</span><span id="IntensityCenter-2702"><a href="#IntensityCenter-2702"><span class="linenos">2702</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="IntensityCenter-2703"><a href="#IntensityCenter-2703"><span class="linenos">2703</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="IntensityCenter-2704"><a href="#IntensityCenter-2704"><span class="linenos">2704</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.    </span>
</span><span id="IntensityCenter-2705"><a href="#IntensityCenter-2705"><span class="linenos">2705</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="IntensityCenter-2706"><a href="#IntensityCenter-2706"><span class="linenos">2706</span></a>        <span class="c1"># Get image/array size</span>
</span><span id="IntensityCenter-2707"><a href="#IntensityCenter-2707"><span class="linenos">2707</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="IntensityCenter-2708"><a href="#IntensityCenter-2708"><span class="linenos">2708</span></a>        <span class="c1"># Calculate borders around the central square</span>
</span><span id="IntensityCenter-2709"><a href="#IntensityCenter-2709"><span class="linenos">2709</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter-2710"><a href="#IntensityCenter-2710"><span class="linenos">2710</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter-2711"><a href="#IntensityCenter-2711"><span class="linenos">2711</span></a>        <span class="c1"># Create central square = cut off the borders</span>
</span><span id="IntensityCenter-2712"><a href="#IntensityCenter-2712"><span class="linenos">2712</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="IntensityCenter-2713"><a href="#IntensityCenter-2713"><span class="linenos">2713</span></a>        <span class="c1"># In the central square, set all values below cintenstity to zero</span>
</span><span id="IntensityCenter-2714"><a href="#IntensityCenter-2714"><span class="linenos">2714</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="IntensityCenter-2715"><a href="#IntensityCenter-2715"><span class="linenos">2715</span></a>        <span class="c1"># Calculate 1st central moments of the image</span>
</span><span id="IntensityCenter-2716"><a href="#IntensityCenter-2716"><span class="linenos">2716</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="IntensityCenter-2717"><a href="#IntensityCenter-2717"><span class="linenos">2717</span></a>        <span class="c1"># Calculate the intensity center = centroid according to www-help</span>
</span><span id="IntensityCenter-2718"><a href="#IntensityCenter-2718"><span class="linenos">2718</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="IntensityCenter-2719"><a href="#IntensityCenter-2719"><span class="linenos">2719</span></a>        <span class="c1"># We have centroid of the central square =&gt; recalculate to whole image</span>
</span><span id="IntensityCenter-2720"><a href="#IntensityCenter-2720"><span class="linenos">2720</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xborder</span><span class="p">,</span><span class="n">yc</span><span class="o">+</span><span class="n">yborder</span><span class="p">)</span>
</span><span id="IntensityCenter-2721"><a href="#IntensityCenter-2721"><span class="linenos">2721</span></a>        
</span><span id="IntensityCenter-2722"><a href="#IntensityCenter-2722"><span class="linenos">2722</span></a>        <span class="c1">## Return the final center</span>
</span><span id="IntensityCenter-2723"><a href="#IntensityCenter-2723"><span class="linenos">2723</span></a>        <span class="k">return</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Simple center determination for a symmetric diffractogram.</p>

<ul>
<li>The center is determined as a center of intensity.</li>
<li>This works well for simple, symmetric diffraction patters, which are:
(i) without beamstopper, (ii) pre-centered, and (iii) powder-like.</li>
<li>A real-life example of a simple symmetric diffractogram:
a good powder electron diffraction pattern from STEMDIFF software.</li>
<li>This class is a legacy from previous EDIFF versions;
it is kept mostly for backward compatibility.
The functions in this class can be (and should be)
replaced by a simple call of <a href="#CenterLocator">CenterLocator</a> object.</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Center determination in a simple symmetric diffraction pattern</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (center = just center_of_intensity, no refinement</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (1) Old way = this (old, legacy) IntensityCenter class:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span> <span class="o">=</span> <span class="n"><a href="#IntensityCenter.center_of_intensity">IntensityCenter.center_of_intensity</a></span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (2) New way = newer (and more universal) CenterLocator class:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span> <span class="o">=</span> <span class="n"><a href="#CenterLocator">CenterLocator</a></span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">arr</span><span class="p">,</span> <span class="n">detection_method</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</code></pre>
</div>
</div>


                            <div id="IntensityCenter.center_of_intensity" class="classattr">
                                        <input id="IntensityCenter.center_of_intensity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">center_of_intensity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">arr</span>, </span><span class="param"><span class="n">csquare</span><span class="o">=</span><span class="mi">20</span>, </span><span class="param"><span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="IntensityCenter.center_of_intensity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IntensityCenter.center_of_intensity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IntensityCenter.center_of_intensity-2681"><a href="#IntensityCenter.center_of_intensity-2681"><span class="linenos">2681</span></a>    <span class="nd">@staticmethod</span>
</span><span id="IntensityCenter.center_of_intensity-2682"><a href="#IntensityCenter.center_of_intensity-2682"><span class="linenos">2682</span></a>    <span class="k">def</span> <span class="nf">center_of_intensity</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">csquare</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cintensity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="IntensityCenter.center_of_intensity-2683"><a href="#IntensityCenter.center_of_intensity-2683"><span class="linenos">2683</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="IntensityCenter.center_of_intensity-2684"><a href="#IntensityCenter.center_of_intensity-2684"><span class="linenos">2684</span></a><span class="sd">        Find center of intensity/mass of an array.</span>
</span><span id="IntensityCenter.center_of_intensity-2685"><a href="#IntensityCenter.center_of_intensity-2685"><span class="linenos">2685</span></a><span class="sd">        </span>
</span><span id="IntensityCenter.center_of_intensity-2686"><a href="#IntensityCenter.center_of_intensity-2686"><span class="linenos">2686</span></a><span class="sd">        Parameters</span>
</span><span id="IntensityCenter.center_of_intensity-2687"><a href="#IntensityCenter.center_of_intensity-2687"><span class="linenos">2687</span></a><span class="sd">        ----------</span>
</span><span id="IntensityCenter.center_of_intensity-2688"><a href="#IntensityCenter.center_of_intensity-2688"><span class="linenos">2688</span></a><span class="sd">        arr : 2D-numpy array</span>
</span><span id="IntensityCenter.center_of_intensity-2689"><a href="#IntensityCenter.center_of_intensity-2689"><span class="linenos">2689</span></a><span class="sd">            The array, whose intensity center will be determined.</span>
</span><span id="IntensityCenter.center_of_intensity-2690"><a href="#IntensityCenter.center_of_intensity-2690"><span class="linenos">2690</span></a><span class="sd">        csquare : int, optional, default is 20</span>
</span><span id="IntensityCenter.center_of_intensity-2691"><a href="#IntensityCenter.center_of_intensity-2691"><span class="linenos">2691</span></a><span class="sd">            The size/edge of the square in the (geometrical) center.</span>
</span><span id="IntensityCenter.center_of_intensity-2692"><a href="#IntensityCenter.center_of_intensity-2692"><span class="linenos">2692</span></a><span class="sd">            The intensity center is searched only within the central square.</span>
</span><span id="IntensityCenter.center_of_intensity-2693"><a href="#IntensityCenter.center_of_intensity-2693"><span class="linenos">2693</span></a><span class="sd">            Reasons: To avoid other spots/diffractions and</span>
</span><span id="IntensityCenter.center_of_intensity-2694"><a href="#IntensityCenter.center_of_intensity-2694"><span class="linenos">2694</span></a><span class="sd">            to minimize the effect of an intensity assymetry around center. </span>
</span><span id="IntensityCenter.center_of_intensity-2695"><a href="#IntensityCenter.center_of_intensity-2695"><span class="linenos">2695</span></a><span class="sd">        cintensity : float, optional, default is 0.8</span>
</span><span id="IntensityCenter.center_of_intensity-2696"><a href="#IntensityCenter.center_of_intensity-2696"><span class="linenos">2696</span></a><span class="sd">            The intensity fraction.</span>
</span><span id="IntensityCenter.center_of_intensity-2697"><a href="#IntensityCenter.center_of_intensity-2697"><span class="linenos">2697</span></a><span class="sd">            When searching the intensity center, we will consider only</span>
</span><span id="IntensityCenter.center_of_intensity-2698"><a href="#IntensityCenter.center_of_intensity-2698"><span class="linenos">2698</span></a><span class="sd">            pixels with intensity &gt; max.intensity.</span>
</span><span id="IntensityCenter.center_of_intensity-2699"><a href="#IntensityCenter.center_of_intensity-2699"><span class="linenos">2699</span></a><span class="sd">            </span>
</span><span id="IntensityCenter.center_of_intensity-2700"><a href="#IntensityCenter.center_of_intensity-2700"><span class="linenos">2700</span></a><span class="sd">        Returns</span>
</span><span id="IntensityCenter.center_of_intensity-2701"><a href="#IntensityCenter.center_of_intensity-2701"><span class="linenos">2701</span></a><span class="sd">        -------</span>
</span><span id="IntensityCenter.center_of_intensity-2702"><a href="#IntensityCenter.center_of_intensity-2702"><span class="linenos">2702</span></a><span class="sd">        xc,yc : float,float</span>
</span><span id="IntensityCenter.center_of_intensity-2703"><a href="#IntensityCenter.center_of_intensity-2703"><span class="linenos">2703</span></a><span class="sd">            XY-coordinates of the intensity/mass center of the array.</span>
</span><span id="IntensityCenter.center_of_intensity-2704"><a href="#IntensityCenter.center_of_intensity-2704"><span class="linenos">2704</span></a><span class="sd">            Round XY-coordinates if you use them for image/array calculations.    </span>
</span><span id="IntensityCenter.center_of_intensity-2705"><a href="#IntensityCenter.center_of_intensity-2705"><span class="linenos">2705</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="IntensityCenter.center_of_intensity-2706"><a href="#IntensityCenter.center_of_intensity-2706"><span class="linenos">2706</span></a>        <span class="c1"># Get image/array size</span>
</span><span id="IntensityCenter.center_of_intensity-2707"><a href="#IntensityCenter.center_of_intensity-2707"><span class="linenos">2707</span></a>        <span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
</span><span id="IntensityCenter.center_of_intensity-2708"><a href="#IntensityCenter.center_of_intensity-2708"><span class="linenos">2708</span></a>        <span class="c1"># Calculate borders around the central square</span>
</span><span id="IntensityCenter.center_of_intensity-2709"><a href="#IntensityCenter.center_of_intensity-2709"><span class="linenos">2709</span></a>        <span class="n">xborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter.center_of_intensity-2710"><a href="#IntensityCenter.center_of_intensity-2710"><span class="linenos">2710</span></a>        <span class="n">yborder</span> <span class="o">=</span> <span class="p">(</span><span class="n">ysize</span> <span class="o">-</span> <span class="n">csquare</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="IntensityCenter.center_of_intensity-2711"><a href="#IntensityCenter.center_of_intensity-2711"><span class="linenos">2711</span></a>        <span class="c1"># Create central square = cut off the borders</span>
</span><span id="IntensityCenter.center_of_intensity-2712"><a href="#IntensityCenter.center_of_intensity-2712"><span class="linenos">2712</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">xborder</span><span class="p">:</span><span class="o">-</span><span class="n">xborder</span><span class="p">,</span><span class="n">yborder</span><span class="p">:</span><span class="o">-</span><span class="n">yborder</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="IntensityCenter.center_of_intensity-2713"><a href="#IntensityCenter.center_of_intensity-2713"><span class="linenos">2713</span></a>        <span class="c1"># In the central square, set all values below cintenstity to zero</span>
</span><span id="IntensityCenter.center_of_intensity-2714"><a href="#IntensityCenter.center_of_intensity-2714"><span class="linenos">2714</span></a>        <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr2</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span><span class="o">*</span><span class="n">cintensity</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="IntensityCenter.center_of_intensity-2715"><a href="#IntensityCenter.center_of_intensity-2715"><span class="linenos">2715</span></a>        <span class="c1"># Calculate 1st central moments of the image</span>
</span><span id="IntensityCenter.center_of_intensity-2716"><a href="#IntensityCenter.center_of_intensity-2716"><span class="linenos">2716</span></a>        <span class="n">M</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="IntensityCenter.center_of_intensity-2717"><a href="#IntensityCenter.center_of_intensity-2717"><span class="linenos">2717</span></a>        <span class="c1"># Calculate the intensity center = centroid according to www-help</span>
</span><span id="IntensityCenter.center_of_intensity-2718"><a href="#IntensityCenter.center_of_intensity-2718"><span class="linenos">2718</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="IntensityCenter.center_of_intensity-2719"><a href="#IntensityCenter.center_of_intensity-2719"><span class="linenos">2719</span></a>        <span class="c1"># We have centroid of the central square =&gt; recalculate to whole image</span>
</span><span id="IntensityCenter.center_of_intensity-2720"><a href="#IntensityCenter.center_of_intensity-2720"><span class="linenos">2720</span></a>        <span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">xborder</span><span class="p">,</span><span class="n">yc</span><span class="o">+</span><span class="n">yborder</span><span class="p">)</span>
</span><span id="IntensityCenter.center_of_intensity-2721"><a href="#IntensityCenter.center_of_intensity-2721"><span class="linenos">2721</span></a>        
</span><span id="IntensityCenter.center_of_intensity-2722"><a href="#IntensityCenter.center_of_intensity-2722"><span class="linenos">2722</span></a>        <span class="c1">## Return the final center</span>
</span><span id="IntensityCenter.center_of_intensity-2723"><a href="#IntensityCenter.center_of_intensity-2723"><span class="linenos">2723</span></a>        <span class="k">return</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find center of intensity/mass of an array.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>arr</strong> (2D-numpy array):
The array, whose intensity center will be determined.</li>
<li><strong>csquare</strong> (int, optional, default is 20):
The size/edge of the square in the (geometrical) center.
The intensity center is searched only within the central square.
Reasons: To avoid other spots/diffractions and
to minimize the effect of an intensity assymetry around center.</li>
<li><strong>cintensity</strong> (float, optional, default is 0.8):
The intensity fraction.
When searching the intensity center, we will consider only
pixels with intensity &gt; max.intensity.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xc,yc</strong> (float,float):
XY-coordinates of the intensity/mass center of the array.
Round XY-coordinates if you use them for image/array calculations.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>